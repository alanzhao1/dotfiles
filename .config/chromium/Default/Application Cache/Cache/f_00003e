(function(){var e=function(e,t){var n={Views:{Cards:{},Modules:{},Pages:{},Lightboxes:{},Tooltips:{}}};(function(){function e(e){function t(){n.trigger("player:pauseSong"),n.trigger("lightbox:open","login",{premiumRequired:!0,_canClose:!1,message:_.getString("LB_SIGNUP_LOGIN_PREMIUM_REQUIRED_2")})}n.ready.done(_.bind(function(){this.get("manatee").setUser(e);if(n.getLoggedInUserID()!==e.id)return;e.get("Locale")&&n.trigger("locale:change",e.get("Locale")),n.premiumRequired()&&_.delay(t,100)},this))}function t(e,t){var n=e.get("oldUserClean"),r=e.cleanUpOnLogout(!0);if(n&&n.state()=="pending"){var i=$.after(n,r);return t.set("oldUserClean",i),i.promise()}return t.set("oldUserClean",r),r}function i(t,n,r,i,s){this.trigger("userChange:started",{newUser:s,oldUser:i,destination:n}),this.set({user:s}),this.trigger("userChange:finished",{newUser:s,oldUser:i,destination:n,preventRedirect:r}),e.call(this,s),t&&t.resolve(s)}function s(e,r,s,u,a){if(!a||a.userID===0){o.call(this,e,r,a);return}a=_.clone(a),n.Models.AuthUser.uncacheID(a.UserID);var f;a.profile&&(f=_.clone(a.profile),delete a.profile);var l=this.get("user"),c=new n.Models.AuthUser(a,{noCache:!0});f&&(f.ProfileID=f.profile&&f.profile.ProfileID,n.Models.Profile.newOrUpdate(f,{overrideUser:c})),t(l,c).done(_.bind(i,this,e,s,u,l,c))}function o(e,t,r){r||(r={}),r.authType=t,n.trigger("guts:log","loginFail",{type:t}),e.reject(r)}function u(e){var r=this.get("user"),s=this.get("manatee");if(!r.get("isLoggedIn"))return!1;n.Models.AuthUser.uncacheID(-1);var o=new n.Models.AuthUser({UserID:-1,userTrackingID:r.get("userTrackingID")},{noCache:!0});t(r,o).done(_.bind(i,this,null,null,null,r,o)),e&&s&&s.publishToSelf("logout",null)}function a(e){if(!e||!e.length)return;var t=this.get("user");t.get("library")&&t.get("library").remove(e),t.get("favoriteSongs")&&t.get("favoriteSongs").remove(e)}function f(){var e=this.get("player"),t=e.previous("queue"),n=e.get("queue"),r=t&&t.get("activeSong");t&&t.off(null,null,this),r&&r.off(null,null,this);if(n)n.on("change:activeSong",l,this),l.call(this);else{var i=this.get("manatee");i&&i.setCurrentSongStatus()}}function l(){var e=this.get("player"),t=e.get("queue"),n=t&&t.previous("activeSong"),r=t&&t.get("activeSong");n&&n.off(null,null,this);if(r)r.on("change:playStatus",c,this),c.call(this);else{var i=this.get("manatee");i&&i.setCurrentSongStatus()}}function c(){var e=this.get("player"),t=e.get("queue"),n=t&&t.get("activeSong"),r=n&&n.get("playStatus"),i=this.get("manatee");i&&i.setCurrentSongStatus(n,r)}function h(e,t){var r=this.get("user");r.get("isLoggedIn")&&(t.sudo||t.userid==r.id)&&(this.logout(!1,!0),n.trigger("notification:add",{description:_.getString("NOTIF_ACCOUNT_DISABLED"),type:"error",duration:0}))}function d(e){var t;e&&e.type==="noServersAvailable"&&(p!==null&&n.trigger("notification:close",p),n.trigger("notification:add",{description:_.getString("MANATEE_DISCONNECTED_2"),click:_.bind(function(){p=null,this.get("manatee").reconnect(!0,!0)},this),initFunc:function(e){t=p=e},closeAction:function(){p===t&&(p=null)},duration:0,type:"error"}))}function v(e){var t;p!==null&&n.trigger("notification:close",p),n.trigger("notification:add",{description:_.getString("MANATEE_IDENTIFY_FAILED"),click:_.bind(function(){p=null,this.get("manatee").retryIdentify(!0)},this),initFunc:function(e){t=p=e},closeAction:function(){p===t&&(p=null)},duration:0,type:"error"}),n.Services.Log.notify("Failed to identify when connecting to manatee","ERROR",{error:e})}function m(){p!==null&&(n.trigger("notification:close",p),p=null)}n.Models=n.Models||{};var p=null;n.Models.Model=Backbone.Model.extend({initialize:function(){var t=new n.Models.AuthUser(_.extend({},gsConfig.user),{noCache:!0});gsConfig.profile&&n.Models.Profile.newOrUpdate(gsConfig.profile,{overrideUser:t});var r=new n.Models.Player(null,{appModel:this}),i=new n.Services.Manatee(n.Services.Manatee.convertGSConfigServerList(gsConfig.chatServersWeighted),!0);this.set({appToken:{},user:t,player:r,manatee:i,theme:new n.Models.Theme,paywalledCountries:[42,61,161,191]}),i.setUser(t),i.on("connectionError",d,this),i.on("identifyFailed",v,this),i.on("connected",m,this),i.reconnect(),e.call(this,this.get("user")),r.on("change:queue",f,this),f.call(this),n.on("songs:deleted",a,this),n.on("manatee:userAccountDisabled",h,this)},onSignup:function(r,i){n.Models.AuthUser.uncacheID(r.UserID);var s=this.get("user"),o=new n.Models.AuthUser(r,{noCache:!0});t(s,o),i&&n.router.setHash(i),this.set("user",o),e.call(this,o)},login:function(e,t,r,i,u){var a=new $.Deferred,f=this.get("appToken"),l;switch(e){case"google":l=n.Services.Google.loginWithGooglePlus(f);break;case"twitter":l=n.Services.Twitter.login(f);break;case"normal":default:e="normal",l=n.Services.API.authenticateUser(t,r)}return l.done(_.bind(s,this,a,e,i,u)).fail(_.bind(o,this,a,e)),a.promise()},authenticateAsAuthorizedUser:function(e){var t=new $.Deferred,i=this,u=this.get("user"),a=n.Services.API.authenticateAsAuthorizedUser(e),f=function(){var f=u.get("primaryUserID")||u.get("UserID"),l=u.get("primaryFName")||u.get("FName"),c=u.get("artistsOwned");a.done(function(r){if(r.userID!=e){r.attemptedUserID=e,r.reason="userID does not match",o.call(i,t,"authAsUser",r);return}r.artistsOwned=c,r.primaryUserID=f,r.primaryFName=l,s.call(i,t,"authAsUser",null,null,r),n.trigger("switchUser",u,i.get("user"))}).fail(function(n){n=n?_.clone(n):{},n.attemptedUserID=e,o.call(i,t,"authAsUser",n)})};if(n.isBroadcaster()){var l=r.model.get("player"),c=l.get("queue"),h=c&&c.get("currentBroadcast");h&&n.trigger("lightbox:open","broadcastListeners",{broadcast:h,endBroadcast:!0,onBroadcastEnded:function(){f.call(i)},onCloseLightbox:function(){var n={};n.attemptedUserID=e,o.call(i,t,"authAsUser",n)}})}else f.call(this);return t.promise()},logout:function(e,t){if(e)return u.call(this,!1);var r,i=this,s=this.get("player").get("queue"),o=s&&s.get("currentBroadcast");return!t&&s&&s.get("isBroadcasting")?(r=$.Deferred(),n.trigger("lightbox:open",{_type:"logoutConfirm",view:{header:"LB_LOGOUT_CONFIRM_BROADCAST_TITLE",message:"LB_LOGOUT_CONFIRM_BROADCAST_MSG",buttonsLeft:[{label:"CANCEL",className:"close"}],buttonsRight:[{label:"SIGN_OUT",className:"btn-primary submit"}]},callbacks:{".submit":function(e){o.end(),i.logout(!1,!0).done(function(){r.resolve.apply(r,_.toArray(arguments))}).fail(function(){r.reject.apply(r,_.toArray(arguments))}).always(function(){n.trigger("lightbox:close","logoutConfirm")})}},onDestroy:function(){r.state()=="pending"&&r.reject()}})):this.get("user").get("isLoggedIn")?(r=n.Services.API.logoutUser(),r.done(_.bind(u,this,!0))):r&&r.resolve(),r.promise()}},{APP_SIZES:{desktopXL:1920,desktop:1025,tablet:530,mobile:320}})})(),function(){function i(e){var t=new $.Deferred;return n.Services.API.getQueueSongListFromSongIDs([e]).done(function(e){if(!e){t.reject(e);return}e[0]&&(e[0].loadedBySelfFromDB=!0),t.resolve(e[0])}).fail(function(e){t.reject(e)}),t.promise()}function s(e,r,i){if(!i)return o(e,r);var s=i.Data||{},u=i.Name&&i.Name.indexOf("/")===-1?i.Name:"",a={pageNameData:s,PathName:u};s&&s.Tags!==t&&(a.Tags=new n.Models.Collections.Tags(s.Tags)),this.set(a),r==="data"&&e?e.resolve(s):e&&e.resolve(u)}function o(e,t){this.set({PathName:"",pageNameData:{}}),e&&e.resolve(null)}function u(e){return{AlbumID:e.A,AlbumName:e.B,ArtistID:e.C,ArtistName:e.D,CoverArtFilename:e.E,EstimateDuration:e.F,Flags:e.G,Popularity:e.H,SongID:e.I,SongName:e.J,TSAdded:e.K,TrackNum:e.L,Year:_.defined(e.M)?e.M:"0",TSFavorited:e.O,TagIDs:e.P}}function a(e){return{AlbumID:e.alID,AlbumName:e.alN,ArtistID:e.arID,ArtistName:e.arN,CoverArtFilename:e.art,EstimateDuration:e.estD,Flags:e.f,SongID:e.sID,SongName:e.sN,TrackNum:e.t,token:e.tk}}function f(e,t,r){this._artists||(this._artists={}),this._albums||(this._albums={});var i=this._artists,s=this._albums,o=r||{};e.ArtistID&&(t||!i.hasOwnProperty(e.ArtistID))&&(o.srcArtist&&o.srcArtist.id==e.ArtistID?this.addArtist(o.srcArtist):o.srcArtists&&o.srcArtists[e.ArtistID]?this.addArtist(o.srcArtists[e.ArtistID]):this.addArtist({ArtistID:e.ArtistID,ArtistName:e.ArtistName})),e.AlbumID&&(t||!s.hasOwnProperty(e.AlbumID))&&(o.srcAlbum&&o.srcAlbum.id==e.AlbumID?this.addAlbum(o.srcAlbum):o.srcAlbums&&o.srcAlbums[e.AlbumID]?this.addAlbum(o.srcAlbums[e.AlbumID]):this.addAlbum({ArtistID:e.AlbumArtistID||e.ArtistID,ArtistName:e.AlbumArtistName||e.ArtistName,AlbumID:e.AlbumID,AlbumName:e.AlbumName,Year:e.Year,CoverArtFilename:e.CoverArtFilename,IsVerifiedSongs:e.IsVerified})),e.TrackNum&&(this.attributes.TrackNumsByAlbumID[e.AlbumID]=e.TrackNum);var u=this.attributes.ArtistID;(t||!u||u===n.Models.Artist.UNKNOWN&&u!=e.ArtistID||o.overwriteArtist)&&this.setPreferredArtist(e.ArtistID,{silent:_.orEqual(o.silent,!0)});var a=this.attributes.AlbumID;(!a||a===n.Models.Album.UNKNOWN&&a!=e.AlbumID||o.overwriteAlbum)&&this.setPreferredAlbum(e.AlbumID,{silent:_.orEqual(o.silent,!0)});if(e.artistIsClaimed&&e.ArtistID&&i[e.ArtistID]){var f=i[e.ArtistID].get("Flags")||0;i[e.ArtistID].set("Flags",f|n.Models.Artist.FLAG_ARTIST_CLAIMED),delete e.artistIsClaimed}}function l(e,t){var n=_.indexOf(e,parseInt(t,10)+"");return n>-1?(e.splice(n,1),!0):!1}function c(e,t){var n=_.indexOf(e,t+"");return n===-1?(e.push(t+""),!0):!1}n.Models=n.Models||{},n.Models.Song=Backbone.CachedModel.extend({idAttribute:"SongID",_useAlbumContextForImg:!1,parse:function(e,r){if(r&&r.skipParse)return e;var i=r||{},s=e;e.hasOwnProperty("A")?s=u(e):e.hasOwnProperty("sID")?s=a(e):e.hasOwnProperty("b")&&(s=a(e.b));var o=_.orEqualEx(s.SongName,s.songName,s.Name,"Unknown Title"),f=_.orEqualEx(s.ArtistName,s.artistName,_.getString("UNKNOWN_ARTIST")),l=_.orEqualEx(s.AlbumName,s.albumName,_.getString("UNKNOWN_ALBUM")),c=[o,f,l].join(" ").toLowerCase(),h=_.orEqualEx(s.CoverArtFilename,s.artFilename,""),p=_.orEqual(s.Flags,s.flags),d=parseFloat(_.orEqual(s.IsVerified,s.isVerified));d=isNaN(d)?0:d,h.length>=2&&h[0]==="0"&&h[1]==="_"&&(h=h.substr(2));if(h==="default.png"||h.length&&h.length<2)h="";return{SongID:_.toInt(_.orEqualEx(s.SongID,s.songID,0)),SongName:o,ArtistID:_.toInt(_.orEqualEx(s.ArtistID,s.artistID,0)),ArtistName:f,AlbumID:_.toInt(_.orEqualEx(s.AlbumID,s.albumID,0)),AlbumName:l,Flags:_.defined(p)?_.toInt(p):t,IsVerified:d,CoverArtFilename:h,PageArtFilename:_.orEqual(s.PageArtFilename,""),EstimateDuration:_.orEqualEx(s.EstimateDuration,s.estimateDuration,0),TrackNum:_.toInt(_.orEqualEx(s.TrackNum,s.trackNum,0)),Year:_.orEqualEx(s.Year,s.year,"0"),Popularity:_.toInt(_.orEqualEx(s.Popularity,s.popularity,0)),TagIDs:_.orEqualEx(s.tagIDs,s.TagIDs,[]),Tags:_.isArray(s.Tags)?new n.Models.Collections.Tags(s.Tags):s.Tags,TrackNumsByAlbumID:_.orEqual(s.TrackNumsByAlbumID,{}),fromLibrary:!!s.fromLibrary||!!i.fromLibrary,isFavorite:!!s.isFavorite||!!i.isFavorite,IsLowBitrateAvailable:_.toInt(s.IsLowBitrateAvailable),searchText:c,token:_.orEqual(s.token,s.Token,null),tokenFailed:!!s.tokenFailed,ppVersion:s.ppVersion,PathName:s.PathName,rawPageNameData:s.pageNameData||s.rawPageNameData,TSFavorited:s.TSFavorited,TSAdded:s.TSAdded,listenDataKey:s.listenDataKey,listenTime:s.listenTime,client:s.client,loadedBySelfFromDB:s.loadedBySelfFromDB||!1}},initialize:function(e,t){e.rawPageNameData&&(this.setPageNameData(e.rawPageNameData),this.unset("rawPageNameData",{silent:!0})),f.call(this,e,!0,t);if(!e.isFavorite||!e.fromLibrary){var n=r.model.attributes.user,i={};n&&(n.attributes.favoriteSongsSongIDs&&n.attributes.favoriteSongsSongIDs[this.id]&&(i.isFavorite=!0),n.attributes.librarySongsSongIDs&&n.attributes.librarySongsSongIDs[this.id]&&(i.fromLibrary=!0),(i.fromLibrary||i.isFavorite)&&this.set(i,{silent:!0}))}return Backbone.CachedModel.prototype.initialize.call(this,e,t)},updateFromNew:function(e,t){var r=_.omitSameKeys(this.attributes,e),i=e.pageNameData||e.rawPageNameData;e.hasOwnProperty("ppVersion")&&(r.ppVersion=e.ppVersion);var s=_.toInt(e.Popularity);if(s>0||!this.attributes.Popularity)r.Popularity=s;var o=_.toInt(e.Year);o!==this.attributes.Year&&(r.Year=o);if(e.isFavorite||t&&t.isFavorite)r.isFavorite=!0;if(e.fromLibrary||t&&t.fromLibrary)r.fromLibrary=!0,e.TSAdded&&(r.TSAdded=e.TSAdded);_.toInt(e.IsVerified)&&!this.attributes.IsVerified&&(r.IsVerified=1),_.isArray(e.Tags)&&(this.attributes.Tags?this.attributes.Tags.add(e.Tags):r.Tags=new n.Models.Collections.Tags(e.Tags)),delete e.pageNameData,delete e.rawPageNameData,e.loadedBySelfFromDB?(r.loadedBySelfFromDB=!0,f.call(this,e,!1,_.extend({overwriteAlbum:!0,overwriteArtist:!0},t))):f.call(this,e,!1,t),this.set(r,t),i&&this.setPageNameData(i)},archiveAttr:function(){var e=[],t=this.attributes;t.Tags&&(e=t.Tags.pluck("TagID")),!e.length&&$.isArray(t.TagIDs)&&(e=t.TagIDs);var n={A:t.AlbumID,B:t.AlbumName,C:t.ArtistID,D:t.ArtistName,E:t.CoverArtFilename,F:t.EstimateDuration,H:t.Popularity,I:t.SongID,J:t.SongName,K:t.TSAdded,L:t.TrackNum,M:t.Year,N:0,O:t.TSFavorited,P:e};return _.defined(t.Flags)&&(n.G=t.Flags),n},get:function(e){var t=this.attributes.AlbumID;switch(e){case"ArtistName":return this._artists&&this._artists[this.attributes.ArtistID]?this._artists[this.attributes.ArtistID].ArtistName:"";case"AlbumName":return this._albums&&this._albums[t]?this._albums[t].AlbumName:"";case"CoverArtFilename":return this._albums&&this._albums[t]?this._albums[t].CoverArtFilename:"";case"TrackNum":return this.attributes.TrackNumsByAlbumID&&this.attributes.TrackNumsByAlbumID[t]?this.attributes.TrackNumsByAlbumID[t]:0}return this.attributes[e]},setPreferredArtist:function(e,t){t=t||{};var r=this._artists,i=r[e],s=i?i.ArtistName:_.getString("UNKNOWN"),o=this._albums,u=o[this.get("AlbumID")];i||(e=n.Models.Artist.UNKNOWN),this.set({ArtistID:e,ArtistName:s},t);if(!t.fromAlbumSet&&(!u||u.ArtistID!=e)){var a=_.find(o,function(t){return t.ArtistID==e});t.fromArtistSet=!0,(a||e==n.Models.Artist.UNKNOWN)&&this.setPreferredAlbum(a?a.AlbumID:n.Models.Album.UNKNOWN,t)}},setPreferredAlbum:function(e,t){t=t||{};var r=this._albums,i=r[e],s=i?i.AlbumName:_.getString("UNKNOWN"),o=i?i.ArtistID:n.Models.Artist.UNKNOWN,u=this._artists;i||(e=n.Models.Album.UNKNOWN),this.set({AlbumID:e,AlbumName:s},t),!t.fromArtistSet&&o!=this.get("ArtistID")&&(t.fromAlbumSet=!0,this.setPreferredArtist(u[o]?o:n.Models.Artist.UNKNOWN,t))},getAlbums:function(e){var t=this._albums;return _.defined(e)?t[e]:_.extend({},t)},addAlbum:function(e){e instanceof Backbone.Model&&(e={AlbumID:e.get("AlbumID"),ArtistID:e.get("ArtistID"),AlbumName:e.get("AlbumName"),ArtistName:e.get("ArtistName"),CoverArtFilename:e.get("CoverArtFilename"),Year:e.get("Year"),IsVerifiedSongs:e.get("IsVerifiedSongs")}),this._albums[e.AlbumID]=e;var t=e.ArtistID,r=this._artists;if(!r.hasOwnProperty(t)){var i=n.Models.Artist.getCached(t);i?this.addArtist(i):this.addArtist({ArtistID:e.ArtistID,ArtistName:e.ArtistName})}},removeAlbum:function(e){var t=this._albums,r=this.get("TrackNumsByAlbumID"),i=this.get("AlbumID");t.hasOwnProperty(e)&&delete t[e],r.hasOwnProperty(e)&&delete r[e];if(e==i){var s=_.keys(t);s.length?this.setPreferredAlbum(s[0]):this.setPreferredAlbum(n.Models.Album.UNKNOWN)}},getArtists:function(e){var t=this._artists;return _.defined(e)?t[e]:_.extend({},t)},addArtist:function(e){e instanceof Backbone.Model&&(e={ArtistID:e.get("ArtistID"),ArtistName:e.get("ArtistName")}),this._artists[e.ArtistID]=e},removeArtist:function(e){var t=this._artists,r=this._albums,i=this.get("ArtistID");t.hasOwnProperty(e)&&delete t[e],_.each(r,function(t,n,r){t.ArtistID==e&&delete r[n]});if(e==i){var s=_.keys(t);s.length?this.setPreferredArtist(s[0]):this.setPreferredArtist(n.Models.Artist.UNKNOWN)}},hasUrl:function(){var e=this.getToken(!0);return!!e},toUrl:function(e){var t=this.getToken(!0);return t?_.cleanUrl(this.get("SongName"),this.get("SongID"),"s",t,e):"#!/notFound"},toArtistUrl:function(e){return n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),e)},toAlbumUrl:function(e){return _.cleanUrl(this.get("AlbumName"),this.get("AlbumID"),"album",null,e)},getToken:function(e){e=_.orEqual(e,!1);var t;return!this.get("token")&&!this.get("tokenFailed")?t=n.Services.API.getTokenForSong(this.get("SongID"),_.bind(this._onGetToken,this),null,{async:!e}):(t=new $.Deferred,t.resolve({Token:this.get("token")})),e?this.get("token"):t.promise()},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("SongID"),"song").done(_.bind(s,this,e,"name")).fail(_.bind(o,this,e)),e.promise()},getPageNameData:function(){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected")return this.pageNameDataDfd.promise();var e=new $.Deferred;return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("SongID"),"song").done(_.bind(s,this,e,"data")).fail(_.bind(o,this,e)),this.pageNameDataDfd=e,e.promise()},setPageNameData:function(e){var t=e&&!e.Data?{Data:e}:e;s.call(this,null,"data",t)},getTags:function(){var e=new $.Deferred;return typeof this.get("Tags")!="undefined"?e.resolve(this.get("Tags")):this.getPageNameData().done(_.bind(function(){e.resolve(this.get("Tags"))},this)).fail(e.reject),e.promise()},_onGetToken:function(e){e.Token?(this.set("token",e.Token),this.constructor.getCached(this.id)&&this.cid===this.constructor.getCached(this.id).cid&&this.constructor.cacheToken(this)):this.set("tokenFailed",!0)},getImageURL:function(t,r){r=_.extend({useDefault:!1},r),t=_.orEqual(t,70);var i,s=this._useAlbumContextForImg||r.useAlbumContext,o=_.getImageURL(n.Models.Song.artPath+t+"_album.png");if(s&&this.attributes.context&&this.attributes.context.type=="album"){var u=this.getAlbums(this.attributes.context.data.albumID);u&&u.CoverArtFilename&&(i=u.CoverArtFilename)}else i=this.get("CoverArtFilename");return i&&!r.useDefault&&(o=_.getImageURL(n.Models.Song.artPath+t+"_"+i)),o+="?co="+e.location.host,o},getPageImageURL:function(t){var r=_.getCDNImage(n.Models.Song[_.isRetina()?"pageArtRetinaPath":"pageArtPath"]),i="?co="+e.location.host,s=new $.Deferred;return this.get("PageArtFilename")?s.resolve(_.getCDNImage(this.get("PageArtFilename"))+i):t?s.resolve(this.getImageURL(500)+i):s.resolve(r+i),s.promise()},getDetailsForFeeds:function(){return{songID:this.get("SongID"),songName:this.get("SongName"),albumID:this.get("AlbumID"),albumName:this.get("AlbumName"),artistID:this.get("ArtistID"),artistName:this.get("ArtistName"),artFilename:this.get("CoverArtFilename"),track:this.get("TrackNum"),isVerified:this.get("IsVerified"),token:this.get("token")}},getDetailsForSwf:function(){var e=/\u0000/g;return{SongID:this.get("SongID"),SongName:this.get("SongName").replace(e,""),AlbumID:this.get("AlbumID"),AlbumName:this.get("AlbumName").replace(e,""),ArtistID:this.get("ArtistID"),ArtistName:this.get("ArtistName").replace(e,""),CoverArtFilename:this.get("CoverArtFilename").replace(e,""),TrackNum:this.get("TrackNum"),Flags:this.get("Flags"),EstimateDuration:this.get("EstimateDuration")}},toProxyLabel:function(){return _.getString("SELECTION_SONG_SINGLE",{SongName:this.escape("SongName"),ArtistName:this.escape("ArtistName")})},getTitle:function(e){return e?['"',this.get("SongName"),'" by ',this.get("ArtistName"),' on "',this.get("AlbumName"),'"'].join(""):['"',this.escape("SongName"),'" by ',this.escape("ArtistName"),' on "',this.escape("AlbumName"),'"'].join("")},getAnchorTag:function(e,t,n){var r=this.escape("SongName");return"<a "+(this.get("token")?' href="'+this.toUrl(t)+'"':"")+' class="song-link helper-tooltip-measured '+(n?n:"")+'" data-song-id="'+this.get("SongID")+'">'+(e?_.getString(e).toLocaleLowerCase():r)+"</a>"},getArtistAnchorTag:function(e,t,r){var i=n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),t);return'<a href="'+i+'" class="artist-link '+(r?r:"")+'">'+(e?_.getString(e).toLocaleLowerCase():_.escape(this.get("ArtistName")))+"</a>"},getAlbumAnchorTag:function(e,t,n){return'<a href="'+_.cleanUrl(this.get("AlbumName"),this.get("AlbumID"),"album",null,t)+'" class="album-link '+(n?n:"")+'">'+(e?_.getString(e).toLocaleLowerCase():_.escape(this.get("AlbumName")))+"</a>"},getWidgetCode:function(e,t,n){n=_.orEqual(n,"metal");var r="gsSong"+this.get("SongID")+Math.floor(Math.random()*101),i=_.orEqual(e,250),s=_.orEqual(t,40),o=_.escape(this.get("SongName")+" by "+this.get("ArtistName")+" on Grooveshark"),u='<a href="http://grooveshark.com/search/song?q='+encodeURIComponent(this.get("ArtistName")+" "+this.get("SongName"))+'" title="'+o+'">'+o+"</a>";return'<object width="'+i+'" height="'+s+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" id="'+r+'" name="'+r+'">'+'<param name="movie" value="http://grooveshark.com/songWidget.swf" /><param name="wmode" value="window" /><param name="allowScriptAccess" value="always" />'+'<param name="flashvars" value="hostname=grooveshark.com&songID='+this.get("SongID")+"&style="+n+'&p=0" />'+'<object type="application/x-shockwave-flash" data="http://grooveshark.com/songWidget.swf" width="'+i+'" height="'+s+'"><param name="wmode" value="window" />'+'<param name="allowScriptAccess" value="always" /><param name="flashvars" value="hostname=grooveshark.com&songID='+this.get("SongID")+"&style="+n+'&p=0" />'+"<span>"+u+"</span></object></object>"},getWidgetType:function(){return"single"},toManateeProperties:function(){var e={},t={sID:this.id,sN:this.get("SongName"),cID:this.get("CalloutID"),arID:this.get("ArtistID"),arN:this.get("ArtistName"),alID:this.get("AlbumID"),alN:this.get("AlbumName"),uID:this.get("UserID"),art:this.get("CoverArtFilename"),t:this.get("TrackNum"),estD:this.get("EstimateDuration"),flags:this.get("Flags"),tk:this.get("Token"),arCl:this.get("ArtistIsClaimed")},n=this.get("Tags");return n&&n.length&&(t.tags=[],n.each(function(e){t.tags.push({tid:e.id,tag:e.get("Tag")})})),e.b=t,e},play:function(e){var t=$.Deferred(),r=e||{};return r.context=r.context||new n.Models.PlayContext,n.trigger("player:addSongsEx",[this],r),t.resolve(),t.promise()},updateInfo:function(e,t){var i=$.Deferred(),s={SongID:this.get("SongID"),ArtistID:this.get("ArtistID"),Name:this.get("SongName"),IsVerified:this.get("IsVerified"),AlbumID:this.get("AlbumID"),Flags:this.get("Flags"),TrackNum:this.get("TrackNum")},o=_.defaults(_.clone(e),s),u=!1;return _.each(o,function(e,t){if(s[t]!==e)return u=!0,!1}),u?(n.Services.API.artistEditSongs([o],[s]).done(_.bind(function(e){if(!e||!e.affectedSongs){i.reject();return}t=t||n.Models.Artist.getCached(s.ArtistID);var u=t.get("albums"),a=r.model.get("user"),f=!1,l,c,h,p;if(o.AlbumID!==s.AlbumID){if(!u)return;l=this.getAlbums(s.AlbumID),c=u.get(o.AlbumID),c&&(this.song.addAlbum(c),l&&(this.song.removeAlbum(s.AlbumID),h=l.get("songs"),h&&h.remove(this)),this.song.setPreferredAlbum(o.AlbumID),p=c.get("songs"),p&&p.add(this)),f=!0}if(o.TrackNum!==s.TrackNum||f)this.attributes.TrackNumsByAlbumID[o.AlbumID]=_.toInt(o.TrackNum);delete o.AlbumID,o.SongName=o.Name,delete o.Name,this.set(o),a.storeLibrary(),i.resolve()},this)).fail(_.bind(i.reject,i)),i.promise()):(i.resolve(),i.promise())},updateTags:function(e){if(e instanceof n.Models.Collections.Tags){var t=$.Deferred(),r=this.get("SongID"),i=this.get("Tags")||new n.Models.Collections.Tags,s=i.map(function(e){return e.get("TagID")}).join(","),o=e.map(function(e){return e.get("TagID")}).join(","),u=!1,a;return s===o?(t.resolve(),t.promise()):(a=_.map(e,function(e){return e.pick("TagID","Tag")}),e.length===0&&(u=!0),n.Services.API.modifyCustomSongsTags([r],a,u).done(_.bind(function(n){n?(this.set("Tags",e),t.resolve()):t.reject()},this)).fail(_.bind(t.reject,t)),t.promise())}return $.Deferred().reject().promise()},loadFromDB:function(e){return this.get("loadedBySelfFromDB")?$.Deferred().resolve().promise():n.Models.Song.getFromDBSkipCache(this.get("SongID"),e)},updateSongPrimaryAlbum:function(e,t){var r=$.Deferred(),i=_.toInt(e.get("AlbumID")),s=_.toInt(this.get("AlbumID"));return s!=i&&n.Services.API.addSongToAlbum(this.get("SongID"),i,t,!0).done(_.bind(function(n){if(!n||!n.success){r.reject(n);return}f.call(this,{AlbumID:i,TrackNum:t},!1,{overwriteAlbum:!0,srcAlbum:e,silent:!1}),r.resolve(n)},this)).fail(_.bind(r.reject,r)),r.promise()}},{artPath:"/static/albums/",pageArtPath:"default/cover/album-song-playlist.png",pageArtRetinaPath:"default/cover/retina/album-song-playlist.png",flags:{EXPLICIT:1,INGESTED:2,ARTIST_EDITED:4,UNLISTED:8,DOWNLOADS_ALL:16,DOWNLOADS_FOLLOWERS:32},cache:function(e,n){if(e._wrapped!==t)return!1;var r=Backbone.CachedModel.cache.call(this,e,n);return(!n||!n.noCache&&!n.dontCache)&&this.cacheToken(e,n),r},cacheToken:function(e){var t=e.get("token");if(t){var n="t:"+t;if(this._cache.hasOwnProperty(n)){if(this._cache[n].cid!==e.cid)throw["Attempt to overwrite cached instance for ",n].join("");return}this._cache[n]=e}},popularSort:function(e,t){return t.get("Popularity")-e.get("Popularity")},verifiedPopularSort:function(e,t){var r=!!e.attributes.IsVerified,i=!!t.attributes.IsVerified;return r===i?n.Models.Song.popularSort(e,t):r?-1:1},trackSort:function(e,t){return _.toInt(e.get("TrackNum"))-_.toInt(t.get("TrackNum"))},getLayeredSort:_.bind(_.getModelSort,_,{ArtistName:["ArtistName","AlbumName","TrackNum"],AlbumName:["AlbumName","TrackNum"]}),nukeSong:function(e,t){if(!e)return;var r=e.getAlbums(),i=e.getArtists();_.each(r,function(t){t=n.Models.Album.getCached(t.AlbumID),t&&(t.get("songs")&&t.get("songs").remove(e),t.get("extraSongs")&&t.get("extraSongs").remove(e))}),_.each(i,function(t){t=n.Models.Artist.getCached(t.ArtistID),t&&t.get("songs")&&t.get("songs").remove(e)});if(t){var s=n.Models.AuthUser.getCached(n.getLoggedInUserID());s&&(s.localRemoveSongsFromLibrary([e]),s.localRemoveSongsFromFavorites([e])),n.Models.Song.uncache(e)}},mergeSongs:function(e,t,r){var i=e.get("TrackNumsByAlbumID"),s,o,u,a;_.each(t,function(t){s=t.getAlbums(),o=t.getArtists(),_.each(s,function(r){r=n.Models.Album.getCached(r.AlbumID),r&&(a=r.get("AlbumID"),u=r.get("songs"),u&&u.get(t)&&(u.remove(t),e.getAlbums(a)||(u.add(e),e.addAlbum(r))),u=r.get("extraSongs"),u&&u.get(t)&&(u.remove(t),e.getAlbums(a)||(u.add(e),e.addAlbum(r))))}),_.each(o,function(e){e=n.Models.Artist.getCached(e.ArtistID),e&&e.get("songs")&&e.get("songs").remove(t)}),t._albums={},t._artists={},n.Models.Song.nukeSong(t,!0)}),r&&_.extend(i,r)},get:function(e,t){var n=Backbone.CachedModel.genericGet.call(this,i,"SongID",e,t);return n.promise()},getFromDBSkipCache:function(e,t){if(this._cache&&this._cache.hasOwnProperty(e)&&this._cache[e].get("loadedBySelfFromDB"))return $.Deferred().resolve(this._cache[e]).promise();var n=Backbone.CachedModel.genericGet.call(this,i,"SongID",e,_.extend({forceFetch:!0},t));return n.promise()},getByToken:function(e,t){var r=function(t){var r=new $.Deferred;return n.Services.API.getSongFromToken(e).done(function(t){t.token=e,t.loadedBySelfFromDB=!0,r.resolve(t)}).fail(function(e){r.reject(e)}),r.promise()},i="t:"+e,s=Backbone.CachedModel.genericGet.call(this,r,"SongID",i,t);return s.promise()},unarchiveSong:function(e){var t=n.Models.Song.getCached(e.I);return t?t:new n.Models.Song(u(e))},unarchiveSongAttributes:function(e){return u(e)},convertManateeSongCalloutProperties:function(e){if(!e||!e.b||e==="key_dne")return t;var n=e.b.art;return e.b.art==="0"&&(n=""),{SongID:e.b.sID,SongName:e.b.sN,CalloutID:e.b.cID,ArtistID:e.b.arID,ArtistName:e.b.arN,AlbumID:e.b.alID,AlbumName:e.b.alN,UserID:e.b.uID,CoverArtFilename:n,TrackNum:e.b.t,EstimateDuration:e.b.estD,Flags:e.b.flags,token:e.b.tk,Tags:e.b.tags,ArtistIsClaimed:e.b.arCl,IsCallout:e.b.cID&&!e.b.sID,artistProfile:this.convertArtistProfileProperties(e.arp),broadcastUpVotes:e.bUV,broadcastDownVotes:e.bDV,broadcastListens:e.bL,queueSongID:e.queueSongID,tsPlayed:e.tsP}},convertArtistProfileProperties:function(e){var t,n,r;return e?(n=e.artist||{},r=e.user||{},t={artist:{ArtistID:n.arID,Name:n.arN,CoverArtFilename:n.art,IsVerified:n.isV,Flags:n.f,Bio:n.bio,BioAttribution:n.bioA,Tags:n.tags,UserID:n.proID},user:{UserID:r.uID,Flags:r.f}}):t={},t}}),n.Models.PlaylistSong=Backbone.MagicModelWrapper.extend({idAttribute:"playlistSongID",myAttributes:["playlistSongID"],wrappedClass:n.Models.Song,getImageURL:n.Models.Song.prototype.getImageURL});var h=function(e){return function(){var t=r.model.get("queue"),n=t&&t.get("songs"),i=this.get("queueSongID"),s=n&&n.get(i);s&&t.get("broadcast")===this.get("broadcast")&&s[e].apply(s,_.toArray(arguments))}};n.Models.BroadcastSong=Backbone.MagicModelWrapper.extend({idAttribute:"broadcastSongID",myAttributes:["broadcastSongID","broadcast","upVotes","downVotes","upVoteCount","downVoteCount","userVote","nowPlaying","queueSongID","noSkip","isActiveSong","listens","listensCounted","tsPlayed"],wrappedClass:n.Models.PlayableSongs,_useAlbumContextForImg:!0,parse:function(e,t){var n=t||{},r=0,i=0,s,o,u;return e.hasOwnProperty("b")?(u=a(e.b),u.queueSongID=e.queueSongID,u.upVotes=e.bUV,u.downVotes=e.bDV,u.broadcastListens=_.toInt(e.bL),u.tsPlayed=e.tsP||0):u=e,_.isNumber(u.upVotes)?r=u.upVotes:_.isNumber(u.broadcastUpVotes)&&(r=u.broadcastUpVotes),_.isNumber(u.downVotes)?i=u.downVotes:_.isNumber(u.broadcastDownVotes)&&(i=u.broadcastDownVotes),_.isArray(u.upVotes)?s=u.upVotes:_.isObject(u.upVotes)?s=_.keys(u.upVotes):s=[],_.isArray(u.downVotes)?o=u.downVotes:_.isObject(u.downVotes)?o=_.keys(u.downVotes):o=[],{broadcastSongID:u.broadcastSongID,broadcast:u.broadcast,upVoteCount:s.length||r,downVoteCount:o.length||i,upVotes:s,downVotes:o,userVote:_.toInt(u.userVote),nowPlaying:u.nowPlaying,queueSongID:u.queueSongID,noSkip:u.noSkip,isActiveSong:u.isActiveSong,listens:u.listens||u.broadcastListens||0,listensCounted:u.listensCounted,tsPlayed:u.tsPlayed||0}},addUpVote:function(e){var t=this.get("upVotes");c(t,e)&&(this.removeDownVote(e),this.trigger("change",this,{}),this.trigger("change:upVotes",this,t,{}),this.set("upVoteCount",t.length))},addDownVote:function(e){var t=this.get("downVotes");c(t,e)&&(this.removeUpVote(e),this.trigger("change",this,{}),this.trigger("change:downVotes",this,t,{}),this.set("downVoteCount",t.length))},removeUpVote:function(e){var t=this.get("upVotes");l(t,e)&&(this.trigger("change",this,{}),this.trigger("change:upVotes",this,t,{}),this.set("upVoteCount",t.length))},removeDownVote:function(e){var t=this.get("downVotes");l(t,e)&&(this.trigger("change",this,{}),this.trigger("change:downVotes",this,t,{}),this.set("downVoteCount",t.length))},load:h("load"),play:h("play"),pause:h("pause"),resume:h("resume"),suspend:h("suspend"),unsuspend:h("unsuspend"),seekTo:h("seekTo"),stop:h("stop"),getImageURL:n.Models.Song.prototype.getImageURL,toManateeProperties:function(){var e=this._wrapped.toManateeProperties();return e.bUV=this.get("upVotes"),e.bDV=this.get("downVotes"),e.bL=this.get("broadcastListens"),e.queueSongID=this.get("queueSongID"),e},makeWrappedModel:function(e,t){return e.CalloutID?n.Models.Callout.newOrUpdate(e,t):n.Models.Song.newOrUpdate(e,t)}}),n.Models.BroadcastSuggestion=Backbone.MagicModelWrapper.extend({idAttribute:"SongID",myAttributes:["broadcast","upVotes","userVote","upVoteCount","approvalStatus","suggester"],wrappedClass:n.Models.Song,parse:function(e,t){var r=t||{},i=0,s=r.suggester||e.suggester,o;return _.isNumber(e.upVotes)&&(i=e.upVotes),_.isArray(e.upVotes)?o=e.upVotes:_.isObject(e.upVotes)?o=_.keys(e.upVotes):e.u&&_.isArray(e.u)?o=e.u:o=[],!s&&e.o&&e.o.z&&!e.o.r?s=new n.Models.TinyUser(e.o):!s&&e.ownerData&&e.ownerData.z&&!e.ownerData.r&&(s=new n.Models.TinyUser(e.ownerData)),{broadcast:e.broadcast,upVoteCount:o.length||i,upVotes:o||[],userVote:_.toInt(e.userVote),approvalStatus:_.toInt(e.approvalStatus),suggester:s,SongID:_.toInt(e.SongID)}},addUpVote:n.Models.BroadcastSong.prototype.addUpVote,removeUpVote:n.Models.BroadcastSong.prototype.removeUpVote,getImageURL:n.Models.Song.prototype.getImageURL});var p=["toUrl","hasUrl","toArtistUrl","getArtists","getAlbums","toAlbumUrl","getToken","getDetailsForFeeds","getDetailsForSwf","toProxyLabel","getPageNameData","getAnchorTag","getArtistAnchorTag","getAlbumAnchorTag"];Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.BroadcastSong,p),p.push("play"),p.push("toManateeProperties"),Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.PlaylistSong,p),Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.BroadcastSuggestion,p),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.BroadcastSong),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.PlaylistSong),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.BroadcastSuggestion)}(),function(){function N(e,t){return e._wrapped&&e instanceof Backbone.Model?e._wrapped:e.attributes&&e instanceof Backbone.Model?e:e.CalloutID||e.calloutID?n.Models.Callout.newOrUpdate(e,t):n.Models.Song.newOrUpdate(e,t)}n.Models=n.Models||{};var t={NONE:0,INITIALIZING:1,LOADING:2,PLAYING:3,PAUSED:4,BUFFERING:5,FAILED:6,COMPLETED:7,SUSPENDED:8},i={},s=!0,o,u=function(t){var r=$.Deferred(),i=n.getAPIReqInfo("getStreamKeyFromSongIDEx",{},t),s=$.stringify(i.req);console.log("sending req",i),o.send($.stringify({cowbellData:s,cowbellHost:e.location.host}));var u=function(e){e.result&&e.result.ip&&(console.log(e.result),o.eventDispatcher.off("message",u),r.resolve(e.result))};return o.eventDispatcher.on("json",u),r.promise()};$(document).ready(function(){return});var a=function(){this._downloadReported=!1,this._playbackReported=!1,this._30secReported=!1,this._completeReported=!1,this._lastPosition=0,this._culmulativePlayTime=0},f=function(){console.warn("markDownloaded");if(this.get("isCallout")||this._downloadReported)return;this._downloadReported=!0;var e={streamKey:this._lastStreamKey,streamServerID:this._lastStreamServerID,songID:this._wrapped.get("SongID")};n.Services.API.makeRequest(!1,"markSongDownloadedEx",e)},l=function(){console.warn("markPlayed"),this._playbackReported=!0;var e={streamKey:this._lastStreamKey,streamServerID:this._lastStreamServerID,songQueueSongID:this.id,songQueueID:_.toInt(this.get("parentQueueID"))};this.get("isCallout")?(e.calloutID=this.get("CalloutID"),n.Services.API.makeRequest(!1,"markCalloutPlayed",e)):(e.songID=this._wrapped.get("SongID"),n.Services.API.makeRequest(!1,"markSongQueueSongPlayed",e))},c=function(){console.warn("mark30"),this._30secReported=!0;if(this.get("isCallout"))return;var e={streamKey:this._lastStreamKey,streamServerID:this._lastStreamServerID,songQueueSongID:this.id,songQueueID:_.toInt(this.get("parentQueueID")),songID:this._wrapped.get("SongID"),artistID:this._wrapped.get("ArtistID")},t={},r=n.getLoggedInUserID(),i=n.Models.User.getCached(r);n.Models.PlayableSong.fetchFlattr&&(t.extraHeaders={flattr:1}),this._wrapped.get("tags")&&(e.getTags=!1),this.trigger("mark30"),n.Services.API.makeRequest(!1,"markStreamKeyOver30Seconds",e,t).done(_.bind(function(e){e&&((e.pageInfo||e.songPageInfo)&&n.trigger("flattr:flattrData",e),e.tags&&this._wrapped.set("tags",e.tags),e.hasOwnProperty("artistClaimed")&&(e.artistIsClaimed?this._wrapped.set("artistIsClaimed",1):this._wrapped.set("artistIsClaimed",0)),n.isBroadcastListener()||i.updateListenTimestamps(!0))},this))},h=function(){console.warn("markComplete",this),this._completeReported=!0;if(this.get("isCallout"))return;var e={streamKey:this._lastStreamKey,streamServerID:this._lastStreamServerID,songID:this._wrapped.get("SongID"),song:this._wrapped.getDetailsForFeeds()};e.song.token=_.orEqual(this._wrapped.get("token"),""),e.song.tagIDs=[];var t=this._wrapped.get("tags");t&&t.length&&_.each(t,function(t){e.song.tagIDs.push(t.tid)});var r=this.get("context")||{};r=_.clone(r),r.data=r.data||{},r.data.client="jsqueue",r.type||(r.type="unknown"),e.context={type:r.type,data:r.data},this.get("broadcastInfo")&&(e.broadcastInfo=this.get("broadcastInfo"));var i=n.getLoggedInUserID();if(i>0){var s=n.Models.User.getCached(i);s&&(e.user={userID:i,username:s.get("Name"),picture:s.get("Picture"),isPremium:s.get("subscription").isPremium()})}n.Services.API.makeRequest(!1,"markSongComplete",e)},p=function(e,r){var i,s;console.log("failed!",e,r,this),this.set({playStatus:t.FAILED,paused:!0,lastError:e}),this.trigger("error",e),e&&e.src==="handle"&&(i=this._lastStreamServer,s=this.get("token"),i&&n.Services.Log.notify("StreamKey playback failed","ERROR",{server:i,token:s,msg:e.msg}))},d=function(e){var r=e||{},s={prefetch:!this._playOnStreamKey,country:n.Services.API.country,mobile:n.Models.PlayableSong.useMobile,type:n.Models.PlayableSong.calculateStreamType(this.get("context"))},f=!this.get("isCallout")&&this._wrapped.get("SongID");r.params=s,a.call(this),this.set({playStatus:t.INITIALIZING,paused:!this.get("active")}),!r.streamKey&&f&&i.hasOwnProperty(f)&&(i[f].Expires&&i[f].Expires*1e3>Date.now()&&_.extend(r,i[f]),delete i[f]);if(r.streamKey&&r.ip&&r.streamServerID){m.call(this,r,{streamKey:r.streamKey,ip:r.ip,streamServerID:r.streamServerID,uSecs:_.toInt(r.uSecs),FileToken:""});return}if(!this._wrapped||!this._wrapped.id){p.call(this,{msg:"FAILED_MUST_PROVIDE_STREAMKEY"});return}if(n.Models.PlayableSong.consecutiveFailedStreamKeys>4){n.Models.PlayableSong.consecutiveFailedStreamKeys=0,p.call(this,{msg:"FAILED_TOO_MANY_STREAMKEY_FAILS"});return}if(this._fileTokenAttempts>1){this._fileTokenAttempts=0,p.call(this,{msg:"FAILED_STREAMKEY_OTHER"});return}var l,c=this._wrapped.get("token"),h=this.get("isCallout");h?s.calloutID=this.get("CalloutID"):s.songID=f;if(r.useFileToken&&c&&!h)s.fileToken=c,l=n.Services.API.makeRequest(!1,"getStreamKeyFromFileToken",s);else if(h)l=n.Services.API.makeRequest(!1,"getStreamKeyInfoFromCalloutID",s),this._fetchingFileToken=!0,this._fileTokenAttempts++;else{var d=$.Deferred();if(r.fastFetch&&o&&o.getIsAvailable()&&n.Services.AudioHandle.canUseWebAudioAPI()){n.Services.AudioHandle.setFastFetchSocket(o);var g=function(){u(s).done(function(e){d.resolve(e)}).fail(function(){d.reject()})};switch(o.readyState){case WebSocket.CONNECTING:l=d,o.onopen=g;break;case WebSocket.OPEN:l=d,g()}}l||(r.fastFetch=!1,h?l=n.Services.API.makeRequest(!1,"getStreamKeyInfoFromCalloutID",s):l=n.Services.API.makeRequest(!1,"getStreamKeyFromSongIDEx",s)),c||(this._fetchingFileToken=!0),this._fileTokenAttempts++}l&&l.done(_.bind(m,this,r)).fail(_.bind(v,this,r))},v=function(e,t){console.warn("streamkey fail",t),n.Models.PlayableSong.consecutiveFailedStreamKeys++,this._wrapped.get("token")||(this._fetchingFileToken=!1),t&&t.code==512?p.call(this,{msg:"FAILED_STREAMKEY_LIMIT"}):p.call(this,{msg:"FAILED_STREAMKEY_OTHER"})},m=function(e,r){var i=e||{},s=i.params,u;this._fetchingFileToken=!1,this._fileTokenAttempts=0;if(!this._cancelPendingPlayback){if(!r){n.Models.PlayableSong.consecutiveFailedStreamKeys++,p.call(this,{msg:"FAILED_STREAMKEY_OTHER"});return}var a=r.streamKey,l=r.ip,c=r.streamServerID,h=r.FileToken,d=_.toInt(r.uSecs),v;if(i.fastFetch)n.Services.AudioHandle.setFastFetchSocket(o);else{if(!(!s.prefetch||a!=="false"&&a!=="null")){console.log("none!"),this.set({playStatus:t.NONE,paused:!0}),this._loadingStarted=0,this._playOnStreamKey&&(this._playOnStreamKey=!1,this.play());return}if(a==="false"||a==="null"||l==="null"||!c){n.Models.PlayableSong.consecutiveFailedStreamKeys++,p.call(this,{msg:"FAILED_STREAMKEY_OTHER"});return}}n.Models.PlayableSong.consecutiveFailedStreamKeys=0,gsConfig&&gsConfig.runMode!="production"&&gsConfig.runMode!="preview"&&gsConfig.runMode!="framily"&&(l="staging."+l),l&&a&&(v=["http://",l,"/stream.php?streamKey=",a].join("")),i.fastFetch&&(v=""),this._lastStreamKey=a,this._lastStreamServerID=c,this._lastStreamServer=l,this._lastStreamKeyTime=Date.now(),this._loadingStarted=0,this._handle.setSource(v),g.call(this,this._handle),f.call(this),this.set({playStatus:t.LOADING,paused:this.get("active")!==!0}),this._playOnStreamKey&&T.call(this,0,i),h&&!this._wrapped.get("token")&&this._wrapped.set("token",h),d&&this.set("duration",d/1e3)}},g=function(e){this._handle&&this._handle!==e&&(this._handle.off(null,null,this),this._handle.destroy(),this._handle=null),e&&(this._handle=e,e.on("error",y,this),e.on("playing",b,this),e.on("buffering",w,this),e.on("update",E,this),e.on("complete",S,this),e.on("seeking",x,this),e.trigger("setup")),this.set({position:0,percentLoaded:0})},y=function(e,t){if(e!==this._handle)return;p.call(this,_.extend({src:"handle"},t)),g.call(this,null)},b=function(e,n){if(e!==this._handle)return;console.log("playing!",this),this._playbackReported||l.call(this),this._suspended?this.set({playStatus:t.SUSPENDED,paused:!0}):this.set({playStatus:t.PLAYING,paused:!1})},w=function(e,n){if(e!==this._handle)return;this.set({playStatus:t.BUFFERING,paused:!1})},E=function(e,t){if(e!==this._handle)return;var n=Date.now(),r;t.hasOwnProperty("position")&&(isNaN(t.position)||t.position===Infinity)&&delete t.position,t.hasOwnProperty("duration")&&(isNaN(t.duration)||t.duration===Infinity)&&delete t.duration,t&&this.set(t),t.position&&(r=t.position-this._lastPosition,!this._suspended&&!this._justSeeked&&r>0&&(n-this._lastSeek>1e3||r<2e3)&&(this._culmulativePlayTime+=r),this._justSeeked=!1,this._lastPosition=t.position,this._culmulativePlayTime>=3e4&&!this._30secReported&&c.call(this))},S=function(e,n){if(e!==this._handle)return;this._playOnStreamKey=!1,!this._completeReported&&this._culmulativePlayTime>=3e4&&h.call(this),g.call(this,null),this.set({playStatus:t.COMPLETED,paused:!0,position:0})},x=function(){this._justSeeked=!0,this._lastSeek=Date.now()},T=function(e,t){if(!this._handle)return;var r=t||{},i=e||0;console.log("got playFrom",r),r.position&&(i=t.position),i<0&&(i=0);var s=i===0&&r.crossFade&&!this._suspended;s&&this._handle.setVolume(0),this._handle.pause(),this._handle.seekTo(i),this._handle.play(r),s&&this._handle.setVolume(1,n.Models.PlayableSong.crossfadeLength).done(_.bind(function(e){e==="complete"&&this.trigger("fadeInComplete")},this))};n.Models.PlayableSong=Backbone.MagicModelWrapper.extend({idAttribute:"queueSongID",myAttributes:["queueSongID","context","paused","active","smile","frown","suggestion","songQueueHelper","source","parentQueueID","autoplayVote","artistIsClaimed","reportedUpcomingInBroadcast","isCallout","broadcastPlayed","position","duration","playerDuration","playStatus","percentLoaded","msLoaded"],makeWrappedModel:N,_useAlbumContextForImg:!0,parse:function(e,t){if(t&&t.skipParse)return e;var r=t||{},i=e,s={},o,u,a,f;i._wrapped&&e instanceof Backbone.Model?(i=i._wrapped.toJSON(),f=e.get("queueSongID"),f&&(i.queueSongID=f)):i.attributes&&e instanceof Backbone.Model&&(i=i.toJSON());for(o=0,u=this.myAttributes.length;o<u;o++)a=this.myAttributes[o],i.hasOwnProperty(a)&&(s[a]=i[a]);return s.queueSongID||(s.queueSongID=++n.Models.PlayableSong.highestQueueSongID),s.playStatus=_.toInt(s.playStatus),s.paused=s.paused||n.Models.Player.isPlayStatusPlaying(s.playStatus),_.isUndefined(s.autoplayVote)||(s.autoplayVote=_.toInt(s.autoplayVote),s.smile=s.autoplayVote==1||s.source=="user"&&s.autoplayVote===0,s.frown=s.autoplayVote==-1),s.smile=s.smile||!1,s.frown=s.frown||!1,!s.context&&t.context&&t.context instanceof n.Models.PlayContext&&(s.context=t.context),s.isCallout=i.CalloutID>0,s.broadcastPlayed=e.tsPlayed?!0:!1,s.context||(s.context=new n.Models.PlayContext,s.context.addDefaultType()),s},initialize:function(){this._playOnStreamKey=!1,this._loadingStarted=0,this._bufferingStarted=0,this._fileTokenAttempts=0,this._fetchingFileToken=!1,this.playAttempts=0,a.call(this),n.Models.PlayableSong.highestQueueSongID=Math.max(this.id,n.Models.PlayableSong.highestQueueSongID)},load:function(e){var r=e||{},i=Date.now(),s=this.get("playStatus"),o;if(i-this._loadingStarted<2e4)return;if(!this._playbackReported&&this._lastStreamKey&&this._lastStreamKeyTime&&i-this._lastStreamKeyTime<9e4)return;if(s==t.INITIALIZING||s==t.PLAYING||s==t.BUFFERING||s==t.LOADING||s==t.PAUSED)return;if(s==t.FAILED)return;if(this._handle&&!this._30secReported)return;o=n.Services.AudioHandle.getAudioHandle("",r),this._handle&&this._handle!==o&&console.warn("new handle returned... possibly overlapping songs",this._handle),this._handle=o,this._loadingStarted=i,this._cancelPendingPlayback=!1,d.call(this,r)},playInQueue:function(e){var t=$.Deferred(),r=e||{};return r.context=r.context||new n.Models.PlayContext,n.trigger("player:addSongsEx",[this],r),t.resolve(),t.promise()},play:function(e){var i=e||{},o=this.get("playStatus"),u=this.get("position"),a=n.getLoggedInUserID(),f=n.Models.User.getCached(a),l=_.indexOf(r.model.get("paywalledCountries"),gsConfig.country.ID)>-1,c,h,p,v;console.log("playablesong play",this),f.updateListenTimestamps(),p=n.Services.Local.get("listenTimestamps"+f.get("UserID")),c=p&&p.length>f.get("listenLimit")-1;if(c&&!f.get("subscription").isPremium()&&!n.isBroadcastListener()&&l){n.router.setHash("upgrade"),n.trigger("lightbox:open","paywall");return}if(i.playOnAdd||i.context||i.index||i.streamType)return this.playInQueue(i);this.playAttempts++;switch(o){case t.INITIALIZING:this._loadingStarted=Date.now(),this._playOnStreamKey=!0;return;case t.LOADING:this._playOnStreamKey=!0;break;case t.BUFFERING:case t.PLAYING:if(i.noReset||u<5)return}if(this._handle&&!this._handle._destroyed&&!this._30secReported){T.call(this,0,i);return}this._playOnStreamKey=!0,this._cancelPendingPlayback=!1,v=gsConfig.assetHost+"/webincludes/singleFrame.mp3",i.isDefaultSrc=!0,h=n.Services.AudioHandle.getAudioHandle(v,i),h&&(this._handle=h),s&&h&&h.play(),d.call(this,i)},getHandleType:function(){return this._handle&&this._handle.type},getCurrentStreamServer:function(){return this._handle&&this._lastStreamServer?"http://"+this._lastStreamServer:""},stop:function(){if(this._handle){this._handle.pause();var e=this.get("playStatus");e!==t.COMPLETED&&e!==t.FAILED&&this.set({playStatus:t.NONE,paused:!0}),g.call(this,null)}this._playOnStreamKey=!1,this._cancelPendingPlayback=!0},pause:function(){this._handle?(this.set({playStatus:t.PAUSED,paused:!0}),n.Models.PlayableSong.pauseFade&&!this._suspended?this._handle.setVolume(0,_.toInt(n.Models.PlayableSong.fadeOutLength)).done(_.bind(function(e){e!=="interrupted"&&this._handle.pause()},this)):this._handle.pause()):this._playOnStreamKey=!1},resume:function(){this._handle&&(this._handle.play(),this.set({playStatus:t.PLAYING,paused:!1}),n.Models.PlayableSong.pauseFade&&!this._suspended&&this._handle.setVolume(1,_.toInt(n.Models.PlayableSong.fadeInLength)))},suspend:function(e){this._suspended=!0,this.set({playStatus:t.SUSPENDED,paused:!!e}),this._handle&&this._handle.setVolume(0)},unsuspend:function(){this._suspended=!1,this.get("playStatus")===t.SUSPENDED&&this.set({playStatus:t.PLAYING,paused:!1}),this._handle&&this._handle.setVolume(1)},seekTo:function(e){this._handle&&this._handle.seekTo(e)},crossfadeOut:function(){this._handle&&!this._suspended&&!this.fadingOut&&(this.fadingOut=!0,this._handle.setVolume(0,n.Models.PlayableSong.crossfadeLength).done(_.bind(function(e){this.fadingOut=!1,e==="complete"&&this.trigger("fadeOutComplete")},this)))},getImageURL:n.Models.Song.prototype.getImageURL,toManateeProperties:function(){var e=this._wrapped.toManateeProperties();return e.queueSongID=this.id,e}},{highestQueueSongID:0,consecutiveFailedStreamKeys:0,consecutiveFailedTokens:0,useStaging:!1,useMobile:!1,crossfadeLength:5e3,pauseFade:!1,fadeOutLength:600,fadeInLength:1500,fetchFlattr:!1,precacheStreamKeys:function(e){var t={songIDs:e,prefetch:!1,country:n.Services.API.country,mobile:n.Models.PlayableSong.useMobile,type:this.calculateStreamType(new n.Models.PlayContext({}))};n.Services.API.makeRequest(!1,"getStreamKeysFromSongIDs",t).done(function(e){e&&_.extend(i,e)})},calculateStreamType:function(e){var t=n.Models.PlayContext,r=t.TYPE_DEFAULT,i=n.getLoggedInUserID(),s=i>0?n.Models.User.getCached(i):!1;s&&s.getIsPremium()&&(r|=t.TYPE_VIP);if(e.streamType)r|=_.toInt(e.streamType);else if(e.type)switch(e.type){case"playlist":r|=t.TYPE_PLAYLIST;break;case"radio":e.data&&e.data.tagID?r|=t.TYPE_STATION:r|=t.TYPE_RADIO;break;case"user":e.data&&e.data.userID&&e.data.userID==i&&(r|=t.TYPE_LIBRARY);break;case"popular":r|=t.TYPE_POPULAR}return r}});var C=["toUrl","hasUrl","toArtistUrl","getArtists","getAlbums","toAlbumUrl","getToken","getDetailsForFeeds","getDetailsForSwf","toProxyLabel","getSingleItemContextMenu","getPageNameData","getAnchorTag","getArtistAnchorTag","getAlbumAnchorTag"];Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.PlayableSong,C),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.PlayableSong)}(),function(){function s(e,t,r){if(!r)return o.call(this,e,t);var i=r.Data||{},s={pageNameData:i,PathName:(r.Name&&r.Name.indexOf("/")>-1?"":r.Name)||"",Tags:new n.Models.Collections.Tags(i.Tags||[]),customRelatedArtists:i.RelatedArtists?new n.Models.Collections.Artists(i.RelatedArtists):null},u;!s.PathName&&this.get("PathName")&&delete s.PathName,i.FavoriteCount>0&&(s.followerCount=_.toInt(i.FavoriteCount)),i.Location&&(u=_.filter([i.Location.City,i.Location.State,i.Location.Country],_.defined),s.Location=u.join(", ")),this.set(s);if(!e)return;t==="data"?e.resolve(this.get("pageNameData")):e.resolve(this.get("PathName"))}function o(e,t){this.set({PathName:"",pageNameData:{}}),e&&e.resolve(null)}function u(e,t){if(!t)return a.call(this,e,type);var n=t.Data||{},r={profilePageNameData:n};this.set(r);if(!e)return;e.resolve(n)}function a(e,t){e&&e.resolve(null)}function f(e,t,n){if(n&&n.success){var r={};t.hasOwnProperty("bio")&&(r.Bio=t.bio),t.hasOwnProperty("bioAttribution")&&(r.BioAttribution=t.bioAttribution),t.urls&&(this.get("pageNameData")&&this.get("pageNameData").URLs?r.URLs=$.extend({},this.get("pageNameData").URLs,t.urls):r.URLs=t.urls),t.ArtistName&&this.set("pendingArtistName",t.ArtistName);var i=$.extend({},_.orEqual(this.get("pageNameData"),{}),r);this.set("pageNameData",i),e.resolve(this.get("pageNameData"))}else c(e,n?n.errorCode:0)}function l(e,t,r){r?(this.get("PathName")&&n.router.uncachePageName(this.get("PathName")),t?(this.set("PathName",t),n.router.cachePageName(t,"artist",this.id)):this.set("PathName",""),e.resolve(this.get("PathName"))):c(e,r)}function c(e,t){e.reject(t)}function h(e){return function(t){return t.get("ArtistID")===e}}function p(e,t,n,r){if(!r)return c(e,r);for(var i=0;i<n.length;i++)n[i].removeArtist(t);e.resolve(n)}function d(e,t,r){if(!r)return c(e,r);for(var i=0;i<t.length;i++)n.Models.Song.uncache(t[i]);n.trigger("songs:deleted",t),e.resolve()}function v(e,t,r){if(!r||!r.events){e.reject();return}t&&this.attributes.feed?this.attributes.feed.add(r.events):this.set("feed",new n.Models.Collections.FeedEvents(r.events,{feedType:"model",ownerModel:this,initialPageableItemLimit:25,pageableItemsPerLoad:25,modelOptions:{dontCache:!0}})),e.resolve(this.attributes.feed,r.events)}function m(e){var t=_.toInt(e.attributes.Flags||0),n=e.attributes.ReleaseType,r=_.defined(e.attributes.IsVerified)||e.attributes.source=="songData"?e.attributes.IsVerified:e.attributes.IsVerifiedSongs;return n==1&&e.attributes.ReleaseStatus==1&&r&&(t>=512||t===0)?"fullAlbums":(n==2||n==3)&&r&&e.attributes.ReleaseStatus==1&&(t>=512||t===0)?"singlesEPs":"others"}function g(){var e=this.attributes.albums?this.attributes.albums.models:[],t={fullAlbums:[],singlesEPs:[],others:[]},r=0,i=e.length,s,o,u=_.any(e,function(e){return e.attributes.ReleaseType>0});if(u){for(;r<i;r++)s=e[r],o=m(s),o&&t[o].push(s);this.set({hasReleaseTypes:!0,fullAlbums:new n.Models.Collections.Albums(t.fullAlbums),singlesEPs:new n.Models.Collections.Albums(t.singlesEPs),others:new n.Models.Collections.Albums(t.others)}),this.attributes.albums.on("add",_.bind(y,this,"add")),this.attributes.albums.on("remove",_.bind(y,this,"remove")),this.attributes.albums.on("change",_.bind(y,this,"change"))}else this.set({hasReleaseTypes:!1})}function y(e,t){function a(e){r.attributes[e].indexOf(t)!=-1&&r.attributes[e].remove(t)}if(e=="change"){var n=t.changedAttributes();if(!(n.hasOwnProperty("ReleaseType")||n.hasOwnProperty("ReleaseStatus")||n.hasOwnProperty("IsVerified")||n.hasOwnProperty("Flags")))return}var r=this,i=m(t),s=["fullAlbums","singlesEPs","others"],o=0,u=s.length;switch(e){case"add":i&&this.attributes[i].add(t);break;case"remove":for(;o<u;o++)a(s[o]);break;case"change":for(;o<u;o++)i&&s[o]==i?this.attributes[i].add(t):a(s[o])}}n.Models=n.Models||{};var i=36e5;n.Models.Artist=Backbone.CachedModel.extend({idAttribute:"ArtistID",parse:function(e,r){if(r&&r.skipParse)return e;var i=r||{},s=_.orEqualEx(e.ArtistName,e.Name,e.artistName)||_.getString("UNKNOWN_ARTIST"),o;return e.Tags&&(o=new n.Models.Collections.Tags(e.Tags)),{ArtistID:_.toInt(_.orEqual(e.ArtistID,e.artistID)),ArtistName:s,searchText:s.toLowerCase(),CoverArtFilename:_.orEqualEx(e.ArtistCoverArtFilename,e.CoverArtFilename,e.artFilename),PageArtFilename:_.orEqual(e.PageArtFilename,""),isFavorite:!!e.isFavorite||!!i.isFavorite,IsVerified:e.IsVerified,Flags:typeof e.Flags!="undefined"?_.toInt(e.Flags):t,Tags:o,rawPageNameData:e.pageNameData||e.rawPageNameData,profilePageNameData:e.user&&e.user.pageNameData||t,profileID:_.toInt(e.profileID||e.ProfileID)||t,PathName:e.PathName,Popularity:e.Popularity,Picture:e.Picture,TSFavorited:_.toInt(e.TSFavorited),ShortBio:e.ShortBio,followerCount:e.FollowerCount!=null?_.toInt(e.FollowerCount):t,sampleTagID:e.sampleTagID,Bio:e.Bio,BioAttribution:e.BioAttribution}},initialize:function(e,t){return e.rawPageNameData&&(this.setPageNameData(e.rawPageNameData),this.unset("rawPageNameData",{silent:!0})),e.profilePageNameData&&u.call(this,$.Deferred(),e.profilePageNameData),Backbone.CachedModel.prototype.initialize.call(this,e,t)},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e),r=e.pageNameData||e.rawPageNameData;if(e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;!this.attributes.CoverArtFilename&&e.CoverArtFilename&&(n.CoverArtFilename=e.CoverArtFilename),!this.attributes.PageArtFilename&&e.PageArtFilename&&(n.PageArtFilename=e.PageArtFilename),delete e.pageNameData,delete e.rawPageNameData,this.set(n,t),r&&this.setPageNameData(r)},getSongs:function(){if(this.loadSongsDfd)return this.loadSongsDfd.promise();var e=$.Deferred(),t;return n.isLoggedInUserOwnerOfArtist(this.id)?t=n.Services.API.artistGetArtistSongs(this.id,5e3,!0):t=n.Services.API.artistGetArtistSongs(this.id),t.done(_.bind(function(t){var r={},i={},s=[],o=this.id,u;_.each(t,function(e){u=e.AlbumID,r[u]?r[u].attributes.IsVerifiedSongs!=1&&r[u].set("IsVerifiedSongs",e.IsVerified):(r[u]=n.Models.Album.newOrUpdate({AlbumID:u,AlbumName:e.AlbumName,ArtistID:e.AlbumArtistID,ArtistName:e.AlbumArtistName||e.ArtistName,CoverArtFilename:e.CoverArtFilename,IsVerifiedSongs:e.IsVerified,ReleaseType:e.ReleaseType,ReleaseStatus:e.ReleaseStatus,Year:e.Year,source:"songData"},{srcArtist:this}),i[u]=[],e.AlbumArtistID==o&&s.push(r[u])),i[u].push(e)});var a=new n.Models.Collections.Songs(t,{srcArtist:this,srcAlbums:r});this.set("songs",a),_.each(s,function(e){i[e.id]&&e.setSongsFromArtist(i[e.id],this,a)}),this.attributes.albums?this.attributes.albums.add(s,{srcArtist:this}):(this.set("albums",new n.Models.Collections.Albums(s,{srcArtist:this})),g.call(this)),e.resolve(a)},this)),t.fail(function(t){e.reject(t)}),this.loadSongsDfd=e,e.promise()},getTopSongs:function(e){var t=$.Deferred(),r;e?r=this.get("topSongs"):r=this.get("featuredSongs");if(r)t.resolve(r);else{var i=new ChainLoading,s,o;i.pushIgnoreFail(this.getSongs()),i.pushIgnoreFail(this.getPageNameData().done(i.bind(function(i){s=this.get("songs");if(!s){t.reject();return}if(i.hasOwnProperty("FeaturedSongIDs")){r=[],_.each(i.FeaturedSongIDs,function(e){o=s.get(e),o&&r.push(o)});if(r.length>0){r=new n.Models.Collections.Songs(r),this.set("featuredSongs",r),t.resolve(r);return}}e=!0},this)).fail(i.bind(function(){e=!0}))),i.done(_.bind(function(r){if(!e)return;s=this.get("songs");if(!s){t.reject();return}var i=function(e){return _.toInt(e.attributes.Popularity)*-1},o=_.sortBy(s.models,i),u=new n.Models.Collections.Songs(_.take(o,100),{comparator:i});this.set("topSongs",u),t.resolve(u)},this))}return t.promise()},getAlbums:function(){if(this.loadAlbumsDfd)return this.loadAlbumsDfd.promise();var e=$.Deferred();return this.get("albums")?e.resolve(this.get("albums")):(this.getSongs().done(_.bind(function(){e.resolve(this.get("albums"))},this)).fail(_.bind(function(){e.reject()},this)),this.loadAlbumsDfd=e),e.promise()},getAllAlbums:function(){if(this.loadAllAlbumsDfd&&this.loadAllAlbumsDfd.state()!=="rejected")return this.loadAllAlbumsDfd.promise();var e=$.Deferred(),t=this.id,r=this.get("albums"),i=n.isLoggedInUserOwnerOfArtist(t);return r&&r.isAllAlbums?(e.resolve(r),e.promise()):(n.Services.API.artistGetAllAlbums(t,i).done(_.bind(function(r){var i=[],s=[],o=this.get("ArtistName"),u;r&&r.albums&&(i=r.albums);for(var a=0,f=i.length;a<f;a++)!i[a].ArtistName&&i[a].ArtistID==t&&(i[a].ArtistName=o),(u=n.Models.Album.getCached(i[a].AlbumID))?u.updateLocalInfo(i[a]):u=new n.Models.Album(i[a]),s.push(u);if(this.attributes.albums)this.attributes.albums.add(s);else{var l=new n.Models.Collections.Albums(s);l.isAllAlbums=!0,this.set("albums",l),g.call(this)}e.resolve(this.attributes.albums)},this)).fail(_.bind(e.reject,e)),this.loadAllAlbumsDfd=e,e.promise())},getRelatedArtistsRecs:function(){if(this.loadSimilarArtistsDfd)return this.loadSimilarArtistsDfd.promise();var e=$.Deferred(),t=this.get("relatedArtists");return t?e.resolve(t):(n.Services.API.artistGetSimilarArtists(this.id).done(_.bind(function(r){t=new n.Models.Collections.Artists(r.SimilarArtists),this.set("relatedArtists",t),e.resolve(t)},this)),this.loadSimilarArtistsDfd=e),e.promise()},getFollowers:function(){if(this.loadFollowersDfd)return this.loadFollowersDfd.promise();var e=$.Deferred();return this.get("followers")?e.resolve(this.get("followers")):(n.Services.API.artistGetFans(this.id,0).done(_.bind(function(t){var r=new n.Models.Collections.Users(t.Return.fans);this.set("followers",r),e.resolve(r)},this)),this.loadFollowersDfd=e),e.promise()},toUrl:function(e){var t=this.get("PathName")||"";if(t&&t.indexOf("/")===-1)return _.makeUrlFromPathName(t,e);var n=this.get("profileID");return n?_.cleanUrl(this.get("ArtistName"),n,"profile",null,e):_.cleanUrl(this.get("ArtistName"),this.id,"artist",null,e)},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("ArtistID"),"artist").done(_.bind(s,this,e,"name")).fail(_.bind(o,this,e)),e.promise()},getPageNameData:function(e){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected"&&!e)return this.pageNameDataDfd.promise();var t=new $.Deferred,r=this.get("pageNameData");return!e&&r?t.resolve(r):n.Services.API.getPageInfoByIDType(this.get("ArtistID"),"artist",e).done(_.bind(s,this,t,"data")).fail(_.bind(o,this,t)),this.pageNameDataDfd=t,t.promise()},getProfilePageNameData:function(e){if(this.profilePageNameDataDfd&&this.profilePageNameDataDfd.state()!="rejected"&&!e)return this.profilePageNameDataDfd.promise();var t=new $.Deferred,r=this.get("profileID"),i=this.get("profilePageNameData");return!e&&i?t.resolve(i):r?n.Services.API.getPageInfoByIDType(r,"user",e).done(_.bind(u,this,t)).fail(_.bind(a,this,t)):n.Models.Profile.get(null,this.get("ArtistID"),!1,!0).done(_.bind(function(e){if(!e||!e.attributes.pageNames){t.reject();return}u.call(this,t,e.attributes.pageNames.user)},this)).fail(_.bind(t.reject,t)),this.profilePageNameDataDfd=t,t.promise()},setPageNameData:function(e){var t=e&&!e.Data?{Data:e}:e;s.call(this,null,"data",t)},getRelatedArtists:function(){if(this.getRelatedArtistsDfd&&this.getRelatedArtistsDfd.state()!=="rejected")return this.getRelatedArtistsDfd.promise();var e=$.Deferred(),t=this.get("customRelatedArtists")||this.get("relatedArtists");if(t!=null)e.resolve(t);else{var n=new ChainLoading;n.push(this.getPageNameData().done(n.bind(function(){t=this.get("customRelatedArtists"),t&&e.resolve(t)},this))),n.push(this.getRelatedArtistsRecs().done(n.bind(function(t){if(e.state()!=="pending")return;e.resolve(t)},this)))}return this.getRelatedArtistsDfd=e,e.promise()},getTags:function(){var e=new $.Deferred,t=this.get("Tags");return t!=null?e.resolve(t):this.getPageNameData().done(_.bind(function(){var t=this.get("Tags");if(!t){var n=this.get("pageNameData");n&&n.Tags&&(t=n.Tags,this.set("Tags",t))}e.resolve(t)},this)).fail(e.reject),e.promise()},getSongkickEvents:function(){if(this.songkickDfd)return this.songkickDfd.promise();var e=$.Deferred();return this.get("songkickEvents")?e.resolve(this.get("songkickEvents")):(n.Services.API.getSongkickEventsFromArtists([this.id],[this.get("ArtistName")]).done(_.bind(function(t){var r=new n.Models.Collections.Events(t);r.comparator=_.getModelSort("StartTime",!0),r.sort(),this.set("songkickEvents",r),e.resolve(r)},this)),this.songkickDfd=e),e.promise()},getImageURL:function(e){e!==""&&(e=_.orEqual(e,70)+"_");var t=_.getImageURL(n.Models.Artist.artPath+e+"artist.png");return this.get("CoverArtFilename")?_.getImageURL(n.Models.Artist.artPath+e+this.get("CoverArtFilename")):t},getPageImageURL:function(t){var r=_.getCDNImage(n.Models.User[_.isRetina()?"artistCoverArtPathDefaultRetina":"artistCoverArtPathDefault"]),i="?co="+e.location.host,s=this.get("profilePageNameData"),o=new $.Deferred,u,a,f;return t=t||1280,u=_.bind(function(e){if(e.CoverPhoto){o.resolve(_.getImageURL(n.Models.User.coverArtPath+t+"_"+e.CoverPhoto+i));return}if(!e.StockCoverPhoto){o.resolve(r+i);return}a=n.Models.Cover.covers[e.StockCoverPhoto],a?(f=new n.Models.Cover(a),o.resolve(f.getCoverPath())):o.reject()},this),s?u(s):this.getProfilePageNameData().done(u),o.promise()},setCoverPhoto:function(e,t,n){var r=this.get("profilePageNameData"),i;e?(i=(new Date).getTime(),r.CoverPhoto=e+"?"+i,delete r.StockCoverPhoto,this.trigger("change:profilePageNameData")):(r.StockCoverPhoto=t,r.CoverPhotoY=n,delete r.CoverPhoto,this.trigger("change:profilePageNameData"))},getImageAttribution:function(){if(this.loadAttribution)return this.loadAttribution.promise();var e=$.Deferred();return this.get("attribution")?e.resolve(this.get("attribution")):(n.Services.API.artistGetArtAttribution(this.id).done(_.bind(function(t){if(!t||!t.URL)t={};this.set("attribution",t),e.resolve(t)},this)),this.loadAttribution=e),e.promise()},getArtistDetails:function(){if(this.loadDetailsDfd)return this.loadDetailsDfd.promise();var e=$.Deferred();return this._gotExtraDetails?e.resolve(this):(n.Services.API.getArtistByID(this.id).done(_.bind(function(t){this._gotExtraDetails=!0;var n={CoverArtFilename:t.CoverArtFilename,IsVerified:this.attributes.IsVerified||t.IsVerified};this.set(n),e.resolve(this)},this)).fail(function(t){e.reject(t)}),this.loadDetailsDfd=e),e.promise()},toProxyLabel:function(){return this.escape("ArtistName")},getTitle:function(e){return e?this.get("ArtistName"):this.escape("ArtistName")},getCommentsAndLatestFanUpdate:function(){var e=$.Deferred(),t=this.get("ArtistID");return n.Services.API.getCommentsAndFanUpdateForArtist(t).done(_.bind(function(r){if(!r)return;var i={};i.hasMoreComments=r.comments&&r.comments.hasMore,i.comments=n.Models.Comment.handleCommentsFromCombinedFanUpdatesCall(r.comments||{comments:[],users:{}},t,n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST);if(r.fanUpdate){i.fanUpdate=new n.Models.FanUpdate(r.fanUpdate,{artist:this});var s=this.get("fanUpdates");s&&s.unshift(i.fanUpdate)}e.resolve(i)},this)),e.promise()},updateProfile:function(e){var t=!0,r=this.get("pageNameData"),i=new $.Deferred;if(!r)t=!1;else{r=$.extend({},r),r.Bio===e.bio||!r.Bio&&!e.bio?delete e.bio:t=!1,r.BioAttribution===e.bioAttribution||!r.BioAttribution&&!e.bioAttribution?delete e.bioAttribution:t=!1;if(!r.URLs&&e.urls)t=!1;else if(e.urls){for(var s in r.URLs)r.URLs.hasOwnProperty(s)&&r.URLs[s]===""&&delete r.URLs[s];for(var s in e.urls)e.urls.hasOwnProperty(s)&&(!r.URLs.hasOwnProperty(s)||e.urls[s]!==r.URLs[s])&&(t=!1)}r.URLsOrder===e.urlsOrder||!r.URLsOrder&&!e.urlsOrder?delete e.urlsOrder:t=!1,e.ArtistName&&this.get("ArtistName")!==e.ArtistName&&this.get("pendingArtistName")!==e.ArtistName?t=!1:e.ArtistName&&delete e.ArtistName,typeof r.Bio=="string"&&(r.bio=r.Bio,delete r.Bio),typeof r.URLs=="object"&&(r.urls=r.URLs,delete r.URLs),typeof r.BioAttribution=="string"&&(r.bioAttribution=r.BioAttribution,delete r.BioAttribution)}return t?i.resolve(this.get("pageNameData")):n.Services.API.artistUpdateProfileEx(this.get("ArtistID"),e,r).done(_.bind(f,this,i,e)).fail(_.bind(c,this,i)),i.promise()},updatePageName:function(e){var t=$.Deferred();return e===this.get("PathName")?t.resolve(!0):n.Models.AuthUser.checkEmailUsername(null,e).done(_.bind(function(r){r.username===-1?t.reject(-1):r.username===!1?t.reject(-2):n.Services.API.artistUpdatePageName(this.get("ArtistID"),e).done(_.bind(l,this,t,e)).fail(_.bind(c,this,t))},this)),t.promise()},disownSongs:function(e,t){var r=this.get("ArtistID"),i=[],s=[],o=new $.Deferred,u,a,f;for(var l=0;l<e.length;l++){u=n.Models.Song.getCached(e[l]);if(u){i.push(u),a=u.getAlbums(),f=0,_.each(a,function(e){e.ArtistID===r&&(f++,_.indexOf(s,e.AlbumID)===-1&&s.push(e.AlbumID))});if(!f)return o.reject(!1),o.promise()}}return t?n.Services.API.artistDeleteSongs(e,s,r).done(_.bind(d,this,o,r,i)).fail(_.bind(c,this,o)):n.Services.API.artistDisownSongs(e,s,r).done(_.bind(p,this,o,r,i)).fail(_.bind(c,this,o)),o.promise()},getDetailsForFeeds:function(){var e={artistID:this.get("ArtistID"),artistName:this.get("ArtistName"),artFilename:this.get("CoverArtFilename"),isVerified:this.get("IsVerified")};return e},getAnchorTag:function(e,t,n){return['<a href="',this.toUrl(t),'" class="artist-link '+(n?n:"")+'">',e?_.getString(e).toLocaleLowerCase():_.escape(this.get("ArtistName")),"</a>"].join("")},getFeed:function(e){if(this.feedDfd&&this.feedDfd.state()!=="rejected"&&!e)return this.feedDfd.promise();var t=$.Deferred();if(this.get("feed")&&!e)t.resolve(this.get("feed"),[]);else if(this.id<=0)i=new n.Models.Collections.FeedEvents([]),this.set({feed:i}),t.resolve(i,[]);else{var r=null;if(e&&this.get("feed")&&this.get("feed").length){var i=this.get("feed");i&&i.length&&(r=this.get("feed").last().get("timestamp"))}this.feedDfd=t,n.Services.API.getProfileFeedForItem(this.id,"artist",r).done(_.bind(v,this,t,e)).fail(_.bind(this.feedDfd.reject,this.feedDfd))}return t.promise()},isClaimed:function(){return(this.get("Flags")&n.Models.Artist.FLAG_ARTIST_CLAIMED)>0?!0:!1},updateFeaturedSongs:function(e){var t=e?e.pluck("SongID"):[],r=this.get("ArtistID"),i=$.Deferred();return n.isLoggedInUserOwnerOfArtist(r)?n.Services.API.artistModifyFeaturedSongIDs(r,t).done(_.bind(function(n){n?(t.length>0?this.set("featuredSongs",e):this.unset("featuredSongs"),i.resolve(n)):i.reject(!1)},this)).fail(_.bind(i.reject,i)):i.reject(),i.promise()},updateRelatedArtists:function(e){var t=[],r=this.get("ArtistID"),i=$.Deferred(),s,o,u,a;return n.isLoggedInUserOwnerOfArtist(r)?(e.each(function(e){s={},o=[],a=e.get("pageNameData"),u=e.get("Tags"),s.ArtistID=e.get("ArtistID"),s.ArtistName=e.get("ArtistName"),s.CoverArtFilename=e.get("CoverArtFilename"),s.Bio=a&&a.Bio||"",s.FollowerCount=e.get("followerCount"),u&&u.each(function(e){o.push({TagID:e.get("TagID"),Tag:e.get("Tag")})}),s.Tags=o,t.push(s)}),n.Services.API.modifyArtistRelatedArtists(r,t).done(_.bind(function(t){t?(this.set("customRelatedArtists",e),i.resolve(t)):i.reject(!1)},this)).fail(_.bind(i.reject,i))):i.reject(),i.promise()},play:function(e){var t=e||{};return t.context=t.context||new n.Models.PlayContext(this),this.getTopSongs().done(_.bind(function(e){var r=e.models.slice();t.collectionComparator&&r.sort(t.collectionComparator),n.trigger("player:addSongsEx",_.take(r,10),t)},this))},playStation:function(){var e=this.get("ArtistID"),t=function(t){n.trigger("player:radio",!0,{seeds:[e],seedArtistWeightRange:[110,130],secondaryArtistWeightModifier:.75}),_.gaTrackEvent("player","autoplayOn","artist"),n.trigger("guts:forcelog","autoplayOn",{autoplay:0,autoplayType:"artist"}),n.trigger("guts:begincontext",{autoplay:0,autoplayType:"artist"})};r.radioClearQueue(t)},getDailySongsStats:function(){var e=this.get("ArtistID"),t=this.get("dailySongStats"),r=30,s=$.Deferred(),o=s.promise(),u=_.bind(function(e){return this.get("songs").map(function(t){var n=t.id,r=e[n];return r?(r=r.Cumulative,r=_.mapValues(r,_.toInt),r.songID=n):r={songID:n,Streams:0,UniqueListeners:0,Favorites:0,LibraryAdds:0},r})},this);return t&&Date.now()-t.timestamp<i?(s.resolve(t.data),o):(n.Services.API.getArtistDailySongsStats(e,r).done(_.bind(function(e){var t=u(e);e?(this.set("dailySongStats",{data:t,timestamp:Date.now()}),s.resolve(t)):s.reject()},this)).fail(function(){s.reject()}),o)},getDailyStats:function(e,t){function c(e){if(!e){s.reject();return}_.each(u,function(s){var u=e[s]||{},f,l;if(s==o)u.Cumulative?a.Cumulative={time:i,data:u.Cumulative}:a&&a.Cumulative&&a.Cumulative.data&&(u.Cumulative=a.Cumulative.data),r.dailyStats=u,a.dailyStats={time:i,data:r.dailyStats},a.statsDaysLoaded=t;else{l=n.Models.Artist.getCached(s);if(!l)return;f=l.get("stats"),f||(f={},l.set("stats",f)),u.Cumulative?f.Cumulative={time:i,data:u.Cumulative}:f&&f.Cumulative&&f.Cumulative.data&&(u.Cumulative=f.Cumulative.data),f.dailyStats={time:i,data:u},f.statsDaysLoaded=t}}),s.resolve(r)}var r={},i=Math.floor(Date.now()/1e3),s=$.Deferred(),o=this.get("ArtistID"),u=e.pluck("ArtistID"),a=this.get("stats"),f=!1,l;a||(a={},this.set("stats",a)),r.days=t,l=a.Cumulative;if(!l||l.time<i-3600)f=!0;return n.Services.API.getArtistsDailyArtistStatsEx(u,t,f).done(c).fail(function(){s.reject()}),s.promise()},getWeeklyTopStats:function(){var e=this.get("ArtistID"),t=this.get("weeklyTopStats"),r=$.Deferred(),s=r.promise();return t&&Date.now()-t.timestamp<i?(r.resolve(t.data),s):(n.Services.API.getArtistWeeklyTopStats(e).done(_.bind(function(e){e?(this.set("weeklyTopStats",{data:e,timestamp:Date.now()}),r.resolve(e)):r.reject()},this)).fail(function(){r.reject()}),s)},getTrafficStats:function(){var e=this.get("trafficStats"),t=$.Deferred(),n=t.promise();return e?(t.resolve(e),n):(e={platforms:[{platform:"Web",plays:2301},{platform:"HTML5",plays:920},{platform:"Android",plays:560},{platform:"iOS",plays:540},{platform:"Other Mobile",plays:102},{platform:"Desktop",plays:23},{platform:"Virtual DJ",plays:10},{platform:"Tiny Song",plays:4},{platform:"API",plays:9}],social:[{name:"Facebook",shares:2301},{name:"Twitter",shares:920},{name:"Google+",shares:560},{name:"Reddit",shares:540},{name:"Custom Widgets",shares:102},{name:"URL",shares:23}]},this.set("trafficStats",e),t.resolve(e),n)},updateTags:function(e){var t=this.get("ArtistID"),r=$.Deferred();return n.Services.API.modifyCustomArtistTags(t,e).done(_.bind(function(t){var n;t?(n=this.get("Tags"),n.reset(e),r.resolve()):r.reject()},this)),r.promise()}},{getArtistStatusDfds:{},artPath:"/static/artists/",themeArtPath:"/static/artistthemes/",FLAG_ARTIST_CLAIMED:1,UNKNOWN:5062,tagIgnoredArtistIDs:{5062:!0,55:!0,401329:!0,1174303:!0,1038545:!0},get:function(e,t){var r=Backbone.CachedModel.genericGet.call(this,n.Services.API.getArtistByID,"ArtistID",e,t);return r.promise()},getArtistUrl:function(e,t,r){var i=n.Models.Artist.getCached(e);return i?i.toUrl(r):_.cleanUrl(t,e,"artist",null,r)},loadArtistsPageNameDatas:function(e){e&&e.models&&(e=e.models);var t=[],r={},i=$.Deferred(),s;return _.each(e,function(e){if(e.get("pageNameData"))return;s=e.get("ArtistID"),r[s]=e,t.push(s)}),t.length>0?n.Services.API.getPageInfoByIDsType(t,"artist").done(function(e){var t;_.each(e,function(e){s=e.ItemID,t=r[e.ItemID],t&&t.setPageNameData(e)}),i.resolve()}).fail(_.bind(i.reject,i)):i.resolve(),i.promise()},artistCoverArtSort:function(e,t){return e.CoverArtFilename?-1:t.CoverArtFilename?1:0},FLAG_CLAIMED:1})}(),function(){function i(e,r,i){if(!i)return s(e,r);var o=i.Data||{},u=i.Name&&i.Name.indexOf("/")===-1?i.Name:"",a={pageNameData:o,PathName:u};o&&o.Tags!==t&&(a.Tags=new n.Models.Collections.Tags(o.Tags)),this.set(a),r==="data"&&e?e.resolve(o):e&&e.resolve(u)}function s(e,t){this.set({PathName:"",pageNameData:{}}),e&&e.resolve(null)}function o(e,t){var r=a(t,this.attributes.ReleaseType,this.attributes.AlbumID);this.set({songs:new n.Models.Collections.Songs(r.songs),extraSongs:new n.Models.Collections.Songs(r.extraSongs),songsLoaded:!0,defaultTrackSort:r.defaultTrackSort}),e&&e.resolve(this.get("songs"))}function u(e,t){e.reject(t)}function a(e,t,r,i){var s,o,u,a,f,c,p,d,v,m=[],g=[],y={},b=[],w={},E={},S=0;t=t||!1,_.isArray(e)||(e=[e]);for(s=0,o=e.length;s<o;s++){a=e[s],f=i&&i.get(a.SongID)||n.Models.Song.newOrUpdate(a),c=f.attributes,m.push(f),d=_.toInt(c.TrackNumsByAlbumID[r]);if(!t||t&&c.IsVerified)S=Math.max(S,d);w[f.id]=d,b[d]?b[d].push(f):b[d]=[f],p=l(f),y.hasOwnProperty(p)?y[p].push(f):y[p]=[f]}s=1;for(s;s<=S;s++){v=b[s];if(!v||!v.length)continue;f=h(v,E,!1);if(!f)continue;p=l(f);if(E[p]&&(!t||!f.attributes.IsVerified)){var x=E[p];if(x.attributes.IsVerified||!f.attributes.IsVerified){f=h(v,E,!0);if(!f)continue;p=l(f)}else{u=_.indexOf(g,x),u!=-1&&g.splice(u,1);var T=h(b[w[x.id]],E,!0);T&&(T.IsVerified=1,E[l(T)]=T)}}g.push(f),E[p]=f}var N,C=!0;return g.length?N=_.difference(m,g):(g=m,N=[],C=!1),{songs:g,extraSongs:N,defaultTrackSort:C,isFullAlbum:g.length&&S===g.length}}function l(e){var t=e.get("SongName");t=t.toLowerCase();var n=t.replace(e.get("ArtistName").toLowerCase(),"").replace(f,"");return n.length?t=n:t=t.replace(f,""),t}function h(e,t,n){var r,i;if(!$.isArray(e)||e.length===0)return!1;if(e.length===1)return r=e[0],i=l(r),n&&t[i]?!1:r;e=e.sort(function(e,t){var n=e.attributes.IsVerified,r=t.attributes.IsVerified;if(n!==r)return r-n;var i=c.test(e.SongName),s=c.test(t.SongName);return i===s?0:i&&!s?1:-1});for(var s=0;s<e.length;s++){r=e[s],i=l(r);if(!t[i])return r}return n?!1:e[0]}function p(e,t,n){if(!n)return d(e,n);var r=!1;t.Name&&(t.AlbumName=t.Name,delete t.Name,r=t.AlbumName!==this.get("AlbumName")),this.set(t),r&&this.get("songs")&&_.invoke(this.get("songs").models,"set",{AlbumName:this.get("AlbumName")}),e.resolve(n)}function d(e,t){e.reject(t)}n.Models=n.Models||{};var f=/\s|\-|\:|\(|\)|\[|\]/g,c=/\(|\)|\[|\]|live|feat|\sft|remix|demo/i;n.Models.Album=Backbone.CachedModel.extend({idAttribute:"AlbumID",parse:function(e,r){if(r&&r.skipParse)return e;var i=r||{},s=_.orEqualEx(e.AlbumName,e.albumName,e.Name)||_.getString("UNKNOWN"),o=_.toInt(_.orEqual(e.AlbumID,e.albumID)),u=_.orEqualEx(e.CoverArtFilename,e.ArtFilename,e.artFilename,""),f,l,c,h,p,d,v,m,g;u&&u.indexOf("default")!==-1&&(u=""),typeof e.ReleaseType!="undefined"&&(f=_.toInt(e.ReleaseType),l=_.toInt(e.ReleaseStatus),typeof e.Year!="undefined"&&(c=_.toInt(e.Year),c||(c=t)),h=e.IsVerified||e.isVerified,h!=="undefined"&&(h=parseFloat(e.IsVerified),h=isNaN(e.IsVerified)?0:e.IsVerified)),typeof e.Flags!="undefined"&&(d=_.toInt(e.Flags));if(i.detailsOnly)return{IsVerified:h,ReleaseType:f,ReleaseStatus:l,Flags:d,Year:c};v=e.songs,m=e.extraSongs,g=e.defaultTrackSort;if(typeof e.songsFromArtist!="undefined"&&!v){var y=a(e.songsFromArtist,f,o);g=y.defaultTrackSort,v=y.songs,m=y.extraSongs,p=y.isFullAlbum}return typeof v!="undefined"&&!(v instanceof Backbone.Collection)&&(v=new n.Models.Collections.Songs(v)),typeof m!="undefined"&&!(m instanceof Backbone.Collection)&&(m=new n.Models.Collections.Songs(m)),{AlbumID:o,AlbumName:s,ArtistID:_.toInt(_.orEqual(e.ArtistID,e.artistID)),ArtistName:_.orEqualEx(e.ArtistName,e.artistName)||_.getString("UNKNOWN_ARTIST"),CoverArtFilename:u,PageArtFilename:_.orEqual(e.PageArtFilename,""),searchText:s.toLowerCase(),isFavorite:!!e.isFavorite||!!i.isFavorite,isFullAlbum:p,IsVerified:h,IsVerifiedSongs:e.IsVerifiedSongs,ReleaseType:f,ReleaseStatus:l,Flags:d,Year:c,songs:v,extraSongs:m,defaultTrackSort:g,Popularity:_.toInt(e.Popularity),source:e.source,GenreID:_.defined(e.GenreID)?_.toInt(e.GenreID):t,rawPageNameData:e.pageNameData||e.rawPageNameData}},initialize:function(e,t){return e.rawPageNameData&&(this.setPageNameData(e.rawPageNameData),this.unset("rawPageNameData",{silent:!0})),Backbone.CachedModel.prototype.initialize.call(this,e,t)},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e),r=e.pageNameData||e.rawPageNameData;e.ArtistName&&this.attributes.ArtistName===_.getString("UNKNOWN_ARTIST")&&(n.ArtistName=e.ArtistName),_.toInt(e.IsVerified)&&(n.IsVerified=1);if(e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;!this.attributes.CoverArtFilename&&e.CoverArtFilename&&(n.CoverArtFilename=e.CoverArtFilename),!this.attributes.PageArtFilename&&e.PageArtFilename&&(n.PageArtFilename=e.PageArtFilename),this.set(n,t),r&&this.setPageNameData(r)},setSongsFromArtist:function(e,t,r){if(this.get("songsLoaded"))return;var i=a(e,this.get("ReleaseType"),this.get("AlbumID"),r),s=this.get("songs"),o=this.get("extraSongs"),u={defaultTrackSort:i.defaultTrackSort,isFullAlbum:i.isFullAlbum};s?s.reset(i.songs):u.songs=new n.Models.Collections.Songs(i.songs,{srcArtist:t}),o?o.reset(i.extraSongs):u.extraSongs=new n.Models.Collections.Songs(i.extraSongs,{srcArtist:t}),this.set(u)},getSongs:function(){if(this.loadSongsDfd)return this.loadSongsDfd.promise();var e=$.Deferred(),t=this.get("ArtistID"),r=this.get("songs"),i=n.isLoggedInUserOwnerOfArtist(t);return this.get("songsLoaded")?e.resolve(r):n.Services.API.albumGetAllSongs(this.id,i).done(_.bind(o,this,e)).fail(_.bind(u,this,e)),this.loadSongsDfd=e,e.promise()},getExtraSongs:function(){var e=$.Deferred(),t=this.get("extraSongs");return t?e.resolve(t):this.getSongs().done(_.bind(function(){e.resolve(this.get("extraSongs"))},this)).fail(function(t){e.reject(t)}),e.promise()},toUrl:function(e){return this.get("PathName")?_.makeUrlFromPathName(this.get("PathName"),e):_.cleanUrl(this.get("AlbumName"),this.id,"album",null,e)},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("AlbumID"),"album").done(_.bind(i,this,e,"name")).fail(_.bind(s,this,e)),e.promise()},getPageNameData:function(){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected")return this.pageNameDataDfd.promise();var e=new $.Deferred;return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("AlbumID"),"album").done(_.bind(i,this,e,"data")).fail(_.bind(s,this,e)),this.pageNameDataDfd=e,e.promise()},setPageNameData:function(e){var t=e&&!e.Data?{Data:e}:e;i.call(this,null,"data",t)},getTags:function(){var e=new $.Deferred;return typeof this.get("Tags")!="undefined"?e.resolve(this.get("Tags")):this.getPageNameData().done(_.bind(function(){e.resolve(this.get("Tags"))},this)).fail(e.reject),e.promise()},toArtistUrl:function(e){return n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),e)},getImageURL:function(t){t!==""&&(t=_.orEqual(t,70)+"_");var r=_.getImageURL(n.Models.Album.artPath+t+"album.png");return this.get("CoverArtFilename")&&(r=_.getImageURL(n.Models.Album.artPath+t+this.get("CoverArtFilename"))),r+="?co="+e.location.host,r},getPageImageURL:function(t){var r=_.getCDNImage(n.Models.Album[_.isRetina()?"pageArtRetinaPath":"pageArtPath"]),i="?co="+e.location.host,s=new $.Deferred;return this.get("PageArtFilename")?s.resolve(_.getCDNImage(this.get("PageArtFilename"))+i):t?s.resolve(this.getImageURL(500)+i):s.resolve(r+i),s.promise()},getTitle:function(e){return e?['"',this.get("AlbumName"),'" by ',this.get("ArtistName")].join(""):['"',this.escape("AlbumName"),'" by ',this.escape("ArtistName")].join("")},toProxyLabel:function(){var e=this.get("ArtistName")?"SELECTION_ALBUM_SINGLE":"SELECTION_ALBUM_SINGLE_NO_ARTIST";return _.getString(e,{AlbumName:this.escape("AlbumName"),ArtistName:this.escape("ArtistName")})},getAlbumDetails:function(){if(this.loadDetailsDfd)return this.loadDetailsDfd.promise();var e=$.Deferred();return typeof this.get("ReleaseType")!="undefined"?e.resolve(this):(n.Services.API.getAlbumByID(this.id).done(_.bind(function(t){var n=this.parse(t,{detailsOnly:!0});this.set(n),e.resolve(this)},this)).fail(function(t){e.reject(t)}),this.loadDetailsDfd=e),e.promise()},updateLocalInfo:function(e){var t=this.parse(e,{detailsOnly:!0});this.set(t)},updateInfo:function(e){var t=new $.Deferred,r=!1,i={AlbumID:this.get("AlbumID"),ArtistID:this.get("ArtistID"),Name:this.get("AlbumName")+"",Year:_.toInt(this.get("Year")),IsVerified:_.toInt(this.get("IsVerified")),ReleaseType:this.getReleaseTypeForEdit(),ReleaseStatus:_.toInt(this.get("ReleaseStatus")),Flags:_.toInt(this.get("Flags"))};i.Year||(i.Year="");for(var s in e)if(e.hasOwnProperty(s)&&e[s]!==i[s]){r=!0;break}return r?(e=$.extend({},i,e,{ArtistID:this.get("ArtistID"),AlbumID:this.get("AlbumID")}),n.Services.API.artistEditAlbum(e,i).done(_.bind(p,this,t,e)).fail(_.bind(d,this,t))):t.resolve(!0),t.promise()},getDetailsForFeeds:function(){var e={artistID:this.get("ArtistID"),artistName:this.get("ArtistName"),artFilename:this.get("CoverArtFilename"),isVerified:this.get("IsVerified"),albumID:this.get("AlbumID"),albumName:this.get("AlbumName")};return e},getAnchorTag:function(e,t,n){return'<a href="'+this.toUrl(t)+'" class="album-link '+(n?n:"")+'">'+(e?_.getString(e).toLocaleLowerCase():this.escape("AlbumName"))+"</a>"},getArtistAnchorTag:function(e,t,n){return'<a href="'+this.toArtistUrl(t)+'" class="artist-link '+(n?n:"")+'">'+(e?_.getString(e).toLocaleLowerCase():this.escape("ArtistName"))+"</a>"},getReleaseTypeLocale:function(){var e=this.get("ReleaseType");switch(e){case 1:return"ALBUM_TYPE_FULL_ALBUM";case 2:return"ALBUM_TYPE_SINGLE";case 3:return"ALBUM_TYPE_EP";case 11:return"ALBUM_TYPE_OTHER";case 12:return"BROADCAST"}return""},getReleaseTypeForEdit:function(){var e=_.toInt(this.get("Flags")),t=this.get("ReleaseType"),r;return e>0&&t==0&&_.each(n.Models.Album.albumFlagsToType,function(n,i){r=_.toInt(i);if((e&r)==r)return t=n,!1}),t},getMoreMenu:function(e){var t=$.Deferred(),i=e||{};return this.getSongs().done(_.bind(function(e){var s=[],o=this.get("ArtistID"),u=r.model.get("appToken");s.push({type:"html",html:'<a class="menu-item"><span data-translate-text="SHARE_TO_ELLIPSIS" class="menu-title">'+_.getString("SHARE_TO_ELLIPSIS")+'</span><i class="icon icon-caretright"></i></a>',subMenu:{tooltipClass:"menu sub-menu context-switch",items:n.contextMenus.getShareSocialOptions(this,u)}},{type:"divider"},{type:"html",html:'<a class="menu-item playlists-menu-item"><span data-translate-text="CONTEXT_ADD_TO_PLAYLIST" class="menu-title">'+_.getString("CONTEXT_ADD_TO_PLAYLIST")+'</span><i class="icon icon-caretright"></i></a>',subMenu:n.contextMenus.getPlaylistsMenu(e.models,{callback:function(t){t.addSongs(e.models,null,!0)}},null,i)}),n.isLoggedInUserOwnerOfArtist(o)&&s.push({type:"divider"},{localeKey:"EDIT_ALBUM",url:this.toUrl("edit")}),t.resolve(s)},this)),t.promise()},play:function(e){var t=e||{};return t.context=t.context||new n.Models.PlayContext(this),this.getSongs().done(_.bind(function(e){var r=e.models.slice();t.collectionComparator&&r.sort(t.collectionComparator);if(t.includeExtraSongs){var i=this.get("extraSongs");i&&i.models&&(r=r.concat(i.models))}n.trigger("player:addSongsEx",r,t),n.trigger("logAlbumPlay",this)},this))}},{artPath:"/static/albums/",pageArtPath:"default/cover/album-song-playlist.png",pageArtRetinaPath:"default/cover/retina/album-song-playlist.png",UNKNOWN:92822,get:function(e,t){var r=Backbone.CachedModel.genericGet.call(this,n.Services.API.getAlbumByID,"AlbumID",e,t);return r.promise()},prettySort:function(e,t){return e.get("IsVerified")&&e.get("CoverArtFilename")||e.get("IsVerified")&&!t.get("CoverArtFilename")?-1:t.get("IsVerified")&&t.get("CoverArtFilename")?1:0},popularSort:function(e,t){var n=0,r=0,i,s,o;if(e.get("songs")){i=e.get("songs");for(s=0,o=i.length;s<o;s++)n+=i.at(s).get("Popularity")}if(t.get("songs")){i=t.get("songs");for(s=0,o=i.length;s<o;s++)r+=i.at(s).get("Popularity")}return r-n},experimentalNiftyComparator:function(e){var t=e.attributes.AlbumName||"",n;if(!t.length)n=-20;else{var r=t.toUpperCase().charCodeAt(0),i=t.match(/[\[\]\(\)\{\}]|n\/a|\.(com|net|org|ro|de|ru|co|ws|info|pl|az|fm|vn|hu)|www\.|http\:\/\//ig),s=t.match(/remix|unknown|top.?\d|unofficial|mtv|promo|grammy|no title|blog|album|bootleg|best of|presents|hits|mix|billboard|none|[\=\+]| \d{4}|((cd|vol|disc).{0,2}\d+)/ig);n=(i?i.length*-10:0)+(s?s.length*-3:0)+(t.length<3?-6:0)+(r<65||r>90?-1:0)+r/-1e3}return n*-1},verifiedishFilter:function(e){var t=e.get("songs");return e.attributes.IsVerified==1||e.attributes.IsVerifiedSongs==1||(t instanceof n.Models.Collections.Songs?t.length>=3:!0)},hasSongsFilter:function(e){var t=e.get("songs");return t&&t.length>=1},albumTypes:{0:"ALBUM_TYPE_NONE",1:"ALBUM_TYPE_LP",2:"ALBUM_TYPE_SINGLE",3:"ALBUM_TYPE_EP",4:"ALBUM_TYPE_COMPILATION",5:"ALBUM_TYPE_SOUNDTRACK",6:"ALBUM_TYPE_SPOKENWORD",7:"ALBUM_TYPE_INTERVIEW",8:"ALBUM_TYPE_AUDIOBOOK",9:"ALBUM_TYPE_LIVE",10:"ALBUM_TYPE_REMIX",11:"ALBUM_TYPE_OTHER"},albumFlagsToType:{1:4,2:5,4:6,8:7,16:8,32:9,64:10},albumStatusTypes:{OFFICIAL:1,PROMOTION:2,BOOTLEG:3,PSEUDO_RELEASE:4}})}(),function(){function i(e,n,r){if(!r)return s(e,n);var i=r.Data||{},o={pageNameData:i,pageNameDataLoaded:!0};typeof r.Name!="undefined"&&(o.PathName=r.Name&&r.Name.indexOf("/")===-1?r.Name:""),i.BroadcastListens!==t&&(o.BroadcastListens=_.toInt(i.BroadcastListens),o.estimatedBroadcastListens=o.BroadcastListens),this.set(o),n==="data"&&e?e.resolve(i):e&&e.resolve(o.PathName)}function s(e,t){this.set({PathName:"",pageNameData:{}}),e&&e.resolve(null)}function o(e,t,r){var i=n.Models.Collections[e],s="favorite"+e;if(!i){console.log("favorites returned but invalid collection class??",e),t.reject(r);return}var o={notifyCache:!0};n.getLoggedInUserID()==this.get("UserID")&&(o.isFavorite=!0,e==="Songs"&&(o.fromLibrary=!0));var u=new i(r,o);this.set(s,u),e==="Songs"&&y.call(this),t.resolve(u)}function u(e,t,n){t.reject(n)}function a(e,t,r,i){var s=this.get("library"),o={silent:!0,notifyCache:!0};n.getLoggedInUserID()==this.get("UserID")&&(o.fromLibrary=!0),s instanceof n.Models.Collections.Songs?e===0?s.reset(i.Songs,o):s.add(i.Songs,o):(s=new n.Models.Collections.Songs(i.Songs,o),this.set("library",s)),i.hasOwnProperty("TSModified")&&this.set("libraryTSModified",i.TSModified);if(i.hasMore===!0){e++;var u=n.Services.API.userGetSongsInLibrary(this.id,e,!r);u.done(_.bind(a,this,e,t,!r)),u.fail(_.bind(f,this,e,t)),u.fail(_.bind(y,this))}else{this.getFavoritesByType("Songs").always(_.bind(function(){y.call(this),t.resolve(s)},this));if(this.get("librarySongsSongIDs")){var l={};s.each(function(e){l[e.id]=1}),this.set({librarySongsSongIDs:l,librarySongsCount:s.length})}}}function f(e,t,n){t.reject(n)}function l(e,t,r){var i={UserID:this.get("UserID"),Username:this.get("Name"),FName:this.get("FName"),LName:this.get("LName")};if(r&&r.Playlists&&_.isArray(r.Playlists))for(var s=0;s<r.Playlists.length;s++)r.Playlists[s]=$.extend(r.Playlists[s],i);var o=new n.Models.Collections.Playlists(r.Playlists),u=!1;t&&r.Playlists.length===t&&(u=!0),this.set({playlists:o,hasMorePlaylists:u}),e.resolve(o)}function c(e,t){e.reject(t)}function h(e,t,r){var i=100,s=new n.Models.Collections.Broadcasts([]),o=!1;r&&r.length&&(s.add(r.slice(1),{activeStatus:0,source:"db"}),s.unshift(r[0],{source:"db"})),t&&r.length===i&&(o=!0),this.set({broadcasts:s,hasMoreBroadcasts:o}),e.resolve(s)}function p(e,t){e.reject(t)}function d(e,t,r,i){if(!i){v(e,t,i);return}if(r){t.resolve(i);return}var s=this.get("followers"),o={};n.getLoggedInUserID()==this.id&&(o.isFollower=!0),e!==0&&s instanceof n.Models.Collections.Users?s.add(i,o):(s=new n.Models.Collections.Users(i,o),this.set("followers",s)),t.resolve(s)}function v(e,t,n){t.reject(n)}function m(e,t){if(t){var r=new n.Models.Collections.Artists(t,{modelOptions:{dontCache:!0}});this.set("topArtists",r),e.resolve(r)}else e.reject(t)}function g(e,t){e.reject(t)}function y(){var e=this.get("favoriteSongs"),t=this.get("library");return e instanceof n.Models.Collections.Songs&&t instanceof n.Models.Collections.Songs?(t.add(e.models),!0):!1}function b(e,t,r){if(!r||!r.events){e.reject();return}t&&this.attributes.feed?this.attributes.feed.add(r.events):this.set("feed",new n.Models.Collections.FeedEvents(r.events,{feedType:"model",ownerModel:this,initialPageableItemLimit:25,pageableItemsPerLoad:25,modelOptions:{dontCache:!0}})),e.resolve(this.attributes.feed,r.events)}n.Models=n.Models||{},n.Models.User=Backbone.CachedModel.extend({favoriteSongsDfd:null,favoriteArtistsDfd:null,libraryDfd:null,playlistsDfd:null,followersDfd:null,topArtistsDfd:null,feedDfd:null,recentListensDfd:null,idAttribute:"UserID",parse:function(e,t){if(t&&t.skipParse)return e;var r=t||{},i=[],s=_.toInt(_.orEqual(e.UserID,e.userID)),o=_.orEqualEx(e.FName,e.fName,e.Name,e.userName,e.UserName,e.displayName,""),u=_.orEqual(e.LName,e.lName),a=!1,f=null,l;if(s<1&&!r.isAuth)return!1;l=o+(u&&u.length?" "+u:"");if(l===""||l&&$.trim(l)==="")a=!0,l=o="New User";return e.City&&i.push(e.City),e.State&&i.push(e.State),e.Country&&i.push(e.Country),i.length?i=i.join(", "):i="",e.topArtists&&(e.topArtists instanceof n.Models.Collections.Artists?f=e.topArtists:f=new n.Models.Collections.Artists(e.topArtists,{modelOptions:{dontCache:!0}})),{UserID:s||-1,FName:o||e.displayName,LName:u,Name:l,hasDefaultName:a,searchText:l.toLowerCase(),Location:i,City:e.City,State:e.State,Country:e.Country,Email:_.orEqual(e.Email,e.email),Sex:_.orEqual(e.Sex,e.sex),IsPremium:_.toInt(_.orEqual(e.IsPremium,e.isPremium)),TSDOB:_.orEqual(e.TSDOB,e.tsDOB),Flags:_.toInt(_.orEqual(e.Flags,e.flags)),Picture:e.Picture||e.userPicture,PageArtFilename:_.orEqual(e.PageArtFilename,""),About:e.About,TSAdded:e.TSAdded,FollowingFlags:e.FollowingFlags,RecentListens:e.RecentListens,SimilarFriendsCount:e.SimilarFriendsCount,followedByUserIDs:e.followedByUserIDs,PathName:e.PathName,pageNameData:e.pageNameData,isFavorite:!!_.toInt(e.IsFavorite)||!!r.isFavorite,TSFavorited:_.dateTimeToTimestamp(e.TSFavorited||e.DateFavorited),isFollower:!!_.toInt(e.IsFollower)||!!r.isFollower,isAuth:!!_.orEqual(e.isAuth,!1),isBroadcaster:e.isBroadcaster,nowPlayingSong:_.orEqual(e.nowPlayingSong,null),estimatedBroadcastListens:_.toInt(e.estimatedBroadcastListens),canBroadcastInvite:_.orEqual(e.canBroadcastInvite,!0),broadcastInviteTime:_.toInt(e.broadcastInviteTime),canBroadcastInviteEmail:_.orEqual(e.canBroadcastInviteEmail,!0),broadcastInviteTimeEmail:_.toInt(e.broadcastInviteTimeEmail),friendsLinked:e.friendsLinked,contextArtistID:e.contextArtistID,isArtist:!!_.toInt(e.isArtist),artistID:e.artistID,profileID:e.profileID,permissions:e.permissions,ipLocationData:e.ipLocationData,TSInteracted:e.TSInteracted||0,topArtists:f}},initialize:function(e,t){e.rawPageNameData&&(this.setPageNameData(e.rawPageNameData),this.unset("rawPageNameData",{silent:!0}));if(!_.isInstance(this,n.Models.AuthUser)){var i=r.model.attributes.user&&r.model.attributes.user.attributes.recentUsers;i&&i[this.id]&&this.set({TSInteracted:i[this.id].TSInteraction},{silent:!0})}return Backbone.CachedModel.prototype.initialize.call(this,e,t)},setBroadcastListens:function(e){var t=this.get("pageNameData");if(!t)return;t.BroadcastListens=_.toInt(e),this.trigger("change:pageNameData",this,t),this.set("estimatedBroadcastListens",e)},incrementEstimatedListens:function(e){e=_.toInt(e);var t=_.toInt(this.get("estimatedBroadcastListens"));this.set("estimatedBroadcastListens",t+e)},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e),r=!t||t.updateProfile!==!1,i=e.pageNameData||e.rawPageNameData;e.hasOwnProperty("friendsLinked")&&(this.friendsLinked=e.friendsLinked),!e.hasDefaultName&&(r||this.attributes.hasDefaultName)&&(e.Name?n.FName=n.Name=e.Name:e.FName&&(n.FName=n.Name=e.FName)),e.Picture&&(r||!e.Picture)&&(n.Picture=e.Picture),typeof e.FollowingFlags!="undefined"&&e.FollowingFlags!==null&&(n.FollowingFlags=e.FollowingFlags);if(_.toInt(e.IsFavorite)||e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;if(_.toInt(e.IsFollower)||e.isFollower||t&&t.isFollower)n.isFollower=!0;e.topArtists&&(!this.attributes.topArtists||e.topArtists.length>0)&&(n.topArtists=e.topArtists),e.About&&!this.attributes.About&&(n.About=e.About),_.toInt(e.IsPremium)&&(n.IsPremium=1),delete e.pageNameData,delete e.rawPageNameData,this.set(n,t),i&&this.setPageNameData(i)},toUrl:function(e){var t=this.get("PathName")||"",r=this.get("artistID"),i=r&&n.Models.Artist.getCached(r);return i&&i.get("PathName")&&(t=i.get("PathName")),t&&t.indexOf("/")===-1?_.makeUrlFromPathName(t,e):_.cleanUrl(this.id?this.get("Name"):"New User",this.id,"profile",null,e)},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("UserID"),"user").done(_.bind(i,this,e,"name")).fail(_.bind(s,this,e)),e.promise()},getPageNameData:function(){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!=="rejected")return this.pageNameDataDfd.promise();var e=new $.Deferred;return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("UserID"),"user").done(_.bind(i,this,e,"data")).fail(_.bind(s,this,e)),this.pageNameDataDfd=e,e.promise()},setPageNameData:function(e){var t=e&&!e.Data?{Data:e}:e;i.call(this,null,"data",t)},getImageURL:function(t,r){t!==""&&(t=_.orEqual(t,70)+"_");var i=this.get("isArtist")?_.getImageURL(n.Models.Artist.artPath+t+"artist.png"):_.getImageURL(n.Models.User.artPath+t+"user.png");return this.get("Picture")&&(!r||!r.defaultPicture)&&(i=_.getImageURL(n.Models.User.artPath+t+this.get("Picture"))),i+="?co="+e.location.host,i},getPageImageURL:function(t){var r=this.get("isArtist"),i="",s="?co="+e.location.host,o=this.get("pageNameData"),u=new $.Deferred,a,f,l;return t=t||1280,a=_.bind(function(e){if(e.CoverPhoto){u.resolve(_.getImageURL(n.Models.User.coverArtPath+t+"_"+e.CoverPhoto+s));return}if(!e.StockCoverPhoto){u.resolve(i+s);return}f=n.Models.Cover.covers[e.StockCoverPhoto],f?(l=new n.Models.Cover(f),u.resolve(l.getCoverPath())):u.reject()},this),r?i=_.getCDNImage(n.Models.User[_.isRetina()?"artistCoverArtPathDefaultRetina":"artistCoverArtPathDefault"]):i=_.getCDNImage(n.Models.User[_.isRetina()?"coverArtPathDefaultRetina":"coverArtPathDefault"]),o?a(o):this.getPageNameData().done(a),u.promise()},setCoverPhoto:function(e,t,n){var r=this.get("pageNameData"),i;e?(i=(new Date).getTime(),r.CoverPhoto=e+"?"+i,delete r.StockCoverPhoto,this.trigger("change:pageNameData",this,r)):(r.StockCoverPhoto=t,r.CoverPhotoY=n,delete r.CoverPhoto,this.trigger("change:pageNameData",this,r))},getThemeImageURL:function(){var e=this.get("pageNameData"),t=new $.Deferred;return e?e&&e.ThemeOptions&&e.ThemeOptions.Image?t.resolve(_.getImageURL(n.Models.User.themeArtPath+e.ThemeOptions.Image)):t.reject():this.getPageNameData().done(function(r){e=r,e&&e.ThemeOptions&&e.ThemeOptions.Image?t.resolve(_.getImageURL(n.Models.User.themeArtPath+e.ThemeOptions.Image)):t.reject()}).fail(function(){t.reject()}),t.promise()},getTitle:function(e){return e?this.get("Name"):this.escape("Name")},getShortName:function(){var e="",t=this.get("Name");if(t.length>12){var n=t.split(" ");for(var r=0;r<n.length;r++){if(!(e.length===0||n[r].length<10&&e.length<12))return e;e.length&&(e+=" "),e+=n[r]}return e>12?e.substr(0,12)+"&hellip;":e}return t},getFavoritesByType:function(e,t,r){var i="favorite"+e;if(this[i+"Dfd"])return this[i+"Dfd"].promise();var s=r||$.Deferred(),a=this.get(i);if(a)s.resolve(a);else{var f=function(){this.id<=0?(a=new n.Models.Collections[e]([]),this.set(i,a),s.resolve(a)):n.Services.API.getFavorites(this.id,e).done(_.bind(o,this,e,s)).fail(_.bind(u,this,e,s,null))};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(f,this)):f.call(this)}return this[i+"Dfd"]=s,s.promise()},getLibrary:function(e){e=_.orEqual(e,!1);if(this.libraryDfd&&this.libraryDfd.state()!=="rejected")return this.libraryDfd.promise();var t=$.Deferred(),r=this.get("library");return r?t.resolve(r):this.id<=0?(r=new n.Models.Collections.Songs([]),this.set({library:r,libraryTSModified:0}),t.resolve(r)):(n.Services.API.userGetSongsInLibrary(this.id,0,!e).done(_.bind(a,this,0,t,e)).fail(_.bind(f,this,0,t)),this.getFavoritesByType("Songs"),this.libraryDfd=t),t.promise()},getLibraryCount:function(){var e=this.get("library");if(e)return e.length;var n=this.get("librarySongsCount");if(n!==t)return n;var r=this.get("pageNameData");if(r)return _.toInt(r.LibrarySongCount)},getFavoriteSongsSongIDs:function(){if(this.favoriteSongIDsDfd&&this.favoriteSongIDsDfd.state()!=="rejected")return this.favoriteSongIDsDfd.promise();var e=this.favoriteSongIDsDfd=$.Deferred(),r=this.get("favoriteSongsSongIDs"),i=this;if(r)e.resolve(r);else{r={};function s(s){var o=i.get("librarySongsSongIDs"),u=i.get("librarySongsCount");for(var a=0,f=s.length,l,c;a<f;a++)l=s[a],l&&(r[l]=1,c=n.Models.Song.getCached(l),c&&c.set("isFavorite",!0),o!==t&&o[l]!==1&&(o[l]=1,u++));i.set({favoriteSongsSongIDs:r,favoriteSongsCount:s.length,librarySongsCount:u}),e.resolve(r)}var o=this.get("favoriteSongs");if(o)s(o.pluck("SongID"));else{var u=new ChainLoading;u.push(this.getLibrarySongIDs()),u.push(n.Services.API.userGetFavoriteSongsSongIDs(this.get("UserID")).done(u.bind(function(t){if(!t){e.reject();return}s(t)},this)).fail(u.bind(e.reject,e)))}}return e.promise()},getShares:function(){var e,t,r;return this.sharesDfd&&this.sharesDfd.state()==="pending"?this.sharesDfd.promise():(this.sharesDfd||(this.sharesDfd=$.Deferred()),r=this.sharesDfd.promise(),e=new n.Models.Collections.UserShares(null,{user:this,feedType:"user"}),t=e.loadMore().done(_.bind(this.sharesDfd.resolve,this.sharesDfd,e)).fail(_.bind(this.sharesDfd.reject,this.sharesDfd)),t&&typeof t.abort=="function"&&(r.abort=_.bind(t.abort,t)),r)},getFavoriteSongsCount:function(){var e=this.get("favoriteSongs");if(e)return e.length;var n=this.get("favoriteSongsCount");if(n!==t)return n;var r=this.get("pageNameData");if(r)return _.toInt(r.FavoriteSongCount)},getPlaylists:function(e){if(this.playlistsDfd&&this.playlistsDfd.state()!=="rejected"&&this.playlistsDfd._limitSpecified>=e)return this.playlistsDfd.promise();var t=$.Deferred(),r=this.get("playlists");return r&&(!this.get("hasMorePlaylists")||e>0&&e<r.length)?t.resolve(r):this.id<=0?(r=new n.Models.Collections.Playlists([]),this.set({playlists:r}),t.resolve(r)):(n.Services.API.userGetPlaylists(this.id,e).done(_.bind(l,this,t,e)).fail(_.bind(c,this,t)),this.playlistsDfd=t,this.playlistsDfd._limitSpecified=e),t.promise()},getLinks:function(){var e=this.get("pageNameData"),t=this.get("artistID"),r=t&&n.Models.Artist.getCached(t),i,s,o,u,a=[];r&&(e=r.get("pageNameData")),i=e&&e.URLs,i?i=_.clone(i):i={},s=e&&e.URLsOrder||[];for(o=0,u=s.length;o<u;o++)s[o]&&i[s[o]]!=null&&(a.push({type:s[o],url:i[s[o]]}),delete i[s[o]]);for(o in i)i.hasOwnProperty(o)&&typeof i[o]=="string"&&a.push({type:o,url:i[o]});return a},getBroadcasts:function(e,t){t=Math.min(1,_.toInt(t));var r=100,i=(t-1)*r;if(this.broadcastsDfd&&this.broadcastsDfd.state()!=="rejected"&&this.broadcastsDfd._limitSpecified>=i)return this.broadcastsDfd.promise();var s=$.Deferred(),o=this.get("broadcasts");return!e&&o&&(!this.get("hasMoreBroadcasts")||i<o.length)?s.resolve(o):this.id<=0?(o=new n.Models.Collections.Broadcasts([]),this.set({broadcasts:o}),s.resolve(o)):(n.Services.API.getUserBroadcasts(this.id,t).done(_.bind(h,this,s,t)).fail(_.bind(p,this,s)),this.broadcastsDfd=s,this.broadcastsDfd._limitSpecified=i),s.promise()},getFollowers:function(e,t){if(this.followersDfd&&this.followersDfd.state()!=="rejected")return this.followersDfd.promise();var r=t||$.Deferred(),i=this.get("followers");if(i)r.resolve(i);else{var s=function(){this.id<=0?(i=new n.Models.Collections.Users([]),this.set({followers:i}),r.resolve(i)):n.Services.API.userGetFollowersEx(this.id).done(_.bind(d,this,0,r,e)).fail(_.bind(v,this,0,r))};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(s,this)):s.call(this)}return e||(this.followersDfd=r),r.promise()},getIntersectingFollowers:function(){var e=$.Deferred();return this.getFollowers(!0).done(_.bind(function(t){var i=r.model.get("user").get("favoriteUsers"),s=r.model.get("user").get("favoriteUsers").pluck("UserID"),o=_.pluck(t,"UserID"),u,a;for(u=0,a=o.length;u<a;u++)o[u]=_.toInt(o[u]);var f=_.intersection(s,o),l=[];for(u=0;u<f.length;u++)l.push(i.get(f[u]));e.resolve(new n.Models.Collections.Users(l))},this)),e.promise()},getDetailsForFeeds:function(){return{userID:this.get("UserID"),userName:this.get("FName"),isPremium:this.get("IsPremium"),location:this.get("Location"),userPicture:this.get("Picture")}},getAnchorTag:function(e,t,n,r){var i=e?_.getString(e):this.escape("Name");return'<a href="'+this.toUrl(t)+'" class="user-link '+(r?r:"")+(n?"":"show-user-tooltip")+'" data-user-id="'+this.get("UserID")+'">'+i+"</a>"},getTopArtists:function(){if(this.topArtistsDfd&&this.topArtistsDfd.state()!=="rejected")return this.topArtistsDfd.promise();var e=$.Deferred(),t=this.get("topArtists");return t?e.resolve(t):this.id<=0?(t=new n.Models.Collections.Artists([]),this.set({topArtists:t}),e.resolve(t)):(n.Services.API.getTopArtistsForUser(this.get("UserID")).done(_.bind(m,this,e)).fail(_.bind(g,this,e)),this.topArtistsDfd=e),e.promise()},getFeed:function(e){if(this.feedDfd&&this.feedDfd.state()!=="rejected"&&!e)return this.feedDfd.promise();var t=$.Deferred();if(this.get("feed")&&!e)t.resolve(this.get("feed"),[]);else if(this.id<=0)i=new n.Models.Collections.FeedEvents([]),this.set({feed:i}),t.resolve(i,[]);else{var r=null;if(e){var i=this.get("feed");i&&i.length&&(r=i.last().get("timestamp"))}this.feedDfd=t,n.Services.API.getProfileFeedForItem(this.id,"user",r).done(_.bind(b,this,t,e)).fail(_.bind(this.feedDfd.reject,this.feedDfd))}return t.promise()},getRecentListens:function(){if(this.recentListensDfd&&this.recentListensDfd.state()!=="rejected")return this.recentListensDfd.promise();var e=$.Deferred(),t=[];return this.id<=0?(t=new n.Models.Collections.Songs([]),this.set({recentListens:t}),e.resolve(t)):(this.getListens().done(_.bind(function(r){r=r||[];var i=10,s=200,o=[],u=[],a={},f={},l=r.length,c,h,p,d;while(l--)d=r[l].SongID,h=r[l].listenTime,a[d]?p=a[d]:(p=n.Models.Song.newOrUpdate(_.clone(r[l])),a[d]=p),u.push(p),f[d]&&h-f[d].o.t[0]<86400?(c=f[d].o,c.t.length>=i&&c.t.splice(i-1,c.t.length-(i-1)),c.t.unshift(h),o[f[d].i]=null,f[d].i=o.length,o.push(c)):(c={s:p.archiveAttr(),t:[h]},f[d]={i:o.length,o:c},o.push(c));l=o.length;while(l--&&s){if(!o[l])continue;t.push(o[l]),s--}this instanceof n.Models.AuthUser&&this.get("settings")?this.saveLocalRecentListens(t):this.set({localRecentListens:t});var v=[];l=u.length;while(l--)v.push(u[l]);e.resolve(new n.Models.Collections.Songs(v))},this)).fail(_.bind(e.reject,e)),this.recentListensDfd=e),e.promise()},getListens:function(){if(this.listensDfd&&this.listensDfd.state()!=="rejected")return this.listensDfd.promise();this.listensDfd=new $.Deferred;if(this.get("listens"))this.listensDfd.resolve(this.get("listens"));else{var e=this.listensDfd;n.Services.API.getUserRecentListens(this.get("UserID")).done(_.bind(function(t){var n=[];for(var r=0,i=t.length,s;r<i;r++)s=t[r],n[r]={AlbumName:s.al,AlbumID:s.alid,ArtistName:s.ar,ArtistID:s.arid,listenDataKey:s.dk,SongName:s.s,SongID:s.sid,TagIDs:s.tids,listenTime:s.ts,client:s.c,CoverArtFilename:s.i};this.set("listens",n),e.resolve(n)},this)).fail(function(){e.reject()})}return this.listensDfd.promise()},getLocalRecentListens:function(){var e=this.getRawLocalRecentListens()||[],t=new n.Models.Collections.Songs,r=[];for(var i=0,s=e.length;i<s;i++)r.push(e[i].attrs);return t.add(r),t},getRawLocalRecentListens:function(e){var t=this.get("settings"),r=[],i=_.isArray(e)?e:t&&t.local&&t.local.recentListens;return _.isArray(i)&&i.length&&_.each(i,function(e){var t=n.Models.Song.unarchiveSongAttributes(e.s);r.push({attrs:t,SongID:t.SongID,ArtistID:t.ArtistID,timestamps:e.t})}),r},getLocalPersonalizedTagIDs:function(e){function v(e,t){var r,s;for(r=0,s=e.length;r<s;r++){h=_.toInt(e[r]instanceof n.Models.Tag?e[r].id:e[r]);if(!h||_.indexOf(o,h)!==-1)continue;i[h]?i[h][1].push(t):i[h]=[h,[t]]}}var t=e||{},r=this.getRawLocalRecentListens()||[],i={},s={},o=t.blacklist||[],u={},a=n.Models.Tag.lowIDFs,f,l,c,h,p,d;t.useRandomness=_.orEqual(t.useRandomness,!0);for(p=0,d=r.length;p<d;p++){if(s[r[p].SongID])continue;c=n.Models.Song.newOrUpdate(r[p].attrs),l=r[p].timestamps;if(!c)continue;s[c.id]=!0,f=c.get("Tags"),f&&f.length?f=f.models:f=c.get("TagIDs"),f&&f.length&&v(f,c)}for(p=0,d=n.Models.Tag.topGenres.length;p<d;p++)u[n.Models.Tag.topGenres[p].tagID]=1;var m=_.sortBy(_.toArray(i),function(e){var n=1,r=t.useRandomness?Math.random():1;if(u[e[0]])n=.3;else{var i=_.indexOf(a,e[0]);i!==-1&&(n=Math.min(.6,Math.max(.3,i/a.length)))}return e[1].length>1?(Math.pow(r*e[1].length,1.2)+10)*-1*n:-1*n});return _.pluck(m,"0")},getLocalPersonalizedTags:function(e){var t=this.getLocalPersonalizedTagIDs(e),r=new n.Models.Collections.Tags;return _.each(t,function(e){var t=n.Models.Tag.getCached(e);if(t){r.add(t);if(r.length===20)return!1}}),r},getPersonalizedTags:function(e){var t=$.Deferred(),r=e||{},i=this.get("UserID"),s,o;return i<=0?(o=this.getLocalPersonalizedTags(),this.set("personalizedTags",o),t.resolve(o)):(s=n.Services.API.getPersonalizedTagsForUser(i,r.skipCache),s.done(_.bind(function(e){o=new n.Models.Collections.Tags,_.each(e,function(e){o.add(new n.Models.Tag(e))}),this.set("personalizedTags",o),t.resolve(o)},this))),t},getPersonalizedSongs:function(e,t){var r=!!e,i=!!t,s=new ChainLoading,o=[],u=$.Deferred(),a=Date.now()/1e3;this instanceof n.Models.AuthUser||(i=!0),!this.get("librarySongsSongIDs")&&this.get("library")||i?s.push(this.getLibrary()):s.push(this.getLibrarySongIDs()),!this.get("favoriteSongsSongIDs")&&this.get("favoriteSongs")||i?s.push(this.getFavoritesByType("Songs")):s.push(this.getFavoriteSongsSongIDs()),this.id<=0&&(r=!0);if(r){o=this.getRawLocalRecentListens();if(o.length){var f=o[0].timestamps[0];this.id&&a-f>14400&&(o=[])}}else s.push(this.getTopArtists());o.length||s.push(this.getRecentListens().done(s.bind(function(){var e=this.get("localRecentListens");e&&(o=this.getRawLocalRecentListens(e))},this)));var l=function(e){var t=100,n=20,r=.25,i=n*(1+r),s=Math.E,o=Math.pow;return parseInt(1+(t-1)/o(1+n*o(s,-r*e+t*n/e),1/i),10)},c=_.bind(function(){var e=this.get("library"),t=this.get("librarySongsSongIDs"),r=this.get("topArtists")||new n.Models.Collections.Artists,i={},s={},a=0,f=0,c=[],h={},p=[],d=14400,v=86400,m=v*3,g=v*7*2,y=3,b={},w,E,S,x,T,N,C,k,L;o&&o.length&&(a=o[0].timestamps[0],f=a);for(w=0,E=o.length;w<E;w++)C=o[w],k=a-C.timestamps[0],f-C.timestamps[0]>d&&(h={},f=C.timestamps[0]),x=C.SongID,T=C.ArtistID,b[x]?S=b[x]:(S=n.Models.Song.newOrUpdate(C.attrs),b[S.id]=S),p.push(S),N=C.timestamps&&C.timestamps.length,(!h[T]||h[T]<y)&&k<g&&(s[T]||(s[T]=[]),s[T].push(S),h[T]?h[T]++:h[T]=1),L=l(Math.max(((k<m?30:0)+(70-k/v))*N)),i[x]?i[x]+=L:i[x]=L;var A=new n.Models.Collections.Songs(p.concat(e?e.models:[])),O=1,M=[],D=Math.random()*15+15,P=27,H=Math.random()*27+P,B=r.length,j;for(w=0,E=A.length;w<E;w++)S=A.models[w],T=S.attributes.ArtistID,x=S.attributes.SongID,L=Math.random()*20,O=1,i[x]&&(L+=i[x]/100*H,i[x]>22&&(O-=.3)),s[T]&&s[T].length>1&&(L+=Math.min(40,s[T].length/2*D*O),O-=.3),B&&(j=r.indexOf(T))!=-1&&(L+=Math.max(0,(B-j)/B*20)*O,O-=.1),(e&&e.indexOf(S)!==-1||t&&t[x])&&L<50&&(L+=10*O),L=l(L),M.push([S,L]);M=_.sortBy(M,function(e){return e[1]=Math.floor(Math.random()*e[1]+Math.random()*10),e[1]*-1}),_.each(M,function(e){c.push(e[0])}),c=new n.Models.Collections.Songs(c);var F=[];_.each(s,function(e,t){F.push([t,e.length])}),F=_.sortBy(F,1).reverse(),this.set({dominateRecentArtists:s,dominateRecentArtistsSorted:F}),u.resolve(c),this instanceof n.Models.AuthUser&&n.trigger("authUser:personalizedSongsLoaded")},this);return s.done(c).fail(function(){u.reject()}),u},getBroadcastOptionMenu:function(e,t,r,i){var s=this,o=this.get("UserID"),u=e.get("bannedUsers"),a=u&&u.get(o),f=e.isUserVIP(o),l=[];return f&&(l.push.apply(l,this.getVIPPermissionsMenu(e)),l.push({type:"divider"})),a?l.push({localeKey:"LISTENER_MENU_UNBLOCK",click:_.bind(e.unBanListener,e,s)}):r!=="owner"&&r!=="admin"&&!f&&l.push({localeKey:"LISTENER_MENU_BLOCK",click:_.bind(e.banListener,e,s,i)}),e.isLoggedInUserOwner()&&(f?l.push({localeKey:"LISTENER_MENU_DEMOTE",click:_.bind(e.removeVIPUser,e,s.get("UserID"))}):r!=="owner"&&l.push({localeKey:"LISTENER_MENU_PROMOTE",click:function(){amdModules.requireDeferred("gs/views/lightboxes/specialGuestSettings.js").done(function(){n.trigger("lightbox:open","specialGuestSettings",{broadcast:e,specialGuest:s})})}})),l},getVIPPermissionsMenu:function(e){var t=this.get("UserID"),r=e.getPermissionsForUserID(t),i=n.Models.Broadcast.VIP_PERMISSIONS,s;return s=_.map(i,function(n){return{type:"html",html:'<a class="menu-item check'+((r&n.flag)>0?" checked":"")+'"><i class="icon icon-check" />'+'<span data-translate-text="'+n.locale+'" class="menu-title">'+_.getString(n.locale)+"</span>"+"</a>",closeOnClick:!1,click:function(i){var s=$(i.currentTarget);e.addVIPUser(t,n.flag^r).done(function(){r=e.getPermissionsForUserID(t),s.toggleClass("checked",r&n.flag>0)})}}}),s},getCurrentStatus:function(e){var t=this.get("UserID"),r=n.Models.User.getUserStatusDfds[t];if(e||!r||r.state()!=="pending")r=$.Deferred(),r.always(function(){delete n.Models.User.getUserStatusDfds[t]}),n.Models.User.getUserStatusDfds[t]=r,n.Models.User.getUsersStatuses([t]);return r.promise()},storeCurrentBroadcast:function(e,t,r,i,s,o,u){var a={};a.statusFromSwf=!!u;if(t){if(!u&&t<this.attributes.currentBroadcastID)return{};a.onlineStatus=1,a.isOwnerOfCurrentBroadcast=e,a.currentBroadcastID=t,a.currentBroadcastName=r,a.currentBroadcastPicture=i;if(!e&&s&&s.i&&s.n)s.u?a.currentBroadcastOwner=n.Models.User.newOrUpdate({FName:s.n,UserID:_.toInt(s.i),Picture:s.p}):a.currentBroadcastOwner=n.Models.Artist.newOrUpdate({ArtistName:s.n,ArtistID:_.toInt(s.i),CoverArtFilename:s.p}),a.currentBroadcastOwner.storeCurrentBroadcast(1,t,r,i,null);else if(!e&&s&&(s instanceof n.Models.User&&this!==s||s instanceof n.Models.Artist))a.currentBroadcastOwner=s,s.storeCurrentBroadcast(1,t,r,i);else{a.currentBroadcastOwner=null;if(u){var f=n.Models.Broadcast.getCached(t);f&&f.set("activeStatus",1)}}}else a.isOwnerOfCurrentBroadcast=0,a.currentBroadcastID=null,a.currentBroadcastName=null,a.currentBroadcastPicture=null,a.currentBroadcastOwner=null;if(o)return a;this.set(a)},updateStatusFromManatee:function(e){var t={onlineStatus:_.toInt(e.status)},r,i;e.bcastOwnerInfo&&e.bcastOwnerInfo.u&&(r=n.Models.User.getCached(_.toInt(e.bcastOwnerInfo.i))),r&&(r instanceof n.Models.AuthUser||!r.get("isFavorite"))&&(r=null),e.bcast&&t.onlineStatus?$.extend(t,this.storeCurrentBroadcast(_.toInt(e.bcastOwner),e.bcast,e.bcastName,e.bcastPic,e.bcastOwnerInfo,!0,!0)):(this.attributes.currentBroadcastID||typeof this.attributes.currentBroadcastID=="undefined")&&$.extend(t,this.storeCurrentBroadcast(0,null,null,null,null,!0,!0)),this.get("isFavorite")&&(i=this.attributes.currentBroadcastOwner,i instanceof n.Models.Artist&&(i=getFakeSidebarArtistUser(i)),i&&i!=t.currentBroadcastOwner&&i.friendsLinked&&i.friendsLinked.remove(this),t.currentBroadcastOwner&&this.id!==n.getLoggedInUserID()&&!r&&(i=t.currentBroadcastOwner,i instanceof n.Models.Artist&&(i=getFakeSidebarArtistUser(i)),i instanceof n.Models.User&&(i.friendsLinked?i.friendsLinked.add(this):(i.friendsLinked=new n.Models.Collections.Users([this]),i!=t.currentBroadcastOwner&&(t.currentBroadcastOwner.friendsLinked=i.friendsLinked))))),n.getLoggedInUserIsChatVisible()&&(e.status&&e.song&&e.song.SongID?t.nowPlayingSong=n.Models.Song.newOrUpdate(e.song,{dontCache:!0}):t.nowPlayingSong=null,t.currentBroadcastOwner&&t.currentBroadcastOwner.friendsLinked&&(!t.currentBroadcastOwner.statusSubLocks||!t.currentBroadcastOwner.statusSubLocks[0])?t.currentBroadcastOwner.set({nowPlayingSong:t.nowPlayingSong}):t.currentBroadcastOwner&&(t.nowPlayingSong=t.currentBroadcastOwner.get("nowPlayingSong"))),t.onlineStatus||(t.nowPlayingSong=null),this.set(t),_.isUndefined(n.Models.User.getUserStatusDfds[this.id])||n.Models.User.getUserStatusDfds[this.id].resolve(e,this.id)},monitorUserStatus:function(e){var t=r.model.get("manatee");t.monitorUsers([this.id],e)},subscribeToStatus:function(e){var t=r.model.get("manatee"),i=n.Services.Manatee.chatReady,s=this.id,o=t.currentUserMonitors[s]&&t.currentUserMonitors[s]._isStatusSubbed,u=!1,a=6e3,f,l;this.statusSubLocks||(this.statusSubLocks=[]);if(!n.Models.User.getUserStatusDfds[s]||n.Models.User.getUserStatusDfds[s].state()==="pending")n.Models.User.getUserStatusDfds[s]=$.Deferred(),u=!0;return f=n.Models.User.getUserStatusDfds[s],t.monitorUsers([s],e,{forceSub:!0}),u&&(o?f.resolve():(i.state()==="pending"&&(a+=1e4),l=setTimeout(function(){n.Models.User.getUserStatusDfds[s]&&n.Models.User.getUserStatusDfds[s].reject()},a),f.always(function(){delete n.Models.User.getUserStatusDfds[s],clearTimeout(l)}))),f.promise()},unsubscribeFromStatus:function(e){var t=r.model.get("manatee"),n=t.currentUserMonitors[this.id];if(!this.monitor)return;n.removeLock(e)},unsubscribeAllFromStatus:function(){},playStation:function(){var e=r.model.get("player"),t=this,i=t.get("UserID"),s=t.get("playlists");s=new n.Models.Collections.Playlists(s&&s.models||null),s.comparator=n.Models.Playlist.modifiedSort,s.sort(),s=s.takeRight(3).reverse();var o=function(r){var o={secondaryArtistWeightModifier:.1,seedArtistWeightRange:[80,100],weightModifierRange:[-9,9]},u=$.Deferred(),a={},f=new n.Models.Collections.PlayableSongs,l=new n.Models.Collections.PlayableSongs,c=1,h=e&&e.get("queue"),p=new n.Models.Radio(o),d=p.get("songPool"),v={},m=!1,g=Date.now(),y=1,b=0,w=!1,E=!1,S,x;S=function(e,t,n,r){var i=[];return r&&(r=r.models?r.toJSON():r,w&&(r=_.shuffle(r)),i=_.take(r,_.toInt(t)),n==1?f.add(i):l.add(i)),f.length&&!a[e]&&c<=3&&g&&(Date.now()-g)/1e3>1&&(console.log("time expired, songBucket!"),x(e)),_.difference(r,i)},x=function(e){if(a[e])return;a[e]=!0;if(w){var t=_.shuffle(f.models);f.reset([],{silent:!0}),f.reset(t)}var r=Math.floor(f.length*y),s=f.take(r),o;f.length<=4&&l.length&&(s=s.concat(l.models),l.reset([]));if(!s||!s.length){u.notify(c++);return}f.reset(f.drop(r)),s=new n.Models.Collections.PlayableSongs(s),m?(o=h.get("activeSong"),d.reset(s.models)):(s=n.Models.Queue.sortSongsForRadio(s,{shuffle:!1}),m=!0,o={},s=s.models,d.reset(s),d.on("reset remove",function(){if(d.length!==0)return;if(h.get("parasite")!==p){d.off(null,null,v);return}u.notify(c++)},v),n.trigger("guts:startNewAutoplayContext","user",i)),b+=s.length,d.length&&!E&&(E=!0,h.set({parasite:p}))},u.progress(function(e){if(e>7)return;var r=!1,i=[],o=function(e,t,n,i){a&&clearTimeout(a);if(r)return;r=!0,S(e,t,n,i)},a;switch(e){case 1:i.push(t.getPersonalizedSongs().done(function(t){o(e,2,1,t)})),a=setTimeout(function(){u.notify(c++)},1200),t.getLibrary(),t.getFavoritesByType("Songs");break;case 2:i.push(t.getPersonalizedSongs(!1,!0).done(function(t){var n=o(e,Math.min(100,t.length/1.4),1,t);n&&n.length&&o(e,100,2,n)}));break;case 3:case 4:case 5:w=!0,y=.67;if(!s.length){c=7,u.notify(6);return}var m=s.shift();i.push(m.getUnwrappedSongs().done(o,this,e,5,1));break;case 6:y=1,f.add(l.models),l.reset([]),i.push($.Deferred().resolve());break;case 7:t.getTopArtists().done(function(e){var t=p.get("frowns"),r=h.get("songs"),i=r.pluck("ArtistID"),s=e.pluck("ArtistID"),o=t.pluck("ArtistID"),u={};i=_.uniq(i.concat(i,s)),i=_.difference(i,o);for(var a=0,f=i.length;a<f;a++)u[i[a]]="p";d.off(null,null,v),p.set("seedArtists",u),_.gaTrackEvent("player","clientRadioFallbackToServer","fallbackSeedArtistIDs:"+i.length+",fallbackSeedFrownArtistIDs:"+o.length),n.trigger("guts:forcelog","clientRadioFallbackToServer",{fallbackSeedArtistIDs:i.toString(),fallbackSeedFrownArtistIDs:o.toString()}),n.trigger("guts:startAutoplayFallbackContext","autoplay",0,"artist",i.toString())});return;default:n.trigger("lightbox:open","stations",{noRecs:!0}),h.set("parasite",null),n.trigger("notification:add",{title:_.getString("ERROR_FETCHING_STATION"),description:"",url:"",type:"error"}),n.trigger("guts:clearAllAutoplayContexts");return}$.after(i).always(_.bind(function(){f.length?x.apply(this,[e].concat(_.toArray(arguments))):d.length||u.notify(c++)},this))}),u.notify(c++)};r.radioClearQueue(o)}},{getUserStatusDfds:{},artPath:"/static/users/",coverArtPath:"/static/usercovers/",coverArtPathDefault:"default/cover/user.png",coverArtPathDefaultRetina:"default/cover/retina/user.png",artistCoverArtPathDefault:"default/cover/artist.png",artistCoverArtPathDefaultRetina:"default/cover/retina/artist.png",themeArtPath:"/static/userthemes/",urlTypes:{fb:"Facebook",tw:"Twitter",yt:"YouTube",ig:"Instagram",bc:"Bandcamp",sk:"Songkick",sc:"SoundCloud",ms:"Myspace",it:"iTunes",fl:"Flattr",mr:"Merch",wp:"Wikipedia",site:"Website"},urlIcons:{fb:"facebook",tw:"twitter",yt:"youtube",ig:"instagram",bc:"musicnote",sk:"musicnote",sc:"soundcloud",ms:"myspace",it:"musicnote",fl:"flattr",mr:"merch",wp:"wikipedia",site:"globe"},get:function(e,t){var r,i;if(e==n.getLoggedInUserID()&&(i=n.Models.AuthUser.getCached(e)))r=new $.Deferred,r.resolve(i);else{var s=function(e){var t=new $.Deferred;return n.Services.API.getUserByID(e).done(function(e){e=e.User||{},t.resolve(e)}).fail(_.bind(t.reject,t)),t.promise()};r=Backbone.CachedModel.genericGet.call(this,s,"UserID",e,t)}return r.promise()},getCached:function(e){var t,i=typeof r!="undefined"&&r.model&&r.model.get("user"),s=i&&i.id;return e==s&&this!==n.Models.AuthUser?t=n.Models.AuthUser.getCached(e):t=Backbone.CachedModel.getCached.call(this,e),t},getUsersStatuses:function(e){var t=[],i=r.model.get("manatee"),s=n.Services.Manatee.chatReady,o=0,u=e.length,a=$.Deferred(),f=6e3,l,c,h;for(;o<u;o++)l=e[o],!this.getUserStatusDfds[l]||this.getUserStatusDfds[l].state()!=="pending"?t.push(this.getUserStatusDfds[l]=$.Deferred()):t.push(this.getUserStatusDfds[l]);return h=i.getUsersKeys(e,["s"]),h.done(function(e){var t=[],r=e&&e["return"],i,s,o,u,f;r||a.reject();for(i=0,s=r.length;i<s;i++)o=_.toInt(r[i].userid),f=r[i].values[0],t.push({userID:o,status:f}),u=n.Models.User.getCached(o),u?u.updateStatusFromManatee(f):n.Models.User.getUserStatusDfds[o]&&(n.Models.User.getUserStatusDfds[o].resolve(f),delete n.Models.User.getUserStatusDfds[o]);a.resolve(t),clearTimeout(c)}),s.state()==="pending"&&(f+=1e4),c=setTimeout(_.bind(function(){a.reject();for(o=0,u=e.length;o<u;o++)this.getUserStatusDfds[l]&&this.getUserStatusDfds[l].reject()},this),f),a},pictureNameSort:function(e,t){if(e.attributes.Picture&&!t.attributes.Picture)return-1;if(t.attributes.Picture&&!e.attributes.Picture)return 1;var n=e.attributes.Name,r=t.attributes.Name;return n&&r?(n=n.toLowerCase(),r=r.toLowerCase(),n<r?-1:n===r?0:1):n?-1:r?1:0},interactedNiftyFriendSort:function(e,t){var r=e.attributes.TSInteracted,i=t.attributes.TSInteracted;return r!==i?i-r:n.Models.User.niftyFriendSort(e,t)},niftyFriendSort:function(e,t){var r=e.attributes.isFavorite,i=t.attributes.isFavorite;if(r&&i){var s=e.attributes.isFollower,o=t.attributes.isFollower;if(s&&!o)return-1;if(o&&!s)return 1}else{if(r)return-1;if(i)return 1}return n.Models.User.pictureNameSort(e,t)},addListenToRecentListensArray:function(e,t,n){var r=10,i=200,s=_.isArray(e)?e:[],o,u,a,f,l;if(!t||!n)return s;a=-1,l=t.get("SongID");for(o=0,u=s.length;o<u;o++){if(n-s[o].t[0]>86400)break;if(s[o].s.I==l){a=o;break}}return a!==-1?(f=s[a],f.t.length>=r&&f.t.splice(r-1,f.t.length-(r-1)),f.t.unshift(n),s.splice(a,1)):f={s:t.archiveAttr(),t:[n]},s.unshift(f),s.splice(i,s.length-i),s},FLAG_PLUS:1,FLAG_LASTFM:2,FLAG_FACEBOOK:4,FLAG_FACEBOOKUSER:16,FLAG_GOOGLEUSER:32,FLAG_GOOGLE:64,FLAG_ANYWHERE:128,FLAG_ISARTIST:256,FLAG_MUSIC_BUSINESS:1024,FLAG_TWITTER:4096,FLAG_TWITTERUSER:8192,FLAG_LITE:32768,FLAG_KINESIS:16384,FLAG_ARTIST_CLAIMED:65536,FLAG_FLATTR:131072,FLAG_VERIFIED_EMAIL:524288,FLAG_HAS_NEW_SUB:1048576,FLAG_HAS_SPECIAL_PRICE:2097152,FLAG_ARTIST_PROFILE:4194304,FOLLOWERS_FLAG_DISABLE_BROADCAST_UPDATES:2,FLAG_EMAIL_DISABLE_FOLLOWED:1,FLAG_EMAIL_DISABLE_INVITESIGNUP:2,FLAG_NOTIF_DISABLE_COMMENT:4,FLAG_EMAIL_DISABLE_SHARE:8,FLAG_EMAIL_DISABLE_PLAYLIST_SUBSCRIBE:16,FLAG_EMAIL_DISABLE_COMMENT:32,FLAG_NOTIF_DISABLE_COMMENT_REPLY:64,FLAG_NOTIF_DISABLE_COMMENT_FEED:256,FLAG_NOTIF_DISABLE_LIKE_SHARE:512,FLAG_NOTIF_DISABLE_PLAYLIST_SUBSCRIBE:1024,FLAG_NOTIF_DISABLE_COMMENT_THREAD:2048,FLAG_EMAIL_DISABLE_ANNOUNCEMENTS:4096,FLAG_EMAIL_DISABLE_COMMENT_REPLY:8192,FLAG_EMAIL_DISABLE_BILLING_EXPIRES_SOON:16384,FLAG_EMAIL_DISABLE_CIVICSCIENCE:32768,FLAG_EMAIL_DISABLE_KINESIS:65536,FLAG_NOTIF_DISABLE_THIRDPARTY_FRIENDS:131072,FLAG_EMAIL_DISABLE_BROADCAST:262144,FLAG_EMAIL_DISABLE_ARTIST_UPDATE:524288,MAX_ONLINE_IDLE_TIME:9e5,FLAG_TAG_DISABLE_UPDATES:1})}(),function(){function i(e,t){if(!t)this.set("artistsOwned",t),e.reject();else{var r=new n.Models.Collections.Artists(t);r.comparator=_.getModelSort("ArtistName",!0),this.set("artistsOwned",r);var i=!n.Services.Local.get("gs.contextTopHat")&&r.length&&(r.length>1||!this.get("artistID"))&&!$("#top-hat-notif.notif").length;i&&setTimeout(_.bind(function(){n.trigger("tophat:open",{name:"context",template:"contextTopHat",templateVars:{user:this}}),n.once("switchUser",function(){n.trigger("tophat:close")})},this),5e3),e.resolve(r)}delete this.loadOwnedArtistsDfd}function s(e,t){this.set("extraData",t),t?e.resolve(t):e.reject()}function o(t,r){if(!r)t.reject();else{var i=r.Data||{};if(_.defined(i.PendingNotification)){var s=function(){n.Services.API.userSawPendingNotification(i.PendingNotification)};switch(i.PendingNotification){case"canceledCard1119":e.location.hash=="#!/upgrade"||e.location.hash=="#!/settings/subscription"||this.get("subscription").get("apiVersion")>1?s():setTimeout(function(){n.trigger("notification:add",{description:_.getString("ERROR_NOTIF_SUB_EXPIRED"),type:"error",click:function(){n.router.setHash("/upgrade")},duration:0,closeAction:s})},1e3);break;case"incorrectEmail1212":setTimeout(function(){n.trigger("notification:add",{description:_.getString("ERROR_NOTIF_INCORRECT_EMAIL"),type:"error",click:function(){n.router.setHash("/settings/account")},duration:0,closeAction:s})},1e3)}}this.set("pageNameDataLoaded",!0),this.setPageNameData(r),t.resolve(i)}}function a(e,t,n){if(!n){e.reject(n);return}var r={};t&&(this.get("pageNameData")&&this.get("pageNameData").URLs?r.URLs=_.extend({},this.get("pageNameData").URLs,t):r.URLs=t);var i=_.extend({},this.get("pageNameData")||{},r);this.set("pageNameData",i),e.resolve(this.get("pageNameData"))}function f(e,t){n.Models.User.prototype.getLibrary.call(this,e).done(_.bind(function(e){t.resolve(e),this.storeLibrary()},this)).fail(function(e){t.reject(e)})}function l(e,t){this.set("broadcastInvites",t),t?e.resolve(t):e.reject()}function c(e,t,n){if(!n||n.statusCode!==1&&n.statusCode!==-6){n&&t.PageName&&(n.statusCode===-17||n.statusCode===-4||n.statusCode===-8||n.statusCode===-9)&&this.set("PathName",t.PageName),e.reject(n);return}if(n.statusCode===-6){e.resolve(n);return}var r=this.get("Picture"),i,s,o,u;t.hasOwnProperty("PageName")&&(t.PathName=t.PageName,delete t.PageName);if(t.hasOwnProperty("FName")||t.hasOwnProperty("Picture"))t.chatUserData=null,t.chatUserDataSig=null;t.hasOwnProperty("FName")&&($.trim(t.FName)?t.hasDefaultName=!1:(t.hasDefaultName=!0,t.FName="New User"),t.Name=t.FName,n.generatedPicture&&(!r||r.match(/_generated\.png$/))&&(t.Picture=n.generatedPicture));if(t.hasOwnProperty("Country")||t.hasOwnProperty("City")||t.hasOwnProperty("State"))i=t.hasOwnProperty("City")?t.City:this.get("City"),s=t.hasOwnProperty("State")?t.State:this.get("State"),o=t.hasOwnProperty("Country")?t.Country:this.get("Country"),u=[],i&&u.push(i),s&&u.push(s),o&&u.push(o),u.length?t.Location=u.join(", "):t.Location="";this.set(t),e.resolve(n)}function h(e,t,r){var i=r&&r.Timestamps?_.toInt(r.Timestamps.newTSModified):null,s=(new Date(i*1e3)).format("Y-m-d G:i:s");this.localAddSongsToLibrary(t,s),this.set("SettingsFlags",(this.get("SettingsFlags")||0)|ut.APP_SETTING_USES_COLLECTION);if(!e)return;var o=[],u=[],a,f,l;for(f=0,l=t.length;f<l;f++)a=t[f].get("SongID"),o.push(a),u.push({id:a,item:t[f].toManateeProperties()});r&&r.Timestamps&&(_.toInt(r.Timestamps.oldTSModified)>this.get("libraryTSModified")?this.refreshLibrary():i&&this.set("libraryTSModified",i)),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONGS_ADDED",{songCount:t.length}),icon:"musicnote",type:"success",url:this.toUrl("collection")}):t[0].get("isFavorite")||n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONG_ADDED"),icon:"musicnote",type:"success",url:this.toUrl("collection")}),e.resolve(t),n.trigger("guts:log","songAddedToLibrary",{ids:o.toString()}),this.syncUserContentChange("libraryChange",{added:!0,items:u,type:"Songs",TSAdded:i},"libraryAddedSongs")}function p(e,t,r){e.reject(r),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONGS_ADD_FAILED",{songCount:t.length}),type:"error"}):n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONG_ADD_FAILED"),type:"error"})}function d(e,t,r){this.localRemoveSongsFromLibrary(t);if(!e)return;var i=r&&r.Timestamps?_.toInt(r.Timestamps.newTSModified):null,s=[],o=[],u,a,f;for(a=0,f=t.length;a<f;a++)u=t[a].get("SongID"),s.push(u),o.push({id:u});r&&r.Timestamps&&(_.toInt(r.Timestamps.oldTSModified)>this.get("libraryTSModified")?this.refreshLibrary():i&&this.set("libraryTSModified",i)),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONGS_REMOVED",{songCount:t.length}),icon:"musicnote",type:"success"}):n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONG_REMOVED"),icon:"musicnote",type:"success"}),e.resolve(t),n.trigger("guts:log","songRemovedFromLibrary",{ids:s.toString()}),this.syncUserContentChange("libraryChange",{added:!1,items:o,type:"Songs"},"libraryRemovedSongs")}function v(e,t,r){e.reject(r),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONGS_REMOVE_FAILED",{songCount:t.length}),type:"error"}):n.trigger("notification:add",{title:_.getString("POPUP_COLLECTION_SONG_REMOVE_FAILED"),type:"error"})}function m(e,t,r,i){var s=n.Models.Collections[t],o="favorite"+t,u=this.get(o),a=i.TSFavorited?new Date(i.TSFavorited*1e3):new Date,f=t.toLowerCase().substr(0,t.length-1),l=r.id,c;if(t=="Songs")c=a.format("Y-m-d G:i:s"),this.localAddSongsToFavorites([r],c);else{c=a.format("Y-m-d");var h;if(t=="Artists"&&i&&i.profile){var p=n.Models.Profile.newOrUpdate(i.profile),d=p.get("user");d&&(h=d)}r.set({isFavorite:!0,TSFavorited:c}),t==="Playlists"&&r.set({SubscriberCount:(r.get("SubscriberCount")||0)+1}),u&&u instanceof s&&u.add(r);if(h&&!(u instanceof n.Models.Collections.Users)){h.set({isFavorite:!0,TSFavorited:c});var v=this.get("favoriteUsers");v&&v.add(h)}t==="Users"?this.updateUserTSInteraction(r.id,n.Models.AuthUser.INTERACTION_TYPE_FOLLOW):h?this.updateUserTSInteraction(h.id,n.Models.AuthUser.INTERACTION_TYPE_FOLLOW):t==="Playlists"&&this.updateUserTSInteraction(r.get("UserID"),n.Models.AuthUser.INTERACTION_TYPE_PLAYLIST_SUB)}if(!e)return;t=="Songs"&&n.trigger("notification:add",{title:_.getString("POPUP_FAVORITE_SONG_ADDED"),icon:"heart",type:"success",url:this.toUrl("collection/favorites")}),t=="Songs"&&n.Services.Flattr.isUserConnected()&&n.Services.Flattr.isUserFavoriteAndFlattr()&&n.trigger("flattr:songFaved",r),e.resolve(r),_.gaTrackEvent("user","objectFavorited",f),n.trigger("guts:log","objectFavorited",{type:f,id:l}),(t=="Songs"||t=="Playlists"||t=="Broadcasts")&&this.syncUserContentChange("favoriteChange",{added:!0,items:[{id:r.id,item:r.toManateeProperties()}],type:t},"favoriteAdded"+t)}function g(e,t,r,i){var s=t.toLowerCase().substr(0,t.length-1);_.gaTrackEvent("user","objectFavoritedFailed",s),n.trigger("guts:log","objectFavoritedFailed",{type:s,id:r.id}),e.reject(i),n.trigger("notification:add",{title:_.getString("POPUP_FAVORITE_SONG_ADD_FAILED"),type:"error"})}function y(e,r,i,s){var o=n.Models.Collections[r],u="favorite"+r,a=this.get(u),f=r.toLowerCase().substr(0,r.length-1),l=i.id;if(r=="Songs")this.localRemoveSongsFromFavorites([i]);else{var c;if(r=="Artists"&&s&&s.profile){var h=n.Models.Profile.newOrUpdate(s.profile),p=h.get("user");p&&(c=p)}i.set({isFavorite:!1,TSFavorited:t}),r==="Playlists"&&i.set({SubscriberCount:i.get("SubscriberCount")-1}),a&&a instanceof o&&a.remove(i);if(c&&!(a instanceof n.Models.Collections.Users)){c.set({isFavorite:!1,TSFavorited:t});var d=this.get("favoriteUsers");d&&d.remove(c)}}if(!e)return;r=="Songs"&&n.trigger("notification:add",{title:_.getString("POPUP_FAVORITE_SONG_REMOVED"),icon:"heart",type:"success"}),e.resolve(i),_.gaTrackEvent("user","objectFavorited",f),n.trigger("guts:log","objectUnfavorited",{type:f,id:l}),(r=="Songs"||r=="Playlists"||r=="Broadcasts")&&this.syncUserContentChange("favoriteChange",{added:!1,items:[{id:i.id}],type:r},"favoriteRemoved"+r)}function b(e,t,r,i){var s=t.toLowerCase().substr(0,t.length-1);_.gaTrackEvent("user","objectUnfavoritedFailed",s),n.trigger("guts:log","objectUnfavoritedFailed",{type:s,id:r.id}),e.reject(i),n.trigger("notification:add",{title:_.getString("POPUP_FAVORITE_SONG_REMOVE_FAILED"),type:"error"})}function w(e,t,r){if(!e.loadSubscriptionDfd||e.loadSubscriptionDfd.state()==="rejected"||t){e.loadSubscriptionDfd=$.Deferred();var i=rt.get("isLoaded");i&&!t?rt.loadSpecialPricing().done(function(){e.loadSubscriptionDfd.resolve(rt)}):u.get(e).done(function(t){if(i&&r&&t.isSpecial()&&!rt.isSpecial()){var s=e.get("Flags");rt.get("apiVersion")==1&&(s&n.Models.User.FLAG_HAS_NEW_SUB)>0&&e.set("Flags",s&~n.Models.User.FLAG_HAS_NEW_SUB),e.loadSubscriptionDfd.resolve(rt);return}t.isPremium()&&e.get("IsPremium")==0&&e.set({chatUserData:null,chatUserDataSig:null,IsPremium:1}),rt=t,e.trigger("change:subscription"),e.loadSubscriptionDfd.resolve(t)}).fail(_.bind(e.loadSubscriptionDfd.reject,e.loadSubscriptionDfd))}return e.loadSubscriptionDfd.promise()}function E(e,t,r,i){switch(e){case"remove":this.get("friends").remove(t);break;case"add":r===this.get("favoriteUsers")?(this.get("followers").get(t.id)&&this.get("friends").add(t),t.set("isFavorite",!0)):r===this.get("followers")?(this.get("favoriteUsers").get(t.id)&&this.get("friends").add(t),t.set("isFollower",!0)):console.warn("_onFavoriteUsersFollowersChanged fired on unknown collection: ",r);break;case"reset":this.get("friends").reset(_.intersection(this.get("favoriteUsers").models,this.get("followers").models));break;case"change:currentBroadcastOwner":if(t.get("isFavorite")){var s=t.previous("currentBroadcastOwner"),o=t.get("currentBroadcastOwner");if(s&&(!s.friendsLinked||!s.friendsLinked.length)){this.get("extraSidebarUsers").remove(s);if(!(s instanceof n.Models.AuthUser)){var u=s.get("artist");s.id<-100&&u&&(u.off(null,null,s),n.Models.User.uncache(s))}}o&&!o.get("isFavorite")&&this.get("extraSidebarUsers").add(o)}}}function x(e,t,r){if(!r)e.reject(!1,r);else{if(r.length>=S){e.reject(!0,r);return}var i=new n.Models.Collections.Users(r,{silent:!0}),s=[],o=[],u=[];i.each(function(e){e.attributes.isFavorite&&o.push(e),e.attributes.isFollower&&s.push(e),e.attributes.isFavorite&&e.attributes.isFollower&&u.push(e)}),s=new n.Models.Collections.Users(s,{silent:!0,isFollower:!0}),o=new n.Models.Collections.Users(o,{silent:!0,isFavorite:!0}),u=new n.Models.Collections.Users(u,{silent:!0}),this.set({followers:s,favoriteUsers:o,friends:u,extraSidebarUsers:new n.Models.Collections.Users}),s.on("all",E,this),o.on("all",E,this),e.resolve(u)}}function T(e,t){if(!t||!t.playlists)e.reject(t);else{var r={silent:!0,notifyCache:!0,isFavorite:!0},i=new n.Models.Collections.Playlists(t.playlists,r),s=new n.Models.Collections.Broadcasts(t.broadcasts,r);this.set({favoritePlaylists:i,favoriteBroadcasts:s}),e.resolve()}}function N(e,t,r,i,s,o){if(o<1){C(e,o);return}if(!e)return;var u=_.currentTime(),a=new n.Models.Playlist({PlaylistID:o,PlaylistName:t,Description:i,Username:this.get("Name"),UserID:this.get("UserID"),FName:this.get("FName"),LName:this.get("LName"),initialSongs:r,TSAdded:u,TSModified:u}),f;s&&n.Models.Tag.get(s).done(_.bind(function(e){a.set("Tag",e)},this)),this.getPlaylists().done(function(e){e.add(a)}),n.trigger("notification:add",{title:_.getString("POPUP_PLAYLIST_CREATE_TITLE_2"),description:_.getString("POPUP_PLAYLIST_CREATE_DESCRIPTION"),url:a.toUrl(),icon:"new-playlist",type:"success"}),_.gaTrackEvent("user","playlistCreated"),n.trigger("guts:forcelog","playlistCreated",{playlistID:o}),r.length&&(f=r.length===1?"singleSongAddedToPlaylist":"songsAddedToPlaylist",_.gaTrackEvent("playlist",f,"count",r.length),n.trigger("guts:forcelog",f,{playlistID:o,ids:_.pluck(r,"SongID")})),e.resolve(a),this.syncUserContentChange("playlistChange",{action:"create",items:[a.toManateeProperties()]},"playlistCreated")}function C(e,t){e.reject(t)}function k(e,t,r,i){if(!i){L(e,t,r);return}e.set("isDeleted",!0),this.get("playlists")&&this.get("playlists").remove(e);if(!t)return;r&&n.trigger("notification:add",{title:_.getString("POPUP_PLAYLIST_DELETE_TITLE",{playlist:e.get("PlaylistName")}),description:_.getString("POPUP_PLAYLIST_DELETE_DESCRIPTION"),url:this.toUrl("music/playlists"),icon:"playlist",type:"success"}),_.gaTrackEvent("user","playlistDeleted"),n.trigger("guts:forcelog","playlistDeleted",{playlistID:e.get("PlaylistID")}),t.resolve(),this.syncUserContentChange("playlistChange",{action:"delete",items:[e.toManateeProperties()]},"playlistDeleted")}function L(e,t,r){r&&n.trigger("notification:add",{description:_.getString("POPUP_FAIL_DELETE_PLAYLIST_MSG",{playlist:e.PlaylistName}),type:"error"}),_.gaTrackEvent("user","deletePlaylistFailed"),n.trigger("guts:log","deletePlaylistFailed",{playlistID:e.get("PlaylistID")}),t.reject()}function A(e,t,r,i){if(!i){O(e,t,r);return}e.set("isDeleted",!1),this.get("playlists").add(e),r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_PLAYLIST_RESTORED"),url:e.toUrl(),icon:"playlist",type:"success"}),_.gaTrackEvent("user","restorePlaylist"),n.trigger("guts:log","restorePlaylist",{playlistID:e.get("PlaylistID")}),t.resolve()}function O(e,t,r){r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_PLAYLIST_RESTORE_FAIL_2"),type:"error"}),_.gaTrackEvent("user","restorePlaylistFailed"),n.trigger("guts:log","restorePlaylistFailed",{playlistID:e.get("PlaylistID")}),t.reject()}function M(e,t,r,i){if(!i){D(e,t,r);return}e.set("isDeleted",!0),this.get("broadcasts")&&this.get("broadcasts").remove(e),r&&n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_DELETE_TITLE",{broadcast:e.escape("Name")}),description:_.getString("POPUP_BROADCAST_DELETE_DESCRIPTION"),url:e.toUrl(),type:"success"}),_.gaTrackEvent("user","broadcastDeleted"),n.trigger("guts:forcelog","broadcastDeleted",{broadcastID:e.get("BroadcastID")}),t.resolve();var s=n.Services.Local.get("lastBroadcasting"+this.id);s&&s.broadcastID==e.get("BroadcastID")&&n.Services.Local.remove("lastBroadcasting"+this.id)}function D(e,t,r){r&&n.trigger("notification:add",{description:_.getString("POPUP_FAIL_DELETE_BROADCAST_MSG",{broadcast:e.escape("Name")}),type:"error"}),_.gaTrackEvent("user","deleteBroadcastFailed"),n.trigger("guts:log","deleteBroadcastFailed",{broadcastID:e.get("BroadcastID")}),t.reject()}function P(e,t,r,i){if(!i){H(e,t,r);return}e.set("isDeleted",!1),this.get("broadcasts")&&this.get("broadcasts").add(e),r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_BROADCAST_RESTORED"),url:e.toUrl(),type:"success"}),_.gaTrackEvent("user","restoreBroadcast"),n.trigger("guts:log","restoreBroadcast",{broadcastID:e.get("BroadcastID")}),t.resolve()}function H(e,t,r){r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_BROADCAST_RESTORE_FAIL"),type:"error"}),_.gaTrackEvent("user","restoreBroadcastFailed"),n.trigger("guts:log","restoreBroadcastFailed",{broadcastID:e.id}),t&&t.reject()}function B(e){e?(this.set("recommendedUsers",new n.Models.Collections.Users(e)),this.recommendedUsersDfd.resolve(this.get("recommendedUsers"))):this.recommendedUsersDfd.reject()}function j(e,t){t?(this.set("claimHistory",t),e.resolve(t)):e.reject()}function F(e){e&&e.status&&this.id===e.userID&&this.currentMasterStatusDfd&&this.currentMasterStatusDfd.resolve(e.status)}function I(){this.userNotificationsDfd=null,this.set("notifications",null)}function q(t,r){if(!r||n.isBroadcastListener())return;var i=Math.floor((Date.now()+e.clientTimeDivergence)/1e3);r.getTags().always(_.bind(function(){this.addLocalSongListen(r,i,!0)},this))}function R(e){var t={local:{}};return t.local.artistsPlayed=_.orEqual(n.Services.Local.get("artistsPlayed"+e),[]),t.local.recentListens=_.orEqual(n.Services.Local.get("recentListens"+e),[]),_.isArray(t.local.artistsPlayed)||(t.local.artistsPlayed=[]),t}function U(e,t){var n=e.get("settings").local,r=_.extend({},n,t),i=e.get("SettingsFlags")||0,s=e.get("PlayerFlags")||0,o,u,a;return u=i&~(ut.APP_SETTING_RESTORE_QUEUE|ut.APP_SETTING_CLEAR_PLAYER_SETTINGS|ut.APP_SETTING_LOWER_QUALITY|ut.APP_SETTING_FAMILY_FRIENDLY|ut.APP_SETTING_DISABLE_PLAYER_SHORTCUTS|ut.APP_SETTING_CHAT_SHOW_JOIN_LEAVE|ut.APP_SETTING_CHAT_HIDE_NOW_PLAYING|ut.APP_SETTING_CHAT_HIDE_SUGGESTIONS|ut.APP_SETTING_CHAT_HIDE_MY_TAG|ut.APP_SETTING_ENABLE_BROWSER_NOTIFS|ut.APP_SETTING_BROADCAST_AUTO_APPROVE),a=s&~(ut.PLAYER_SETTING_CROSSFADE_ENABLED|ut.PLAYER_SETTING_SHUFFLE_ENABLED|ut.PLAYER_SETTING_CROSSFADE_SECS_3|ut.PLAYER_SETTING_CROSSFADE_SECS_4|ut.PLAYER_SETTING_CROSSFADE_SECS_5|ut.PLAYER_SETTING_CROSSFADE_SECS_6|ut.PLAYER_SETTING_CROSSFADE_SECS_7|ut.PLAYER_SETTING_CROSSFADE_SECS_8|ut.PLAYER_SETTING_CROSSFADE_SECS_ANY|ut.PLAYER_SETTING_PLAY_PAUSE_FADE),typeof t.restoreQueue=="undefined"?u|=n.restoreQueue?ut.APP_SETTING_RESTORE_QUEUE:0:t.restoreQueue&&(u|=ut.APP_SETTING_RESTORE_QUEUE),typeof t.clearPlayerSettings=="undefined"?u|=n.clearPlayerSettings?ut.APP_SETTING_CLEAR_PLAYER_SETTINGS:0:t.clearPlayerSettings&&(u|=ut.APP_SETTING_CLEAR_PLAYER_SETTINGS),typeof t.lowerQuality=="undefined"?u|=n.lowerQuality?ut.APP_SETTING_LOWER_QUALITY:0:t.lowerQuality&&(u|=ut.APP_SETTING_LOWER_QUALITY),typeof t.themeFlags=="undefined"?u|=n.themeFlags&!0?ut.APP_SETTING_FAMILY_FRIENDLY:0:t.themeFlags&!0&&(u|=ut.APP_SETTING_FAMILY_FRIENDLY),typeof t.disablePlayerShortcuts=="undefined"?u|=n.disablePlayerShortcuts?ut.APP_SETTING_DISABLE_PLAYER_SHORTCUTS:0:t.disablePlayerShortcuts&&(u|=ut.APP_SETTING_DISABLE_PLAYER_SHORTCUTS),typeof t.joinLeftDisabled=="undefined"?u|=n.joinLeftDisabled?0:ut.APP_SETTING_CHAT_SHOW_JOIN_LEAVE:t.joinLeftDisabled||(u|=ut.APP_SETTING_CHAT_SHOW_JOIN_LEAVE),typeof t.nowPlayingDisabled=="undefined"?u|=n.nowPlayingDisabled?ut.APP_SETTING_CHAT_HIDE_NOW_PLAYING:0:t.nowPlayingDisabled&&(u|=ut.APP_SETTING_CHAT_HIDE_NOW_PLAYING),typeof t.suggestionsDisabled=="undefined"?u|=n.suggestionsDisabled?ut.APP_SETTING_CHAT_HIDE_SUGGESTIONS:0:t.suggestionsDisabled&&(u|=ut.APP_SETTING_CHAT_HIDE_SUGGESTIONS),typeof t.ignoreChatTag=="undefined"?u|=n.ignoreChatTag?ut.APP_SETTING_CHAT_HIDE_MY_TAG:0:t.ignoreChatTag&&(u|=ut.APP_SETTING_CHAT_HIDE_MY_TAG),typeof t.enableBrowserNotifications=="undefined"?u|=n.enableBrowserNotifications?ut.APP_SETTING_ENABLE_BROWSER_NOTIFS:0:t.enableBrowserNotifications&&(u|=ut.APP_SETTING_ENABLE_BROWSER_NOTIFS),typeof t.broadcastAutoApprove=="undefined"?u|=n.broadcastAutoApprove?ut.APP_SETTING_BROADCAST_AUTO_APPROVE:0:t.broadcastAutoApprove&&(u|=ut.APP_SETTING_BROADCAST_AUTO_APPROVE),typeof t.crossfadeEnabled=="undefined"?a|=n.crossfadeEnabled?ut.PLAYER_SETTING_CROSSFADE_ENABLED:0:t.crossfadeEnabled&&(a|=ut.PLAYER_SETTING_CROSSFADE_ENABLED),typeof t.shuffleEnabled=="undefined"?a|=n.shuffleEnabled?ut.PLAYER_SETTING_SHUFFLE_ENABLED:0:t.shuffleEnabled&&(a|=ut.PLAYER_SETTING_SHUFFLE_ENABLED),typeof t.crossfadeAmount=="undefined"?(o=n.crossfadeAmount/1e3,o&&ut["PLAYER_SETTING_CROSSFADE_SECS_"+o]&&(a|=ut["PLAYER_SETTING_CROSSFADE_SECS_"+o])):t.crossfadeAmount&&(o=t.crossfadeAmount/1e3,o&&ut["PLAYER_SETTING_CROSSFADE_SECS_"+o]&&(a|=ut["PLAYER_SETTING_CROSSFADE_SECS_"+o])),typeof t.playPauseFade=="undefined"?a|=n.playPauseFade?ut.PLAYER_SETTING_PLAY_PAUSE_FADE:0:t.playPauseFade&&(a|=ut.PLAYER_SETTING_PLAY_PAUSE_FADE),{SettingsFlags:u,PlayerFlags:a,local:r}}function z(e,t){var r=e.get("Privacy"),i=e.get("sessionPrivacy"),s=e.get("Privacy"),o=e.get("Privacy"),u=!1,a;if(_.defined(t.activityPrivacy))switch(t.activityPrivacy){case 1:r&1||(s=s&-3|1,u=!0),t.deleteActivity&&n.Services.API.deleteFeedEvents().fail(function(){n.trigger("notification:add",{title:_.getString("SETTINGS_DELETE_FAILED_TITLE"),type:"error",description:_.getString("SETTINGS_DELETE_FAILED")})});break;case 0:(r&3)>0?(s&=-4,u=!0):(i&1)>0&&(o&=-2);break;case 2:r&2||(s=s&-2|2,u=!0);break;case-1:if(!(r&1)||!(i&1))o|=1}if(_.defined(t.onlinePrivacy))switch(t.onlinePrivacy){case 4:r&4||(s=s&-9|4,u=!0);break;case 0:(r&12)>0?(s&=-13,u=!0):(i&4)>0&&(o&=-5);break;case 8:r&8||(s=s&-5|8,u=!0);break;case-4:if(!(r&4)||!(i&4))o|=4}return _.defined(t.recommendMe)&&(a=r&16,!t.recommendMe&&!a?(s|=16,u=!0):t.recommendMe&&a&&(s&=-17,u=!0)),{changed:u,Privacy:s,sessionPrivacy:u?s:o}}function W(){var e=this.id,t=this.get("Email"),r=Date.now(),i=n.Services.Local.get("lastLiveRampEx"+e);if(e>0&&t&&(!i||r-i>1296e6)){var s=hex_sha1($.trim(t.toLowerCase()));_.delay(function(){n.Services.Local.set("lastLiveRampEx"+e,Date.now()),$("iframe#liveRamp").remove();var t=$('<iframe id="liveRamp" name="_rlcdn" width=0 height=0 frameborder=0></iframe>'),r="http://ei.rlcdn.com/44054.html?s="+s;t.css("visibility","hidden"),t.attr("src",r),$("body").append(t)},3e4)}}function X(){var e=this.id,t=new Date,r=n.Services.Local.get("lastExcelateEx"+e),i=this.get("Sex"),s=this.get("TSDOB")?this.get("TSDOB").split("-"):!1;(!r||t.valueOf()-r>1296e6)&&_.delay(function(){n.Services.Local.set("lastExcelateEx"+e,Date.now()),$("iframe#excelate").remove();var r=$('<iframe id="excelate" width=0 height=0 frameborder=0></iframe>'),o=["http://loadus.exelator.com/load/?p=259&g=001&c=285367&j=w"];i&&e>0&&(o.push("&ge="),o.push(i.toLowerCase()=="m"?"0":"1"));if(s&&s.length==3&&e>0){var u=t.getFullYear()-_.toInt(s[0]);_.toInt(s[1])>t.month?u-=1:_.toInt(s[1])==t.month&&_.toInt(s[2])>t.date&&(u-=1),o.push("&ae="),o.push(n.Models.Ad.encodeInteger(u))}r.css("visibility","hidden"),r.attr("src",o.join("")),$("body").append(r)},31e3)}function V(e,t){t&&(t=n.Models.Broadcast.newOrUpdate(t,{source:"db"})),e.resolve(t)}function J(e,t){if(!_.isArray(t)||!t.length||!t[0].hasOwnProperty("CalloutID"))t=[];var r=new n.Models.Collections.Callouts(t,{user:this});this.set("callouts",r),e.resolve(r)}function K(e,t){e.reject(t)}function et(){if(!this.get("isLoggedIn"))return;var e=this.libraryFavoritesToSync,t,n,r,i=Y.length-1;if(!e||!e.length)return;this.libraryFavoritesToSync=[];var s=this.get("shouldSyncUserContent");if(!s){Z&&(clearInterval(Z),Z=0),s===!1&&(Y=[]);return}for(t=0,n=e.length;t<n;t++){r=e[t];if(i>-1&&Y[i].groupKey===r.groupKey){Y[i].params.items=Y[i].params.items.concat(r.params.items);continue}Y.push(r),i++}Z||(Z=setInterval(tt,1e3))}function tt(){if(!Y.length){clearInterval(Z),Z=0;return}if(n.Services.Manatee.chatReady.state()==="pending")return;var e=0,t=[],i,s;while(e<Q&&Y.length){s=Y[0],i=s.params.items&&s.params.items.length;if(i>Q){var o={type:s.type,groupKey:s.groupKey,params:$.extend({},s.params)};o.params.items=s.params.items.splice(Q),Y[0]=o}else Y.shift();if(i+e>Q){Y.unshift();break}e+=i,t.push(s)}try{var u=r.model.get("manatee");u&&u.publishToSelf("userContentSync",t)}catch(a){console.warn("Failed to sendSelfMessage with sync change",a,s)}}function nt(e,t){if(!t){e.reject();return}var r={},i={},s={},o={},u;_.each(t.playlists,function(e){r[e.PlaylistID]=e,u=n.Models.Playlist.getCached(e.PlaylistID),u&&u.set("TSLastPlayed",e.TSListened)}),_.each(t.users,function(e){o[e.UserID]=e,u=n.Models.User.getCached(e.UserID),u&&u.set("TSInteracted",e.TSInteraction)}),_.each(t.broadcasts,function(e){var t=e.Tag?e.Tag.i:0,n=e.UserID+":"+t;i[e.BroadcastID]=e,s[n]||(s[n]=[]),s[n].push(e)}),this.set({recentPlaylists:r,recentBroadcasts:i,recentBroadcastsByUserIDTag:s,recentUsers:o}),e.resolve(t.broadcasts,t.playlists,t.users,t.recentBroadcastsByUserIDTag)}n.Models=n.Models||{};var S=5e3,Q=40,G=0,Y=[],Z=0,rt,it=/^(?!.*\.@)(?!.*\.{2})[A-z0-9\._+-]+@[A-z0-9][A-z0-9-]*(\.[A-z0-9_-]+)*\.([A-z]{2,6})$/,st=/^([a-zA-Z0-9]+[\.\-_]?)+[a-zA-Z0-9]+$/,ot=33e5,ut=n.Models.AuthUser=n.Models.User.extend({parse:function(e,r){var i=r||{};i.isAuth=!0;var s=n.Models.User.prototype.parse.call(this,e,i);return s.isLoggedIn=s.UserID>0,s.isAuth=!0,s.Privacy=_.orEqual(e.Privacy,e.privacy),s.Privacy=_.toInt(e.Privacy),s.sessionPrivacy=s.Privacy,s.NotificationEmailPrefs=_.toInt(e.NotificationEmailPrefs),s.IsActive=e.IsActive,s.Zip=e.Zip,s.UploadsEnabled=e.UploadsEnabled,s.favoritesLimit=e.favoritesLimit,s.librarySizeLimit=e.librarySizeLimit,s.themeID=e.themeID,s.userTrackingID=e.userTrackingID,s.artistsOwned=e.artistsOwned,s.primaryUserID=e.primaryUserID,s.primaryFName=e.primaryFName,s.TSModified=e.TSModified,s.SettingsFlags=e.SettingsFlags!==t?_.toInt(e.SettingsFlags):t,s.PlayerFlags=e.PlayerFlags!==t?_.toInt(e.PlayerFlags):t,s.NotificationFlags=e.NotificationFlags!=null?_.toInt(e.NotificationFlags):t,s.PrivacyFlags=e.PrivacyFlags!==t?_.toInt(e.PrivacyFlags):t,s.Locale=e.Locale,s.isArtist=(s.Flags&n.Models.User.FLAG_ARTIST_PROFILE)>0,s.chatUserData=e.chatUserData,s.chatUserDataSig=e.chatUserDataSig,s.chatUserDataSigExpires=Date.now()+ot,s.PlayerFlags===0&&(s.PlayerFlags|=ut.DEFAULT_PLAYER_SETTINGS),s.Context={type:"user",artist:{}},s},initialize:function(e,t){n.Models.User.prototype.initialize.call(this,e,t),this.set("_noCache",!1),n.Models.AuthUser.cache(this);if(this.get("isLoggedIn")){_.defer(_.bind(this.loadUserInfo,this));var r=0,i=!1,s=!1,o=this.get("UserID");this.get("Flags")&n.Models.User.FLAG_ANYWHERE?r=8:this.get("Flags")&n.Models.User.FLAG_PLUS&&this.get("IsPremium")?r=6:this.get("Flags")&n.Models.User.FLAG_LITE?r=21:this.get("IsPremium")?r=8:i=!0,this.get("Flags")&n.Models.User.FLAG_HAS_SPECIAL_PRICE&&(s=!0),rt=new u({SubscriptionTypeID:r,isLoaded:i,hasSpecialPricing:s,user:this}),n.Models.User.getUserStatusDfds[o]||(n.Models.User.getUserStatusDfds[o]=$.Deferred())}else rt=new u({isLoaded:!0,user:this}),this.getUserMiscData();this.defineProperty("subscription",{get:function(){return rt},configurable:!1}),this.defineProperty("listenLimit",{get:function(){return 3},configurable:!1}),this.setLocalSettings();var a=n.Services.Twitter.SERVICE_ID|n.Services.Twitter.TWITTER_ONLY_SERVICE_ID|n.Services.Google.SERVICE_ID|n.Services.Google.GOOGLE_ONLY_SERVICE_ID|n.Services.Facebook.SERVICE_ID|n.Services.Facebook.FACEBOOK_ONLY_SERVICE_ID|n.Services.Flattr.SERVICE_ID|n.Services.Lastfm.SERVICE_ID,f=!1;this.get("isLoggedIn")&&(this.get("Flags")&a)>0&&(f=!0),this.set("hasExtraData",f),this.get("IsPremium")||(W.call(this),X.call(this)),this.unset("shouldSyncUserContent"),Y=[],n.on("manatee:selfMasterStatus",F,this),n.on("manatee:connected",I,this),n.on("player:songCompleted",q,this),n.Services.Local.set("visitCount."+this.id,(n.Services.Local.get("visitCount."+this.id)||0)+1)},updateFromNew:function(e,t){return delete e.IsPremium,n.Models.User.prototype.updateFromNew.call(this,e,t)},loadUserInfo:function(){this.getPageNameData(),this.getLibrarySongIDs(),this.getFavoriteSongsSongIDs(),this.getFavoritesByType("Playlists"),this.getFavoritesByType("Artists"),this.getFriends(),this.getUserMiscData();var e=this.getOwnedArtists(),t=[n.Services.Manatee.chatReady,n.ready],i=this.get("UserID"),s=n.Models.User.getUserStatusDfds[i];_.delay(_.bind(this.getExtraData,this),5e3),$.after(t).done(_.bind(function(){this.getCurrentStatus(!0).done(function(t){s&&s.resolve(t);if(!t)return;var i=_.clone(t);i.broadcastID=i.bcast,i.broadcastName=i.bcastName,i.bannedUserIDsArray=[];if(i&&i.broadcastID&&i.bcastOwner){var o=_.bind(function(){var e=r.page.getCurrentPageView();i.remora&&e&&n.Views.Pages.User&&_.isInstance(e,n.Views.Pages.User)&&e.broadcastView&&e.model.get("user")===this?n.Models.Broadcast.fetchRealtimeBroadcast(i.broadcastID).done(_.bind(this.resumeBroadcast,this)).fail(function(){i.alreadyTried=!0,n.trigger("lightbox:open","broadcastResume",i)}):n.trigger("lightbox:open","broadcastResume",i)},this);e.done(o)}}),this.getLeapLib()},this)).fail(function(e){s&&s.reject(e)})},setLocalSettings:function(){var e=this.attributes.SettingsFlags,t=this.attributes.PlayerFlags,r=this.get("UserID"),i=!1,s=null,o=null,u=R(r),a,f,l,c,h;e==null&&(h=0,n.Services.Local.get("player.restoreQueue")&&(h|=ut.APP_SETTING_RESTORE_QUEUE),f=n.Services.Local.get("player.persistShuffle"+r),f!=null&&!f&&(h|=ut.APP_SETTING_CLEAR_PLAYER_SETTINGS),n.Services.Local.get("player.lowerQuality"+r)&&(h|=ut.APP_SETTING_LOWER_QUALITY),(n.Services.Local.get("user.themeFlags"+r)&1)==1&&(h|=ut.APP_SETTING_FAMILY_FRIENDLY),n.Services.Local.get("user.disablePlayerShortcuts"+r)&&(h|=ut.APP_SETTING_DISABLE_PLAYER_SHORTCUTS),l=n.Services.Local.get("broadcast.chat.joinLeftDisabled"+r),l!=null&&!l&&(h|=ut.APP_SETTING_CHAT_SHOW_JOIN_LEAVE),n.Services.Local.get("broadcast.chat.nowPlayingDisabled"+r)&&(h|=ut.APP_SETTING_CHAT_HIDE_NOW_PLAYING),n.Services.Local.get("broadcast.chat.suggestionsDisabled"+r)&&(h|=ut.APP_SETTING_CHAT_HIDE_SUGGESTIONS),n.Services.Local.get("chat.ignoreChatTag"+r)&&(h|=ut.APP_SETTING_CHAT_HIDE_MY_TAG),n.Services.Local.get("user.enableBrowserNotifications"+r)&&(h|=ut.APP_SETTING_ENABLE_BROWSER_NOTIFS),n.Services.Local.get("broadcast.autoApprove"+r)&&(h|=ut.APP_SETTING_BROADCAST_AUTO_APPROVE),e=s=h,i=!0),u.local.restoreQueue=(e&ut.APP_SETTING_RESTORE_QUEUE)>0,u.local.clearPlayerSettings=(e&ut.APP_SETTING_CLEAR_PLAYER_SETTINGS)>0,u.local.lowerQuality=(e&ut.APP_SETTING_LOWER_QUALITY)>0,u.local.disablePlayerShortcuts=(e&ut.APP_SETTING_DISABLE_PLAYER_SHORTCUTS)>0,(e&ut.APP_SETTING_FAMILY_FRIENDLY)>0&&(u.local.themeFlags=(u.local.themeFlags||0)|1),u.local.joinLeftDisabled=(e&ut.APP_SETTING_CHAT_SHOW_JOIN_LEAVE)==0,u.local.nowPlayingDisabled=(e&ut.APP_SETTING_CHAT_HIDE_NOW_PLAYING)>0,u.local.suggestionsDisabled=(e&ut.APP_SETTING_CHAT_HIDE_SUGGESTIONS)>0,u.local.ignoreChatTag=(e&ut.APP_SETTING_CHAT_HIDE_MY_TAG)>0,u.local.enableBrowserNotifications=(e&ut.APP_SETTING_ENABLE_BROWSER_NOTIFS)>0,t==null&&(h=0,n.Services.Local.get("player.crossfadeEnabled"+r)&&(h|=ut.PLAYER_SETTING_CROSSFADE_ENABLED),n.Services.Local.get("player.playPauseFade"+r)&&(h|=ut.PLAYER_SETTING_PLAY_PAUSE_FADE),a=n.Services.Local.get("player.crossfadeAmount"+r)/1e3,a||(a=ut.DEFAULT_CROSSFADE_AMOUNT/1e3),a&&ut["PLAYER_SETTING_CROSSFADE_SECS_"+a]&&(h|=ut["PLAYER_SETTING_CROSSFADE_SECS_"+a]),t=o=h,i=!0),u.local.playPauseFade=(t&ut.PLAYER_SETTING_PLAY_PAUSE_FADE)>0,c=n.Services.Local.get("player.crossfadeEnabled"+r);if(c||(t&ut.PLAYER_SETTING_CROSSFADE_ENABLED)>0)u.local.crossfadeEnabled=1;u.local.crossfadeAmount=0;for(var p=3;p<=6;p++)(t&ut["PLAYER_SETTING_CROSSFADE_SECS_"+p])>0&&(u.local.crossfadeAmount+=p*1e3);u.local.crossfadeAmount||(u.local.crossfadeAmount=ut.DEFAULT_CROSSFADE_AMOUNT),u.local.shuffleEnabled=(t&ut.PLAYER_SETTING_SHUFFLE_ENABLED)>0,this.set("settings",u);if(i&&r>0){if(s==this.get("SettingsFlags")&&o==this.get("PlayerFlags"))return;setTimeout(function(){n.Services.API.changeUserPreferences(s,o).done(function(e){if(!e)return;n.Services.Local.remove("user.tooltips"+r),n.Services.Local.remove("user.persistPinboard"+r),n.Services.Local.remove("broadcast.recent"+r),n.Services.Local.remove("civicscience.optOut"),e.appSettings&&(n.Services.Local.remove("player.restoreQueue"),n.Services.Local.remove("player.persistShuffle"+r),n.Services.Local.remove("player.lastShuffle"+r),n.Services.Local.remove("player.lowerQuality"+r),n.Services.Local.remove("user.themeFlags"+r),n.Services.Local.remove("player.noPrefetch"+r),n.Services.Local.remove("user.disablePlayerShortcuts"+r),n.Services.Local.remove("user.enableBrowserNotifications"+r),n.Services.Local.remove("user.broadcast.autoApprove"+r)),e.playerSettings&&(n.Services.Local.get("player.playPauseFade"+r),n.Services.Local.get("player.crossfadeAmount"+r),n.Services.Local.get("player.crossfadeEnabled"+r)),e.chatSettings&&(n.Services.Local.remove("broadcast.chat.joinLeftDisabled"+r),n.Services.Local.remove("broadcast.chat.nowPlayingDisabled"+r),n.Services.Local.remove("broadcast.chat.suggestionsDisabled"+r),n.Services.Local.remove("chat.ignoreChatTag"+r))})},5e3)}},updatePicture:function(e){var t=Date.now(),n={};n.chatUserData=null,n.chatUserDataSig=null,n.Picture=e+"?"+t,this.set(n)},getOwnedArtists:function(e){if(!e&&this.loadOwnedArtistsDfd&&this.loadOwnedArtistsDfd.state()!=="rejected")return this.loadOwnedArtistsDfd.promise();var t=$.Deferred(),r=this.get("Flags")&n.Models.User.FLAG_ARTIST_CLAIMED||this.get("Flags")&n.Models.User.FLAG_ARTIST_PROFILE;return!e&&typeof this.get("artistsOwned")!="undefined"?t.resolve(this.get("artistsOwned")):this.get("isLoggedIn")&&(r||this.get("primaryUserID"))?(n.Services.API.userGetArtistsOwned().done(_.bind(i,this,t)).fail(_.bind(i,this,t,null)),this.loadOwnedArtistsDfd=t):i.call(this,t,[]),t.promise()},getClaimHistory:function(e){if(!e&&this.loadClaimHistoryDfd&&this.loadClaimHistoryDfd.state()!=="rejected")return this.loadClaimHistoryDfd.promise();var t=$.Deferred();return!e&&typeof this.get("claimHistory")!="undefined"?t.resolve(this.get("claimHistory")):this.get("isLoggedIn")?(n.Services.API.getClaimHistory().done(_.bind(j,this,t)).fail(_.bind(j,this,t,[])),this.loadClaimHistoryDfd=t):j.call(this,t,[]),t.promise()},hasTwitterDataStored:function(){return this.get("Flags")&n.Services.Twitter.SERVICE_ID||this.get("Flags")&this.TWITTER_ONLY_SERVICE_ID},hasGoogleDataStored:function(){return this.get("Flags")&n.Services.Google.SERVICE_ID||this.get("Flags")&this.GOOGLE_ONLY_SERVICE_ID},hasLastfmDataStored:function(){return this.get("Flags")&n.Services.Lastfm.SERVICE_ID},hasFlattrDataStored:function(){return this.get("Flags")&n.Services.Flattr.SERVICE_ID},getExtraData:function(){if(this.loadExtraDataDfd&&this.loadExtraDataDfd.state()==="pending")return this.loadExtraDataDfd.promise();var e=$.Deferred();return typeof this.get("extraData")!="undefined"?e.resolve(this.get("extraData")):this.get("hasExtraData")?(n.Services.API.userGetExtraData().done(_.bind(s,this,e)).fail(_.bind(s,this,e,null)),this.loadExtraDataDfd=e):e.resolve(null),e.promise()},getPageNameData:function(e){if(this.loadUserPageNameDataDfd&&this.loadUserPageNameDataDfd.state()==="pending")return this.loadUserPageNameDataDfd.promise();var t=$.Deferred();return typeof this.get("pageNameData")!="undefined"&&!e?t.resolve(this.get("pageNameData")):this.get("isLoggedIn")?(n.Services.API.getPageInfoByIDType(this.get("UserID"),"user",e).done(_.bind(o,this,t)).fail(_.bind(o,this,t,null)),this.loadUserPageNameDataDfd=t):o.call(this,t,null),t.promise()},setPageNameData:function(e){if(this.get("pageNameData")&&(!e||e.source!=="user"))return;n.Models.User.prototype.setPageNameData.call(this,e)},getUserBroadcastInvites:function(){if(this.loadUserBroadcastInvitesDfd&&this.loadUserBroadcastInvitesDfd.state()==="pending")return this.loadUserBroadcastInvitesDfd.promise();var e=$.Deferred();return typeof this.get("broadcastInvites")!="undefined"?e.resolve(this.get("broadcastInvites")):this.get("isLoggedIn")?(n.Services.API.getPastBroadcastInvites().done(_.bind(l,this,e)).fail(_.bind(l,this,e)),this.loadUserBroadcastInvitesDfd=e):l.call(this,e,null),e.promise()},changeUserInfo:function(e,t){var i=$.Deferred(),s={},o={},u=t&&t.password,a=t&&t.thirdPartyLogin,f=t&&t.regAuthToken,l=!1,h;for(var p in e)if(e.hasOwnProperty(p)){h=this.get(p);if(!e[p]&&!h)continue;!e[p]&&p!=="PathName"&&(e[p]=null);if(e[p]!==h){if(p==="TSDOB"&&e[p]===null&&h=="0000-00-00")continue;s[p]=e[p],o[p]=h,l=!0}}var d=this.get("LName");d&&d.length&&(_.isUndefined(s.FName)&&(s.FName=this.get("Name"),o.FName=this.get("FName")),s.LName="",o.LName=this.get("LName"),l=!0);if(!l)i.resolve({statusCode:1,nothingChanged:!0});else{var v=$.extend({},s);v.hasOwnProperty("PathName")&&(v.PageName=v.PathName,delete v.PathName);if(v.PageName||v.Email){var m=this.get("Flags"),g=(m&n.Models.User.FLAG_ARTIST_PROFILE)!=0&&(m&n.Models.User.FLAG_ARTIST_CLAIMED)==0,y=r.model.get("appToken"),b;if(!u&&!a&&((m&n.Models.User.FLAG_GOOGLEUSER)>0||(m&n.Models.User.FLAG_TWITTERUSER)>0)){a={};var w=this;return m&n.Models.User.FLAG_GOOGLEUSER?n.Services.Google.loginWithGooglePlus(y).done(function(e){b=n.Services.Google.getProfile(y),a.type="google",a.googleEmailAddress=b.email,a.googleUID=b.id,a.accessToken=e.accessToken,n.Services.API.changeUserInfoEx(v,u,f,a,o,_.bind(c,w,i,s),function(e){i.reject(e)})}).fail(function(){i.reject({statusCode:-15})}):n.Services.Twitter.login(y).done(function(e){a.type="twitter",a.twitterUserID=e.id_str,a.oauthToken=e.oauthToken,a.oauthSecret=e.oauthSecret,n.Services.API.changeUserInfoEx(v,u,f,a,o,_.bind(c,w,i,s),function(e){i.reject(e)})}).fail(function(){i.reject({statusCode:-15})}),i.promise()}if(!u&&!f&&!a&&!g)return i.reject({statusCode:-7}),i.promise()}n.Services.API.changeUserInfoEx(v,u,f,a,o,_.bind(c,this,i,s),function(e){i.reject(e)})}return i.promise()},updateProfileURLs:function(e,r,i){var s=!0,o=this.get("pageNameData"),u=new $.Deferred,f,l,c;if(!e)s=!0;else if(!o||i)s=!1;else{f=_.extend({},o.URLs);if(!f&&e)s=!1;else if(e){for(l in e)if(e.hasOwnProperty(l)&&(!f.hasOwnProperty(l)||e[l]!==f[l])){s=!1;break}for(l in f)f.hasOwnProperty(l)&&!e.hasOwnProperty(l)&&(e[l]=f[l]||t)}}if(s&&r&&!i)if(!o.URLsOrder)s=!1;else for(l=0,c=r.length;l<r.length;l++)if(o.URLsOrder[l]!==r[l]){s=!1;break}return s?u.resolve(this.get("pageNameData")):n.Services.API.updateUserProfileURLs(e,r).done(_.bind(a,this,u,e)).fail(_.bind(u.reject,u)),u.promise()},storeUserPageCardArragement:function(e,t){n.Services.API.storeUserPageCardArragement(e,t).fail(function(){n.trigger("notification:add",{description:_.getString("CARD_ARRANGEMENT_ERROR"),type:"error",duration:5e3})})},changePassword:function(e,t){var r=$.Deferred();return!e||e.length<5||e.length>32?r.reject({statusCode:-2}).promise():(n.Services.API.changePassword(e,t).done(function(e){e&&e.statusCode==1?r.resolve(e):r.reject(e)}).fail(_.bind(r.reject,r)),r.promise())},getLibraryTSModified:function(){if(this.libraryTSModifiedDfd&&this.libraryTSModifiedDfd.state()=="pending")return this.libraryTSModifiedDfd.promise();this.libraryTSModifiedDfd=$.Deferred();var e=this.get("libraryTSModified");return e?this.libraryTSModifiedDfd.resolve(e):this.get("isLoggedIn")?n.Services.API.userGetLibraryTSModified(this.id).done(_.bind(function(t){t?(e=t.TSModified||"0",this.set("libraryTSModified",e),this.libraryTSModifiedDfd.resolve(e)):this.libraryTSModifiedDfd.reject()},this)).fail(_.bind(this.libraryTSModifiedDfd.reject,this.libraryTSModifiedDfd)):(e="0",this.set("libraryTSModified",e),this.libraryTSModifiedDfd.resolve(e)),this.libraryTSModifiedDfd.promise()},getLibrary:function(e){e=_.orEqual(e,!1);if(this.loadAuthLibraryDfd&&this.loadAuthLibraryDfd.state()!=="rejected")return this.loadAuthLibraryDfd.promise();var t=new $.Deferred,r=this.get("library");if(r)t.resolve(r);else{var i=function(){var i=n.Services.Local.get("library"+this.id);i?this.getLibraryTSModified().done(_.bind(function(s){s>i.lastModified?f.call(this,e,t):(r=new n.Models.Collections.Songs(_.toArray(i.songs),{silent:!0,fromLibrary:!0}),this.set("library",r),t.resolve(r))},this)).fail(_.bind(function(){f.call(this,e,t)},this)):f.call(this,e,t),this.getFavoritesByType("Songs")};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(i,this)):i.call(this),this.loadAuthLibraryDfd=t}return t.promise()},getLibrarySongIDs:function(){function i(i,s){for(var o=0,u=i.length,a,f;o<u;o++)a=i[o],a&&t[a]!==1&&(t[a]=1,f=n.Models.Song.getCached(a),f&&f.set("fromLibrary",!0));r.set({librarySongsSongIDs:t,libraryTSModified:s,librarySongsCount:i.length}),e.resolve(t)}function s(){n.Services.API.userGetSongIDsInLibrary().done(function(t){if(!t||!t.SongIDs){e.reject();return}i(t.SongIDs,t.TSModified),r.storeLibrary()}).fail(_.bind(e.reject,e))}function o(){var t=r.get("library");if(t){i(t.pluck("SongID"),r.get("TSModified")),r.storeLibrary();return}var o=n.Services.Local.get("librarySongIDs"+r.id);if(!o){s();return}r.getLibraryTSModified().done(function(t){s();return}).fail(s)}if(this.loadAuthLibrarySongIDsDfd&&this.loadAuthLibrarySongIDsDfd.state()!=="rejected")return this.loadAuthLibrarySongIDsDfd.promise();var e=new $.Deferred,t=this.get("librarySongsSongIDs"),r=this;return t?(e.resolve(t),e.promise()):this.get("isLoggedIn")?(t={},this.get("oldUserClean")?this.get("oldUserClean").done(o):o(),this.loadAuthLibrarySongIDsDfd=e,e.promise()):(t={},this.set({librarySongsSongIDs:t,librarySongsCount:0}),e.resolve(t),e.promise())},storeLibrary:function(){var e=this.get("library"),t=this.get("librarySongsSongIDs"),r=this.get("libraryTSModified"),i=this.get("librarySongsCount")||0,s;e&&(s={lastModified:r,songs:{}},t||(t={},i=e.length),e.each(function(e){s.songs[e.id]=e.archiveAttr(),t[e.id]=1}),n.Services.Local.set("library"+this.id,s)),t&&(s={lastModified:r,count:i,songIDs:t},n.Services.Local.set("librarySongIDs"+this.id,s))},refreshLibrary:function(){var e=this.get("libraryTSModified"),t=this.get("library");this.unset("libraryTSModified",{silent:!0}),this.unset("library",{silent:!0}),this.hasOwnProperty("loadAuthLibraryDfd")&&delete this.loadAuthLibraryDfd,this.hasOwnProperty("libraryDfd")&&delete this.libraryDfd,this.getLibrary(!0).fail(_.bind(function(){this.set({libraryTSModified:e,library:t},{silent:!0})},this))},getFavoriteSongsSongIDs:function(){function s(s){var o=i.get("librarySongsSongIDs"),u=i.get("librarySongsCount");for(var a=0,f=s.length,l,c;a<f;a++)l=s[a],l&&r[l]!==1&&(r[l]=1,c=n.Models.Song.getCached(l),c&&c.set({isFavorite:!0,fromLibrary:!0}),o!==t&&o[l]!==1&&(o[l]=1,u++));i.set({favoriteSongsSongIDs:r,favoriteSongsCount:s.length,librarySongsCount:u}),e.resolve(r)}function o(){var t=i.get("favoriteSongs");if(t)s(t.pluck("SongID"));else{var r=new ChainLoading;r.push(i.getLibrarySongIDs()),r.push(n.Services.API.userGetFavoriteSongsSongIDs().done(r.bind(function(t){if(!t){e.reject();return}s(t)})).fail(r.bind(e.reject,e)))}}if(this.favoriteSongIDsDfd&&this.favoriteSongIDsDfd.state()!=="rejected")return this.favoriteSongIDsDfd.promise();var e=this.favoriteSongIDsDfd=$.Deferred(),r=this.get("favoriteSongsSongIDs"),i=this;return r?(e.resolve(r),e.promise()):this.get("isLoggedIn")?(r={},this.get("oldUserClean")?this.get("oldUserClean").done(o):o(),e.promise()):(r={},this.set({favoriteSongsSongIDs:r,favoriteSongsCount:0}),e.resolve(r),e.promise())},getCallouts:function(){if(this.loadCalloutsDfd)return this.loadCalloutsDfd.promise();var e=$.Deferred(),t=this.get("callouts");return t?e.resolve(t):n.Services.API.getUserCallouts(this.id).done(_.bind(J,this,e)).fail(_.bind(K,this,e)),this.loadCalloutsDfd=e,e.promise()},deleteCallout:function(e){if(!e)return;n.Services.API.deleteCallout(e.id).done(_.bind(function(){var t=this.get("callouts");t&&t.remove(e),e.constructor.uncache(e.id)},this)).fail(function(){n.trigger("notification:add",{description:_.getString("PROBLEM_DELETING_CALLOUT"),type:"error",duration:5e3})})},gotNewSubscription:function(e,t){if(!e){var r=this.get("Flags");r|=n.Models.User.FLAG_HAS_NEW_SUB,this.set("Flags",r)}return this.loadSubscription(!0,t)},loadSubscription:function(e,t){return w(this,e,t)},getIsPremium:function(){return this.get("subscription").isPremium()},createPlaylist:function(e,t,r,i){var s=new $.Deferred,o=[],u=[],a,f,l;if(t&&t.length)for(l=0;l<t.length;l++){a=t[l],a=a._wrapped||a;if(!(a&&a instanceof Backbone.Model&&!isNaN(a.get("SongID")))){gsConfig.runMode!="production"&&console.warn("Tried to add song to playlist that but didn't pass a song model!",a);continue}f=a.get("SongID"),n.Models.Song.getCached(f)||n.Models.Song.cache(a,{notifyCache:!0}),o.push(a.toJSON()),u.push(f)}return this.get("isLoggedIn")?n.Services.API.createPlaylist(e,u,r,i).done(_.bind(N,this,s,e,o,r,i)).fail(_.bind(C,this,s)):s.reject({error:"Not logged in"}),s.promise()},addSongsToLibrary:function(e,t){var r=new $.Deferred,i=[],s=[],o=this.get("librarySizeLimit"),u=this.get("librarySongsCount"),a,f,l;for(a=0,f=e.length;a<f;a++){l=e[a],l=l._wrapped||l;if(l.get("SongID")===0)continue;l.get("fromLibrary")||(n.Models.Song.getCached(l.id)||n.Models.Song.cache(l),i.push(l),s.push(l.getDetailsForFeeds()))}if(!i.length)return r.resolve([]),r.promise();if(this.get("isLoggedIn")){var c=u+i.length,d=this.get("IsPremium"),v=d?"NOTICE_MAX_SONGS_VIP_TITLE":"NOTICE_MAX_COLLECTION_TITLE",m=d?"NOTICE_MAX_COLLECTION_VIP":"NOTICE_MAX_COLLECTION",g=d?"":"/#!/upgrade";c>o?i.length==1?n.trigger("notification:add",{title:_.getString(v),description:_.getString(m)+" "+_.getString("NOTICE_MAX_NOT_SAVED"),type:"error",url:g}):n.trigger("notification:add",{title:_.getString(v),description:_.getString(m)+" "+_.getString("NOTICE_MAX_MULTI_NOT_SAVED"),type:"error",url:g}):(n.Services.API.userAddSongsToLibrary(s).done(_.bind(h,this,r,i)).fail(_.bind(p,this,r,i)),c==o&&n.trigger("notification:add",{title:_.getString(v),description:_.getString(m),type:"error",url:g}))}else n.Models.AuthUser.openRequireLoginTooltip("LB_LOGIN_MUST_LOGIN_TO_ADD_LIBRARY",function(e){e.getLibrary().done(function(){n.Services.API.userAddSongsToLibrary(s).done(_.bind(h,e,r,i)).fail(_.bind(p,e,r,i))})},t);return r.promise()},removeSongsFromLibrary:function(e){var t=new $.Deferred,r=[],i=[],s=[],o=[],u=[],a,f,l;for(a=0;a<e.length;a++)f=e[a],f=f._wrapped||f,l=f.get("SongID"),f.get("fromLibrary")&&(r.push(f),s.push(l),o.push(f.get("AlbumID")),u.push(f.get("ArtistID"))),f.get("isFavorite")&&i.push(f);for(a=0;a<i.length;a++)n.Services.API.unfavorite("Song",i[a].id).done(_.bind(this.localRemoveSongsFromFavorites,this,[i[a]]));return r.length?(this.get("isLoggedIn")?n.Services.API.userRemoveSongsFromLibrary(this.id,s,o,u).done(_.bind(d,this,t,r)).fail(_.bind(v,this,t,r)):t.reject(),t.promise()):(t.resolve([]),t.promise())},localAddSongsToLibrary:function(e,t){var n=this.get("librarySongsSongIDs"),r=this.get("librarySongsCount");for(var i=0,s=e.length;i<s;i++){if(n){if(n[e[i].id]===1)continue;n[e[i].id]=1,r++}e[i].set({TSAdded:t,fromLibrary:!0})}var o=this.get("library");o&&o.add(e),(n||o)&&this.set("librarySongsCount",o?o.length:r)},localAddSongsToFavorites:function(e,t){var n=this.get("favoriteSongsSongIDs"),r=this.get("favoriteSongsCount");for(var i=0,s=e.length;i<s;i++)n&&n[e[i].id]!==1&&(n[e[i].id]=1,r++),e[i].set({TSFavorite:t,isFavorite:!0});var o=this.get("favoriteSongs");o&&o.add(e),(n||o)&&this.set("librarySongsCount",o?o.length:r),this.localAddSongsToLibrary(e,t)},localRemoveSongsFromLibrary:function(e){var n=this.get("library");n&&n.remove(e);var r=this.get("librarySongsSongIDs"),i=this.get("librarySongsCount");for(var s=0,o=e.length;s<o;s++)r&&r[e[s].id]&&(r[e[s].id]=t,i--),e[s].set({TSAdded:t,TSFavorite:t,fromLibrary:!1,isFavorite:!1});(r||n)&&this.set("librarySongsCount",n?n.length:i)},localRemoveSongsFromFavorites:function(e){var n=this.get("favoriteSongs");n&&n.remove(e);var r=this.get("favoriteSongsSongIDs"),i=this.get("favoriteSongsCount");for(var s=0,o=e.length;s<o;s++)r&&r[e[s].id]&&(r[e[s].id]=t,i--),e[s].set({TSFavorite:t,isFavorite:!1});(r||n)&&this.set("favoriteSongsCount",n?n.length:i)},favorite:function(e,t,r){var i=new $.Deferred,s=e.substr(0,e.length-1),o=n.Models[s],t=t._wrapped||t,u=t.id,a=_.orEqual(r,{});if(!o)return i.reject("Invalid type"),i.promise();if(!t)return i.reject("Invalid item"),i.promise();if(!u)return i.reject("Invalid itemID"),i.promise();if(this.get("isLoggedIn")){var f,l,c,h=this.get("IsPremium"),p=e.toUpperCase(),d=this.get("favorite"+e),v=d?d.length:0;h?f=5e3:f=500,l=h?["NOTICE_MAX_",p,"_VIP_TITLE"].join(""):["NOTICE_MAX_",p,"_TITLE"].join(""),c=h?["NOTICE_MAX_",p,"_VIP"].join(""):["NOTICE_MAX_",p].join("");if(v>=f){n.trigger("notification:add",{title:_.getString(l),description:_.getString(c)+" "+_.getString("NOTICE_MAX_NOT_SAVED"),type:"error",url:"/#!/upgrade"});return}v>=f-1&&n.trigger("notification:add",{title:_.getString(l),description:_.getString(c),type:"error",url:"/#!/upgrade"});if(e==="Broadcasts"){if(!t||!t.get("Name")||!t.get("UserID")&&!t.get("ArtistID"))return i.reject(),i.promise();n.Services.API.favoriteBroadcast(u,t.get("Name"),t.get("UserID"),t.get("ArtistID")).done(_.bind(m,this,i,e,t)).fail(_.bind(g,this,i,e,t))}else n.Services.API.favorite(s,u,t.getDetailsForFeeds()).done(_.bind(m,this,i,e,t)).fail(_.bind(g,this,i,e,t))}else{var y;switch(e){case"Users":y="LB_LOGIN_MUST_LOGIN_TO_FOLLOW_USER";break;case"Songs":y="LB_LOGIN_MUST_LOGIN_TO_FAV_SONG";break;case"Playlists":y="LB_LOGIN_MUST_LOGIN_TO_SUBSCRIBE_PLAYLIST";break;case"Artists":y="LB_LOGIN_MUST_LOGIN_TO_FOLLOW_ARTIST";break;case"Broadcasts":y="LB_LOGIN_MUST_LOGIN_TO_FAV_BROADCAST"}n.Models.AuthUser.openRequireLoginTooltip(y,function(r){r.getFavoritesByType(e).done(function(){n.Services.API.favorite(s,u,t.getDetailsForFeeds()).done(_.bind(m,r,i,e,t)).fail(_.bind(g,r,i,e,t))})},a)}return i.promise()},unfavorite:function(e,t){var r=new $.Deferred,i=e.substr(0,e.length-1),s=n.Models[i],t=t._wrapped||t,o=t.id;return s?t?o?(this.get("isLoggedIn")?(i||"").toLowerCase()==="broadcast"?n.Services.API.unfavoriteBroadcast(o).done(_.bind(y,this,r,e,t)).fail(_.bind(b,this,r,e,t)):n.Services.API.unfavorite(i,o).done(_.bind(y,this,r,e,t)).fail(_.bind(b,this,r,e,t)):r.reject("log in plz"),r.promise()):(r.reject("Invalid itemID"),r.promise()):(r.reject("Invalid item"),r.promise()):(r.reject("Invalid type"),r.promise())},handleUserContentSync:function(e){for(var t=0,n=e.length;t<n;t++)switch(e[t].type){case"favoriteChange":e[t].params.added?this.handleSyncedFavorites(e[t].params.type,e[t].params.items):this.handleSyncedUnfavorites(e[t].params.type,e[t].params.items);break;case"playlistChange":e[t].params.action=="create"?this.handleSyncedPlaylistCreated(e[t].params.items):e[t].params.action=="delete"?this.handleSyncedPlaylistDeleted(e[t].params.items):e[t].params.action=="rename"&&this.handleSyncedPlaylistRenamed(e[t].params.items);break;case"playlistSongsChange":this.handleSyncedPlaylistSongsChange(e[t].params.items);break;case"libraryChange":e[t].params.added?this.handleSyncedLibraryAdds(e[t].params.items,e[t].params.TSAdded):this.handleSyncedLibraryRemoves(e[t].params.items)}},handleSyncedUnfavorites:function(e,t){var r=n.Models[e.substr(0,e.length-1)],i,s,o;for(s=0,o=t.length;s<o;s++)t[s].item?e=="Songs"?i=r.newOrUpdate(r.convertManateeSongCalloutProperties(t[s].item)):i=r.newOrUpdate(r.convertManateeProperties(t[s].item)):i=r.getCached(t[s].id),i&&y.call(this,null,e,i,!0)},handleSyncedFavorites:function(e,t){var r=n.Models[e.substr(0,e.length-1)],i,s,o;for(s=0,o=t.length;s<o;s++)t[s].item?e=="Songs"?i=r.newOrUpdate(r.convertManateeSongCalloutProperties(t[s].item)):i=r.newOrUpdate(r.convertManateeProperties(t[s].item)):i=r.getCached(t[s].id),i&&m.call(this,null,e,i,!0)},handleSyncedPlaylistCreated:function(e){var t=this.get("playlists"),r,i,s,o;if(!t)return;for(i=0,s=e.length;i<s;i++)o=n.Models.Playlist.convertManateeProperties(e[i]),o.Username=this.get("Name"),r=n.Models.Playlist.newOrUpdate(o),r&&t.add(r)},handleSyncedPlaylistDeleted:function(e){var t=this.get("playlists"),r,i,s;if(!t){for(i=0,s=e.length;i<s;i++)r=n.Models.Playlist.getCached(e[i].pID),r&&r.uncache();return}for(i=0,s=e.length;i<s;i++)!n.Models.Playlist.getCached(e[i].pID)||(r=n.Models.Playlist.newOrUpdate(n.Models.Playlist.convertManateeProperties(e[i])),r&&k.call(this,r,null,null,!0))},handleSyncedPlaylistRenamed:function(e){var t,r,i,s;for(r=0,i=e.length;r<i;r++)!n.Models.Playlist.getCached(e[r].pID)||(s=n.Models.Playlist.convertManateeProperties(e[r]),t=n.Models.Playlist.newOrUpdate(s),t.set("PlaylistName",s.PlaylistName))},handleSyncedPlaylistSongsChange:function(e){var t,r,i;for(r=0,i=e.length;r<i;r++)t=n.Models.Playlist.getCached(e[r]),t&&t.clearSongs()},handleSyncedLibraryAdds:function(e,t){var r=[],i,s,o;for(s=0,o=e.length;s<o;s++)e[s].item?i=n.Models.Song.newOrUpdate(n.Models.Song.convertManateeSongCalloutProperties(e[s].item)):i=n.Models.Song.getCached(e[s].id),i&&r.push(i);h.call(this,null,r,{Timestamps:{newTSModified:t}})},handleSyncedLibraryRemoves:function(e){var t=[],r,i,s;for(i=0,s=e.length;i<s;i++)r=n.Models.Song.getCached(e[i].id),r&&t.push(r);d.call(this,null,t,!0)},syncUserContentChange:function(e,t,n){if(!t)return;this.libraryFavoritesToSync||(this.libraryFavoritesToSync=[]),this.libraryFavoritesToSync.push({type:e,params:t,groupKey:n}),G&&clearTimeout(G),G=setTimeout(_.bind(et,this),2e3)},getLastBroadcast:function(){if(this.lastBroadcastDfd&&this.lastBroadcastDfd.state()!=="rejected")return this.lastBroadcastDfd.promise();var e=$.Deferred();return this.lastBroadcastDfd=e,this.get("isLoggedIn")?n.Services.API.getUserLastBroadcast().done(_.bind(V,this,e)).fail(_.bind(e.reject,e)):e.resolve(null),e.promise()},clearLastBroadcast:function(){this.lastBroadcastDfd&&delete this.lastBroadcastDfd},storeBroadcastingLocally:function(e){e&&e.isLoggedInUserOwner()?n.Services.Local.set("lastBroadcasting"+this.id,{broadcastID:e.get("BroadcastID"),broadcastName:this.get("currentBroadcastName"),context:{type:"user",artistID:t},time:Date.now(),bannedUserIDsArray:_.keys(e.get("bannedUserIDs"))}):n.Services.Local.remove("lastBroadcasting"+this.id)},getBroadcastingLocally:function(){var e=n.Services.Local.get("lastBroadcasting"+this.id);return e&&e.time&&e.time+72e5<Date.now()&&(e=null),n.Services.Local.remove("lastBroadcasting"+this.id),e},createBroadcast:function(e,i,s,o,u){var a=u||{};if(this.creatingBroadcast)return;if(!this.get("isLoggedIn"))return;if(!a||!a.skipFlashCheck){this.preventChromeNonFlashBroadcast().done(_.bind(function(){var t=a||{};t.skipFlashCheck=!0,this.createBroadcast(e,i,s,o,t)},this)).fail(function(){amdModules.requireDeferred("gs/views/lightboxes/unableToBroadcast.js").done(function(){n.trigger("lightbox:open","unableToBroadcast")})});return}n.trigger("player:radio",!1);var f=this,l=function(){f.creatingBroadcast&&(clearTimeout(f.creatingBroadcast),f.creatingBroadcast=null)};this.creatingBroadcast=setTimeout(l,5e3),this.getLastBroadcast().always(_.bind(function(u){var f=a.isRandomName||!1;u instanceof n.Models.Broadcast||(u=null),e=_.orEqual(e,u&&!u.get("IsRandomName")?u.get("Name"):"")+"";if(!e){var c=["Street","Pizza","Trap","Crystal","Beat","Moon","Night","Summer","Dance","Lazer","Ice","Gold","Red","Blue","Hot","Orange","Turquoise","Pretty","Sapphire","Naughty","Weird","Cute","Feisty","Purple","Neon","Groovy","Funky","Tangerine","Awesome","Sparkle"],h=["Weasel","Meow","Wave","Bop","Pudding","Panda","Wolf","Buggy","Cake","Beach","Berry","Otter","Sloth","Donkey","Llama","Manatee","Bat","Hippo","Dog","Giraffe","Mouse","Cat","Ant","Lion","Elephant","Zebra","Rhino","Tiger","Flamingo","Candles","Soap","Balloons","Lake","Statues","Path","Hats","Party","Zoo"],p=["FM","Mixtape","Radio","Mix","Music"];e=[c[Math.floor(Math.random()*c.length)],h[Math.floor(Math.random()*h.length)],p[Math.floor(Math.random()*p.length)]].join(" "),f=!0}i=_.orEqual(i,u?u.get("Tag"):null),s=_.orEqual(s,u?u.get("Description"):"");if(o){var d=u?u.get("Image")||"":t,v=u?u.get("Privacy")||0:t,m=d?d.indexOf("?"):-1;m>-1&&(d=d.substring(0,m)),i&&i.i<1&&i.i!==0&&(i={i:0,n:"multi-genre"});var g={userID:this.id,name:e,isRandomName:f,description:s,image:d,privacy:v,tag:i,version:4,vipUsers:[],bannedUserIDs:a&&a.bannedUserIDsArray||[],attachType:"user",attachID:this.id,settings:{suggestionsEnabled:!0,chatEnabled:!0},clientVersion:n.Models.Broadcast.CLIENT_VERSION,country:n.Services.API.country};r.model.get("player").set({isCreatingBroadcast:g,isJoiningBroadcast:!1}),n.once("manatee:startBroadcast",function(){l(),r.model.get("player").set("isCreatingBroadcast",!1)}),n.Services.Manatee.chatReady.done(_.bind(function(){var e=r.model.get("manatee");e&&e.createBroadcast(g).done(_.bind(function(e){console.log("broadcast successfully created",e);var t=r.model.get("player").get("queue");e.remoraSetInitialSongsStatus(t),this.joinBroadcast(e,this,"create")},this)).fail(_.bind(function(e){n.trigger("manatee:startBroadcast",{success:!1,reason:e}),n.Services.Log.notify("Failed to create a broadcast","ERROR",{reason:e})},this))},this))}else n.trigger("lightbox:open","createBroadcast",{name:e,tag:i,description:s,isRandomName:f}),l()},this)),this.getFollowers().done(_.bind(function(){this.getUserBroadcastInvites().done(_.bind(this.updateBroadcastInviteableUsers,this))},this))},preventChromeNonFlashBroadcast:function(){return navigator.userAgent.match(/.*Chrome.*/)===null?$.Deferred().resolve().promise():_.getFlashObjectDfd("html5ShimSwf","makeHandle")},joinBroadcast:function(t,i,s,o,u){var a=t.id,f;o=o||$.Deferred(),f=o.promise();if(!t&&!i)return o.reject(1),f;var l=i||t.getOwner(),c=r.model.get("player"),h=c.get("queue"),p=h&&h.get("parasite");p instanceof n.Models.Broadcast||(p=null);if(!!l&&this!==l||s==="create"||s==="resume"){if(c.get("isJoiningBroadcast")==a)return o.reject(4),f;if(!u)return this.preventChromeNonFlashBroadcast().done(_.bind(function(){this.joinBroadcast(t,i,s,o,!0)},this)).fail(function(){amdModules.requireDeferred("gs/views/lightboxes/unableToBroadcast.js").done(function(){n.trigger("lightbox:open","unableToBroadcast")}),o.reject(5)}),f;if(p){if(p===t)return o.reject(4),f;this.leaveBroadcast(!1)}var d=_.bind(function(){c.set({isCreatingBroadcast:!1,isJoiningBroadcast:a}),t.monitor(),t.monitorChat();var i=t.subscribe();this.getFollowers().done(_.bind(function(){this.getUserBroadcastInvites().done(_.bind(this.updateBroadcastInviteableUsers,this))},this)),i.dfd.done(_.bind(function(t){c.set({isJoiningBroadcast:!1});var i=c.get("queue"),o=s==="create"||s==="resume",u;i.set({parasite:t,currentBroadcast:t,isBroadcasting:o},{source:s}),this.logBroadcastJoin(t),this.set("currentBroadcastID",a),_.defer(function(){var r=t.toUrl();e.location.hash.indexOf(r)<0&&n.router.setHash(r,{broadcast:t})}),o?n.trigger("guts:begincontext",{isBroadcasting:!0,autoplayID:a}):n.trigger("guts:startNewAutoplayContext","broadcast",a),n.trigger("manatee:startBroadcast",{success:!0,broadcast:t,created:o}),o&&s==="resume"&&(u=r.model.get("manatee"),t.sendToRemora({action:"takeover",uuid:u&&u.getPublicUID(),clientVersion:n.Models.Broadcast.CLIENT_VERSION,country:n.Services.API.country}))},this)).fail(function(){c.set({isJoiningBroadcast:!1}),n.trigger("manatee:startBroadcast",{success:!1})}),o.resolve()},this),v=function(){t.set({capacityLimitReached:!0});var e=t.getOwner();e&&e.storeCurrentBroadcast&&e.storeCurrentBroadcast(!0,t.get("BroadcastID"),t.get("Name"),t.get("Image"),e.attributes,!1,!1),n.router.setHash(t.toUrl())},m=t&&t.get("UserID")||i&&i.get("UserID"),g=t&&t.get("ArtistID")||i&&i.get("ArtistID"),y=m&&gsConfig.specialBroadcastUserID&&m==gsConfig.specialBroadcastUserID,b=g&&gsConfig.specialBroadcastArtistID&&g==gsConfig.specialBroadcastArtistID;if(t&&(y||b)){var w=t.getUpdatedListenersCount();return w.done(function(e){!gsConfig.specialBroadcastCap||e<gsConfig.specialBroadcastCap?d():v()}),w.fail(v),f}return d(),this.invitesDfd=this.getUserBroadcastInvites(),f}return o.reject(3),f},leaveBroadcast:function(e){var t=r.model.get("player"),i=t.get("queue"),s=i.get("currentBroadcast");if(!s)return;s.listenerLeft(this),s.cleanupOnEnd(s.get("ownerSubscribed")),s.unmonitor(),s.unmonitorChat(),s.unsubscribe(),s.unsubscribeFromChat(),t.set({isJoiningBroadcast:!1}),i.set({parasite:null,currentBroadcast:null,isBroadcasting:!1}),e||t.clearQueue(),this.set("currentBroadcastID",null),n.trigger("manatee:broadcastEnded",{success:!0,broadcastID:s.id}),n.trigger("guts:log","broadcastLeft",{broadcastID:s.id}),n.trigger("guts:endcontext","isBroadcasting"),n.trigger("guts:clearAllAutoplayContexts")},resumeBroadcast:function(e,t){var i=$.Deferred();if(!e)return i.reject(),i.promise();var s=this;return n.Services.Manatee.chatReady.done(function(){var t=r.model.get("manatee");if(s.creatingBroadcast||!t)return;var o=function(){s.creatingBroadcast&&(clearTimeout(s.creatingBroadcast),s.creatingBroadcast=null)};s.creatingBroadcast=setTimeout(o,5e3),n.trigger("player:radio",!1),r.model.get("player").set({isCreatingBroadcast:e.attributes,isJoiningBroadcast:!1}),e.getFullQueue().done(function(t,o){var u=r.model.get("player").get("queue"),a=u&&u.resetSongsFromRemoraFullQueue(o);if(!a){n.trigger("notification:add",{description:_.getString("BCAST_QUEUE_FAILED_CONSECTUTIVELY"),type:"error",duration:1e4});return}s.joinBroadcast(e,s,"resume").done(_.bind(i.resolve,i)).fail(_.bind(i.reject,i)),s.getFollowers().done(function(){s.getUserBroadcastInvites().done(_.bind(s.updateBroadcastInviteableUsers,s))})}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_TAKE_OVER_FAILED"),type:"error",duration:5e3})})}),i.promise()},cleanUpOnLogout:function(e){this.stopListening(),n.off("manatee:selfMasterStatus",null,this),n.off("manatee:connected",null,this);var t=new $.Deferred,r=this;this.id>0&&this.storeLibrary();var i=function(e,t){var s=e.splice(0,1e3),o=s.length,u;for(var a=0;a<o;a++)u=s[a],u instanceof n.Models.Song?u.set({isFavorite:!1,fromLibrary:!1}):u instanceof n.Models.User?u.set({isFavorite:!1,isFollower:!1,canBroadcastInvite:!0,broadcastInviteTime:0,canBroadcastInviteEmail:!0,broadcastInviteTimeEmail:0}):u.set({isFavorite:!1});e.length?_.defer(i,e,t):(n.Models.AuthUser.uncache(r),n.Services.API.getPageInfoByIDType(r.id,"user",!1,{uncache:!0}),t.resolve())},s=this.get("library")?this.get("library").models:null,o=this.get("favoriteUsers")?this.get("favoriteUsers").models:[],u=this.get("favoriteArtists")?this.get("favoriteArtists").models:[],a=this.get("favoritePlaylists")?this.get("favoritePlaylists").models:[],f=this.get("followers")?this.get("followers").models:[],l=this.get("favoriteBroadcasts")?this.get("favoriteBroadcasts").models:[],c=this.get("librarySongsSongIDs")||{},h;return n.trigger("tophat:close"),s||(s=[],_.each(c,function(e,t){h=n.Models.Song.getCached(t),h&&s.push(h)})),_.defer(i,s.concat(o,u,a,f,l),t),Y=[],t.promise()},getFollowers:function(e){if(this.followersDfd&&this.followersDfd.state()!=="rejected")return this.followersDfd.promise();var t=$.Deferred(),r=this.get("followers"),i=this;if(r)t.resolve(r);else{if(!!this.get("favoriteUsers"))return n.Models.User.prototype.getFollowers.call(this,e);var s=function(){this.id<=0?(r=new n.Models.Collections.Users,this.set({followers:r}),t.resolve(r)):this.get("favoriteUsers")||this.getFollowersFollowingFriends().done(function(){t.resolve(i.get("followers"))}).fail(_.bind(function(r){if(!r){t.reject();return}this.followersDfd=null,n.Models.User.prototype.getFollowers.call(this,e,t)},this))};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(s,this)):s.call(this),this.followersDfd=t}return t.promise()},getFavoritesByType:function(e,t){if(e!=="Users"&&e!=="Playlists"&&e!=="Broadcasts")return n.Models.User.prototype.getFavoritesByType.call(this,e,t);var r=e;t&&e==="Broadcasts"&&(r=e+="Metadata");if(this["favorite"+r+"Dfd"]&&this["favorite"+r+"Dfd"].state()!=="rejected")return this["favorite"+r+"Dfd"].promise();var i=$.Deferred(),s=this.get("favorite"+e),o=this,u,a;if(s)i.resolve(s);else if(e==="Users"&&!this.get("followers"))a=function(){this.id<=0?(s=new n.Models.Collections[e],this.set("favoriteUsers",s),i.resolve(s)):this.getFollowersFollowingFriends().done(function(){i.resolve(o.get("favoriteUsers"))}).fail(function(e){if(!e){i.reject();return}o["favorite"+r+"Dfd"]=null,n.Models.User.prototype.getFavoritesByType.call(o,"Users",!1,i)})},this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(a,this)):a.call(this),this["favorite"+r+"Dfd"]=i;else if(e==="Playlists")u=this.get("favoritePlaylists"),u?i.resolve(u):a=function(){this.getFavoritePlaylistsBroadcasts().always(function(){var e=o.get("favoritePlaylists");e?i.resolve(e):i.reject()})},this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(a,this)):a.call(this),this["favorite"+r+"Dfd"]=i;else if(e==="Broadcasts"&&!t)u=this.get("favoriteBroadcasts"),u?i.resolve(u):this.getFavoritePlaylistsBroadcasts().always(function(){var e=o.get("favoriteBroadcasts");e?i.resolve(e):i.reject()}),this["favorite"+r+"Dfd"]=i;else{if(e!=="Broadcasts"||!t)return n.Models.User.prototype.getFavoritesByType.call(this,e,t);u=this.get("favoriteBroadcasts"),u&&u.includedMetadata?i.resolve(u):(a=function(){this.id<=0?(s=new n.Models.Collections.Broadcasts,this.set("favoriteBroadcasts",s),s.includeMetadata=!0,i.resolve(s)):n.Services.API.getFavoriteBroadcasts().always(function(e){if(!e){i.reject();return}s=new n.Models.Collections.Broadcasts(e),s.includeMetadata=!0,s.each(function(e){e.set("isFavorite",!0)}),o.set("favoriteBroadcasts",s),i.resolve(s)})},this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(a,this)):a.call(this)),this["favorite"+r+"Dfd"]=i}return i.promise()},getFavoritePlaylistsBroadcasts:function(){if(this.getFavoritePlaylistsBroadcastsDfd)return this.getFavoritePlaylistsBroadcastsDfd.promise();var e=$.Deferred(),t=this.get("favoritePlaylists"),r=this.get("favoriteBroadcasts");if(t&&r)e.resolve();else{var i=_.bind(function(){this.id<=0?(t=new n.Models.Collections.Playlists,r=new n.Models.Collections.Broadcasts,r.includeMetadata=!0,this.set({favoritePlaylists:t,favoriteBroadcasts:r}),e.resolve()):(n.Services.API.getSubscribedPlaylistsBroadcasts().always(_.bind(T,this,e)),this.getFavoritePlaylistsBroadcastsDfd=e)},this);this.get("oldUserClean")?this.get("oldUserClean").done(i):i()}return e.promise()},getFriends:function(){if(this.friendsDfd&&this.friendsDfd.state()!=="rejected")return this.friendsDfd.promise();var e=$.Deferred(),t=this.get("friends"),r=this.get("followers"),i=this.get("favoriteUsers"),s=this;r&&i&&!t&&(t=new n.Models.Collections.Users(_.intersection(r.models,i.models)));if(t)e.resolve(t);else{var o=function(){this.id<=0?(t=new n.Models.Collections.Users([]),this.set("friends",t),e.resolve(t),this.friendsDfd=e):this.getFollowersFollowingFriends().done(function(){e.resolve(s.get("friends"))}).fail(function(o){if(!o){e.reject();return}var u=new ChainLoading;u.push(n.Models.User.prototype.getFavoritesByType.call(s,"Users",!1)),u.push(n.Models.User.prototype.getFollowers.call(s,!1)),u.done(function(){r=s.get("followers"),i=s.get("favoriteUsers"),r&&i&&(t=new n.Models.Collections.Users(_.intersection(r.models,i.models)),e.resolve(t))})})};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(o,this)):o.call(this)}return e.promise()},getFollowersFollowingFriends:function(){if(this.followersFollowingFriendsDfd&&this.followersFollowingFriendsDfd.state()!=="rejected")return this.followersFollowingFriendsDfd.promise();var e=$.Deferred();return n.Services.API.userGetFollowersFollowing(S).done(_.bind(x,this,e,null)).fail(_.bind(x,this,e,null,null)),this.followersFollowingFriendsDfd=e,e.promise()},getRecommendedUsers:function(){return this.recommendedUsersDfd&&this.recommendedUsersDfd.state()!=="rejected"?this.recommendedUsersDfd.promise():(this.recommendedUsersDfd=new $.Deferred,this.get("recommendedUsers")?this.recommendedUsersDfd.resolve(this.get("recommendedUsers")):this.get("isLoggedIn")?n.Services.API.userGetRecommendedUsers().done(_.bind(B,this)):this.recommendedUsersDfd.reject(),this.recommendedUsersDfd.promise())},getLeapLib:function(){},updateListenTimestamps:function(t){var r=n.Services.Local.get("listenTimestamps"+this.get("UserID")),i=t?this.get("listenLimit")-1:this.get("listenLimit"),s=r?r.slice(i*-1):[],o=Math.floor(Date.now()+e.clientTimeDivergence),u=864e5,a=0,f=s.length,l=[];for(;a<f;a++)o-s[a]<u&&l.push(s[a]);t&&l.push(o),n.Services.Local.set("listenTimestamps"+this.get("UserID"),l)},addLocalSongListen:function(e,t,r){var i=this.get("settings"),s;e&&t&&i&&i.local&&_.isArray(i.local.recentListens)&&(s=n.Models.User.addListenToRecentListensArray(i.local.recentListens,e,t),r&&this.saveLocalRecentListens(s))},saveLocalRecentListens:function(e){var t=this.get("UserID");n.Services.Local.set("recentListens"+t,e),this.set({localRecentListens:e})},saveLocalArtistsPlayed:function(e){var t=this.get("UserID");n.Services.Local.set("artistsPlayed"+t,e)},saveUserPreferences:function(e){function l(e){e||t.reject(),this.set(i),t.resolve()}var t=$.Deferred(),r=this.get("UserID"),i={},s=!1,o,u,a,f;if(!e||_.isEmpty(e))return t.reject().promise();if(e.local&&!_.isEmpty(e.local)){f=U(this,e.local),i.settings=$.extend(!0,{},this.get("settings"),{local:f.local}),i.SettingsFlags=f.SettingsFlags,i.PlayerFlags=f.PlayerFlags;if(i.SettingsFlags!==this.get("SettingsFlags")||i.PlayerFlags!==this.get("PlayerFlags"))s=!0}return r<1?t.resolve().promise():(e.privacy&&!_.isEmpty(e.privacy)&&(f=z(this,e.privacy),f.changed?(s=!0,i.Privacy=f.Privacy,i.sessionPrivacy=f.sessionPrivacy):f.sessionPrivacy!==this.get("sessionPrivacy")&&(i.sessionPrivacy=f.sessionPrivacy)),_.defined(e.notificationsFlag)&&(o=_.toInt(e.notificationsFlag),o!==this.get("NotificationEmailPrefs")&&(s=!0,i.NotificationEmailPrefs=o,u=this.get("NotificationEmailPrefs"))),_.defined(e.locale)&&(s=!0,a=e.locale),s?n.Services.API.changeUserPreferences(i.SettingsFlags,i.PlayerFlags,i.Privacy,i.NotificationEmailPrefs,u,a).done(_.bind(l,this)).fail(_.bind(t.reject,t)):l.call(this,!0),t.promise())},saveUserTagPreferences:function(e,t,r){var i=n.Services.API.saveUserTagPreferences(e,t,r);return i.promise()},getUserTagPreferences:function(){var e=n.Services.API.getUserTagPreferences();return e.promise()},deletePlaylist:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred();return e&&e.get("UserID")===this.get("UserID")?n.Services.API.deletePlaylist(e.get("PlaylistID"),e.get("PlaylistName")).done(_.bind(k,this,e,r,t)).fail(_.bind(L,this,e,r,t)):r.reject(),r.promise()},restorePlaylist:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred();return n.Services.API.playlistUndelete(e.get("PlaylistID")).done(_.bind(A,this,e,r,t)).fail(_.bind(O,this,e,r,t)),r.promise()},deleteBroadcast:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred();if(e){var i=this.get("artistsOwned"),s=e.get("ArtistID"),o=e.get("UserID");!s&&o!==this.get("UserID")||s&&(!i||!i.get(s))?r.reject():n.Services.API.deleteBroadcast(e.get("BroadcastID"),s).done(_.bind(M,this,e,r,t)).fail(_.bind(D,this,e,r,t))}else r.reject();return r.promise()},restoreBroadcast:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred();if(e){var i=this.get("artistsOwned"),s=e.get("ArtistID"),o=e.get("UserID");!s&&o!==this.get("UserID")||s&&(!i||!i.get(s))?r.reject():n.Services.API.undeleteBroadcast(e.get("BroadcastID"),s).done(_.bind(P,this,e,r,t)).fail(_.bind(H,this,e,r,t))}else r.reject();return r.promise()},getMaterializedFeed:function(e,t,r,i){var s="feed",o=e&&_.isArray(e)&&e.sort(),u,a,f,l;return o&&o.length?s+=".["+o.join(",")+"]":o=null,t&&(s+="."+t),r&&(s+="."+r),this.materializedFeedDfds&&this.materializedFeedDfds[s]&&this.materializedFeedDfds[s].state()==="pending"?this.materializedFeedDfds[s].promise():(u=new $.Deferred,a=new n.Models.Collections.FeedEvents(null,{user:this,feedType:"materialized",tagIDs:o,mediaType:t,groupType:r,skipCache:i}),f=a.loadMore().fail(_.bind(u.reject,u)),u.resolve(a),this.materializedFeedDfds={},this.materializedFeedDfds[s]=u,l=u.promise(),f&&typeof f.abort=="function"&&(l.abort=_.bind(f.abort,f)),l.loadMoreDfd=f,l)},getNotifications:function(){if(this.userNotificationsDfd&&this.userNotificationsDfd.state()!=="rejected")return this.userNotificationsDfd.promise();var e=this.get("notifications"),t=$.Deferred();return e?this.userNotificationsDfd.resolve(e):this.get("isLoggedIn")?(e=new n.Models.Collections.Tacos,e.loadMore().done(_.bind(t.resolve,t,e)).fail(_.bind(t.reject,t)),this.set("notifications",e)):t.reject(),this.userNotificationsDfd=t,this.userNotificationsDfd.promise()},onDirectUserManateePublish:function(e){if(!e)return;switch(e.type||e.messageType){case"newNotification":this.onNewNotification(e.notification,e.tsNewest);break;case"removedNotifications":this.unset("notifications"),this.userNotificationsDfd&&this.userNotificationsDfd.state()!=="pending"&&delete this.userNotificationsDfd;break;default:n.trigger("manatee:"+e.messageType,e)}},onNewNotification:function(e,t){if(!e)return;var r=this.get("notifications"),i,s,o;r&&(r.updateTSNewest(t),i=r.get(e.GroupID)),i?i.updateFromNew(n.Models.Taco.prototype.parse(e)):(i=n.Models.Taco.newOrUpdate(e),r&&r.add(i)),s=i.getLastInstance();if(!s)return;o=i.getNormalizedObjectForInstance(s);if(!o)return;n.trigger("auth:newNotification"),n.trigger("notification:add",{title:_.getString(o.locale,o.localeOptions),description:o.message,url:o.link,icon:"bell",type:"success"})},claimArtist:function(e,t){this.id>0?this.getClaimHistory().done(function(e){}):n.Models.AuthUser.openRequireLoginTooltip("LB_LOGIN_MUST_LOGIN_TO_CLAIM_ARTIST",function(t){t.claimArtist(e)},t)},getUserAge:function(){var e=this.get("TSDOB"),t="";return e&&e!=="0000-00-00"?(t=e.match(/(\d+)/g),_.dobToAge(Number(t[0]),Number(t[1])-1,Number(t[2]))):!1},getUserStringForAnalytics:function(){var e,t,r,i,s,o="";e=this.get("isLoggedIn")?"Y":"N",t=_.orEqual(this.get("Sex"),"U"),r=this.getUserAge();switch(!0){case r>=13&&r<=17:i="A";break;case r>=18&&r<=23:i="B";break;case r>=24&&r<=29:i="C";break;case r>=30&&r<40:i="D";break;case r>=40&&r<50:i="E";break;case r>=50&&r<60:i="F";break;case r>=60&&r<70:i="G";break;case r>=70&&r<80:i="H";break;case r>=80&&r<90:i="I";break;case r>=90:i="J";break;default:i="U"}return s=(this.get("Flags")&n.Models.User.FLAG_ARTIST_CLAIMED)>0?"Y":"N",o+="L:"+e,o+=",S:"+t,o+=",A:"+i,o+=",C:"+s,o},getImageURL:function(e){return this.getUserImageURL(e)},getUserImageURL:function(e){return this._super.apply(this,["getImageURL",e])},getThemeImageURL:function(){return this.getUserThemeImageURL()},getUserThemeImageURL:function(){return this._super.apply(this,["getThemeImageURL"])},setContext:function(t,r){this.clearLastBroadcast(),r||(n.router.setHash("/#!/"),$(e).trigger("hashchange",{force:!0}))},updateBroadcastInviteableUsers:function(){var t=this.get("broadcastInvites"),i=(Date.now()+e.clientTimeDivergence)/1e3>>0,s=Infinity,o=Infinity,u=14400,a=86400,f;if(!t||!this.get("isLoggedIn"))return;t.InvitedUsers&&_.forEach(t.InvitedUsers,function(e,t){var f=n.Models.User.getCached(t);if(!f)return;var l=_.toInt(f.get("broadcastTimeInvited")),c=_.toInt(f.get("broadcastTimeInvitedEmail")),h=_.toInt(e[1]),p=_.toInt(e[2]),d=Math.max(h,l),v=Math.max(p,c),m=r.model.get("user").get("currentBroadcastID"),g=f.get("currentBroadcastID"),y=(!d||i-d>u)&&m!==g,b=!v||i-v>a;f.set({canBroadcastInvite:y,broadcastTimeInvited:d,canBroadcastInviteEmail:b,broadcastTimeInvitedEmail:v}),s=Math.min(d,s),o=Math.min(v,o)}),f=s===Infinity&&o===Infinity?1:Math.min(s+u,o+a),this.set("checkBroadcastInvitesTime",f)},getCurrentMasterStatus:function(){if(!this.currentMasterStatusDfd||this.currentMasterStatusDfd.state()!=="pending"){this.currentMasterStatusDfd=$.Deferred();var e=setTimeout(_.bind(function(){this.currentMasterStatusDfd&&this.currentMasterStatusDfd.reject()},this),7e3);this.currentMasterStatusDfd.always(_.bind(function(){clearTimeout(e)},this)),n.Services.Manatee.chatReady.done(function(){r.model.get("manatee").getSelfMasterStatus()})}return this.currentMasterStatusDfd.promise()},subscribeToStatus:function(){var e=n.Models.User.getUserStatusDfds[this.id];if(!e||e.state()!="pending"){e=$.Deferred();var t={status:this.get("onlineStatus"),bcastOwner:this.get("isOwnerOfCurrentBroadcast"),bcast:this.get("currentBroadcastID"),bcastName:this.get("currentBroadcastName"),bcastPic:this.get("currentBroadcastPicture"),bcastOwnerInfo:null,song:null},r=this.get("currentBroadcastOwner"),i=this.get("nowPlayingSong");r&&(t.bcastOwnerInfo=r),i&&(t.song=i.getDetailsForSwf()),e.resolve(t,this.id),n.Models.User.getUserStatusDfds[this.id]=e}return e.promise()},logPlaylistPlay:function(e){if(!this.get("isLoggedIn"))return;var t=e.get("PlaylistID"),r=null,i={Name:e.get("PlaylistName"),Picture:e.get("Picture")||"",Tag:r,UserID:e.get("UserID")};e.get("hasUnknownUserName")||(i.UserName=e.get("UserName")),n.Services.API.logPlaylistPlayEvent(t,i,i.UserID==n.getLoggedInUserID()).done(_.bind(function(e){if(!e)return;var n=Math.floor(Date.now()/1e3),r=$.extend({PlaylistID:t,ListenCount:1,TSListened:n},i),s;s=this.get("recentPlaylists"),s&&(s[t]?(s[t].ListenCount++,s[t].TSListened=n):s[t]=r,this.trigger("change:recentPlaylists",this,s))},this)).fail(function(){})},logBroadcastJoin:function(e){if(!this.get("isLoggedIn"))return;var t=e.get("BroadcastID"),r=e.getOwner(),i=e.get("Tag"),s=i?i.i:0,o=r&&r.get("UserID"),u={Tag:i?{Tag:i.n,TagID:i.i}:null,UserID:o};n.Services.API.logBroadcastPlayEvent(t,u).done(_.bind(function(){if(!u.UserID)return;this.updateUserTSInteraction(u.UserID,n.Models.AuthUser.INTERACTION_TYPE_JOIN_BROADCAST);var e=!1,r=o+":"+s,i=Math.floor(Date.now()/1e3),a={BroadcastID:t,ListenCount:1,TSListened:i,Tag:u.Tag,UserID:o},f,l;f=this.get("recentBroadcasts"),f&&(_.each(f,function(n){n.BroadcastID==t&&(n.ListenCount++,n.TSListened=i,e=!0)}),e||(f[t]=a),this.trigger("change:recentBroadcasts",this,f)),l=this.get("recentBroadcastsByUserIDTag"),l&&(e=!1,l[r]?_.each(l[r],function(n){n.BroadcastID==t&&(n.ListenCount++,n.TSListened=i,e=!0)}):l[r]=[],e||l[r].push(a))},this)).fail(function(){})},logAlbumPlay:function(e){if(!this.get("isLoggedIn"))return;var t=e.get("AlbumID");n.Services.API.logAlbumPlayEvent(t).fail(function(){})},updateUserTSInteraction:function(e,t){if(!e)return;var r=n.Models.User.getCached(e),i=this.get("recentUsers"),s=_.currentTime();r&&r.set("TSInteracted",s),i&&(i[e]?(i[e].TSInteraction=s,i[e].InteractionType|=t||0):i[e]={TSInteraction:s,InteractionType:t||0},this.trigger("change:recentUsers",this,i))},getRecentBroadcastsPlaylistsUsers:function(){if(this.userRecentStuffDfd&&this.userRecentStuffDfd.state()==="pending")return this.userRecentStuffDfd.promise();this.userRecentStuffDfd=new $.Deferred;var e=this.get("recentPlaylists"),t=this.get("recentBroadcasts"),r=this.get("recentUsers");return t||e||r?this.userRecentStuffDfd.resolve(t,e,r):this.get("isLoggedIn")?n.Services.API.getRecentBroadcastsPlaylistsUsers().done(_.bind(nt,this,this.userRecentStuffDfd)).fail(_.bind(this.userRecentStuffDfd.reject,this.userRecentStuffDfd)):this.userRecentStuffDfd.reject(),this.userRecentStuffDfd.promise()},getRecentPlaylists:function(){var e=$.Deferred();return this.getRecentBroadcastsPlaylistsUsers().done(function(t,n,r){e.resolve(n)}).fail(_.bind(e.reject,e)),e.promise()},getRecentBroadcasts:function(){var e=$.Deferred();return this.getRecentBroadcastsPlaylistsUsers().done(function(t,n,r,i){e.resolve(t,i)}).fail(_.bind(e.reject,e)),e.promise()},getRecentUsers:function(){var e=$.Deferred();return this.getRecentBroadcastsPlaylistsUsers().done(function(t,n,r){e.resolve(r)}).fail(_.bind(e.reject,e)),e.promise()},hasArtists:function(){var e=this.get("artistsOwned"),t=this.get("Flags"),r=t&n.Models.User.FLAG_ARTIST_CLAIMED||t&n.Models.User.FLAG_ARTIST_PROFILE;return!r&&(!e||!e.length)?!1:!r&&e.length===1&&!this.get("primaryUserID")&&e.at(0).get("ArtistID")===this.get("artistID")?!1:!0},refreshChatUserData:function(){var e=$.Deferred();return this.get("isLoggedIn")?(n.Services.API.getChatSignedUserData().done(_.bind(function(t){if(!t||!t.sig){e.reject();return}this.set({chatUserData:t.userData,chatUserDataSig:t.sig,chatUserDataSigExpires:Date.now()+ot}),e.resolve()},this)).fail(_.bind(e.reject,e)),e.promise()):e.reject().promise()},getUsesCollection:function(){return(this.get("SettingsFlags")&ut.APP_SETTING_USES_COLLECTION)==ut.APP_SETTING_USES_COLLECTION},getPreferredPlaylistSort:function(){var e=this.get("SettingsFlags"),t="asc",n="default";return(e&ut.APP_SETTING_PLAYLISTS_SORT_BACKWARDS)>0&&(t="desc"),(e&ut.APP_SETTING_PLAYLISTS_SORT_NAME)>0&&(n="PlaylistName"),(e&ut.APP_SETTING_PLAYLISTS_SORT_DATE)>0&&(n="TSAdded",(e&ut.APP_SETTING_PLAYLISTS_SORT_BACKWARDS)===0?t="desc":t="asc"),(e&ut.APP_SETTING_PLAYLISTS_SORT_LISTEN)>0&&(n="TSLastPlayed"),{dir:t,prop:n}},updatePreferredPlaylistSort:function(e,t){var r=this.get("SettingsFlags"),i=r,s=!1;if(e!=null){i&=~(ut.APP_SETTING_PLAYLISTS_SORT_NAME|ut.APP_SETTING_PLAYLISTS_SORT_DATE|ut.APP_SETTING_PLAYLISTS_SORT_LISTEN);switch(e){case"PlaylistName":i|=ut.APP_SETTING_PLAYLISTS_SORT_NAME;break;case"TSAdded":i|=ut.APP_SETTING_PLAYLISTS_SORT_DATE;break;case"TSLastPlayed":i|=ut.APP_SETTING_PLAYLISTS_SORT_LISTEN;break;case"default":break;default:console.error("Invalid property sent to updatePreferredPlaylistSort",e)}}return t!=null&&((i&ut.APP_SETTING_PLAYLISTS_SORT_DATE)>0?s=t==="asc":s=t==="desc",s?i|=ut.APP_SETTING_PLAYLISTS_SORT_BACKWARDS:i&=~ut.APP_SETTING_PLAYLISTS_SORT_BACKWARDS),i===r?$.Deferred().resolve().promise():(this.set("SettingsFlags",i),n.Services.API.changeUserPreferences(i))},updateCommentsRestriction:function(e){var t=$.Deferred();return this.getPageNameData().done(_.bind(function(){var r=this.get("pageNameData");if(r&&(r.CommentsRestriction===e||r.CommentsRestriction===null&&!e)){t.resolve();return}n.Services.API.updateUserCommentsRestriction(e).done(_.bind(function(n){if(!n){t.reject();return}r||(r={},this.set("pageNameData",r)),r.CommentsRestriction=e,t.resolve()})).fail(_.bind(t.reject,t))},this)).fail(_.bind(t.reject,t)),t.promise()},initTutorialTips:function(e){var t=_.bind(function(){this.triggerTutorialTooltip("RestoreQueue",$("#restore-queue"))},this),r=_.bind(function(){this.listenTo(n,"tutorial:OnlineNow",_.bind(function(){_.delay(_.bind(function(){this.triggerTutorialTooltip("OnlineNow",$(".nav-link.online-friends"))},this),1e3)},this))},this),i=_.bind(function(){_.delay(t,1e3)},this),s=_.bind(function(){_.delay(r,1e3)},this),o;if(n.getAppMode()!=="desktop"||e.UserID&&e.UserID!==this.get("UserID"))return;o=e&&e.Tips&&e.Tips.MiscSet||{},o.QueueTab||this.listenTo(n,"tutorial:QueueTab",_.bind(this.triggerTutorialTooltip,this,"QueueTab",$(".main-nav-link.queue"))),o.QueueMenu||this.listenTo(n,"tutorial:QueueMenu",_.bind(this.triggerTutorialTooltip,this,"QueueMenu",$(".queue-menu"))),o.OnlineNow||s(),o.RestoreQueue||($("body").hasClass("show-restore-queue")?i():this.listenTo(n,"tutorial:RestoreQueue",i)),o.ShareButton||this.listenTo(n,"tutorial:ShareButton",_.bind(function(e){this.triggerTutorialTooltip("ShareButton",e)},this))},onUserMiscData:function(e){var t=n.Services.Local.get("gs.viewedMiscTips"),r=e&&e.Tips&&e.Tips.MiscSet||{},i=this.get("UserID");e.UserID&&e.UserID!==i&&(r={}),_.each(t,function(e,t){r[t]||(this.markTipViewed("misc",e,t),r[t]=e)},this),this.initTutorialTips({UserID:i,Tips:{MiscSet:r}})},getUserMiscData:function(){return this.get("isLoggedIn")?n.Services.API.getUserMiscellaneousData().done(_.bind(this.onUserMiscData,this)):(this.initTutorialTips({UserID:-1,Tips:{MiscSet:n.Services.Local.get("gs.viewedMiscTips")}}),$.Deferred().resolve())},triggerTutorialTooltip:function(e,t){amdModules.requireDeferred("gs/views/tooltips/tutorialTip.js").done(_.bind(function(){n.Views.Tooltips.TutorialTip.openTooltip({$attached:t,$menuOpenEl:t,persist:!0,authUser:this,tipType:e})},this))},markTipViewed:function(e,t,r){var i=this.get("isLoggedIn"),s,o;e==="misc"&&(r==="QueueTab"?this.stopListening(n,"tutorial:QueueTab"):r==="QueueMenu"?this.stopListening(n,"tutorial:QueueMenu"):r==="RestoreQueue"?this.stopListening(n,"tutorial:RestoreQueue"):r==="ShareButton"?this.stopListening(n,"tutorial:ShareButton"):r==="OnlineNow"&&this.stopListening(n,"tutorial:OnlineNow"),i||(o={},o[r]=Date.now(),s=n.Services.Local.get("gs.viewedMiscTips")||{},n.Services.Local.set("gs.viewedMiscTips",_.extend(s,o)))),i&&n.Services.API.markTipViewed(e,t,r)}},{checkEmailUsername:function(e,t,r){var i=$.Deferred(),s={username:-1,email:-1};if(!t||t.length>=5&&t.length<=32&&t.match(st))s.username=t;if(!e||e.match(it))s.email=e;return r||(!s.email||s.email===-1)&&(!s.username||s.username===-1)?i.resolve(s):(typeof t=="undefined"&&(t=""),n.Services.API.getIsUsernameEmailAvailable(t,e).done(function(n){n.email&&(n.email=e),n.username&&(n.username=t),i.resolve(n)}).fail(function(){i.reject()})),i.promise()},openRequireLoginTooltip:function(e,t,r){amdModules.requireDeferred("gs/views/tooltips/requireLogin.js").done(function(){n.Views.Tooltips.RequireLogin.openTooltip(e,t,r)})},INTERACTION_TYPE_FOLLOW:1,INTERACTION_TYPE_COMMENT:2,INTERACTION_TYPE_JOIN_BROADCAST:4,INTERACTION_TYPE_PLAYLIST_SUB:8,INTERACTION_TYPE_SHARE:16,APP_SETTING_RESTORE_QUEUE:1,APP_SETTING_CLEAR_PLAYER_SETTINGS:2,APP_SETTING_LOWER_QUALITY:4,APP_SETTING_FAMILY_FRIENDLY:8,APP_SETTING_DISABLE_PLAYER_SHORTCUTS:16,APP_SETTING_CHAT_SHOW_JOIN_LEAVE:32,APP_SETTING_CHAT_HIDE_NOW_PLAYING:64,APP_SETTING_CHAT_HIDE_SUGGESTIONS:128,APP_SETTING_CHAT_HIDE_MY_TAG:256,APP_SETTING_BROADCAST_AUTO_APPROVE:512,APP_SETTING_ENABLE_BROWSER_NOTIFS:1024,APP_SETTING_USES_COLLECTION:2048,APP_SETTING_PLAYLISTS_SORT_NAME:4096,APP_SETTING_PLAYLISTS_SORT_DATE:8192,APP_SETTING_PLAYLISTS_SORT_LISTEN:16384,APP_SETTING_PLAYLISTS_SORT_BACKWARDS:32768,DEFAULT_CROSSFADE_AMOUNT:5e3,DEFAULT_PLAYER_SETTINGS:16,PLAYER_SETTING_CROSSFADE_ENABLED:1,PLAYER_SETTING_SHUFFLE_ENABLED:2,PLAYER_SETTING_CROSSFADE_SECS_3:4,PLAYER_SETTING_CROSSFADE_SECS_4:8,PLAYER_SETTING_CROSSFADE_SECS_5:16,PLAYER_SETTING_CROSSFADE_SECS_6:32,PLAYER_SETTING_CROSSFADE_SECS_7:12,PLAYER_SETTING_CROSSFADE_SECS_8:20,PLAYER_SETTING_CROSSFADE_SECS_ANY:60,PLAYER_SETTING_PLAY_PAUSE_FADE:64})}(),function(){n.Models=n.Models||{};var e={skipUserID:!0};n.Models.TinyUser=Backbone.Model.extend({idAttribute:"UserID",parse:function(e,t){if(t&&t.skipParse)return e;var n=e.FName||e.Name||e.n||"",r=!1,i;if(n===""||n&&$.trim(n)==="")r=!0,n="New User";i={Name:n,hasDefaultName:r,searchText:n.toLowerCase(),IsPremium:e.IsPremium==1||e.isPremium==1||e.y==1?1:0,Picture:e.Picture||e.p,metadataChecksum:e.z||e.metadataChecksum,permissions:e.permissions||0,noMetadata:!!e.noMetadata};if(!t||t.skipUserID!==!0)i.UserID=_.toInt(e.UserID||e.userID||e.u)||-1;return i},get:function(e){if(e==="isFavorite"){var t=r.model.attributes.user&&r.model.attributes.user.attributes.favoriteUsers;return t!=null&&t.get(this.attributes.UserID)!=null}return this.attributes[e]},updateFromNew:function(e,t){var n=!t||t.overwrite!==!0?_.omitSameKeys(this.attributes,e):e;delete n.UserID,this.set(n,t)},updateFromManatee:function(t){if(!t.z||t.z===this.attributes.metadataChecksum)return;t.permissions==null&&(t.permissions=this.attributes.permissions),t.noMetadata==null&&(t.noMetadata=this.attributes.noMetadata),this.set(this.parse(t,e))},updateFromUserModel:function(e){if(!e)return;this.set(n.Models.TinyUser.getKeysFromUserModel(e))},toUrl:n.Models.User.prototype.toUrl,getImageURL:n.Models.User.prototype.getImageURL,getShortName:n.Models.User.prototype.getShortName,getAnchorTag:n.Models.User.prototype.getAnchorTag,getBroadcastOptionMenu:n.Models.User.prototype.getBroadcastOptionMenu,getVIPPermissionsMenu:n.Models.User.prototype.getVIPPermissionsMenu},{interactedNiftyFriendSort:function(e,t){var i=r.model.attributes.user&&r.model.attributes.user.attributes.recentUsers,s=0,o=0;return i!=null&&(i[e.attributes.UserID]!=null&&(s=i[e.attributes.UserID]),i[t.attributes.UserID]!=null&&(o=i[t.attributes.UserID])),s!==o?o-s:n.Models.TinyUser.niftyFriendSort(e,t)},niftyFriendSort:function(e,t){var i=r.model.attributes.user&&r.model.attributes.user.attributes.favoriteUsers,s=!1,o=!1,u=!1,a=!1,f;i!=null&&(s=i.get(e.attributes.UserID)!=null,o=i.get(t.attributes.UserID)!=null);if(s&&o){f=r.model.attributes.user&&r.model.attributes.user.attributes.followers,f!=null&&(u=f.get(e.attributes.UserID)!=null,a=f.get(t.attributes.UserID)!=null);if(u&&!a)return-1;if(a&&!u)return 1}else{if(s)return-1;if(o)return 1}return n.Models.User.pictureNameSort(e,t)},getKeysFromUserModel:function(e){return e?{Name:e.get("Name"),hasDefaultName:e.get("hasDefaultName"),searchText:e.get("searchText"),IsPremium:e.get("IsPremium"),Picture:e.get("Picture"),metadataChecksum:"",noMetadata:!1}:{}}})}(),function(){n.Models=n.Models||{};var e;n.Models.Profile=e=Backbone.CachedModel.extend({idAttribute:"ProfileID",parse:function(t,r){if(r&&r.skipParse)return t;var i=r||{},s=!1,o=t.pageNames,u=t.artist,a=t.user,f,l;f=t.profile&&_.toInt(t.profile.ProfileID)||t.user&&_.toInt(t.user.UserID||t.user.id);if(u){var c;u instanceof n.Models.Artist?c={ArtistID:u.id}:c=_.clone(u),c.profileID=f,u=e.importArtist(c,o&&o.artist,i),l=u.get("ArtistID"),s=!0}if(a){var h;a instanceof n.Models.User?h={UserID:a.id}:h=_.clone(a),h.isArtist=!!l,h.artistID=l,a=e.importUser(h,o&&o.user,i)}return{ProfileID:f,isArtist:s,artist:u,user:a,profile:t.profile,attemptedPageNames:t.attemptedPageNames,pageNames:o}},updateFromNew:function(e,t){var n=_.defaults({},this.attributes,e);e.artist instanceof Backbone.Model&&(n.artist=e.artist),e.user instanceof Backbone.Model&&(n.user=e.user),this.set(n,t)}},{get:function(e,t,r,i,s){r=r!==!1,i=i!==!1;var o=$.Deferred(),u,a,f=e&&n.Models.User.getCached(e),l=t&&n.Models.Artist.getCached(t),c=f&&f.get("Flags"),h=f&&f.get("isArtist"),p=h||!_.isUndefined(c)&&c&n.Models.User.FLAG_ARTIST_PROFILE;return e&&(a=n.Models.Profile.getCached(e)),!a&&l&&l.get("profileID")&&(a=n.Models.Profile.getCached(l.get("profileID"))),a&&(a.get("attemptedPageNames")||f&&f.get("pageNameData")&&l&&l.get("pageNameData"))?(o.resolve(a),o.promise()):(f&&(!p||l)&&(r&&(r=!1),i&&f.get("pageNameData")&&(!p||l.get("pageNameData"))&&(i=!1)),!r&&!i&&f?(a=n.Models.Profile.newOrUpdate({user:f,artist:l},s),o.resolve(a),o.promise()):(t?u=n.Services.API.getProfileInfoByID(null,t,r,i):e?u=n.Services.API.getProfileInfoByID(e,null,r,i):u=$.Deferred().reject(),u.done(function(e){if(!e||!e.user){o.reject(e);return}e=_.clone(e),i&&(e.attemptedPageNames=!0);var t=n.Models.Profile.newOrUpdate(e,s);o.resolve(t)}).fail(function(e){o.reject(e)}),o.promise()))},importUser:function(e,t,r){var i;return t&&(e.rawPageNameData=t),r&&r.overrideUser?(i=r.overrideUser,e=n.Models.AuthUser.prototype.parse.call(i,e,r),i.updateFromNew(e)):i=n.Models.User.newOrUpdate(e,r),e.PathName&&n.router.cachePageName(e.PathName,"user",i.id),i},importArtist:function(e,t,r){var i,s;return t&&(e.PathName=(t.Name&&t.Name.indexOf("/")>-1?"":t.Name)||"",e.pageNameData=t.Data),!_.isUndefined(e.IsVerified)&&!_.isUndefined(e.CoverArtFilename)&&(s=!0),i=n.Models.Artist.newOrUpdate(e,r),s&&(i._gotExtraDetails=!0),e.PathName&&n.router.cachePageName(e.PathName,"artist",i.id),i}})}(),function(){function i(e){var t=[],r={};_.each(e,_.bind(function(e){e.playlistSongID=[this.id,":",this.lastPlaylistSongID++].join(""),t.push(e);var n=e.AlbumID;n&&(r[n]?r[n].IsVerified!=1&&(r[n].IsVerified=e.IsVerified):r[n]={AlbumID:n,AlbumName:e.AlbumName,ArtistID:e.ArtistID,ArtistName:e.ArtistName,CoverArtFilename:e.CoverArtFilename,IsVerified:e.IsVerified})},this));var i=new n.Models.Collections.PlaylistSongs(t);this.set({songs:i,albums:new n.Models.Collections.Albums(_.toArray(r))})}function s(e){if(e.get("SongID")<=0)return;var t=$.Deferred();return n.Services.API.playlistAddSongToExisting(this.get("PlaylistID"),e.get("SongID")).done(_.bind(l,this,t,e,!0)).fail(_.bind(h,this,t)),t.promise()}function o(e,t,r){var i=$.Deferred(),s=[],o;for(var u=0;u<e.length;u++)s.push(e[u].get("SongID"));return t=_.orEqual(t,!0),r?o=_.bind(c,this,i,e,t,!0):o=_.bind(f,this,i,e,t,!0),n.Services.API.overwritePlaylist(this.get("PlaylistID"),this.get("PlaylistName"),s).done(o).fail(_.bind(h,this,i)),n.trigger("guts:log","savePlaylist",{playlistID:this.get("PlaylistID")}),i.promise()}function u(e){var t=this.get("changeLog");t.push(e),t.length>10&&t.shift()}function a(e){var t=e.get("PlaylistName");t&&t.length>18&&(t=t.substr(0,15)+"..."),n.trigger("notification:add",{title:_.getString("POPUP_PLAYLIST_SAVE_TITLE",{playlist:"<i>"+_.escape(t)+"</i>"}),description:_.getString("POPUP_PLAYLIST_SAVE_DESCRIPTION"),url:e.toUrl(),icon:"playlist",type:"success"})}function f(e,t,i,s,o){if(!o)return n.trigger("notification:add",{description:_.getString("POPUP_FAIL_SAVE_PLAYLIST_MSG",{playlist:this.escape("PlaylistName")}),type:"error"}),!1;if(o==-1)return n.trigger("notification:add",{title:_.getString("POPUP_FAIL_PLAYLIST_ADD_TITLE"),description:_.getString("POPUP_FAIL_PLAYLIST_ADD_MSG"),type:"error"}),!1;if(this.get("songs")){i=_.orEqual(i,!0);if(i){var f=this.get("songs").toArray();u.call(this,f)}this.get("songs").reset(t),this.set("TSModified",_.currentTime()),a(this)}_.gaTrackEvent("playlist","savePlaylist"),s,r.model.get("user").syncUserContentChange("playlistSongsChange",{items:[this.get("PlaylistID")]},"playlistSongsChange"),e.resolve()}function l(e,t,i,s,o){if(!s)return n.trigger("notification:add",{description:_.getString("POPUP_FAIL_SAVE_PLAYLIST_MSG",{playlist:this.escape("PlaylistName")}),type:"error"}),!1;if(s==-1)return n.trigger("notification:add",{title:_.getString("POPUP_FAIL_PLAYLIST_ADD_TITLE"),description:_.getString("POPUP_FAIL_PLAYLIST_ADD_MSG_SINGLE"),type:"error"}),!1;if(this.get("songs")){o=_.orEqual(o,!0);if(o){var f=this.get("songs").toArray();u.call(this,f)}this.get("songs").add(t)}this.set("TSModified",_.currentTime()),a(this),i,e.resolve(),r.model.get("user").syncUserContentChange("playlistSongsChange",{items:[this.get("PlaylistID")]},"playlistSongsChange"),_.gaTrackEvent("playlist","songsAddedToPlaylist","count",1),n.trigger("guts:forcelog","singleSongAddedToPlaylist",{playlistID:this.get("PlaylistID"),songID:t._wrapped.id})}function c(e,t,n,i,s){var o=this.get("changeLog");o.pop(),this.get("songs")&&(this.get("songs").reset(t),a(this)),this.set("TSModified",_.currentTime()),r.model.get("user").syncUserContentChange("playlistSongsChange",{items:[this.get("PlaylistID")]},"playlistSongsChange"),e.resolve()}function h(e){e.reject()}n.Models=n.Models||{},n.Models.Playlist=Backbone.CachedModel.extend({idAttribute:"PlaylistID",parse:function(e,t){if(t&&t.skipParse)return e;var r=t||{},i=e.Collaborators,s=""+_.orEqualEx(e.PlaylistName,e.Name,""),o=e.Username||e.UserName||e.attributor||$.trim($.trim(e.FName)+" "+$.trim(e.LName))||"",u=!1;return o||(o=_.getString("UNKNOWN_USER"),u=!0),i&&!(i instanceof n.Models.Collections.Users)&&(i=new n.Models.Collections.Users(i)),e.owner!=null&&(e.owner instanceof Backbone.Model||(e.owner=n.Models.User.newOrUpdate(e.owner,{dontCache:!0,skipUpdate:!0})),u&&(o=e.owner.get("Name"),u=!1)),{PlaylistID:_.toInt(e.PlaylistID),PlaylistName:s,CoverPhoto:_.orEqual(e.CoverPhoto,""),CoverPhotoY:e.CoverPhotoY,StockCoverPhoto:e.StockCoverPhoto,Description:_.orEqualEx(e.Description,e.About,""),Picture:e.Picture,UserName:o,hasUnknownUserName:u,UserID:_.toInt(e.UserID),Collaborators:i,Collaborative:_.orEqual(e.Collaborative,!!i),TSAdded:_.dateTimeToTimestamp(e.TSAdded),TSModified:_.dateTimeToTimestamp(e.TSModified),TSFavorited:_.dateTimeToTimestamp(e.TSFavorited),Tag:e.Tag?n.Models.Tag.newOrUpdate(e.Tag,{skipUpdate:!0,dontCache:!0}):null,searchText:s.toLowerCase(),isFavorite:!!e.isFavorite||!!r.isFavorite,SongCount:e.SongCount,SubscriberCount:e.SubscriberCount,initialSongs:e.initialSongs,IsDeleted:e.IsDeleted,changeLog:[],TSLastPlayed:_.toInt(e.TSLastPlayed),owner:e.owner,ownerPicture:e.OwnerPicture}},initialize:function(e,t){this.lastPlaylistSongID=0;var n=this.get("initialSongs");n&&(i.call(this,n),this.unset("initialSongs",{silent:!0}));var s=r.model.attributes.user&&r.model.attributes.user.attributes.recentPlaylists;s&&s[this.id]&&this.set({TSLastPlayed:s[this.id].TSListened},{silent:!0}),Backbone.CachedModel.prototype.initialize.call(this,e,t)},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e);if(e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;e.UserName&&this.attributes.hasUnknownUserName&&(n.hasUnknownUserName=!1,n.UserName=e.UserName),this.set(n,t)},getOwner:function(){if(this.getOwnerDfd)return this.getOwnerDfd.promise();var e=$.Deferred(),t=this.get("UserID"),r=this.get("owner");return r?e.resolve(r):n.Models.User.get(t).done(_.bind(function(t){this.set("owner",t),e.resolve(t)},this)).fail(_.bind(e.reject,e)),this.getOwnerDfd=e,e.promise()},getSongs:function(){if(this.loadSongsDfd)return this.loadSongsDfd.promise();var e=$.Deferred();return this.get("songs")?e.resolve(this.get("songs")):(n.Services.API.playlistGetSongs(this.id,this._skipSongsAPICache).done(_.bind(function(t){this._skipSongsAPICache=!1,i.call(this,t.Songs),e.resolve(this.get("songs"))},this)).fail(function(t){e.reject(t)}),this.loadSongsDfd=e),e.promise()},loadSongCount:function(){var e=$.Deferred(),t=this.get("SongCount");return t!=null?e.resolve(t):n.Services.API.getPlaylistMetaByID(this.id).done(_.bind(function(t){this.updateFromNew(this.parse(t)),e.resolve(this.get("SongCount"))},this)).fail(_.bind(e.reject,e)),e.promise()},clearSongs:function(){this._skipSongsAPICache=!0,delete this.loadSongsDfd,delete this.loadAlbumsDfd,this.unset("songs"),this.unset("albums")},getUnwrappedSongs:function(){var e=this.getSongs(),t=$.Deferred();return e.done(function(e){e=e.models;var r=[];for(var i=0,s=e.length;i<s;i++)r.push(e[i]._wrapped);t.resolve(new n.Models.Collections.Songs(r))}).fail(function(){t.reject.apply(t,arguments)}),t},getAlbums:function(){if(this.loadAlbumsDfd)return this.loadAlbumsDfd.promise();var e=new $.Deferred;return this.get("albums")?e.resolve(this.get("albums")):(this.getSongs().done(_.bind(function(){e.resolve(this.get("albums"))},this)).fail(function(t){e.reject(t)}),this.loadAlbumsDfd=e),e.promise()},getFans:function(){if(this.loadFansDfd)return this.loadFansDfd.promise();var e=$.Deferred();return this.get("fans")?e.resolve(this.get("fans")):(n.Services.API.playlistGetFans(this.id).done(_.bind(function(t){if(t.Users){var r=new n.Models.Collections.Users(_.toArray(t.Users));this.set({fans:r}),e.resolve(r)}else e.reject(t)},this)).fail(function(t){e.reject(t)}),this.loadFansDfd=e),e.promise()},getImageURL:function(t){t=_.orEqual(t,200);var r=this.get("Picture"),i=_.getImageURL(n.Models.Playlist.artPath+t+"_playlist.png");return this.attributes.hasCustomImage?(t==200&&(t=120),i=_.getImageURL(n.Models.Playlist.featuredArtPath+t+"_"+this.get("Picture"))):r&&(i=_.getImageURL(n.Models.Playlist.artPath+t+"_"+this.get("Picture"))),i+="?co="+e.location.host,i},getPageImageURL:function(t){var r=_.getCDNImage(n.Models.Playlist[_.isRetina()?"coverArtPathDefaultRetina":"coverArtPathDefault"]),i="?co="+e.location.host,s=new $.Deferred,o=this.get("CoverPhoto"),u=this.get("StockCoverPhoto"),a,f;return t=t||1280,o?s.resolve(_.getImageURL(n.Models.Playlist.coverArtPath+t+"_"+o+i)):u?(a=n.Models.Cover.covers[u],a?(f=new n.Models.Cover(a),s.resolve(f.getCoverPath())):s.reject()):s.resolve(r+i),s.promise()},getPlaylistArt:function(e){e=_.orEqual(e,200);var t=this.get("Picture");if(t)return[_.getImageURL(n.Models.Playlist.artPath+e+"_"+t)];var r=[],i={},s=[];this.get("songs")&&(this.get("songs").each(function(e){e.get("CoverArtFilename")&&(i.hasOwnProperty(e.get("AlbumID"))?i[e.AlbumID].weight++:i[e.AlbumID]={CoverArtFilename:e.get("CoverArtFilename"),weight:1})}),s=_.toArray(i),s=s.sort(function(e,t){return t.weight-e.weight}).slice(0,4)),s.length==4&&(e=70);for(var o=0;o<s.length;o++)r.push(_.getImageURL(n.Models.Album.artPath+e+"_"+s[o].CoverArtFilename));return r.length?r:[_.getImageURL(n.Models.Playlist.artPath+e+"_playlist.png")]},getOwnerImageURL:function(t){var r=this.get("owner"),i=this.get("UserID"),s=this.get("ownerPicture"),o;return s!=null&&!r&&(r=new n.Models.User({UserID:i,Picture:s},{dontCache:!0})),r?o=r.getImageURL(t):o=_.getImageURL(n.Models.User.artPath+t+"user.png"),o+="?co="+e.location.host,o},setCoverPhoto:function(e,t,n){var r;e?(r=(new Date).getTime(),this.set({CoverPhoto:e+"?"+r,StockCoverPhoto:""})):this.set({CoverPhoto:"",CoverPhotoY:n,StockCoverPhoto:t})},toOwnerUrl:function(){var e=this.get("owner"),t=this.get("UserID"),n=this.get("UserName"),r;return e?r=e.toUrl():r=_.cleanUrl(n?n:"New User",t,"profile"),r},addSongs:function(e,t){if(!this.isEditable())return;var r=[],i=this.get("songs"),u,a,f,l;for(l=0;l<e.length;l++){f=e[l],f=f._wrapped||f,a=f.get("SongID");if(!f||a===0)continue;u=[this.id,":",this.lastPlaylistSongID++].join(""),r.push(new n.Models.PlaylistSong($.extend(f.toJSON(),{playlistSongID:u})))}if(r.length===0)return;t=_.orEqual(t,-1);if(r.length==1&&(i&&t==i.length||t===-1)){s.call(this,r[0]).done(_.bind(function(){this.trigger("songsAddedToPlaylist")},this));return}this.getSongs().done(_.bind(function(e){if(r.length+e.length>2500){n.trigger("notification:add",{title:_.getString("POPUP_FAIL_PLAYLIST_ADD_TITLE"),description:_.getString("POPUP_FAIL_PLAYLIST_ADD_MSG"),type:"error"});return}var i=e.toArray();t==-1||t>=e.length?i.push.apply(i,r):i.splice.apply(i,[t,0].concat(r)),o.call(this,i,!0,!1).done(_.bind(function(){var e=[],t;for(t=0;t<r.length;t++)e.push(r[t].get("SongID"));this.trigger("songsAddedToPlaylist"),_.gaTrackEvent("playlist","songsAddedToPlaylist","count",e.length),n.trigger("guts:forcelog","songsAddedToPlaylist",{playlistID:this.get("PlaylistID"),ids:e})},this))},this)).fail(function(){})},moveSongsTo:function(e,t){if(!this.isEditable())return!1;var n,r,i=[],s=this.get("songs").toArray();for(n=0;n<e.length;n++)i.push(s[e[n]]);for(n=0;n<i.length;n++)r=_.indexOf(s,i[n]),s.splice(r,1),r<t&&t--;s.splice.apply(s,[t,0].concat(i)),o.call(this,s,!0,!1)},undo:function(){var e=this.get("changeLog"),t=$.Deferred();return o.call(this,e[e.length-1],!1,!0).done(function(){t.resolve()}),t.promise()},removeSongs:function(e){if(!this.isEditable())return!1;e.sort(function(e,t){return t-e});var t=this.get("songs").toArray(),r=[];for(var i=0;i<e.length;i++)r.push(t.splice(e[i],1)[0].get("SongID"));o.call(this,t,!0,!1).done(_.bind(function(){this.trigger("songsRemovedFromPlaylist"),_.gaTrackEvent("playlist","songsRemovedFromPlaylist","count",r.length),n.trigger("guts:forcelog","songsRemovedFromPlaylist",{playlistID:this.get("PlaylistID"),ids:r})},this))},overwriteWithSongs:function(e){var t=$.Deferred(),r=[],i=[],s,u,a;if(!this.isEditable())return t.reject().promise();for(a=0;a<e.length;a++){s=e[a],s=s._wrapped||s;if(!s)continue;u=[this.id,":",this.lastPlaylistSongID++].join(""),r.push(new n.Models.PlaylistSong($.extend(s.toJSON(),{playlistSongID:u}))),i.push(s.get("SongID"))}return o.call(this,r,!0,!1).done(_.bind(function(){_.gaTrackEvent("playlist","overwritePlaylist","count",i),n.trigger("guts:forcelog","overwritePlaylist",{playlistID:this.get("PlaylistID"),replacementSongIDs:i}),t.resolve()},this)).fail(function(){t.reject()}),t.promise()},toProxyLabel:function(){return _.getString("SELECTION_PLAYLIST_SINGLE",{PlaylistName:this.escape("PlaylistName"),Username:this.escape("UserName")})},getTitle:function(e){return e?['"',this.get("PlaylistName"),'" by ',this.get("UserName")].join(""):['"',this.escape("PlaylistName"),'" by ',this.escape("UserName")].join("")},isEditable:function(){return this.get("UserID")===n.getLoggedInUserID()},toUrl:function(e){return _.cleanUrl(this.get("PlaylistName"),this.get("PlaylistID"),"playlist",null,e)},toUserUrl:function(e){return _.cleanUrl(this.get("UserName"),this.get("UserID"),"profile",null,e)},rename:function(e){var t=$.Deferred();return n.Services.API.renamePlaylist(this.get("PlaylistID"),e,!1).done(_.bind(function(n){this.set("PlaylistName",e),r.model.get("user").syncUserContentChange("playlistChange",{action:"rename",items:[this.toManateeProperties()]},"playlistUpdated"),t.resolve()},this)).fail(function(e){t.reject()}),t.promise()},changeDescription:function(e){var t=$.Deferred();return n.Services.API.setPlaylistAbout(this.get("PlaylistID"),e,!1).done(_.bind(function(n){this.set("Description",e),t.resolve()},this)).fail(function(e){t.reject()}),t.promise()},changeCustomTag:function(e,t){var r=$.Deferred();return n.Services.API.modifyPlaylistCustomTag(this.get("PlaylistID"),e.TagID,t).done(_.bind(function(t){this.set("Tag",n.Models.Tag.newOrUpdate({TagID:e.TagID,TagName:e.Tag||""})),r.resolve()},this)).fail(function(e){r.reject()}),r.promise()},getDetailsForFeeds:function(){var e={playlistID:this.get("PlaylistID"),playlistName:this.get("PlaylistName"),artFilename:this.get("Picture"),userID:this.get("UserID"),userName:this.get("UserName")};if(!this.get("UserName")){var t=n.Models.User.getCached(this.get("UserID"));t&&(e.userName=t.get("FName"))}return this.get("songs")&&(e.songs=[],e.numSongs=this.get("songs").length),e},getAnchorTag:function(e,t){return'<a href="'+this.toUrl(t)+'" class="playlist-link">'+(e?_.getString(e).toLocaleLowerCase():this.escape("PlaylistName"))+"</a>"},getAuthorAnchorTag:function(e,t){return'<a href="'+this.toUserUrl(t)+'" class="user-link show-user-tooltip" data-user-id="'+this.get("UserID")+'">'+(e?_.getString(e).toLocaleLowerCase():this.escape("UserName"))+"</a>"},getWidgetCode:function(e,t,n){var r=["bbg","bth","pfg","lfg"],i=["bt","pbg","pfgh","si","lbg","lfgh","sb"],s=["bfg","pbgh","lbgh","sbh"],o="gsPlaylist"+this.get("PlaylistID")+Math.floor(Math.random()*101),u=_.orEqual(e,250),a=_.orEqual(t,40),f=_.escape(this.get("PlaylistName")+" by "+this.get("UserName")+" on Grooveshark"),l='<a href="http://grooveshark.com/search/playlist?q='+encodeURIComponent(this.get("PlaylistName")+" "+this.get("UserName"))+'" title="'+f+'">'+f+"</a>",c=[],h,p;for(h=0,p=r.length;h<p;h++)c.push(r[h]+"="+n.base);for(h=0,p=i.length;h<p;h++)c.push(i[h]+"="+n.primary);for(h=0,p=s.length;h<p;h++)c.push(s[h]+"="+n.secondary);return'<object width="'+u+'" height="'+a+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" id="'+o+'" name="'+o+'">'+'<param name="movie" value="http://grooveshark.com/widget.swf" /><param name="wmode" value="window" /><param name="allowScriptAccess" value="always" />'+'<param name="flashvars" value="hostname=grooveshark.com&playlistID='+this.get("PlaylistID")+"&p=0&"+c.join("&")+'" />'+'<object type="application/x-shockwave-flash" data="http://grooveshark.com/widget.swf" width="'+u+'" height="'+a+'"><param name="wmode" value="window" />'+'<param name="allowScriptAccess" value="always" /><param name="flashvars" value="hostname=grooveshark.com&playlistID='+this.get("PlaylistID")+"&p=0&"+c.join("&")+'" />'+"<span>"+l+"</span></object></object>"},getWidgetType:function(){return"multi"},toManateeProperties:function(){return{pID:this.get("PlaylistID"),pN:this.get("PlaylistName"),uID:this.get("UserID"),d:this.get("Description")}},play:function(e){var t=e||{};return t.context=t.context||new n.Models.PlayContext(this),this.getSongs().done(_.bind(function(e){var r=e.models.slice();t.collectionComparator&&r.sort(t.collectionComparator),n.trigger("player:addSongsEx",r,t),n.trigger("logPlaylistPlay",this),this.set("TSLastPlayed",_.currentTime())},this))}},{featuredArtPath:"/static/featured/",artPath:"/static/playlists/",coverArtPath:"/static/playlistcovers/",coverArtPathDefault:"default/cover/album-song-playlist.png",coverArtPathDefaultRetina:"default/cover/retina/album-song-playlist.png",get:function(e){var t=Backbone.CachedModel.genericGet.call(this,n.Services.API.getPlaylistByID,"PlaylistID",e);return t.promise()},wrapFeedData:function(e){var t={PlaylistID:_.orEqual(e.playlistID,e.PlaylistID),PlaylistName:$.trim(_.orEqualEx(e.playlistName,e.PlaylistName,e.Name)),Username:$.trim(_.orEqualEx(e.owningName,e.userName,e.UserName)),UserID:_.orEqualEx(e.owningUserID,e.userID,e.UserID),Picture:e.artFilename};return!t.Username&&e.subscribingName&&(t.Username=e.subscribingName),n.Models.Playlist.newOrUpdate(t,{noCache:!0})},convertManateeProperties:function(e){return e?{PlaylistID:e.pID,PlaylistName:e.pN,UserID:e.uID,Description:e.d}:t},createdSort:function(e,t){var r=n.getLoggedInUserID(),i=(e.attributes.UserID==r?e.attributes.TSAdded:_.toInt(e.attributes.TSFavorited)-1)||0,s=(t.attributes.UserID==r?t.attributes.TSAdded:_.toInt(t.attributes.TSFavorited)-1)||0;return i-s},modifiedSort:function(e,t){return _.orEqual(t.get("TSModified"),0)-_.orEqual(e.get("TSModified"),0)},modifiedPlayedSort:function(e,t){var r=n.getLoggedInUserID(),i=(e.attributes.UserID==r?e.attributes.TSModified:_.toInt(e.attributes.TSLastPlayed)-1)||0,s=(t.attributes.UserID==r?t.attributes.TSModified:_.toInt(t.attributes.TSLastPlayed)-1)||0;return s-i},acceptDrop:function(e,t,n,r){function f(e){u=u.concat(e.toArray())}n=_.orEqual(n,-1),r=_.orEqual(r,!1);if(r){var i=[];return _.forEach(t.draggedItems,function(t){var n=e.get("songs").indexOf(t);n!=-1&&i.push(n)}),i.length?(e.moveSongsTo(i,n),!0):!1}var s,o,u=[],a=[];switch(t.draggedItemsType){case"song":return e.addSongs(t.draggedItems,n),!0;case"album":case"artist":case"playlist":for(s=0;s<t.draggedItems.length;s++){o=t.draggedItems[s];if(o===e)continue;_.isFunction(o.getSongs)&&a.push(o.getSongs().done(f))}}return a.length>0&&$.after(a).always(function(){u.length&&e.addSongs(u,n)}),!0}})}(),function(){n.Models=n.Models||{},n.Models.Video=Backbone.Model.extend({idAttribute:"UniqueVideoID",params:{allowscriptaccess:"always",allowfullscreen:!0},attributes:{name:"videoPlayer"},parse:function(e,t){if(t&&t.skipParse)return e;var n=t||{},r=_.orEqualEx(e.embedType,e.type),i=_.orEqualEx(e.vimeoID,e.VimeoID,e.videoID,e.VideoID);if(!r||r=="iframe"&&(e.vimeoID||e.VimeoID))r="vimeo";return this.flashvars={version:gsConfig.snapVersion},{title:_.orEqualEx(e.Title,e.title,e.Video,""),author:_.orEqualEx(e.Author,e.author,""),type:r,swf:_.orEqual(e.swf,"/webincludes/flash/videoplayer.swf"),src:_.orEqual(e.src,""),VideoID:i,VimeoID:_.orEqualEx(e.vimeoID,e.VimeoID,""),ArtistID:e.ArtistID||e.artistID,ArtistName:e.ArtistName||e.artistName,thumbnail:_.orEqual(e.thumbnail,e.Thumbnails&&e.Thumbnails.length&&e.Thumbnails[0]?e.Thumbnails[0].url:""),duration:_.millisToMinutesSeconds(_.orEqual(e.duration,e.Duration)*1e3),durationSecs:_.orEqual(e.duration,e.Duration),width:_.orEqualEx(e.Width,e.width,640),height:_.orEqualEx(e.Height,e.height,360),UniqueVideoID:r+i.toString(),Picture:e.Picture,clickToPlay:e.clickToPlay,attributor:e.attributor,tags:e.tags,info:e.info,hasCustomImage:e.hasCustomImage,gsArtistURL:e.gsArtistURL,gsSongURL:e.gsSongURL,url:e.url,uri:e.uri}},getImageURL:function(e){return e=_.orEqual(e,120),this.get("Picture")?_.getImageURL(n.Models.Video.artPath+e+"_"+this.get("Picture")):""},toArtistUrl:function(e){return n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),e)}},{artPath:"/static/featured/"})}(),function(){n.Models=n.Models||{},n.Models.Event=Backbone.Model.extend({idAttribute:"EventID",parse:function(e,n){if(n&&n.skipParse)return e;var r=(e.EventName||"").replace(/\s\((.*?)\)$/,""),i=e.StartTime,s=e.EndTime,o,u,a;return i&&!(i instanceof Date)&&(typeof i!="string"||i.indexOf("-")==-1?(o=_.toInt(i),i=new Date(o*1e3)):(u=i.split(" "),u.length>1?(a=u[1]?u[1].split(":"):"00:00:00",u=u[0].split("-"),i=new Date(parseInt(u[0],10),parseInt(u[1],10)-1,parseInt(u[2],10),parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10))):i=t)),s&&!(s instanceof Date)&&(typeof s!="string"||s.indexOf("-")==-1?(o=_.toInt(s),s=new Date(o*1e3)):(u=s.split(" "),u.length>1?(a=u[1]?u[1].split(":"):"00:00:00",u=u[0].split("-"),s=new Date(parseInt(u[0],10),parseInt(u[1],10)-1,parseInt(u[2],10),parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10))):s=t)),{EventName:r,EventID:e.EventID,StartTime:i,EndTime:s,ArtistName:e.ArtistName,City:e.City,VenueName:e.VenueName,TicketsURL:e.TicketsURL,searchText:[r,e.ArtistName,e.City].join(" ").toLowerCase(),UserID:e.UserID,Tag:e.Tag,UserInfo:e.UserInfo,broadcast:e.broadcast,RecurrenceData:e.RecurrenceData,ArtistID:e.ArtistID}}},{})}(),function(){function t(t){var r=0,i=e.length,s,o,u;for(;r<i;r++){s=e[r],o=this.attributes?this.attributes[s]:null,u=t&&$.isArray(t[s])?t[s]:!1;if(u){if(o instanceof Backbone.Collection){u.length>o.length&&o.reset(u),t[s]=o;continue}if(!$.isArray(o)||u.length>o.length)o=u}o&&$.isArray(o)&&(t[s]=new n.Models.Collections[s=="RelatedTags"?"Tags":s](o))}return t}function i(e){var t=new $.Deferred;return n.Services.API.getPageInfoByIDType(e,"tag").done(function(n){var r=n.Data;r&&r.Tag?(r.TagID=e,r.Albums=_.orEqual(r.Albums,[]),r.Artists=_.orEqual(r.Artists,[]),r.RelatedTags=_.orEqual(r.RelatedTags,[]),r.Songs=_.orEqual(r.Songs,[]),r.pageInfoLoaded=!0,r.pageMetaInfoLoaded=!0,r.source="getPageInfoByIDType",t.resolve(r)):t.reject(n)}).fail(function(e){t.reject(e)}),t.promise()}function s(e,t){if(!this.updateSelfDfd||this.updateSelfDfd.state()!="pending")this.updateSelfDfd=i(this.id);this.updateSelfDfd.done(_.bind(function(n){var r=this.parse(n);this.updateFromNew(r),e.resolve(this.get(t))},this)).fail(function(){e.reject()})}n.Models=n.Models||{};var e=["RelatedTags","Songs","Albums","Artists"];n.Models.Tag=Backbone.CachedModel.extend({idAttribute:"TagID",parse:function(e,r){if(r&&r.skipParse)return e;var i=String(_.orEqualEx(e.Tag,e.TagName,e.tag,e.n,"")),s=_.orEqualEx(e.TagID,e.tagID,e.tid,e.i),o=n.Models.Tag.fixNameLookup[s]||i,u=t.call(this,{RelatedTags:e.RelatedTags,Songs:e.Songs,Albums:e.Albums,Artists:e.Artists}),a={TagID:s,Tag:o,DisplayName:_.ucwords(o,!0),searchText:i.toLowerCase(),RelatedTags:u.RelatedTags,Songs:u.Songs,Albums:u.Albums,Artists:u.Artists,pageInfoLoaded:_.defined(e.pageInfoLoaded)?e.pageInfoLoaded:!1,pageMetaInfoLoaded:_.defined(e.pageMetaInfoLoaded)?e.pageMetaInfoLoaded:!1,sampleSongs:_.defined(e.sampleSongs)?e.sampleSongs:!1,Description:e.Description||"",ShortDescription:e.ShortDescription||""};return a},updateFromNew:function(e,n){var r=t.call(this,e),i=_.omitSameKeys(this.attributes,r),s=r.TagName||r.Tag||r.tag||"";r.pageInfoLoaded&&(i.pageInfoLoaded=r.pageInfoLoaded),s&&!this.attributes.Tag&&(i.Tag=s,i.DisplayName=_.ucwords(s,!0),i.searchText=s.toLowerCase()),r.Description&&(i.Description=r.Description),r.ShortDescription&&(i.ShortDescription=r.ShortDescription),this.set(i,n)},getSongs:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.Songs||!this.attributes.Songs instanceof n.Models.Collections.Songs?s.call(this,e,"Songs"):e.resolve(this.attributes.Songs),e},getArtists:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.Artists||!this.attributes.Artists instanceof n.Models.Collections.Artists?s.call(this,e,"Artists"):e.resolve(this.attributes.Artists),e},getAlbums:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.Albums||!this.attributes.Albums instanceof n.Models.Collections.Albums?s.call(this,e,"Albums"):e.resolve(this.attributes.Albums),e},getRelatedTags:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.RelatedTags||!this.attributes.RelatedTags instanceof n.Models.Collections.Tags?s.call(this,e,"RelatedTags"):e.resolve(this.attributes.RelatedTags),e},getDescription:function(){var e=$.Deferred();return this.attributes.Description||this.attributes.source==="getPageInfoByIDType"?e.resolve(this.attributes.Description||""):s.call(this,e,"Description"),e},getShortDescription:function(){var e=$.Deferred();return this.attributes.ShortDescription||this.attributes.source==="getPageInfoByIDType"?e.resolve(this.attributes.ShortDescription||""):s.call(this,e,"ShortDescription"),e},toUrl:function(e){return _.cleanUrl(this.get("DisplayName"),this.id,"genre",null,e)},getImageURL:function(e){e=_.orEqual(e,80);var t=_.getImageURL(n.Models.Tag.artPath+e+"_"+this.get("TagID")+".jpg");return this.get("CoverArtFilename")?_.getImageURL(n.Models.Tag.artPath+e+"_"+this.get("CoverArtFilename")):t},getRandomArtists:function(e){var t=this.get("Artists");if(!t||t.length===0)return[];var n=[],r=Math.min(e,t.length),i,s=[];while(n.length<r)i=Math.floor(Math.random()*t.length),_.indexOf(n,i)==-1&&n.push(i);for(i=0;i<r;i++)s.push(t.at(n[i]));return s},toProxyLabel:function(){return this.get("DisplayName")+" - "+_.getString("STATION")},playStation:function(){this.play()},play:function(e){var t=this.get("TagID"),i=$.Deferred();return this.getSongs().done(function(e){if(!e||!e.length){i.reject();return}var s=_.bind(function(){var s=r.model.get("player"),o=s.get("queue"),u=n.Models.Queue.shuffleSongsForRadio(new n.Models.Collections.PlayableSongs(e.toJSON())),a,f,l;l={host:o,secondaryArtistWeightModifier:.7,seedArtistWeightRange:[75,100],weightModifierRange:[-14,9]},a=new n.Models.Radio(l),f=a.get("songPool"),f.reset(u.models),f.on("reset remove",function(){if(f.length!==0)return;f.off(null,null,this);if(o.get("parasite")!==a)return;n.trigger("guts:startAutoplayFallbackContext","autoplay",0)}),i.resolve(e),n.trigger("guts:startNewAutoplayContext","tag",t),n.trigger("guts:log","autoplayOn",{stationType:"tag",tagID:t})},this);r.radioClearQueue(s)}).fail(function(){i.reject()}),i.promise()}},{artPath:"/static/genres/",topGenres:[{title:"60s",tag:"60s",artists:"",tagID:7512},{title:"70s",tag:"70s",artists:"",tagID:2360},{title:"80s",tag:"80s",artists:"",tagID:424},{title:"90s",tag:"90s",artists:"",tagID:10,important:1},{title:"Alternate Rock",tag:"alternative rock",artists:"",tagID:7096},{title:"Ambient",tag:"ambient",artists:"",tagID:75},{title:"Bachata",tag:"bachata",artists:"",tagID:6310},{title:"Classical",tag:"classical",artists:"",tagID:750},{title:"Classic Rock",tag:"classic rock",artists:"",tagID:3529},{title:"Chillout",tag:"chillout",artists:"",tagID:678},{title:"Country",tag:"country",artists:"",tagID:1933},{title:"Cumbia",tag:"cumbia",artists:"",tagID:4271},{title:"Electronic",tag:"electronic",artists:"",tagID:156,important:1},{title:"Dance",tag:"dance",artists:"",tagID:814},{title:"Hip Hop",tag:"hip hop",artists:"",tagID:3502},{title:"Indie Folk",tag:"indie folk",artists:"",tagID:6939},{title:"Indie Rock",tag:"indie rock",artists:"",tagID:3773,important:1},{title:"Jazz",tag:"jazz",artists:"",tagID:1749},{title:"K-Pop",tag:"k-pop",artists:"",tagID:7588},{title:"Pop Rock",tag:"pop rock",artists:"",tagID:3489},{title:"R&B",tag:"r&b",artists:"",tagID:7614},{title:"Rap",tag:"rap",artists:"",tagID:1748,important:1},{title:"Reggae",tag:"reggae",artists:"",tagID:160},{title:"Samba",tag:"samba",artists:"",tagID:4285},{title:"World",tag:"world",artists:"",tagID:313}],get:function(e){var t=Backbone.CachedModel.genericGet.call(this,i,"TagID",e);return t.promise()},getMulti:function(e){var t=$.Deferred(),r=[],i=[],s;for(var o=0,u=e.length;o<u;o++)s=this.getCached(e[o]),s&&s.attributes.pageInfoLoaded?r.push(s):i.push(e[o]);return i.length?n.Services.API.getPageInfoByIDsType(i,"tag").done(function(e){r=r.concat(n.Models.Tag.convertPageNamesToTags(e)),t.resolve(r)}).fail(function(){r.length?t.resolve(r):t.reject()}):t.resolve(r),t.promise()},getMetaMulti:function(e){var t=$.Deferred(),r=[],i=[],s;for(var o=0,u=e.length;o<u;o++)s=this.getCached(e[o]),s&&s.attributes.pageMetaInfoLoaded?r.push(s):i.push(e[o]);return i.length?n.Services.API.getPageMetaInfoByIDsType(i,"tag").done(function(e){r=r.concat(n.Models.Tag.convertPageNamesToTags(e)),t.resolve(r)}).fail(function(){r.length?t.resolve(r):t.reject()}):t.resolve(r),t.promise()},getTagsSampleSongs:function(e){var t=$.Deferred(),r=[],i=[],s;for(var o=0,u=e.length;o<u;o++)s=this.getCached(e[o]),s&&s.attributes.pageInfoLoaded?r.push(s):i.push(e[o]);return i.length?n.Services.API.getTagsSampleSongs(i).done(function(e){r=r.concat(n.Models.Tag.convertPageNamesToTags(e,!0)),t.resolve(r)}).fail(function(){r.length?t.resolve(r):t.reject()}):t.resolve(r),t.promise()},convertPageNamesToTags:function(e,t){var r=[],i,s,o,u,a,f;if(e.length)for(i=0,s=e.length;i<s;i++){u=e[i].ItemID;if(!u)continue;o=e[i].Data||{},o.TagID=u,o.pageMetaInfoLoaded=!0,f=!1,o.Tag?t?(o.Songs=_.orEqual(o.Songs,[]),o.sampleSongs=!0,f=!0):(o.Albums=_.orEqual(o.Albums,[]),o.Artists=_.orEqual(o.Artists,[]),o.RelatedTags=_.orEqual(o.RelatedTags,[]),o.pageInfoLoaded=!0):e[i].NameFormatted&&(n.Models.Tag.fixNameLookup[o.TagID]?o.TagName=_.ucwords(n.Models.Tag.fixNameLookup[o.TagID],!0):(a=e[i].NameFormatted.split("/"),o.TagName=a[1].replace(/\+/g," ").replace(/(\d+) s$/i,"$1s"),o.TagName=="R B"&&(o.TagName="R&B"))),r.push(n.Models.Tag.newOrUpdate(o,{noCache:f}))}return r},getTopLevelTags:function(){var e=$.Deferred();if(this.topLevel)e.resolve(this.topLevel);else{if(this.topLevelDfd&&this.topLevelDfd.state()=="pending")return this.topLevelDfd.promise();this.topLevelDfd=e,n.Services.API.getTopLevelTags().done(_.bind(function(t){$.isArray(t)?(this.topLevel=new n.Models.Collections.Tags(t),e.resolve(this.topLevel)):e.reject(t)},this)).fail(function(t){e.reject(t)})}return e.promise()},getTagList:function(){var e=$.Deferred();if(this.tagsList)e.resolve(this.tagsList);else{if(this.tagsListDfd&&this.tagsListDfd.state()=="pending")return this.tagsListDfd.promise();this.tagsListDfd=e,n.Services.API.getTagList().done(_.bind(function(t){if(t){var n={},r,i;for(i in t)t.hasOwnProperty(i)&&(n[t[i]]=i);this.tagsList=n,e.resolve(n)}else e.reject(t)},this)).fail(function(t){e.reject(t)})}return e.promise()},getSortedQueueTags:function(){var e=r.model.get("player").get("queue"),t=e&&e.get("songs"),i=t&&t.pluck("Tags"),s={},o=new n.Models.Collections.Tags;return!t||!t.length?o:(i=_.filter(i,function(e){return!!e}),_.each(i,function(e){e.each(function(e){var t=e.get("TagID");s[t]?s[t][1]+=1:s[t]=[e,1]})}),o.reset(_.pluck(_.sortBy(s,"1"),"0")),o)},fixNameLookup:{10:"90s",44:"Fusion",75:"Ambient",84:"Merengue",85:"Flamenco",89:"Vallenato",100:"Ska",102:"Oldies",104:"Instrumental",130:"Bhangra",131:"Emo",134:"Grunge",153:"Downtempo",156:"Electronic",160:"Reggae",162:"Electro",164:"Gothic",191:"Experimental",230:"Blues",245:"Hardcore",248:"Jungle",267:"Comedy",268:"Grime",269:"Dancehall",270:"Breakbeat",275:"Industrial",283:"Trance",313:"World",424:"80s",443:"Musicals",506:"Bollywood",510:"Synthpop",534:"Britpop",625:"Romantic",645:"Electronica",652:"Broadway",678:"Chillout",748:"Crunk",750:"Classical",787:"Salsa",790:"Latin",795:"Crossover",807:"Nerdcore",814:"Dance",820:"Baroque",893:"Electropop",898:"House",901:"Disco",919:"Urban",922:"Americana",940:"Reggaeton",957:"Celtic",963:"Traditional",975:"Mambo",1032:"Swing",1086:"Rockabilly",1102:"Shoegaze",1140:"Cabaret",1168:"Psychedelic",1210:"Mashup",1304:"Anime",1332:"Post-hardcore",1407:"Mariachi",1408:"Surf",1411:"Metal",1416:"Bolero",1430:"String",1489:"Gospel",1501:"Lo-fi",1535:"Opera",1599:"J-pop",1717:"Symphonic",1747:"Funk",1748:"Rap",1749:"Jazz",1750:"Soul",1933:"Country",1947:"Bluegrass",1965:"Screamo",2086:"Trova",2177:"Minimal",2195:"Cuarteto",2260:"Contemporary",2360:"70s",2412:"Techno",2482:"Piano",2536:"Bebop",2563:"Dubstep",2649:"Spiritual",2760:"Orchestra",2764:"Boogie",2856:"Rock",2868:"Tango",3124:"Thrash",3162:"Schlager",3454:"Rumba",3489:"Pop Rock",3502:"Hip Hop",3518:"Nu Jazz",3519:"Acid Jazz",3529:"Classic Rock",3598:"Singer-songwriter",3606:"Pagode",3625:"Hymn",3664:"New Age",3692:"Chanson",3698:"Avant-garde",3773:"Indie Rock",3855:"Smooth Jazz",3856:"Hard Rock",3907:"Oldskool",3922:"Trip Hop",3975:"Show Tunes",3984:"Heavy Metal",4009:"Soft Rock",4028:"Eurodance",4063:"Power Metal",4137:"Progressive Rock",4171:"Nu Metal",4271:"Cumbia",4274:"Hardstyle",4278:"Motown",4281:"Ragga",4283:"Rocksteady",4285:"Samba",4286:"Sertanejo",5805:"Afrobeat",6310:"Bachata",6367:"Chillwave",6369:"Chiptune",6437:"Electronic Rock",6439:"Electroswing",4657:"Folktronica",6462:"Freestyle",6484:"Glitch",6539:"Jota",6550:"Klasik",6635:"Parranda",6680:"Ranchera",6716:"Skweee",6719:"Soca",6771:"Turntablism",6794:"Zouk",6799:"Blues Rock",6834:"Big Band",6850:"Jazz Fusion",6869:"Cool Jazz",6873:"Latin Jazz",6875:"Brazilian Music",6878:"Soul Jazz",6879:"Jazz Funk",6893:"Roots Reggae",6897:"Post Punk",6903:"Reggae Dub",6928:"Punk",6938:"Folk Rock",6939:"Indie Folk",6980:"Breakbeat Hardcore",6994:"Pop Music",7e3:"Goa Trance",7004:"Psychedelic Trance",7008:"Vocal Trance",7025:"Tech House",7027:"Happy Hardcore",7030:"Drum & Bass",7036:"Progressive House",7038:"Electro House",7060:"Deep House",7061:"Funky House",7063:"Neo Soul",7066:"Rave Music",7071:"French Music",7075:"EDM",7077:"Alt Country",7085:"Southern Rock",7090:"Old-time Music",7091:"Country Rock",7096:"Alternative Rock",7109:"New Country",7120:"Folk Music",7121:"Garage Rock",7126:"UK Garage",7127:"Intelligent Dance Music",7139:"Electronic Body Music",7147:"Minimal Techno",7162:"Post-dubstep",7167:"Dance Pop",7176:"New Wave",7200:"Indie Electronic",7214:"Bubblegum Pop",7216:"Indie Pop",7226:"Boy Bands",7227:"Pop Punk",7248:"Post Rock",7252:"Black Metal",7253:"Death Metal",7273:"Metal Core",7319:"Christian Rock",7324:"Doo-wop",7333:"Ska Punk",7368:"Neo-Psychedelia",7393:"Old School Hip Hop",7399:"Gangsta Rap",7409:"Dirty South",7413:"Witch House",7420:"Christian Music",7463:"British Invasion",7469:"Medieval Music",7490:"Dark Wave",7512:"60s",7514:"Children's Music",7515:"Classic Country",7518:"Easy Listening",7520:"Latin Pop",7524:"90s Alternative Rock",7575:"Video Game Music",7579:"Contemporary Christian",7588:"K-pop",7607:"Italy",7614:"R&B",7623:"Vocal Music",7626:"Film Score",7647:"Modern Rock",7651:"Beach Music",7656:"Underground Hip Hop",7675:"Oi!",7699:"Bossa Nova",7711:"Quiet Storm",7756:"Japanese Music",7792:"Nu-folk",7824:"Asian Music",7830:"Sacred Music",7862:"Spanish Rock",7864:"Worship Music",7873:"String Quartet",7877:"Banda Music",7890:"Chicano Rap",7894:"Rock N' Roll",7909:"Dirty Blues",7970:"Acoustic Guitar",7974:"Jesus Music",8024:"Jazz Guitar",8141:"Pachanga",8143:"Salsa Romantica",8183:"Slow Jam",8191:"Turkish Music",8488:"Christmas Music",8497:"Trap",8498:"Synthwave",8499:"Vaporwave",8500:"Alternative R&B",8501:"Big Room"},lowIDFs:[2856,10,102,160,230,424,750,787,814,898,1411,1704,1748,1749,1750,1755,1933,2412,2563,3502,6928,6994,7517,7614,7621,104,162,283,645,678,3529]})}(),function(){function l(){this.trigger("mark30",arguments)}function h(e){var t=e;e&&!(e instanceof n.Models.Song)&&(t=n.Models.Song.getCached(t.get("SongID"))),n.trigger("player:songCompleted",e,t)}function E(){var e=arguments[arguments.length-1];!e||!e.internal}n.Models=n.Models||{};var e=2e4,i=5e3,s,o=function(e,t,n){var r=n||{};if(!t){this.set({_previousSongs:[],_nextSongs:[],_pendingSongs:[]}),r.ignorePreviousActiveSong=!0,f.call(this,r);return}var i=this.get("songs").toArray(),o=this.get("activeSong");if(!o||!r.fromRestore&&(o.get("playStatus")===s.NONE||o.get("playStatus")===s.COMPLETED))o=_.sample(i);this.set({activeSong:o,hasPreviousSong:!1,hasNextSong:!1,previousSong:null,nextSong:null,_previousSongs:[],_nextSongs:[],_pendingSongs:i}),r.ignorePreviousActiveSong=!0,f.call(this,r)},u=function(e,t,n){n.ignorePreviousActiveSong=!0,f.call(this,n)},a=function(t,r){var i=t.changed,o=this.get("activeSong"),u=n.Models.Player.repeatModes,f=this.get("repeatMode"),l=this.get("blockNextSong"),c=i.playStatus&&i.playStatus===s.COMPLETED,p=i.playStatus&&i.playStatus===s.FAILED,d=_.toInt(i.position&&t.attributes.duration&&t.attributes.duration-i.position),v,m;c?this.consecutiveSongFailures=0:p&&this.consecutiveSongFailures++;if(o!=t){console.log("listener was not removed properly"),t.off("change",a,this);return}d&&d<e&&(v=this.get("nextSong"),v&&v!==o&&v.load()),this.get("crossfadeEnabled")&&!l&&d&&d<n.Models.PlayableSong.crossfadeLength&&f!==u.ONE&&(v=this.get("nextSong"),m=this.get("crossfadeSong"),v&&v!==m&&(m&&(m.stop(),m.off("fadeInComplete",null,this)),this.set("crossfadeSong",v),v.once("fadeInComplete",function(){v.off("fadeInComplete",null,this),setTimeout(_.bind(function(){var e=this.get("activeSong"),t=this.get("crossfadeSong");v===t&&o===e&&(console.log("crossfade complete forcing next song"),this.playSong(v,{noReset:!0}))},this),1e3)},this),v.play({crossFade:!0}))),c&&o&&h(o);if(c&&f===u.ONE)l||this.playSong(o);else if(c||p&&this.consecutiveSongFailures<4)this.trigger("playNextSong"),_.gaTrackEvent("queue","songCompleted")},f=function(e){var t=e||{},r=this.get("activeSong"),i=this.get("songs"),o=this.get("shuffle"),u=this.get("repeatMode"),a=this.get("_previousSongs")||[],f=this.get("_pendingSongs")||[],l=this.get("_nextSongs")||[],c=this.previous("activeSong")||this.get("previousSong"),h=n.Models.Player.repeatModes,p=r&&i.indexOf(r)||0,d=u===h.ALL,v,m;t.ignorePreviousActiveSong||t.fromClear?c=null:c===r&&(!d||i.length>1)?c=null:i.get(c)||(c=null),m=_.indexOf(f,r),m>=0&&f.splice(m,1),m=_.indexOf(l,r),l.length&&m>=0&&l.splice(m,1);if(o)if(l.length)v=l[0],t.fromAdd&&t.index!==n.Models.Player.playSpecialIndexes.NEXT&&l.length===1&&v.get("playStatus")===s.NONE&&(f.push(v),v=_.sample(f),l.splice(0,1,v)),t.goingBack&&(c=a[a.length-1]);else{var g=o&&d&&i.length;g&&i.length<=2?f=[(i.at(1)==r?i.at(0):i.at(1))||r]:g&&!f.length&&(f=i.toArray(),m=_.indexOf(f,c),m>=0&&i.length>3&&f.splice(m,1),m=_.indexOf(f,r),m>=0&&f.splice(m,1)),v=_.sample(f),d&&!c&&(c=_.sample(f))}else c=i.at(p-1),v=i.at(p+1),d&&(c||(c=i.last()),v||(v=i.first()));c&&(a[a.length-1]!==c&&a.push(c),m=_.indexOf(f,c),m>=0&&f.splice(m,1)),this.set({hasPreviousSong:c?!0:!1,hasNextSong:v?!0:!1,previousSong:c||null,nextSong:v||null,_pendingSongs:f})},c=function(e,t,n){var r=this.previous("activeSong"),i=this.get("crossfadeSong"),o=this.get("currentBroadcast");r&&(r.off("change",a,this),r.off("mark30",l,this),r!==i&&r.stop()),t&&(!o&&t.get("playStatus")===s.FAILED&&this.consecutiveSongFailures<4&&this.trigger("playNextSong"),t.on("change",a,this),t.on("mark30",l,this)),f.call(this,n)},p=_.debounce(function(e,t){var n=e.get("activeSong");n&&e.playSong(n,t)},10),d=function(e,t,r){var i=this.get("activeSong"),s=this.get("crossfadeSong"),o=n.Models.Player.isPlayStatusPlaying(i&&i.get("playStatus")),u=this.get("nextSong"),a=this.get("_nextSongs"),l=this.get("previousSong"),c=this.get("_pendingSongs");_.remove(c,e),_.remove(a,e),e.stop(),s&&s===e&&(e.off("fadeInComplete",null,this),this.set("crossfadeSong",null)),i&&i===e?(i=u||l||null,this.set("activeSong",i),o&&u&&p(this,{noReset:s&&u===s})):f.call(this,r)},v=function(e,t){var n=t||{},r=this.get("_previousSongs"),i=this.get("_nextSongs"),s=this.get("activeSong"),o=this.get("nextSong"),u=this.get("previousSong"),a=this.get("shuffle"),l={},c,h,p;if(n.fromClear)return;for(h=0,p=r.length;h<p;h++)e.get(r[h])||(r.splice(h,1),h--,p--);for(h=0,p=i.length;h<p;h++)e.get(i[h])||(i.splice(h,1),h--,p--);s&&!e.get(s)&&(a?l.activeSong=_.sample(e):l.activeSong=e.at(0)),u&&!e.get(u)&&(l.previousSong=null),o&&!e.get(o)&&(l.nextSong=null),c=r.concat(i),l.activeSong&&c.push(l.activeSong),l._pendingSongs=_.difference(e.models,c),this.set(l),f.call(this,t)},m=function(e){n.External.DesktopBridge.active&&e&&e.msg==="MEDIA_ERR_SRC_NOT_SUPPORTED"?n.trigger("lightbox:open","flashRequired"):n.Services.AudioHandle.canUseAudioAPI()||_.getFlashObjectDfd("html5ShimSwf","makeHandle").fail(function(){n.trigger("lightbox:open","flashRequired")})},g=function(){this.off(null,null,this),this.songs.off(null,null,this),this.songs=null,this.clearParasite()},y=function(e,t,n){var r=this.previous("parasite");r&&r.trigger("detached",this),t&&t.trigger("attached",this,n)},b=function(e,t){e._previousSongs=e.playedSongs,e._pendingSongs=e.pendingSongs,w.call(this,e,t)},w=function(e,t){var r=this.get("songs"),i=e._previousSongs||[],s=e._nextSongs||[],o=e._pendingSongs||[],u=this.get("_previousSongs"),a=this.get("_nextSongs"),f=this.get("_pendingSongs"),l={},c=[],h={},p=e.songs||[],d=new n.Models.PlayContext,v,m,g,y;d.addDefaultType();for(v=0,m=t.length;v<m;v++)h[t[v].SongID]=t[v];for(v=0,m=p.length;v<m;v++){y=p[v],g=h[y.songID];if(!g||!y)continue;g=_.extend(y,g),g.context=g.context&&g.context.fromStored?new n.Models.PlayContext(g.context):d,c.push(g)}c=n.Models.Player.generateQueueSongs(c),r.reset(c,{internal:!0}),e.activeSong&&(l.activeSong=r.get(e.activeSong)),e.previousSong&&(l.previousSong=r.get(e.previousSong)),e.nextSong&&(l.nextSong=r.get(e.nextSong)),(!i.length||!o.length)&&!e.shuffle&&l.activeSong&&(v=r.indexOf(l.activeSong),i.length||(i=r.slice(0,v)),o.length||(o=r.slice(v+1)));for(v=0,m=i.length;v<m;v++){g=r.get(i[v]);if(!g||g===l.activeSong)continue;u.push(g)}for(v=0,m=s.length;v<m;v++){g=r.get(s[v]);if(!g||g===l.activeSong)continue;a.push(g)}for(v=0,m=o.length;v<m;v++){g=r.get(o[v]);if(!g)continue;f.push(g)}this.set(l,{fromRestore:!0})},S=function(e){var n=[t,"add","remove","move"],r,i,s,o;return r=parseInt(e.checksum,16),r?(o=r&15,i=r>>>4&1023,s=n[o],s?{action:s,songs:e.songs,changeIncr:i,queueChecksum:e.queueChecksum,options:e.options||{}}:(console.error("Received invalid action",r),this.refreshQueueAfterUpdateFail(),null)):(console.error("Received invalid checksum number: ",e.checksum),null)};n.Models.Queue=Backbone.Model.extend({parse:function(e,r){if(r&&r.skipParse)return e;var i=e||{},s=r||{},o=i.activeSong,u=i.previousSong,a=i.nextSong,f=i.songs,l=i.shuffle,c=i.repeatMode,h;i.fromJSQueue?(o=null,f=t,i.shuffle=i.shuffleEnabled,l=i.shuffle,i.songs&&i.songs.length&&(h=_.pluck(i.songs,"songID"),this.restoreAttrs=i,this.restoreDfd=n.Services.API.getQueueSongListFromSongIDs(h))):i.isStoredQueue&&(a=u=o=null,f=null,h=_.pluck(i.songs,"songID"),this.restoreAttrs=i,this.restoreDfd=n.Services.API.getQueueSongListFromSongIDs(h));if(!f||!(f instanceof n.Models.Collections.PlayableSongs))f=new n.Models.Collections.PlayableSongs(f||t,s);return f._prepareModel=function(e,t){var r=_.extend({},this._modelOptions,t)||this._modelOptions||{};return n.Models.Queue.buildSong(e,r)},{songs:f,queueID:i.queueID,activeSong:n.Models.Queue.buildSong(o),previousSong:n.Models.Queue.buildSong(u),nextSong:n.Models.Queue.buildSong(a),repeatMode:!!c||!1,shuffle:!!l||!1,parasite:i.parasite||null,isBroadcasting:!1,_previousSongs:[],_nextSongs:[],_pendingSongs:[]}},initialize:function(){var e=!1;this.restoreDfd&&(this.restoreAttrs.fromJSQueue?this.restoreDfd.done(_.bind(b,this,_.clone(this.restoreAttrs))):this.restoreDfd.done(_.bind(w,this,_.clone(this.restoreAttrs))),this.restoreDfd=null,this.restoreAttrs=null,e=!0),s=n.Models.Player.playStatuses,this.songs=this.get("songs"),this.songs.on("add remove reset",E,this),this.songs.on("remove",d,this),this.songs.on("reset move",v,this),this.songs.on("error",m,this),this.on("change:shuffle",o,this),this.on("change:repeatMode",u,this),this.on("change:activeSong",c,this),this.on("change:parasite",y,this),this.on("playNextSong",this.nextSong,this),this.on("destroy",g,this);var t=this.get("parasite"),r=this.get("shuffle");t&&t.trigger("attached",this),r&&o.call(this,this,r,{fromRestore:e}),this.songs&&f.call(this)},addSongs:function(e,t){var r=t||{},i=_.orEqual(r.index,n.Models.Player.playSpecialIndexes.DEFAULT),s={internal:!0},u=this.get("activeSong"),a=this.get("shuffle"),l=this.get("_nextSongs"),c=this.get("_pendingSongs"),h=!1,p=!1,d;if(i===n.Models.Player.playSpecialIndexes.PREVIEW){n.trigger("lightbox:open","previewSong",{songs:(new n.Models.Collections.Songs(e,{dontCache:!0})).models,playContext:context,playOnAdd:r.playOnAdd,showPlayerControls:!0,_showPlayerControls:!0}),n.trigger("guts:log","broadcastPreviewSong",{songIDs:e.pluck("SongID")});return}s.context=r.context,i>=0&&(s.at=i),i===n.Models.Player.playSpecialIndexes.REPLACE&&(this.clear(),h=!0,i=n.Models.Player.playSpecialIndexes.DEFAULT);if(i===n.Models.Player.playSpecialIndexes.DEFAULT||i===n.Models.Player.playSpecialIndexes.NEXT){if(u){var v=this.songs.indexOf(u);v>=0&&(s.at=v+1)}}else i===n.Models.Player.playSpecialIndexes.SHUFFLE?(this.set("shuffle",!0),a=!0,p=!0,r.playOnAdd=!0,i=n.Models.Player.playSpecialIndexes.DEFAULT):i==n.Models.Player.playSpecialIndexes.LAST&&(s.at=-1);this.songs.add(e,s),i===n.Models.Player.playSpecialIndexes.NEXT?(a&&(e=_.randomizeArray(e)),l.unshift.apply(l,e)):c.push.apply(c,e),a?d=_.sample(e):d=e[0],r.playOnAdd?this.playSong(d):!u&&this.songs.length&&this.set("activeSong",d),r.fromAdd=!0,h&&a||p?o.call(this,this,a,r):f.call(this,r)},removeSongs:function(e,t){var n=t||{};n.internal=!0,this.songs.remove(e,n)},moveSongs:function(e,t,n){var r=n||{};r.internal=!0,this.songs.move(e,t,r)},resetSongs:function(e,t){var r=t||{},i=e.length,s=new Array(i),o,u;for(o=0;o<i;o++)u=e[o],u instanceof n.Models.PlayableSong?s[o]=this.songs.get(u)||u:u.queueSongID?s[o]=this.songs.get(u.queueSongID)||u:s[o]=u;r.internal=!0,this.songs.reset(s,r)},seekActiveSongTo:function(e,t){var n=this.get("activeSong"),r=n&&n.get("position"),i=this.get("crossfadeSong");n&&n.seekTo(e),i&&e<r&&(i.stop(),i.off("fadeInComplete",null,this),this.set("crossfadeSong",null))},pause:function(e){var t=this.get("activeSong"),r=this.get("crossfadeSong");if(this.get("currentBroadcast")&&t){t.suspend(!0),n.trigger("player:volumeMute",!0);return}t&&t.pause(),r&&r.pause()},resume:function(e){var t=this.get("activeSong"),r=this.get("crossfadeSong");if(t&&t._suspended)return t.unsuspend(),n.trigger("player:volumeMute",!1),!0;t&&t.resume(),r&&r.resume()},stop:function(e){var t=this.get("activeSong"),n=this.get("crossfadeSong");t&&t.stop(),n&&n.stop()},clear:function(e){var t=e||{},n=t.activeSong||null,r=this.get("activeSong"),i={activeSong:n,crossfadeSong:null,hasPreviousSong:!1,hasNextSong:!1,previousSong:null,nextSong:null,_previousSongs:[],_nextSongs:[],_pendingSongs:[]},s=[];t.fromParasite||(i.parasite=null),_.extend(t,{internal:!0,fromClear:!0}),n!==r&&this.stop(),this.set(i,t),n&&s.push(n),this.songs.reset(s,t)},getStorableQueue:function(){var e=this.get("songs"),t=[],n=this.get("activeSong"),r=this.get("previousSong"),i=this.get("nextSong"),s,o,u,a;for(s=0,o=e.length;s<o;s++)u=e.at(s),a=u.get("context"),u={autoplayVote:u.get("autoplayVote"),context:a&&a.getStorable(),queueSongID:u.get("queueSongID"),songID:u.get("SongID"),source:u.get("source"),sponsoredAutoplayID:u.get("sponsoredAutoplayID")},t.push(u);return{songs:t,activeSong:n&&n.get("queueSongID"),previousSong:r&&r.get("queueSongID"),nextSong:i&&i.get("queueSongID"),repeatMode:!!this.get("repeatMode"),shuffle:!!this.get("shuffle"),_previousSongs:_.pluck(this.get("_previousSongs"),"id"),_nextSongs:_.pluck(this.get("_nextSongs"),"id"),_pendingSongs:_.pluck(this.get("_pendingSongs"),"id"),isStoredQueue:!0}},nextSong:function(e){var t=e||{},n=this.get("activeSong"),r=this.get("nextSong"),i=this.get("crossfadeSong"),s=this.get("blockNextSong");if(!r)return;n&&n.stop(),i&&i!==r&&(i.stop(),i.off("fadeInComplete",null,this),this.set("crossfadeSong",null)),this.set({activeSong:r}),s?i&&i.stop():this.playSong(r,_.extend({},t,{noReset:i===r,skipShuffle:!0}))},previousSong:function(){var e=this.get("activeSong"),t=this.get("previousSong"),n=this.get("crossfadeSong"),r=this.get("_previousSongs"),s=this.get("_nextSongs"),o=t&&r.lastIndexOf(t);n&&(n.stop(),n.off("fadeInComplete",null,this),this.set("crossfadeSong",null));if(e&&e.get("position")>=i){e.seekTo(0);return}if(!t)return;e&&(e.stop(),s.unshift(e)),o>=0&&r.splice(o,1),this.set({activeSong:t},{goingBack:!0}),this.playSong(t,{skipShuffle:!0})},playSong:function(e,t){var r=this.get("activeSong"),i=this.get("crossfadeSong"),u=this.get("shuffle"),a=r&&r._suspended,f=t||{},l,c;if(!e){console.log("no song passed to playSong",arguments);return}e.get?l=this.songs.get(e.get("queueSongID")):l=this.songs.get(e),l||(l=n.Models.Queue.buildSong(e)),l?(r&&r!==l&&r.stop(),i&&(i!==l&&i.stop(),i.off("fadeInComplete",null,this),this.set("crossfadeSong",null)),c=l.get("playStatus"),(c===s.COMPLETED||c===s.FAILED)&&l.set("playStatus",s.NONE),this.set({activeSong:l}),l.play(f),u&&!this.get("nextSong")&&!f.skipShuffle&&o.call(this,this,u,f),a&&l.suspend(r.get("paused"))):console.log("missing playableSong",e)},clearParasite:function(){this.parasite&&this.set({parasite:null})},calculateChecksum:function(){var e=this.get("songs");return crc32(e.models)},handleRemoraQueueReset:function(e,t,n){var i=r.model.get("manatee"),s=e.options||{},o;return!e||e.changeIncr==null||!_.isArray(e.songs)?!1:this.get("isSyncing")?(o=this.get("pendingRemoraUpdates"),o||(o=[],this.set("pendingRemoraUpdates",o)),o.push({type:"reset",update:e,allowFromSelf:t,src:n}),!0):(this.set("changeIncr",e.changeIncr,{silent:!0}),!t&&i&&s.uid===i.getPublicUID()?!0:(this.resetSongs(e.songs,s),!0))},handleRemoraQueueUpdate:function(e,i){var s=this.get("songs"),o=r.model.get("manatee"),u=this.get("changeIncr")||0,a=e.options||{},f=i||{},l,c,h,p;if(!s||!e||!e.songs)return!1;if(this.get("isSyncing"))return p=this.get("pendingRemoraUpdates"),p||(p=[],this.set("pendingRemoraUpdates",p)),p.push({type:"update",update:e,src:i}),!0;u>=1024?c=0:c=u+1,this.set("changeIncr",c,{silent:!0}),l=S(e);if(!l)return this.trigger("outOfSync"),!1;if(u!==l.changeIncr)return console.error("Received invalid changeIncr",u,l),this.trigger("outOfSync"),!1;if(!o||a.uid!==o.getPublicUID())switch(l.action){case"add":s.add(l.songs,{at:l.options.index||t,internal:!0,skipSyncing:!0});break;case"move":s.move(l.songs,l.options.index,{internal:!0,skipSyncing:!0});break;case"remove":s.remove(l.songs,{internal:!0,skipSyncing:!0});break;default:return this.trigger("outOfSync"),n.Services.Log.notify("Received invalid queue sync action","ERROR",_.extend({},f,{action:l.action})),!1}return h=this.calculateChecksum(),h!==l.queueChecksum?(console.error("Queue checksum mismatch",h,l.queueChecksum,l),n.Services.Log.notify("Queue sync checksum mismatch","ERROR",_.extend({},f,{action:l.action})),!1):!0},resetSongsFromRemoraFullQueue:function(e){if(!e||!e.songs)return!1;var t=e.songs.length,r=new Array(e.songs.length),i;for(i=0;i<t;i++)r[i]=n.Models.Song.convertManateeSongCalloutProperties(e.songs[i]);return this.resetSongs(r,{skipSyncing:!0}),this.set({changeIncr:e.changeIncr,isSyncing:!1,pendingRemoraUpdates:[]}),e.queueChecksum&&this.calculateChecksum()!==e.queueChecksum&&(console.error("Queue checksum mismatch after fullQueue",e),n.Services.Log.notify("Queue checksum mismatch after fullQueue","ERROR")),!0},setSyncing:function(e){var t=this.get("pendingRemoraUpdates"),n=!1,r;this.set("isSyncing",e);if(t&&!e){while(t&&!n&&(r=t.shift()))switch(r.type){case"reset":this.handleRemoraQueueReset(r.update,r.allowFromSelf,r.src)||(n=!0);break;case"update":this.handleRemoraQueueUpdate(r.update,r.src)||(n=!0)}t.splice(0,t.length)}n&&this.trigger("outOfSync")}},{buildSong:function(e,t){var r=e;if(e&&!(e instanceof n.Models.PlayableSong)){var i;e instanceof n.Models.Song?e._wrapped?i=e._wrapped.attributes:i=e.attributes:i=e,i&&(r=new n.Models.PlayableSong(i,t))}return r||null},shuffleSongsForRadio:function(e){var t=_.shuffle(e.take(Math.floor(e.length*.5))),r=_.shuffle(e.drop(Math.ceil(e.length*.5)));return new n.Models.Collections.Songs(t.concat(r))},sortSongsForRadio:function(e,t){t=_.defaults(t||{},{disperseArtists:!0,disperseAlbums:!0,shuffle:!0});var n=[],r=[],i=Math.floor(e.length*.5),s=e.take(i),o=e.drop(i),u=[],a=[],f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;t.shuffle?(s=_.shuffle(s),o=_.shuffle(o),f=s.concat(o)):f=e.models,f=new e.constructor(f);if(t.disperseArtists||t.disperseAlbums)for(l=0,c=f.length;l<c;l++){y=f.models[l],m=y.get("ArtistID"),g=y.get("AlbumID"),d=_.lastIndexOf(n,m),v=_.lastIndexOf(n,m);if(t.disperseArtists&&d!==-1&&d<n.length-5||t.disperseAlbums&&v!==-1&&v<r.length-5)b=y;if(!b){S=y,w=n.slice(-5),E=r.slice(-5);for(h=0,p=a.length;h<p;h++){y=a[h],m=y.get("ArtistID"),g=y.get("AlbumID"),x=t.disperseArtists&&_.indexOf(w,m)==-1||!t.disperseArtists,x=t.disperseAlbums&&_.indexOf(E,g)==-1||!t.disperseAlbums;if(x){b=y;break}}a.push(S)}b&&(u.push(b),n.push(m),r.push(g),b=null)}return a.length&&(t.shuffle&&(a=_.shuffle(a)),u.push.apply(u,a)),u.length&&f.reset(u),f}})}(),function(){n.Models=n.Models||{};var e,i,s={duration:0,position:0,playStatus:0},o=function(e,t){var r=[],i;for(var s=0,o=e.length;s<o;s++)e[s]instanceof n.Models.Song||e[s]instanceof n.Models.Callout?i=e[s]:e[s]._wrapped&&(e[s]._wrapped instanceof n.Models.Song||e[s]._wrapped instanceof n.Models.Callout)?i=e[s]._wrapped:e[s].CalloutID?i=n.Models.Callout.newOrUpdate(e[s]):i=n.Models.Song.newOrUpdate(e[s]),i=_.clone(i.attributes),i.context=t||e[s].context,i.source=e[s].source,i.autoplayVote=e[s].autoplayVote,i.sponsoredAutoplayID=e[s].sponsoredAutoplayID,i.queueSongID=e[s].queueSongID,r.push(new n.Models.PlayableSong(i));return r},u=n.Models.Player=Backbone.Model.extend({allowRestore:!1,parse:function(e,t){if(t&&t.skipParse)return e;var r={volume:1,isMuted:!1,crossfadeAmount:0,crossfadeEnabled:!1,playPauseFade:!1,lowerQuality:!1,position:0,duration:0,bytesLoaded:0,bytesTotal:0,playStatus:0,queue:this.queue,previousQueue:!1,expectManualSongChange:!1,isJoiningBroadcast:!1,uiMode:"normal",shuffle:!1,persistSettings:!1,repeatMode:0,autoplay:!1,blockNextSong:!1,flattr:!0,fallbackQueue:null},i={};return _.defaults(i,e,r),i.queue||(i.queue=new n.Models.Queue),i},initialize:function(t,r){var i=r||{},s=this,o,u;this.queue=this.get("queue"),this.muteLocks={},this.preLockMuteValue=!1,this.preLockVolume=1,e=i.appModel||e;var a=location.hash.match(/^#!?\/s(?:ong)?\/(.*)\/?/);a?(o=a[0],u=o.replace(/\?([^#]*)$/,""),this.allowRestore=!1,this.songToPlayOnReadyToken=u.split("/")[3]):this.allowRestore=!0,this.on("change",this.onOptionsChange),this.onOptionsChange({changed:this.attributes},{}),n.on("player:volumeChange",this.setVolume,this),n.on("player:volumeMute",this.toggleVolumeMute,this),n.on("player:crossfade",this.toggleCrossfade,this),n.on("player:moveSongs",this.moveSongsTo,this),n.on("player:addSongs",this.addSongs,this),n.on("player:addSongsEx",this.addSongsEx,this),n.on("player:removeSongs",this.removeSongsWrapper,this),n.on("player:removeSpecific",this.removeSpecificSong,this),n.on("player:playSong",this.playSong,this),n.on("player:pauseSong",this.pauseSong,this),n.on("player:stopSong",this.stopSong,this),n.on("player:resumeSong",this.resumeSong,this),n.on("player:togglePlay",this.togglePlay,this),n.on("player:shuffle",this.toggleShuffle,this),n.on("player:repeat",this.toggleRepeat,this),n.on("player:nextSong",this.playNextSong,this),n.on("player:previousSong",this.playPreviousSong,this),n.on("player:seekTo",this.seekTo,this),n.on("player:clear",this.clearQueue,this),n.on("player:restore",this.restoreQueue,this),n.on("player:radio",this.setAutoplay,this);var f=n.Services.Local.get("storedQueue"),l=n.Services.Local.get("storedVolume"),c=n.Services.Local.get("storedMute");_.defined(l)&&this.setVolume(l),_.defined(c)&&this.setIsMuted(c);if(f){if(f.songs){this.set({previousQueue:!0,storedQueue:f});var h=n.Models.PlayableSong;_.each(f.songs,function(e){h.highestQueueSongID<e.queueSongID&&(h.highestQueueSongID=e.queueSongID)})}}else _.getFlashObjectDfd("html5ShimSwf","getFlashCookieData").done(_.bind(function(e){var t=e.getFlashCookieData();t&&t.lastQueue?(f=t.lastQueue,f.fromJSQueue=!0,s.set({previousQueue:!0,storedQueue:f})):f={},n.Services.Local.set("storedQueue",f),t&&t.volume&&this.setVolume(t.volume/100)},this));e.on("change:user",this.onUserChange,this),this.onUserChange(e,e.get("user")),this.on("change:shuffle",function(){this.queue.set("shuffle",this.get("shuffle"))},this),this.on("change:repeatMode",function(){this.queue.set("repeatMode",this.get("repeatMode"))},this),this.queue.set({repeatMode:this.get("repeatMode"),shuffle:this.get("shuffle")})},onUserChange:function(e,t){if(!i&&!t)return;i&&i.off("change:settings",this.onUserSettingsChange,this),i=t,i&&(i.on("change:settings",this.onUserSettingsChange,this),this.onUserSettingsChange(i,i.get("settings")))},onUserSettingsChange:function(e,t){if(!i)return;var r=t.local;!!r.crossfadeEnabled!==this.attributes.crossfadeEnabled&&this.setCrossfadeEnabled(r.crossfadeEnabled),_.toInt(r.crossfadeAmount)!==n.Models.PlayableSong.crossfadeLength&&this.setCrossfadeAmount(_.toInt(r.crossfadeAmount)),!!r.playPauseFade!==n.Models.PlayableSong.pauseFade&&this.setPlayPauseFade(r.playPauseFade),!!r.lowerQuality!==n.Models.PlayableSong.useMobile&&this.setLowerQuality(r.lowerQuality),!r.clearPlayerSettings!==this.attributes.persistSettings&&this.set("persistSettings",!r.clearPlayerSettings),!r.clearPlayerSettings&&!!r.shuffleEnabled!==this.attributes.shuffle&&this.setShuffle(r.shuffleEnabled),this.setPlayerKeyShortcuts(!r.disablePlayerShortcuts)},setPlayerKeyShortcuts:function(e){function i(e){var t=$(e.target);return t.is("input,textarea,select")||t.attr("contenteditable")}var t=$(document),r=this;t.unbind(".playerShortcut"),e&&(t.bind("keyup.playerShortcut.playerShortcutPause","space",function(e){$(e.target).is("button")&&e.preventDefault()}),t.bind("keydown.playerShortcut.playerShortcutPause","space",function(e){if(i(e))return;return n.trigger("player:togglePlay"),_.gaTrackEvent("player","playPauseShortcut"),!1}),t.bind("keydown.playerShortcut.playerShortcutNext","ctrl+right",function(e){if(i(e))return;return n.trigger("player:nextSong"),_.gaTrackEvent("player","nextShortcut"),!1}),t.bind("keydown.playerShortcut.playerShortcutNext","meta+right",function(e){if(i(e))return;return n.trigger("player:nextSong"),_.gaTrackEvent("player","nextShortcut"),!1}),t.bind("keydown.playerShortcut.playerShortcutPrevious","ctrl+left",function(e){if(i(e))return;return n.trigger("player:previousSong"),_.gaTrackEvent("player","prevShortcut"),!1}),t.bind("keydown.playerShortcut.playerShortcutPrevious","meta+left",function(e){if(i(e))return;return n.trigger("player:previousSong"),_.gaTrackEvent("player","prevShortcut"),!1}),t.bind("keydown.playerShortcut.playerShortcutVolumeUp","ctrl+up",function(e){if(i(e))return;return r.setVolume(Math.min(100,r.getVolume()+5)),n.trigger("player:volume:keychange"),_.gaTrackEvent("player","volumeUpShortcut",r.getVolume()),!1}),t.bind("keydown.playerShortcut.playerShortcutVolumeUp","meta+up",function(e){if(i(e))return;return r.setVolume(Math.min(100,r.getVolume()+5)),n.trigger("player:volume:keychange"),_.gaTrackEvent("player","volumeUpShortcut",r.getVolume()),!1}),t.bind("keydown.playerShortcut.playerShortcutVolumeDown","ctrl+down",function(e){if(i(e))return;return r.setVolume(Math.max(0,r.getVolume()-5)),n.trigger("player:volume:keychange"),_.gaTrackEvent("player","volumeDownShortcut",r.getVolume()),!1}),t.bind("keydown.playerShortcut.playerShortcutVolumeDown","meta+down",function(e){if(i(e))return;return r.setVolume(Math.max(0,r.getVolume()-5)),n.trigger("player:volume:keychange"),_.gaTrackEvent("player","volumeDownShortcut",r.getVolume()),!1}))},addSongsEx:function(e,r){var i=r?r.playOnAdd:!0,s=r&&r.index,o=r&&r.context,u=r&&r.autoplayOnAdd||!1,a=r&&r.skipPrompt||!1;_.isNumber(s)||(s=n.Models.Player.playSpecialIndexes.DEFAULT),r&&(r.streamTypes?o.addStreamTypes(r.streamTypes):r.streamType!==t&&o.addStreamType(r.streamType)),n.trigger("tutorial:QueueTab"),this.addSongs(e,s,i,o,u,a)},addSongs:function(e,t,r,i,s,a){var f=[],l=[],c=this.queue.get("parasite"),h=c instanceof n.Models.Broadcast?c:null,p=this.queue.get("isBroadcasting"),d=this.playStatusIsPlaying(!0),v=t,m=!1,g,y,b,w,E,S;t=_.orEqual(t,u.playSpecialIndexes.DEFAULT),r=_.orEqual(r,!1),i=_.orEqual(i,null),_.isNull(i)&&(i=new n.Models.PlayContext),s=_.orEqual(s,!1),e.models&&(e=e.models),e.length>1e3&&(n.trigger("notification:add",{description:_.getString("ERROR_TOO_MANY_SONGS"),type:"error",duration:5e3}),e=_.take(e,1e3));if(!e.length)return console.log("tried to play no songs"),$.Deferred().reject();g=e[0];if(g.attributes)_.each(e,function(e){f.push(e.get("SongID"))}),l=e;else if(_.isNumber(g)){for(b=0,w=e.length;b<w;b++)g=n.Models.Song.getCached(e[b]),g?(l.push(g),f.push(g.get("SongID"))):console.log("unable to find song",f[b]);if(!l.length)return console.log("tried to play songs but none cached",e),$.Deferred().reject()}y={songIDs:f},t==u.playSpecialIndexes.PREVIEW?m=!0:!a&&h&&(r&&d&&p?m=!0:p||(m=!0));if(h&&h.get("isSuspended")){n.Views.Notification.error(_.getString("POPUP_CANT_PLAY_SONGS_WHILE_BROADCAST_SUSPENDED"),{duration:3e4,url:h.toUrl()});return}if(m){S=(new n.Models.Collections.Songs(l,{dontCache:!0})).models,n.trigger("lightbox:open","previewSong",{index:t,songs:S,playContext:i,playOnAdd:r,showPlayerControls:!0,_showPlayerControls:!0}),n.trigger("guts:log","broadcastPreviewSong",y);return}if(_.isObject(g)&&g instanceof n.Models.PlayableSong&&this.queue.songs.get(g.get("queueSongID"))){this.playSong(g);return}return E=o(l,i),this.queue.addSongs(E,{index:t,manual:!0,playOnAdd:r,skipPreviewPrompt:a,autoplayOnAdd:s}),r&&this.set({expectManualSongChange:!0}),n.trigger("guts:log","songsQueued",{songIDs:f,atIndex:v,playOnAdd:r,autoplayOnAdd:s}),$.Deferred().resolve()},playSong:function(e,t){var r=this.queue.get("songs"),i=!1,s=this.get("playStatus");if(_.isUndefined(e)){i=!0,e=this.queue?this.queue.get("activeSong"):!1;if(!e)return}var o=typeof e=="number"?e:e.get("queueSongID");i&&s===n.Models.Player.playStatuses.PAUSED?this.resumeSong():this.queue.playSong(o,t)},pauseSong:function(){this.queue.pause()},removeSongsWrapper:function(e){return this.queue.removeSongs(e)},removeSongs:function(e){if(_.isNumber(e[0])){var t=[];for(var n=0,r=e.length;n<r;n++)t.push(this.queue.songs.get(e[n]));e=t}return this.removeSongsWrapper(e)},removeSpecificSong:function(e,t){if(t==this.queue.get("queueID")){var n=this.queue.songs.get(e);return this.queue.removeSongs([n])}},moveSongsTo:function(e,n,r){var i=r||{},s=[],o=this;if(e.length&&_.isNumber(e[0])){var u;_.each(e,function(e,t){u=o.queue.songs.get(e),u&&i.maintainOrder?s[t]=u:u&&s.push(u)}),i.maintainOrder&&(s=_.without(s,t))}return this.queue.moveSongs(s,n,i),!0},getVolume:function(){return this.get("volume")*100},setVolume:function(e){var t,r=this.queue.get("currentBroadcast");return _.isNumber(e)?t=e:t=parseFloat(e),t>1&&(t/=100),this.attributes.volume!=t&&(this.get("isMuted")&&r&&this.resumeSong(),this.preLockVolume=t,this.set("volume",t),n.Services.Local.set("storedVolume",t),_.isEmpty(this.muteLocks)&&n.Services.AudioHandle.setGlobalVolume(t)),!0},getRepeat:function(){return this.get("repeatMode")},setRepeat:function(e){return this.set("repeatMode",e),!0},toggleRepeat:function(){var e=this.getRepeat();switch(e){case 0:e=1;break;case 1:e=2;break;case 2:e=0}return this.set("repeatMode",e),!0},getShuffle:function(){return this.get("shuffle")},setShuffle:function(e){return this.set("shuffle",!!e),this.storePlayerSettings({shuffleEnabled:!!e}),!0},toggleShuffle:function(){return this.setShuffle(!this.get("shuffle")),!0},setAutoplay:function(e,t){_.isUndefined(e)&&(e=!this.get("autoplay"));var r=t||{},i;return e?(i=new n.Models.Radio(r),this.get("queue").set({parasite:i})):this.get("queue").set({parasite:null}),this.set("autoplay",!!e),!0},toggleAutoplay:function(){return this.setAutoplay(),!0},getIsMuted:function(){return this.get("muted")},setIsMuted:function(e){var t=!!e;return this.preLockMuteValue=t,this.set("isMuted",t),n.Services.Local.set("storedMute",t),_.isEmpty(this.muteLocks)&&n.Services.AudioHandle.setGlobalMuted(t),!0},toggleVolumeMute:function(e){return e=_.isUndefined(e)?!this.get("isMuted"):e,this.setIsMuted(e)},lockMute:function(e){var t=!_.isEmpty(this.muteLocks);this.muteLocks[e]=!0,t||(this.preLockMuteValue=this.get("isMuted"),this.preLockVolume=this.get("volume")),n.Services.AudioHandle.setGlobalMuted(!0)},unlockMute:function(e){this.muteLocks.hasOwnProperty(e)&&delete this.muteLocks[e],_.isEmpty(this.muteLocks)&&(n.Services.AudioHandle.setGlobalVolume(this.preLockVolume),n.Services.AudioHandle.setGlobalMuted(this.preLockMuteValue))},resumeSong:function(){return this.queue.resume(),!0},togglePlay:function(e){var t=this.queue.get("activeSong"),r=this.queue.get("crossfadeSong"),i=t&&t.get("playStatus");return this.queue.songs.length==0?!0:(!t&&!e?this.playSong(this.queue.songs.at(0)):e&&(!t||e!==t.get("queueSongID"))?this.playSong(this.queue.songs.get(e)):u.isPlayStatusPlaying(i)?this.pauseSong():i===n.Models.Player.playStatuses.PAUSED||i===n.Models.Player.playStatuses.SUSPENDED?this.resumeSong():(t.play(),r&&(r.stop(),this.queue.set("crossfadeSong",null))),!0)},stopSong:function(){var e=this.queue.get("activeSong"),t=this.queue.get("crossfadeSong");return e&&e.stop(),t&&(t.stop(),this.queue.set("crossfadeSong",null)),!0},seekTo:function(e){return this.queue.seekActiveSongTo(e),!0},nextSong:function(e){return this.queue.nextSong(e),!0},playNextSong:function(){return this.nextSong({fromUserNext:!0}),this.set({expectManualSongChange:!0}),!0},previousSong:function(){return this.queue.previousSong(),!0},playPreviousSong:function(){return this.previousSong(),this.set({expectManualSongChange:!0}),!0},clearQueue:function(){return this.storeQueue(),this.queue.clear(),this.get("persistSettings")||this.setShuffle(!1),!0},setBlockNextSong:function(e){this.queue.set("blockNextSong",e)},storePlayerSettings:function(e,t){var n=t||{},r=i&&i.get("settings"),s=r&&r.local,o;if(!this.get("persistSettings")&&!n.ignorePersist||!i)return;_.each(e,function(t,n){e[n]!==s[n]&&(o=!0)}),o&&i.saveUserPreferences({local:e})},getLowerQuality:function(){return this.get("lowerQuality")},setLowerQuality:function(e){var t=!!e;return this.set("lowerQuality",t),n.Models.PlayableSong.useMobile=t,this.storePlayerSettings({lowerQuality:t}),!0},getPlayPauseFade:function(){return this.get("playPauseFade")},setPlayPauseFade:function(e){var t=!!e;return this.set("playPauseFade",t),n.Models.PlayableSong.pauseFade=t,this.storePlayerSettings({playPauseFade:t}),!0},getCrossfadeAmount:function(){return this.get("crossfadeAmount")},setCrossfadeAmount:function(e){var t=_.toInt(e)||0;return this.set("crossfadeAmount",t),n.Models.PlayableSong.crossfadeLength=t,this.storePlayerSettings({crossfadeAmount:t}),!0},getCrossfadeEnabled:function(){return this.get("crossfadeEnabled")},setCrossfadeEnabled:function(e){var t=!!e;return this.set("crossfadeEnabled",t),this.queue.set("crossfadeEnabled",t),this.storePlayerSettings({crossfadeEnabled:t}),!0},toggleCrossfade:function(){var e=!this.get("crossfadeEnabled");return this.setCrossfadeEnabled(e)},setFlattr:function(e){return this.set("flattr",e),!0},playSongFromStreamKey:function(e,t,r){if(!e||!e.SongID)return;var i=this.get("queue"),s;r||(r=new n.Models.PlayContext,r.addDefaultType()),e.context=r,s=o([e]),e=s[0],i.addSongs(s),this.playSong(e,t)},getQueueIsRestorable:function(){return this.allowRestore&&this.get("previousQueue")},restoreQueue:function(){var e=this.get("storedQueue"),t=this.get("queue"),r=t&&t.get("currentBroadcast"),i,s,o;return r?r.isBroadcasting()?e&&e.songs?(t.resetSongs(e.songs),!0):!1:!1:(i=new n.Models.Queue(e),i?(s=t.get("activeSong"),o=t.get("crossfadeSong"),s&&s.stop(),o&&(o.stop(),t.set("crossfadeSong",null)),this.set("queue",i),this.queue=i,t.destroy(),!0):!1)},storeQueue:function(){var e=this.get("queue"),t=e.getStorableQueue();return t&&t.songs&&t.songs.length?(this.set({storedQueue:t,previousQueue:!0}),t.songs.length>1&&n.Services.Local.set("storedQueue",t),!0):!1},storeQueueDebounced:_.debounce(function(){this.storeQueue()},50),attemptAutoRestoreQueue:function(){var t=e.get("user");this.get("storedQueue")&&t&&t.get("settings")&&t.get("settings").local.restoreQueue&&this.restoreQueue()},checkUserActivity:function(){if(_.isUndefined(n.isBroadcaster)||_.isUndefined(n.isBroadcastListener))return;var e=new Date,t=e-r.lastActive<36e5,s=n.isBroadcaster()||n.isBroadcastListener(),o=i.get("subscription").canListenUninterrupted();this.playStatusIsPlaying()&&!t&&!s&&!o&&n.trigger("lightbox:open","interactionTimeout",{_canClose:!1})},onQueueChange:function(t,r){var i=this.queue,s=t.changed,o=e.get("user"),u=i&&i.get("songs"),a=i&&i.get("activeSong"),f,l;_.isUndefined(s.shuffle)||(f=i.get("shuffle"),f!==this.get("shuffle")&&this.setShuffle(f)),_.isUndefined(s.crossfadeEnabled)||(l=i.get("crossfadeEnabled"),l!==this.get("crossfadeEnabled")&&this.setCrossfadeEnabled(f)),!_.isUndefined(s.activeSong)&&a&&(n.trigger("player:openFanFeedback"),this.storeQueueDebounced(),_.delay(_.bind(this.checkUserActivity,this),1e3))},onOptionsChange:function(e,t){var n=e.changed;n.queue&&(this.storeQueueDebounced(),this.queue.get("songs").off(null,null,this),this.queue.off(null,null,this),this.queue=n.queue,this.queue.on("change",this.onQueueChange,this),this.queue.get("songs").on("add remove reset move",this.storeQueueDebounced,this),this.onQueueChange(this.queue,this.queue.attributes))},playStatusIsPlaying:function(e){var t=this.queue.get("activeSong");return u.isPlayStatusPlaying(t&&t.get("playStatus"),e)}},{isPlayStatusPlaying:function(e,t){switch(e){case n.Models.Player.playStatuses.INITIALIZING:case n.Models.Player.playStatuses.LOADING:case n.Models.Player.playStatuses.PLAYING:case n.Models.Player.playStatuses.BUFFERING:return!0;case n.Models.Player.playStatuses.PAUSED:case n.Models.Player.playStatuses.SUSPENDED:return!!t}return!1},generateQueueSongs:o,playSpecialIndexes:{PREVIEW:-99,DEFAULT:-1,NEXT:-2,LAST:-3,REPLACE:-4,SHUFFLE:-5},playStatuses:{NONE:0,INITIALIZING:1,LOADING:2,PLAYING:3,PAUSED:4,BUFFERING:5,FAILED:6,COMPLETED:7,SUSPENDED:8},repeatModes:{NONE:0,ALL:1,ONE:2}})}(),function(){n.Models=n.Models||{};var e=0,i=0,s=0,o=0,u=20,a=function(e){var t=/[^A-Za-z0-9]+/g,n=/\sand\s|\sbut\s|\sor\s|\sthe\s/g,r;return _.isString(e)?(r=e.toLowerCase(),r=r.replace(t," "),r=" "+r+" ",r=r.replace(n," "),r=r.replace(/\s/g,""),r):(console.log("no title provided"),console.trace(),"")};n.Models.Radio=Backbone.Model.extend({idAttribute:"radioID",parse:function(i,s){if(s&&s.skipParse)return i;var o=i||{},u;return u={radioID:_.toInt(o.radioID||++e),songQueueID:null,secondaryArtistWeightModifier:o.secondaryArtistWeightModifier||.9,seedArtistWeightRange:o.seedArtistWeightRange||[70,100],weightModifierRange:o.weightModifierRange||[-9,9],maxDuration:o.maxDuration||1500,minDuration:o.minDuration||60,smiles:new n.Models.Collections.PlayableSongs(o.smiles),frowns:new n.Models.Collections.PlayableSongs(o.frowns),recentArtists:new n.Models.Collections.Artists(o.recentArtists),songIDsAlreadySeen:o.songIDsAlreadySeen||[],titlesAlreadySeen:o.titlesAlreadySeen||[],seedArtists:o.seedArtists||{},songPool:new n.Models.Collections.PlayableSongs(o.songPool),disperseArtists:o.disperseArtists||!0,disperseAlbums:o.disperseAlbums||!0,recentArtistsDisperseSize:o.recentArtistsDisperseSize||5,recentAlbumsDisperseSize:o.recentAlbumsSize||5,extraStreamFlags:o.extraStreamFlags||0,host:o.host||t},o.seeds&&_.isArray(o.seeds)&&_.each(o.seeds,function(e){u.seedArtists[e]="p"}),u.songQueueID||(u.songQueueID=r.model.get("player").get("queue").get("queueID")),u},initialize:function(){var e=this.get("host");this.on("attached",this.onAttached,this),this.on("detached",this.onDetached,this),e&&e.set("parasite",this)},destroy:function(){var e=this.get("host");this.off(null,null,this),e&&e.set("parasite",null)},onAttached:function(e){var t=e.get("songs"),r=e.get("_previousSongs"),i=e.get("activeSong"),s=r.concat(i),o=this.get("seedArtists"),u=this.get("recentArtists"),a,f,l,c;console.log("attached!",arguments),this.set("host",e),e.set({autoplay:!0,shuffle:!1,repeatMode:n.Models.Player.repeatModes.NONE}),t.on("add",this.onHostSongsAdded,this),t.on("remove reset",this.checkNextSongNeeded,this),t.on("change:autoplayVote",this.onHostSongAutoplayVoteChange,this);for(a=0,f=t.length;a<f;a++)this.onHostSongsAdded(t.models[a],t);for(a=0,f=s.length;a<f;a++)l=s[a]&&s[a].get("ArtistID"),c=l&&s[a].getArtists(l),c&&(console.log(o),u.add(c),o[l]="p");e.on("change:activeSong",this.onHostActiveSongChanged,this),this.onHostActiveSongChanged(e,i)},onDetached:function(e){var t=e.get("songs"),r=t.last();console.log("detached!",arguments),e.off(null,null,this),e.set("autoplay",!1),t.off(null,null,this),this.set("host",null),r&&r.get("suggestion")&&!r.playAttempts&&n.trigger("player:removeSpecific",r.get("queueSongID"),e.get("queueID")),this.destroy()},onHostActiveSongChanged:function(e,t,n){var r=e.get("songs"),i=this.get("recentArtists"),s=t&&t.get("ArtistID"),o=s&&t.getArtists(s);o&&i.add(o),this.checkNextSongNeeded()},checkNextSongNeeded:function(){var e=this.get("host"),t=e.get("songs"),n=e.get("activeSong"),r=t.indexOf(n);r===t.length-1&&setTimeout(_.bind(this.getNextSong,this,e),10)},onHostSongAutoplayVoteChange:function(e){var t=this.get("smiles"),n=this.get("frowns");e.get("smile")?t.add(e):t.remove(e),e.get("frown")?n.add(e):n.remove(e)},onHostSongsAdded:function(e,t){var n=this.get("songIDsAlreadySeen"),r=this.get("titlesAlreadySeen"),i=e.get("SongID"),s=a(e.get("SongName")),o;o=_.indexOf(n,i),o===-1&&n.push(i),o=_.indexOf(r,s),s&&o===-1&&r.push(s)},getNextSong:function(e){if(this.getNextSongDfd&&this.getNextSongDfd.state()==="pending")return;var t=$.Deferred(),r=this,u,f,l,c;f=function(t){var s=!1,u=0,a=r.get("host"),f=a&&a.get("songs"),c;r.getNextSongDfd=null,c=function(e,t){n.trigger("notification:add",{description:e,duration:t||6500,type:"error"})},i=Date.now(),o++,console.log("error picking autoplay song",t);if(t.code){switch(t.code){case 2048:case 512:case-256:case 10:s=!0}u=t.code}if(!f||!f.length||_.isEmpty(t.nextSong))s=!0,u=2048;if((!t||t.retry!==!1)&&o<3)l=200+Math.floor(Math.random()*600),setTimeout(_.bind(r.getNextSong,r,e),l);else{s&&e.set("parasite",null),console.log("failed to get a new song");switch(u){case 2048:n.trigger("lightbox:open","stations",{noRecs:!0});break;default:c(_.getString("ERROR_FETCHING_STATION"))}_.gaTrackEvent("playerError","autoplay",u)}},this.getNextSongDfd=t,u=this.pluckSongFromPool();if(u)c={clientRadio:!0},t.resolve({nextSong:u});else{if(o>=3&&Date.now()-i<5e3){f({retry:!1}),t.reject();return}t=n.Services.API.getAutoplaySong(this.getAutoplayState())}t.done(function(t){var i=t&&t.nextSong,u=r.get("titlesAlreadySeen"),l=e.get("songs"),h=e.get("activeSong"),p=h&&h.get("playStatus"),d=!1,v,m;r.getNextSongDfd=null;if(e.get("parasite")!==r)return;if(!i||!(i.SongID||i instanceof Backbone.Model)||!l){f(t);return}o=0;if(r.get("host")===e){m=a(i.SongName||i.get&&i.get("SongName"));if(_.indexOf(u,m)!==-1&&++s<3){f({badTitle:!0});return}s=0,v=new n.Models.PlayContext(r,c),v.addStreamType(r.get("extraStreamFlags"));if(i instanceof Backbone.Model)i.set({suggestion:!0,context:v});else{i.context=v,i.suggestion=!0;var g=(i.CoverArtUrl||"").split("/");g.length&&(i.CoverArtFilename=_.last(g).substring(1)),i=n.Models.Player.generateQueueSongs([i]),i=i[0]}d=!h,!d&&h&&(d=p==n.Models.Player.playStatuses.FAILED||p==n.Models.Player.playStatuses.COMPLETED),n.trigger("player:addSongsEx",[i],{index:n.Models.Player.playSpecialIndexes.LAST,playOnAdd:d,context:v,fromParasite:!0}),n.trigger("guts:forcelog","autoplayRecommendedSongToQueue",{songID:i.get("SongID")})}}),t.fail(f)},pluckSongFromPool:function(){var e=this.get("songPool"),t=this.get("frowns"),n=this.get("disperseArtists"),r=this.get("disperseAlbums"),i=_.toInt(this.get("recentArtistsDisperseSize")),s=_.toInt(this.get("recentAlbumsDisperseSize")),o=t.pluck("ArtistID"),u,a,f;u=function(e){return _.indexOf(o,e.get("ArtistID"))===-1},a=new e.constructor(_.filter(e.models,u));if(!a.length)return null;var l=function(e,t){return _.map(this.takeRight(t),function(t){return t.get(e)})};if(n||r){var c=l.apply(a,["ArtistID",i]),h=l.apply(a,["AlbumID",s]),p=n+r,d;for(var v=0,m=Math.min(30,a.length);v<m;v++){d=0,n&&_.indexOf(c,a.models[v].get("ArtistID"))==-1&&d++,r&&_.indexOf(h,a.models[v].get("AlbumID"))==-1&&d++;if(d>=p){f=a.models[v];break}d&&!f&&(f=a.models[v])}}return f||(f=a.models[0]),e.remove(f),f},getAutoplayState:function(){var e=this.get("seedArtists"),t=this.get("smiles"),n={},r=0,i,s,o;for(i in e)e.hasOwnProperty(i)&&(n[i]=e[i],r++);for(i=0,s=t.length;i<s&&r<u;i++){o=t.models[i].get("ArtistID");if(n[o])continue;n[o]="s",r++}return{songQueueID:this.get("queueID"),secondaryArtistWeightModifier:this.get("secondaryArtistWeightModifier"),seedArtistWeightRange:this.get("seedArtistWeightRange"),weightModifierRange:this.get("weightModifierRange"),maxDuration:this.get("maxDuration"),minDuration:this.get("minDuration"),frowns:this.get("frowns").pluck("ArtistID"),recentArtists:this.get("recentArtists").pluck("ArtistID"),songIDsAlreadySeen:this.get("songIDsAlreadySeen"),seedArtists:n}},getDetailsForFeeds:function(){return{}}},{})}(),function(){n.Models=n.Models||{},n.Models.Station=Backbone.Model.extend({idAttribute:"TagID",defaults:{TagID:0,StationTitle:""},toProxyLabel:function(){return _.escape(_.getString(this.get("StationTitle")))}},{getStations:function(){var e=[{StationTitle:"STATION_INDIE",TagID:136},{StationTitle:"STATION_ELECTRONICA",TagID:67},{StationTitle:"STATION_CLASSICAL",TagID:750},{StationTitle:"STATION_POP",TagID:56},{StationTitle:"STATION_RAP",TagID:3},{StationTitle:"COUNTRY",TagID:80},{StationTitle:"STATION_ALTERNATIVE",TagID:13},{StationTitle:"STATION_HIP_HOP",TagID:29},{StationTitle:"STATION_CLASSIC_ROCK",TagID:3529},{StationTitle:"STATION_AMBIENT",TagID:75},{StationTitle:"STATION_PUNK",TagID:111},{StationTitle:"STATION_90S_ALT_ROCK",TagID:9},{StationTitle:"STATION_BLUES",TagID:230},{StationTitle:"STATION_ROCK",TagID:12},{StationTitle:"STATION_JAZZ",TagID:43},{StationTitle:"STATION_RNB",TagID:4},{StationTitle:"STATION_FOLK",TagID:122},{StationTitle:"STATION_DUBSTEP",TagID:2563},{StationTitle:"STATION_80s",TagID:55},{StationTitle:"STATION_TRANCE",TagID:69},{StationTitle:"STATION_BLUEGRASS",TagID:96},{StationTitle:"STATION_REGGAE",TagID:160},{StationTitle:"STATION_METAL",TagID:17},{StationTitle:"STATION_OLDIES",TagID:102},{StationTitle:"STATION_EXPERIMENTAL",TagID:191},{StationTitle:"STATION_LATIN",TagID:528}];return new n.Models.Collections.Stations(e)},getStationsStartMenu:function(){var e=n.Models.Station.getStations(),t=[],r=function(e){return function(){n.Models.Tag.get(tagID).done(function(e){e.play()})}};return e.comparator=function(e){return _.getString(e.get("StationTitle"))},e.sort(),e.each(function(e){t.push({key:e.get("StationTitle").toUpperCase(),title:_.getString(e.get("StationTitle")),customClass:"jj_menu_item_hasIcon jj_menu_item_station",action:{type:"fn",callback:r(e.get("TagID"))}})}),t}})}(),function(){function e(e,t,r,i,s,o){if(!o||o.comments==null)return e&&e.reject(),null;n.Models.Comment.handleUsersArtistsInResult(o.comments,o.users,o.artists);if(s)return e&&e.resolve(o.comments,t,r,o.hasMore),o.comments;r!=n.Models.Comment.COMMENT_PAGE_TYPES.FAN_UPDATE&&r!=n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT&&r!=n.Models.Comment.COMMENT_PAGE_TYPES.OTHER&&(t=_.toInt(t));var u=n.Models.Comment.newCollectionForItem(t,r,o.comments,o.hasMore,i);return e&&e.resolve(u,t,r,o.hasMore),u}function t(t,r,i,s,o){s||(s=0),n.Services.API.getCommentsForItem(r,i,s).done(_.bind(e,this,t,r,i,s,o)).fail(_.bind(t.reject,t))}n.Models=n.Models||{},n.Models.Comment=Backbone.CachedModel.extend({idAttribute:"CommentID",parse:function(e,t){if(t&&t.skipParse)return e;var r=t&&t.clone===!1?e:_.clone(e);r.OriginalItem&&(r.ItemID=r.OriginalItem,delete r.OriginalItem),r.OriginalType&&(r.TypeID=r.OriginalType,delete r.OriginalType);if(r.user||r.artist)r.author=_.getNormalizedAuthorForCommentResponse(r,r.ItemID,r.TypeID);var i=[],s=this;return _.each(r.Responses,function(e){e.comment=s,e.ItemID=r.ItemID,e.TypeID=r.TypeID,i.push(e)}),r.Responses=new n.Models.Collections.CommentResponses(i,{dontCache:!0}),i.length?(r.ResponsesCount=r.Responses.length,r.ResponsesLoaded=!0):(r.ResponsesCount=_.toInt(r.ResponsesCount),r.ResponsesLoaded=r.ResponsesCount<=0),r},get:function(e){switch(e){case"time":return _.getFormattedDate(this.attributes.Timestamp)}return this.attributes[e]},loadResponses:function(){var e=$.Deferred();if(this.get("ResponsesLoaded"))e.resolve(this.get("Responses"));else{var t=function(){n.trigger("notification:add",{description:_.getString("POPUP_FAILED_LOAD_RESPONSES"),type:"error",url:""}),e.reject()};n.Services.API.getCommentByID(this.id).done(_.bind(function(r){if(!r||!r.comment)return t();var i=[];if(r.comment.Responses){var s=this;n.Models.Comment.handleUsersArtistsInResult(r.comment,r.users,r.artists),_.each(r.comment.Responses,function(e){e.comment=s,e.ItemID=s.get("ItemID"),e.TypeID=s.get("TypeID"),i.push(e)}),this.get("Responses").add(i)}this.set({ResponsesLoaded:!0,ResponsesCount:i.length}),e.resolve(this.get("Responses"))},this)).fail(t)}return e.promise()},reportComment:function(){if(n.getLoggedInUserID()>0)return n.Services.API.reportComment(this.get("CommentID"));var e=new $.Deferred,t=this.get("CommentID");return n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_REPORT_COMMENT"),onLogin:function(r){n.Services.API.reportComment(t).done(function(t){e.resolve(t)}).fail(function(t){e.reject(t)})},onClose:function(){e.state()=="pending"&&d.reject()}}),e.promise()},deleteComment:function(){var e=new $.Deferred,t=this.get("CommentID"),r=this.get("ItemID"),i=this.get("TypeID");return this.get("UserID")===n.getLoggedInUserID()?n.Services.API.deleteComment(t,this.get("AuthorArtistID"),r,i).done(_.bind(function(t){t?(this.destroy(),e.resolve(t)):e.reject(t)},this)).fail(_.bind(e.reject,e)):this.canDelete()?n.Services.API.deleteCommentFromMyPage(t,r,i).done(_.bind(function(t){t?(this.destroy(),e.resolve(t)):e.reject(t)},this)).fail(_.bind(e.reject,e)):e.reject(),e.promise()},canDelete:function(){var e;if(n.isLoggedInUserOwnerOfArtist(this.get("AuthorArtistID")))return!0;if(this.get("UserID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.USER&&this.get("ItemID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST){e=n.Models.Playlist.getCached(this.get("ItemID"));if(e&&e.get("UserID")===n.getLoggedInUserID())return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM){e=n.Models.Album.getCached(this.get("ItemID"));if(e&&n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG){e=n.Models.Song.getCached(this.get("ItemID"));if(e&&n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))return!0}else{if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST&&n.isLoggedInUserOwnerOfArtist(this.get("ItemID")))return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT){e=n.Models.FeedEvent.getCached(this.get("ItemID"));if(e&&n.getLoggedInUserID()==e.get("UserID"))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.FAN_UPDATE){e=n.Models.FanUpdate.getCached(this.get("ItemID"));if(e&&n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))return!0}}return n.Models.Comment.ADMINS[n.getLoggedInUserID()]?!0:!1},canEdit:function(){var e=this.get("AuthorArtistID");return e?n.isLoggedInUserOwnerOfArtist(e):this.get("UserID")===n.getLoggedInUserID()},storeResponse:function(e){function r(){var r=this.get("CommentID"),i=this.get("ItemID"),s=this.get("TypeID");n.Services.API.storeResponseToComment(r,i,s,e).done(_.bind(function(e){if(e&&e.response){var r=e.response;r.user=n.Models.User.getCached(n.getLoggedInUserID()),this.addResponse(r),t.resolve(r)}else n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",url:""}),t.reject()},this)).fail(_.bind(t.reject,t)),n.trigger("guts:log","respondToComment",{commentID:r,itemID:i,typeID:s}),_.gaTrackEvent("site","respondToComment",s)}var t=$.Deferred();return n.getLoggedInUserID()>0?r.call(this):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_REPORT_COMMENT"),onLogin:_.bind(r,this),onClose:function(){t.state()=="pending"&&t.reject()}}),t.promise()},getMessage:function(){if(this.get("linkedMessage"))return this.get("linkedMessage");var e=$.parseGSTagMessage(this.get("Message")),t=this.get("UserID"),n=[],r=0,i=/[^\s]/,s,o,u;for(s=0,o=e.length;s<o;s++){if(typeof e[s]=="string"){n.push(_.makeSafeLinks(e[s])),i.test(e[s])&&r++;continue}if(typeof e[s]!="object")continue;e[s].type==="all"?n.push('<a href="#!/user/-/'+t+'/followers">'+e[s].name+"</a>"):e[s].id>=1&&(u=e[s].id,n.push('<a href="#!/user/-/'+u+'" class="show-user-tooltip" data-user-id="'+u+'">'+e[s].name+"</a>"))}return n[0]&&(n[0]=n[0].replace(/^\s+/g,""),n[0]==""&&n.shift()),o=n.length,o>1&&(n[o-1]=n[o-1].replace(/\s+$/g,""),n[o-1]==""&&n.pop()),n=n.join(""),this.set({linkedMessage:n,messageOnlyContainsTags:r==0},{silent:!0}),n},getResponsesCount:function(){return this.get("MoreResponses")?"30+":this.get("ResponsesCount")},addResponse:function(e){e instanceof n.Models.CommentResponse||(e.comment=this,e=new n.Models.CommentResponse(e,{dontCache:!0})),this.get("Responses").push(e),this.set("ResponsesCount",this.get("Responses").length)},toUrl:function(){var e=this.get("ItemID"),t="",r;switch(this.get("TypeID")){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:r=n.Models.Artist,t="artist";break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:r=n.Models.Album,t="album";break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:r=n.Models.Playlist,t="playlist";break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:r=n.Models.User,t="user";break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:r=n.Models.Song,t="song";break;default:return""}var i="",s=r.getCached(e);return this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG&&(!s||!s.get("token"))?i="":s?i=s.toUrl("comment/"+this.id):i=_.cleanUrl(null,e,t,null,"comment/"+this.id),i},getAnchorTag:function(e){if(!e)switch(this.get("TypeID")){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:e=_.getString("ARTIST").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:e=_.getString("ALBUM").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:e=_.getString("PLAYLIST").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:e=_.getString("USER").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:e=_.getString("SONG").toLocaleLowerCase();break;default:return""}return'<a href="'+this.toUrl()+'" class="comment-link" data-comment-id="'+this.escape("CommentID")+'">'+e+"</a>"},getChildMetadata:function(){var e=n.Models.Comment.getModelForType(this.get("TypeID"));if(!e)return null;var t=e.getCached(this.get("ItemID"));return t?_.getString("COMMENTED_ON",{item:t.getAnchorTag()}):null}},{COMMENT_PAGE_TYPES:{USER:1,ARTIST:2,ALBUM:3,PLAYLIST:4,SONG:5,FAN_UPDATE:6,FEED_EVENT:7,OTHER:9},ADMINS:{3879:1,42:1,3327599:1,21007202:1,17729920:1,17638985:1,2226931:1,25736013:1,579416:1},getModelForType:function(e){var t;switch(e){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:t=n.Models.Artist;break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:t=n.Models.Album;break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:t=n.Models.Playlist;break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:t=n.Models.User;break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:t=n.Models.Song;break;case n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT:t=n.Models.FeedEvent;break;case 9:t=null}return t},getTypeIDFromTypeString:function(e){var t;switch(e){case"artist":t=n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST;break;case"album":t=n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM;break;case"playlist":t=n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST;break;case"user":t=n.Models.Comment.COMMENT_PAGE_TYPES.USER;break;case"song":t=n.Models.Comment.COMMENT_PAGE_TYPES.SONG;break;case"fanUpdate":t=n.Models.Comment.COMMENT_PAGE_TYPES.FAN_UPDATE;break;case"feedEvent":t=n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT;break;case"other":t=9}return t},loadCommentsForItemType:function(e,n,r,i){var s=new $.Deferred;return t(s,e,n,r,i),s.promise()},loadCommentsForItemsType:function(t,r,i,s,o){var u=new $.Deferred;return!t||t.length<1?u.reject().promise():(n.Services.API.getRecentCommentsForItems(t,r,o).done(function(t){if(!t||!t.commentsByItem){u.reject();return}var o={comments:null,hasMore:!0,users:t.users,artists:t.artists},a=n.Models.Collections.Comments.prototype._initialPageableItemLimit,f,l,c=0;_.each(t.commentsByItem,function(t,n){o.comments=t.comments,o.hasMore=t.hasMore,o.comments.length<a&&o.hasMore?c=-1:c=0,f=e(null,n,r,c,i,o);if(!f){u.reject();return}s&&(l=s.get(n),l&&l.set("comments",f,{skipModules:!0}))})}).fail(_.bind(u.reject,u)),u.promise())},loadComments:function(e,t,r){var i=n.Models.Comment.getTypeIDFromTypeString(e);return i?n.Models.Comment.loadCommentsForItemType(t,i,r,!1):$.Deferred().reject().promise()},storeComment:function(e,t,i){var s=$.Deferred();return n.Services.API.storeCommentForItem(e,t,i).done(_.bind(function(i){if(i&&i.comment){var o=i.comment;o.user=n.Models.User.getCached(o.UserID),s.resolve(o);if(t===n.Models.Comment.COMMENT_PAGE_TYPES.USER){var u=r.model.get("user");u.updateUserTSInteraction(e,n.Models.AuthUser.INTERACTION_TYPE_COMMENT)}}else n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}),s.reject()},this)).fail(_.bind(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}),s.reject(),n.trigger("guts:log","commentFailDeferred"),_.gaTrackEvent("site","commentFailDeferred")},this)),n.trigger("guts:log","comment",{itemID:e,typeID:t}),_.gaTrackEvent("site","comment",t),s.promise()},handleCommentsFromCombinedFanUpdatesCall:function(t,n,r){return e(null,n,r,0,!1,t)},handleUsersArtistsInResult:function(e,t,r){var i=e;!_.isArray(i)&&e!=null&&(i=[e]);if(t)for(var s in t)t.hasOwnProperty(s)&&t[s].UserID&&(t[s]=n.Models.User.newOrUpdate(t[s],{dontCache:!0,updateProfile:!1}));else t={};if(r)for(var o in r)r.hasOwnProperty(o)&&r[o].ArtistID&&(r[o]=n.Models.Artist.newOrUpdate(r[o],{dontCache:!0,updateProfile:!1}));else r={};_.each(i,function(e){e.AuthorArtistID?e.artist=r[e.AuthorArtistID]:e.user=t[e.UserID],e.Responses&&_.each(e.Responses,function(e){e.AuthorArtistID?e.artist=r[e.AuthorArtistID]:e.user=t[e.UserID]})})},get:function(e){var t=function(e){var t=new $.Deferred;return n.Services.API.getCommentByID(e).done(function(e){if(e&&e.comment&&e.users){var r=e.comment;n.Models.Comment.handleUsersArtistsInResult(r,e.users,e.artists),t.resolve(r)}else t.reject(e)}).fail(_.bind(t.reject,t)),t.promise()},r=Backbone.CachedModel.genericGet.call(this,t,"CommentID",e);return r.promise()},newCollectionForItem:function(e,t,r,i,s){var o=t==n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT?"FeedEventComments":"Comments",u=new n.Models.Collections[o](r,{modelOptions:{dontCache:!0},hasMore:i,initialPage:_.toInt(s)});return u.lastLoaded=Date.now(),u.loadedTypeID=t,u.loadedItemID=e,u}})}(),function(){function e(e,t){t?(this.destroy(),e.resolve(!0)):(e.reject(),n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error",duration:5e3}))}n.Models=n.Models||{},n.Models.CommentResponse=Backbone.CachedModel.extend({idAttribute:"ResponseID",parse:function(e,t){if(t&&t.skipParse)return e;var n=t&&t.clone===!1?e:_.clone(e);return n.author=_.getNormalizedAuthorForCommentResponse(n,n.ItemID,n.TypeID),n.time=_.getFormattedDate(n.Timestamp),n},deleteResponse:function(){var t=new $.Deferred;return n.isLoggedInUserOwnerOfArtist(this.get("AuthorArtistID"))||this.get("UserID")===n.getLoggedInUserID()?n.Services.API.deleteResponseToComment(this.get("comment").get("CommentID"),this.get("ResponseID"),this.get("AuthorArtistID")).always(_.bind(e,this,t)):this.canDelete()?n.Services.API.deleteResponseToCommentFromMyPage(this.get("comment").get("CommentID"),this.get("ResponseID"),this.get("ItemID"),this.get("TypeID")).always(_.bind(e,this,t)):t.reject(),t.promise()},canDelete:function(){var e;if(n.isLoggedInUserOwnerOfArtist(this.get("AuthorArtistID")))return!0;if(this.get("UserID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.USER&&this.get("ItemID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST){e=n.Models.Playlist.getCached(this.get("ItemID"));if(e&&e.get("UserID")==n.getLoggedInUserID())return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM){e=n.Models.Album.getCached(this.get("ItemID"));if(e&&n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG){e=n.Models.Song.getCached(this.get("ItemID"));if(e&&n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))return!0}else{if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST&&n.isLoggedInUserOwnerOfArtist(this.get("ItemID")))return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT){e=n.Models.FeedEvent.getCached(this.get("ItemID"));if(e&&n.getLoggedInUserID()==e.get("UserID"))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.FAN_UPDATE){e=n.Models.FanUpdate.getCached(this.get("ItemID"));if(e&&n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))return!0}}return n.Models.Comment.ADMINS[n.getLoggedInUserID()]?!0:!1},reportResponse:function(){var e=this.get("comment").get("CommentID");if(n.getLoggedInUserID()>0)return n.Services.API.reportResponseToComment(e,this.get("ResponseID"));var t=new $.Deferred;return n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_REPORT_COMMENT"),onLogin:function(r){n.Services.API.reportResponseToComment(e).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)})},onClose:function(){t.state()=="pending"&&d.reject()}}),t.promise()},getMessage:function(){if(this.get("linkedMessage"))return this.get("linkedMessage");var e=this.get("Message");return e=_.makeSafeLinks(e),this.set("linkedMessage",e,{silent:!0}),e}})}(),function(){n.Models=n.Models||{};var e=function(e,t,r){if(!e||!e.length||!t)return!1;var i=[],s,o,u,a;for(u=0,a=e.length;u<a;u++){o=e[u].metatype;if(!t[o])return!1;s=t[o][e[u].metaID];if(!s)continue;if(s instanceof Backbone.Model)i.push(s);else{if(o==="broadcast"){if(!t.user||!t.user[s.UserID])continue;s.ownerUser=t.user[s.UserID]}else if(o==="playlist"){if(!t.user||!t.user[s.UserID])continue;s.owner=t.user[s.UserID]}else if(o==="artist"){if(!t.user||!t.user[s.UserID])continue;s.user=t.user[s.UserID]}i.push(n.Models[_.ucwords(o)].newOrUpdate(s,{dontCache:!0}))}r.itemType=o}return i[1]?r.items=i:i[0]&&(r.item=i[0]),!0},t=function(e,t,r,i,s,o){if(!e||!t||!t.length||!r||!r[e])return null;var u=[],a,f,l;for(f=0,l=t.length;f<l;f++){if(o!=null&&t[f]==o)continue;a=r[e][t[f]];if(!a)continue;u.push(n.Models[_.ucwords(e)].newOrUpdate(a,{dontCache:!0}))}return i&&u.sort(i),s&&(u=_.take(u,s)),new(n.Models.Collections[_.ucwords(e)+"s"])(u)},i=function(e,t,r){var i=[],s,o,u=n.getLoggedInUserID(),a=0;if(!e||!t||!e.dstUserIDs||!e.dstUserIDs.length)return;for(var f=0,l=e.dstUserIDs.length;f<l;f++){o=e.dstUserIDs[f];if(o==u)continue;a++,s=t.user[o],s?s instanceof Backbone.Model?i.push(s):i.push(n.Models.User.newOrUpdate(s,{dontCache:!0,skipUpdate:!0})):console.error("couldn't find user info for dstUserID!",o)}e.sharedWithViewingUserID&&(r.sharedWithViewingUserID=u,a++),r.destinationUsers=i,e.dstUserIDsRemaining&&(a+=_.toInt(e.dstUserIDsRemaining)),r.destinationUsersCount=a},s=function(e,t,n,r,i){if((!e||!e.length)&&!t||!n)return;var s=e&&e.length||0,o=t;i&&(t-=1,o-=1),s>1?t>s+1?i?(r.likesLocaleKey="FEED3_TWO_PLUS_LIKERS_WITH_NAMES_AND_YOU_AND_OTHERS",o=t-3):(r.likesLocaleKey="FEED3_TWO_PLUS_LIKERS_WITH_NAMES_AND_OTHERS",o=t-2):t>s?i?r.likesLocaleKey="FEED3_TWO_PLUS_LIKERS_WITH_NAMES_AND_YOU_AND_OTHER":r.likesLocaleKey="FEED3_TWO_PLUS_LIKERS_WITH_NAMES_AND_OTHER":i?r.likesLocaleKey="FEED3_TWO_PLUS_LIKERS_WITH_NAMES_AND_YOU":r.likesLocaleKey="FEED3_TWO_PLUS_LIKERS_WITH_NAMES":s>0?t>s+1?i?(r.likesLocaleKey="FEED3_ONE_LIKER_WITH_NAME_AND_YOU_AND_OTHERS",o=t-2):(r.likesLocaleKey="FEED3_ONE_LIKER_WITH_NAME_AND_OTHERS",o=t-1):t>s?i?r.likesLocaleKey="FEED3_ONE_LIKER_WITH_NAME_AND_YOU_AND_OTHER":r.likesLocaleKey="FEED3_ONE_LIKER_WITH_NAME_AND_OTHER":i?r.likesLocaleKey="FEED3_ONE_LIKER_WITH_NAME_AND_YOU":r.likesLocaleKey="FEED3_ONE_LIKER_WITH_NAME":t>1?i?r.likesLocaleKey="FEED3_OTHER_LIKERS_AND_YOU":r.likesLocaleKey="FEED3_OTHER_LIKERS":t>0?i?r.likesLocaleKey="FEED3_YOU_LIKER_AND_YOU":r.likesLocaleKey="FEED3_ONE_LIKER":i&&(r.likesLocaleKey="FEED3_YOU_LIKER"),r.localeVariables.likersCount=o},o=function(e,t){t.icon="share";var r=n.getLoggedInUserID(),i=t.sharedWithViewingUserID&&t.sharedWithViewingUserID==r,s=t.isStranger&&t.localeVariables.genre;return t.destinationUsersCount>3?i?t.localeKey="FEED3_USER_SHARED_YOU_OTHERS":t.destinationUsers[0]?t.localeKey="FEED3_USER_SHARED_SOMEONE_OTHERS":t.localeKey=s?"FEED3_USER_SHARED_GENRE":"FEED3_USER_SHARED":t.destinationUsersCount>2?i?!t.destinationUsers[0]||t.destinationUsers.length===1?t.localeKey="FEED3_USER_SHARED_YOU_OTHERS":t.localeKey="FEED3_USER_SHARED_YOU_OTHER_OTHER":t.destinationUsers[0]?t.localeKey="FEED3_USER_SHARED_SOMEONE_OTHERS":t.localeKey=s?"FEED3_USER_SHARED_GENRE":"FEED3_USER_SHARED":t.destinationUsersCount>1?i?t.destinationUsers[0]?t.localeKey="FEED3_USER_SHARED_YOU_SOMEONE":t.localeKey="FEED3_USER_SHARED_YOU_OTHER":t.destinationUsers[1]?t.localeKey="FEED3_USER_SHARED_SOMEONE_SOMEONE":t.localeKey="FEED3_USER_SHARED_SOMEONE_OTHER":t.destinationUsersCount>0?i?t.localeKey="FEED3_USER_SHARED_YOU":t.destinationUsers[0]?t.localeKey="FEED3_USER_SHARED_SOMEONE":t.localeKey=s?"FEED3_USER_SHARED_GENRE":"FEED3_USER_SHARED":(t.localeKey=s?"FEED3_USER_SHARED_GENRE":"FEED3_USER_SHARED",t.showRepost=!0),t.addStreamType=["TYPE_ACTIVITY","TYPE_SHARE"],!0},u={favoriteSong:function(e,t){return u.favorited(e,t)},favorited:function(e,t){t.icon="heart";switch(t.itemType){case"artist":case"song":case"album":case"playlist":case"user":t.items?t.localeKey="FEED3_USER_FAVORITED_"+t.itemType.toUpperCase()+"S":t.localeKey="FEED3_USER_FAVORITED_"+t.itemType.toUpperCase();break;default:return!1}return t.addStreamType=["TYPE_ACTIVITY"],!0},songsAddedLibrary:function(e,t){return u.addSongsToLibrary(e,t)},addSongsToLibrary:function(e,t){t.icon="check",t.items?t.localeKey="FEED3_USER_COLLECTED_SONGS":t.localeKey="FEED3_USER_COLLECTED_SONG",t.addStreamType=["TYPE_ACTIVITY"];var r=t.item||t.items&&t.items[0];return r instanceof n.Models.Song?!0:!1},broadcastCreated:function(e,t){t.icon="broadcast",t.localeKey="FEED3_USER_STARTED_BROADCAST",t.addStreamType=["TYPE_ACTIVITY"];var r=t.item||t.items&&t.items[0];return r instanceof n.Models.Broadcast?!0:!1},playlistCreated:function(e,t){return t.icon="playlist",t.localeKey="FEED3_USER_CREATED_PLAYLIST",t.addStreamType=["TYPE_ACTIVITY"],t.item instanceof n.Models.Playlist?!0:!1},overwritePlaylist:function(e,t){return t.icon="playlist",t.localeKey="FEED3_USER_EDITED_PLAYLIST",t.addStreamType=["TYPE_ACTIVITY"],t.item instanceof n.Models.Playlist?!0:!1},songShared:function(e,t){return o(e,t)},artistShared:function(e,t){return o(e,t)},albumShared:function(e,t){return o(e,t)},userShared:function(e,t){return o(e,t)},playlistShared:function(e,t){return o(e,t)},broadcastShared:function(e,t){return o(e,t)},artistAddedAlbum:function(e,t){return u.albumAddedArtist(e,t)},albumAddedArtist:function(e,t){t.icon="upload",t.items?t.localeKey="FEED3_ARTIST_ADDED_ALBUMS":t.localeKey="FEED3_ARTIST_ADDED_ALBUM",t.addStreamType=["TYPE_ACTIVITY"];var r=t.item||t.items&&t.items[0];return r instanceof n.Models.Album?!0:!1},artistAddedSong:function(e,t){return u.songAddedArtist(e,t)},artistAddedSongs:function(e,t){return u.songAddedArtist(e,t)},songAddedArtist:function(e,t){t.icon="upload",t.items?t.localeKey="FEED3_ARTIST_ADDED_SONGS":t.localeKey="FEED3_ARTIST_ADDED_SONG",t.addStreamType=["TYPE_ACTIVITY"];var r=t.item||t.items&&t.items[0];return r instanceof n.Models.Song?!0:!1},recommendation:function(e,t){t.icon="thumbsup";switch(t.itemType){case"artist":case"song":case"album":case"playlist":case"user":case"broadcast":t.localeKey="FEED3_RECOMMENDATION_"+t.itemType.toUpperCase();break;default:return!1}return t.addStreamType=["TYPE_ACTIVITY"],!0},featured:function(e,t){return u.recommendation(e,t)},fake:function(e,t){return!0},playlistDeleted:function(e,t){return!1},unfavorited:function(e,t){return!1},genreShared:function(e,t){return!1}};n.Models.FeedEvent=Backbone.CachedModel.extend({idAttribute:"EventID",parse:function(e,r){if(r&&r.skipParse)return e;var i=null,s=0,o=0,u=null,a,f,l,c;return r.metaByType||(e.owner&&(r.metaByType=r.metaByType||{},r.metaByType.user=r.metaByType.user||{},r.metaByType.user[e.userID]=e.owner),e.sharedItem&&e.metadata[0]&&(r.metaByType=r.metaByType||{},r.metaByType[e.metadata[0].metatype]=r.metaByType[e.metadata[0].metatype]||{},r.metaByType[e.metadata[0].metatype][e.metadata[0].metaID]=e.sharedItem)),a=r&&r.metaByType,f=a&&a[e.metadata[0].metatype],l=f&&f[e.metadata[0].metaID],l?(e.likesTrunc&&e.likesTrunc.likedByViewingUserID&&(s=n.getLoggedInUserID(),o+=1),e.likesTrunc&&e.likesTrunc.likesImportant&&e.likesTrunc.likesImportant[0]&&(i=t("user",e.likesTrunc.likesImportant,r.metaByType,n.Models.User.interactedNiftyFriendSort,4,s),o+=i?i.length:0),e.likesTrunc&&e.likesTrunc.likesRemaining&&(o+=_.toInt(e.likesTrunc.likesRemaining)),e.context&&e.context.userTagID&&(u=n.Models.Tag.getCached(e.context.userTagID)||null,c=r.metaByType.genre&&r.metaByType.genre[e.context.userTagID],!u&&c&&(u=n.Models.Tag.newOrUpdate(c,{dontCache:!0}))),{EventID:e.itemID||e.feedItemID,EventType:e.itemType,UserID:e.userID,metadata:e.metadata,context:e.context,timestamp:e.tsAdded,commentsCount:_.toInt(e.commentsCount),globalMetadatas:r.metaByType,importantLikers:i,userTag:u,numLikes:o,userIDLiked:s,rankingData:e.rankingData}):!1},updateFromNew:function(e){this.set(e)},getPrimaryUser:function(){var e=this.get("user");if(!e){var t=this.get("UserID"),i;this.get("EventType")==="recommendation"&&t<=0?e=new n.Models.User({FName:"Grooveshark",Picture:"4034-20140502155157.png",UserID:4034},{skipCache:!0,dontCache:!0}):t==n.getLoggedInUserID()?e=n.Models.AuthUser.getCached(t):(i=r.model.get("user").get("favoriteUsers"),e=i&&i.get(t));if(!e){var s=this.get("globalMetadatas");s.user&&s.user[t]&&(e=n.Models.User.newOrUpdate(s.user[t],{dontCache:!0,skipUpdate:!0}));if(!e)return null}this.set("user",e)}return e},canDelete:function(){return this.get("EventType")==="recommendation"?!1:this.get("UserID")===n.getLoggedInUserID()},deleteFeedEvent:function(){var e=$.Deferred();return n.Services.API.feeds3DeleteItem(this.get("EventID")).done(_.bind(function(t){t?(this.destroy(),e.resolve()):e.reject()},this)).fail(_.bind(e.reject,e)),e.promise()},flagBadTag:function(){var e=$.Deferred();return n.Services.API.feeds3ItemIDBadlyTagged(this.get("EventID")).done(_.bind(function(t){t?e.resolve():e.reject()},this)).fail(_.bind(e.reject,e)),e.promise()},hideFeedEvent:function(){var e=$.Deferred();return n.Services.API.feeds3HideItemID(this.get("EventID")).done(_.bind(function(t){t?(this.set("hidden",!0),e.resolve()):e.reject()},this)).fail(_.bind(e.reject,e)),e.promise()},getIsLikedByLoggedInUser:function(){return this.get("userIDLiked")===n.getLoggedInUserID()},canComment:function(){return this.get("EventType")==="recommendation"?!1:!0},canRepost:function(){return this.get("EventType")==="recommendation"?!1:!0},storeComment:function(e){var t=$.Deferred(),r=this.get("EventID"),i=this.get("displayObject"),s=n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT,o={};return n.Models.Comment.storeComment(r,s,e).done(_.bind(function(e){if(!e){t.reject();return}var u=this.get("comments");u?u.add(e,{newComment:!0}):(u=n.Models.Comment.newCollectionForItem(r,s,[e]),this.set("comments",u)),this.set("commentsCount",this.get("commentsCount")+1),t.resolve(e),o.feedItemType=this.get("EventType"),o.ownerUserID=this.get("UserID"),o.feedItemID=i&&i.item&&i.item.id,n.trigger("guts:log","feedItemCommented",o)},this)).fail(_.bind(t.reject,t)),t.promise()},removeComment:function(e){var t=$.Deferred();return e?(e.deleteComment().done(_.bind(function(e){if(!e){t.reject();return}this.set("commentsCount",this.get("commentsCount")-1)},this)).fail(_.bind(t.reject,t)),t.promise()):t.reject().promise()},like:function(){var e=$.Deferred(),t=this.get("displayObject"),r={};return this.getIsLikedByLoggedInUser()?e.reject().promise():(n.Services.API.feeds3LikeItem(this.get("EventID")).done(_.bind(function(i){i?(this.set({userIDLiked:n.getLoggedInUserID(),numLikes:this.get("numLikes")+1}),e.resolve(),r.feedItemType=this.get("EventType"),r.ownerUserID=this.get("UserID"),r.feedItemID=t&&t.item&&t.item.id,n.trigger("guts:log","feedItemLiked",r)):e.reject()},this)).fail(_.bind(e.reject,e)),e.promise())},unlike:function(){var e=$.Deferred(),t=this.get("displayObject"),r={};return n.Services.API.feeds3UnlikeItem(this.get("EventID")).done(_.bind(function(i){i?(this.set({userIDLiked:0,numLikes:Math.max(0,this.get("numLikes")-1)}),e.resolve(),r.feedItemType=this.get("EventType"),r.ownerUserID=this.get("UserID"),r.feedItemID=t&&t.item&&t.item.id,n.trigger("guts:log","feedItemUnliked",r)):e.reject()},this)).fail(_.bind(e.reject,e)),e.promise()},getDisplayData:function(){if(this.generatingDisplayDataDfd&&this.generatingDisplayDataDfd.state()==="pending")return this.generatingDisplayDataDfd.promise();var t=$.Deferred(),r=this.get("displayObject"),s=this.get("EventType"),o=this.get("globalMetadatas"),a=n.getLoggedInUserID(),f,l;this.generatingDisplayDataDfd=t;if(typeof r!="object"||r&&r.viewingUserID!==a){if(typeof u[s]!="function")return t.reject().promise();f=this.getPrimaryUser();if(!f)r=null;else{r={localeVariables:{},user:f,isStranger:!f.get("isAuth")&&!f.get("isFavorite")&&!f.get("isFollower"),id:this.get("EventID"),viewingUserID:a,message:""};if(!e(this.get("metadata"),o,r)||!r.item)r=null;else{i(this.get("context"),o,r);if(r.destinationUsers&&r.destinationUsers.length>0)r.localeVariables.recipient=r.destinationUsers[0].getAnchorTag(),r.destinationUsers[1]&&(r.localeVariables.recipient2=r.destinationUsers[1].getAnchorTag());else if(s!=="recommendation"||s!=="featured")l=this.getTag()||r.item.get("Tags")&&r.item.get("Tags").first()||r.item.get("Tag"),l&&(_.isInstance(l,n.Models.Tag)||(l=n.Models.Tag.newOrUpdate(l)),r.localeVariables.genre='<a href="'+l.toUrl()+'">'+l.get("DisplayName")+"</a>");r.destinationUsersCount>2&&(r.localeVariables.othersCount=_.addCommaSeparators(r.destinationUsersCount-1)),this.recalculateLikesText(r),s==="recommendation"||s==="featured"?(this.calculateContextText(r),r.localeVariables.user="Grooveshark"):r.localeVariables.user=f.getAnchorTag(),r.items&&r.items.length>0&&(r.localeVariables.itemsCount=r.items.length),u[s](this,r)||(r=null)}}this.set("displayObject",r)}return r==null?t.reject().promise():(r.time=_.getFormattedDate(this.get("timestamp")),t.resolve(r),t.promise())},getTag:function(){var e=this.get("userTag"),t,r,i,s;return e?e:(t=this.get("displayObject")||this.getDisplayData(),!t||!t.item&&(!t.items||!t.items.length)?null:(r=t.item||t.items[0],s=r.get("Tag"),s?_.isInstance(s,n.Models.Tag)?s:n.Models.Tag.newOrUpdate(s):(i=r.get("Tags"),i?i.first():null)))},recalculateLikesText:function(e){var t=this.get("numLikes"),r=this.get("importantLikers"),i=r&&r.at(0),o=1,u=this.get("userIDLiked")==n.getLoggedInUserID(),a;return e=e||this.get("displayObject"),e?(i&&i.get("isLoggedIn")&&(i=r.at(1),o=2),s(r,t,this.get("globalMetadatas"),e,u),r&&r.length>o&&(a=[],_.each(r.slice(o),function(e){if(e.get("isLoggedIn"))return;a.push(e.getAnchorTag())}),e.localeVariables.initialLikers=a.join(", ")),i&&(e.localeVariables.lastLiker=i.getAnchorTag()),e):null},calculateContextText:function(e){var t=r.model.get("user"),i=t.get("favoriteUsers"),s=this.get("context"),o=this.get("globalMetadatas"),u=o&&o.user||{},a={},f,l,c,h,p;if(!s||!s.recommendationReasonIDs||!s.recommendationReasonIDs.length||!i)return e;p=function(){for(c=0,h=s.recommendationReasonIDs.length;c<h;c++){l=i.get(s.recommendationReasonIDs[c]);if(!l){l=u[s.recommendationReasonIDs[c]];if(!l)continue;l=n.Models.User.newOrUpdate(l,{dontCache:!0})}if(!a.user)a.user=l.getAnchorTag();else if(!a.user2)a.user2=l.getAnchorTag();else{if(!!a.user3)break;a.user3=l.getAnchorTag()}}return a.user?(a.others=s.recommendationReasonIDs.length-2,e):null};switch(s.recommendationReason){case"followerFavorite":case"bffFavorite":if(!p())return e;if(a.others>=2)switch(e.itemType){case"artist":f="CONTEXT_BECAUSE_USER_USER_OTHERS_FOLLOWED_ARTIST";break;case"album":f="CONTEXT_BECAUSE_USER_USER_OTHERS_FAVORITED_ALBUM";break;default:f="CONTEXT_BECAUSE_USER_USER_OTHERS_FAVORITED"}else if(a.user3)switch(e.itemType){case"artist":f="CONTEXT_BECAUSE_USER_USER_AND_USER_FOLLOWED_ARTIST";break;case"album":f="CONTEXT_BECAUSE_USER_USER_AND_USER_FAVORITED_ALBUM";break;default:f="CONTEXT_BECAUSE_USER_USER_AND_USER_FAVORITED"}else if(a.user2)switch(e.itemType){case"artist":f="CONTEXT_BECAUSE_USER_AND_USER_FOLLOWED_ARTIST";break;case"album":f="CONTEXT_BECAUSE_USER_AND_USER_FAVORITED_ALBUM";break;default:f="CONTEXT_BECAUSE_USER_AND_USER_FAVORITED"}else switch(e.itemType){case"artist":f="CONTEXT_BECAUSE_USER_FOLLOWED_ARTIST";break;case"album":f="CONTEXT_BECAUSE_USER_FAVORITED_ALBUM";break;default:f="CONTEXT_BECAUSE_USER_FAVORITED"}e.contextText=_.getString(f,a);break;case"followerListen":case"bffListen":if(!p())return e;a.others>=2?f="CONTEXT_BECAUSE_USER_USER_OTHERS_LISTENED":a.user3?f="CONTEXT_BECAUSE_USER_USER_AND_USER_LISTENED":a.user2?f="CONTEXT_BECAUSE_USER_AND_LISTENED":f="CONTEXT_BECAUSE_USER_LISTENED",e.contextText=_.getString(f,a);break;case"taste":break;default:}return e},toUrl:function(){var e=this.get("UserID"),t=r.model.get("user"),i,s,o;return t.id==e?o=t:(s=t.get("favoriteUsers"),s&&(o=s.get(e))),o||(o=n.Models.User.getCached(e)),o&&(i=o.get("Name")),_.cleanUrl(i||"-",e,"profile",null,"share/"+this.id)}},{BROADCAST_TYPES:{SONG:1,PLAYLIST:2,ARTIST:3,ALBUM:4},get:function(e){var t=new $.Deferred;return this._cache&&this._cache.hasOwnProperty(e)?t.resolve(this._cache[e]):n.Services.API.feeds3GetFeedItemsByIDs([e]).done(function(e){if(!e){t.reject();return}var r=n.Models.FeedEvent.newOrUpdate(e.feedItems[0],{metaByType:e.metaByType});t.resolve(r)}).fail(_.bind(t.reject,t)),t.promise()},getFeedEventsByIDs:function(e){var t=$.Deferred();return n.Services.API.feeds3GetFeedItemsByIDs(e).done(function(e){if(!e){t.reject();return}var r=new n.Models.Collections.FeedEvents(e.feedItems,{metaByType:e.metaByType});t.resolve(r)}).fail(_.bind(t.reject,t)),t.promise()}})}(),function(){function e(e){var t=r.model.attributes.user&&r.model.attributes.user.attributes.recentUsers;return t&&e.sort(function(e,n){var r=0,i=0,s;return e.Source!=null&&(r=e.Source.UserID),n.Source!=null&&(i=n.Source.UserID),s=_.toInt(t[i]&&t[i].TSInteraction)-_.toInt(t[r]&&t[r].TSInteraction),s===0&&(s=n.tsAdded-e.tsAdded),s}),e}function i(e){var t=[],n={},r,i;for(r=e.length-1;r>=0;r--){i=e[r].Source;if(!i||!i.UserID||n.hasOwnProperty(i.UserID))continue;n[i.UserID]=!0,t.push(i)}return t.reverse()}function s(e,t,r,i,s){var o=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),u={locale:"NOTIF_SHARED_"+i.toUpperCase()+"_YOU",localeOptions:{},link:this.toUrl(),btnIcon:"thinarrow-right"},a=_.ucwords(i,!0),f=i=="playlist"?70:40,l;u.localeOptions.user="<strong>"+_.escape(o.get("FName"))+"</strong>";if(e.length>1){if(e.length>4)u.picture=o.getImageURL(40),u.isUserPicture=!0;else{u.pictures=[],_.each(e,function(e){l=n.Models[a].newOrUpdate(e.Metadata.sharedItem,{dontCache:!0,skipUpdate:!0}),!l.get("CoverArtFilename")&&e.Metadata.sharedItem.CoverArtFilename?l.set("CoverArtFilename",e.Metadata.sharedItem.CoverArtFilename):!l.get("Picture")&&e.Metadata.sharedItem.Picture&&l.set("Picture",e.Metadata.sharedItem.Picture),u.pictures.push(l.getImageURL(f))});if(i=="user"||i=="artist")u.isUserPicture=!0}u.locale="NOTIF_SHARED_"+i.toUpperCase()+"S_YOU",u.localeOptions.count=e.length}else{u.link=o.toUrl("share/"+e[0].Metadata.feedItemID),l=n.Models[a].newOrUpdate(e[0].Metadata.sharedItem,{dontCache:!0,skipUpdate:!0}),u.picture=l.getImageURL(f);if(i==="user"||i==="artist")u.isUserPicture=!0;if(i==="broadcast"||i==="playlist")l.get("UserID")==o.id?u.locale="NOTIF_SHARED_OWN_"+i.toUpperCase()+"_YOU":u.localeOptions.owner="<strong>"+_.escape(e[0].Metadata.sharedItem.owner.FName)+"</strong>";u.btnIcon=s||"play-circle-fill",!s&&i!=="broadcast"&&(u.btnClass="play-dropdown",u.btnData={streamType:"TYPE_SHARE"},u.btnData[i+"Id"]=l.id),u.localeOptions.name="<strong>"+_.escape(l.get(i!=="user"&&i!=="broadcast"?a+"Name":"Name"))+"</strong>",u.itemModel=l,u.onBtnClick=function(e){if(i==="broadcast"){var t=l.getOwner();n.router.setHash(t.toUrl("broadcast/join"))}return $.Deferred().resolve().promise()}}return u}function o(e,t){var n="";switch(e){case"songShared":case"artistShared":case"albumShared":case"playlistShared":case"broadcastShared":n="<strong>"+_.escape(t.sharedItem.Name)+"</strong>";break;case"userShared":n="<strong>"+_.escape(t.sharedItem.FName)+"</strong>"}return n}function u(e,t){var r;switch(e){case"songShared":r=n.Models.Song.newOrUpdate(t.sharedItem,{dontCache:!0,skipUpdate:!0});break;case"artistShared":r=n.Models.Artist.newOrUpdate(t.sharedItem,{dontCache:!0,skipUpdate:!0});break;case"albumShared":r=n.Models.Album.newOrUpdate(t.sharedItem,{dontCache:!0,skipUpdate:!0});break;case"playlistShared":r=n.Models.Playlist.newOrUpdate(t.sharedItem,{dontCache:!0,skipUpdate:!0});break;case"broadcastShared":r=n.Models.Broadcast.newOrUpdate(t.sharedItem,{dontCache:!0,skipUpdate:!0});break;case"userShared":r=n.Models.User.newOrUpdate(t.sharedItem,{dontCache:!0,skipUpdate:!0})}return r}function a(e){var t=[];return _.each(e.slice(0,5),function(e){var r=n.Models.User.newOrUpdate(e,{dontCache:!0,skipUpdate:!0});t.push(r.getImageURL(40))}),t}function l(t,n,r){var s,o;r=e(r),o=i(r),s=f[n].call(this,r,o,t);if(!s)return;return s.type=n,s.timestamp=this.get("Timestamp"),s.tacoID=this.get("TacoID"),s}n.Models=n.Models||{};var f={songShared:function(e,t,n){return s.call(this,e,t,n,"song")},artistShared:function(e,t,r){var i=s.call(this,e,t,r,"artist","thinarrow-right");return i.itemModel&&(i.onBtnClick=function(){n.router.setHash(i.itemModel.toUrl())}),i},albumShared:function(e,t,n){return s.call(this,e,t,n,"album")},playlistShared:function(e,t,n){return s.call(this,e,t,n,"playlist")},userShared:function(e,t,n){return s.call(this,e,t,n,"user")},broadcastShared:function(e,t,n){return s.call(this,e,t,n,"broadcast")},comment:function(e,t,i){var s=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),u=r.model.get("user"),a={localeOptions:{},picture:s.getImageURL(40),btnIcon:"thinarrow-right"},f=this.get("ItemType"),l,c;a.localeOptions.user="<strong>"+s.escape("Name")+"</strong>";switch(f){case"user":l="PROFILE",a.link=u.toUrl();break;case"playlist":l="PLAYLIST",a.link=i.toUrl(),a.localeOptions.name="<strong>"+i.escape("PlaylistName")+"</strong>";break;case"song":l="SONG",a.localeOptions.name="<strong>"+i.escape("SongName")+"</strong>";break;case"artist":l="ARTIST",a.link=i.toUrl(),a.localeOptions.name="<strong>"+i.escape("ArtistName")+"</strong>";break;case"album":l="ALBUM",a.link=i.toUrl(),a.localeOptions.name="<strong>"+i.escape("AlbumName")+"</strong>";break;case"feedEvent":l="FEED_EVENT",a.link=i.toUrl(),c=this.get("ItemMetadata"),a.localeOptions.name=o(i.get("EventType"),this.get("ItemMetadata"));break;default:throw new Error("comment not supported for "+f)}return t.length>1?(a.localeOptions.others=t.length-2,t.length>2?a.locale="NOTIF_COMMENT_USER_USER_AND_OTHERS_"+l:a.locale="NOTIF_COMMENT_USER_USER_"+l,a.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>",a.pictures=[],a.link+="/comment/"+e[e.length-1].Metadata.commentID):(a.link+="/comment/"+e[0].Metadata.commentID,l==="FEED_EVENT"&&(l="FEED_EVENT_2"),a.locale="NOTIF_COMMENT_"+l,a.message=e[e.length-1].Metadata.message),a},relatedComment:function(e,t,r){var i=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),s={localeOptions:{},btnIcon:"thinarrow-right"},o=this.get("ItemType"),u=t.length>1,f;s.localeOptions.user="<strong>"+i.escape("Name")+"</strong>";switch(o){case"feedEvent":u?t.length>2?s.locale="NOTIF_PEOPLE_COMMENT_SHARE_TAGGED":s.locale="NOTIF_USER_USER_COMMENT_SHARE_TAGGED":s.locale="NOTIF_COMMENT_SHARE_TAGGED",s.link=r.toUrl(),f=this.get("ItemMetadata"),s.localeOptions.author="<strong>"+_.escape(f.owner.FName)+"</strong>";break;default:throw new Error("relatedComment not supported for "+o)}return u?(s.localeOptions.count=e.length,s.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>",s.pictures=a(t)):(s.link+="/comment/"+e[0].Metadata.commentID,s.picture=i.getImageURL(40),s.isUserPicture=!0,s.message=e[e.length-1].Metadata.message),s},commentInThread:function(e,t,r){var i=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),s={localeOptions:{},btnIcon:"thinarrow-right"},o=this.get("ItemType"),u="",f=!1,l;s.localeOptions.user="<strong>"+i.escape("Name")+"</strong>",o=="comment"&&(f=!0,u+="REPLY_",l=this.get("ItemMetadata"),o=l.commentedOnItemType,r=n.Models[_.ucwords(l.commentedOnItemType,!0)].newOrUpdate(l.itemMetadata,{dontCache:!0,skipCache:!0}));switch(o){case"user":r.id==n.getLoggedInUserID()?u+="YOUR_PROFILE":u+="USER",s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("Name")+"</strong>";break;case"playlist":u+="PLAYLIST",s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("PlaylistName")+"</strong>";break;case"song":u+="SONG",s.localeOptions.name="<strong>"+r.escape("SongName")+"</strong>";break;case"artist":u+="ARTIST",s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("ArtistName")+"</strong>";break;case"album":u+="ALBUM",s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("AlbumName")+"</strong>";break;case"feedEvent":s.link=r.toUrl(),l=this.get("ItemMetadata"),l.owner==null||l.owner.UserID==n.getLoggedInUserID()?u+="YOUR_":s.localeOptions.author="<strong>"+_.escape(l.owner.FName)+"</strong>",u+="SHARE";break;default:throw new Error("relatedComment not supported for "+o)}return t.length>1?(t.length>2||f?s.locale="NOTIF_PEOPLE_COMMENT_THREAD_"+u:s.locale="NOTIF_USER_USER_COMMENT_THREAD_"+u,s.localeOptions.count=e.length,s.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>",s.pictures=a(t)):(s.locale="NOTIF_COMMENT_THREAD_"+u,s.link+="/comment/"+e[0].Metadata.commentID,s.picture=i.getImageURL(40),s.isUserPicture=!0,s.message=e[e.length-1].Metadata.message),s},commentReply:function(e,t,r){var i=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),s={localeOptions:{},btnIcon:"thinarrow-right"},o=e[0].Metadata.commentedOnItemType||this.attributes.ItemMetadata.commentedOnItemType,u="",f=e[0].Metadata.itemMetadata||this.attributes.ItemMetadata.itemMetadata,l;s.localeOptions.user="<strong>"+i.escape("Name")+"</strong>",r=n.Models[_.ucwords(o,!0)].newOrUpdate(f,{dontCache:!0,skipUpdate:!0}),s.picture=r.getImageURL(40);switch(o){case"user":u="USER",r.id==n.getLoggedInUserID()&&(u="YOUR_PROFILE",delete s.picture,s.pictures=a(t)),s.isUserPicture=!0,s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("Name")+"</strong>";break;case"playlist":u="NAME",s.picture=r.getImageURL(70),s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("PlaylistName")+"</strong>";break;case"song":u="NAME",s.localeOptions.name="<strong>"+r.escape("SongName")+"</strong>";break;case"artist":u="NAME",s.isUserPicture=!0,s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("ArtistName")+"</strong>";break;case"album":u="NAME",s.link=r.toUrl(),s.localeOptions.name="<strong>"+r.escape("AlbumName")+"</strong>";break;case"feedEvent":u="SHARE",s.link=r.toUrl(),l=e[0].Metadata.itemMetadata,!l.owner||l.owner.UserID==n.getLoggedInUserID()?u="YOUR_SHARE":s.localeOptions.author="<strong>"+_.escape(l.owner.FName)+"</strong>",l.owner.Picture?s.picture=_.getImageURL(n.Models.Artist.artPath+"40_"+l.owner.Picture):s.picture=_.getImageURL(n.Models.Artist.artPath+"40_user.png");break;default:throw new Error("replyComment not supported for "+o)}return s.link+="/comment/"+e[0].Metadata.commentID,t.length>1?(t.length>2?s.locale="NOTIF_PEOPLE_COMMENT_INCEPTION_"+u:s.locale="NOTIF_USER_USER_COMMENT_INCEPTION_"+u,s.localeOptions.others=t.length-2,s.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>",s.pictures=a(t)):(s.locale="NOTIF_COMMENT_INCEPTION_"+u,s.picture=i.getImageURL(40),s.isUserPicture=!0,s.message=e[e.length-1].Metadata.message),s},like:function(e,t,r){var i=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),s={locale:"NOTIF_LIKED_SHARE",localeOptions:{},link:r.toUrl(),btnIcon:"thinarrow-right"},a=this.get("ItemMetadata"),f=u(r.get("EventType"),a);return s.localeOptions.user="<strong>"+i.escape("Name")+"</strong>",s.localeOptions.name="<strong>"+o(r.get("EventType"),a)+"</strong>",f instanceof n.Models.Playlist?s.picture=f.getImageURL(70):s.picture=f.getImageURL(40),t.length>1&&(t.length>2?t.length>3?s.locale="NOTIF_USER_USER_OTHERS_LIKED_SHARE":s.locale="NOTIF_USER_USER_OTHER_LIKED_SHARE":s.locale="NOTIF_USER_USER_LIKED_SHARE",s.localeOptions.others=t.length-2,s.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>"),s},playlistSubscribed:function(e,t,r){var i=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),s={locale:"NOTIF_USER_FOLLOWED_YOUR_PLAYLIST_2",localeOptions:{},link:this.toUrl(),picture:r.getImageURL(70),btnIcon:"thinarrow-right"};return s.localeOptions.user="<strong>"+i.escape("Name")+"</strong>",s.localeOptions.playlist="<strong>"+r.escape("PlaylistName")+"</strong>",t.length>1?(s.localeOptions.count=t.length,s.locale="NOTIF_USERS_FOLLOWED_YOUR_PLAYLIST"):s.link=r.toUrl(),s},friendJoined:function(e,t,i){var s=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),o="@"+e[0].Metadata.twitterHandle,u=r.model.get("user"),f=u.get("favoriteUsers"),l={locale:"NOTIF_FRIEND_FROM_TWITTER_JOINED_2",localeOptions:{},link:this.toUrl(),picture:s.getImageURL(40),isUserPicture:!0,btnIcon:"thinarrow-right"};return l.localeOptions.user="<strong>"+_.escape(s.get("hasDefaultName")?o:s.get("Name"))+"</strong>",e.length>1?(l.localeOptions.count=t.length,l.locale="NOTIF_FRIENDS_FROM_TWITTER_JOINED",l.pictures=a(t)):(l.link=s.toUrl(),f.get(s.id)?l.btnIcon="check":l.btnIcon="plus",l.onBtnClick=function(e){var t=$.Deferred();return f.get(s.id)?u.unfavorite("Users",s).done(function(){e.btnIcon="plus",l.btnIcon="plus",t.resolve()}).fail(_.bind(t.reject,t)):u.favorite("Users",s).done(function(){e.btnIcon="check",l.btnIcon="check",t.resolve()}).fail(_.bind(t.reject,t)),t.promise()}),l},follow:function(e,t,i){var s=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),o=r.model.get("user"),u=o.get("favoriteUsers"),f={locale:"NOTIF_USER_FOLLOWED_YOU_2",localeOptions:{},link:this.toUrl(),isUserPicture:!0,btnIcon:"thinarrow-right"};return f.localeOptions.user="<strong>"+s.escape("Name")+"</strong>",t.length>1?(t.length>2?(f.locale="NOTIF_USER_USER_AND_OTHERS_FOLLOWED_YOU",f.localeOptions.others=t.length-2):f.locale="NOTIF_USER_AND_USER_FOLLOWED_YOU",f.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>",f.pictures=a(t)):(f.picture=s.getImageURL(40),f.link=s.toUrl(),u.get(s.id)?f.btnIcon="check":f.btnIcon="plus",f.onBtnClick=function(e){var t=$.Deferred();return u.get(s.id)?o.unfavorite("Users",s).done(function(){e.btnIcon="plus",f.btnIcon="plus",t.resolve()}).fail(_.bind(t.reject,t)):o.favorite("Users",s).done(function(){e.btnIcon="check",f.btnIcon="check",t.resolve()}).fail(_.bind(t.reject,t)),t.promise()}),f},invitedUserJoined:function(e,t,i){var s=n.Models.User.newOrUpdate(t[0],{dontCache:!0,skipUpdate:!0}),o=r.model.get("user"),u=o.get("favoriteUsers"),f={locale:"NOTIF_INVITED_USER_JOINED",localeOptions:{},link:this.toUrl(),isUserPicture:!0,btnIcon:"thinarrow-right"};return f.localeOptions.user="<strong>"+s.escape("Name")+"</strong>",t.length>1?(t.length>2?(f.locale="NOTIF_INVITED_USER_USER_AND_OTHERS_JOINED",f.localeOptions.others=t.length-2):f.locale="NOTIF_INVITED_USER_AND_USER_JOINED",f.localeOptions.user2="<strong>"+_.escape(t[1].FName)+"</strong>",f.pictures=a(t)):(f.picture=s.getImageURL(40),f.link=s.toUrl(),u.get(s.id)?f.btnIcon="check":f.btnIcon="plus",f.onBtnClick=function(e){var t=$.Deferred();return u.get(s.id)?o.unfavorite("Users",s).done(function(){e.btnIcon="plus",f.btnIcon="plus",t.resolve()}).fail(_.bind(t.reject,t)):o.favorite("Users",s).done(function(){e.btnIcon="check",f.btnIcon="check",t.resolve()}).fail(_.bind(t.reject,t)),t.promise()}),f}};n.Models.Taco=Backbone.CachedModel.extend({idAttribute:"GroupID",parse:function(e,t){return t&&t.skipParse?e:{GroupID:e.GroupID,Type:e.Type,ItemID:e.ItemID,ItemType:e.ItemType,ItemMetadata:e.ItemMetadata||null,Timestamp:Math.floor(e.Timestamp/1e3),Instances:e.Instances,userID:n.getLoggedInUserID(),unseen:!!e.unseen}},updateFromNew:function(e){if(!e&&this.id!=e.GroupID)return;var n=this.get("ItemMetadata");$.extend(n,e.ItemMetadata),this.set({Instances:e.Instances,ItemMetadata:n,normalizedObject:t})},getItem:function(){var e=this.get("cachedItem"),t,r;return typeof e!="undefined"?e:(t=this.get("ItemType"),r=this.get("ItemMetadata"),!t||!r?e=null:e=n.Models[_.ucwords(t,!0)].newOrUpdate(r,{dontCache:!0,skipUpdate:!0}),this.set("cachedItem",e),e)},getLastInstance:function(){var e=this.get("Instances");return e[e.length-1]},getNormalizedObject:function(){var e=this.get("normalizedObject"),t,n,r;if(typeof e!="object")try{n=this.getItem(),r=this.get("Type"),t=l.call(this,n,r,this.get("Instances"));if(!t)return;this.set("normalizedObject",t),e=t}catch(i){return gsConfig.runMode!=="production"&&console.warn("Couldn't process taco",i,i.message,this),null}return e.time=_.getFormattedDate(e.timestamp),_.clone(e)},getNormalizedObjectForInstance:function(e){var t,n,r;try{n=this.getItem(),r=this.get("Type"),t=l.call(this,n,r,[e]);if(!t)return;t.time=_.getFormattedDate(t.timestamp)}catch(i){return gsConfig.runMode!=="production"&&console.warn("Couldn't process single instance taco",i,i.message,e,this),null}return t},toUrl:function(){var e=r.model.get("user");return this.get("userID")!=e.get("UserID")?"/notFound":e.toUrl("notification/"+this.get("GroupID"))}},{})}(),function(){function w(e){var t={};e=_.toInt(e);switch(e){case 1:case 3:case 4:t.type=c,t.length=p,t.special=!0;break;case 2:t.type=c,t.length=v,t.special=!0;break;case 5:t.type=c,t.length=p,t.special=!0;break;case 6:case 15:case 20:t.type=l,t.length=p;break;case 7:case 16:case 19:t.type=l,t.length=v;break;case 8:case 10:case 11:case 13:case 14:case 17:t.type=c,t.length=p;break;case 9:case 18:t.type=c,t.length=v;break;case 12:t.type=c,t.length=h;break;case 21:t.type=f,t.length=p;break;case 22:t.type=f,t.length=v;break;case 97:t.type=f,t.length=m;break;case 98:t.type=l,t.length=m;break;case 99:t.type=c,t.length=m}return t}function E(e,t){var r=e.bVip===1||e.bVip==="1",i={vip:r,isLoaded:!0},s;if((e===!1||!e.paymentType)&&t&&t.get("IsPremium"))i.SubscriptionTypeID=99,i.type=c,i.length=m,t.get("Flags")&n.Models.User.FLAG_ANYWHERE||(t.get("Flags")&n.Models.User.FLAG_PLUS?(i.SubscriptionTypeID=98,i.type=l):t.get("Flags")&n.Models.User.FLAG_LITE&&(i.SubscriptionTypeID=97,i.type=f));else if(!e||!e.bActive||e.bActive=="0")i={SubscriptionTypeID:0,vip:r,isLoaded:!0};else{i.SubscriptionTypeID=e.subscriptionTypeID;if(i.SubscriptionTypeID>0){var o=w(i.SubscriptionTypeID);i=$.extend({},o,i)}i.recurring=e.bRecurring,(e.bVip==="1"||e.bVip===1)&&t&&t.get("IsPremium")&&(i.type=c),i.paymentMethod=_.orEqual(e.paymentType,"UNKNOWN"),i.billingAmount=parseFloat(e.amount).toFixed(2);if(e.dateUnsubscribed){var a=e.dateUnsubscribed.split("-");a.length>1&&(i.unsubscriptionDate=new Date(_.toInt(a[0]),_.toInt(a[1])-1,_.toInt(a[2])))}if((e.dateSubscriptionEnd||e.dateEnd||e.dateSubcriptionEnd)&&!i.recurring)try{var d=_.orEqual(e.dateSubscriptionEnd,e.dateSubcriptionEnd,e.dateEnd,"").split("-");d.length>1&&(i.endDate=new Date(_.toInt(d[0]),_.toInt(d[1])-1,_.toInt(d[2])))}catch(g){i.endDate=-1}else i.unsubscriptionDate&&(i.endDate=i.unsubscriptionDate);if((e.dateNextBill||e.dateNextCheck)&&i.recurring&&e.dateStart!=e.dateNextCheck)try{var y=_.orEqual(e.dateNextBill,e.dateNextCheck,"").split("-");y.length>1&&(i.nextBillDate=new Date(_.toInt(y[0]),_.toInt(y[1])-1,_.toInt(y[2])))}catch(g){i.nextBillDate=-1}else e.dateStart==e.dateNextCheck&&(i.nextBillDate=i.endDate);e.period=="MONTH"?(i.length=p,s=u.PLAN_PERIODS.MONTH):e.period=="YEAR"?(i.length=v,s=u.PLAN_PERIODS.YEAR):e.period=="WEEK"&&(i.length=h,s=u.PLAN_PERIODS.WEEK),i.recurBillPeriod=s,t&&(t.get("Flags")&n.Models.User.FLAG_ANYWHERE)>0?i.type=c:t&&(t.get("Flags")&n.Models.User.FLAG_PLUS)>0&&t.get("IsPremium")?i.type=l:t&&(t.get("Flags")&n.Models.User.FLAG_LITE)>0&&(i.type=f)}return i}function S(e,t){var r={isLoaded:!0},i;if((!e||!e.UserID)&&t&&t.get("IsPremium"))r.SubscriptionTypeID=99,r.type=c,r.length=m,t.get("Flags")&n.Models.User.FLAG_ANYWHERE||(t.get("Flags")&n.Models.User.FLAG_PLUS?(r.SubscriptionTypeID=98,r.type=l):t.get("Flags")&n.Models.User.FLAG_LITE&&(r.SubscriptionTypeID=97,r.type=f));else if(!e||!e.Status||e.Status==="0")r={SubscriptionTypeID:0,isLoaded:!0};else{i=_.toInt(e.Flags),r.SubscriptionTypeID=_.toInt(e.SubType);if(r.SubscriptionTypeID>0){var s=w(r.SubscriptionTypeID);r=$.extend({},s,r)}r.recurring=!parseInt(e.CancelAtPeriodEnd,10),r.paymentMethod=_.orEqual(e.api,"UNKNOWN").toUpperCase(),e.Amount?r.billingAmount=parseFloat(e.Amount).toFixed(2):r.billingAmount="0.00";switch(_.toInt(e.Period)){case g:r.length=p;break;case y:r.length=v;break;case b:r.length=h}if(e.TSEnded&&e.TSEnded!=="0"){var o=new Date;o.setTime(_.toInt(e.TSEnded)*1e3),r.unsubscriptionDate=o}if(e.finalEndDate&&e.finalEndDate!=="0"&&!r.recurring){var a=new Date;a.setTime(_.toInt(e.finalEndDate)*1e3),r.endDate=a}else if(e.TSPeriodEnd&&e.TSPeriodEnd!=="0"&&!r.recurring){var d=new Date;d.setTime(_.toInt(e.TSPeriodEnd)*1e3),r.endDate=d}else if(r.unsubscriptionDate)r.endDate=r.unsubscriptionDate;else if(e.TSStart&&r.length){var E=new Date;E.setTime(parseInt(e.TSStart,10)*1e3),r.length===p?E.setMonth(E.getMonth()+1):r.length===v?E.setYear(E.getYear()+1):r.length===h&&E.setYear(E.getWeek()+1),r.endDate=E}r.inTrialPeriod=e.TSPeriodStart-30<=e.TSStart&&(i&u.FLAGS.HAS_TRIAL)===u.FLAGS.HAS_TRIAL;if(e.TSPeriodStart&&e.TSPeriodStart!=="0"&&r.recurring){var S=new Date;S.setTime(parseInt(e.TSPeriodEnd,10)*1e3),r.nextBillDate=S}if(e.recurBillDate){var x=new Date;x.setTime(parseInt(e.recurBillDate,10)*1e3),r.recurBillDate=x}r.recurBillAmount=e.recurBillAmount?parseFloat(e.recurBillAmount).toFixed(2):0,r.recurBillPeriod=e.recurBillPeriod||0,r.recurBillType=(e.recurSubType||"").toUpperCase(),r.recurCurrency=e.currency||"usd",r.recurCurrencySymbol=e.currencySymbol||"$",t&&(t.get("Flags")&n.Models.User.FLAG_ANYWHERE)>0?r.type=c:t&&(t.get("Flags")&n.Models.User.FLAG_PLUS)>0&&r.type!==c?r.type=l:t&&(t.get("Flags")&n.Models.User.FLAG_LITE)>0&&r.type!==c&&r.type!==l?r.type=f:r.type=_.toInt(e.SubType),t&&r.type===c?t.set("Flags",t.get("Flags")|n.Models.User.FLAG_ANYWHERE):t&&r.type===l?t.set("Flags",t.get("Flags")|n.Models.User.FLAG_PLUS):t.set("Flags",t.get("Flags")|n.Models.User.FLAG_LITE),e.api==="paypal"&&(r.PaypalProfileID=e.ProfileID)}return r}function x(e){switch(e){case f:return i.canListen|i.email;case l:return i.canListen|i.noAds|i.playerBonuses|i.desktop|i.email;case c:return i.canListen|i.noAds|i.mobile|i.playerBonuses|i.desktop|i.email}return 0}function T(e){return e.type=_.orEqual(e.type,0),e.length=_.orEqual(e.length,0),e.billingAmount=_.orEqual(e.billingAmount,0),e.recurring=_.orEqual(e.recurring,!1),e.features=x(e.type),e.endDate=_.orEqual(e.endDate,null),e.nextBillDate=_.orEqual(e.nextBillDate,null),e.unsubscriptionDate=_.orEqual(e.unsubscriptionDate,null),e.paymentMethod=_.orEqual(e.paymentMethod,null),e.vip=_.orEqual(e.vip,!1),e.isLoaded=e.isLoaded?!0:!1,e}n.Models=n.Models||{};var t=e.nodeWebkit,r=0,i={canListen:1,noAds:2,mobile:4,playerBonuses:8,desktop:16,email:32},s={plus:{month:6,year:60,currency:"usd",currencySymbol:"$"},anywhere:{month:9,year:90,currency:"usd",currencySymbol:"$"},lite:{month:2,year:20,currency:"usd",currencySymbol:"$"},liteEx:{month:4,year:40,currency:"usd",currencySymbol:"$"},codes:{"1month":9,"3month":27,"6month":54,"12month":90}},o,a=-1;setTimeout(function(){n.ready.done(function(){var t=gsConfig&&gsConfig.saleTerms,n=t&&t.completeTime;n&&Date.now()+e.clientTimeDivergence<n*1e3&&(s.saleActive=!0,s.anywhere={month:t.priceMonth,year:t.priceYear},s.codes={"1month":t.priceMonth,"3month":t.priceMonth*3,"6month":t.priceMonth*6,"12month":t.priceYear})})},10);var f=21,l=6,c=8,h=2,p=3,d=7,v=9,m=11,g=0,y=1,b=2;u=Backbone.Model.extend({idAttribute:"SubscriptionID",parse:function(e,t){if(t&&t.skipParse)return e;var n=t&&t.clone===!1?e:_.clone(e);n.apiVersion=_.orEqual(n.apiVersion,1);if(n.hasOwnProperty("details")&&n.hasOwnProperty("user"))n.apiVersion===2?$.extend(n,S(n.details,n.user)):$.extend(n,E(n.details,n.user));else if(n.SubscriptionTypeID>0){var r=w(n.SubscriptionTypeID);n=$.extend({},r,n)}return n.user&&n.user.id!==a&&(o=null,a=n.user.id),n.hasSpecialPricing=_.orEqual(n.hasSpecialPricing,!1),delete n.details,delete n.user,n=T($.extend(n,!0)),n},initialize:function(){typeof Object.defineProperty=="function"&&this.freeze(),this.on("freeAdExpiresUpdate",function(e){e>r&&e>Date.now()-(144e5+1)&&(r=e,this.trigger("ad:handleSub"))},this)},get:function(e){switch(e){case"altPricing":return o}return this.attributes[e]},isActive:function(){var t=Date.now()+e.clientTimeDivergence;return this.get("endDate")&&this.get("endDate")<t?!1:!0},getTypeName:function(){switch(this.get("type")){case f:return"Grooveshark";case l:case c:return $.localize.getString("GROOVESHARK_VIP")}return""},getTypeString:function(){switch(this.get("type")){case f:return"lite";case l:return"plus";case c:return"anywhere"}return""},getPrices:function(){var e={},t;if(this.hasRecurring()){var n,r;this.get("apiVersion")==2?(n=_.toInt(this.get("recurBillAmount")),n&&this.get("recurBillPeriod")==g?r=n:n&&(r=n/10)):this.isAnywhere()&&(n=_.toInt(this.get("billingAmount")),this.get("length")==p?r=n:n&&(r=n/10)),r&&(e.anywhere={month:r,year:r*10,currency:this.get("recurCurrency"),currencySymbol:this.get("recurCurrencySymbol")}),t=$.extend(!0,{},s,e)}else this.get("hasSpecialPricing")&&this.get("altPricing")?(e=this.get("altPricing"),t=e):t=$.extend(!0,{},s);return s.anywhere&&e.anywhere&&(t.anywhere.month=Math.min(s.anywhere.month,e.anywhere.month),t.anywhere.year=Math.min(s.anywhere.year,e.anywhere.year)),t},loadSpecialPricing:function(){var e=$.Deferred();return this.get("hasSpecialPricing")&&this.get("altPricing")?e.resolve(this.get("altPricing")):n.Services.API.getUserPricing().done(_.bind(function(t){o=$.extend(!0,{},s),t.userSpecialPricing&&t.userSpecialPricing.Price?(o.anywhere.month=parseFloat(t.userSpecialPricing.Price)||0,o.anywhere.year=parseFloat(t.userSpecialPricing.YearPrice)||0):t.creditPlans&&t.creditPlans.monthCents&&(o.anywhere.month=(parseFloat(t.creditPlans.monthCents)||0)/100,o.anywhere.year=(parseFloat(t.creditPlans.yearCents)||0)/100,o.anywhere.currency=t.creditPlans.currency,o.anywhere.currencySymbol=t.creditPlans.currencySymbol,s.anywhere=o.anywhere,s.saleActive=t.creditPlans.isSalePrice,s.hasTrialOption=t.creditPlans.hasTrialOption),e.resolve($(!0,{},o))},this)).fail(function(){e.reject()}),e.promise()},hasSubscription:function(){return this.get("type")>0},hasRecurring:function(){return this.get("recurring")||this.get("recurBillAmount")},isPremium:function(){return this.get("type")!==f&&this.get("type")!==0},isPlus:function(){return this.get("type")===l},isAnywhere:function(){return this.get("type")===c},isLite:function(){return this.get("type")===f},isSpecial:function(){return this.get("length")===m},canHideAds:function(){if((gsConfig.inOffice||_.cookie("g53Mpl0y33"))&&(gsConfig.runMode=="production"||gsConfig.runMode=="framily"||gsConfig.httpHost=="t3.grooveshark.com")){var e=["5be3","d798","1e133b","3c8c8c","1e","f27","2a","f","8694c1","1529a6","14b1c06","17a681d","1438249","1796362","1c47062"];if(_.indexOf(e,parseInt(n.getLoggedInUserID()).toString(16))<0)return _.cookie("g53Mpl0y33",!0),!1}return t||(this.get("features")&i.noAds)>0||r>Date.now()},canUsePlayerBonuses:function(){return this.isAnywhere()||this.isPlus()},canListenUninterrupted:function(){return(this.get("features")&i.canListen)>0||r>Date.now()},canDirectEmail:function(){return(this.get("features")&i.email)>0},canUseDesktop:function(){return(this.get("features")&i.desktop)>0},getNextBillDate:function(){return this.get("nextBillDate")>0?this.get("nextBillDate").format("F j, Y"):this.get("recurBillDate")>0?this.get("recurBillDate").format("F j, Y"):null},getEndDate:function(){return this.get("endDate")>0?this.get("endDate").format("F j, Y"):null},canExtend:function(){return this.get("length")!==m&&!this.hasRecurring()},canUpgradeToLite:function(){return!(this.isLite()||this.isSpecial()||this.isPlus()||this.isAnywhere())},canUpgradeToPlus:function(){return!this.isPlus()&&!this.isSpecial()},canUpgradeToAnywhere:function(){return!this.isAnywhere()&&!this.isSpecial()},premiumRequired:function(){return this.isPremium()?!1:!this.canUseDesktop()&&n.External.DesktopBridge.active}},{FLAGS:{HAS_TRIAL:8},PLAN_TYPES:{ANYWHERE:8,PLUS:6,LITE:21},PLAN_PERIODS:{MONTH:g,YEAR:y,WEEK:b},PLAN_LENGTHS:{MONTH:p,YEAR:v,WEEK:h},get:function(e){var t=$.Deferred(),r=e.get("Flags")&n.Models.User.FLAG_HAS_SPECIAL_PRICE;if(e.get("Flags")&n.Models.User.FLAG_HAS_NEW_SUB)n.Services.API.nautilusFetchSubscriptionStatusEx().done(function(n){var i=new u({details:n,user:e,apiVersion:2,hasSpecialPricing:r});i.loadSpecialPricing().done(function(){t.resolve(i)})}).fail(function(e){t.reject(e)});else if(e.get("isLoggedIn"))n.Services.API.getSubscriptionDetails().done(function(n){var i=new u({details:n,user:e,hasSpecialPricing:r});i.loadSpecialPricing().done(function(){t.resolve(i)})}).fail(function(e){t.reject(e)});else{var i=new u({isLoaded:!0,user:this});t.resolve(i)}return t}}),n.Models.Subscription={PLAN_PERIODS:u.PLAN_PERIODS,PLAN_LENGTHS:u.PLAN_LENGTHS,PLAN_TYPES:u.PLAN_TYPES}}(),function(){n.Models=n.Models||{};var e=/\u0000/g,t=n.Models.PlayContext=function(r,i){r=_.orEqual(r,{});if(r.fromStored)return this.data=r.data,this.type=r.type,this.streamType=r.streamType,this;this.type=r instanceof Backbone.Model?_.getItemType(r):"unknown",_.isFunction(r.getDetailsForFeeds)?this.data=r.getDetailsForFeeds():_.isFunction(r.getDetailsForSwf)?this.data=r.getDetailsForSwf():_.isFunction(r.toJSON)?this.data=r.toJSON():r instanceof Backbone.Model?this.data={}:this.data=r,this.type==="unknown"&&this.data.hasOwnProperty("contextType")&&(this.type=this.data.contextType,delete this.data.contextType),this.type==="album"&&r.get("CoverArtFilename")&&(this.data.CoverArtFilename=r.get("CoverArtFilename")),this.type==="playlist"&&(this.addStreamType(t.TYPE_PLAYLIST),r.get("UserID")!=n.getLoggedInUserID()&&this.addStreamType(t.TYPE_OTHER_PLAYLIST)),this.type==="popular"&&this.addStreamType(t.TYPE_POPULAR),this.type==="user"&&r.get("UserID")==n.getLoggedInUserID()&&this.addStreamType(t.TYPE_LIBRARY),this.type==="artist"&&this.addStreamType(t.TYPE_DEFAULT),this.type==="radio"&&(i&&i.clientRadio?(this.type="clientRadio",this.addStreamType(n.Models.PlayContext.TYPE_STATION)):this.addStreamType(t.TYPE_RADIO)),this.type==="broadcast"&&(i&&i.archivedBroadcast&&(this.data.archivedBroadcast=!0),this.addStreamType(t.TYPE_BROADCAST));for(var s in this.data)this.data.hasOwnProperty(s)&&typeof this.data[s]=="string"&&(this.data[s]=this.data[s].replace(e,""));i&&i.streamTypes&&this.addStreamTypes(i.streamTypes)};t.prototype.getStorable=function(){return{data:_.clone(this.data),type:this.type,streamType:this.streamType,fromStored:!0}},t.prototype.addStreamType=function(e){e=_.toInt(e),_.defined(this.streamType)||(this.streamType=0),this.streamType=this.streamType|e},t.prototype.addStreamTypes=function(e){var t=this;_.each(e,function(e){e=$.trim(e),_.defined(n.Models.PlayContext[e])&&t.addStreamType(n.Models.PlayContext[e])})},t.prototype.addDefaultType=function(){this.addStreamType(t.TYPE_DEFAULT)},t.prototype.clone=function(){var e=new n.Models.PlayContext;return $.extend(!0,e,this),e},t.TYPE_DEFAULT=0,t.TYPE_STATION=1,t.TYPE_RADIO=2,t.TYPE_DMCA_RADIO=4,t.TYPE_VIP=8,t.TYPE_PLAYLIST=16,t.TYPE_LIBRARY=32,t.TYPE_POPULAR=64,t.TYPE_HOME_RADIO_SEEDS=128,t.TYPE_USER_STATION=256,t.TYPE_BROADCAST=512,t.TYPE_RECOMMENDED=1024,t.TYPE_SHARE=2048,t.TYPE_ACTIVITY=4096,t.TYPE_PLAY_ALL=8192,t.TYPE_OTHER_PLAYLIST=16384}(),function(){n.Models=n.Models||{},n.Models.Theme=Backbone.Model.extend({idAttribute:"id",trackView:function(){n.Services.API.logTargetedThemeImpression(this.id),n.Models.Ad.loadTracking(this.get("tracking"))},getViewPath:function(){return["themes",this.get("location"),"index.js"].join("/")+"?_="+$.now()},getTemplatePath:function(){return"themes/"+this.get("location")+"/index"},getRootPath:function(){return"/themes/"+this.get("location")+"/"},getAssetPath:function(){return"themes/"+this.get("location")+"/"},getVideoHeaderTemplatePath:function(){return"themes/"+this.model.get("location")+"/videoheader"}},{THEME_FLAG_DEFAULT:0,THEME_FLAG_FAMILY_FRIENDLY:1,themePages:["home","search","popular","broadcasts","promotion"],topLevelPages:["home","search","popular","broadcasts"],themeSetByUser:!1,version:0,definitionsUpdated:0,versions:0,themes:{999:{id:999,location:"stingrayVIP"},1e3:{id:1e3,location:"stingrayNonVIP"},1877:{id:1877,location:"stingrayCapitalBanner"},1896:{id:1896,location:"stingraySignup"},1897:{id:1897,location:"stingrayVIPTrial"}},getThemeDefinitions:function(t){if(!t&&this.themeDfd)return this.themeDfd.promise();var n=this.themeDfd=$.Deferred();if(!t&&!this.themeSetByUser)return this.definitionsUpdated=Date.now(),this.themeDfd.resolve(),this.themeDfd.promise();var r=document.getElementsByTagName("script")[0],i=document.getElementById("themeJS"),s=r.parentNode,o=document.createElement("script");return i&&i.parentNode.removeChild(i),o.type="text/javascript",o.async=!0,e.gsProduction&&e.gsProduction.THEMES?o.src=gsConfig.assetHost+e.gsProduction.THEMES.assetPath:o.src=gsConfig.assetHost+"/themes/themes.js?_="+Date.now(),o.id="themeJS",o.onError=function(){n.reject()},o.onreadystatechange=function(){if(this.readyState!=="complete"&&this.readyState!=="loaded")return;this.status==404&&this.onError()},s.appendChild(o),n.promise()},topLevelCheck:function(e,t){return _.indexOf(this.topLevelPages,e)>=0},themePageCheck:function(e,t){return _.indexOf(this.themePages,e)>=0},cleanURL:function(e){var t=Date.now();return e.replace(/%c/g,"").replace(/%n/g,t).replace(/'%%CLICK_URL_UNESC%%'/g,"").replace(/%%CACHEBUSTER%%/g,t)}})}(),function(){function i(e){var t=!0,n=0,r="",s,u,a,f,l;if(e.hasAttributes()){t={};for(n;n<e.attributes.length;n++)s=e.attributes.item(n),t["@"+s.name.toLowerCase()]=o($.trim(s.value))}if(e.hasChildNodes())for(l=0;l<e.childNodes.length;l++)u=e.childNodes.item(l),u.nodeType===4?r+=u.nodeValue:u.nodeType===3?r+=$.trim(u.nodeValue):u.nodeType===1&&!u.prefix&&(n===0&&(t={}),a=u.nodeName.toLowerCase(),f=i(u),t.hasOwnProperty(a)?(t[a].constructor!==Array&&(t[a]=[t[a]]),t[a].push(f)):(t[a]=f,n++));return r&&(_.isObject(t)&&n>0?t.keyValue=o(r):t=o(r)),t}function s(e){var t=0,n=String(e).split(":");return t+=n[0]*60*60,t+=n[1]*60,t+=parseFloat(n[2]),t}function o(e){return/^\s*$/.test(e)?null:/^(?:true|false)$/i.test(e)?e.toLowerCase()==="true":isFinite(e)?parseFloat(e):isFinite(Date.parse(e))?new Date(e):e}n.Models=n.Models||{};var u=n.Models.Ad=Backbone.Model.extend({idAttribute:"AdID"},{useTestAds:!1,useTestAdsValue:null,RANDOM_PERCENT:Math.floor(Math.random()*10)+1,personalizedTags:null,adRotationCount:0,topLevel:!1,areas:[],defaultAreas:function(e){return e.areaCheck?Number(_.indexOf(this.areas,e.areaCheck)>=0):(e.areaIn&&(this.defaultAreas({areaCheck:e.areaIn})||this.areas.push(e.areaIn)),0)},loadTracking:function(e,t){if(_.isArray(e)){var n=(new Date).getTime(),r;_.forEach(e,function(e){e&&(e=e.replace("%n",n),e.indexOf("pointroll")==-1&&(e.indexOf("?")!=-1?e+="&"+n:e+="?"+n),r=new Image,$("body").append($(r).load(function(e){$(e.target).remove()}).css("visibility","hidden").attr("src",e)))})}},loadCustomTracking:function(e,t){switch(e){case"iframe":var n=$("<iframe>");$("body").append(n.css({width:1,height:1,visibility:"hidden"}).attr("src",t)),setTimeout(function(){n.remove()},1e4)}},paramFragments:{init:[],user:[],page:[],rotation:[]},initParams:function(){var t=this.paramFragments.init;if(t.length)return t;var r=gsConfig&&gsConfig.isPreview,i,s={en:"1",bg:"2",ca:"3",cs:"4",da:"5",de:"6",es:"7",eu:"8",fi:"9",fr:"10",it:"11",ja:"12",lt:"13",nb:"14",nl:"15",pl:"16",pt:"17",ro:"18",ru:"19",sk:"20",sl:"21",sv:"22",tr:"23",zh:"24"};this.useTestAds&&(t.push("testAds="+this.useTestAdsValue),t.push("testAds=1"));try{i="0=",i+=s[n.Services.Local.get("gs.locale")]}catch(o){i="0=1"}return t.push(i),t.push("16="+(r?"1":"0")),t.push("21="+n.Models.Ad.RANDOM_PERCENT),t.push("24="+gsConfig.country.ID),t.push("host="+e.location.host),this.paramFragments.init=t},userParams:function(e){var t=this.paramFragments.user;if(!e)return t;t=[];var r=e.get("isLoggedIn"),i=e.get("Sex"),s=e.get("TSDOB"),o=e.get("Flags"),u=e.get("Email"),a=(e.get("settings").local.themeFlags&n.Models.Theme.THEME_FLAG_FAMILY_FRIENDLY)==n.Models.Theme.THEME_FLAG_FAMILY_FRIENDLY,f=e.get("UserID"),l=new Date,c=0,h;t.push("19="+(r?"1":"0")),t.push("5="+(a?"1":"0")),t.push("ff="+(a?"1":"0")),t.push("gsf="+Number(e.get("IsPremium")&&!e.get("subscription").canHideAds())),t.push("inofftest="+Number(gsConfig.runMode==="staging"&&gsConfig.httpHost!=="htmlstaging.grooveshark.com")),i&&(i=i.toLowerCase(),t.push("1="+(i=="m"?"0":"1")),t.push("genderabb="+i),t.push("gender="+(i=="m"?"male":"female")),t.push("gendernum="+(i=="m"?"1":"2")));if(u){var p=u.split(".");p.length&&p[p.length-1]=="edu"&&t.push("20=1")}o&n.Models.User.FLAG_ISARTIST?t.push("17=1"):o&n.Models.User.FLAG_MUSIC_BUSINESS&&t.push("17=2"),!n.Models.Ad.personalizedTags&&n.Services.Local&&n.Services.Local.get("personalizedTags")&&(n.Models.Ad.personalizedTags=n.Services.Local.get("personalizedTags"));if(n.Models.Ad.personalizedTags&&n.Models.Ad.personalizedTags[f]){h=n.Models.Ad.personalizedTags[f];if(!h.length)t.push("genre=-1");else for(;c<h.length;c++)h[c]?(t.push("26="+h[c]),t.push("tagid="+h[c]),c||t.push("genre="+h[c])):t.push("genre=-1")}else t.push("genre=-1");if(s){var d=s.split("-"),v=d.length==3,m="0";if(!v)return this.paramFragments.user=t,t;s=l.getFullYear()-_.toInt(d[0]),_.toInt(d[1])>l.getMonth()?s-=1:_.toInt(d[1])==l.getMonth()&&_.toInt(d[2])>l.getDate()&&(s-=1),s>=13&&s<18?m="1":s>=18&&s<25?m="2":s>=25&&s<35?m="3":s>=35&&s<50?m="4":s>=50&&(m="5"),t.push("a="+(s>=21?"1":"0")),t.push("10="+m),t.push("14="+this.encodeInteger(s)),t.push("age="+s)}return t.push("sid="+this.encodeInteger(e.get("userTrackingID"))),this.paramFragments.user=t},pageParams:function(e){var t=this.paramFragments.page;if(!e||e&&!e.view)return t;t=[];var r=e.view.id,i=e.type,s=!$.browser.msie||$.browser.msie&&$.browser.version>=10;_.indexOf(n.Models.Theme.themePages,i)>=0?(t.push("tl=1"),t.push("tl="+i),this.topLevel=!0):this.topLevel=!1;switch(i){case"popular":case"tags":t.push("9=5"),s&&t.push("multi=1");break;case"tag":t.push("9=4-"+r);break;case"artist":t.push("9=3-"+r),s&&e.section=="albums"&&t.push("multi=1");break;case"user":t.push("9=3-"+r);break;case"search":t.push("9=2");break;case"home":t.push("9=1");break;case"song":t.push("28="+r);break;case"playlist":t.push("27="+r);break;case"album":s&&e.subpage=="related-albums"&&t.push("multi=1")}return this.paramFragments.page=t},themeParams:function(e){var t=this.paramFragments.theme;if(!e)return t;t=[];var n=e.id,r=e.get("extraParams");return t.push("11="+n),t.push("themeID="+n),r&&t.push(r),this.paramFragments.theme=t},rotationParams:function(){var e=[];if(r.model.get("player")&&r.model.get("player").get("queue")){var t=r.model.get("player").get("queue");t.get("currentAutoplayTagID")&&(e.push("12=1"),e.push("13="+t.get("currentAutoplayTagID"))),t.get("activeSong")&&(e.push("2="+t.get("activeSong").get("ArtistID")),e.push("artist_id="+t.get("activeSong").get("ArtistID")))}return e.push("4="+this.adRotationCount),e.push("25="+(n.Models.Theme.lastTakeoverID||"0")),this.paramFragments.rotation=e},getParams:function(t,r,i,s){t=t instanceof Array?t:[],r=_.orEqual(r,"?"),i=_.orEqual(i,"&");var o=new Date,u=0,a=function(e,t){e=2;var n=t+"";while(n.length<e)n="0"+n;return n},f,l,c,h;t.push(o.getTime()+"="+o.getTime()),t.push("kltstamp="+encodeURIComponent([_.map([o.getFullYear(),o.getMonth()+1,o.getDate()],a).join("-"),_.map([o.getHours(),o.getMinutes(),o.getSeconds()],a).join(":")].join(" "))),t.push("viewid="+~~(Math.random()*1e8)),t.push("random="+~~(Math.random()*1e8)),t.push("ranreq="+Math.random()),t.push("gslang="+(n.Services.Local.get("gs.locale")||"en"));if(e.location.hash.length&&e.location.hash.indexOf("gs_adparams=")>=0){f=location.hash.split("gs_adparams=")[1],l=f.length?f.split("&"):[],h=Math.min(l.length,3);for(;u<h;u++)c=l[u].split("="),t.push(c[0]+"="+c[1])}return r+t.concat(this.initParams()).concat(this.userParams()).concat(this.pageParams()).concat(this.themeParams()).concat(this.rotationParams()).join(i)},getParamsAsObjects:function(){var e=this.getParams().replace("?","").split("&"),t=e.length,n=[];while(--t){var r={},i=e[t].split("=");r[i[0]]=i[1]||"",n.push(r)}return n},getParamsAsArrays:function(){var e=this.getParams().replace("?","").split("&"),t=e.length,n=[];while(--t)n.push(e[t].split("="));return n},postAMessage:function(t,n,r){var i=gsConfig.runMode!="production"?e.location.protocol+"//"+e.location.host:"http://ads-grooveshark.com";try{e.postMessage({toString:function(){r=!0}},"*")}catch(s){}if(r||!0)n=JSON.stringify(n);t.postMessage(n,i)},encodeInteger:function(e){var t=e.toString(2).split(""),n=1,r=t.length,i=0;while(n<r)t.splice(n+i,0,0),n+=3,i++;return(parseInt(t.join(""),2)*751).toString(16)},decodeInteger:function(e){var n=(parseInt(e,16)/751).toString(2).split(""),r=1,i=0;while(n[r+i]!==t)n[r+i]=null,r+=3,i++;return parseInt(n.join(""),2)}});n.Models.Capital=n.Models.Capital||{},n.Models.Capital.AudioRoll=Backbone.Model.extend({_emittedCanSkip:!1,initialize:function(){this.on("skip",this.onSkip,this),this.on("clickthrough",this.onClickThrough,this),this.on("error",this.onError,this),this.on("noAdError",this.onNoAdError,this),this.on("firstQuartile",this.onAudioFirstQuartile,this),this.on("midpoint",this.onAudioMidpoint,this),this.on("thirdQuartile",this.onAudioThirdQuartile,this)},destroy:function(e){return this.audioHandle&&(this.audioHandle.pause(),this.audioHandle.destroy(),this.stopListening(this.audioHandle),this.audioHandle=null),Backbone.Model.prototype.destroy.call(this,e)},play:function(e){var t=this.get("audio"),r=e||{},i=this.alreadyPlaying,s=!0,o,u;if(!t||!t.src)return;this.alreadyPlaying||(this.audioHandle||(this.audioHandle=n.Services.AudioHandle.getAudioHandle()),this.setupAudioHandleListeners(),this.audioHandle.setSource(t.src),this.alreadyPlaying=!0),u=this.audioHandle.getMuted(),o=this.audioHandle.getVolume(),o<.07?r.click?n.trigger("player:volumeChange",.07):(this.pause(),s=!1):u&&(r.click?n.trigger("player:volumeMute",!1):(this.pause(),s=!1)),s&&(this.audioHandle.play(),this.audioHandle.seekTo=function(){},this.set("paused",!1)),i||_.defer(_.bind(function(){this.trigger("setup")},this))},pause:function(){this.audioHandle&&(this.audioHandle.pause(),this.set("paused",!0))},setupAudioHandleListeners:function(){var e=this.get("audio"),t,n,r;e.time&&(t=e.time/4,n=e.time/2,r=t+n,this.set("markers",{firstQuartile:t,midpoint:n,thirdQuartile:r})),this.listenTo(this.audioHandle,"update",this.onAudioUpdate),this.listenTo(this.audioHandle,"playing",this.onAudioPlaying),this.listenTo(this.audioHandle,"error",this.onAudioError),this.listenTo(this.audioHandle,"downloaded",this.onAudioDownloaded),this.listenTo(this.audioHandle,"volumechange",this.onAudioVolumeChange),this.listenTo(this.audioHandle,"complete",this.onAudioComplete)},handleSkip:function(){var e=this.get("skip");return e?(this.audioHandle&&this.audioHandle.pause(),this.trigger("skip"),!0):!1},handleClickThrough:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.clickThrough)},requestURLsForTracking:function(e){if(!e||e.length==0)return;var t=$("body"),n=Date.now(),r;_.isString(e)&&(e=[e]),r=function(e){$(e.target).remove()},_.each(e,function(i,s){var o=new Image,u=$(o),a=i;if(!_.isString(a))return;a.indexOf("?")===-1?a+="?"+n:a+="&"+n,u.load(r),u.error(r),u.css("visibility","hidden").attr("src",a),t.append(u)})},onAudioUpdate:function(e,t){var n=this.get("audio"),r=this.get("markers"),i=t.duration||n&&n.time,s=t.position,o=s/1e3,u=(i-s)/1e3;_.each(r,_.bind(function(e,t){this._lastPositionSecs<e&&o>=e&&this.trigger(t)},this)),this._lastPositionSecs=o,!this._emittedCanSkip&&o>5&&(this.trigger("canSkipNow"),this._emittedCanSkip=!0),this.set("timeLeft",_.toInt(u))},onSkip:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.skip)},onClickThrough:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.clickThrough)},onError:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.error)},onNoAdError:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.noAdError)},onAudioFirstQuartile:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.firstQuartile)},onAudioMidpoint:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.midpoint)},onAudioThirdQuartile:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.thirdQuartile)},onAudioPlaying:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.start),this.trigger("playing")},onAudioError:function(){this.trigger("error")},onAudioDownloaded:function(){},onAudioVolumeChange:function(e){e<.07&&this.pause()},onAudioComplete:function(){var e=this.get("eventTracking");this.requestURLsForTracking(e&&e.complete),this.trigger("complete")},getAudioRoll:function(e){if(this.rollFetchingDfd)return this.rollFetchingDfd;return $.Deferred().reject();var t,n,r,s,o,u,a,f},parseVAST:function(e){if(!e)return;var t={},n=parseInt(e["@version"],10),r={start:[]},i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;if(n>=2&&n<3&&e.ad&&e.ad.inline){i=e.ad["@id"],t.id=i,o=e.ad.inline,o&&o.adsystem&&(t.adSystem=_.trim(o.adsystem.keyValue||o.adsystem),t.adSystemVersion=_.trim(o.adsystem["@version"])||null),o&&o.adtitle&&(t.title=_.trim(o.adtitle.keyValue||o.adtitle));if(o&&o.creatives&&o.creatives.creative){u=o.creatives.creative,_.isArray(u)||(u=[u]);for(g=0,y=u.length;g<y;g++){a=u[g];if(a.linear&&a.linear.mediafiles&&a.linear.mediafiles.mediafile){l=a.linear.mediafiles.mediafile,_.isArray(l)||(l=[l]);for(b=0,w=l.length;b<w;b++)c=l[b],c["@type"]==="audio/mpeg"&&(t.audio={src:c.keyValue||c,time:s(a.linear.duration)})}if(a.companionads&&a.companionads.companion&&a.companionads.companion.iframeresource){h=a.companionads&&a.companionads.companion,_.isArray(h)||(h=[h]);for(b=0,w=h.length;b<w;b++)p=h[b],p.iframeresource?(d=p.iframeresource,t.iframe={width:p["@width"],height:p["@height"],src:d.keyValue||d}):p.staticresource?(d=p.staticresource,t.image={width:p["@width"],height:p["@height"],type:d["@type"],src:d.keyValue||d}):p.htmlresource&&(d=p.htmlresource,t.html={width:p["@width"],height:p["@height"],src:d.keyValue||d})}if(a.linear&&a.linear.trackingevents&&a.linear.tracking){v=a.linear.trackingevents.tracking,_.isArray(v)||(v=[v]);for(b=0,w=v.length;b<w;b++){m=v[b]["@event"];if(!m)continue;_.isArray(r[m])||(r[m]=[]),r[m].push(_.trim(v[b].keyValue))}}}}if(o.impression){f=o.impression,_.isArray(f)||(f=[f]);for(g=0,y=f.length;g<y;g++)r.start.push(_.trim(f[g].keyValue||f[g]))}o.advertiser&&(t.advertiser=_.trim(o.advertiser.keyValue||o.advertiser)),o.error&&(r.error=[_.trim(o.error.keyValue||o.error)])}else e.ad&&e.ad.wrapper&&e.ad.wrapper.vastadtaguri?t.redirectURI=_.trim(e.ad.wrapper.vastadtaguri):e.error&&(r.noAdError=[_.trim(e.error.keyValue||e.error)]);t.skip=!1,t.eventTracking=r,this.set(t)},parseCustomData:function(e){var t,r,i,s,o,u;if(e.TOD){e.skp=!0,t=e.TOD;if(t.hasOwnProperty("Error")){t.UnfilledAvails&&t.UnfilledAvails.length&&n.Models.Ad.loadTracking([t.UnfilledAvails[0].Log.uri]),this.trigger("error");return}r=t.AdBreaks.AdBreak;if(!r||!r.length||!r[0].Ad.length||!r[0].Ad[0]){this.data=e;return}i=r[0].Ad[0],i.MediaFile&&i.MediaFile.uri&&(e.audio={src:i.MediaFile.uri,time:parseFloat(i.duration)}),s=i.CompanionVisual,s&&s.MediaFile&&s.MediaFile.length&&s.MediaFile[0].uri&&(e.image={src:s.MediaFile[0].uri,url:i.ClickThrough&&i.ClickThrough.clickThroughLink}),e.eventTracking=e.eventTracking||{};if(i.Impression&&i.Impression.Log&&i.Impression.Log.length){u=i.Impression.Log,o=u.length;while(o--)e.eventTracking[u[o].event]||(e.eventTracking[u[o].event]=[]),e.eventTracking[u[o].event].push(u[o].uri)}e.eventTracking.complete&&(e.eventTracking.skip=_.clone(e.eventTracking.complete)),i.ClickThrough&&(e.eventTracking=e.eventTracking||{},e.eventTracking.clickThrough||(e.eventTracking.clickThrough=[]),e.eventTracking.clickThrough.push(i.ClickThrough.Log.uri)),e.skip=!0}else e.eventTracking={start:e.tracking},e.skip=_.isUndefined(e.skp)?!!e.skip:!!e.skp;this.set(e)},getParams:function(e,t){return n.Models.Ad.getParams(["browser="+_.browserDetect().browser],e,t,this)}},{})}(),function(){n.Models=n.Models||{};var e=n.Models.Promotion=Backbone.Model.extend({idAttribute:"id",loadStyles:function(){var e=[gsConfig.assetHost,"themes/promotions",this.get("location"),"index.css"].join("/"),t="?ver="+_.orEqual(this.get("version"),1);document.getElementById("promo-styles").href=e+t},getViewPath:function(){return["themes/promotions",this.get("location"),"index.js"].join("/")+"?ver="+_.orEqual(this.get("version"),1)},getTemplatePath:function(){return"themes/promotions/"+this.get("location")+"/index"}},{getPromoDefinitions:function(){function i(){e.reject()}if(this.promoDfd)return this.promoDfd.promise();var e=this.promoDfd=$.Deferred(),t=document.getElementsByTagName("script")[0],n=t.parentNode,r=document.createElement("script");return r.type="text/javascript",r.async=!0,r.src=gsConfig.assetHost+"/themes/promotions/promotions.js?_="+Date.now(),r.id="promoJS",r.onerror=i,r.onreadystatechange=function(){if(this.readyState!=="complete"&&this.readyState!=="loaded")return;this.status==404&&i()},n.appendChild(r),e.promise()}})}(),function(){function i(e,t){var n=e.attributes.upVotes,r=t.attributes.upVotes;return(r?r.length:0)-(n?n.length:0)}function s(e){var t=e||"";return t.indexOf(A.CHAT_SERVER_PREFIX_PUBLIC)===0?t=t.substr(A.CHAT_SERVER_PREFIX_PUBLIC.length):t.indexOf(A.CHAT_SERVER_PREFIX)===0&&(t=t.substr(A.CHAT_SERVER_PREFIX.length)),t}function o(e){return _.first((e||"").split(":"))}function u(e,t,n){var r=[],i=0,s=e.length,o,u=0,a=0;for(;i<s;i++)o=e[i],o.broadcastSongID=[n,":",i].join(""),t&&t[i]&&t[i].s==o.SongID?(o.upVotes=_.toInt(t[i].u)||0,o.downVotes=_.toInt(t[i].d)||0,o.listens=_.toInt(t[i].l)||0,u+=o.upVotes,a+=o.downVotes):(o.upVotes=0,o.downVotes=0,o.listens=0),r.push(o);return{totalUpVotes:u,totalDownVotes:a,songs:r}}function a(e,r,i){var s=[],o=0,u=e.length,a,f=0,l=0;for(;o<u;o++){a=e[o],a.broadcastSongID=[r,":",a.queueSongID].join("");if(i[a.broadcastSongID]){a.broadcastListens&&(a.listens=_.toInt(a.broadcastListens),i[a.broadcastSongID].set({listens:a.listens})),s.push(i[a.broadcastSongID]);continue}a.broadcastUpVotes!==t&&(a.upVotes=_.toInt(a.broadcastUpVotes),f+=a.upVotes,delete a.broadcastUpVotes),a.broadcastDownVotes!==t&&(a.downVotes=_.toInt(a.broadcastDownVotes),l+=a.downVotes,delete a.broadcastDownVotes),a.broadcastListens!==t&&(a.listens=_.toInt(a.broadcastListens),delete a.broadcastListens),a=new n.Models.BroadcastSong(a,{dontCache:!0}),i[a.id]=a,s.push(a)}return{totalUpVotes:f,totalDownVotes:l,songs:s}}function f(e,t,r){var i=n.Models.Player.playStatuses;switch(t){case i.NONE:case i.FAILED:case i.COMPLETED:!this.get("nextSong")&&!this.idleTimeout&&(this.idleTimeout=setTimeout(_.bind(function(){var e=this.get("activeSongStatus");switch(e){case i.NONE:case i.FAILED:case i.COMPLETED:this.set("idle",!this.get("nextSong"));break;default:this.set("idle",!1)}this.idleTimeout=!1},this),15e3));break;default:this.set({idle:!1}),this.idleTimeout&&(clearTimeout(this.idleTimout),this.idleTimeout=!1)}}function l(e){var t=e.get("listeners"),n=e.get("vipUsers"),r;if(!t||!n)return;n.each(function(e){if(!e.get("noMetadata"))return;r=t.get(e.get("UserID"));if(!r)return;e.updateFromUserModel(r)})}function c(e,t){var r=e.bannedUsers||new n.Models.Collections.TinyUsers;t&&r.reset(t);if(e){var i=e.chatActivities,s=n.getLoggedInUserID(),o;i&&i.each(function(e){if(e.get("type")!="message")return;o=e.get("user");if(!o||o.id===s)return;r.get(o.get("UserID"))?e.set("specialFlag","banned"):e.get("specialFlag")==="banned"&&e.unset("specialFlag")})}return r}function h(e,t){if(!t||!t.length)return;var r=t.length,i=s(e),o=(e||"").indexOf(A.CHAT_SERVER_PREFIX_PUBLIC)>=0,u=[],a=[],f,l,c;while(r--)u.push(t[r].key),a.push(t[r].value),t[r].key==="idSuffix"&&typeof t[r].value=="string"&&(c=t[r].value);c&&(i+=":"+c),l=n.Models.Broadcast.getLatestIncrementedCached(i);if(!l)return;f=_.zipObject(u,a),l.updateFromManatee(f,o,!1,!0)}function p(e,t,i){var o=s(e),u=n.Models.Broadcast.getLatestIncrementedCached(o),a=i?_.toInt(i.userid):0,f,l,c;if(!u)return;switch(t.type){case"sub_alert":if(i.sudo)return;if(a>0){i.app_data&&i.app_data.z?l=i.app_data:t.sub_alert.extra&&(l=t.sub_alert.extra);if(l){if(l.r)return;l.u=a}}u.newListener(l);break;case"unsub_alert":if(i.sudo)return;if(a>0){i.app_data&&i.app_data.z?l=i.app_data:t.unsub_alert.extra&&(l=t.unsub_alert.extra);if(l){if(l.r)return;l.u=a}}u.listenerLeft(l);break;case"broadcastOwnerEnded":f=u.get("host");if(!u.isLoggedInUserOwner()||f&&f.get("isBroadcasting"))u.set("ownerSubscribed",!1),r.model.get("user").leaveBroadcast(!0);amdModules.requireDeferred("gs/views/lightboxes/broadcastEnded.js").done(function(){n.trigger("lightbox:open","broadcastEnded",{broadcast:u})});break;case"allTimeListens":c=this.getOwner(),t.allTimeListens&&c&&c.setBroadcastListens(t.allTimeListens);break;case"songFailuresOverLimit":n.trigger("notification:add",{title:_.getString("POPUP_ERROR_BROADCAST_NEXT_SONG_FAIL_PERMANENTLY"),icon:"broadcast",duration:18e4});break;case"vipRequestResponse":t&&t.data&&u.handleVIPRequestResponse(t.data);break;default:console.log("unhandled sub data",e,t,i)}}function d(e){var t=e;Math.abs(e-A.clientTimeDivergence)<9e4&&(t=Math.floor(t/2),A.clientTimeDivergence+=t,console.log("Suspected time inconsistency! Correcting time by",t,"ms"))}function v(e,t,r){var i=s(e),o=n.Models.Broadcast.getLatestIncrementedCached(i),u=r?_.toInt(r.userid):0,a,f,l,c;if(!o){console.log("missing broadcast",t,r,i,e);return}switch(t.type){case"chat":if(u<=0||!t.data){console.log("user not found from chat message or missing data",r,t);return}f=o.get("listeners"),c=o.get("vipUsers"),c&&(l=c.get(u)),!l&&r&&r.app_data&&r.app_data.z?(r.app_data.u=u,l=new n.Models.TinyUser(r.app_data)):l||(l=f&&f.get(u)||n.Models.User.getCached(u)),l&&(t.user=l,o.newChatActivity(new n.Models.ChatActivity(t))),n.trigger("broadcast:notifEvent",o);break;case"suggestion":if(!t.data){console.log("missing data",r,t);return}break;case"suggestionRemove":if(!t.data||!t.data.songID){console.log("missing data",r,t);return}o.handleSuggestionVote(t.data.songID,0,u);break;case"activeSongVote":if(!t.data||!t.data.queueSongID){console.log("no queueSongID for activeSongVote",t);return}o.handleActiveSongVote(t.data.queueSongID,t.data.vote,u);break;case"songAddedToHistory":a=n.Models.Song.convertManateeSongCalloutProperties(t.newSong),console.log("new song in history!",a,t.totalListens),o.handleAddedToHistory(a);break;case"suggestionAction":if(!t.action){console.log("no action",t);return}var h=t.action;h.approvedSong&&h.approvedSong.b&&(h.approvedSong=n.Models.Song.convertManateeSongCalloutProperties(h.approvedSong)),h.removedSong&&h.removedSong.b&&(h.removedSong=n.Models.Song.convertManateeSongCalloutProperties(h.removedSong)),h.blockedSong&&h.blockedSong.b&&(h.blockedSong=n.Models.Song.convertManateeSongCalloutProperties(h.blockedSong)),o.handleSuggestionsAction(h),console.log("suggestion action!",t);break;default:console.warn("unhandled event...",t,r,o)}}function m(e,t,r,i,s){var o=_.zipObject(t,r),u;return!e||(!o.owners||!o.owners.length)&&!s?(i&&i.reject(o),{}):(u=A.getCached(e),u?u.updateFromManatee(o,s,!1,!1):(o=A.convertManateeRealProperties(o),u=new A({BroadcastID:e,ownerUser:n.Models.User.getCached(o.UserID),activeStatus:1}),u.updateFromManatee(o,!1,!0,!1)),i&&i.resolve(u),u)}function g(e,r,s,o,u,f){var l=(r?r.cachedBroadcastSongs:e.cachedBroadcastSongs)||{},h=r&&r.listenersLoaded,p=r&&r.listeners,d,v,m;u||(o?e=A.convertManateeChatProperties(e):e=A.convertManateeRealProperties(e));if(e.history&&!(e.history instanceof n.Models.Collections.BroadcastSongs))if(e.history.songs){var g=r&&r.history,y;if(g&&g.length&&e.history.songs.length>1&&g.at(0).get("queueSongID")===e.history.songs[1].queueSongID)y=a([e.history.songs[0]],s,r.cachedBroadcastSongs),d=y.songs[0],d&&g.add(d,{at:0}),delete e.history;else{y=a(e.history.songs,s,l);var b=y.songs;r&&r.history?(r.history.reset(b),delete e.history):e.history=new n.Models.Collections.BroadcastSongs(b,{broadcastID:s,modelOptions:{dontCache:!0}}),e.historyLoaded=!0}}else delete e.history;if(e.newHistorySong){if(r&&r.history){e.newHistorySong.b&&(e.newHistorySong=n.Models.Song.convertManateeSongCalloutProperties(e.newHistorySong));var w=a([e.newHistorySong],s,r.cachedBroadcastSongs);d=w.songs[0],d&&r.history.add(d,{at:0})}delete e.newHistorySong}if(e.suggestions){var E=[],S=n.getLoggedInUserID(),x=0,T=r&&r.cachedBroadcastSuggestions||e.cachedBroadcastSuggestions,N,C;T||(T={}),e.cachedBroadcastSuggestions=T,_.each(e.suggestions,function(e){e.song&&e.users&&e.users.length&&(_.indexOf(e.users,S)>-1?x=1:x=0,T[e.song.SongID]?N=T[e.song.SongID]:(C=null,e.song.ownerData&&!e.song.ownerData.r&&(C=p&&p.get(e.song.ownerData.u)),N=new n.Models.BroadcastSuggestion(_.extend(e.song,{upVotes:e.users}),{dontCache:!0,suggester:C}),T[e.song.SongID]=N),N.set({userVote:x,upVotes:e.users}),E.push(N))});var k=_.toInt(e.suggestions.lastChangeID);v=r&&r.suggestions,v instanceof n.Models.Collections.BroadcastSuggestions?(v.reset(E),v.lastChangeID=k,e.suggestions=v):(e.suggestions=new n.Models.Collections.BroadcastSuggestions(null,{modelOptions:{dontCache:!0}}),e.suggestions.comparator=i,e.suggestions.add(E),e.suggestions.lastChangeID=k)}return e.playbackStatus&&(e.status=e.playbackStatus,delete e.playbackStatus),e.activeSong&&e.activeSong.id&&!l[e.activeSong.id]&&(l[e.activeSong.id]=e.activeSong),e.owners&&(e.owners.artists&&e.owners.artists.length&&(e.ArtistID=e.owners.artists[0]),e.owners.users&&(e.UserID&&_.indexOf(e.owners.users,e.UserID)===-1&&e.owners.users.push(e.UserID),e.owners.users.length&&(e.ownerUserIDs=e.owners.users)),delete e.owners),e.ownerArtistIDs&&(e.ownerArtistIDs.length&&(e.ArtistID=e.ownerArtistIDs[0]),delete e.ownerArtistIDs),e.ownerArtistID&&(e.ArtistID=e.ownerArtistID,delete e.ownerArtistID),e.ownerUserIDs&&!e.UserID&&(e.UserID||(e.UserID=e.ownerUserIDs[0])),e.publishers&&(e.publishers.users&&(e.publishersUsersIDs=e.publishers.users),delete e.publishers),e.Description&&(e.Description=$.trim((e.Description+"").replace(/[\r\n]/g," ").replace(/\s{2,}/," ")),r&&r.Description==e.Description&&delete e.Description),e.activeStatus===1&&(!r||!r.chatActivities)&&(e.chatActivities=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100})),e.pendingNewOwnerUserDetails?(e.pendingNewOwnerUserDetails.u?e.pendingNewOwner=n.Models.User.newOrUpdate({UserID:_.toInt(e.pendingNewOwnerUserDetails.i),FName:e.pendingNewOwnerUserDetails.n,Picture:e.pendingNewOwnerUserDetails.p,IsPremium:e.pendingNewOwnerUserDetails.y}):e.pendingNewOwner=n.Models.Artist.newOrUpdate({ArtistID:_.toInt(e.pendingNewOwnerUserDetails.i),ArtistName:e.pendingNewOwnerUserDetails.n,CoverArtFilename:e.pendingNewOwnerUserDetails.p}),delete e.pendingNewOwnerUserDetails):e.hasOwnProperty("pendingNewOwnerUserDetails")&&(e.pendingNewOwner=null,delete e.pendingNewOwnerUserDetails),e.bannedUsers&&(e.bannedUsers=c(r,e.bannedUsers)),e.vipUsers&&(m=r&&r.vipUsers||new n.Models.Collections.TinyUsers,h&&p&&_.each(e.vipUsers,function(e){if(e instanceof n.Models.TinyUser){if(!e.get("noMetadata"))return;e.updateFromUserModel(p.get(e.UserID))}else{if(e.noMetadata!==!0)return;e.UserID&&_.extend(e,n.Models.TinyUser.getKeysFromUserModel(p.get(e.UserID)))}}),m.reset(e.vipUsers,{skipVIPUsersNotifs:!f||!r.vipUsers}),e.vipUsers=m),e.lastUpdated=Date.now(),e.activeStatus===t&&r&&r.activeStatus<0&&(e.activeStatus=1),e}function y(){T||(n.on("manatee:broadcastsInfo",w),n.on("manatee:broadcastInfo",b),T=!0)}function b(e,t){!e&&n.Models.Broadcast.broadcastsDeferreds[t]&&n.Models.Broadcast.broadcastsDeferreds[t].reject()}function w(e){var t=[],i={},s=e.length,o=[],u=r.model.get("manatee"),a,f,l,c,h,p,d;for(c=0;c<s;c++){if(!e[c])continue;l=e[c].get("BroadcastID"),f=n.Models.Broadcast.broadcastIDToTags[l];if(f){o=o.concat(f);for(h=0,p=f.length;h<p;h++)n.Models.Broadcast.broadcastsByTagsDeferreds[f[h]]&&n.Models.Broadcast.broadcastsByTagsDeferreds[f[h]].__broadcasts.push(e[c])}a=e[c].get("ownerUserIDs")[0];if(e[c].get("ownerArtistID")||!a||a<1||i[a])continue;if(n.Models.User.getCached(a)){i[a]=1;continue}t.push(a)}o=_.unique(o),t.length?(t=_.unique(t),d=u.getUsersKeys(t,["i"]).done(function(e){if(e&&e.users){var t=[],r;_.each(e.users,function(e,i){if(!e)return;if(e.r){r=n.Models.User.getCached(i),r&&r.set("restricted",!0);return}r=n.Models.User.newOrUpdate({UserID:i,FName:e.n,Picture:e.p},{dontCache:!0}),t.push(r)}),E(t,{completedTags:o})}})):E(null,{completedTags:o})}function E(e,t){if(!t||!t.completedTags)return;var r=t.completedTags,i,s,o;for(s=0,o=r.length;s<o;s++)i=n.Models.Broadcast.broadcastsByTagsDeferreds[r[s]],i&&(i.resolve(i.__broadcasts),delete n.Models.Broadcast.broadcastsByTagsDeferreds[r[s]])}n.Models=n.Models||{};var S={msPlayed:5e3,msLeft:3e4,numListeners:10,downDelta:5,downPercent:.9,activePercent:.25,countdown:20},x=_.throttle(function(){var e=this.get("activeSong");if(!e||e.get("noSkip"))return;var t=r.model.get("player");if(!t.get("duration")||t.get("position")<S.msPlayed||t.get("duration")-t.get("position")<S.msLeft)return;var n=this.get("listeners");if(!n||n.length<S.numListeners)return;var i=e.get("upVotes")||[],s=e.get("downVotes")||[];if(s.length-i.length<S.downDelta)return;if(s.length/(s.length+i.length)<S.downPercent)return},1e3),T=!1,N={},C={},k=1,L=0,A=n.Models.Broadcast=Backbone.CachedModel.extend({idAttribute:"BroadcastID",consecutivePacemakersOutOfOrder:0,consecutiveNegativeBeginningPositions:0,skippedLastHeartbeat:!1,reSyncWithBroadcasterAtNextSong:!1,lastReceivedHeartbeat:null,parse:function(t,r){if(r&&r.skipParse)return t;var i=r||{},s=i.clone===!1?t:_.clone(t);A.clientTimeDivergence||(A.clientTimeDivergence=e.clientTimeDivergence),s.BroadcastID=_.orEqual(s.BroadcastID,s.broadcastID),s.UserID?s.ownerUserIDs=[s.UserID]:s.ownerUserIDs&&s.ownerUserIDs.length>0&&(s.UserID=_.toInt(s.ownerUserIDs[0]));if(s.Songs){var o=u(s.Songs,s.PlayData,s.BroadcastID);s.history=new n.Models.Collections.BroadcastSongs(o.songs,{broadcastID:s.BroadcastID,modelOptions:{dontCache:!0}}),s.historyLoaded=!0,s.totalUpVotes=o.totalUpVotes,s.totalDownVotes=o.totalDownVotes}s.owner&&s.ownerUser==null&&(s.ownerUser=s.owner,delete s.owner),!s.ownerUser&&i.ownerUser&&i.ownerUser instanceof n.Models.User&&s.UserID==i.ownerUser.get("UserID")&&(s.ownerUser=i.ownerUser),s.ownerUser&&(s.ownerUser instanceof n.Models.User?s.ownerModel=s.ownerUser:s.ownerModel=n.Models.User.newOrUpdate(s.ownerUser,{dontCache:!0,skipUpdate:!0}),s.ownerModel.id!==s.UserID&&delete s.ownerModel),s.cachedBroadcastSongs={},s.cachedBroadcastSuggestions={},s.approvedSuggestions=new n.Models.Collections.BroadcastSongs([]),s.CoverPhoto=_.orEqual(t.CoverPhoto,""),s.CoverPhotoY=t.CoverPhotoY,s.StockCoverPhoto=t.StockCoverPhoto;if(typeof t.listenersCount!="undefined"||typeof t.ListenersCount!="undefined")s.listenersCount=t.listenersCount||t.ListenersCount;return s.isListener=t.isListener||!1,!s.activeStatus&&N[s.BroadcastID]&&(s.activeStatus=0,delete N[s.BroadcastID]),s.ActiveSong&&(s.activeSong||(s.activeSong=n.Models.Song.newOrUpdate(s.ActiveSong,{dontCache:!0,skipUpdate:!0})),delete s.ActiveSong),g(s,null,s.BroadcastID,!1,!0,!1),delete s.broadcastID,delete s.Songs,delete s.PlayVotes,delete s.owner,delete s.ownerArtist,delete s.ownerUser,delete s.suggestionsChanges,i.isFavorite&&(s.isFavorite=!0),i.activeStatus===0&&!s.activeStatus&&(s.activeStatus=0),s},initialize:function(e,t){this.set(_.omitSameKeys(e,{activeSong:null,nextSong:null,listenersLoaded:!1,activeStatus:-1,isFavorite:!1,sumVotes:0,publicChannelSubscription:null}),{silent:!0});var r=this.get("host"),i=this.id.indexOf(":");this.chatLocks=[],this.updateSearchText(),this.isLoggedInUserOwner()&&this.get("chatEnabled")===!1&&this.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.CHAT_DISABLED_OWNER})),n.Models.Broadcast.restoreListenersFromCache(this),this.on("change:Name change:Tag change:UserID",this.updateSearchText,this),this.on("change:Name change:Tag change:Description",this.onMainAttrChange,this),this.on("change:controlChannel",this.onControlChannelChange,this),this.on("change:activeSong",this.handleActiveSongChange,this),this.subControlChannelIfNeeded(),this.isLoggedInUserOwner()&&this.on("change:activeSong",this.suggestInvitingBroadcasterFriends,this),this.on("change:vipUsers",function(e,t,n){var r=e.previous("vipUsers"),i={previousModels:r&&r.models||[]};r&&r.off(null,null,this),t&&(t.on("reset",this.onVIPUsersChanged,this),this.onVIPUsersChanged(t,_.defaults(i,n)))},this),this.on("change:activeSongStatus",f,this),this.on("change:listenersLoaded",l,this),Backbone.CachedModel.prototype.initialize.call(this,e,t),n.Models.Broadcast.broadcastsDeferreds[this.id]&&this.get("activeStatus")!==-1&&n.Models.Broadcast.broadcastsDeferreds[this.id].resolve(this,this.id);if(i>-1){var s=this.id.substr(0,i);if(!C[s]||this.id>C[s])C[s]=this.id}this.on("attached",this.onAttached,this),this.on("detached",this.onDetached,this),r&&r.set("parasite",this)},updateFromNew:function(e,t){var r={};t&&t.source==="db"?r=_.removeUndefinedValues(e):this.attributes.listenersLoaded||(t&&t.source==="memcache"&&!this.attributes.listenersLoaded?r=_.removeUndefinedValues(e):typeof e.listenersCount!=null&&(r=_.omitSameKeys(this.attributes,e),r.listenersCount=_.toInt(e.listenersCount)));if(e.isFavorite||t&&t.isFavorite)r.isFavorite=!0;e.controlChannel&&(r.controlChannel=e.controlChannel),e.ownerModel instanceof n.Models.User&&!this.attributes.ownerModel&&(r.ownerModel=e.ownerModel),this.set(r,t)},updateListenersCount:function(e){var t={};e=_.toInt(e),e>-1&&!this.attributes.listenersLoaded&&(t.listenersCount=e),this._getUpdatedListenersCountDfd&&(e>-1?this._getUpdatedListenersCountDfd.resolve(e):this._getUpdatedListenersCountDfd.reject(e)),this.set(t)},updateFromManatee:function(e,t,r,i){if(!e)return;var s,o;e=g(e,this.attributes,this.get("BroadcastID"),t,r,i),e.suggestions&&this.set("suggestions",e.suggestions),e.suggestionsChanges&&(this.handleSuggestionsChanges(e.suggestionsChanges,{initialChanges:!i}),delete e.suggestionsChanges),this.isLoggedInUserOwner()&&_.defined(e.isSuspended)&&!e.isSuspended&&this.get("isSuspended")&&this.refreshQueueAfterUpdateFail(),delete e.broadcastID,delete e.BroadcastID,this.set(e,{skipVIPUsersNotifs:!i||!this.attributes.vipUsers}),e.status&&(this.get("host")&&this.heartbeatHandler(),this.updateBroadcastFromHeartbeat(),s=this.getOwner(),s&&(o=String(e.status.ownerAvailable||"online"),s.set("broadcastOwnerAvailability",o))),e.vipUsers&&this.subControlChannelIfNeeded(),this.isLoggedInUserOwner()&&(e.chatEnabled===!0?this.removePersistentChatActivity("info",n.Models.ChatActivity.CHAT_DISABLED_OWNER):e.chatEnabled===!1&&this.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.CHAT_DISABLED_OWNER}))),n.Models.Broadcast.broadcastsDeferreds[this.id]&&n.Models.Broadcast.broadcastsDeferreds[this.id].resolve(this,this.id),this.cleanupSuggestionsCache()},updateLatestMessages:function(e){var t=this.get("chatActivities"),n=this.get("unreadChatAcivities"),r=this.get("ownerUserIDs"),i,s,o;if(t&&t.length>0||n&&n.length>0||!e)return;for(i=0,s=e.length;i<s;i++){o=e[i];if(!o.hasOwnProperty("id")||!o.hasOwnProperty("value"))continue;switch(o.value.type){case"chat":o.value.isInitialMessage=!0,v(this.id,o.value,o.id);break;case"songAddedToHistory":break;default:console.warn("unhandled message",o)}}this.set("initialChatMessagesLoaded",!0),this.addWelcomeMessage()},updateSearchText:function(){var e=this.get("Name"),t=this.get("Tag"),r=t&&t.n||_.getString("DEFAULT_TAG"),i=this.getOwner(),s=i&&i.get(i instanceof n.Models.Artist?"ArtistName":"Name");this.set("searchText",[e,r,s].join(" ").toLowerCase())},onAttached:function(e,t){var i=t||{},s=e.get("activeSong"),o=this.get("seedArtists"),u=this.get("recentArtists"),a=e.get("isBroadcasting"),f=r.model.get("player"),l=r.model.get("manatee"),c;a&&(c=setInterval(_.bind(this.pingRemora,this),45e3),this.pingRemora()),this.set({host:e,pingInterval:c,tsAttached:Date.now(),lastCrossfade:f.get("crossfadeEnabled"),isListener:!0}),f.setCrossfadeEnabled(!1),e.set({autoplay:!1,shuffle:!1,repeatMode:n.Models.Player.repeatModes.NONE,alwaysStayCompliant:this.get("alwaysStayCompliant")||!1}),e.addSongs=_.bind(this.overrideAddSongs,this),e.removeSongs=_.bind(this.overrideRemoveSongs,this),e.moveSongs=_.bind(this.overrideMoveSongs,this),e.seekActiveSongTo=_.bind(this.overrideSeek,this),e.playSong=_.bind(this.overridePlay,this),e.pause=_.bind(this.overridePause,this),e.resume=_.bind(this.overrideResume,this),e.nextSong=_.bind(this.overrideNext,this),e.previousSong=_.bind(this.overridePrevious,this),e.clear=_.bind(this.overrideClear,this),e.resetSongs=_.bind(this.overrideReset,this),e.off("playNextSong",null,e),e.on("playNextSong",this.playNextQueueSong,this),e.on("change:activeSong",this.showQueueEndingLightbox,this),this.listenTo(e,"outOfSync",this.onQueueOutOfSync),this.listenTo(l,"disconnected",this.onManateeDisconnected),this.listenTo(l,"connected",this.onManateeConnected),l.isConnected()||this.onManateeDisconnected(),this.subscribeToChat("attached"),this.lastReceivedHeartbeat=null,a?i.source==="resume"&&this.heartbeatHandler():(e.clear({fromParasite:!0}),this.heartbeatHandler()),this.addWelcomeMessage()},onDetached:function(e){var t=e.get("songs"),i=t.last(),s=r.model.get("player"),o=r.model.get("manatee"),u=this.get("pingInterval"),a=this.get("lastCrossfade");a&&s.setCrossfadeEnabled(!0),this.unsubscribeFromChat("attached"),this.stopListening(e),e.set({autoplay:!1,isSyncing:!1,pendingRemoraUpdates:[],changeIncr:0}),e.off("playNextSong",null,this),e.off("change:activeSong",null,this),this.set({host:null,lastCrossfade:null,isListener:!1}),e.addSongs=e.constructor.prototype.addSongs,e.removeSongs=e.constructor.prototype.removeSongs,e.moveSongs=e.constructor.prototype.moveSongs,e.seekActiveSongTo=e.constructor.prototype.seekActiveSongTo,e.playSong=e.constructor.prototype.playSong,e.pause=e.constructor.prototype.pause,e.resume=e.constructor.prototype.resume,e.nextSong=e.constructor.prototype.nextSong,e.previousSong=e.constructor.prototype.previousSong,e.clear=e.constructor.prototype.clear,e.resetSongs=e.constructor.prototype.resetSongs,e.on("playNextSong",e.nextSong,e),this.stopListening(o),u&&(clearInterval(u),this.unset("pingInterval",{silent:!0})),n.off("userActivity",null,this),i&&i.get("suggestion")&&!i.playAttempts&&n.trigger("player:removeSpecific",i.get("queueSongID"),e.get("queueID"))},onManateeDisconnected:function(){if(!this.get("host"))return;this.set("isOutOfSync",!0)},onManateeConnected:function(){if(!this.get("host"))return;this.refreshQueueAfterUpdateFail()},overrideAddSongs:function(e,t){var i=t||{},s=this.get("host"),o=r.model.get("manatee"),u=s.get("activeSong"),a=s.get("nextSong"),f=u&&n.Models.Player.isPlayStatusPlaying(u.get("playStatus"),!0),l=u&&s.songs.indexOf(u),c=i&&i.index,h=n.Models.Player.playSpecialIndexes,p,d,v,m;if(!i.fromParasite&&!s.get("isBroadcasting"))return;f||(i.playOnAdd=!0);if(i&&i.at)p=i.at;else if(c>=0)p=c;else if(_.defined(c)){!f&&c===h.DEFAULT&&(c=h.LAST);switch(c){case h.DEFAULT:case h.NEXT:case h.SHUFFLE:p=_.defined(l)?l+1:s.songs.length,c===h.SHUFFLE&&(e=_.randomizeArray(e));break;case h.LAST:p=s.songs.length}}if(!i.fromParasite){if(i.playOnAdd&&f&&!i.skipPreviewPrompt){m=_.isArray(e)?e[0]:e.at?e.at(0):null,n.trigger("lightbox:open","previewSong",{index:index,songs:(new n.Models.Collections.Songs(e,{dontCache:!0})).models,playContext:m?m.get("context"):new n.Models.PlayContext,showPlayerControls:!0,_showPlayerControls:!0}),n.trigger("guts:log","broadcastPreviewSong",{songIDs:e.pluck("SongID")});return}u&&a&&p===l+1&&this.get("listenersCount")>n.Models.Broadcast.LARGE_THRESHOLD&&(d=u.get("position"),v=u.get("duration"),v&&d&&v-d<=n.Models.Broadcast.PREVENT_NEXT_POSITION&&(p++,n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCASTER_CHANGE_NEXT"),type:"error"}))),this.remoraAddSongs(e,p,i);return}i.index=p,s.constructor.prototype.addSongs.call(s,e,i)},overrideRemoveSongs:function(e,t){var n=t||{},r=this.get("host");if(!r||!n.fromParasite&&!r.get("isBroadcasting"))return;if(!n.fromParasite){typeof this._debouncedRemoveSongs!="function"&&function(e){var t=[],n,r=_.debounce(function(){e._debouncedRemoveSongs=null,e.remoraRemoveSongs(_.uniq(t),n)},600);e._debouncedRemoveSongs=function(e,i){t.push.apply(t,e),n=i,r()}}(this),this._debouncedRemoveSongs(e,n);return}r.constructor.prototype.removeSongs.call(r,e,n)},overrideMoveSongs:function(e,t,n){var r=n||{},i=this.get("host");if(!i||!e||!e.length||!r.fromParasite&&!i.get("isBroadcasting"))return;i.constructor.prototype.moveSongs.call(i,e,t,r),!r.fromParasite&&!r.dragging&&this._remoraMoveSongs(e,t,r)},overrideSeek:function(e,t){var n=t||{},r=this.get("host");if(!n.fromParasite&&!r.get("isBroadcasting"))return;r.constructor.prototype.seekActiveSongTo.call(r,e),n.fromParasite||this.remoraSeek(e)},overridePlay:function(e,t){var r=t||{},i=this.get("host"),s=i.get("activeSong"),o=i.get("isBroadcasting"),u=n.Models.Player.isPlayStatusPlaying(s&&s.get("playStatus")),a;if(!r.fromParasite&&!o)return;e.get?a=i.songs.get(e.get("queueSongID")):a=i.songs.get(e),a||(a=n.Models.Queue.buildSong(e));if(!r.fromParasite&&o&&a&&u&&a!==s&&!r.skipPreviewPrompt){n.trigger("lightbox:open","previewSong",{songs:[a._wrapped],playContext:a.get("context"),showPlayerControls:!0,_showPlayerControls:!0}),n.trigger("guts:log","broadcastPreviewSong",{songIDs:[a.get("SongID")]});return}i.constructor.prototype.playSong.call(i,a,r),s=i.get("activeSong");if(!r.fromParasite){if(!s){console.log("no active song in queue despite caling playSong",a);return}this.remoraPlaySong(s,s&&s.get("position"),r)}},overridePause:function(e){var t=e||{},n=this.get("host");n.constructor.prototype.pause.call(n)},overrideResume:function(e){var t=e||{},n=this.get("host");n.constructor.prototype.resume.call(n)},overrideNext:function(e){var t=e||{},r=this.get("host"),i=this.get("listenersCount"),s=this.get("allowPauseSkip"),o=r.get("isBroadcasting");if(!t.fromParasite&&!o)return;if(r.get("isBroadcasting")&&i>1&&!s&&!t.forceSkip){n.trigger("lightbox:open","broadcastPauseSkip",{broadcast:this,confirmType:"SKIP",callback:function(){r.nextSong({forceSkip:!0})}});return}r.constructor.prototype.nextSong.call(r,t)},overridePrevious:function(e){var t=e||{},n=this.get("host"),r=n.get("isBroadcasting");if(!t.fromParasite&&!r)return;n.constructor.prototype.previousSong.call(n,t)},overrideClear:function(e){var t=e||{},n=this.get("host"),r=n.get("activeSong"),i=t.fromParasite;if(!i&&!n.get("isBroadcasting"))return;_.extend(t,{internal:!0,fromClear:!0,fromParasite:!0,activeSong:r});if(!i)return this.remoraResetQueue([r],t);n.constructor.prototype.resetSongs.call(n,[],t)},overrideReset:function(e,t){var n=t||{},r=this.get("host");if(!n.fromParasite&&!n.skipSyncing){this.remoraResetQueue(e.models||e,n);return}_.extend(n,{internal:!0,fromParasite:!0}),r.constructor.prototype.resetSongs.call(r,e,n)},remoraShuffleUnplayedSongs:function(e){var t=this.get("host"),r=t&&t.get("songs"),i=t?t.get("isBroadcasting"):null,s=this,o,u;return!t||!r||!i?$.Deferred().reject().promise():(u={action:"shuffleUnplayedSongs"},o=function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_FAILED_SHUFFLE"),type:"error",duration:5e3}),s.refreshQueueAfterUpdateFail(t)},t.setSyncing(!0),this.sendToRemora(u).done(function(e){if(!e||!e.response||!e.success){o();return}n.trigger("notification:add",{title:_.getString("POPUP_QUEUE_RANDOMIZED"),icon:"shuffle",type:"success",duration:5e3}),t.setSyncing(!1)}).fail(o))},handleActiveSongChange:function(e,t){var r=this.get("publicChannelSubscription");r&&t&&this.newChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.SONG_CHANGED,song:t}))},showQueueEndingLightbox:function(){var e=this.get("host"),t=this,r,i,s,o,u,a,f;if(!t.isLoggedInUserOwner()||!e)return;r=e.get("activeSong");if(!r)return;i=e.get("songs"),s=i.indexOf(r);if(s<i.length-2)return;u=Date.now();if(u-t.get("tsAttached")<6e5)return;a=t.get("UserID"),o=n.Services.Local.get("lastQueueEndingIgnored-"+a)||0,u=new Date,f=new Date,f.setTime(o);if(u-o<216e5||f.getMonth()===u.getMonth()&&f.getDate()===u.getDate())return;amdModules.requireDeferred("gs/views/lightboxes/queueEnding.js").done(function(){n.trigger("lightbox:open","queueEnding",{broadcast:t})})},getFullQueue:function(){if(this.getFullQueueDfd&&this.getFullQueueDfd.state()==="pending")return this.getFullQueueDfd.promise();this.getFullQueueDfd=$.Deferred();var e=this.sendToRemora({action:"getQueue",blackbox:{getFullQueue:!0}});return e||this.getFullQueueDfd.reject(),this.getFullQueueDfd.promise()},playNextQueueSong:function(){var e=this.get("host"),t=e&&e.get("isBroadcasting"),r=e&&e.get("activeSong"),i=e&&e.get("nextSong"),s=r&&r.get("playStatus"),o=n.Models.Player,u=o.playStatuses;if(!e)return;s==u.COMPLETED&&this.skippedLastHeartbeat?this.heartbeatHandler():i&&i.get("token")&&(this.reSyncWithBroadcasterAtNextSong?(i.load({useFileToken:!0}),this.nextSong.load("","",0,0,!0)):e.playSong(i,{useFileToken:!0,fromParasite:!0}))},heartbeatHandler:function(){var e=this.get("status"),t=this.get("lastHeartbeatTime"),i=this.get("lastUpdated"),s=this.get("host"),o=s&&s.get("songs"),u=s&&s.get("activeSong"),a=s&&s.get("nextSong"),f=u&&o&&o.at(o.indexOf(u)-1),l=s&&s.get("isBroadcasting"),c=!1,h=null,p=n.Models.Player,v=p.playSpecialIndexes,m=p.playStatuses,g=u&&u.get("position"),y=u&&u.get("duration")-g||0,b=new n.Models.PlayContext(this),w=!1,E={},S;if(!e||!s)return;if(e.pacemaker>0&&this.lastReceivedHeartbeat&&e.pacemaker<this.lastReceivedHeartbeat.pacemaker){if(this.consecutivePacemakersOutOfOrder++>3){var x=r.model.get("user");x&&(x.leaveBroadcast("error"),n.Services.Log.notify("Leaving broadcast because consecutivePacemakersOutOfOrder","ERROR",{broadcastID:this.get("BroadcastID")}))}return}if(this.lastReceivedHeartbeat&&!this.skippedLastHeartbeat&&e.pacemaker===this.lastReceivedHeartbeat.pacemaker&&e.ts===this.lastReceivedHeartbeat.ts)return;this.consecutivePacemakersOutOfOrder=0,this.skippedLastHeartbeat=!1,e.receivedTime||(e.receivedTime=Date.now());var T=0;e.timestamp&&(T=Date.now()-(e.timestamp-A.clientTimeDivergence),Math.abs(T)<3e5&&(e.activeSongPosition+=T));if(u&&a&&e.nextSong&&u.get("queueSongID")==e.nextSong.queueSongID&&f&&f.get("duration")<e.activeSongPosition+1e3)return;if(e.activeSong)if(!u||e.activeSong.queueSongID!=u.get("queueSongID")){var N=o.get(e.activeSong.queueSongID),C=u&&u.get("playStatus")===m.PLAYING;N&&u&&N===f&&C&&g>A.MAX_LISTENER_DRIFT&&f.get("duration")<e.activeSongPosition-A.MAX_LISTENER_DRIFT?w=!0:N&&N==a&&u&&C&&y<A.MAX_LISTENER_DRIFT&&y>0?w=!0:(N?(E.activeSong=N,u=N,e.activeSong.token&&N.set("token",e.activeSong.token),a===u&&(a=null)):h=new n.Models.BroadcastSong(e.activeSong,{dontCache:!0}),c=!0)}else!u.get("token")&&e.activeSong&&e.activeSong.token&&u.set("token",e.activeSong.token);else u=null,E.activeSong=null;var k=null,L=null;e.nextSong?!a||e.nextSong.queueSongID!=a.get("queueSongID")?(a&&u&&a!=u&&!h&&!w&&!l&&s.removeSongs(a.get("queueSongID"),{fromParasite:!0}),L=o.get(e.nextSong.queueSongID),L||(e.nextSong instanceof n.Models.BroadcastSong||(e.nextSong=new n.Models.BroadcastSong(e.nextSong)),k=e.nextSong)):!a.get("token")&&e.nextSong&&e.nextSong.token&&a.set("token",e.nextSong.token):a&&!l&&a!==u&&s.removeSongs(a.get("queueSongID"),{fromParasite:!0});if(w){this.skippedLastHeartbeat=!0,this.lastReceivedHeartbeat=e;return}this.lastReceivedHeartbeat=e;var O=[],M=0,_=!1,D=!1;if(h){O.push(h),k&&O.push(k),M=v.LAST;if(h.get("token")){if(e.activeSongStatus==m.PLAYING||e.activeSongStatus==m.BUFFERING)_=!0;else if(e.activeSongStatus==m.LOADING||e.activeSongStatus==m.INITIALIZING)l?_=!0:D=!0}else console.log("missing token",h,e.activeSongStatus)}else k&&(M=c?o.indexOf(u)+1:v.LAST,O.push(k));O.length?(s.addSongs(O,{context:b,index:M,fromParasite:!0}),s.set(E),h&&(_?(e.activeSongPosition>A.MAX_LISTENER_DRIFT?s.playSong(h.get("queueSongID"),{position:e.activeSongPosition,fromParasite:!0}):s.playSong(h.get("queueSongID"),{fromParasite:!0}),u=s.get("activeSong")):D&&h.load({useFileToken:!0}))):u&&L&&!l?(s.set(E),L&&o.indexOf(L)!=o.length-1&&(s.removeSongs(L.get("queueSongID"),{fromParasite:!0}),s.addSongs(L,{context:b,fromParasite:!0}))):s.set(E);if(h||!u)return;S=u.get("playStatus");switch(e.activeSongStatus){case m.FAILED:l?u.get("token")&&s.playSong(u,{useFileToken:!0,fromParasite:!0}):u.playStatus!=m.NONE&&u.playStatus<m.FAILED&&u.stop();break;case m.NONE:case m.COMPLETED:Math.abs(y)>A.MAX_LISTENER_DRIFT&&S!==m.FAILED&&u.stop();break;case m.PAUSED:S!==m.FAILED&&u.pause();break;case m.LOADING:case m.INITIALIZING:u.get("token")&&S!==m.FAILED&&u.load({useFileToken:!0});break;case m.BUFFERING:this.reSyncWithBroadcasterAtNextSong=!0;break;case m.PLAYING:if(S===m.FAILED)break;this.lastReceivedHeartbeat&&this.lastReceivedHeartbeat.activeSongStatus==m.BUFFERING&&this.reSyncWithBroadcasterAtNextSong&&(e.activeSongPosition<this.lastReceivedHeartbeat.activeSongPosition+A.MAX_LISTENER_DRIFT?this.reSyncWithBroadcasterAtNextSong=!1:e.activeSongPosition>u.get("position")+A.MAX_LISTENER_DRIFT&&(this.reSyncWithBroadcasterAtNextSong=!1));var P=Math.abs(u.get("position")-e.activeSongPosition);u.get("position")<A.MAX_LISTENER_DRIFT&&(P<A.MAX_LISTENER_DRIFT?this.consecutiveNegativeBeginningPositions=0:e.activeSongPosition<0&&(this.consecutiveNegativeBeginningPositions++,this.consecutiveNegativeBeginningPositions%2==0&&this.consecutiveNegativeBeginningPositions<10&&d(P)));switch(S){case m.BUFFERING:this.broadcastActiveSongSeek(e.activeSongPosition);break;case m.PAUSED:this.broadcastActiveSongSeek(e.activeSongPosition),e.activeSongPosition>0&&u.resume();break;case m.PLAYING:P>A.MAX_LISTENER_DRIFT&&!this.reSyncWithBroadcasterAtNextSong&&this.broadcastActiveSongSeek(e.activeSongPosition);break;default:u.get("token")?e.activeSongPosition>A.MAX_LISTENER_DRIFT?s.playSong(u,{useFileToken:!0,position:e.activeSongPosition,fromParasite:!0}):s.playSong(u,{useFileToken:!0,fromParasite:!0}):console.log("missing token",u)}}s.get("isBroadcasting")||(this.broadcasterLoadingSongTimer&&clearTimeout(this.broadcasterLoadingSongTimer),e.activeSongStatus==m.LOADING&&(this.broadcasterLoadingSongTimer=setTimeout(function(){console.log("broadcasterLoadingSongTimer fired")},2e4)))},updateBroadcastFromHeartbeat:function(){var e=this.get("status"),t=this.get("activeSong"),r=this.get("nextSong"),i=this.get("history"),s=e&&e.activeSong,o=e&&e.nextSong,u=s&&s.artistProfile&&s.artistProfile.artist&&s.artistProfile.artist.ArtistID,a=this.get("activeArtist")&&this.get("activeArtist").get("ArtistID"),f=!1,l=!1,c={},h=this.get("cachedBroadcastSongs")||{},p=this.get("cachedBroadcastSuggestions")||{},d=n.getLoggedInUserID(),v=0,m,g;if(!e)return;s&&s.SongID&&(!t||s.queueSongID!=t.get("queueSongID"))?(s.broadcastSongID=[this.id,":",s.queueSongID].join(""),e.activeSongVotes&&(e.activeSongVotes.up&&e.activeSongVotes.up[d]?v=1:e.activeSongVotes.down&&e.activeSongVotes.down[d]&&(v=-1)),h[s.broadcastSongID]?(s=h[s.broadcastSongID],m=e.activeSongVotes?_.keys(e.activeSongVotes.up):[],g=e.activeSongVotes?_.keys(e.activeSongVotes.down):[],s.set({upVotes:m,downVotes:g,upVoteCount:m.length,downVoteCount:g.length,isActiveSong:!0,userVote:v})):(e.userVote=v,e.activeSongVotes&&(s.upVotes=_.keys(e.activeSongVotes.up),s.downVotes=_.keys(e.activeSongVotes.down)),s.isActiveSong=!0,s=new n.Models.BroadcastSong(s,{dontCache:!0}),h[s.id]=s),f=!0):s?t&&(e.activeSongVotes&&(e.activeSongVotes.up&&e.activeSongVotes.up[d]?v=1:e.activeSongVotes.down&&e.activeSongVotes.down[d]&&(v=-1)),m=e.activeSongVotes?_.keys(e.activeSongVotes.up):[],g=e.activeSongVotes?_.keys(e.activeSongVotes.down):[],t.set({upVotes:m,downVotes:g,upVoteCount:m.length,downVoteCount:g.length,userVote:v})):(s=null,f=!0),o&&o.SongID&&(!r||o.queueSongID!=r.get("queueSongID"))?(o.broadcastSongID=[this.id,":",o.queueSongID].join(""),h[o.broadcastSongID]?o=h[o.broadcastSongID]:(o=new n.Models.BroadcastSong(o,{dontCache:!0}),h[o.id]=o),l=!0):o||(o=null,l=!0),f&&i&&i.models[0]&&t&&i.models[0].get("queueSongID")===t.get("queueSongID")&&(c.sumVotes=this.get("sumVotes")+i.models[0].get("userVote")),e.activeSongPosition&&(c.activeSongPosition=e.activeSongPosition),e.activeSongStatus&&(c.activeSongStatus=e.activeSongStatus),e.timestamp&&(c.lastHeartbeatTime=e.timestamp),f&&(t&&t.set("isActiveSong",!1),c.activeSong=s),l&&(c.nextSong=o),u!==a&&(c.activeArtist=this.getActiveArtistModel()),this.set(c)},getActiveArtistModel:function(){var e=this.get("status").activeSong,t=e&&e.artistProfile,r=t&&t.artist;if(!r)return;return n.Models.Artist.newOrUpdate({ArtistID:r.ArtistID,ArtistName:r.Name,Tags:r.Tags,IsVerified:r.IsVerified,CoverArtFilename:r.CoverArtFilename,Flags:r.Flags,Bio:r.Bio,BioAttribution:r.BioAttribution},{noCache:!0,dontCache:!0})},broadcastActiveSongSeek:function(e){var t=this.get("activeSong"),r=t&&t.get("queueSongID"),i=this.get("host"),s=i&&i.get("songs"),o=s&&s.get(r),u=A.MAX_LISTENER_DRIFT,a=n.Models.Player,f=a.playStatuses,l;return!o||!i?(console.log("attempted activeSongSeek but not queue broadcast..."),!1):e<0?Math.abs(e)<u?!0:(l=o.get("playStatus"),l!=f.PAUSED&&l!=f.FAILED&&(o.pause(),this.broadcastResumePlayback&&clearTimeout(this.broadcastResumePlayback),this.broadcastResumePlayback=setTimeout(function(){console.log("reSync")},Math.abs(e+u))),!0):(o.seekTo(e,{fromParasite:!0}),!0)},activeVotesChanged:function(){this.isLoggedInUserOwner()&&x.call(this)},remoraResetQueue:function(e,n){return this.remoraAddSongs(e,t,_.extend(n,{resetQueue:!0}))},remoraSetInitialSongsStatus:function(e){var t=e.get("songs"),n=e.get("activeSong");t&&(this.remoraResetQueue(t.models.slice(0,5e3),{activeQueueSongID:n&&n.get("queueSongID"),queue:e,truncate:!0}),n&&this.remoraPlaySong(n))},remoraPlaySong:function(e,t,r){var i={action:"playSong",queueSongID:e.get("queueSongID"),country:n.Services.API.country,sourceID:1,streamType:n.Models.PlayableSong.calculateStreamType(e.get("context")),position:_.orEqualEx(t,e.get("position"),0),options:r||{}};this.sendToRemora(i)},remoraSeek:function(e){var t={action:"seek",position:e};this.sendToRemora(t)},remoraPause:function(){var e={action:"pause"};this.sendToRemora(e)},remoraResume:function(){var e={action:"resume"};this.sendToRemora(e)},remoraAddSongs:function(e,t,r){var i=r||{},s=this.get("host")||i.queue,o={},u=[],a=[],f=this,l=!1,c,h;return s?(e[0]instanceof Backbone.Model||(l=!0),_.each(e,function(e){var t,n,r;l?(t=e.songID,n=e.calloutID,r=e.queueSongID):(t=e.get("SongID"),n=e.get("CalloutID"),r=e.get("queueSongID"));if(t&&r)u.push(t),a.push(r);else{if(!n||!r){console.log("bad song sent to broadcast.addSongs",e);return}u.push(n*-1),a.push(r)}l||(o[r]=e)}),c={action:i.resetQueue?"resetQueue":"addSongs",songIDs:u,queueSongIDs:a,activeQueueSongID:i.activeQueueSongID,truncate:i.truncate},_.defined(t)&&(c.index=t),h=function(e){var t="ERROR_ADDING_SONG";e&&e.response&&e.response.errorNum===-11&&(t="ERROR_TOO_MANY_SONGS_INBROADCAST"),n.trigger("notification:add",{description:_.getString(t,{limit:5e3}),type:"error",duration:5e3}),f.refreshQueueAfterUpdateFail(s)},s.setSyncing(!0),this.sendToRemora(c).done(function(e){if(!e||!e.response||!e.success||!e.response.queueSongIDs){h(e);return}var t=e.response.queueSongIDs,n=[],r=!1,u,a;for(u=0,a=t.length;u<a;u++){if(!o[t[u]]){l||console.error("Received queueSong from remora that we didnt send:",t[u]),r=!0;break}n.push(o[t[u]])}if(r){f.refreshQueueAfterUpdateFail(s);return}i=_.extend(i,{internal:!0,fromParasite:!0});if(i.resetQueue)s.constructor.prototype.resetSongs.call(s,n,i);else{if(n.length==0){h(e);return}s.constructor.prototype.addSongs.call(s,n,i)}s.setSyncing(!1)}).fail(h)):$.Deferred().reject().promise()},remoraRemoveSongs:function(e,t){var r=t||{},i=this.get("host")||r.queue,s=[],o=this,u,a;if(!i)return;return _.each(e,function(e){var t=e.get("queueSongID");t?s.push(t):console.log("bad song sent to broadcast.remoraRemoveSongs",e)}),u={action:"removeSongs",queueSongIDs:s},a=function(){n.trigger("notification:add",{description:_.getString("ERROR_REMOVING_SONG"),type:"error",duration:5e3}),o.refreshQueueAfterUpdateFail(i)},i.setSyncing(!0),this.sendToRemora(u).done(function(t){i.constructor.prototype.removeSongs.call(i,e,r),i.setSyncing(!1)}).fail(a)},_remoraMoveSongs:function(e,t,r){var i=r||{},s=[],o=this.get("host")||i.queue,u=this,a,f;if(!o)return;return _.each(e,function(e){var t=e.get("queueSongID");t?s.push(t):console.log("bad song sent to broadcast._remoraMoveSongs",e)}),a={action:"moveSongs",queueSongIDs:s,index:t},f=function(){n.trigger("notification:add",{description:_.getString("ERROR_MOVE_SONGS"),type:"error",duration:5e3}),u.refreshQueueAfterUpdateFail(o)},o.setSyncing(!0),this.sendToRemora(a).done(function(e){o.setSyncing(!1)}).fail(f)},sendToRemora:function(e){var t=this.get("controlChannel"),i=r.model.get("manatee"),s=this.get("controlMonitor"),o=n.getLoggedInUserID(),u=n.Models.Comment.ADMINS[o],a=this.isLoggedInUserOwner()||this.isUserVIP(o)||u,f=$.Deferred(),l=k++,c,h;return!a||!i||!t?f.reject().promise():(e.blackbox||(e.blackbox={}),e.blackbox.remoraRespID=l,e&&e.action!=="ping"&&console.log("sendToRemora",e),i.publishToChannels([t],e),s?(h=_.bind(function(e,t,n){if(!t||!t.blackbox||!t.blackbox.remoraRespID||!n.sudo)return;t.blackbox.remoraRespID==l&&(clearTimeout(c),s.removeListener(h),t.success?f.resolve(t):f.reject(t))},this),c=setTimeout(function(){n.Services.Log.notify("Timed out waiting for remora to respond to request","ERROR",{action:e&&e.action}),s.removeListener(h),f.reject(null)},15e3),s.listen(h)):u?f.resolve():f.reject(),f.promise())},pingRemora:function(){var e={action:"ping",idle:!1,away:!1};r.model.get("userActive")||(e.idle=r.lastActive<=Date.now()-A.OWNER_IDLE_TIME,n.off("userActivity",null,this),n.once("userActivity",this.pingRemora,this)),this.sendToRemora(e)},monitor:function(){var e=this.get("monitor"),t=A.monitorBroadcastKeys(this.id);return e!==t.monitor&&this.set("monitor",t.monitor),t},unmonitor:function(){var e=this.get("monitor");return e&&(e.stop(),this.set("monitor",null)),!0},monitorChat:function(){var e=this.get("chatMonitor"),t=A.monitorBroadcastChatKeys(this.id);return e!==t.monitor&&this.set("chatMonitor",t.monitor),t},unmonitorChat:function(){var e=this.get("chatMonitor");return e&&(e.stop(),this.set("chatMonitor",null)),!0},subscribe:function(){return A.subscribeToBroadcast(this.id)},unsubscribe:function(){var e=this.get("subscription");return e&&(e.stop(),this.set("subscription",null)),!0},getListeners:function(){var e=this.get("listeners"),t;return e?(t=$.Deferred(),t.resolve(e.toArray())):A.getBroadcastListeners(this.id,this)},getListenerCount:function(){return A.getBroadcastListenerCount(this.id,this)},getTitle:function(e){return e?this.get("Name"):this.escape("Name")},transferFromOldBroadcast:function(e,t){var r=this.id,s=e.get("chatActivities"),o={BroadcastID:r,history:new n.Models.Collections.BroadcastSongs([],{broadcastID:r}),chatActivities:new n.Models.Collections.ChatActivities(s&&s.models,{silentCapping:!0,limit:100}),cachedBroadcastSongs:{},cachedBroadcastSuggestions:{},lastUpdated:Date.now(),pendingNewOwner:null},u=e.get("listeners"),a=[],f=e.get("suggestions"),l=e.get("activeSong"),c=e.get("nextSong"),h,p;if(t){var d=t.get("UserID");o.UserID=d,o.ownerModel=t,o.ownerUserIDs=[d]}o.suggestions=new n.Models.Collections.BroadcastSuggestions(null,{modelOptions:{dontCache:!0,broadcastListeners:u}}),o.suggestions.comparator=i,f&&(e.get("suggestions").each(function(e){p=e.get("SongID"),e=new n.Models.BroadcastSuggestion($.extend({SongID:p},e.attributes),{dontCache:!0,wrappedModel:e._wrapped}),a.push(e),o.cachedBroadcastSuggestions[p]=e}),o.suggestions.add(a)),l&&(p=l.get("SongID"),h=$.extend({SongID:p},l.attributes,{broadcastSongID:[r,":",l.get("queueSongID")].join("")}),l=new n.Models.BroadcastSong(h,{dontCache:!0}),o.activeSong=l,o.cachedBroadcastSongs[h.broadcastSongID]=l),c&&(p=c.get("SongID"),h=$.extend({SongID:p},c.attributes,{broadcastSongID:[r,":",c.get("queueSongID")].join("")}),h.broadcastSongID=[r,":",c.get("queueSongID")].join(""),c=new n.Models.BroadcastSong(h,{dontCache:!0}),o.nextSong=c,o.cachedBroadcastSongs[h.broadcastSongID]=c),this.set($.extend({},e.attributes,o)),e.trigger("transferred",this)},setListeners:function(e){var t=this.get("listeners");if(t){t.reset(e),this.set("listenersLoaded",!0);return}var r=new n.Models.Collections.TinyUsers([],{modelOptions:{dontCache:!0,skipUpdate:!0}}),i=this.get("UserID"),s=this.get("vipUsers"),o,u;this.on("change:UserID",function(e,t){t&&(i=t.id,r.sort())}),this.on("change:vipUsers",function(e,t){u=this.previous("vipUsers"),u&&u.off(null,null,r),s=t,s.on("add remove reset",function(){this.sort()},r),r.sort()},this),r.comparator=function(e,t){if(e.id===i)return-1;if(t.id===i)return 1;if(s!=null){o=(s.get(t.id)?1:0)-(s.get(e.id)?1:0);if(o!==0)return o}return n.Models.TinyUser.interactedNiftyFriendSort(e,t)},r.add(e),this.set({listeners:r,listenersLoaded:!0})},addHistoryListenCount:function(e,t){var n=this.get("history"),r=t;for(var i=0,s=n.models.length;i<s;i++)if(n.models[i]&&n.models[i].get("SongID")==e){r-=_.toInt(n.models[i].attributes.listens),n.models[i].set({listens:t});break}},isLoggedInUserOwner:function(){return this.attributes.ownerUserIDs&&_.contains(this.attributes.ownerUserIDs,n.getLoggedInUserID())},isListener:function(){return!this.isLoggedInUserOwner()&&this.get("host")!=null&&this.get("activeStatus")>0},isBroadcasting:function(){return this.isLoggedInUserOwner()&&this.get("host")!=null&&this.get("activeStatus")>0},isUserVIP:function(e){var t=this.get("vipUsers");return!!t&&!!t.get(e)},getPermissionsForUserID:function(e){if(this.attributes.ownerUserIDs&&_.contains(this.attributes.ownerUserIDs,e))return n.Models.Broadcast.VIP_PERM_ADMIN;var t=this.get("vipUsers"),r=t?t.get(e):null;return r?r.get("permissions"):0},checkPermissionsForUserID:function(e,t){return(this.getPermissionsForUserID(e)&t)>0},addVIPCallout:function(e){if(!this.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_CALLOUTS)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CALLOUT_PERMISSIONS"),type:"error",duration:5e3});return}},updateBroadcastDetails:function(e,t,r,i,s,o,u,a,f,l){i=_.orEqual(i,null),s=_.orEqual(s,null);var c=$.Deferred(),h=n.getLoggedInUserID(),p=this.isUserVIP(h),d=this.get("BroadcastID"),v=this.get("Tag"),m=this.get("Description"),g,y;if(!this.isLoggedInUserOwner()&&!p)return n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_NOT_OWNER"),type:"error",duration:5e3}),c.reject();if(p&&!this.checkPermissionsForUserID(h,n.Models.Broadcast.VIP_PERM_METADATA))return n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_PERMISSIONS"),type:"error",duration:5e3}),c.reject();e=_.isString(e)&&e.substr(0,255);if(!e||e===this.get("Name"))e=null;if(t===null&&v&&v.i>0)t={i:0,n:"multi-genre"};else if(t===v||t&&v&&v.i===t.i||!v&&t&&t.i===0)t=null;return m||(m=""),r!=null&&r!==m?r=r.substr(0,1024):r=null,s!==null&&s===this.get("Privacy")&&(s=null),o||(o=null),u!==null&&u===this.get("PromoImage")&&(u=null),a!==null&&a===this.get("CoverPhoto")&&(a=null),f!==null&&f===this.get("StockCoverPhoto")&&(f=null),a===null&&f===null&&l!==null&&(l=null),e!==null||r!==null||i!==null&&i!=this.get("Image")||s!==null&&s!=this.get("Privacy")||!(!t&&!v||t&&v&&t.i==v.i)||o!==null||u!==null||a!==null||f!==null?(y=function(){var n={},h={action:"updateSettings",settings:n};e!==null&&(n.name=e),r!==null&&(n.description=r),i!==null&&(n.image=i),s!==null&&(n.privacy=s),o!==null&&(n.urls=o),u!==null&&(n.promoImage=u);if(a!=null||f!=null)n.coverPhotoOptions={photo:a||"",stock:f||0,y:l||0,flags:0};t&&(t.i?n.tag=t:n.tag=null),this.sendToRemora(h),c.resolve(this)},p?y():(g=n.Services.API.broadcastUpdateExtraData({broadcastID:d,name:e,tag:t,description:r,image:i,privacy:s,urls:o,promoImage:u,asArtistID:this.get("ArtistID"),coverPhoto:a,stockCoverPhotoID:f,coverPhotoY:l}),g.done(_.bind(y,this)),g.fail(_.bind(c.reject,c))),c.promise()):(c.resolve(this),c.promise())},setCoverPhoto:function(e,t,n,r){if(this.isBroadcasting())return this.addNewCoverPhoto(e,t,n,r.imageFilename);var i={},s;e?(s=(new Date).getTime(),i={CoverPhoto:e+"?"+s,StockCoverPhoto:""}):i={CoverPhoto:"",CoverPhotoY:n,StockCoverPhoto:t},r.imageFilename&&(i.Image=r.imageFilename),this.set(i)},updateBroadcastPreferences:function(e,t){var r=n.getLoggedInUserID(),i={},s=!1;return this.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_FEATURES)?(e!==this.get("chatEnabled")&&(i.chatEnabled=!!e,s=!0),t!==this.get("suggestionsEnabled")&&(i.suggestionsEnabled=!!t,s=!0),s?this.sendToRemora({action:"updateSettings",settings:i}):$.Deferred().resolve().promise()):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_PERMISSIONS"),type:"error",duration:5e3}),$.Deferred().reject().promise())},addNewPromoImage:function(e){var t=n.getLoggedInUserID();return e?this.checkPermissionsForUserID(t,n.Models.Broadcast.VIP_PERM_METADATA)?this.sendToRemora({action:"updateSettings",settings:{promoImage:e}}):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_PERMISSIONS"),type:"error",duration:5e3}),$.Deferred().reject().promise()):$.Deferred().reject().promise()},addNewCoverPhoto:function(e,t,r,i){var s=n.getLoggedInUserID(),o;return!e&&!t?$.Deferred().reject().promise():this.checkPermissionsForUserID(s,n.Models.Broadcast.VIP_PERM_METADATA)?(o={photo:e||"",stock:t||0,y:r||0,flags:0},this.sendToRemora({action:"updateSettings",settings:{coverPhotoOptions:o,image:i}})):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_PERMISSIONS"),type:"error",duration:5e3}),$.Deferred().reject().promise())},sendChatMessage:function(e,t){var i=_.orEqual(r.model.get("user").get("settings"),{}),s=_.orEqual(i.local,{}),u=A.CHAT_SERVER_PREFIX_PUBLIC+o(this.id),a=r.model.get("manatee"),f=!1;s&&s.ignoreChatTag&&(f=!0);var l={type:"chat",data:e.substr(0,256),ignoreTag:f},c=this.get("activeSong");c&&(l.playingSongID=c.get("SongID")),n.getLoggedInUserID()>0&&(a.publishToChannels([u],l,!1,!0),n.trigger("guts:log","broadcastChatMessageSent",{broadcastID:this.id}),this.suggestInvitingUserFriends())},suggestSong:function(e,t){function c(){var t=e.toManateeProperties(),u=n.getLoggedInUserID(),f=r.model.get("manatee"),c=A.CHAT_SERVER_PREFIX_PUBLIC+o(s.id),h=s.isUserVIP(u),p;if(i<1||!t){console.log("songID sent to suggestSong is less than 1 or song is invalid",i);return}if(h&&s.checkPermissionsForUserID(u,n.Models.Broadcast.VIP_PERM_AUTO_APPROVE)){p={type:"vipRequest",data:{action:"addSongEx",song:t,index:-1,resultKey:"vip:addSongEx:"+i}},c=A.CHAT_SERVER_PREFIX+o(s.id),f.publishToChannels([c],p);return}if(!s.get("suggestionsEnabled")){a();return}p={type:"suggestion",data:{song:t,songID:i}},f.publishToChannels([c],p).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_FAILED",{song:e.escape("SongName")}),type:"error",duration:5e3}),n.trigger("guts:log","broadcastSuggestFailed",l)}),n.trigger("guts:log","broadcastSongSuggested",l)}if(!this.get("activeStatus"))return;var i=e.get("SongID"),s=this,u=this.get("blockedSuggestionSongIDs");if(u&&_.indexOf(u,i)>-1){n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_BLOCKED"),type:"error",duration:5e3});return}var a=function(){n.trigger("notification:add",{description:_.getString("SUGGESTIONS_DISABLED"),type:"error",duration:5e3})};if(!this.get("suggestionsEnabled")){a();return}var f=this.get("cachedBroadcastSuggestions")[i];if(f&&_.indexOf(f.get("upVotes"),n.getLoggedInUserID())>-1){n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_ALREADY_VOTED",{song:f.escape("SongName")}),type:"error",url:this.toUrl(),duration:5e3}),f.set("userVote",t?-1:1);return}var l={songID:i};n.getLoggedInUserID()>0?(this.suggestInvitingUserFriends(),c()):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_SUGGEST"),onLogin:c,destination:this.toUrl()})},addSong:function(e,t){var i=e?e.toManateeProperties():null,s=e.get("SongID"),u=n.getLoggedInUserID(),a=r.model.get("manatee"),f=A.CHAT_SERVER_PREFIX+o(this.id),l=this.isUserVIP(u),c;if(!l||!i)return!1;if(t===n.Models.Player.playSpecialIndexes.NEXT){if(!this.checkPermissionsForUserID(u,n.Models.Broadcast.VIP_PERM_PLAY_NEXT))return!1}else{if(t!==n.Models.Player.playSpecialIndexes.LAST)return!1;if(!this.checkPermissionsForUserID(u,n.Models.Broadcast.VIP_PERM_AUTO_APPROVE))return!1}return c={type:"vipRequest",data:{action:"addSongEx",song:i,index:t,resultKey:"vip:addSongEx:"+s}},a.publishToChannels([f],c),!0},suggestInvitingUserFriends:function(){function e(){this.newChatActivity(new n.Models.ChatActivity({type:"info",infoType:"inviteUserFollowers"})),this.suggestedInvitation=!0}if(this.isLoggedInUserOwner())return;if(this.suggestedInvitation||this.get("activeStatus")!==1)return;this.suggestInvitingUserFriendsTimer?(clearTimeout(this.suggestInvitingUserFriendsTimer),this.suggestInvitingUserFriendsTimer=null):this.suggestInvitingUserFriendsTimer=setTimeout(_.bind(e,this),1e4)},suggestInvitingBroadcasterFriends:function(){if(this.get("history").length<2)return;this.off("change:activeSong",this.suggestInvitingBroadcasterFriends),this.get("listenersCount")<5&&this.newChatActivity(new n.Models.ChatActivity({type:"info",infoType:"inviteBroadcasterFollowers"}))},removeSuggestion:function(e,t){var i=e.get("SongID"),s=this.get("suggestions"),u=r.model.get("manatee"),a=A.CHAT_SERVER_PREFIX_PUBLIC+o(this.id),f=this.get("blockedSuggestionSongIDs"),l;if(f&&_.indexOf(f,i)>-1){e.set("userVote",0);return}var c=this.get("cachedBroadcastSuggestions")[i];if(c&&_.indexOf(c.get("upVotes"),n.getLoggedInUserID())===-1){c.set("userVote",0);return}if(n.getLoggedInUserID()>0){n.on("manatee:suggestionRemove:"+i,function h(t){(!t||!t.success)&&n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_REMOVE_FAILED",{song:e.escape("SongName")}),type:"error",duration:5e3}),n.off("manatee:suggestionRemove:"+i,h)},this);if(!s.get(i))return;l={type:"suggestionRemove",data:{songID:i}},u.publishToChannels([a],l)}},approveTopSuggestion:function(e,t){if(!_.defined(e)&&!this.get("nextSong")){this.cancelPendingAutoApprove();var r=this.get("suggestions");if(r&&r.length){var i=r.at(0);this.approveSuggestedSong(i,!0),n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_AUTO_APPROVED",{song:i.escape("SongName")}),type:"success",duration:5e3})}return}if(!this.autoApproveTimeout||this.autoApproveAllowOverwrite)this.cancelPendingAutoApprove(),this.autoApproveTimeout=setTimeout(_.bind(this.approveTopSuggestion,this),e),this.autoApproveAllowOverwrite=!!t},cancelPendingAutoApprove:function(){clearTimeout(this.autoApproveTimeout),this.autoApproveTimeout=!1},approveSuggestedSong:function(e,t){function a(){i.setSyncing(!1),n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_SUGGESTION_FAILED"),type:"error",duration:5e3}),e.set("approvalStatus",0)}t=_.orEqual(t,!1);var r=n.getLoggedInUserID(),i=this.get("host");if(!this.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_SUGGESTIONS)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_APPROVE_PERMISSIONS"),type:"error",duration:5e3});return}if(!i||!e||e.get("approvalStatus")==1)return;var s=e.get("SongID"),o=new n.Models.PlayContext,u={songID:s};t&&(u.wasAuto=t),o.type="suggestion",o.data={wasAuto:t},o.addStreamType(n.Models.PlayContext.TYPE_BROADCAST),i.setSyncing(!0),this.sendToRemora({action:"approveSuggestion",songID:s}).done(function(t){if(!t||!t.success||!t.response||!t.response.songsAdded){a();return}var r=[],s=i.get("songs"),o=0;_.each(t.response.songsAdded,function(e){r.push(n.Models.Song.convertManateeSongCalloutProperties(e))}),t.response.queueIndex===-1?o=s?s.length:0:o=t.response.queueIndex,i.constructor.prototype.addSongs.call(i,r,{index:o}),i.setSyncing(!1),e.set("approvalStatus",1)}).fail(a),n.trigger("guts:log","broadcastSuggestionApproved",u)},rejectSuggestedSong:function(e){var t=n.getLoggedInUserID();if(!this.checkPermissionsForUserID(t,n.Models.Broadcast.VIP_PERM_SUGGESTIONS)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_REJECT_PERMISSIONS"),type:"error",duration:5e3});return}if(!e||e.get("approvalStatus")==-1)return;var r=e.get("SongID"),i=this.get("cachedBroadcastSuggestions");this.sendToRemora({action:"rejectSuggestion",songID:r}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_SUGGESTION_REJECT_FAILED"),type:"error",duration:5e3}),e.set("approvalStatus",0)}),n.trigger("guts:log","broadcastSuggestionRejected",{songID:r}),i&&i[r]&&delete i[r],e.set("approvalStatus",-1)},voteActiveSong:function(e){if(this.isLoggedInUserOwner())return;var t=this.get("activeSong");if(!t)return;var i,s=n.getLoggedInUserID()+"";e!==0?(e>0?i=t.get("upVotes"):i=t.get("downVotes"),i&&_.indexOf(i,s)>-1&&t.set("userVote",e)):(i=t.get("upVotes"),i&&_.indexOf(i,s)===-1&&(i=t.get("downVotes"),i&&_.indexOf(i,s)===-1&&t.set("userVote",e)));var u=function(e,n){var i=r.model.get("manatee"),s=A.CHAT_SERVER_PREFIX_PUBLIC+o(e),u={type:"activeSongVote",data:{vote:n,queueSongID:t.get("queueSongID")}};i.publishToChannels([s],u)};n.getLoggedInUserID()>0?(u(this.id,e),e>0?n.trigger("guts:log","songUpVoted",{nowPlaying:!0,songID:t.get("SongID")}):e===0?n.trigger("guts:log","songVotedNeutral",{nowPlaying:!0,songID:t.get("SongID")}):n.trigger("guts:log","songDownVoted",{nowPlaying:!0,songID:t.get("SongID")})):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_VOTE"),onLogin:_.bind(u,this,this.id,e),destination:this.toUrl()})},onVIPUsersChanged:function(e,t){var r=_.pluck(t?t.previousModels:[],"id"),i=_.pluck(e?e.models:[],"id"),s=_.difference(i,r),o=_.difference(r,i),u=n.getLoggedInUserID(),a=this.get("chatActivities"),f=this,l,c;a&&a.each(function(t){if(t.get("type")!="message")return;l=t.get("user");if(!l)return;e&&e.get(l.get("UserID"))!=null?t.set("specialFlag","vip"):t.get("specialFlag")==="vip"&&t.unset("specialFlag")}),e&&e.get(u)!=null&&_.indexOf(s,u)>-1?(c=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.YOU_ARE_VIP}),this.newChatActivity(c)):_.indexOf(o,u)>-1&&(c=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.NO_LONGER_VIP}),this.newChatActivity(c)),!t.skipVIPUsersNotifs&&e&&_.each(s,function(t){if(t&&t!=u){l=e.get(t);if(!l)return;c=new n.Models.ChatActivity({type:"info",user:l,infoType:n.Models.ChatActivity.VIP_ADDED}),f.newChatActivity(c)}}),(s.length||o.length)&&this.trigger("vipUsersChanged",e)},banListener:function(e,t){var r=e.get("UserID"),i=n.getLoggedInUserID(),s=this.isLoggedInUserOwner(),o=n.Models.Comment.ADMINS[i],u=this.isUserVIP(i);if(!r)return;if(!s&&!o&&!u){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_NOT_OWNER"),type:"error",duration:5e3});return}if(u&&!this.checkPermissionsForUserID(i,n.Models.Broadcast.VIP_PERM_CHAT_MODERATE)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_PERMISSIONS"),type:"error",duration:5e3});return}if(_.contains(this.attributes.ownerUserIDs,r)||n.Models.Comment.ADMINS[r]||this.isUserVIP(r))return;this.sendToRemora({action:"banListeners",userIDs:[r],offendingMessage:t})},unBanListener:function(e){var t=e.get("UserID"),r=n.getLoggedInUserID(),i=this.get("bannedUsers"),s=this.isLoggedInUserOwner(),o=n.Models.Comment.ADMINS[r],u=this.isUserVIP(r);if(!t||!i||!i.get(t))return;if(!s&&!o&&!u){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_NOT_OWNER"),type:"error",duration:5e3});return}if(u&&!this.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_CHAT_MODERATE)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_PERMISSIONS"),type:"error",duration:5e3});return}this.sendToRemora({action:"removeBannedListeners",userIDs:[t]})},addVIPUser:function(e,t){return this.isLoggedInUserOwner()?e==this.get("UserID")?$.Deferred().reject().promise():this.sendToRemora({action:"addSpecialGuest",userID:e,permission:t}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_PROMOTE_FAILED"),type:"error",duration:5e3})}):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_PROMOTE_NOT_OWNER"),type:"error",duration:5e3}),$.Deferred().reject().promise())},removeVIPUser:function(e){return this.isLoggedInUserOwner()?this.sendToRemora({action:"removeSpecialGuest",userID:e}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_DEMOTE_FAILED"),type:"error",duration:5e3})}):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_DEMOTE_NOT_OWNER"),type:"error",duration:5e3}),$.Deferred().reject().promise())},getImageURL:function(t){var r=this.get("Image"),i=this.getOwner(),s;if(r)s=_.getImageURL(n.Models.Broadcast.artPath+t+"_"+r);else{if(i)return i.getImageURL(t);s=_.getImageURL(n.Models.User.artPath+t+"_user.png")}return s+="?co="+e.location.host,s},getPageImageURL:function(t){var r=_.getCDNImage(n.Models.Broadcast[_.isRetina()?"pageArtRetinaPath":"pageArtPath"]),i="?co="+e.location.host,s=new $.Deferred,o=this.get("CoverPhoto"),u=this.get("StockCoverPhoto"),a,f;return t=t||1280,o?s.resolve(_.getImageURL(n.Models.Broadcast.coverArtPath+t+"_"+o+i)):u?(a=n.Models.Cover.covers[u],a?(f=new n.Models.Cover(a),s.resolve(f.getCoverPath())):s.reject()):s.resolve(r+i),s.promise()},getPromoImageURL:function(t){var r=this.get("PromoImage"),i="?co="+e.location.host;return t=t||800,r?_.getImageURL(n.Models.Broadcast.promoArtPath+t+"_"+r+i):""},getActiveSongImageURL:function(e){var t=this.get("activeSong");return t?t.getImageURL(e):_.getImageURL(n.Models.Song.artPath+e+"_album.png")},toUrl:function(e,t){var n=this.get("ArtistID"),r=this.get("UserID"),i=this.getOwner(),s;if(!r&&!n&&!i)return null;if(i){if(this.get("activeStatus")>0)return e?t?i.toUrl("broadcast/"+this.id+"/"+t):i.toUrl("broadcast/"+this.id):t?i.toUrl("broadcast/current/"+t):i.toUrl("broadcast/current");return i.toUrl("broadcast/"+this.id)}return n?s="artist":s="profile",_.cleanUrl("-",n||r,s,null,"broadcast/"+this.id)},updateOwnerModel:function(e){if(!(e instanceof n.Models.User&&this.get("ownerModel")!==e))return;if(this.get("UserID")!=e.id)return;this.set("ownerModel",e)},toManateeProperties:function(){return{bID:this.get("BroadcastID"),n:this.get("Name"),aID:this.get("ArtistID"),uID:this.get("UserID"),t:this.get("Tag"),d:this.get("Description"),pr:this.get("Privacy"),im:this.get("Image"),pbID:this.get("ParentBroadcastID"),ir:this.get("IsRandomName"),s:this.get("Subscribers"),ps:this.get("PeakSubscribers"),ts:this.get("TSCreated")}},toOwnerUrl:function(){var e=this.get("ArtistID"),t=this.get("UserID"),r=this.getOwner(),i;if(!t&&!e&&!r)return null;if(!r){if(e){var s=n.Models.Artist.getCached(e);s&&(r=s),i="artist"}else{var o=n.Models.User.getCached(t);o&&(r=o),i="user"}i="profile"}return r?r.toUrl():_.cleanUrl("-",e||t,i)},getOwner:function(){if(this.attributes.ownerModel)return this.attributes.ownerModel;if(this.attributes.ArtistID){var e=n.Models.Artist.getCached(this.get("ArtistID"));return e||null}var t=n.Models.User.newOrUpdate({UserID:this.get("UserID"),Name:this.get("OwnerName")});return t||null},getOwnerAnchorTag:function(e,t){var n=this.getOwner(),r,i;return n?n.getAnchorTag(e,t,!0):(r=this.get("OwnerName")||_.getString("UNKNOWN_USER"),i=_.cleanUrl(r,this.get("UserID"),"profile",null,t),'<a href="'+i+'" class="user-link">'+(e?_.getString(e).toLocaleLowerCase():_.escape(r))+"</a>")},newListener:function(e){if(e&&e.u>0){var t=this.get("listeners"),r=t&&t.get(e.u);if(r){r.updateFromManatee(e);return}r=new n.Models.TinyUser(e),t&&t.add(r);if(r.id!=n.getLoggedInUserID()){var i=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.JOINED_BROADCAST,users:new n.Models.Collections.TinyUsers([r])});this.newChatActivity(i)}}this.get("listenersLoaded")&&this.set("listenersCount",_.toInt(this.get("listenersCount"))+1)},listenerLeft:function(e){if(e&&e.u>0){var t=this.get("listeners"),r=t&&t.get(e.u);if(t){if(!r)return;t.remove(r)}else r=new n.Models.TinyUser(e);if(r.id!=n.getLoggedInUserID()){var i=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.LEFT_BROADCAST,users:new n.Models.Collections.TinyUsers([r])});this.newChatActivity(i)}}this.get("listenersLoaded")&&this.set("listenersCount",Math.max(1,this.get("listenersCount")-1))},suggestionApproved:function(e,t,r){var i=r||{};if(!e){console.log("sugg app no song",e);return}var s=this.get("listeners"),o=s&&s.get(t)||n.Models.User.getCached(t),u=this.get("suggestions"),a=this.get("approvedSuggestions"),f;e.get("userVote")&&_.indexOf(e.get("upVotes"),n.getLoggedInUserID())===0&&n.trigger("notification:add",{type:"success",description:_.getString("POPUP_BROADCAST_SUGGESTION_APPROVED",{song:e.escape("SongName")}),url:this.toUrl(),duration:5e3}),u&&u.remove(e),a&&a.add(e.clone()),e.set({userVote:0,approvalStatus:1}),i.initialChanges!==!0&&(f=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.SUGGESTION_APPROVED,song:e,user:o}),this.newChatActivity(f))},suggestionAdded:function(e,t,r){var i=r||{};if(!e||!t){console.log("sugg add no song/user",e,t);return}if(i.initialChanges!==!0){var s=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.SUGGESTION_ADDED,song:e,user:t});this.newChatActivity(s)}},newChatActivity:function(e){var i=this.get("unreadChatActivities"),s=this.get("chatActivities"),o=this.get("bannedUsers"),u=_.orEqual(r.model.get("user").get("settings"),{}),a=_.orEqual(u.local,{}),f=e.get("infoType"),l=n.Models.ChatActivity,c=f===l.JOINED_BROADCAST||f===l.LEFT_BROADCAST,h=f===l.SONG_CHANGED,p=f===l.SUGGESTION_ADDED||f===l.SUGGESTION_APPROVED,d=e.get("artist"),v=e.get("user"),m;if(c&&a.joinLeftDisabled||h&&a.nowPlayingDisabled||p&&a.suggestionsDisabled)return;i||(i=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100}),this.set("unreadChatActivities",i)),s||(s=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100}),this.set("chatActivities",s));if(e.get("type")==="message")if(o&&v&&o.get(v.id)&&v.id!==n.getLoggedInUserID())e.set("specialFlag","banned");else if(d&&this.get("ArtistID")==d.id)e.set("specialFlag","owner");else if(v&&_.contains(this.get("ownerUserIDs"),v.id))e.set("specialFlag","owner");else if(v&&this.isUserVIP(v.id))e.set("specialFlag","vip");else if(v&&v.get("restricted"))return;m=i.last()||s.last();if(m){n.trigger("chat:merge");if(m.merge(e)){n.trigger("chat:mergeDone");return}}e.set("broadcastID",this.id),i.add(e)},addWelcomeMessage:function(){var e=this.getOwner(),t=this.isLoggedInUserOwner(),r=this.isListener(),i=this.get("initialChatMessagesLoaded"),s=this.get("hasShownWelcomeMessage");if(t||!r||!i||s)return;this.set("hasShownWelcomeMessage",!0),this.newChatActivity(new n.Models.ChatActivity({user:e,type:"info",infoType:n.Models.ChatActivity.WELCOME_MESSAGE}))},markUnreadChatActivitiesRead:function(){var e=this.get("chatActivities"),t=this.get("unreadChatActivities"),n=t?t.remove(t.models):[];return e&&e.add(n),n},cleanupOnEnd:function(e){n.trigger("broadcast:notifEvent",this,!0),n.trigger("lightbox:close","queueEnding");var t=this.get("BroadcastID");if(this.get("activeStatus")!==1){this.set("activeStatus",0),n.Models.Broadcast.broadcastsDeferreds[t]&&n.Models.Broadcast.broadcastsDeferreds[t].resolve(this);return}var r=this.get("history"),i=this.get("ownerUserIDs"),s=this.get("ArtistID");if(!e){var o=0,u=0;r&&r.length&&r.each(function(e){o+=e.get("upVotes").length,u+=e.get("downVotes").length}),this.set({activeStatus:0,lastUpdated:Date.now(),activeSong:null,nextSong:null,listenersCount:0,listenersLoaded:!1,listeners:null,suggestions:null,approvedSuggestions:new n.Models.Collections.BroadcastSuggestions([]),blockedSuggestionSongIDs:null,totalUpVotes:o,totalDownVotes:u,cachedBroadcastSongs:{},cachedBroadcastSuggestions:{}});var a;_.each(i,function(e){a=n.Models.User.getCached(e),a&&a.get("currentBroadcastID")===t&&a.set({isOwnerOfCurrentBroadcast:0,currentBroadcastID:null})}),a=n.Models.Artist.getCached(s),a&&a.get("currentBroadcastID")==t&&a.set({isOwnerOfCurrentBroadcast:0,currentBroadcastID:null}),n.Models.Broadcast.broadcastsDeferreds[t]&&n.Models.Broadcast.broadcastsDeferreds[t].resolve(this)}else{var f={suggestions:null,approvedSuggestions:new n.Models.Collections.BroadcastSuggestions([]),blockedSuggestionSongIDs:null,nextSong:null,cachedBroadcastSongs:{},cachedBroadcastSuggestions:{}},l=this.get("activeSong");l&&(f.cachedBroadcastSongs[l.id]=l);if(!this.chatLocks||!this.chatLocks.length)f.chatActivities=null,f.persistentChatActivities=null;this.set(f)}this.stopOwnerLeftTimer()},startOwnerLeftTimer:function(){if(this.get("ownerLeftTimer"))return;var e=setTimeout(_.bind(function(){var e=r.model.get("player").get("queue");if(!e||e.get("currentBroadcast")!==this)return;delete this.popupBroadcasterLeftNotif},this),6e4);n.trigger("notification:add",{title:"",description:_.getString("POPUP_ERROR_BROADCASTER_LEFT"),url:this.toUrl(),duration:6e4,onOpened:_.bind(function(e){this.popupBroadcasterLeftNotif=e},this)});var t=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.BROADCASTER_BAILED});this.newChatActivity(t),this.set("ownerLeftTimer",e)},stopOwnerLeftTimer:function(e){var t=this.get("ownerLeftTimer");if(t){clearTimeout(t);if(e){this.popupBroadcasterLeftNotif&&(this.popupBroadcasterLeftNotif.close(),delete this.popupBroadcasterLeftNotif),n.trigger("notification:add",{title:"",description:_.getString("POPUP_ERROR_BROADCASTER_BACK"),url:this.toUrl()});var r=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.BROADCASTER_BACK});this.newChatActivity(r)}}},getHistory:function(){var e=$.Deferred();return this.get("historyLoaded")&&this.get("history")?e.resolve(this.get("history")):n.Services.API.getBroadcast(this.id,!0).done(_.bind(function(t){if(this.get("historyLoaded")&&this.get("history")){e.resolve(this.get("history"));return}var r=[];if(t&&t.Songs&&t.PlayData){var i=u(t.Songs,t.PlayData,this.id);r=i.songs}var s=new n.Models.Collections.BroadcastSongs(r,{broadcastID:this.id,modelOptions:{dontCache:!0}});this.set({history:s,historyLoaded:!0}),e.resolve(s)},this)).fail(function(t){e.reject(t)}),e.promise()},getSongs:function(){return this.getHistory()},getUpdatedListenersCount:function(){var e=this._getUpdatedListenersCountDfd,t=this.attributes.BroadcastID;if(!e||e.state()!=="pending")e=$.Deferred(),this._getUpdatedListenersCountDfd=e;return e.promise()},toProxyLabel:function(){return _.getString("VAR_NAME",{name:this.escape("Name")})},subscribeToChat:function(e,t){var n=this.id,r;if(!this.chatLocks.length||t)r=A.subscribeToBroadcastChat(n);return _.indexOf(this.chatLocks,e)===-1&&this.chatLocks.push(e),r},unsubscribeFromChat:function(e){var t=_.indexOf(this.chatLocks,e);t>-1&&this.chatLocks.splice(t,1);if(!this.chatLocks.length){var n=this.get("publicChannelSubscription");n&&(n.stop(),this.set("publicChannelSubscription",null))}},unsubscribeAllFromChat:function(){this.chatLocks=[];var e=this.get("publicChannelSubscription");e&&(e.stop(),this.set("publicChannelSubscription",null))},inviteUserToTransferOwnership:function(e,t){function f(){o.reject({error:"ackTimeout"})}function l(){a&&clearTimeout(a),a=!1}function c(){o.reject({error:"cancel"})}function h(e){e&&e.success?a=setTimeout(f,5e3):o.reject({error:"publisherFailed"})}function p(t){var r=t&&t.success;r?(u||(u=new n.Models.Collections.Users([])),u.push(e),o.notify("invited")):o.reject({error:"inviteFailed"})}function d(t){if(t&&t.data&&t.data.accept&&t.userID==s)var n={u:!0,n:e.get("Name"),i:e.id,p:e.get("Picture")};else o.reject({error:"rejected"})}function v(e){e&&e.userID==s&&o.reject({error:"failed"})}function m(e,i){o.resolve(),t?r.model.get("user").leaveBroadcast(!0):n.router.setHash(e.toUrl())}var i=this.get("Name"),s=e.get("UserID"),o=$.Deferred();if(!this.isLoggedInUserOwner()||this.get("activeStatus")!==1)return o.reject({error:"invalid"}),o.promise();var u=this.get("invitedBroadcasters");if(u&&u.get(s))return o.reject({error:"duplicate"}),o.promise();var a=!1;n.once("broadcast:takeoverRequestAck",l),n.once("broadcast:cancelTakeOver",c),n.once("manatee:broadcastDispatch:inviteNewBroadcaster",p,this),n.once("manatee:newBroadcasterResponse",d),n.once("broadcast:renameForTakeOverFailed",v),n.once("manatee:broadcastTransferred",m),o.always(_.bind(function(){n.off("manatee:broadcastAddPublisher:"+s,h),n.off("manatee:broadcastDispatch:inviteNewBroadcaster",p,this),n.off("manatee:newBroadcasterResponse",d),n.off("manatee:broadcastTransferred",m),n.off("broadcast:cancelTakeOver",c),n.off("broadcast:takeoverRequestAck",l),n.off("broadcast:renameForTakeOverFailed",v)},this));var g=this.get("publishersUsersIDs");return g&&_.indexOf(g,s)>-1?h({success:!0}):n.once("manatee:broadcastAddPublisher:"+s,h),o.promise()},addPersistentChatActivity:function(e){var r=this.get("persistentChatActivities");if(!r)r=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100}),this.set("persistentChatActivities",r);else{var i;for(var s=0,o=r.models.length;s<o;s++){i=r.models[s];if(i.attributes.type===e.attributes.type&&i.attributes.infoType===e.attributes.infoType){if(s<o-1){var u=r.models.splice(s,1);u.push(e),r.reset(u)}return}}}r.add(e)},removePersistentChatActivity:function(e,t){var n=this.get("persistentChatActivities");if(!n)return;var r;for(var i=0,s=n.models.length;i<s;i++){r=n.models[i];if(r.attributes.type===e&&r.attributes.infoType===t){n.remove(r);return}}},end:function(e){var t=e||{};if(this.isLoggedInUserOwner())if(!t.skipConfirm&&this.get("listenersCount")>1){var i=this;n.trigger("lightbox:open",{_type:"broadcastEndConfirm",view:{header:"ARE_YOU_SURE",message:"LB_BROADCAST_CONFIRM_CLEAR_QUEUE",messageParams:{num:i.get("listenersCount")-1},buttonsLeft:[{label:"CANCEL",className:"close"}],buttonsRight:[{label:"IM_SURE",className:"btn-primary submit"}]},callbacks:{".submit":_.bind(function(){n.trigger("lightbox:close","broadcastEndConfirm"),i.end(_.extend(t,{skipConfirm:!0}))},this)}})}else this.sendToRemora({action:"destroyQueue"}),this.set("ownerSubscribed",!1),r.model.get("user").leaveBroadcast(!0),_.isFunction(t.onEnd)&&t.onEnd()},getDetailsForFeeds:function(){return{ArtistID:this.get("ArtistID"),UserID:this.get("UserID"),BroadcastID:this.get("BroadcastID"),Name:this.get("Name"),Tag:this.get("Tag"),Description:this.get("Description")}},cleanupSuggestionsCache:function(){var e=this.get("suggestions");if(!e)return;var t={};e.each(function(e){t[e.id]=e}),this.set("cachedBroadcastSuggestions",t)},handleSuggestionsChanges:function(e,t){var r=t||{},i=this.get("suggestions");if(!i){console.error("no suggestions but handleSuggestionsChanges called");return}var s=this.get("cachedBroadcastSuggestions"),o=this.get("listeners"),u=[],a=!1,f,l,c,h,p,d;for(var v=0,m=e.length;v<m;v++){f=e[v];if(i.lastChangeID>=f.id)continue;f.s=_.toInt(f.s),f.b&&f.bl!==0&&u.push(f.s),d=null,l=i.get(f.s),f.u=_.toInt(f.u);if(!f.a)l&&(f.u?(h=_.indexOf(l.attributes.upVotes,f.u),h>-1&&(l.attributes.upVotes.splice(h,1),l.attributes.upVoteCount--),f.no?p=f.no:p=l.attributes.upVotes[0],d=o&&o.get(p),!d&&f.od&&!f.od.r&&(d=new n.Models.TinyUser(f.od)),l.set("suggester",d),l.trigger("change",this,{}),l.trigger("change:upVotes",l,l.attributes.upVotes,{}),this.handleSuggestionsAction({songID:f.s,type:4,userID:f.u},r),l.attributes.upVotes.length||i.remove(l,{silent:!0})):i.remove(l,{silent:!0}));else if(l)_.indexOf(l.attributes.upVotes,f.u)==-1&&(l.attributes.upVotes.push(f.u),l.attributes.upVoteCount++,l.trigger("change",l,{}),l.trigger("change:upVotes",l,l.attributes.upVotes,{}),this.handleSuggestionsAction({songID:f.s,type:0,userID:f.u},r));else{if(!f.song){console.log("add suggestion no song",f);continue}p=f.no||f.u,d=o&&o.get(p),l=new n.Models.BroadcastSuggestion(f.song,{dontCache:!0,suggester:d}),i.add(l,{silent:!0}),s[f.s]=l,this.handleSuggestionsAction({songID:f.s,type:2,userID:f.u},r)}i.lastChangeID=f.id,a=!0}a&&i.sort()},handleSuggestionsAction:function(e,t){var i=t||{},s=r.model.get("player").get("queue");if(!e||this.get("activeStatus")!==1){console.log("Ignoring handleSuggestionsAction for broadcast that isn't active",e);return}var o=this.get("suggestions"),u=n.Models.Song.getCached(e.songID),a=n.getLoggedInUserID(),f=_.toInt(e.userID),l=e.userData,c=f==a,h=this.attributes.cachedBroadcastSuggestions[e.songID],p=o&&o.get(e.songID),d=this.get("listeners"),v;switch(e.type){case-1:h&&h.get("suggester")&&h.get("suggester").id===a&&n.trigger("notification:add",{type:"error",description:_.getString("POPUP_BROADCAST_SUGGESTION_REJECTED",{song:h.escape("SongName")}),url:this.toUrl(),duration:5e3}),p&&p.set("approvalStatus",-1),o&&o.remove(p||h||e.blockedSong&&e.blockedSong.SongID);break;case 0:h&&(c?h.set("userVote",1):h.get("suggester")&&h.get("suggester").id===a&&n.trigger("notification:add",{icon:"thumbsup",type:"success",description:_.getString("POPUP_BROADCAST_SUGGESTION_VOTED",{song:h.escape("SongName")}),url:this.toUrl(),duration:5e3}));break;case 4:h&&c&&h.set("userVote",0);break;case 1:h?e.approvedSong&&n.Models.Song.replaceCacheAttributes(h._wrapped,e.approvedSong):(h=u,h?e.approvedSong&&n.Models.Song.replaceCacheAttributes(h,e.approvedSong):h=n.Models.Song.newOrUpdate(e.approvedSong,{dontCache:!0})),(p||h)&&this.suggestionApproved(p||h,f,i);break;case 2:if(h){c&&(i.initialChanges!==!0&&n.trigger("notification:add",{type:"success",description:_.getString("POPUP_BROADCAST_SUGGESTION_ADDED",{song:h.escape("SongName")}),url:this.toUrl(),duration:5e3}),h.set("userVote",1)),l&&l.z?v=new n.Models.TinyUser(l):v=d&&d.get(f)||n.Models.User.getCached(f);if(v){this.suggestionAdded(h,v,i);var m=r.page.getCurrentPageView();(!m||!m.broadcastView||m.broadcastView.model.get("broadcast")!==this)&&!c&&n.trigger("broadcast:notifEvent",this)}else console.log("missing user from suggestion",e.userID)}break;case 3:case 7:if(c){var g=e.type==3?"POPUP_BROADCAST_SUGGESTION_REJECTED_PLAYED":"POPUP_BROADCAST_SUGGESTION_REJECTED_PLAY_LATER";n.trigger("notification:add",{description:_.getString(g),type:"error",url:this.toUrl(),duration:5e3})}break;case 6:c&&n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_REJECTED_FULL"),type:"error",url:this.toUrl(),duration:5e3});break;case 8:c&&n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_REJECTED_PERCENT_FULL"),type:"error",url:this.toUrl(),duration:5e3})}},handleAddedToHistory:function(e){if(!e)return;var t=this.get("history"),n=this.getOwner(),r=e.queueSongID,i=this.get("host"),s=i?i.get("songs"):null,o;t.add(e,{at:0}),n&&e.broadcastListens&&n.incrementEstimatedListens(e.broadcastListens),s&&(o=s.get(r),o&&o.set("broadcastPlayed",!0))},handleActiveSongVote:function(e,t,r){if(!e||!r)return;var i=this.get("activeSong");i&&i.get("queueSongID")===e&&(t>0?i.addUpVote(r):t<0?i.addDownVote(r):(i.removeUpVote(r),i.removeDownVote(r)),i.trigger("change"),r==n.getLoggedInUserID()&&i.set("userVote",t),this.activeVotesChanged())},handleSuggestionVote:function(e,t,n){var r=this.get("suggestions"),i=r?r.get(e):null,s;i&&(t>0?i.addUpVote(n):t<=0&&(i.removeUpVote(n),s=i.get("upVotes"),(!s||!s.length)&&r.remove(i)))},handleVIPRequestResponse:function(e){if(!this.isLoggedInUserOwner()&&!this.isUserVIP(n.getLoggedInUserID()))return;var t=this.get("listeners"),r=e.sender&&t&&t.get(e.sender.userID)||n.Models.User.getCached(e.sender.userID),i=r&&n.getLoggedInUserID()===r.get("UserID"),s,o,u;if(!r||!i&&!this.isLoggedInUserOwner())return;e.song||e.callout?s=new n.Models.Song(n.Models.Song.convertManateeSongCalloutProperties(e.song||e.callout),{dontCache:!0}):e.songID&&(s=n.Models.Song.getCached(e.songID));if(!s)return;e.resultKey.indexOf("addSuggestion")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_APPROVED_2",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_ADDED_BY_VIP}:e.resultKey.indexOf("addSongEx")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_APPROVED_2",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_ADDED_BY_VIP}:e.resultKey.indexOf("approveSuggestion")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_APPROVED_2",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_ADDED_BY_VIP}:e.resultKey.indexOf("rejectSuggestion")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_REJECTED_2",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_REJECTED_BY_VIP}:e.resultKey.indexOf("addCallout")>=0&&(i?o={description:_.getString("VIP_POPUP_CALLOUT_ADDED_QUEUE_2")}:u={infoType:n.Models.ChatActivity.CALLOUT_ADDED_BY_VIP}),o&&n.trigger("notification:add",_.defaults(o,{icon:"musicnote",type:"success"})),u&&this.newChatActivity(new n.Models.ChatActivity(_.defaults(u,{type:"info",song:s,user:r})))},onMainAttrChange:function(e){e.changed.Name&&n.trigger("guts:log","broadcastNameChanged",{newName:e.changed.Name,broadcastID:e.get("BroadcastID")}),e.changed.Description&&n.trigger("guts:log","broadcastDescriptionChanged",{newText:e.changed.Description,broadcastID:e.get("BroadcastID")}),e.changed.Tag&&n.trigger("guts:log","broadcastDescriptionChanged",{newTagID:e.changed.Tag.i,broadcastID:e.get("BroadcastID")})},subControlChannelIfNeeded:function(){var e=this.get("controlChannel"),t=this.get("controlMonitor"),i=this.get("controlMonitorListening"),s=r.model.get("manatee"),o=this.isLoggedInUserOwner()||this.isUserVIP(n.getLoggedInUserID()),u;if(t&&(!o||!e)){t.stop(),this.unset({controlMonitor:!0,controlMonitorListening:!0});return}!t&&s&&o&&e&&(u=s.subscribeToChannels([e]),t=u.subscriptions[0],this.set("controlMonitor",t)),t&&!i&&(this.set("controlMonitorListening",t),t.listen(_.bind(this.onControlChannelData,this)))},onControlChannelChange:function(e){var t=this.get("controlMonitor"),n=r.model.get("manatee");t&&(t.stop(),this.unset({controlMonitor:!0,controlMonitorListening:!0})),this.subControlChannelIfNeeded()},onControlChannelData:function(e,t,i){if(!t||!i)return;var s=this.isLoggedInUserOwner(),o=this.get("host"),u=r.model.get("manatee"),a=r.model.get("player"),f,l,c,h,p;if(!u||i.uid===u.uuid)return;(t.action||t.response&&!t.response.pong)&&console.log("broadcast got data on controlChannel",this,t.action,arguments);if(t.blackbox&&t.blackbox.getFullQueue&&i.sudo)t.response.requester&&t.response.requester===u.getPublicUID()&&this.getFullQueueDfd&&(t.response&&t.response.songs?this.getFullQueueDfd.resolve(t.response.songs,t.response):this.getFullQueueDfd.reject(t));else if(t.action==="queueUpdate"&&i.sudo)this.handleQueueUpdate(t);else if(t.action==="queueReset"&&i.sudo)this.handleQueueReset(t);else if(t.action==="takeover"&&t.uuid)s&&t.uuid!=u.getPublicUID()&&n.trigger("notification:add",{title:_.getString("POPUP_ERROR_BROADCAST_RESUMED_2"),icon:"broadcast"});else if(t.action==="complianceIssue"&&s)this.handleComplianceIssue(t);else if(t.action==="nextSongFailed"&&s)t.action&&(p=new n.Models.BroadcastSong(t.song,{dontCache:!0}),n.trigger("notification:add",{title:_.getString("POPUP_ERROR_BROADCAST_NEXT_SONG_FAIL",{song:p.get("SongName"),artist:p.get("ArtistName")}),icon:"broadcast",duration:5e3}));else if(t.action==="pendingDestruction"&&i.sudo&&s){h=this.get("host");if(!h)return;c=h.get("activeSong"),f=function(){n.trigger("lightbox:close")},l=function(){a.playStatusIsPlaying(!0)&&n.trigger("lightbox:close")},this.listenToOnce(h,"change:activeSong",f),c&&this.listenToOnce(c,"change:playStatus",l),n.trigger("lightbox:open","generic",{_type:"destroyBroadcast",view:{headerHTML:_.getString("BROADCAST_DESTRUCTION_NOTICE_TITLE"),messageHTML:_.getString("BROADCAST_DESTRUCTION_NOTICE_MESSAGE"),buttonsRight:[{className:"btn-success confirm",label:"GOT_IT"}]},onDestroy:_.bind(function(){this.stopListening(h,"change:activeSong",f),c&&this.stopListening(c,"change:playStatus",l)},this),callbacks:{".confirm":function(){n.trigger("lightbox:close")}}})}},handleComplianceIssue:function(e){if(!e)return;var t=this.get("host"),i=t&&t.get("activeSong"),s=e.reason,o=e.playOptions||{},u=e.song?n.Models.Song.newOrUpdate(e.song):null;switch(e.issue){case"nextSongNonCompliant":if(this.get("alwaysStayCompliant")){this.skipToNextCompliantSong();break}n.trigger("lightbox:open","broadcastNonCompliant",{reason:s,broadcast:this,queueSongID:e.song&&e.song.queueSongID,playerModel:r.model.get("player")});break;case"requestedSongNonCompliant":o.fromUserNext?n.trigger("lightbox:open","broadcastNonCompliant",{reason:s,skipImmediate:!0,broadcast:this,queueSongID:e.song&&e.song.queueSongID}):n.trigger("lightbox:open","previewSong",{songs:[u],nonComplianceError:s,broadcast:this,playerModel:r.model.get("player")});break;case"complianceModeOn":n.trigger("notification:add",{type:"success",description:_.getString("POPUP_BROADCAST_COMPLIANCE_ON"),duration:1e4})}},disableMobileCompliance:function(){if(!this.isLoggedInUserOwner())return;this.sendToRemora({action:"disableMobileCompliance"})},skipToNextCompliantSong:function(e,t){if(!this.isLoggedInUserOwner())return;this.sendToRemora({action:"skipToNextCompliantSong",immediate:!!e}),typeof t!="undefined"&&this.set("alwaysStayCompliant",t)},refreshQueueAfterUpdateFail:function(e){var t=r.model.get("user"),i=this.get("host")||e;if(!i||this.getFullQueueDfd&&this.getFullQueueDfd.state()==="pending")return;L++;if(L>3){n.trigger("notification:add",{description:_.getString("BCAST_QUEUE_FAILED_CONSECTUTIVELY"),type:"error",duration:0}),t.leaveBroadcast(!0);return}i.setSyncing(!0),this.getFullQueue().done(_.bind(function(e,t){i.resetSongsFromRemoraFullQueue(t),this.set("isOutOfSync",!1)},this)).fail(_.bind(function(){L++,this.refreshQueueAfterUpdateFail()},this)).always(function(){i.setSyncing(!1)})},handleQueueReset:function(e,t){var n=this.get("host");if(!n)return;n.handleRemoraQueueReset(e,t,{broadcastID:this.get("broadcastID")})&&(L=0)},handleQueueUpdate:function(e){var t=this.get("host");if(!t)return;t.handleRemoraQueueUpdate(e,{broadcastID:this.get("broadcastID")})&&(L=0)},onQueueOutOfSync:function(){if(!this.get("host"))return;this.refreshQueueAfterUpdateFail()},getLoggedInListenerCount:function(){var e=this.get("listeners");return e&&e.length||0},getLoggedOutListenerCount:function(){var e=this.get("listenersCount")||0;return Math.max(e-this.getLoggedInListenerCount(),0)},handleSongCached:function(e,t){var n=this.get("activeSong"),r=this.get("nextSong"),i=this.get("history"),s=this.get("suggestions"),o=this.get("chatActivities");n&&n.get("SongID")==e&&n.replaceWrapped(t),r&&r.get("SongID")==e&&r.replaceWrapped(t),i&&i.length&&i.replaceWrappedModelByID(t),s&&s.length&&s.get(e)&&s.replaceWrappedModelByID(t);if(o){var u;for(var a=0,f=o.length;a<f;a++)u=o.at(a),u&&(u.attributes.song||u.attributes.songs)&&u.replaceSong(t)}},handleUserCached:function(e,t){var r=this.get("listeners"),i=this.get("chatActivities"),s=this.get("ownerModel");r&&r.length&&r.replaceModelByID(t);if(i){var o;for(var u=0,a=i.length;u<a;u++)o=i.at(u),o&&(o.attributes.user||o.attributes.users)&&o.replaceUser(t)}s instanceof n.Models.User&&s.id==e&&this.set("ownerModel",t)},play:function(e){var t=e||{};return t.context=t.context||new n.Models.PlayContext(this),this.getHistory().done(_.bind(function(e){n.trigger("player:addSongsEx",e,t)},this))}},{artPath:"/static/broadcasts/",pageArtPath:"default/cover/broadcast.png",pageArtRetinaPath:"default/cover/retina/broadcast.png",coverArtPath:"/static/broadcastcovers/",promoArtPath:"/static/broadcastpromos/",cachedListenerCounts:{},broadcastIDToTags:{},broadcastsByTagsDeferreds:{},broadcastsDeferreds:{},pendingChannelSubsDfds:{},CHAT_SERVER_PREFIX:"bcast:",CHAT_SERVER_PREFIX_PUBLIC:"bcast:p:",CLIENT_VERSION:1.2,VIP_PERM_AUTO_APPROVE:1,VIP_PERM_SUGGESTIONS:2,VIP_PERM_CHAT_MODERATE:4,VIP_PERM_METADATA:8,VIP_PERM_FEATURES:16,VIP_PERM_CALLOUTS:32,VIP_PERM_PLAY_NEXT:64,VIP_PERM_ADMIN:-1,VIP_DEFAULT_PERMS:0,VIP_PERMISSIONS:[],MAX_LISTENER_DRIFT:1e4,LARGE_THRESHOLD:49,PREVENT_NEXT_POSITION:3e4,OWNER_IDLE_TIME:6e5,get:function(e,t){var r=$.Deferred();return this._cache&&this._cache.hasOwnProperty(e)?r.resolve(this._cache[e]):n.Services.API.getBroadcast(e,!0).done(function(e){if(e&&e.BroadcastID){e.Songs||(e.Songs=[]);var i=n.Models.Broadcast.newOrUpdate(e,$.extend({source:"db"},t));r.resolve(i)}else r.reject(e)}).fail(function(e){r.reject(e)}),r.promise()},getLatestIncrementedCached:function(e){return e===null||e===t||!this._cache?null:C[e]&&this._cache.hasOwnProperty(C[e])?this._cache[C[e]]:this._cache.hasOwnProperty(e)?this._cache[e]:null},getBroadcastInfo:function(e){var t=["s","h","owners","n","t","owner_subscribed","i","d","tl","py","qc","x"],n=r.model.get("manatee"),i=o(e),s=A.CHAT_SERVER_PREFIX+i,u=$.Deferred();return!e||!n?(u.reject({}),u):(n.getChannelKeys(s,t).done(function(n){var r=n&&n["return"]&&n["return"].values;if(!r){u.reject(n);return}m(e,t,r,u)}),u)},getBroadcastListeners:function(e,t){var i=r.model.get("manatee"),s=o(e),u=A.CHAT_SERVER_PREFIX+s,a=this.pendingChannelSubsDfds,f=$.Deferred();return!e||!s||!i?(f.reject({}),f):a[s]?a[s]:(a[s]=f,i.getChannelSubscribers(u).done(function(r){var i=r&&r.sub_list_with_extra,o=0,u=[],l={},c,h,p,d,v;if(!i){f.reject(r);return}for(c=0,h=i.length;c<h;c++){p=i[c],d=_.toInt(p&&p.id&&p.id.userid);if(p&&p.id&&p.id.sudo)continue;o++,v=p.id.app_data&&p.id.app_data.z?p.id.app_data:p.extra;if(!d||l[d]||!v||v.r)continue;v.u=d,u.push(v),l[d]=1}t||(t=n.Models.Broadcast.getLatestIncrementedCached(e)),t?(t.setListeners(u),t.set("listenersCount",o)):n.Models.Broadcast.storeListenersInCache(e,u,o),a[s]=null,f.resolve(u,o)}),f)},getBroadcastListenerCount:function(e,t){var i=r.model.get("manatee"),s=o(e),u=A.CHAT_SERVER_PREFIX+s,a=this.pendingChannelSubsDfds,f=$.Deferred();return!e||!s||!i?(f.reject({}),f):a[s]?(a[s].done(function(e,t){f.resolve(t)}).fail(_.bind(f.reject,f)),f.promise()):(i.getChannelSubscriberCount(u).done(function(r){if(_.notDefined(r.sub_count)){f.reject(r);return}t||(t=n.Models.Broadcast.getLatestIncrementedCached(e)),t?t.updateListenersCount(r.sub_count):n.Models.Broadcast.storeListenersInCache(e,null,r.sub_count),f.resolve(r.sub_count)}),f)},extractBroadcastIDFromChannel:s,subscribeToBroadcastsStatuses:function(e,t,i){var u=r.model.get("manatee"),a=t,f=[],l=i||A.CHAT_SERVER_PREFIX,c=$.Deferred(),p,d,v,g,y;if(!e||!e.length||!u)return[];for(p=0,d=e.length;p<d;p++)f.push(l+o(e[p]));if(!a||!a.length)a=["s","h","owners","n","t","owner_subscribed","i","d","tl","v","pndOwner","py","tags","qc","idSuffix","urls","pi","p","x","cp"],y=0;g=_.indexOf(a,"idSuffix"),g===-1&&(a.push("idSuffix"),g=a.length-1);var b=u.monitorChannelsKeys(f,a),w=b.monitors;return b.command.done(function(e){var t=e&&e.success,r=[],i,u,h;if(!t||!t.length){c.reject(e);return}for(var p=0,d=t.length;p<d;p++){u=t[p].sub;if(!u||!_.contains(f,u))continue;h=s(u);if(t[p].values){t[p].values[g]&&typeof t[p].values[g]=="string"&&(h+=":"+t[p].values[g]);if(t[p].values[y]&&t[p].values[y].error)continue}if(u.indexOf(A.CHAT_SERVER_PREFIX_PUBLIC)==-1||n.Models.Broadcast.getCached(h))i=m(h,a,t[p].values,null,l===A.CHAT_SERVER_PREFIX_PUBLIC),i instanceof A&&(r.push(i),A.broadcastsDeferreds[i.id]&&A.broadcastsDeferreds[i.id].resolve(i,i.id),v=o(i.id),A.broadcastsDeferreds[v]&&A.broadcastsDeferreds[v].resolve(i,v))}c.resolve(r)}),_.each(w,function(e){e.listen(h)}),{monitors:w,dfd:c}},monitorBroadcastChatKeys:function(e){var t=A.getLatestIncrementedCached(e),n=t&&t.get("chatMonitor"),r=$.Deferred(),i;return n&&n.getKeys().length?{newMonitor:!1,monitor:n,dfd:r.resolve(t)}:(i=A.subscribeToBroadcastsStatuses([e],["c","banned","sge","sg","sgc","vp"],A.CHAT_SERVER_PREFIX_PUBLIC),n=i&&i.monitors[0],i.dfd.done(function(t){var n=!1;_.each(t,function(i){return o(i.id)===o(e)&&(r.resolve(t[0]),n=!0),!n}),n||r.reject(t)}),{newMonitor:!0,monitor:n,dfd:r})},monitorBroadcastKeys:function(e){var t=A.getLatestIncrementedCached(e),n=t&&t.get("monitor"),r=$.Deferred(),i;return n&&n.getKeys().length&&n.dfd?{newMonitor:!1,monitor:n,dfd:n.dfd}:(i=A.subscribeToBroadcastsStatuses([e]),n=i&&i.monitors[0],n.dfd=r,i.dfd.done(function(t){var i=!1;_.each(t,function(n){return o(n.id)===o(e)&&(r.resolve(t[0]),i=!0),!i}),i||r.reject(t),delete n.dfd}),{newMonitor:!0,monitor:n,dfd:r})},subscribeToBroadcast:function(e){var t=r.model.get("manatee"),n=this.getLatestIncrementedCached(e),i=n&&n.get("subscription"),u=$.Deferred(),a=o(e),f=A.CHAT_SERVER_PREFIX+a,l={sub:f,overwrite_params:!1,create_when_dne:!1},c,h;return!e||!t?{newSubscription:!1,subscription:{},dfd:$.Deferred().reject()}:i&&i.getState()?{newSubscription:!1,subscription:i,dfd:u.resolve(n)}:(c=t.subscribeToChannels([l]),h=c.subscriptions||[],c.command.done(function(t){var n=t&&t.success,r,i,a;if(!n||!n.length){u.reject(t);return}for(var f=0,l=n.length;f<l;f++)r=n[f].sub,i=r&&s(r),o(i)===o(e)&&(a=A.getLatestIncrementedCached(e),a.updateFromManatee(n[f].params));u.resolve(a)}),_.each(h,function(e){e.listen(p)}),i=h[0]||null,n&&i&&n.set("subscription",i),{newSubscription:!0,subscription:i,dfd:u})},subscribeToBroadcastChat:function(e){var n=r.model.get("manatee"),i=this.getLatestIncrementedCached(e),u=i&&i.get("publicChannelSubscription"),a=$.Deferred(),f=o(e),l=A.CHAT_SERVER_PREFIX_PUBLIC+f,c={sub:l,overwrite_params:!1,create_when_dne:!1},h,p;return!e||!n?{newSubscription:!1,subscription:{},dfd:$.Deferred().reject()}:u&&u.getState()?{newSubscription:!1,subscription:u,dfd:a.resolve(i)}:(h=n.subscribeToChannels([c]),h.command.done(function(n){var r=n&&n.success,i,u,f;if(!r||!r.length){a.reject(n);return}for(var l=0,c=r.length;l<c;l++)i=r[l].sub,u=i&&s(i),o(u)===o(e)&&(f=A.getLatestIncrementedCached(e),f&&(f.updateFromManatee(r[l].params,!0),r[l].latest_messages===t&&r[l].params&&r[l].params.store_latest===!0&&(r[l].latest_messages=[]),f.updateLatestMessages(r[l].latest_messages)));a.resolve(f)}),p=h.subscriptions,_.each(p,function(e){e.listen(v)}),u=p[0]||null,i&&u&&i.set("publicChannelSubscription",u),{newSubscription:!0,subscription:u,dfd:a})},fetchRealtimeBroadcast:function(e,t,i,s){var o=n.Models.Broadcast.getCached(e),u=r.model.get("player").get("queue"),a=u?u.get("currentBroadcast"):null,f=Date.now();if(!o||t||a!==o&&(f-o.get("lastUpdated")>3e4||!o.get("listenersLoaded")&&!i)){if(!t&&n.Models.Broadcast.broadcastsDeferreds[e]&&n.Models.Broadcast.broadcastsDeferreds[e].state()==="pending")return s&&(y(),A.subscribeToBroadcastsStatuses([e])),n.Models.Broadcast.broadcastsDeferreds[e].promise();var l;if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred();l=n.Models.Broadcast.broadcastsDeferreds[e],s?A.subscribeToBroadcastsStatuses([e]):A.getBroadcastInfo(e).done(function(e){l.resolve(e)}),i?A.getBroadcastListenerCount(e):(o&&o.set("listenersLoaded",!1),A.getBroadcastListeners(e)),l.timeout&&(clearTimeout(l.timeout),l.timeout=null),l.timeout=setTimeout(function(){l.reject()},7e3),l.always(function(){l.timeout&&(clearTimeout(l.timeout),l.timeout=null)}),y()}else{if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred(),n.Models.Broadcast.broadcastsDeferreds[e].resolve(o,e);s&&(y(),A.subscribeToBroadcastsStatuses([e])),n.trigger("manatee:broadcastInfo",o,e,!0)}return n.Models.Broadcast.broadcastsDeferreds[e].promise()},fetchRealtimeBroadcastListeners:function(e){var t=A.getLatestIncrementedCached(e);t&&t.set("listenersLoaded",!1),y()},fetchRealtimeBroadcasts:function(e,t,i,s){var u=[],a=[],f=[],l=[],c=r.model.get("manatee"),h=-1;return t=_.orEqual(t,["s","h","owners","n","t","owner_subscribed","i","d","tl","qc","idSuffix","x","cp"]),h=_.indexOf(t,"idSuffix"),h===-1&&(t.push("idSuffix"),h=t.length-1),_.each(e,function(e){var t=n.Models.Broadcast.getCached(e),r=Date.now();if(!t||i||r-t.get("lastUpdated")>3e4||!t.get("listenersLoaded")){if(!i&&n.Models.Broadcast.broadcastsDeferreds[e]&&n.Models.Broadcast.broadcastsDeferreds[e].state()==="pending"){u.push(n.Models.Broadcast.broadcastsDeferreds[e].promise());return}if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred();a.push(e),f.push(A.CHAT_SERVER_PREFIX+o(e)),c||n.Models.Broadcast.broadcastsDeferreds[e].reject({})}else{if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred(),n.Models.Broadcast.broadcastsDeferreds[e].resolve(t,e);l.push(t),n.trigger("manatee:broadcastInfo",t,e)}u.push(n.Models.Broadcast.broadcastsDeferreds[e].promise())}),l.length&&w(l),a.length&&(y(),c.getChannelsKeys(a,t).done(function(e){var r=e&&e["return"],i,s,o,u;if(!r)return;for(i=0,s=r.length;i<s;i++)o=A.extractBroadcastID(r[i].sub),r[i].values&&r[i].values[h]&&typeof r[i].values[h]=="string"&&(o+=":"+r[i].values[h]),u=n.Models.Broadcast.broadcastsDeferreds[o],m(o,t,r[i].values,u)}).fail(function(){_.each(a,function(e){n.Models.Broadcast.broadcastsDeferreds[e].reject({}),delete n.Models.Broadcast.broadcastsDeferreds[e]})})),s?u:$.after(u)},recentSort:function(e,t){return _.orEqual(t.get("TSCreated"),0)-_.orEqual(e.get("TSCreated"),0)},storeListenersInCache:function(e,t,r){var i=n.Models.Broadcast.cachedListenerCounts[e];i?(t&&(i.users=t),r&&(i.count=r)):n.Models.Broadcast.cachedListenerCounts[e]={users:t,count:r}},restoreListenersFromCache:function(e){var t=e.id;if(e.get("listenersLoaded")){delete n.Models.Broadcast.cachedListenerCounts[t];return}var r=n.Models.Broadcast.cachedListenerCounts[t];if(!r){var i=t.split(":");if(i.length!=2)return;t=i[0],r=n.Models.Broadcast.cachedListenerCounts[t];if(!r)return}r.users&&e.setListeners(r.users),r.count&&e.set("listenersCount",r.count),delete n.Models.Broadcast.cachedListenerCounts[t]},cleanupDataFromMemcache:function(e){var t=e.id||s(e.sub),r,i;e.users&&e.users.length&&(i=n.Models.User.newOrUpdate(e.users[0],{dontCache:!0})),e.artists&&e.artists.length&&(r=n.Models.Artist.newOrUpdate(e.artists[0],{dontCache:!0}));var o=n.Models.Song.convertManateeSongCalloutProperties(e.s&&e.s.active);return o&&(o.broadcastSongID=[t,":",o.queueSongID].join(""),o.isActiveSong=!0,o=new n.Models.BroadcastSong(o,{dontCache:!0})),{BroadcastID:t,Name:e.n,Tag:e.t,isPlaying:e.py,Image:e.i,ownerUserIDs:e.ownerUserIDs,ownerArtistID:e.ownerArtistID,ownerSubscribed:e.owner_subscribed,listenersCount:e.subscribers_count,ownerUser:i,ownerArtist:r,tallies:e.tallies||{old_tallies:{},new_tallies:{}},activeSong:o}},getTopBroadcastsForTags:function(e){var t=$.Deferred(),r=n.Services.API.getTopBroadcasts(e);return r.done(function(e){var r={};_.each(e,function(e,t){var i=[],s=Date.now()+A.clientTimeDivergence;_.each(e,function(e){if(e.s&&e.s.ts&&e.s.ts+72e4<s){console.log("rejected bcast too old",e);return}if(!e.sub)return;i.push(n.Models.Broadcast.cleanupDataFromMemcache(e))}),r[t]=i}),t.resolve(r)}),t},getTopBroadcastsCombined:function(e){var t=$.Deferred(),r=n.Services.API.getTopBroadcastsCombinedEx(e||!1);return r.done(function(e){var r=[],i=[],s=Date.now()+A.clientTimeDivergence;_.each(e.all,function(e){if(e.s&&e.s.ts&&e.s.ts+72e4<s)return;if(!e.sub)return;r.push(n.Models.Broadcast.cleanupDataFromMemcache(e))}),_.each(e.events,function(e){if(!e.EventID)return;i.push(e)}),t.resolve(r,i)}),t},getBroadcastImageURL:function(e,t){return _.getImageURL(n.Models.Broadcast.artPath+t+"_"+e)},convertManateeProperties:function(e){return e?{BroadcastID:e.bID,Name:e.n,ArtistID:e.aID,UserID:e.uID,Tag:e.t,Description:e.d,Privacy:e.pr,Image:e.i,ParentBroadcastID:e.pbID,IsRandomName:e.ir,Subscribers:e.s,PeakSubscribers:e.ps,TSCreated:e.ts}:t},convertManateeRealProperties:function(e){if(!e)return t;var r=e.owners,i=A.convertManateeStatusProperties(e.s),s=A.convertManateeHistoryProperties(e.h),o,u,a,f,l,c;if(e.owners){u=[];for(a=0,f=e.owners.length;a<f;a++)u.push(_.toInt(e.owners[a].name));r={users:u}}r&&r.users&&r.users.length&&(l=r.users,o=l[0]),c={Name:e.n,Tag:e.t,Image:e.i,Description:e.d,status:i,PlayData:i&&i.votes,history:s,UserID:o,ownerUserIDs:l,ownerUser:o?n.Models.User.getCached(o):t,ownerAvailable:i&&i.ownerAvailable||"offline",owners:r,ownerSubscribed:e.owner_subscribed,isSuspended:e.x&&!e.x.error},typeof e.qc=="string"&&(c.controlChannel=e.qc),e.urls&&!e.urls.error&&(c.URLs=e.urls);if(e.pi&&!e.pi.error||e.pi===null)c.PromoImage=e.pi||null;if(e.cp&&!e.cp.error||e.cp===null)e.cp?(c.CoverPhoto=e.cp.photo||"",c.CoverPhotoY=e.cp.y||0,c.StockCoverPhoto=e.cp.stock||0):(c.CoverPhoto="",c.CoverPhotoY=0,c.StockCoverPhoto=0);return i&&i.activeSong&&(c.activeStatus=1),e.p!=null&&typeof e.p!="object"?c.Privacy=_.toInt(e.p):_.isArray(e.tags)&&(e.tags.length==0?c.Privacy=1:c.Privacy=0),c.Tag&&!c.Tag.i&&(c.Tag=null),_.omit(c,function(e){return e===t})},convertManateeChatProperties:function(e){var r=e.sg,i,s,o,u,a,f,l,c,h,p,d,v;if(r){s={},i=[];if(r.s)for(u in r.s)r.s.hasOwnProperty(u)&&(a=r.s[u],f=n.Models.Song.convertManateeSongCalloutProperties(a.s),f&&(s[f.SongID]={song:f,users:a.u,ownerData:a.o}));r.b&&(i=_.toArray(r.b))}if(e.vp){l=[];for(p=0,d=e.vp.length;p<d;p++){if(e.vp[p].p==null)continue;h={UserID:_.toInt(e.vp[p].u),permissions:_.toInt(e.vp[p].p)},e.vp[p].d?(h.FName=e.vp[p].d.n,h.Picture=e.vp[p].d.p,h.IsPremium=_.toInt(e.vp[p].d.y),h.metadataChecksum=e.vp[p].d.z):h.noMetadata=!0,l.push(h)}}if(e.banned){c=[];for(p=0,d=e.banned.length;p<d;p++)e.banned[p].type==="userid"&&e.banned[p].app_data&&(h=e.banned[p].app_data,h.UserID=_.toInt(e.banned[p].name),c.push(h))}return o={chatEnabled:e.c,suggestionsEnabled:e.sge,suggestionsChanges:e.sgc,suggestions:s,blockedSuggestionSongIDs:i,bannedUsers:c,broadcasterVersion:e.v,vipUsers:l},_.omit(o,function(e){return e===t})},convertManateeStatusProperties:function(e){if(!e)return t;var r=null,i=null;return e.active&&e.active.b&&(r=n.Models.Song.convertManateeSongCalloutProperties(e.active)),e.next&&e.next.b&&(i=n.Models.Song.convertManateeSongCalloutProperties(e.next)),{heartbeaterID:e.i,pacemaker:e.pm,status:e.status,activeSong:r,activeSongPosition:e.pos,activeSongVotes:e.votes,activeSongStatus:e.status,nextSong:i,timestamp:e.ts,ownerAvailable:e.ownerAvailable,remora:e.remora}},convertManateeHistoryProperties:function(e){if(!e||e==="key_dne")return t;var r=[],i=e.s||e;return i&&!i.error&&_.each(i,function(e){var t=n.Models.Song.convertManateeSongCalloutProperties(e);t.broadcastSongID=e.broadcastSongID,r.push(t)}),{songs:r}},storeBroadcastNotFound:function(e){N[e]=1,n.Models.Broadcast.broadcastsDeferreds[e]&&n.Models.Broadcast.broadcastsDeferreds[e].reject()}});n.Models.Broadcast.VIP_DEFAULT_PERMS=n.Models.Broadcast.VIP_PERM_AUTO_APPROVE|n.Models.Broadcast.VIP_PERM_SUGGESTIONS|n.Models.Broadcast.VIP_PERM_CHAT_MODERATE|n.Models.Broadcast.VIP_PERM_METADATA|n.Models.Broadcast.VIP_PERM_FEATURES|n.Models.Broadcast.VIP_PERM_CALLOUTS,n.Models.Broadcast.VIP_PERMISSIONS=[{locale:"VIP_MENU_PERM_CHAT_MODERATE",flag:n.Models.Broadcast.VIP_PERM_CHAT_MODERATE},{locale:"VIP_MENU_PERM_FEATURES",flag:n.Models.Broadcast.VIP_PERM_FEATURES},{locale:"VIP_MENU_PERM_SUGGESTIONS",flag:n.Models.Broadcast.VIP_PERM_SUGGESTIONS},{locale:"VIP_MENU_PERM_ADD_SONGS_END_OF_QUEUE",flag:n.Models.Broadcast.VIP_PERM_AUTO_APPROVE},{locale:"VIP_MENU_PERM_CALLOUTS",flag:n.Models.Broadcast.VIP_PERM_CALLOUTS},{locale:"VIP_MENU_PERM_PLAY_NEXT",flag:n.Models.Broadcast.VIP_PERM_PLAY_NEXT}]}(),function(){n.Models=n.Models||{};var e=1,t=Math.pow(10,12);n.Models.ChatActivity=Backbone.Model.extend({idAttribute:"ChatActivityID",parse:function(r,i){if(i&&i.skipParse)return r;var s={ChatActivityID:e++,message:r.message||r.data,ignoreTag:r.ignoreTag||!1,playingSongID:r.playingSongID,type:r.type||"message",infoType:r.infoType,user:r.user||r.sender,users:r.users,song:r.song,closeable:r.closeable||!1,isInitialMessage:r.isInitialMessage||!1,specialFlag:r.specialFlag};s.type==="chat"&&(s.type="message"),s.timestamp?s.timestamp/t<1&&(s.timestamp*=1e3):s.timestamp=Date.now(),s.type==="message"&&(s.message?(s.messages=[s.message],delete s.message):s.messages=[]),this.messageCache={};switch(s.infoType){case n.Models.ChatActivity.LEFT_BROADCAST:s.iconClass="icon-user";break;case n.Models.ChatActivity.JOINED_BROADCAST:s.iconClass="icon-user";break;case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:s.iconClass="icon-user";break;case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:s.iconClass="icon-user";break;case n.Models.ChatActivity.SUGGESTION_APPROVED:s.iconClass="icon-thumbsup"}if(s.type==="message"&&!s.specialFlag&&s.user&&!s.ignoreTag){var o=s.user.get("UserID");n.Models.Comment.ADMINS[o]?s.specialFlag="admin":n.Models.ChatActivity.DEVTagUserIDs[o]&&(s.specialFlag="gsdev")}return s},merge:function(e){var t=!1,r=this.get("type"),i=null,s,o,u,a,f,l,c,h,p,d,v,m;if(r!=e.get("type"))return!1;if(r==="info"){s=this.get("infoType"),o=e.get("infoType"),u=this.get("users"),a=e.get("users"),f=s!==o;switch(s){case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:if(o===n.Models.ChatActivity.JOINED_BROADCAST||o===n.Models.ChatActivity.LEFT_BROADCAST)if(a.length===1&&u.length===1&&a.at(0)===u.at(0)){i={infoType:o};break}return!1;case n.Models.ChatActivity.SONG_ADDED_BY_VIP:if(!!f||this.get("user")!==e.get("user"))return!1;i={songs:[this.get("song"),e.get("song")],infoType:n.Models.ChatActivity.SONGS_ADDED_BY_VIP,song:null};break;case n.Models.ChatActivity.SONGS_ADDED_BY_VIP:if(!f||o!==n.Models.ChatActivity.SONG_ADDED_BY_VIP||this.get("user")!==e.get("user"))return!1;this.get("songs").push(e.get("song")),i={_update:Date.now()};break;case n.Models.ChatActivity.LEFT_BROADCAST:case n.Models.ChatActivity.JOINED_BROADCAST:if(f){if((o===n.Models.ChatActivity.JOINED_BROADCAST||o===n.Models.ChatActivity.LEFT_BROADCAST)&&a.length===1){var c=a.at(0),g=u.get(c.get("UserID"));if(g&&u.length>1){u.remove(c,{slient:!0}),i={_update:Date.now()},t=!0,o===n.Models.ChatActivity.JOINED_BROADCAST?e.set("infoType",n.Models.ChatActivity.LEFT_JOINED_BROADCAST):e.set("infoType",n.Models.ChatActivity.JOINED_LEFT_BROADCAST);break}if(g){o===n.Models.ChatActivity.JOINED_BROADCAST?i={infoType:n.Models.ChatActivity.LEFT_JOINED_BROADCAST}:i={infoType:n.Models.ChatActivity.JOINED_LEFT_BROADCAST};break}}return!1}u&&u.length<3&&a&&a.length<3&&(u.add(a.models,{at:0}),i={_update:Date.now()});break;default:return!1}}else{l=this.get("user"),c=e.get("user"),h=this.get("messages"),p=e.get("messages"),v=e.get("timestamp")-this.get("timestamp"),d=l&&c&&l.get("UserID")==c.get("UserID"),m=6e4,d&&v<m&&(i={messages:h.concat(p),timestamp:e.get("timestamp")});if(!i)return!1}return this.messageCache&&(this.messageCache={}),i&&this.set(i),t?!1:!0},getText:function(){var e=this.messageCache[r.model.get("locale")],t=this.get("messages"),i="",s,o,u,a;if(e)return e;if(t)return u=this.get("user"),e=_.map(t,_.makeSafeLinks).join("<br/>"),u&&u.get("IsPremium")?_.emojify(e):e;switch(this.get("infoType")){case n.Models.ChatActivity.LEFT_BROADCAST:s=this.get("users").map(function(e){return e.getAnchorTag()}),i=s.join(", "),e=_.getString("CHAT_BROADCAST_LEFT",{users:i});break;case n.Models.ChatActivity.JOINED_BROADCAST:s=this.get("users").map(function(e){return e.getAnchorTag()}),i=s.join(", "),e=_.getString("CHAT_BROADCAST_JOINED",{users:i});break;case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:s=this.get("users").map(function(e){return e.getAnchorTag()}),i=s.join(", "),e=_.getString("CHAT_BROADCAST_JOINED_LEFT",{users:i});break;case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:s=this.get("users").map(function(e){return e.getAnchorTag()}),i=s.join(", "),e=_.getString("CHAT_BROADCAST_LEFT_JOINED",{users:i});break;case n.Models.ChatActivity.SUGGESTION_APPROVED:o=this.get("song"),e=_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:o.getAnchorTag(null,null,"no-title-tooltip"),artist:o.getArtistAnchorTag()});break;case n.Models.ChatActivity.SUGGESTION_ADDED:o=this.get("song"),u=this.get("user"),e=_.getString("USER_SUGGESTED_A_SONG",{user:u.getAnchorTag(null,null,!0),song:_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:o.getAnchorTag(null,null,"no-title-tooltip"),artist:o.getArtistAnchorTag()})});break;case n.Models.ChatActivity.BROADCASTER_BAILED:e=_.getString("CHAT_BROADCASTER_BAILED");break;case n.Models.ChatActivity.BROADCASTER_BACK:e=_.getString("CHAT_BROADCASTER_BACK");break;case n.Models.ChatActivity.WELCOME_MESSAGE:u=this.get("user"),a=u&&u.escape("Name"),e=_.getString("CHAT_WELCOME_MESSAGE",{name:a});break;case n.Models.ChatActivity.CHAT_INVITE_FOLLOWERS:e=_.getString("CHAT_INVITE_FOLLOWERS_2");break;case n.Models.ChatActivity.BROADCASTER_INVITE_FOLLOWERS:e=_.getString("BROADCASTER_INVITE_FOLLOWERS_2");break;case n.Models.ChatActivity.CHAT_DISABLED:e=_.getString("CHAT_DISABLED");break;case n.Models.ChatActivity.CHAT_DISABLED_OWNER:e=_.getString("CHAT_DISABLED_OWNER");break;case n.Models.ChatActivity.CHAT_FAILED:e=_.getString("CHAT_FAILED");break;case n.Models.ChatActivity.RATE_LIMITED:e=_.getString("CHAT_RATE_LIMITED");break;case n.Models.ChatActivity.NEW_BROADCAST_OWNER:u=this.get("user"),e=_.getString("NEW_BROADCASTER_MESSAGE",{user:u&&u.escape("Name")});break;case n.Models.ChatActivity.SONG_CHANGED:o=this.get("song"),o.get("CalloutID")?i="<strong>"+o.get("SongName")+"<strong>":i=o.getAnchorTag(null,null,"no-title-tooltip"),e=_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:i,artist:o.getArtistAnchorTag()});break;case n.Models.ChatActivity.OFFLINE_CANT_CHAT:e=_.getString("CHAT_OFFLINE_CANT_CHAT");break;case n.Models.ChatActivity.VISIBILITY_FRIENDS_WARNING:e=_.getString("CHAT_VISIBILITY_FRIENDS_WARNING");break;case n.Models.ChatActivity.YOU_ARE_VIP:e=_.getString("CHAT_YOU_ARE_VIP");break;case n.Models.ChatActivity.NO_LONGER_VIP:e=_.getString("CHAT_NO_LONGER_VIP");break;case n.Models.ChatActivity.VIP_ADDED:u=this.get("user"),e=_.getString("CHAT_VIP_ADDED",{user:u&&u.escape("Name")});break;case n.Models.ChatActivity.SONG_ADDED_BY_VIP:o=this.get("song"),u=this.get("user"),e=_.getString("VIP_ADDED_A_SONG",{user:u.getAnchorTag(),song:_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:o.getAnchorTag(null,null,"no-title-tooltip"),artist:o.getArtistAnchorTag()})});break;case n.Models.ChatActivity.SONGS_ADDED_BY_VIP:u=this.get("user"),e=_.getString("VIP_ADDED_SONGS",{user:u.getAnchorTag(),num:_.orEqual(this.get("songs"),[]).length});break;case n.Models.ChatActivity.SONG_REJECTED_BY_VIP:o=this.get("song"),u=this.get("user"),e=_.getString("VIP_REJECTED_SONG",{user:u.getAnchorTag(),song:_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:o.getAnchorTag(null,null,"no-title-tooltip"),artist:o.getArtistAnchorTag()})});break;case n.Models.ChatActivity.CALLOUT_ADDED_BY_VIP:o=this.get("song"),u=this.get("user"),e=_.getString("VIP_ADDED_CALLOUT",{user:u.getAnchorTag(),callout:o.escape("SongName")})}return this.messageCache||(this.messageCache={}),this.messageCache[r.model.get("locale")]=e,e},getModelToFavorite:function(e){return e==="User"?this.get("user"):null},getFormattedTimestamp:function(){var e=this.get("timestamp"),t=new Date(e),n=new Date,r=864e5,i,s,o;return n-t>r?_.getFormattedDate(e):(i=t.getHours(),s=t.getMinutes(),i>=12?(i>12&&(i-=12),o="PM"):o="AM",_.format("%s:%s %s",i,_.padLeft(s,2,"0"),o))},replaceUser:function(e){var t=this.get("user");if(t){if(e===t||e.id!=t.id)return;this.set("user",e);return}var n=this.get("users");if(!n)return;n.replaceModelByID(e)},replaceSong:function(e){var t=this.get("song");if(t){if(t instanceof Backbone.MagicModelWrapper){if(e===t._wrapped||e.id!=t._wrapped.id)return;t.replaceWrapped(e)}else{if(e===t||e.id!=t.id)return;this.set("song",e)}return}var n=this.get("songs");if(!n)return;n instanceof Backbone.WrappedModelCollection?n.replaceWrappedModelByID(e):n.replaceModelByID(e)}},{LEFT_BROADCAST:"leftBroadcast",JOINED_BROADCAST:"joinedBroadcast",JOINED_LEFT_BROADCAST:"joinedLeftBroadcast",LEFT_JOINED_BROADCAST:"leftJoinedBroadcast",SUGGESTION_APPROVED:"suggestionApproved",SUGGESTION_ADDED:"suggestionAdded",BROADCASTER_BAILED:"broadcasterBail",BROADCASTER_BACK:"broadcasterBack",WELCOME_MESSAGE:"welcomeMessage",CHAT_INVITE_FOLLOWERS:"inviteUserFollowers",BROADCASTER_INVITE_FOLLOWERS:"inviteBroadcasterFollowers",CHAT_DISABLED:"chatDisabled",CHAT_DISABLED_OWNER:"chatDisabledOwner",RATE_LIMITED:"rateLimited",NEW_BROADCAST_OWNER:"newBroadcastOwner",SONG_CHANGED:"songChange",CHAT_FAILED:"chatFailed",OFFLINE_CANT_CHAT:"offlineCantChat",VISIBILITY_FRIENDS_WARNING:"visibilityFriendsWarning",YOU_ARE_VIP:"youAreVIP",NO_LONGER_VIP:"noLongerVIP",VIP_ADDED:"vipAdded",SONG_ADDED_BY_VIP:"songAddedByVIP",SONGS_ADDED_BY_VIP:"songsAddedByVIP",SONG_REJECTED_BY_VIP:"songRejectedByVIP",CALLOUT_ADDED_BY_VIP:"calloutAddedByVIP",DEVTagUserIDs:{15:1,30:1,42:1,352:1,3879:1,23523:1,253182:1,699759:1,788921:1,889603:1,1386918:1,1781485:1,1971003:1,2376844:1,2585425:1,4098150:1,6836686:1,8819905:1,9112752:1,13968140:1,24732514:1}})}(),function(){n.Models=n.Models||{},n.Models.Callout=Backbone.CachedModel.extend({idAttribute:"CalloutID",parse:function(e,n){if(n&&n.skipParse)return e;var r=e.Name||e.SongName,i=_.toInt(e.UserID||n&&n.user&&n.user.id);return{CalloutID:_.toInt(e.CalloutID),Name:r,SongName:r,UserID:i,FileID:_.defined(e.FileID)?_.toInt(e.FileID):t,Flags:_.defined(e.Flags)?_.toInt(e.Flags):t,EstimateDuration:e.EstimateDuration||_.defined(e.uSecs)?e.uSecs/1e6:t,uploaded:_.defined(e.uploaded)?e.uploaded:!0,transcoded:_.defined(e.transcoded)?e.transcoded:!0,uploadPercent:e.uploadPercent,ArtistName:e.ArtistName||(n&&n.user&&n.user.id==i?n.user.get("Name"):t)}},toUrl:function(){return null},toArtistUrl:function(){var e=this.get("UserID"),t=e&&n.Models.User.getCached(e);return t?t.toUrl():e?_.cleanUrl(this.get("ArtistName"),e,"profile"):null},toAlbumUrl:function(){return null},getToken:function(){},getDetailsForFeeds:function(){return null},toProxyLabel:function(){return _.getString("VAR_NAME",{name:this.escape("Name")})},getAnchorTag:function(){return""},getArtistAnchorTag:function(){var e=this.toArtistUrl();return e?'<a href="'+e+'" class="artist-link">'+_.escape(this.get("ArtistName"))+"</a>":""},getDetailsForSwf:function(){var e=/\u0000/g;return{CalloutID:this.get("CalloutID"),SongID:0,isCallout:!0,SongName:this.get("Name").replace(e,""),AlbumID:0,AlbumName:"",ArtistID:0,UserID:this.get("UserID"),ArtistName:this.get("ArtistName")||"",Flags:this.get("Flags"),EstimateDuration:this.get("EstimateDuration")}},getImageURL:function(e){return e=_.orEqual(e,70),_.getImageURL(n.Models.Callout.artPath+e+"_album.png")},set:function(e,t){return _.isString(e)&&e=="Name"?e={Name:t,SongName:t}:e.hasOwnProperty("Name")&&(e.SongName=e.Name),Backbone.CachedModel.prototype.set.apply(this,_.toArray(arguments))},play:function(e){var t=$.Deferred(),r=n.getCurrentBroadcast(),i=e||{};return this.id>0&&this.get("transcoded")?(i.context=i.context||new n.Models.PlayContext,r&&r.isUserVIP(n.getLoggedInUserID())?r.addVIPCallout(callout):n.trigger("player:addSongsEx",[this],i),t.resolve()):t.reject(),t.promise()},toManateeProperties:n.Models.Song.prototype.toManateeProperties},{artPath:"/static/albums/",uploadCache:{},setupCalloutListeners:function(){n.on("callouts:uploadStarted",this.onUploadStarted,this),n.on("callouts:uploadComplete",this.onUploadComplete,this),n.on("callouts:uploadFailed",this.onUploadFailed,this),n.on("manatee:calloutResponse",this.onTranscodeComplete,this)},onUploadStarted:function(e){var t=r.model.get("user"),n=new this({CalloutID:-1*e.tempID,Name:e.Name,EstimateDuration:_.toInt(e.EstimateDuration),uploaded:!1,uploadPercent:0,transcoded:!1},{user:t});this.uploadCache[n.id]=n,t.getCallouts().done(function(e){n.get("uploadFailed")||e.add(n,{at:0})});var i=setInterval(function(){var e=n.get("uploadPercent");e<40&&!n.get("uploadFailed")?n.set("uploadPercent",e+.33):(n.unset("uploadTimer"),clearTimeout(i))},30);n.set("uploadTimer",i)},onUploadComplete:function(e){var t=-1*e.tempID,r=this.uploadCache[t]||this.getCached(t);r&&(this.uncache(r),delete this.uploadCache[r.id],r.set({uploaded:!0,uploadPercent:75,CalloutID:e.realID}),this.cache(r),this.uploadCache[r.id]=r,n.Services.API.updateCalloutDetails(e.realID,r.get("Name")))},onUploadFailed:function(e){var t=-1*e.tempID,i=this.uploadCache[t]||this.getCached(t),s=r.model.get("user");i&&(this.uncache(i),delete this.uploadCache[i.id],s&&i.get("UserID")==s.get("UserID")&&(i.set("uploadFailed",!0),s.get("callouts")&&s.get("callouts").remove(i),n.trigger("notification:add",{title:_.getString("CALLOUT_UPLOAD_FAILED",{callout:i.escape("Name")}),type:"error"})))},onTranscodeComplete:function(e){if(!e||e.error)return this.onTranscodeFailed(e);var t=e.callout.CalloutID,r=this.uploadCache[t]||this.getCached(t),i=Math.floor(e.callout.uSecs/1e6),s={transcoded:!0};i>0&&(s.EstimateDuration=i),r&&(delete this.uploadCache[t],r.set({uploaded:!0,uploadPercent:100}),setTimeout(function(){r.set(s)},330),r.get("UserID")==n.getLoggedInUserID()&&n.trigger("notification:add",{title:_.getString("CALLOUT_SUCCESS",{callout:r.escape("Name")}),type:"success"}))},onTranscodeFailed:function(e){var t=e.CalloutID,i=this.uploadCache[t]||this.getCached(t),s=r.model.get("user");i&&(this.uncache(i),delete this.uploadCache[t],s&&i.get("UserID")==s.get("UserID")&&(s.get("callouts")&&s.get("callouts").remove(i),n.trigger("notification:add",{title:_.getString("CALLOUT_TRANSCODE_FAILED",{callout:i.escape("Name")}),type:"error"})))},get:function(e){var t=Backbone.CachedModel.genericGet.call(this,n.Services.API.getCallout,"CalloutID",e);return t.promise()}})}(),function(){n.Models=n.Models||{},n.Models.FanUpdate=Backbone.CachedModel.extend({idAttribute:"ArtistIDTimestamp",parse:function(e,t){if(t&&t.skipParse)return e;e.Timestamp=_.toInt(e.Timestamp),e.ArtistID=_.toInt(e.ArtistID);var r=e.ArtistID+"-"+e.Timestamp,i=new Date(e.Timestamp*1e3),s=null;switch(e.AttachmentType){case"artist":case"song":case"album":case"playlist":case"user":s=n.Models[_.ucwords(e.AttachmentType)].newOrUpdate(e.Attachment,{dontCache:!0,skipUpdate:!0});break;case"link":}return{ArtistIDTimestamp:r,ArtistID:_.toInt(e.ArtistID),Timestamp:_.toInt(e.Timestamp),DatePosted:i,Message:e.Message,Location:e.Location,Attachment:s,AttachmentType:e.AttachmentType,CommentCount:_.toInt(e.CommentCount),artist:t&&t.artist||n.Models.Artist.getCached(e.ArtistID)}},getComments:function(){var e=$.Deferred()},toUrl:function(){return""}},{})}(),function(){n.Models=n.Models||{};var e=function(e,t){return e.id<t.id?1:e.id>t.id?-1:0},t=function(e,t){return e.id>t.id?1:e.id<t.id?-1:0},i=function(e,t){return t.attributes.Timestamp-e.attributes.Timestamp},s=function(e,t){return e.id<t.id?1:e.id>t.id?-1:0},o=function(e,t){var r=$.Deferred(),i=0,s,o,u;if(this.length<=0)return r.reject(),r.promise();this.nextPageToLoad==null?(i=1,this.nextPageToLoad=2):(i=this.nextPageToLoad,this.nextPageToLoad++),t&&t.initialPage!=null&&(i+=_.toInt(t.initialPage)),s=_.orEqual(this.loadedTypeID,this.at(0).get("TypeID")),o=_.orEqual(this.loadedItemID,this.at(0).get("ItemID")),u=n.Models.Comment.loadCommentsForItemType(o,s,i,!0).done(function(e,t,n,i){r.resolve(e,i)}).fail(_.bind(r.reject,r));var a=r.promise();return u&&typeof u.abort=="function"&&(a.abort=_.bind(u.abort,u)),a},u=function(e,t,r){var i=$.Deferred(),s=t.user&&t.user.get("isLoggedIn"),o=!1,u,a,f,l,c;switch(t.feedType){case"user":if(t.user){if(!this.lastSharesUserID||this.lastSharesUserID!==t.user.get("UserID"))this.lastSharesUserID=t.user.get("UserID"),this.lastShareAdded=null;u=n.Services.API.feeds3GetUserShares(this.lastSharesUserID,r,this.lastShareAdded).done(_.bind(function(e){if(!e||!e.feedItems){i.reject();return}o=e.feedItems.length==r,c=e.feedItems.length&&e.feedItems[e.feedItems.length-1],this.lastShareAdded=c.tsAdded?c.tsAdded:-1,i.resolve(e.feedItems,o,{metaByType:e.metaByType})},this))}else i.reject();break;case"materialized":!this.materializedTagIDs&&t.tagID&&(this.materializedTagIDs=[t.tagID],a=s),!this.materializedTagIDs&&_.isArray(t.tagIDs)&&(this.materializedTagIDs=t.tagIDs,a=s),!this.materializedLastCursor&&t.materializedLastCursor&&(this.materializedLastCursor=t.materializedLastCursor);if(t.mediaType!=="all")switch(t.mediaType){case"songs":f=["song"];break;case"artists":f=["artist"];break;case"albums":f=["album"];break;case"playlists":f=["playlist"];break;case"broadcasts":f=["broadcast"];break;case"people":f=["user"]}t.groupType==="community"&&(l=!0),t.user?u=n.Services.API.feeds3GetMaterialization(this.materializedLastCursor,this.materializedTagIDs,a,f,l,t.skipCache).done(_.bind(function(e){if(!e){i.reject();return}o=e.cursor!==null&&e.feedItems[0]!==null,this.materializedLastCursor=e.cursor,i.resolve(e.feedItems,o,{metaByType:e.metaByType})},this)).fail(_.bind(i.reject,i)):i.reject();break;default:i.reject()}var h=i.promise();return u&&typeof u.abort=="function"&&(h.abort=_.bind(u.abort,u)),h},a=function(e,t){var r=$.Deferred(),i;!this.notificationLastTSNewest&&t.notificationLastTSNewest&&(this.notificationLastTSNewest=t.notificationLastTSNewest),!this.notificationOldestNotifTS&&t.notificationOldestNotifTS&&(this.notificationOldestNotifTS=t.notificationOldestNotifTS),i=n.Services.API.getTacobellCarryOut(this.notificationLastTSNewest,this.notificationOldestNotifTS).done(_.bind(function(e){if(!e){r.reject();return}this.notificationLastTSNewest=e.tsNewest||this.notificationLastTSNewest,this.notificationOldestNotifTS=e.oldestNotificationTS;var t;e.tsNewest||(t=!1),r.resolve(e.notifications,t)},this)).fail(_.bind(r.reject,r));var s=r.promise();return typeof i.abort=="function"&&(s.abort=_.bind(i.abort,i)),s},f=function(){var e=$.Deferred(),t=this;return this.notificationLastTSNewest?n.Services.API.markTacosAsEaten(this.notificationLastTSNewest).done(function(n){n==-1?e.reject():(t.each(function(e){e.set("unseen",!1,{silent:!0})}),e.resolve())}).fail(_.bind(e.reject,e)):e.reject(),e.promise()},l=function(e){this.notificationLastTSNewest=e},c=function(e){console.log("unsubscribing from",e);var t=_.partition(this.monitors,function(t){var r=n.Models.Broadcast.extractBroadcastIDFromChannel(t.channelName);return _.indexOf(e,r)!==-1});this.monitors=t[1],_.each(t[0],function(e){e.stop(!0)}),r.model.get("manatee").updateMonitorChannelList()},h={model:n.Models.Broadcast,subscribed:!1,initialize:function(){this.toUnsubscribe=[],this.subscribeDebounce=_.debounce(_.bind(function(){this.subscribed&&this.subscribe()},this),150),this.unsubscribeBroadcastIDsDebounce=_.debounce(_.bind(function(){var e=_.pluck(this.toUnsubscribe.splice(0,this.toUnsubscribe.length),"id");c.call(this,e)},this),150)},setSubscribedKeys:function(e){return this.subscribed?!1:(this.subscribedKeys=e,!0)},subscribe:function(){if(!this.subscribedKeys||!this.subscribedKeys.length)return!1;var e=this.pluck("BroadcastID"),t=n.Models.Broadcast.subscribeToBroadcastsStatuses(e,this.subscribedKeys);return t&&t.monitors?(this.monitors=t.monitors,this.subscribed=!0,this.on("add",this.onSubscribedAdd,this),this.on("remove",this.onSubscribedRemove,this),!0):!1},onSubscribedAdd:function(){this.subscribeDebounce()},onSubscribedRemove:function(e){this.toUnsubscribe.push(e),this.unsubscribeBroadcastIDsDebounce()},unsubscribe:function(){return!this.subscribedKeys||!this.subscribedKeys.length||!this.monitors?!1:(_.each(this.monitors,function(e){e.stop(!0)}),r.model.get("manatee").updateMonitorChannelList(),this.subscribed=!1,this.off("add",this.onSubscribedAdd),this.off("remove",this.onSubscribedRemove),!0)},filterBestBroadcasts:function(){this.reset(this.filter(function(e){return gsConfig.filterBroadcastsByListenersCount&&e.attributes.listenersCount>gsConfig.filterBroadcastsByListenersCount?!1:e.attributes.ownerSubscribed&&e.attributes.isPlaying!==!1&&e.attributes.activeStatus!=0}))},sortByListeners:function(){this.comparator=function(e){return e.attributes.listenersCount*-1},this.sort()},getForTag:function(e){return this.filter(function(t){var n=t.get("Tag");return n&&n.i==e})}},p=function(e){return this.get([this.options.broadcastID,":",e].join(""))};n.Models.Collections={Songs:Backbone.CachedModelCollection.extend({model:n.Models.Song},{}),PageableSongs:Backbone.PageableCollection.extend({model:n.Models.Song,_initialPageableItemLimit:10,_pageableItemsPerLoad:10},{}),BroadcastSongs:Backbone.WrappedModelCollection.extend({model:n.Models.BroadcastSong,initialize:function(e,t){this.options=t},getByQueueSongID:p},{}),PlayableSongs:Backbone.WrappedModelCollection.extend({model:n.Models.PlayableSong},{}),PlaylistSongs:Backbone.WrappedModelCollection.extend({model:n.Models.PlaylistSong},{}),BroadcastSuggestions:Backbone.WrappedModelCollection.extend({model:n.Models.BroadcastSuggestion},{}),Artists:Backbone.CachedModelCollection.extend({model:n.Models.Artist},{}),Albums:Backbone.CachedModelCollection.extend({model:n.Models.Album},{}),Playlists:Backbone.CachedModelCollection.extend({model:n.Models.Playlist},{}),Broadcasts:Backbone.CachedModelCollection.extend(h,{}),Users:Backbone.CachedModelCollection.extend({model:n.Models.User},{}),TinyUsers:Backbone.Collection.extend({model:n.Models.TinyUser},{}),Videos:Backbone.Collection.extend({model:n.Models.Video},{}),Events:Backbone.Collection.extend({model:n.Models.Event},{}),Stations:Backbone.Collection.extend({model:n.Models.Station},{}),Tags:Backbone.CachedModelCollection.extend({model:n.Models.Tag},{}),Callouts:Backbone.CachedModelCollection.extend({model:n.Models.Callout},{}),Comments:Backbone.PageableCollection.extend({model:n.Models.Comment,comparator:e,_initialPageableItemLimit:25,_pageableItemsPerLoad:50,_pageableItemsPerPage:20,_pageableLoadFunc:o,_pageableAllowPreload:!1},{}),CommentResponses:Backbone.CachedModelCollection.extend({model:n.Models.CommentResponse,comparator:t},{}),FeedEvents:Backbone.PageableCollection.extend({model:n.Models.FeedEvent,_initialPageableItemLimit:20,_pageableItemsPerLoad:20,_pageableItemsPerPage:20,_pageableLoadFunc:u,_pageableAllowPreload:!1},{}),Tacos:Backbone.PageableCollection.extend({model:n.Models.Taco,comparator:i,markAllAsSeen:f,updateTSNewest:l,_initialPageableItemLimit:10,_pageableItemsPerLoad:25,_pageableItemsPerPage:10,_pageableLoadFunc:a,_pageableAllowPreload:!1},{}),UserShares:Backbone.PageableCollection.extend({model:n.Models.FeedEvent,_initialPageableItemLimit:25,_pageableItemsPerLoad:75,_pageableItemsPerPage:100,_pageableLoadFunc:u,_pageableAllowPreload:!1},{}),ChatActivities:Backbone.CappedCollection.extend({model:n.Models.ChatActivity},{})},n.Models.Collections.FeedEventComments=n.Models.Collections.Comments.extend({comparator:s})}(),function(){function e(e,t,n){var i=this._dfds,s=this._requests,o,u,a,f;n.assignedVersion&&n.version&&(this.set({assignedVersion:n.assignedVersion,version:n.version}),r.model.set("searchVersion",n.version)),n&&n.result&&n.result.Tags&&e.push("Tags");for(var l=0,c=e.length;l<c;l++){o=e[l],u=i[o];if(!n||!n.result||!_.isArray(n.result[o])){u&&u.reject();continue}a=this.get(o.toLowerCase()),a.reset(n.result[o]),u&&u.resolve(a)}f=_.indexOf(s,t),f>=0&&s.splice(f,1)}n.Models=n.Models||{},n.Models.Search=Backbone.Model.extend({parse:function(e,t){return t&&t.skipParse?e:{query:e.query+"",ppOverride:e.ppOverride||!1,assignedVersion:"",topResult:null,fuzzyMatch:null,songs:new n.Models.Collections.Songs(e.songs,t),artists:new n.Models.Collections.Artists(e.artists,t),albums:new n.Models.Collections.Albums(e.albums,t),users:new n.Models.Collections.Users(e.users,t),broadcasts:new n.Models.Collections.Broadcasts(e.broadcasts,t),playlists:new n.Models.Collections.Playlists(e.playlists,t),events:new n.Models.Collections.Events(e.events,t),videos:new n.Models.Collections.Videos(e.videos,t),tags:new n.Models.Collections.Tags(e.tags,t)}},initialize:function(){this._dfds={},this._requests=[]},setQuery:function(e){var t=this.get("songs"),n=this.get("artists"),r=this.get("albums"),i=this.get("users"),s=this.get("broadcasts"),o=this.get("playlists"),u=this.get("events"),a=this.get("videos");t.reset([]),n.reset([]),r.reset([]),i.reset([]),s.reset([]),o.reset([]),u.reset([]),a.reset([]),this.set("query",e+"")},getResults:function(t){var n=[],r=[],i=this._dfds,s=this._requests,u,a;for(var f=0,l=t.length;f<l;f++)u=_.ucwords(t[f]),i[u]||(i[u]=$.Deferred(),i[u].searchType=u,r.push(u)),n.push(i[u]);return r.length&&(a=o.getResultsFromSearch(this.get("query"),r,this.get("ppOverride")),s.push(a),a.always(_.bind(e,this,r,a))),n},selectTopResult:function(){var e=(this.get("query")||"").toLowerCase(),t=this.get("songs"),n=this.get("artists"),r=this.get("albums"),i=this.get("users"),s=this.get("broadcasts"),o=this.get("playlists"),u=this.get("events"),a=this.get("tags"),f=[[t,"SongName"],[n,"ArtistName"],[r,"AlbumName"],[i,"FName"],[s,"Name"],[o,"PlaylistName"],[u,"EventName"],[a,"Tag"]],l=e.indexOf(" by "),c=a&&a.length?a.models[0].get("Tag").toLowerCase():"",h=c?$.trim(e.replace(c,"")):e,p=null,d=null,v,m,g,y,b,w,E,S,x;if(h!=="")for(g=0,y=f.length;g<y;g++){b=f[g][0],w=f[g][1],E=b.first();if(!E)continue;S=(E.get(w)||"").toLowerCase(),x=E.get("IsVerified"),v=S==e||S==h,l>0&&g!=1?m=S==e.substring(0,l):m=null;if(v||m){d=E;if(x)break}else!p&&e.indexOf(S)!==-1&&x&&(p=E)}a.length&&(d=a.first());var T={topResult:d,fuzzyMatch:p};return this.set(T),T},abortRequests:function(){var e=this._requests,t=e.length;while(t--)e[t].abort&&e[t].abort();e.splice(0,e.length)}},{})}(),function(){n.Models=n.Models||{};var e=n.Models.Cover=Backbone.Model.extend({idAttribute:"id",getPreviewPath:function(){return["/themes/coverphotos",this.get("location"),"preview.jpg"].join("/")+"?ver="+_.orEqual(this.get("version"),1)},getCoverPath:function(){return["/themes/coverphotos",this.get("location"),"cover.jpg"].join("/")+"?ver="+_.orEqual(this.get("version"),1)}},{definitionsUpdated:0,version:20121005.56,covers:{0:{id:0,location:"upload",upload:!0},1:{id:1,location:"default",styles:""},2:{id:2,location:"fusion"},3:{id:3,location:"leporidaeZanders"},4:{id:4,location:"oldSkoolSBalmer"},5:{id:5,location:"patternShirtATurnbull"},6:{id:6,location:"sharkWhales"},7:{id:7,location:"seamlessWaves1Markovka"},8:{id:8,location:"seamlessWaves2Markovka"},9:{id:9,location:"floralPigeonsMarkovka"},10:{id:10,location:"airplanesNassner"},11:{id:11,location:"daytimeAnaMontiel"},12:{id:12,location:"nighttimeAnaMontiel"},13:{id:13,location:"fruitRubyTaylor"},14:{id:14,location:"driveTrain"},15:{id:15,location:"nauticalGlasby"},16:{id:16,location:"mushroomsBoil"},17:{id:17,location:"novembreFrancout"},18:{id:18,location:"mellow"},19:{id:19,location:"moonAndSea",styles:{"background-size":"cover"}},20:{id:20,location:"ribbonDancer"},21:{id:21,location:"instruments2012"},22:{id:22,location:"grayTile"},23:{id:23,location:"petitBirds2012"},24:{id:24,location:"triangled"},25:{id:25,location:"wood"},26:{id:26,location:"greenDust"},27:{id:27,location:"avntgrd2012"}}})}(),function(){function e(e){var t=e.constructor;return t||(t=n.Views.Modules[e.cacheKey]),t}function t(e){return function(t){e.call(this,t)}}n.Views=n.Views||{},n.Views.Modules=n.Views.Modules||{},n.Views.Modules.Base=Backbone.View.extend({templatePath:"modules",templateFile:"",templateData:"",tagName:"div",className:"module grid-item",cacheKey:"Base",rendered:!1,disabled:!1,initEventsAttached:!1,_baseInit:!1,modelEvents:null,initialize:function(e){var t={module:this};this.rendered=!1,this.disabled=!1,this._baseInit=!0,this.changeModelCached={},this.renderDfd=$.Deferred();if(e.grid||e.list)this.grid=e.grid||e.list,this.grid.options&&(this.grid.options.playContext&&(t.playContext=this.grid.options.playContext,this.playContext=this.grid.options.playContext),this.grid.options.addStreamType&&(t.streamType=this.grid.options.addStreamType,this.streamType=this.grid.options.addStreamType));return this.options.addClass&&this.$el.addClass(this.options.addClass),this.$el.data(t),this.addModelListeners(),this.changeModelSelectors&&this.runChangeModelSelectors({"&":this.changeModelSelectors["&"]}),Backbone.View.prototype.initialize.call(this,e)},addModelListeners:function(){var e=!this.initEventsAttached,n,r,i;if(!this.model||!this.rendered)return;this.grid&&this.grid.cid&&(this.listenTo(this.model,this.grid.cid+":select",this.select),this.listenTo(this.model,this.grid.cid+":deselect",this.deselect)),this.initEventsAttached=!0;if(this.changeModelSelectors){this.model.on("change",this.handleModelChange,this);return}n=this;while(n){if(n.modelEvents)for(r in n.modelEvents)if(n.modelEvents.hasOwnProperty(r)){i=t(n.modelEvents[r]),e&&this.on("model:set",i,this);if(r==="model")continue;this.listenTo(this.model,r,i)}n=n.constructor&&n.constructor.__super__}},removeModelListeners:function(){this.model&&this.stopListening(this.model)},destroy:function(e){return this.off("model:set",null,this),this.removeModelListeners(),this.$el.off("mouseleave"),Backbone.View.prototype.destroy.call(this,e)},render:function(t){var n=e(this),r=t||new ChainLoading,i;return this.model?n.cachedTemplate?(r.done(_.bind(this.completeRender,this,n.cachedTemplate)),this.renderDfd.promise()):(this.templateFile?i=this.fetchTemplate(this.templateFile):(i=$.Deferred(),i.resolve(_.template(this.templateData))),r.push(i).always(_.bind(this.cacheAndCompleteRender,this)),this.renderDfd.promise()):$.Deferred().resolve()},select:function(){this.selected=!0,this.$el.addClass("active")},deselect:function(){this.selected=!1,this.$el.removeClass("active")},changeModel:function(e,t){var n=t||{};this.initEventsAttached||(n.force=!0);if(this.model===e&&!n.force)return;if(this.model!==e||!this.initEventsAttached)this.removeModelListeners(),this.model=e,this.addModelListeners(),e&&this.trigger("model:set",e);this.selected&&!n.selected?this.deselect():!this.selected&&n.selected&&this.select();if(!this.renderDfd){this.render();return}if(this.renderDfd.state()!=="resolved")return;this.changeModelSelectors&&this.runChangeModelSelectors()},runChangeModelSelectors:function(e){var t;e=e||this.changeModelSelectors,typeof e["&"]=="function"&&(this.changeModelCached["&"]||(this.changeModelCached["&"]=this.$el),this.changeModelCached["&"].each(_.bind(e["&"],this)));for(t in e)t!=="&"&&e.hasOwnProperty(t)&&(this.changeModelCached[t]||(this.changeModelCached[t]=this.$el.find(t)),this.changeModelCached[t].each(_.bind(e[t],this)))},show:function(){this.isHidden&&(this.isHidden=!1,this.$el.show())},hide:function(){this.isHidden=!0,this.$el.hide()},cacheAndCompleteRender:function(t){var n=e(this);if(!n)return;n.cachedTemplate=t,this.completeRender(t)},completeRender:function(e,t){if(this.renderDfd.state()==="resolved")return;var r=t||{},i,s,o;r.skipHTML||this.$el.html(this.renderTemplate(_.bind(e,this))),i=this.grid&&this.grid.options?this.grid.options.excludeCells:!1;if(i&&i.length)for(s=0,o=i.length;s<o;s++)this.$el.find(".module-row-cell."+i[s]).remove();this.bindUIElements(),this.renderDfd.resolve(e),this.handleModelChange(),this.options.redrawUpdate&&n.trigger("page:redrawUpdate"),this.rendered=!0,this.initEventsAttached||(this.addModelListeners(),this.model&&this.trigger("model:set",this.model)),this.changeModelSelectors&&this.runChangeModelSelectors(),this.trigger("rendered")},updateOnDrag:function(){},acceptDrop:function(e){return!1},handleModelChange:function(e,t){if(!this.renderDfd||this.renderDfd.state()!=="resolved"||t&&t.skipModules)return;var n={force:!0};this.grid&&this.grid.selectedItems&&(n.selected=this.grid.selectedItems.indexOf(this.model)!==-1),this.changeModel(this.model,n)}},{precacheTemplate:function(e){if(e.cachedTemplate)return $.Deferred().resolve(e.cachedTemplate);var t=e.prototype,n=t.templateFile,r=t.templatePath,i,s;return s={templatePath:r,fetchTemplate:Backbone.View.prototype.fetchTemplate},n?i=s.fetchTemplate(n):(i=$.Deferred(),i.resolve(_.template(""))),i.always(function(t){e.cachedTemplate=t})}}),n.Views.Modules.Draggable=n.Views.Modules.Base.extend({events:{draginit:"onDragInit",drag:"onDrag",dragstart:"onDragStart",dragend:"onDragEnd"},onDragInit:function(){if(gsConfig.isMobile||!this.dragData)return!1;switch(this.dragData.itemType){case"artist":case"album":case"song":case"playlist":break;default:return!1}},itemsToDragProxy:function(e){return _.globalItemsToDragProxy(e)},onDrag:function(e,t){_.globalDragHandler(e,t)},onDragStart:function(e,t){var r=$('<div class="grid-drag-proxy" style="pointer-events: none"/>').mousewheel(_.globalDragProxyMousewheel);return t.draggedItemsContext=this.dragData.playContext,t.draggedItems=this.dragData.items||[this.dragData.item],t.draggedItemsSource=this.cid,this.itemsToDragProxy(t.draggedItems).done(_.bind(function(e){typeof e=="string"?r.html(e):r.append(e),r.appendTo("body"),t.proxy=r,n.trigger("drag:start",t)},this)),r},onDragEnd:function(e,t){_.globalDragCleanup(e,t),n.trigger("drag:end",t)}})}(),function(){n.Views.Modules.SongRowBase=n.Views.Modules.Base.extend({albumHidden:!1,ui:{rowNumber:".row-number",play:".play",title:".title",songLink:".song-link",favorite:".favorite",repost:".song-row-repost",more:".song-row-more",artist:".artist",album:".album",tag:".tag"},events:{"click .metadata .artist":"onArtistLinkClick","click .metadata .album":"onAlbumLinkClick","click .metadata .song-link":"onSongLinkClick","click .action.song-row-favorite":"onFavoriteClick","click .action.song-row-playlist":"onPlaylistClick","click .action.song-row-repost":"onRepostClick","click .action.song-row-more, .row-actions":"onMoreClick","mouseenter .action":"onActionHover"},modelEvents:{model:function(e){var t=e.get("CalloutID"),n=this.grid&&this.grid.collection;this.$el.data("songId",e.get("SongID")).data("calloutId",t||null).toggleClass("callout",t||!1).toggleClass("grid-item",n||!1),this.ui.$play.data("songId",e.get("SongID")),this.ui.$songLink.data("songId",e.get("SongID")),this.ui.$favorite.data("songId",e.get("SongID")),this.ui.$repost.data("songId",e.get("SongID")),e.idAttribute==="queueSongID"&&this.$el.data("queueSongId",e.id)},"change:removedFrom":function(e){var t=e.get("removedFrom");this.$el.toggleClass("removed-from",t||!1),t&&this.$el.removeClass("active")},"change:TrackNumsByAlbumID change:TrackNum":function(e){var t=this.grid,n,r;t&&(t.options.showTrackNum||this.options.showTrackNum?(t.options.contextAlbumID?(r=e.get("TrackNumsByAlbumID"),n=r&&r[t.options.contextAlbumID]||""):n=e.get("TrackNum")||"",this.ui.$rowNumber.innerText(n)):(t.options.showCount||this.options.showCount)&&this.ui.$rowNumber.innerText(t.collection.indexOf(e)+1))},"change:SongName":function(e){this.ui.$title.innerText(e.get("SongName"))},"change:isFavorite":function(e){var t=e.get("isFavorite");this.ui.$favorite.toggleClass("btn-success",t||!1),this.$el.toggleClass("favorited",t||!1),t?this.ui.$favorite.data("translateTitle","REMOVE_FROM_FAVORITES").removeData("tooltipText"):this.ui.$favorite.data("translateTitle","ADD_TO_FAVORITES").removeData("tooltipText")},"change:ArtistName":function(e){this.ui.$artist.attr("href",e.toArtistUrl()).innerText(e.get("ArtistName"))},"change:AlbumName":function(e){var t;this.albumHidden||(t=e.get("AlbumName"),this.ui.$album.attr("href",e.toAlbumUrl()).innerText(t).toggleClass("hide",!t))},"change:Tags":function(e){var t=this.getSongTag();this.ui.$tag.toggleClass("hide",!t),t&&this.ui.$tag.attr("href",t.toUrl()).innerText(t.get("DisplayName"))}},initialize:function(e){this.once("rendered",this.onRendered,this),this._super("initialize",e)},getSongTag:function(){var e=this.model;return e.get("Tags")&&e.get("Tags").length?e.get("Tags").first():null},getGutsContext:function(e){var t=$(e.currentTarget),r=t.data("songId");return $.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e))},onRendered:function(){this.options&&this.options.hideArtistName&&this.ui.$artist.addClass("hide")},onArtistLinkClick:function(e){this.grid&&this.grid.onArtistLinkClick&&this.grid.onArtistLinkClick(e),n.trigger("guts:log","OLartistLinkClick",this.getGutsContext(e))},onAlbumLinkClick:function(e){this.grid&&this.grid.onAlbumLinkClick&&this.grid.onAlbumLinkClick(e),n.trigger("guts:log","OLalbumLinkClick",this.getGutsContext(e))},onSongLinkClick:function(e){this.grid&&this.grid.onSongLinkClick&&this.grid.onSongLinkClick(e),n.trigger("guts:log","OLsongLinkClick",this.getGutsContext(e))},onFavoriteClick:function(e){this.grid&&this.grid.onSongFavoriteClick&&this.grid.onSongFavoriteClick(e),n.trigger("guts:log","OLfavoriteClick",this.getGutsContext(e))},onRepostClick:function(e){n.getLoggedInUserID()<1?this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_SHARE",_.bind(function(){this.onRepostClick(e)},this)):n.trigger("lightbox:open","share",{item:this.model})},openRequireLoginTooltip:function(e,t,r){var i=$(e.currentTarget);n.Models.AuthUser.openRequireLoginTooltip(t,r,{$attached:i,$menuOpenEl:i})},onPlaylistClick:function(e){if(n.getLoggedInUserID()<1){this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST");return}if(this.grid&&this.grid.onPlaylistClick)this.grid.onPlaylistClick(e);else{var t=$(e.currentTarget),i=r.model.get("user"),s={closeOnScroll:!1,$attached:t,tooltipClass:"playlist-songrow-menu",$menuOpenEl:t.closest(".module"),playlist:this.grid&&this.grid.options&&this.grid.options.playlist,playlistSongID:this.model.get("playlistSongID"),songs:[this.model],collectionCallback:_.bind(function(e,t){t?e.addSongsToLibrary([this.model]):e.removeSongsFromLibrary([this.model])},this),callback:_.bind(function(e){e.addSongs([this.model],null,!0)},this)};i.getPlaylists().done(_.bind(function(){_.asyncTooltipMenu(t,s,this.model,"getPlaylistsMenu")},this))}n.trigger("guts:log","OLplaylistClick",this.getGutsContext(e))},onMoreClick:function(e){var t=r.model.get("appSize")==="mobile",i=new n.Models.PlayContext,s=$(e.currentTarget),o=s.hasClass("row-actions"),u,a;if(t&&!o||!t&&o)return;i.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),!t&&this.grid&&this.grid.onMoreClick?this.grid.onMoreClick(e):(s=this.ui.$more,u={closeOnScroll:!1,playContext:i,$attached:s,className:"more-songrow-menu",$menuOpenEl:s.closest(".module"),player:r.model.get("player"),appToken:r.model.get("appToken"),isMobile:t},t?(n.trigger("header:metadata",this.model),a="getContextMenuForSong"):this.$el.hasClass("collapse-actions")?(a="getContextMenuForSongRowMoreCombined",u.authUser=r.model.get("user")):a="getContextMenuForSongRowMore",_.asyncTooltipMenu(s,u,this.model,a)),n.trigger("guts:log","OLmoreClick",this.getGutsContext(e))},onActionHover:function(e){n.Views.Application.titleTooltipHelper(e,{positionDir:"up"})}})}(),function(){n.Views.Modules.SongRow=n.Views.Modules.SongRowBase.extend({className:"module module-row song",cacheKey:"SongRow",templateFile:"songRow"})}(),function(){n.Views.Modules.SongRowTall=n.Views.Modules.SongRowBase.extend({className:"module module-row song tall",templateFile:"songRowTall",ui:_.extend({},n.Views.Modules.SongRowBase.prototype.ui,{img:".img"}),modelEvents:{"change:SongName change:CoverArtFilename":function(e){this.ui.$img.attr("src",e.getImageURL(this.options.requestedImageSize||40)).attr("alt",e.get("SongName"))}},mobileAction:function(e){this.play(e)},play:function(e){var t;if($(e.target).hasClass("action"))return;this.grid&&this.grid.playContext&&(t=this.grid.playContext),this.model.play({context:t,streamType:n.Models.PlayContext.TYPE_DEFAULT,playOnAdd:!0})},initialize:function(e){e.activeSong&&(this.activeSong=!0),this.once("rendered",this.onRendered,this),this._super("initialize",e)},onRendered:function(){this.$el.toggleClass("hide-artist",!!this.options&&!!this.options.hideArtistName)}})}(),function(){n.Views.Modules.SongRowBC=n.Views.Modules.SongRowBase.extend({className:"module module-row song tall grid-item bc-row",templateFile:"songRowBC",ui:_.extend({},n.Views.Modules.SongRowBase.prototype.ui,{img:".img",votes:".votes",voteButton:".vote-btn",upvoteButton:".upvote-btn",approvalButtons:".approval-btns",approve:".approve",reject:".reject",suggestedByText:".suggested-by-text",suggestedByLink:".suggested-by-link",userLink:".user-link"}),events:_.extend({},n.Views.Modules.SongRowBase.prototype.events,{"click .upvote-btn":"onSongUpVoteClick","click .approve":"onSongApproveClick","click .reject":"onSongRejectClick","mouseover .votes-number":"onActionHover"}),modelEvents:{model:function(e){var t=n.getCurrentBroadcast(),r=this.options.isHistory,i=t&&t.isLoggedInUserOwner(),s=t&&t.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS),o=this.options.isAdmin&&(this.activeSong||r);this.$el.toggleClass("bc-owner",i||!1).toggleClass("bc-vip",s&&!i||!1),this.ui.$voteButton.data("songId",e.get("SongID")),this.ui.$upvoteButton.toggleClass("hide",!this.options.isSuggestion),this.ui.$votes.toggleClass("both-votes",o),r?this.ui.$approvalButtons.remove():this.updateRowActions()},"change:isFavorite":function(e){var t=e.get("isFavorite");this.$el.toggleClass("favorited",t||!1)},"change:userVote":function(e){var t=e.get("userVote");t===0?this.$el.removeClass("upvoted downvoted"):this.$el.swapClasses("upvoted","downvoted",t>0)},"change:CoverArtFilename change:SongName":function(e){this.ui.$img.attr("src",e.getImageURL(this.options.requestedImageSize||40)).attr("alt",e.get("SongName"))},"change:upVotes change:downVotes change:upVoteCount change:downVoteCount":function(e){var t=e.get("upVoteCount")||0,n=e.get("downVoteCount")||0,r=t-n;this.ui.$votes.html(r)},"change:approvalStatus":function(e){var t=this.options.isSuggestion,n=this.options.isHistory,r=this.options.isAdmin,i=e.get("approvalStatus")||0;this.ui.$approve.toggleClass("btn-success",i>0),this.ui.$reject.toggleClass("btn-danger",i<0);if(t||n)this.$el.toggleClass("show-approval",r),i===0?this.$el.removeClass("approved rejected"):this.$el.swapClasses("approved","rejected",i>0)},"change:suggester":function(e){var t=e.get("suggester");this.ui.$suggestedByText.toggleClass("hide",!t),this.ui.$suggestedByLink.toggleClass("hide",!t),this.ui.$userLink.toggleClass("hide",!t),t&&(this.ui.$suggestedByLink.attr("user-id",t.get("userId")).innerText(t.get("Name")),this.ui.$userLink.attr("href",t.toUrl()).innerText(t.get("Name")))}},initialize:function(e){e&&e.upcomingSong&&(this.upcomingSong=!0),this._super("initialize",e),this.grid&&this.grid.options.isHistory&&(this.options.isHistory=!0),this.grid&&this.grid.options.isSuggestion&&(this.options.isSuggestion=!0),this.grid&&this.grid.options.isAdmin&&(this.options.isAdmin=!0),this.broadcast=n.getCurrentBroadcast(),this.broadcast&&(this.broadcast.on("change:vipUsers",this.updateRowActions,this),this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS)&&(this.options.isAdmin=!0)),r.model.get("appMode")=="mobile"&&this.$el.on("click",_.bind(function(e){if($(e.target).hasClass("action"))return;var t;this.grid&&this.grid.playContext&&(t=this.grid.playContext),this.model.play({context:t,streamType:n.Models.PlayContext.TYPE_DEFAULT,playOnAdd:!0}),e.stopPropagation()},this))},onDestroy:function(){this.broadcast&&this.broadcast.off(null,null,this)},updateRowActions:function(){var e=!1;this.broadcast?this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS)?(this.options.isAdmin=!0,e=!0):this.options.isAdmin=!1:this.options.isAdmin&&(e=!0),e?(this.$(".approval-btns").removeClass("hide"),this.$(".vote-btns").addClass("hide")):(this.$(".approval-btns").addClass("hide"),this.$(".vote-btns").removeClass("hide"))},onSongUpVoteClick:function(e){if(!this.broadcast||!this.broadcast.isListener())return;this.activeSong?this.model.get("userVote")===1?this.broadcast.voteActiveSong(0):this.broadcast.voteActiveSong(1):this.model.get("userVote")===1?this.broadcast.removeSuggestion(this.model):this.broadcast.suggestSong(this.model)},onSongApproveClick:function(e){var t=$(e.currentTarget),r=this.broadcast&&this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS),i;if(r){this.broadcast.approveSuggestedSong(this.model),n.trigger("guts:log","broadcastApproveSuggestionClicked",this.getGutsContext(e));return}},onSongRejectClick:function(e){var t=$(e.currentTarget),r=this.broadcast&&this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS),i;if(r){this.broadcast.rejectSuggestedSong(this.model),n.trigger("guts:log","broadcastRejectSuggestionClicked",this.getGutsContext(e));return}}})}(),function(){n.Views.Modules.SongRowBCActive=n.Views.Modules.SongRowBase.extend({templateFile:"songRowBCActive",ui:_.extend({},n.Views.Modules.SongRowBase.prototype.ui,{img:".img",upvotes:".upvotes"}),events:_.extend({},n.Views.Modules.SongRowBase.prototype.events,{"click .upvote-btn":"onSongUpVoteClick","click .downvote-btn":"onSongDownVoteClick"}),modelEvents:{model:function(e){var t=n.getCurrentBroadcast(),r=e.get("CalloutID"),i=t&&t.isLoggedInUserOwner(),s=t&&t.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS),o=(t&&t.get("BroadcastID"))===this.options.broadcastID;this.$el.toggleClass("bc-owner",i||!1).toggleClass("bc-vip",s||!1).toggleClass("callout",r||!1).toggleClass("current-bc",o).data("calloutId",r||!1)},"change:CoverArtFilename":function(e){this.ui.$img.attr("src",e.getImageURL(200)).attr("alt",e.get("SongName")).attr("id","active-song-album-art")},"change:isFavorite":function(e){var t=e.get("isFavorite");this.$el.toggleClass("favorited",t||!1)},"change:upVotes change:downVotes change:userVote":function(e){var t=n.getCurrentBroadcast(),r=t&&t.isLoggedInUserOwner(),i=e.get("upVotes")&&e.get("downVotes"),s=i?e.get("upVotes").length-e.get("downVotes").length:0,o=r?s:e.get("userVote");this.ui.$upvotes.text(s),o===0?this.$el.removeClass("upvoted downvoted"):this.$el.swapClasses("upvoted","downvoted",o>0)}},initialize:function(e){this.user=e.user,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},completeRender:function(){this._super.apply(this,["completeRender"].concat(_.toArray(arguments))),this.user&&this.listenTo(this.user,"change:currentBroadcastID",this.renderRowActions)},renderRowActions:function(){var e=n.getCurrentBroadcast(),t=(e&&e.get("BroadcastID"))===this.options.broadcastID;this.$el.toggleClass("current-bc",t)},isActiveSong:function(){var e=r.model.get("player").get("queue"),t=e.get("currentBroadcast"),n=e.get("activeSong"),i=t&&t.get("activeSong"),s=this.model;return!t||e.get("isBroadcasting")||!n||!i||!s?!1:n.get("queueSongID")===s.get("queueSongID")&&n.get("queueSongID")===i.get("queueSongID")?!0:!1},onSongUpVoteClick:function(e){var t=r.model.get("player").get("queue"),n=t.get("currentBroadcast"),i=t.get("activeSong"),s=n&&n.get("activeSong");if(!n||t.get("isBroadcasting"))return;this.isActiveSong()?this.model.get("userVote")===1?n.voteActiveSong(0):n.voteActiveSong(1):this.model.get("userVote")===1?n.removeSuggestion(this.model):n.suggestSong(this.model)},onSongDownVoteClick:function(e){var t=r.model.get("player").get("queue"),n=t.get("currentBroadcast");if(!n||t.get("isBroadcasting"))return;this.isActiveSong()?this.model.get("userVote")===-1?n.voteActiveSong(0):n.voteActiveSong(-1):this.model.get("userVote")===-1?n.removeSuggestion(this.model,!0):n.suggestSong(this.model,!0)}})}(),function(){var e=["msLoaded","percentLoaded","position","duration","token","artistIsClaimed"];n.Views.Modules.SongRowQueue=n.Views.Modules.Base.extend({className:"module queue-item grid-item",cacheKey:"SongRowQueue",templateFile:"songRowQueue",events:{click:function(e){n.getAppMode()!=="desktop"&&!$(e.target).hasClass("queue-song-option")&&(e.preventDefault(),e.stopPropagation(),this.onPlayClick(e))},"click .remove":function(e){n.trigger("player:removeSongs",[this.model])},"mouseenter .play":function(e){return!1},"click .move-up":function(e){var t=this.model.get("queueSongID"),r=this.grid.visibleCollection.indexOf(this.model);n.trigger("player:moveSongs",[t],r-1)},"click .move-down":function(e){var t=this.model.get("queueSongID"),r=this.grid.visibleCollection.indexOf(this.model);n.trigger("player:moveSongs",[t],r+2)},"click .play":"onPlayClick"},changeModelSelectors:{"&":function(e,t){_.$one(t)[this.model.get("active")?"addClass":"removeClass"]("queue-item-active").data("queueSongId",this.model.get("queueSongID")),this.songQueueHelper=this.model.get("songQueueHelper")||{}},".row-number":function(e,t){_.$one(t).text(this.grid.collection.indexOf(this.model)+1)},".queue-song":function(e,t){_.$one(t)[this.model.get("suggestion")?"addClass":"removeClass"]("suggestion"),_.$one(t)[this.model.get("broadcastPlayed")?"addClass":"removeClass"]("dj-locked")},".queue-radio-options":function(e,t){_.$one(t)[this.songQueueHelper.autoplay?"addClass":"removeClass"]("active")},".smile":function(e,t){_.$one(t)[this.model.get("smile")?"addClass":"removeClass"]("active")},".frown":function(e,t){_.$one(t)[this.model.get("frown")?"addClass":"removeClass"]("active")},".queue-song-options":function(e,t){_.$one(t)[this.model.get("isCallout")?"addClass":"removeClass"]("hide"),_.$one(t)[this.model.get("fromLibrary")?"addClass":"removeClass"]("inLibrary"),_.$one(t)[this.model.get("isFavorite")?"addClass":"removeClass"]("isFavorite")},".paused, .play":function(e,t){_.$one(t)[this.model.get("paused")?"addClass":"removeClass"]("paused").attr("rel",this.model.get("queueSongID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(this.songQueueHelper.queueImageSize))},".queue-song-name":function(e,t){var n=this.model.get("SongName");_.$one(t).data("songId",this.model.get("SongID")).data("calloutId",this.model.get("CalloutID")).innerText(n),_.$one(t).toggleClass("song-link",!this.model.get("isCallout"))},".queue-song-artist":function(e,t){var n=this.model.get("ArtistName");_.$one(t).attr("title",n).attr("href",this.model.toArtistUrl()).innerText(n)},".favorite":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".remove":function(e,t){_.$one(t).toggleClass("hide",n.isBroadcastListener())}},onPlayClick:function(e){n.trigger("player:togglePlay",this.model.get("queueSongID")),e.stopPropagation()},changeModel:function(t,n){var r,i,s;if(this.model===t){r=t.changedAttributes(),i=_.keys(r),s=_.difference(i,e);if(!s.length)return}this._super("changeModel",t,n)},updateOnDrag:function(){this.runChangeModelSelectors({".row-number":this.changeModelSelectors[".row-number"]})}})}(),function(){n.Views.Modules.SongRowQueuePage=n.Views.Modules.SongRowBase.extend({className:"module module-row song tall",templateFile:"songRowQueuePage",ui:_.extend({},n.Views.Modules.SongRowBase.prototype.ui,{rowNumber:".row-number",img:".img",play:".play",playIcon:".play .icon"}),events:_.extend({},n.Views.Modules.SongRowBase.prototype.events,{"click .play":function(e){n.trigger("player:togglePlay",this.model.get("queueSongID")),e.stopPropagation()}}),modelEvents:{model:function(e){this.$el.data("queueSongId",e.get("queueSongID")),this.ui.$play.attr("rel",e.get("queueSongID")),this.ui.$rowNumber.innerText(this.grid.collection.indexOf(this.model)+1)},"change:active":function(e){this.$el.toggleClass("is-playing",!!e.get("active"))},"change:active change:pause":function(e){this.ui.$playIcon.swapClasses("icon-pause","icon-play-circle-fill",!!e.get("active")&&!e.get("paused"))},"change:CoverArtFilename change:SongName":function(e){this.ui.$img.attr("src",e.getImageURL(40)).attr("alt",e.get("SongName"))}}})}(),function(){n.Views.Modules.SongCell=n.Views.Modules.Base.extend({className:"module module-cell song block grid-item",cacheKey:"SongCell",templateFile:"songCell",events:{"click .song-cell-dropdown":"onDropDownGearClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".play-or-add":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".album-link":function(e,t){_.$one(t).attr("href",this.model.toAlbumUrl()).attr("title",this.model.get("AlbumName")).innerText(this.model.get("AlbumName"))},".title":function(e,t){_.$one(t).innerText(this.model.get("SongName"))},".btn.song-cell-dropdown":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))}},initialize:function(e){this.$el.data({songId:this.model.get("SongID"),tooltipCacheKey:"songMini"}),e.grid&&e.grid.options&&(e.grid.options.smallGrid?this.$el.addClass("small"):e.grid.options.mediumGrid&&this.$el.addClass("medium")),this._super.call(this,"initialize",e)},onDropDownGearClick:function(e){var t=this.model,n={};return this.grid&&this.grid.options&&this.grid.options.playContext&&(n.playContext=this.grid.options.playContext),t&&(n.menuOpenParent=!0,_.simpleAsyncMenu(e,t,n)),!1}})}(),function(){n.Views.Modules.SongProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card song grid-item",cacheKey:"SongProfileCard",templateFile:"songProfileCard",changeModelSelectors:{"&":function(e,t){_.$one(t).data("song",this.model)},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},".song-link":function(e,t){_.$one(t).data("songId",this.model.id).innerText(this.model.get("SongName"))},".btn.share":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".metadata":function(e,t){_.$one(t).html(_.getString("SONG_BY_ARTIST",{artist:'<a href="'+this.model.toArtistUrl()+'" class="metadata-link">'+this.model.get("ArtistName")+"</a>",album:'<a href="'+this.model.toAlbumUrl()+'" class="metadata-link">'+this.model.get("AlbumName")+"</a>"}))},".play-dropdown":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))}},initialize:function(e){this.$el.data("song",this.model).attr("id","song-"+this.model.get("SongID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.AnalyticsDigestSongRow=n.Views.Modules.SongRowTall.extend({className:"module module-row song tall grid-item analytics-digest-row",cacheKey:"AnalyticsDigestSongRow",templateFile:"analyticsDigestSongRow",changeModelSelectors:_.extend({},n.Views.Modules.SongRowTall.prototype.changeModelSelectors,{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.play-dropdown":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".stat .num":function(e,t){_.$one(t).innerText(_.addCommaSeparators(this.model.get("statsForDashboardColumns")))}})})}(),function(){n.Views.Modules.AlbumRowTall=n.Views.Modules.Base.extend({className:"module module-row tall album grid-item",cacheKey:"AlbumRowTall",templateFile:"albumRowTall",ui:{albumLink:".album-link",imgContainer:".img-container",img:".img",title:".title",artistLink:".artist-link",rowNumber:".row-number"},modelEvents:{model:function(e){var t=e.get("AlbumID");this.$el.data("albumId",t),this.ui.$albumLink.attr("href",e.toUrl()).data("albumId",t),this.ui.$imgContainer.attr("href",e.toUrl()),this.ui.$rowNumber.text(this.grid.collection.indexOf(this.model)+1)},"change:CoverArtFilename":function(e){this.ui.$img.attr("src",e.getImageURL(40))},"change:AlbumName":function(e){var t=e.get("AlbumName");this.ui.$title.innerText(t),this.ui.$img.attr("alt",t)},"change:ArtistID change:ArtistName":function(e){this.ui.$artistLink.innerText(e.get("ArtistName")).attr("href",e.toArtistUrl())}}})}(),function(){n.Views.Modules.ArtistAlbumRow=n.Views.Modules.Base.extend({className:"module module-nested artist-album grid-item",cacheKey:"ArtistAlbumRow",templateFile:"artistAlbumRow",events:{"click @albumEdit":"editAlbum","click .album-cell-dropdown":"onDropDownGearClick","contextmenu .context-menu-item":"onContextMenu"},ui:{albumLink:".album-link",albumTitle:".album-title",albumYear:".album-year",albumType:".album-type",albumImg:".album-img",albumEdit:".album-cell-edit",button:".btn"},modelEvents:{model:function(e){var t=e.get("AlbumID"),r=this.constructor.estimateSize(e,this.grid,!0),i;this.$el.data("albumId",t),this.ui.$albumLink.attr("href",e.toUrl()),this.ui.$button.data("albumId",t),this.size!==r&&this.tmpSize!==r&&(this.$el.outerHeight(r),this.tmpSize=r),this.childViews.songGrid?(i=this.model.get("songs"),this.childViews.songGrid.options.contextAlbumID=t,i&&this.childViews.songGrid.collection.reset(i.models),this.childViews.songGrid.options.playContext=new n.Models.PlayContext(e)):this.rendered&&this.makeChildGrid()},"change:AlbumName":function(e){this.ui.$albumTitle.innerText(e.get("AlbumName"))},"change:Year":function(e){this.ui.$albumYear.innerText(e.get("Year"))},"change:CoverArtFilename":function(e){this.ui.$albumImg.attr("src",e.getImageURL(142))},"change:ReleaseType":function(e){var t=this.model.getReleaseTypeLocale();this.ui.$albumType.attr("data-translate-text",t).innerText(_.getString(t))},"change:ArtistID":function(e){this.ui.$albumEdit.toggleClass("hide",!n.isLoggedInUserOwnerOfArtist(e.get("ArtistID")))}},initialize:function(e){this.size=this.constructor.estimateSize(this.model),this.$el.outerHeight(this.size);var t=r.model.get("user");this.listenTo(t,"change:currentBroadcastID",this.onBroadcastChange),this._super.call(this,"initialize",e)},destroy:function(e){this._super.call(this,"destroy",e),this.rendered=!1},completeRender:function(e,t){this._super.call(this,"completeRender",e,t),this.rendered=!0,_.defer(_.bind(this.makeChildGrid,this))},getModelsBetweenPoints:function(e,t,n,r){var i=this.grid.collection.indexOf(e),s=this.grid.collection.indexOf(n),o=[],u,a;if(i===-1||s===-1)return o;var f=e.get("songs"),l=f.indexOf(t),c=n.get("songs"),h=c.indexOf(r);u=Math.min(i,s),a=Math.max(i,s);if(u===a){var p=Math.min(l,h),d=Math.max(l,h);o.push.apply(o,f.slice(p,d+1))}else i===u?(o.push.apply(o,f.takeRight(f.length-l)),o.push.apply(o,c.take(h+1))):(o.push.apply(o,c.takeRight(c.length-h)),o.push.apply(o,f.take(l+1)));if(u>-1&&u+1<a){var v=this.grid.collection.slice(u+1,a);_.each(v,function(e){o.push.apply(o,e.get("songs").models)})}return o},makeChildGrid:function(){this.childViews.songGrid&&(this.childViews.songGrid.selectedItems.off("add remove reset sort",null,this),this.childViews.songGrid.off("resized",null,this),this.childViews.songGrid.destroy(!1));var e=this.model.get("songs"),t=new n.Models.Collections.Songs(e?e.models:null),r=this.model.id;t.comparator=function(e){return e.attributes.TrackNumsByAlbumID[r]||""},t.sort();var i=n.Views.SongGrid,s=this.grid.options.childGridAlt;s&&(i=s),this.childViews.songGrid=new i({el:this.$el.find(".song-grid")[0],collection:t,showTrackNum:!0,playContext:new n.Models.PlayContext(this.model),header:!1,dontDeselectFor:[this.grid.$el.parent()[0]],parentGrid:this.grid,parentModel:this.model,addStreamType:this.grid.options.addStreamType,getModelsBetweenPoints:_.bind(this.getModelsBetweenPoints,this),contextAlbumID:this.model.id}),this.childViews.songGrid.on("resized",this.childResized,this),this.childViews.songGrid.render()},childResized:function(){var e=Math.max(160,this.childViews.songGrid.$el.height()+30)+40;this.size!==e&&(this.size=e,this.tmpSize!=e&&(this.$el.outerHeight(e),this.tmpSize=null),this.trigger("resized"))},editAlbum:function(e){return n.router.setHash(this.model.toUrl("edit")),!1},onDropDownGearClick:function(e){return _.simpleAsyncMenu(e,this.model,{menuOpenParent:!0}),!1},onContextMenu:function(e){var t={onMouse:!0,shouldLog:!0,contextMenu:!0,ev:e,menuOpenParent:!0};return _.simpleAsyncMenu(e,this.model,t),!1},onBroadcastChange:function(){var e=this.$(".actions.primary").first(),t=r.model.get("user").get("currentBroadcastID");t?e.addClass("hide"):e.removeClass("hide")}},{estimateSize:function(e,t,n){var r=e.get("songs");return Math.max(160,r?r.length*51+30:0)+40}})}(),function(){n.Views.Modules.AlbumCellVertical=n.Views.Modules.Base.extend({className:"module module-cell album block grid-item",templateFile:"albumCellVertical",ui:{playBtn:".play",moreBtn:".more",overlay:".overlay",albumLink:".album-link",title:".title",img:".img",year:".year"},events:{"click @moreBtn":"clickMoreBtn"},modelEvents:{model:function(e){var t=e.get("AlbumID");this.$el.data("albumId",t),this.ui.$playBtn.data("albumId",t),this.ui.$albumLink.attr("href",e.toUrl())},"change:AlbumName":function(e){this.ui.$title.innerText(e.get("AlbumName"))},"change:CoverArtFilename":function(e){this.ui.$img.attr("src",e.getImageURL(142))},"change:Year change:IsVerified":function(e){var t=e.get("Year");e.get("IsVerified")&&t?(this.ui.$year.text(t),this.ui.$year.removeClass("hide")):this.ui.$year.addClass("hide")}},clickMoreBtn:function(e){var t=new ChainLoading;t.push(amdModules.requireDeferred("gs/views/tooltips/menu.js")),t.push(this.model.getMoreMenu()).done(_.bind(function(e){n.Views.Tooltips.Menu.openTooltip({items:e,$attached:this.ui.$moreBtn,$activeEl:this.ui.$moreBtn,width:175,positionSpill:"right",closeOnScroll:!0,sticky:!0})},this))}})}(),function(){n.Views.Modules.AlbumProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card album grid-item",cacheKey:"AlbumProfileCard",templateFile:"albumProfileCard",ui:{albumLink:".album-link",share:".btn.share",playDropdown:".play-dropdown",img:".img",metadata:".metadata"},modelEvents:{model:function(e){var t=e.get("AlbumID");this.$el.data("album",e).attr("id","album-"+t),this.ui.$albumLink.attr("href",e.toUrl()).data("albumId",t),this.ui.$share.data("albumId",t),this.ui.$playDropdown.data("albumId",t)},"change:CoverArtFilename":function(e){this.ui.$img.attr("src",e.getImageURL(120))},"change:AlbumName":function(e){this.ui.$albumLink.innerText(e.get("AlbumName"))},"change:ArtistID change:ArtistName":function(e){this.ui.$metadata.html(_.getString("ALBUM_BYLINE",{artist:'<a href="'+this.model.toArtistUrl()+'" class="metadata-link">'+this.model.get("ArtistName")+"</a>"}))}}})}(),function(){n.Views.Modules.PromotionAlbumCell=n.Views.Modules.Base.extend({className:"module module-cell promotionAlbum song grid-item",cacheKey:"PromotionAlbumCell",templateFile:"promotionAlbumCell",changeModelSelectors:{"&":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".album-link":function(e,t){var n=_.$one(t);n.data("albumId",this.model.get("AlbumID")),n.attr({title:this.model.escape("AlbumName"),href:this.model.get("albumURL")}),n.text(this.model.get("AlbumName"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.get("artistURL")).innerText(this.model.get("ArtistName")).attr("title",this.model.escape("ArtistName"))},".title":function(e,t){_.$one(t).innerText(this.model.get("AlbumName"))},".img":function(e,t){_.$one(t).attr("src",this.model.get("albumImage"))},".play":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))}},initialize:function(){this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.UserRowTall=n.Views.Modules.Base.extend({className:"module module-row user tall grid-item",cacheKey:"UserRowTall",templateFile:"userRowTall",events:{"click .user-broadcast-options":"onBroadcastOptionsClick","click .bc-give-ownership":"onGiveOwnershipClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data({artistId:null,userId:this.model.get("UserID")}).toggleClass("no-location",!this.model.get("Location")).toggleClass("favorited",!!this.model.get("isFavorite"))},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name")).data({artistId:null,userId:this.model.get("UserID")})},".img":function(e,t){_.$one(t).attr({src:this.model.getImageURL(40),alt:this.model.get("FName")})},".img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".favorite":function(e,t){var n=this.model.get("isFavorite"),r=n?"FOLLOWING":"FOLLOW";this.isArtist?_.$one(t).data({artistId:this.model.get("ArtistID"),userId:null}):_.$one(t).data({artistId:null,userId:this.model.get("UserID")}),_.$one(t).toggleClass("favorited btn-success",n).find(".label").text(_.getString(r))},".location":function(e,t){_.$one(t).text(this.model.get("Location"))},".row-actions.secondary":function(e,t){_.$one(t)[this.model.get("UserID")!=n.getLoggedInUserID()?"removeClass":"addClass"]("hide")},".user-broadcast-options":function(e,t){this.updateBroadcastBtn()},".badges-container":function(e,t){var r=this.childViews.badges;if(!r||r.destroyed||r.item.get("UserID")!==this.model.get("UserID"))r&&!r.destroyed&&r.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.$(".badges-container"),item:this.model}),this.childViews.badges.render()}},initialize:function(e){e&&e.endBroadcast&&(this.endBroadcastOnTransfer=e.endBroadcast),this.broadcast=this.options.broadcast,this.changeModelSelectors["&"].call(this,0,this.el),this._super.call(this,"initialize",e);if(this.artistBroadcast&&this.artistBroadcast.get("ArtistID")===this.model.get("contextArtistID")){var t=this,n=function(){t.off("rendered",n),_.defer(function(){t.handleModelChange()})};this.on("rendered",n)}this.broadcast&&this.on("rendered",_.bind(function(){this.updateBroadcastBtn(),this.broadcast.on("change:vipUsers",this.updateBroadcastBtn,this)},this))},updateBroadcastBtn:function(){var e=this.$(".user-broadcast-options"),t=this.model.get("UserID"),r=n.getLoggedInUserID();!this.options.showBroadcastOptions||this.endBroadcastOnTransfer?e.addClass("hide"):t===r||this.broadcast&&this.model===this.broadcast.getOwner()?e.addClass("hide"):this.broadcast&&this.broadcast.isLoggedInUserOwner()?e.removeClass("hide"):this.broadcast&&!this.broadcast.isUserVIP(t)&&this.broadcast.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_CHAT_MODERATE)?e.removeClass("hide"):e.addClass("hide")},onDestroy:function(){this.broadcast&&this.broadcast.off(null,null,this)},onBroadcastOptionsClick:function(e){var t=$(e.currentTarget),i=t.parents(".row-actions"),s=this.model,o=r.model.get("player").get("queue"),u=o?o.get("currentBroadcast"):null,a=!1,f;u&&(a=u.isUserVIP(this.model.get("UserID")),f=s.getBroadcastOptionMenu(u,this.endBroadcastOnTransfer),this.userMenuOptions={tooltipKey:"bcast-listener-menu",delay:0,width:a?260:175,positionSpill:"left",$attached:t,tooltipClass:"menu",model:s,items:f,$menuOpenEl:i},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){this.settingsTooltip=n.Views.Tooltips.Menu.openTooltip(this.userMenuOptions)},this)))},onGiveOwnershipClick:function(){function t(){n.trigger("lightbox:close","broadcastListeners")}var e=this.options.grid.options.broadcast;n.trigger("lightbox:open","broadcastTransferOwnership",{user:this.model,broadcast:e,endBroadcast:this.endBroadcastOnTransfer,onSuccess:t})}})}(),function(){n.Views.Modules.MutualFriendRow=n.Views.Modules.Base.extend({className:"module module-row user mutual-friend tall",cacheKey:"MutualFriendRow",templateFile:"mutualFriendRow",events:{"click .favorite":"clickFavorite"},ui:{title:".title",favoriteBtn:".favorite",favoriteLabel:"@favoriteBtn .label",favoriteIcon:"@favoriteBtn .icon",imgContainer:".img-container",img:".img",metadata:".metadata",metaInner:".meta-inner",title:".title"},modelEvents:{model:function(e){var t=e.get("UserID");this.$el.data("userId",t),this.ui.$favoriteBtn.data("userId",t),this.ui.$imgContainer.attr("href",e.toUrl())},"change:Name":function(e){this.ui.$title.attr("href",e.toUrl()).data("userId",e.get("UserID")).text(e.get("Name")),this.updateImage(e)},"change:Picture":function(e){this.updateImage(e)},"change:Location":function(e){var t=e.get("Location");this.ui.$metadata.toggleClass("has-byline",!!t),this.ui.$metaInner.text(_.getString("USER_BYLINE_2",{location:t}))},"change:isFavorite":function(e){e.get("isFavorite")?(this.ui.$favorite.addClass("btn-success"),this.ui.$favoriteLabel.attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")),this.ui.$favoriteIcon.removeClass("icon-plus").addClass("icon-check")):(this.ui.$favorite.removeClass("btn-success"),this.ui.$favoriteLabel.attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW")),this.ui.$favoriteIcon.removeClass("icon-check").addClass("icon-plus"))}},updateImage:function(e){this.ui.$img.attr({src:e.getImageURL(40),alt:e.escape("Name")})},clickFavorite:function(e){var t={userID:this.model.get("UserID"),index:this.options.grid.collection.indexOf(this.model)};this.model.get("isFavorite")||(t.userIsSelected=!0),n.trigger("guts:log","followButtonClicked",t)}})}(),function(){n.Views.Modules.SidebarUser=n.Views.Modules.Base.extend({className:"module sidebar-user grid-item",cacheKey:"SidebarUser",templateFile:"sidebarUser",changeModelSelectors:{"&":function(e,t){var n=this.model.get("currentBroadcastID");_.$one(t).toggleClass("in-bc",!!n),_.$one(t).toggleClass("now-playing",!n&&!!this.model.get("nowPlayingSong"))},".user-img-link":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data("userId",this.model.get("UserID"))},".user-img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(26))},".user-name":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".np-artist":function(e,t){var n=this.model.get("nowPlayingSong");n&&_.$one(t).innerText(n.get("ArtistName")).attr("href",n.toArtistUrl())},".np-song":function(e,t){var n=this.model.get("nowPlayingSong");n&&_.$one(t).innerText(n.get("SongName")).attr("href",n.toUrl())},".bc-link":function(e,t){var n=this.model.get("currentBroadcastID"),r=this.model.get("currentBroadcastOwner");n&&_.$one(t).attr("href",r?r.toUrl("broadcast"):this.model.toUrl("broadcast"))},".bc-title":function(e,t){this.model.get("currentBroadcastID")&&_.$one(t).innerText(this.model.get("currentBroadcastName"))},".bc-invite":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))}},initialize:function(e){this.$el.data({tooltipCacheKey:"sidebarUser"}),this._super.call(this,"initialize",e)},acceptDrop:function(e){if(e.draggedItemsType=="song"&&e.draggedItems[0].get("isCallout")||!(this.model instanceof n.Models.User))return!1;var t;return e.draggedItemsType==="song"&&e.draggedItems[0].hasOwnProperty("_wrapped")?t=e.draggedItems[0]._wrapped:t=e.draggedItems[0],n.trigger("lightbox:open","share",{service:"grooveshark",serviceLock:!0,toUserID:this.model.get("UserID"),type:e.draggedItemsType,model:t}),!0}})}(),function(){n.Views.Modules.SidebarArtist=n.Views.Modules.Base.extend({className:"module sidebar-artist grid-item",cacheKey:"SidebarArtist",templateFile:"sidebarArtist",changeModelSelectors:{"&":function(e,t){var n=this.model.get("Tags"),r=n&&n.at(0),i=r&&!_.isUndefined(r.get("Tag"));_.$one(t).toggleClass("favorited",this.model.get("isFavorite")).toggleClass("has-genre",!!i)},".img-container":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID")).attr("href",this.model.get("url"))},".user-img":function(e,t){_.$one(t).attr("src",this.model.get("imageURL"))},".artist-name":function(e,t){_.$one(t).attr("href",this.model.get("url")).innerText(this.model.get("ArtistName"))},".genre-title":function(e,t){var n=this.model.get("Tags"),r=n&&n.at(0),i=r&&r.get("Tag");_.$one(t).innerText(i)},".favorite":function(e,t){var n=this.model.get("isFavorite");_.$one(t).data("artistId",this.model.get("ArtistID")).toggleClass("btn-success",n).find(".icon").swapClasses("icon-check","icon-plus",n)}},initialize:function(e){this._super.call(this,"initialize",e),this.user=r.model.get("user");var t=e.activeSong,i=e.artist,s,o,u;t&&this.model.set({ArtistName:t.get("ArtistName"),ArtistID:t.get("ArtistID"),isFavorite:!!t.get("isFavorite"),url:t.toArtistUrl(),imageURL:_.getImageURL(n.Models.Artist.artPath+"40_artist.png")}),i&&(s=i.get("ArtistName"),o=i.get("ArtistID"),u=i.get("Tags"),s&&s!=="Unknown Artist"&&this.model.set({ArtistName:s}),o&&o>0&&this.model.set({ArtistID:o}),u&&u.at(0)&&this.model.set({Tags:u}),this.model.set({imageURL:i.getImageURL(40)})),this.model.get("ArtistName")&&this.model.get("ArtistID")&&e.parentModel.set("loading",!1),this.user.getFavoritesByType("Artists").done(_.bind(function(){if(this.destroyed)return;this.listenTo(this.user.get("favoriteArtists"),"add remove reset",this.updateFav),this.updateFav()},this))},updateFav:function(){this.model.set("isFavorite",!!this.user.get("favoriteArtists").get(this.model.get("ArtistID")))}})}(),function(){n.Views.Modules.SuggestedUserRowTall=n.Views.Modules.UserRowTall.extend({className:"module module-row user tall suggested",cacheKey:"SuggestedUserRowTall",templateFile:"suggestedUserRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))},".img-container":function(e,t){var n=_.$one(t);n.attr("href",this.model.toUrl()),n.data("userId",this.model.get("UserID"))},".img":function(e,t){_.$one(t).attr({src:this.model.getImageURL(70),alt:this.model.escape("Name")})},".title":function(e,t){var n=_.$one(t);n.attr("href",this.model.toUrl()),n.innerText(this.model.get("Name")),n.data("userId",this.model.get("UserID"))},".favorite":function(e,t){var n=_.$one(t),r=n.find(".icon");n.data("userId",this.model.get("UserID")),this.model.get("isFavorite")?(n.addClass("btn-success"),r.removeClass("icon-plus").addClass("icon-check")):(n.removeClass("btn-success"),r.removeClass("icon-check").addClass("icon-plus"))},".favorite .label":function(e,t){var n=this.model.get("isFavorite"),r=n?"UNFOLLOW":"FOLLOW";_.$one(t).text(_.getString(r)).data("translateText",r)},".followed-by":function(e,t){var r=this.model.get("followedByUserIDs"),i=null;if(this.renderedForID===this.model.id)return;this.renderedForID=this.model.id,_.each(_.shuffle(r),function(e){i=n.Models.User.getCached(e);if(i)return!1});if(!i||!r||!r.length){_.$one(t).addClass("hide"),this.$el.removeClass("has-metadata");return}_.$one(t).removeClass("hide"),this.$el.addClass("has-metadata"),_.$one(t).html(_.getString("FOLLOWED_BY_USER",{user:i.getAnchorTag()}))},".remove-suggestion":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))}}})}(),function(){n.Views.Modules.AnalyticsDigestFanRow=n.Views.Modules.Base.extend({className:"module module-row user tall grid-item analytics-digest-row",cacheKey:"AnalyticsDigestFanRow",templateFile:"analyticsDigestFanRow",changeModelSelectors:{"&":function(e,t){var n=!!this.model.get("Location");_.$one(t).data("userId",this.model.get("UserID")).toggleClass("no-location",!n)},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(40)).attr("alt",this.model.get("Name"))},".username":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data("user-id",this.model.get("UserID")).innerText(this.model.get("Name"))},".location":function(e,t){_.$one(t).text(this.model.get("Location"))},".stat .num":function(e,t){_.$one(t).innerText(_.addCommaSeparators(this.model.get("statsForDashboardColumns")))}}})}(),function(){n.Views.Modules.InviteUserCell=n.Views.Modules.Base.extend({className:"module module-cell invite-user grid-item",cacheKey:"InviteUserCell",templateFile:"inviteUser",changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID")),this.update()},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(30))}},initialize:function(){this.$el.data("userId",this.model.get("UserID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.update()},update:function(){var e=this.model.get("canBroadcastInviteEmail");e?(this.$el.removeClass("disabled"),this.disabled=!1):(this.$el.addClass("disabled"),this.disabled=!0)}})}(),function(){n.Views.Modules.InviteUserRow=n.Views.Modules.InviteUserCell.extend({className:"module module-row invite-user grid-item"})}(),function(){n.Views.Modules.BroadcastFriendUserCell=n.Views.Modules.Base.extend({className:"module module-cell bc-friend-user grid-item",cacheKey:"BroadcastFriendUserCell",templateFile:"bcFriendUser",events:{},changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))},".user-link":function(e,t){_.$one(t).attr("title",this.model.escape("Name")).attr("href",this.model.toUrl()).data("userId",this.model.get("UserID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(30))}},initialize:function(){this.$el.data("userId",this.model.get("UserID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.ShareUserCell=n.Views.Modules.InviteUserCell.extend({update:function(){}})}(),function(){n.Views.Modules.ArtistCell=n.Views.Modules.Base.extend({className:"module module-cell artist grid-item",cacheKey:"ArtistCell",templateFile:"artistCell",events:{"click .sample-artist":"onSampleArtistClick","click .remove-artist":"onRemoveArtistClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID")),this.editable?_.$one(t).addClass("editable"):_.$one(t).removeClass("editable")},".title":function(e,t){_.$one(t).innerText(this.model.get("ArtistName")).attr("href",this.model.toUrl())},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(500)).removeClass("hide")},".img-container":function(e,t){this.model.get("CoverArtFilename")?_.$one(t).removeClass("default"):_.$one(t).addClass("default")},".favorite":function(e,t){var n="FOLLOW",r,i;this.model.get("isFavorite")?(r="btn-success",n="FOLLOWING",i=""):(i="btn-success",r=""),_.$one(t).data("artistId",this.model.get("ArtistID")).attr("title",_.getString(n)).removeClass(i).addClass(r)},".favorite .icon":function(e,t){var n,r;this.model.get("isFavorite")?(n="icon-check",r="icon-plus"):(n="icon-plus",r="icon-check"),_.$one(t).removeClass(r).addClass(n)},".info":function(e,t){_.$one(t).toggleClass("hide",this.grid.options.hideInfo)},".bio":function(e,t){var n=this.model.get("ShortBio")||"",r=_.getString("ELLIPSIS")+' <a class="description-more" data-translate-text="ELLIPSIS_READ_MORE" data-artist-id="'+this.model.get("ArtistID")+'">'+_.getString("READ_MORE")+"</a>";if(!n){var i=this.model.get("pageNameData");i&&(n=i.Bio||"")}_.$one(t).innerText(n);while(_.$one(t).height()>100)_.$one(t).text(n=n.substr(0,n.lastIndexOf(" "))),_.$one(t).append(" "+r)},".tags":function(e,t){var n=this.model.get("Tags");n?this.fetchTemplate("/shared/genreTags").done(_.bind(function(e){_.$one(t).html(this.renderTemplate(e,{tags:n,noLinks:!0,hideSuggestTags:!0}))},this)):_.$one(t).empty()},".remove-artist":function(e,t){this.editable?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".followers":function(e,t){_.$one(t).toggleClass("hide",!this.model.get("followerCount")||this.grid.options.hideInfo)},".followers .num":function(e,t){var n=this.model.get("followers"),r=this.model.get("followerCount")||0;n&&(r=n.length),_.$one(t).innerText(_.addCommaSeparators(r))},".followers .label":function(e,t){var n=this.model.get("followers"),r=this.model.get("pageNameData"),i,s;n?i=n.length:r?i=r.FavoriteCount:i=0,s=i===1?"FOLLOWER":"FOLLOWERS",_.$one(t).innerText(_.getString(s)).data("translateText",s)},".overlay":function(e,t){var n=this.model.get("ShortBio")||"",r=this.model.get("Tags"),i=r?r.length:0,s;n||(s=this.model.get("pageNameData"),s&&(n=s.Bio||"")),_.$one(t).toggleClass("hide",!n&&!i||this.grid.options.hideInfo)}},initialize:function(e){var t=!1;this.$el.data("artist",this.model),e&&e.grid&&(this.grid=e.grid,this.grid.options.editable&&(t=!0)),this.editable=t,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},completeRender:function(){this._super.apply(this,["completeRender"].concat(_.toArray(arguments))),this.$(".img")[0].onerror=_.bind(this.onError,this)},onDropDownGearClick:function(e){var t=$(e.currentTarget),n=this.model;return!1},onError:function(e){$(e.target).attr("src",_.getImageURL(n.Models.Artist.artPath+"500_artist.png"))},onSampleArtistClick:function(e){this.model.getTopSongs().done(function(e){if(e&&e.length){var t=new n.Models.PlayContext,r=e.take(3);t.addStreamType(n.Models.PlayContext.TYPE_DFAULT),n.trigger("player:addSongs",r,n.Models.Player.playSpecialIndexes.DEFAULT,!0,t)}})},onRemoveArtistClick:function(){if(!this.editable)return;this.grid.collection.remove(this.model)}})}(),function(){n.Views.Modules.ArtistRowTall=n.Views.Modules.Base.extend({className:"module module-row tall artist grid-item",cacheKey:"ArtistRowTall",templateFile:"artistRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data({artist:this.model,artistId:this.model.get("ArtistID")})},".img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".btn.favorite":function(e,t){_.$one(t).toggleClass("btn-success",this.model.get("isFavorite")),_.$one(t).data("artistId",this.model.get("ArtistID"))},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).attr("class","icon icon-check white"):_.$one(t).attr("class","icon icon-plus")},".btn.favorite .favorite-label":function(e,t){this.changeFavoriteLabel(e,t)},".btn.use-artist":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".title":function(e,t){_.$one(t).innerText(this.model.get("ArtistName")).data("artistId",this.model.get("ArtistID"))},".img":function(e,t){_.$one(t).attr({src:this.model.getImageURL(40),alt:this.model.escape("ArtistName")})}},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},changeFavoriteLabel:function(e,t){this.model.get("isFavorite")?_.$one(t).attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")):_.$one(t).attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW"))}})}(),function(){n.Views.Modules.ArtistSelectRow=n.Views.Modules.ArtistRowTall.extend({className:"module module-row tall artist artist-select grid-item",cacheKey:"ArtistSelectRow",templateFile:"artistSelectRow",changeModelSelectors:_.extend({},n.Views.Modules.ArtistRowTall.prototype.changeModelSelectors,{".img-container":function(e,t){},".metadata":function(e,t){var n=this.model.get("pageNameData"),r=n&&n.FavoriteCount;_.$one(t).toggleClass("has-metadata",!!r)},".follower-count":function(e,t){var n=this.model.get("pageNameData"),r=n&&n.FavoriteCount;r?(_.$one(t).text(_.getStringPluralized("ONE_FOLLOWER","NUM_FOLLOWERS",r,{num:_.addCommaSeparators(r)})),_.$one(t).removeClass("hide")):_.$one(t).addClass("hide")}})})}(),function(){n.Views.Modules.ArtistProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card artist grid-item",cacheKey:"ArtistProfileCard",templateFile:"artistProfileCard",changeModelSelectors:{"&":function(e,t){this.pageNameData=this.model.get("pageNameData")||{},this.user=n.Models.User.getCached(this.model.get("profileID")),this.userPageNameData=this.user&&this.user.get("pageNameData")||{},_.$one(t).data("artist",this.model)},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("ArtistName"))},".btn.favorite":function(e,t){_.$one(t).toggleClass("btn-success",this.model.get("isFavorite")).data("artistId",this.model.get("ArtistID"))},".btn.favorite .icon":function(e,t){_.$one(t).swapClasses("icon-check","icon-plus",this.model.get("isFavorite"))},".btn.favorite .label":function(e,t){var n=this.model.get("isFavorite")?"FOLLOWING":"FOLLOW";_.$one(t).innerText(_.getString(n))},".metadata-link":function(e,t){var n=_.isUndefined(this.userPageNameData.FollowedCount);_.$one(t).attr("href",this.model.toUrl("followers")).toggleClass("hide",n)},".followers-num":function(e,t){_.$one(t).innerText(_.truncateNumber(this.userPageNameData.FollowedCount)||"-")},".followers-label":function(e,t){_.$one(t).innerText(_.getStringPluralized("FOLLOWER","FOLLOWERS",this.userPageNameData.FollowedCount))},".play-dropdown":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".tags":function(e,t){this.model.get("Tags")&&this.model.get("Tags").length?this.fetchTemplate("/shared/genreTags").done(_.bind(function(e){var r=_.clone(this.options);r.tags=new n.Models.Collections.Tags(this.model.get("Tags").first()),_.$one(t).html(this.renderTemplate(e,r))},this)):_.$one(t).addClass("hide")}},initialize:function(e){this.$el.data("artist",this.model).attr("id","artist-"+this.model.get("ArtistID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.PlaylistRow=n.Views.Modules.Base.extend({className:"module module-row playlist grid-item",cacheKey:"PlaylistRow",templateFile:"playlistRow",events:{click:"onModuleClick","click .repost":"onRepostClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".playlist-img":function(e,t){this.model.getPageImageURL().done(_.bind(function(e){_.$one(t).css("background-image","url("+e+")")},this))},".play":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".play-dropdown":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".title":function(e,t){_.$one(t).text(this.model.get("PlaylistName")).attr("href",this.model.toUrl()).data("playlistId",this.model.get("PlaylistID"))},".author":function(e,t){var n=this.options.bylineLocale||"BY_USER";_.$one(t).text(_.getString(n,{user:this.model.get("UserName")})).attr("href",this.model.toUserUrl())},".subscribers":function(e,t){var n=this.model.get("SubscriberCount");_.$one(t).toggleClass("hide",!n).text(n+" "+_.getStringPluralized("SUBSCRIBER","SUBSCRIBERS",n))},".tag-container":function(e,t){var n=this.model.get("Tag"),r=n&&n.get("Tag");_.$one(t).toggleClass("hide",!r)},".tag":function(e,t){var n=this.model.get("Tag"),r=n&&n.get("Tag");_.$one(t).toggleClass("hide",!r).text(r?r:"").attr("href",n&&n.toUrl())},".favorite":function(e,t){var r=this.model.get("UserID")===n.getLoggedInUserID(),i=this.model.get("isFavorite"),s=i?"SUBSCRIBED":"SUBSCRIBE";_.$one(t).toggleClass("hide",r).swapClasses("icon-check","icon-plus",i).attr("title",_.getString(s)).data("translateTitle",s)}},initialize:function(e){this.$el.toggleClass("no-tag",!this.model.get("Tag")),this._super.call(this,"initialize",e)},onRepostClick:function(e){e.preventDefault(),e.stopPropagation(),n.getLoggedInUserID()<1?this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_SHARE",_.bind(function(){this.onRepostClick(e)},this)):n.trigger("lightbox:open","share",{item:this.model})},onModuleClick:function(e){n.getAppMode()!=="desktop"&&(e.preventDefault(),e.stopPropagation(),n.router.setHash(this.model.toUrl()))}})}(),function(){n.Views.Modules.PlaylistRowMini=n.Views.Modules.Base.extend({className:"module module-row grid-item mini playlist-mini",cacheKey:"PlaylistRowMini",templateFile:"playlistRowMini",changeModelSelectors:{"&":function(e,t){_.$one(t).data("playlist",this.model)},".inner":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".play-dropdown":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".item-link":function(e,t){var n=this.options.grid&&this.options.grid.options&&this.options.grid.options.linkPathSuffix;_.$one(t).attr("href",this.model.toUrl(n))},".name":function(e,t){_.$one(t).innerText(this.model.get("PlaylistName"))}},acceptDrop:function(e){return n.Models.Playlist.acceptDrop(this.model,e)}})}(),function(){n.Views.Modules.BroadcastCell=n.Views.Modules.Base.extend({className:"module module-cell broadcast grid-item",cacheKey:"BroadcastCell",templateFile:"broadcastCell",events:{click:"onModuleClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcast",this.model),this.model.get("activeStatus")===0?_.$one(t).addClass("bc-inactive"):_.$one(t).removeClass("bc-inactive")},".join-toggle":function(e,t){var r=this.model.get("BroadcastID"),i=n.getCurrentBroadcastID()==r;_.$one(t).data("broadcastId",r)[(i?"add":"remove")+"Class"]("leave-broadcast")[(i?"remove":"add")+"Class"]("join-broadcast")},".join-toggle .label":function(e,t){var r=n.getCurrentBroadcastID()==this.model.get("BroadcastID"),i=r?"LEAVE":"LISTEN_NOW";_.$one(t).data("translateText",i).text(_.getString(i))},".title":function(e,t){this.model.get("activeStatus")===0?_.$one(t).removeAttr("href"):_.$one(t).attr("href",this.model.toUrl()),_.$one(t).attr("title",this.model.get("Name")).innerText(this.model.get("Name"))},".user-link":function(e,t){var r=this.model.getOwner();r instanceof n.Models.User?_.$one(t).data("userId",r.get("UserID")).innerText(r.get("Name")||""):_.$one(t).attr("href",r.toUrl()).innerText(r.get("ArtistName")||"")},".bc-img-container .img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(200))},".listeners":function(e,t){var r=this.model.get("BroadcastID"),i=n.getCurrentBroadcastID()==r;_.$one(t).toggleClass("hide",i)},".listeners .num":function(e,t){_.$one(t).innerText(_.truncateNumber(this.model.get("listenersCount"),1e4))},".listeners .label":function(e,t){_.$one(t).innerText(_.getStringPluralized("LISTENER","LISTENERS",this.model.get("listenersCount")))},".bc-now-playing":function(e,t){var n=this.model.get("activeSong");n?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".active-song":function(e,t){var n=this.model.get("activeSong");n?_.$one(t).html(_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:n.getAnchorTag(null,null,"link"),artist:this.model.get("activeSong").getArtistAnchorTag(null,null,"link")})):_.$one(t).html("N/A")},".tags":function(e,t){var r=$(t),i=this.model.get("Tag"),s=new n.Models.Collections.Tags;_.isObject(i)&&i.i?s.push({tag:i.n,tid:i.i}):s.push({tag:_.getString("DEFAULT_TAG"),tid:-1}),this.fetchTemplate("/shared/genreTags").always(_.bind(function(e){r.html(this.renderTemplate(e,{tags:s,hideSuggestTags:!0}))},this))},".genre-link":function(e,t){var n=this.model.get("Tag");n&&n.n!=="multi-genre"?_.$one(t).data({tag:n.n,tagId:n.i}).attr({"data-tag":n.n,"data-tag-id":n.i}):_.$one(t).data({tagId:null,tag:_.getString("DEFAULT_TAG")}).attr({"data-tag":_.getString("DEFAULT_TAG"),"data-tag-id":null})},".plays":function(e,t){var n=this.model.getOwner(),r=n&&n.get("estimatedBroadcastListens");_.isNumber(r)&&r!==0?_.$one(t).removeClass("hide").find(".num-plays").text(_.getStringPluralized("ONE_PLAY","NUM_PLAYS",r,{num:_.addCommaSeparators(r)})):_.$one(t).addClass("hide")},".followers":function(e,t){var n=this.model.getOwner(),r;n&&n.attributes.pageNameData&&n.attributes.pageNameData.FollowedCount?(r=_.toInt(n.attributes.pageNameData.FollowedCount),_.$one(t).removeClass("hide").find(".num-followers").text(_.getStringPluralized("ONE_FOLLOWER","NUM_FOLLOWERS",r,{num:_.addCommaSeparators(r)}))):_.$one(t).addClass("hide")},".start-time":function(e,t){_.$one(t).html(_.getString("STARTING_IN",{duration:_.getFormattedDate(this.model.get("TSCreated"))}))},".user-info":function(e,t){_.$one(t).toggleClass("hide",!!this.getOwner())},".user-img":function(e,t){var n=this.getOwner();_.$one(t).attr("src",n&&n.getImageURL(40))},".byline":function(e,t){var n=this.getOwner();_.$one(t).html(n&&n.getAnchorTag(!1,null,!0))}},initialize:function(e){var t=this.model.getOwner();this.$el.data("broadcast",this.model),this.followingInBroadcast=new n.Models.Collections.Users([]),e.grid&&e.grid.options.featuredBroadcasts&&this.$el.addClass("featured"),t&&this.updateOwner(this.model,{force:!0}),r.model.get("player").on("change:queue",this.onPlayerChange,this),r.model.get("user").getFavoritesByType("Users").done(_.bind(this.onFavoriteUsers,this)),this.onPlayerChange(),this._super("initialize",e)},onDestroy:function(){var e=this.model.getOwner(),t=r.model.get("user").get("favoriteUsers");r.model.off(null,null,this),this.queue&&this.queue.off(null,null,this),e&&e.off(null,null,this),t&&t.off(null,null,this)},completeRender:function(e,t){this._super("completeRender",e,t);var n=r.model.get("user"),i=this.model.getOwner();i===n&&this.$el.find(".join-toggle").addClass("hide")},onFavoriteUsers:function(){r.model.get("user").get("favoriteUsers").on("change:currentBroadcastID",this.onFollowingBroadcastChange,this)},onFollowingBroadcastChange:function(e,t){var r=this.model.get("BroadcastID"),i=e.previousAttributes().currentBroadcastID,s=this.$(".bc-friends"),o=this.$(".bc-friends-grid");t===r&&e.get("UserID")!==this.model.get("UserID")&&!this.followingInBroadcast.get(e.id)?this.followingInBroadcast.add(e):i===r&&this.followingInBroadcast.remove(e),this.followingInBroadcast.length?(this.bcFriendsGrid||(this.bcFriendsGrid=new n.Views.BroadcastFriendUserGrid({el:o[0],collection:this.followingInBroadcast}),this.childViews.push(this.bcFriendsGrid),this.bcFriendsGrid.render()),this.followingInBroadcast.length>5&&this.$(".plus-friends").text("+"+(this.followingInBroadcast.length-5)).removeClass("hide"),s.removeClass("hide")):s.addClass("hide")},onPlayerChange:function(){this.queue&&this.queue.off(null,null,this),this.queue=r.model.get("player").get("queue"),this.queue&&this.queue.on("change:currentBroadcast",this.forceModelChange,this),this.renderDfd&&this.forceModelChange()},changeModel:function(e){this.updateOwner(e),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))},updateOwner:function(e,t){var n=this.model&&this.model.getOwner(),r=e.getOwner(),i=t||{};if(n!==r&&!i.force)return;n&&n.off(null,null,this),r&&(r.on("change:pageNameData",this.forceModelChange,this),r.on("change:isFavorite",this.forceModelChange,this))},forceModelChange:function(){this._super("changeModel",this.model,{force:!0})},onModuleClick:function(e){n.getAppMode()!=="desktop"&&this.model.get("activeStatus")!==0&&(e.preventDefault(),e.stopPropagation(),n.router.setHash(this.model.toUrl()))}})}(),function(){n.Views.Modules.BroadcastRowLarge=n.Views.Modules.BroadcastCell.extend({className:"module module-row broadcast large grid-item",cacheKey:"BroadcastRowLarge",templateFile:"broadcastRowLarge",changeModelSelectors:{"&":function(e,t){var r=this.model.getOwner(),i=r&&r.get("UserID");r?_.$one(t).data("broadcast",this.model).toggleClass("bc-inactive",this.model.get("activeStatus")===0).toggleClass("bc-no-active-song",!this.model.get("activeSong")).toggleClass("not-owner",i!==n.getLoggedInUserID()).removeClass("hide"):_.$one(t).addClass("hide")},".bc-image":function(e,t){_.$one(t).toggleClass("no-count",!this.model.get("listenersCount"))},".bc-cover":function(e,t){_.$one(t).css("background-image","url("+this.model.getImageURL(120)+")")},".listeners .num":function(e,t){_.$one(t).text(_.truncateNumber(this.model.get("listenersCount"),1e4))},".listeners .label":function(e,t){var n=_.getStringPluralized("LISTENER","LISTENERS",this.model.get("listenersCount"));_.$one(t).text(n)},".bc-metadata .title":function(e,t){this.model.get("activeStatus")===0?_.$one(t).text(this.model.get("Name")).removeAttr("href"):_.$one(t).text(this.model.get("Name")).attr("href",this.model.toUrl())},".tag-name":function(e,t){var n=this.model.get("Tag"),r,i;n?(r=n.n?n.n:_.getString("DEFAULT_TAG"),i=_.cleanUrl(r,n.i,"genre",null)):(r=_.getString("DEFAULT_TAG"),i=""),_.$one(t).text(r).attr("href",i)},".broadcaster":function(e,t){var r=this.model.getOwner();if(!r)return;var i=r instanceof n.Models.User,s=i?'<a href="'+r.toUrl()+'" class="bc-link user-link show-user-tooltip" data-user-id="'+r.get("UserID")+'">'+r.escape("Name")+"</a>":'<a href="'+r.toUrl()+'" class="bc-link artist-link">'+r.escape("ArtistName")+"</a>",o=_.getString("BYLINE",{link:s});_.$one(t).html(o)},".plays":function(e,t){var n=this.model.get("totalListens")||this.model.get("PlayCount");_.$one(t).toggleClass("hide",!n).text(_.getStringPluralized("ONE_PLAY","NUM_PLAYS",n,{num:_.addCommaSeparators(n)}))},".album-art":function(e,t){var n=this.model.get("activeSong"),r=n&&n.getImageURL(40);_.$one(t).attr("src",r||"")},".bc-now-playing .song-name":function(e,t){var n=this.model.get("activeSong");_.$one(t).html(n&&n.getArtistAnchorTag(null,null,"bc-link"))},".bc-now-playing .artist-name":function(e,t){var n=this.model.get("activeSong");_.$one(t).html(n&&n.getAnchorTag(null,null,"bc-link",!0))},".bc-start-time .label":function(e,t){_.$one(t).text(_.getString("STARTING_IN",{duration:_.getFormattedDate(this.model.get("TSCreated"))}))},".join-toggle":function(e,t){var r=this.model.getOwner(),i=this.model.get("BroadcastID"),s=n.getCurrentBroadcastID()==i,o=s?"LEAVE":"LISTEN_NOW";_.$one(t).toggleClass("hide",this.model.isLoggedInUserOwner()).swapClasses("leave-broadcast","join-broadcast",s).data("broadcastId",i).data("userId",r&&r.get("UserID")).children(".label").data("translateText",o).text(_.getString(o))},".btn.favorite":function(e,t){var r=this.model.getOwner(),i=r&&r.get("UserID"),s=r&&r.get("ArtistID"),o=r&&r.get("isFavorite"),u=o?"FOLLOWING":s?"FOLLOW_ARTIST":"FOLLOW";this.$el.toggleClass("favorited",o),_.$one(t).toggleClass("btn-success",o).toggleClass("hide",!r||i===n.getLoggedInUserID()).data("userId",i).children(".label").text(_.getString(u)).data("translateText",u)},".btn.favorite .icon":function(e,t){var n=this.model.getOwner();_.$one(t).swapClasses("icon-check","icon-plus",n.get("isFavorite"))}}})}(),function(){n.Views.Modules.SuggestedBroadcastRow=n.Views.Modules.BroadcastCell.extend({className:"module module-row tall suggested-broadcast grid-item",cacheKey:"SuggestedBroadcastRow",templateFile:"suggestedBroadcastRow",initialize:function(e){e&&e.favoriteListeners&&(this.favoriteListeners=e.favoriteListeners),this.listenTo(n,"change:page",this.onPageChange),this.listenTo(this.model,"change:unreadChatActivities",this.onUnreadChatActivitiesChange),this.onUnreadChatActivitiesChange(),this.list=e.list,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},events:{"click .friends":"onFriendsClick","mouseover .friends":"onFriendsHover"},changeModelSelectors:_.extend({},n.Views.Modules.BroadcastCell.prototype.changeModelSelectors,{".music-playing":function(e,t){_.$one(t).toggleClass("hide",!this.model.get("isListener"))},".bc-notifs":function(e,t){var r=this.model.get("unreadChatActivities"),i=n.getCurrentBroadcast(),s;r&&i&&this.model.get("BroadcastID")==n.getCurrentBroadcast().get("BroadcastID")?(s=r.reject(function(e){return e.get("type")=="info"&&e.get("infoType")=="songChange"}),_.$one(t).toggleClass("hide",!s.length).text(s.length)):_.$one(t).addClass("hide")},".bc-link-overlay":function(e,t){this.model.get("activeStatus")===0?_.$one(t).removeAttr("href"):_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("Name"))},".user-link":function(e,t){var r=this.model.getOwner();r instanceof n.Models.User?_.$one(t).text(_.getString("BYLINE",{link:r.get("Name")||""})):_.$one(t).text(_.getString("BYLINE",{link:r.get("ArtistName")||""}))},".friends":function(e,t){var n=this.list.favoriteListeners&&this.list.favoriteListeners[this.model.id];n&&n.length?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".friend-count":function(e,t){var n=this.list.favoriteListeners&&this.list.favoriteListeners[this.model.id],r=n&&n.length;r&&_.$one(t).text(r<=99?r:"99+").removeClass("hide")}}),onUnreadChatActivitiesChange:function(){if(!this.model.get("isListener"))return;var e=this.model.get("unreadChatActivities");e&&this.listenTo(e,"add remove reset",_.debounce(function(){this.runChangeModelSelectors({".bc-notifs":this.changeModelSelectors[".bc-notifs"]})},500))},onPageChange:function(){var e=r.page&&r.page.currentPageView,t=e&&e.broadcastView&&e.broadcastView.broadcastID==this.model.get("BroadcastID");this.$el.toggleClass("active",!!t)},showFriendTooltip:function(e,t){amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;var r=$(e.currentTarget),i=this.list.favoriteListeners&&this.list.favoriteListeners[this.model.id],s=[],o={tooltipKey:"simple-user-tooltip",width:175,notch:!1,positionSpill:"right",$attached:r,tooltipClass:"simple-user-tooltip",sticky:!!t,fixed:!0};_.each(i,function(e){s.push({type:"module",module:new n.Views.Modules.SimpleUserRow({model:e})})}),o.items=s,this.childViews.friendTooltip=n.Views.Tooltips.Menu.openTooltip(o)},this))},onFriendsClick:function(e){this.showFriendTooltip(e,!0)},onFriendsHover:function(e){this.showFriendTooltip(e)}})}(),function(){n.Views.Modules.BroadcastRowMini=n.Views.Modules.Base.extend({className:"module module-row sidebar-broadcast grid-item mini",cacheKey:"BroadcastRowMini",templateFile:"broadcastRowMini",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcast",this.model)},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".item-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".name":function(e,t){_.$one(t).innerText(this.model.get("Name"))}},events:{contextmenu:"handleContextMenuClick"},acceptDrop:function(e){return!1},handleContextMenuClick:function(e){return e.preventDefault(),!1}})}(),function(){n.Views.Modules.ProfileSection=n.Views.Modules.Base.extend({className:"module section profile-section grid-item",cacheKey:"ProfileSection",templateFile:"profileSection",events:{"click .icon-up":"moveUp","click .icon-down":"moveDown","click .icon-edit":"edit"},changeModelSelectors:{".controls":function(e,t){_.$one(t).data("sectionId",this.model.get("id"))}},edit:function(){},moveUp:function(){var e=this.options.grid.collection.indexOf(this.model);e>0&&this.options.grid.collection.move(this.model,e-1)},moveDown:function(){var e=this.options.grid.collection.indexOf(this.model),t=this.options.grid.collection.length;e<t&&this.options.grid.collection.move(this.model,e+1)}})}(),function(){n.Views.Modules.EventRowTall=n.Views.Modules.Base.extend({className:"module module-row event tall grid-item",cacheKey:"EventRowTall",templateFile:"eventRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("eventId",this.model.get("EventID"))},".event-link":function(e,t){_.$one(t).attr("href",this.model.get("TicketsURL")).data("eventId",this.model.get("EventID")).innerText(this.model.get("EventName"))},".meta-inner":function(e,t){_.$one(t).innerText(this.model.get("VenueName")+" "+this.model.get("City"))},".month":function(e,t){_.$one(t).innerText(_.getDateFormatChars(this.model.get("StartTime")).M)},".day":function(e,t){_.$one(t).innerText(_.getDateFormatChars(this.model.get("StartTime")).j)}},initialize:function(e){this.$el.data("eventId",this.model.get("EventID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.StationRow=n.Views.Modules.Base.extend({className:"module module-row station grid-item",cacheKey:"StationRow",templateFile:"stationRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("tagId",this.model.get("TagID"))},".play-station":function(e,t){_.$one(t).data("tagId",this.model.get("TagID"))},".module-inner .play-station":function(e,t){_.$one(t).text(_.getString(this.model.get("StationTitle")))}},initialize:function(){this.$el.data("tagId",this.model.get("TagID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.Comment=n.Views.Modules.Base.extend({className:"module module-comment",cacheKey:"Comment",templateFile:"comment",events:{"click .respond-cta":"openResponseInput","click .delete-response-cta":"deleteResponse","click .report-response-cta":"reportResponse","click .comment-options":"onOptionClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("comment",this.model)},".author-image":function(e,t){var n=this.model.get("author");_.$one(t).attr("href",n.URL),_.$one(t).data("userId",n.UserID)},".author-image .user-img":function(e,t){_.$one(t).attr("src",this.model.get("author").getPicture(40))},".comment-details":function(e,t){_.$one(t).data("commentId",this.model.get("CommentID"))},".author-name":function(e,t){var n=this.model.get("author");_.$one(t).attr("href",n.URL),_.$one(t).data("userId",n.UserID),_.$one(t).text(n.Name)},".comment-message":function(e,t){_.$one(t).html(this.model.getMessage())},".comment-link":function(e,t){_.$one(t).data("commentId",this.model.get("CommentID")),_.$one(t).text(this.model.get("time")),this.isParentPage?_.$one(t).attr("href",this.model.toUrl()):_.$one(t).removeAttr("href")},".comment-original":function(e,t){_.$one(t).toggleClass("hide",!this.isParentPage),_.$one(t).html("&nbsp;"+this.model.getChildMetadata())},".label":function(e,t){var n=this.model.getResponsesCount()?"SHOW_REPLIES":"REPLY";_.$one(t).data("translateText",n).text(_.getString(n))},".response-count":function(e,t){_.$one(t).toggleClass("hide",!this.model.getResponsesCount())},".comment-replies-num":function(e,t){_.$one(t).text(this.model.getResponsesCount())},".response-row":function(e,t){_.$one(t).data("parentId",this.model.get("CommentID"))},".reply-author-image":function(e,t){_.$one(t).attr("src",this.getUserPicture(30))},".comment-badges-container":function(e,t){var r=this.model.get("user"),i=this.model.get("artist"),s=r?r.id:i.id,o=this.childViews.badges;if(!o||o.destroyed||o.item.id!==s)o&&!o.destroyed&&o.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.$(".comment-badges-container"),item:r||i}),this.childViews.badges.render()}},onDestroy:function(){this.model.get("Responses").off(null,null,this)},initialize:function(e){this.getUserPicture=_.orEqual(this.options.getUserPicture,_.bind(n.getLoggedInUserPicture,n)),this.isParentPage=this.model.get("ItemID")!=this.options.pageItemID||this.model.get("TypeID")!=this.options.pageTypeID,this.model.get("Responses").on("add",this.renderNewResponse,this),this.model.get("Responses").on("remove",this.removeResponse,this),this.model.on("commentRemoved",this.destroy,this),this._super.call(this,"initialize",e)},completeRender:function(e,t){if(this.isParentPage&&!this.model.getChildMetadata()){this.$el.addClass("empty");return}this.$el.removeClass("empty"),this._super.call(this,"completeRender",e,t),this.responseModules=[],this.$responsesEl=this.$el.find(".comment-responses"),this.renderResponses(),this.options.highlighted&&this.$el.addClass("reply").find(".comment-response-container").removeClass("hide"),this.options.showOptions===!1&&this.$el.find(".comment-options").addClass("hide")},changeModel:function(e){this.childViews.badges&&!this.childViews.badges.destroyed&&(this.childViews.badges.destroy(!1),this.childViews.badges=null),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))},renderResponses:function(){var e=this.model.get("Responses").length;if(!e)return;this.$responsesEl.empty();var t=[],r=this.responseModules;this.model.get("Responses").each(function(e){if(!e.get("author"))return;var i=new n.Views.Modules.CommentResponse({model:e});i.render(),r.push(i),t.push(i.$el[0])}),this.$responsesEl.append(t).show(),this.$el.find(".module-item-respond").show(),this.$el.find(".comment-replies-num").text(e)},renderNewResponse:function(e){if(!this.$responsesEl||!e.get("author"))return;var t=new n.Views.Modules.CommentResponse({model:e});t.render(),this.responseModules.push(t),this.$responsesEl.append(t.$el[0]).show(),this.$el.find(".module-item-respond").show()},removeResponse:function(e){if(!this.$responsesEl)return;var t=e.get("ResponseID");_.each(this.responseModules,function(e){e.model.get("ResponseID")===t&&e.destroy()});var n=this.model.get("Responses").length;this.$el.find(".comment-replies-num").text(n)},openResponseInput:function(e){e.preventDefault();var t=this.$el,n=function(){t.addClass("reply").find(".comment-response-container").removeClass("hide"),$(".reply-input",t).focus()};this.model.get("ResponsesLoaded")?n():this.model.loadResponses().done(_.bind(function(){this.renderResponses(),n()},this))},deleteResponse:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".response-row").data("response");n&&!t.hasClass("pending")&&n.deleteResponse().fail(function(){t.removeClass("pending")}),t.addClass("pending")},reportResponse:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".response-row").data("response");n&&!t.hasClass("pending")&&n.reportResponse().done(function(){t.replaceWith('<span class="module-footer-link">'+_.getString("REPORTED")+"</span>")}).always(function(){t.removeClass("pending")}),t.addClass("pending")},onOptionClick:function(e){var t=$(e.currentTarget);if(t.hasClass("menu-open")){n.trigger("tooltip:close","comments-context");return}amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;var e={width:175,$attached:t,tooltipKey:"comments-context"};e.items=this.getCommentMenuItems(t),n.Views.Tooltips.Menu.openTooltip(e),this.$el.addClass("active-context")},this))},getCommentMenuItems:function(e){var t=[],r=this.model,i=this.collection,s=r.get("author").UserID!=n.getLoggedInUserID(),o=this.options.parentItem.get("displayObject"),u=!s&&o;return u&&t.push({localeKey:"PRIVACY_SETTINGS",click:function(){n.router.setHash("/#!/settings/preferences")}}),u&&(s||r.canDelete())&&t.push({type:"divider"}),s&&t.push({localeKey:r.get("reportedByUser")?"REPORTED":"REPORT",click:function(){r&&!r.get("reportedByUser")&&r.reportComment().done(function(){r.set("reportedByUser",!0)})}}),r.canDelete()&&t.push({localeKey:"DELETE",click:_.bind(this.deleteComment,this)}),t},deleteComment:function(){var e=this.model;e.deleteComment().done(function(e){e||n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error"})}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error"})})}})}(),function(){n.Views.Modules.CommentResponse=n.Views.Modules.Base.extend({className:"module response-row",templateFile:"commentResponse",changeModelSelectors:{"&":function(e,t){_.$one(t).data("response",this.model)},".response-author-image":function(e,t){_.$one(t).attr("href",this.model.get("author").URL)},".response-author-image .user-img":function(e,t){_.$one(t).attr("src",this.model.get("author").getPicture(30))},".response-content":function(e,t){_.$one(t).data("responseId",this.model.get("ResponseID"))},".response-author-name":function(e,t){var n=this.model.get("author");_.$one(t).attr("href",n.URL),_.$one(t).text(n.Name)},".response-message":function(e,t){_.$one(t).html(this.model.getMessage())},".module-footer-time":function(e,t){_.$one(t).text(this.model.get("time"))},".report-response-cta":function(e,t){var r=this.model.get("author");_.$one(t).toggleClass("hide",r.UserID==n.getLoggedInUserID())},".delete-response-cta":function(e,t){_.$one(t).toggleClass("hide",!this.model.canDelete())},".response-badges-container":function(e,t){var r=this.model.get("user"),i=this.model.get("artist"),s=r?r.id:i.id,o=this.childViews.badges;if(!o||o.destroyed||o.item.id!==s)o&&!o.destroyed&&o.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.$(".response-badges-container"),item:r||i}),this.childViews.badges.render()}},changeModel:function(e){this.childViews.badges&&!this.childViews.badges.destroyed&&(this.childViews.badges.destroy(!1),this.childViews.badges=null),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.FeedEventComment=n.Views.Modules.Comment.extend({className:"module module-comment feed-event-comment",cacheKey:"FeedEventComment",templateFile:"feedEventComment",changeModelSelectors:{".user-img-container":function(e,t){var n=this.model.get("author");_.$one(t).attr("href",n.URL),_.$one(t).data("userId",n.UserID)},".user-img":function(e,t){_.$one(t).attr("src",this.model.get("author").getPicture(40))},".author-name":function(e,t){var n=this.model.get("author");_.$one(t).attr("href",n.URL),_.$one(t).data("userId",n.UserID),_.$one(t).text(n.Name)},".comment-message":function(e,t){_.$one(t).html(this.model.getMessage())},".comment-time":function(e,t){_.$one(t).text(this.model.get("time"))}},deleteComment:function(){var e=this.options.parentItem,t=this.model;if(!e)return n.Views.Modules.Comment.prototype.deleteComment.call(this);e.removeComment(t).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error"})})}})}(),function(){n.Views.Modules.TagProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card genre grid-item no-img",cacheKey:"TagProfileCard",templateFile:"tagProfileCard",changeModelSelectors:{"&":function(e,t){_.$one(t).data("tag",this.model)},".tag-name a":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data({tagId:this.model.id,tag:this.model.get("Tag")}).innerText(this.model.get("DisplayName"))},".artist-links":function(e,t){var n=this.model.getRandomArtists(3);for(var r=0,i=n.length;r<i;r++)n[r]=n[r].getAnchorTag();_.$one(t).html(n.join(", "))},".play-genre":function(e,t){_.$one(t).data({tag:this.model.get("Tag"),tagID:this.model.get("TagID")})}},initialize:function(e){this.$el.data("tag",this.model).attr("id","tag-"+this.model.get("TagID")),this.on("rendered",_.bind(function(){var e=this.$el.find(".artist-links");if(!e.length)return;var t=this.model.id;this.model.get("pageInfoLoaded")?this.changeModelSelectors[".artist-links"].call(this,0,e[0]):this.model.getArtists().done(_.bind(function(){this.model.id==t&&this.changeModelSelectors[".artist-links"].call(this,0,e[0])},this))},this)),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.Tag=n.Views.Modules.Base.extend({className:"module grid-item genre",cacheKey:"Tag",templateFile:"tag",events:{"click .remove":"onRemoveClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("tag",this.model)},".row-number":function(e,t){this.grid&&_.$one(t).text(this.grid.collection.indexOf(this.model)+1)},".title":function(e,t){_.$one(t).innerText(this.model.get("DisplayName")).data({tagId:this.model.id,tag:this.model.get("Tag")})}},onRemoveClick:function(e){if(!this.options||!this.options.removeTag)return;this.options.removeTag(this.model)}})}(),function(){n.Views.Modules.TagRow=n.Views.Modules.Base.extend({className:"module module-row tall genre grid-item",cacheKey:"TagRow",templateFile:"tagRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("tag",this.model)},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data({tagId:this.model.id,tag:this.model.get("Tag")}).innerText(this.model.get("DisplayName"))},".artist-links":function(e,t){this.model.getArtists().done(_.bind(function(){var e=this.model.getRandomArtists(3),n=_.map(e,function(e){return _.format('<span class="link-container">%s</span>',e.getAnchorTag())});_.$one(t).html(n)},this))}}})}(),function(){n.Views.Modules.TagRowSimple=n.Views.Modules.Base.extend({tagName:"a",className:"module grid-item tag-item",changeModelSelectors:{"&":function(e,t){_.$one(t).text(_.ucwords(this.model.get("DisplayName"),!0))}}})}(),function(){n.Views.Modules.ThemeCell=n.Views.Modules.Base.extend({className:"module module-cell theme grid-item",cacheKey:"ThemeCell",templateFile:"themeCell",user:null,events:{"click .theme-select":"onThemeClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("themeID",this.model.get("themeID"))},".theme-title":function(e,t){_.$one(t).innerText(this.model.get("title"))},".img":function(e,t){_.$one(t).attr("src","themes/"+this.model.get("location")+"/preview.jpg")},".theme-select":function(e,t){_.$one(t).data("themeId",this.model.get("themeID"))}},initialize:function(e){this.user=e.grid.user;var t=this.model.get("themeID");this.$el.data("themeID",t).attr("data-theme-id",t),t==e.grid.selected&&this.$el.addClass("active"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onThemeClick:function(e){var t=$(e.currentTarget),r=t.attr("data-theme-id");$("#page-content .save").removeClass("btn-success").removeClass("disabled"),$("#page-content .cancel").removeClass("disabled"),this.user.get("subscription").isPremium()?(n.trigger("theme:set",{themeID:r,temporary:!0}),$(".theme").removeClass("active"),$('.theme[data-theme-id="'+r+'"]').addClass("active")):n.trigger("lightbox:open","vipOnlyFeature")}})}(),function(){n.Views.Modules.AlbumEditor=n.Views.Modules.Base.extend({className:"module edit-entity-container album",cacheKey:"AlbumEditor",templateFile:"albumEditor",events:{"mousemove .button-upload-form":"uploadMousemove","change .uploader":"onNewUpload"},initialize:function(e){this.artist=e.artist,this.creatingNew=_.orEqual(e.creatingNew,!1),this.hideArt=_.orEqual(e.hideArt,!1),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=_.toArray(arguments);if(!this.creatingNew){var t=$.Deferred();return this.model.getAlbumDetails().done(_.bind(function(){this._super.apply(this,["render"].concat(e)).done(_.bind(t.resolve,t)).fail(_.bind(t.fail,t))},this)),t.promise()}return this._super.apply(this,["render"].concat(e))},submit:function(e){var t=new ChainLoading,r=$.Deferred(),i=this.$el.find(".album-name"),s=this.$el.find(".album-year"),o=this.$el.find(".album-type"),u=this.artist,a={},f={Name:i.val(),Year:_.toInt(s.val()),ReleaseType:_.toInt(o.val()),IsVerified:1,ArtistID:u.get("ArtistID"),ReleaseStatus:_.toInt(this.$el.find(".album-status:checked").val())};if(!f.Name||f.Name=="")return i.parent().addClass("field-error"),r.reject(0),r.promise();var l=s.val();if(l!==""&&f.Year<1900)return s.parent().addClass("field-error"),r.reject(0),r.promise();l===""&&(f.Year="");if(f.ReleaseStatus&&!f.ReleaseType)return o.parent().addClass("field-error"),r.reject(-1),r.promise();if(e)return r.resolve(f),r.promise();if(!this.creatingNew){var c=this.model;f.Name!==c.get("AlbumName")&&(a.changedAlbumName=!0),f.ReleaseType!==c.get("ReleaseType")&&(a.originalAlbumReleaseType=c.get("ReleaseType"),a.changedAlbumReleaseType=f.ReleaseType),f.Year!==c.get("Year")&&(a.originalAlbumReleaseYear=c.get("Year"),a.changedAlbumReleaseYear=f.Year),a.editedAlbum=c.get("AlbumID"),t.pushIgnoreFail(this.model.updateInfo(f).fail(t.bind(r.reject,r,1))),this.submitArtUpload(r,t,this.model),t.done(_.bind(r.resolve,r,this.model)),n.trigger("guts:log","editAlbum",a),_.gaTrackEvent("artist","editAlbum",c.get("AlbumID"))}else t.pushIgnoreFail(n.Services.API.artistCreateAlbum(f).done(t.bind(function(e){if(!e||!e.success){r.reject(1);return}f.AlbumID=_.toInt(e.albumID),f.ArtistName=u.get("ArtistName");var i=n.Models.Album.newOrUpdate(f);u.getAllAlbums().done(function(){u.get("albums").add(i)}),this.submitArtUpload(r,t,i),t.done(_.bind(r.resolve,r,i)),n.trigger("guts:log","createAlbum",{newAlbumID:f.AlbumID,onArtistID:u.get("ArtistID")}),_.gaTrackEvent("artist","newAlbum",u.get("ArtistID"))},this)).fail(t.bind(r.reject,r,1)));return r.promise()},submitArtUpload:function(t,r,i){var s=$("#upload-entity-art"),o=s.val();if(!this.hideArt&&o&&o.length){var u,a=new $.Deferred;r.pushIgnoreFail(a.fail(r.bind(t.reject,t,2)));var f=_.bind(function(e,t){switch(e){case"complete":i.set("CoverArtFilename",t.filename+"?"+(new Date).getTime()),$(".entity-art",this.$el).find("img").attr("src",i.getImageURL(120)),s.val(""),a.resolve(),n.trigger("guts:log","editAlbumArt",{editedAlbumID:i.get("AlbumID"),editedAlbumArtistID:i.get("ArtistID")}),_.gaTrackEvent("artist","editAlbumArt",i.get("ArtistID"));break;case"error":a.reject()}},this);if(e.FormData){u=new e.XMLHttpRequest;var l=new FormData;l.append("albumArt",s.data("file")),l.append("albumID",i.get("AlbumID")),u.addEventListener("load",function(e){var t=e.currentTarget.response;try{t=$.parseJSON(t)}catch(e){t=null}f&&t&&t.filename?f("complete",t):f("error",t)},!1),u.addEventListener("error",function(e){f&&f("error",e)},!1),u.open("POST","/upload.php?albumArt=1"),u.send(l)}else{var c="uploadAlbumArt_"+i.get("AlbumID"),h=c+"_Frame";e[c]=function(t){f&&(t&&t.filename?f("complete",t):f("error",t),_.defer(function(){$("#"+h).remove(),delete e[c]}))};var p=document.createElement("iframe");p.src="empty.html",p.id=h,p.name=h,p.setAttribute("style","visiblity: hidden; display: none;"),document.body.appendChild(p);var d=$(".button-upload-form",this.$el);d.find(".upload-albumID").val(i.get("AlbumID")),d.attr("action","/upload.php?albumArt=1&callback="+c).attr("target",h).submit()}}},uploadMousemove:function(e){typeof e.pageY=="undefined"&&typeof e.clientX=="number"&&document.documentElement&&(e.pageX=e.clientX+document.documentElement.scrollLeft,e.pageY=e.clientY+document.documentElement.scrollTop);var t=$(e.currentTarget),n=t.offset(),r=$(t).find(".uploader").removeClass("hide");r.css("top",e.pageY-n.top-Math.abs(r.height()/2)+"px"),r.css("left",e.pageX-n.left-Math.abs(r.width()-50)+"px")},onNewUpload:function(t){var n=$(t.currentTarget),r=t.target&&t.target.files?t.target.files:null,i;if(r&&r.item(0)){var s=r.item(0);s.getAsDataURL?i=s.getAsDataURL():e.URL&&e.URL.createObjectURL?i=e.URL.createObjectURL(s):e.webkitURL&&e.webkitURL.createObjectURL&&(i=e.webkitURL.createObjectURL(s)),n.data("file",s)}if(i){var o=$(".entity-art",this.$el).find("img").css({height:"auto",width:"auto",left:0,top:0}),u=function(){try{o.width()>o.height()?(o.css("height","120px"),o.css("left",-1*Math.floor((o.width()-120)/2)+"px")):(o.css("width","120px"),o.css("top",-1*Math.floor((o.height()-120)/2)+"px")),e.URL?e.URL.revokeObjectURL(this.src):e.webkitURL&&e.webkitURL.revokeObjectURL(this.src),o.off("load",u)}catch(t){}};o.on("load",u).attr("src",i)}var a=_.last(_.last(n.val().split("\\")).split("/"));$(".art-filename",this.$el).text(a)}})}(),function(){n.Views.Modules.UserArtistCell=n.Views.Modules.Base.extend({className:"module module-cell user-artist grid-item",cacheKey:"UserArtistCell",templateFile:"userArtistCell",events:{"click .sample-artist":"onSampleArtistClick","click .add":"onAddClick",mouseover:"onMouseover",mouseout:"onMouseout","mouseover .favorite":"onMouseoverFav"},changeModelSelectors:{"&":function(e,t){this.isLoggedInUser=this.model.id===n.getLoggedInUserID(),this.isArtist=this.model.get("isArtist")||!!this.model.get("ArtistID"),this.model.get("ArtistID")?_.$one(t).data({artistId:this.model.id,userId:null}):_.$one(t).data({userId:this.model.id,artistId:null}),this.isOnboardingCell&&_.$one(t).toggleClass("favorited",this.model.get("isFavorite")).toggleClass("favorite",!this.relatedArtistsGrid)},".inner":function(e,t){var r;this.isArtist?this.isOnboardingCell?r=!!n.Models.Tag.fixNameLookup[this.model.get("sampleTagID")]:r=!1:r=!!this.model.get("Location"),_.$one(t).toggleClass("has-info",r)},".title":function(e,t){this.isOnboardingCell||_.$one(t).attr("href",this.model.toUrl()),_.$one(t).text(this.model.get("ArtistName")||this.model.get("Name"))},".user-info":function(e,t){var r="",i=this.model,s;this.isArtist?this.isOnboardingCell?(r=n.Models.Tag.fixNameLookup[i.get("sampleTagID")],_.$one(t).data("translateText","").text(r)):i instanceof n.Models.User?i.getPageNameData().done(_.bind(function(e){if(this.model!==i)return;s=e.FollowedCount,_.$one(t).parent().toggleClass("has-info",s!==0),s!==0&&this.setArtistInfo(_.$one(t),s,r)},this)):(r=i.get("Tags"),r=r&&r.first()&&r.first().get("Tag")||"",s=i.get("followerCount"),s?this.setArtistInfo(_.$one(t),s,r):this.options.canRequestFollowers&&(_.$one(t).text("..."),i.getFollowers().done(_.bind(function(){if(this.model!==i)return;var e=i.get("followers");s=e&&e.length||0,this.setArtistInfo(_.$one(t),s,r)},this)))):_.$one(t).data("translateText","").text(this.model.get("Location"))},".img-container":function(e,t){_.$one(t).attr({href:this.model.toUrl(),title:this.model.get("Name")})},".img":function(e,t){_.$one(t).attr({src:this.model.getImageURL(this.imageSize),width:this.imageDisplaySize,height:this.imageDisplaySize})},".action":function(e,t){if(!this.relatedArtistsGrid){var n=this.model.get("isFavorite"),r=n?"UNFOLLOW":"FOLLOW";_.$one(t).data("translateTitle",r).removeData("tooltipText")}_.$one(t).swapClasses("add","favorite",this.relatedArtistsGrid).toggleClass("btn-success",this.relatedArtistsGrid?!!this.isAdded:n).toggleClass("hide",!!this.isLoggedInUser).data(this.model.get("ArtistID")?{artistId:this.model.id,userId:null}:{userId:this.model.id,artistId:null})},".action .icon":function(e,t){_.$one(t).swapClasses("icon-check","icon-plus",this.relatedArtistsGrid?!!this.isAdded:this.model.get("isFavorite"))},".sample-artist":function(e,t){var n=this.model.get("ArtistID");_.$one(t).toggleClass("hide",!n),n&&_.$one(t).data({artistId:this.model.id})},".badges-container":function(e,t){var r=this.childViews.badges;if(!r||r.destroyed||r.item.get("UserID")!==this.model.get("UserID"))r&&!r.destroyed&&r.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.$(".badges-container"),item:this.model}),this.childViews.badges.render()},".top-artists":function(e,t){var n=_.$one(t).find(".items"),r=this.model.get("topArtists"),i;r?(i=_.map(r.take(5),function(e){return'<span class="item">'+e.get("ArtistName")+"</span>"}),_.$one(t).removeClass("hide"),n.html(i)):(_.$one(t).addClass("hide"),n.html(""))},".top-genres":function(e,t){var n=_.$one(t).find(".items"),r=this.model.get("personalizedTags"),i;r?(i=_.map(r.take(5),function(e){return'<span class="item">'+e.get("DisplayName")+"</span>"}),_.$one(t).removeClass("hide"),n.html(i)):(_.$one(t).addClass("hide"),n.html(""))}},initialize:function(e){var t=e.grid&&e.grid.options;t&&t.isOnboardingGrid?(this.isOnboardingCell=!0,this.relatedArtistsGrid=t.relatedArtistsGrid,this.imageSize=120,this.imageDisplaySize=90,this.$el.addClass("user-artist-follow favorite")):(this.imageSize=70,this.imageDisplaySize=60),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDestroy:function(){clearTimeout(this.timeout)},changeModel:function(e){this.childViews.badges&&!this.childViews.badges.destroyed&&(this.childViews.badges.destroy(!1),this.childViews.badges=null),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))},onSampleArtistClick:function(e){e.stopPropagation();if(!this.isArtist)return;this.model instanceof n.Models.User?n.Models.Artist.get($(e.currentTarget).data("artistId")).done(_.bind(function(e){this.getArtistTopSongs(e)},this)):this.getArtistTopSongs(this.model)},getArtistTopSongs:function(e){e.getTopSongs().done(function(e){if(e&&e.length){var t=new n.Models.PlayContext,e=e.take(3);t.addStreamType(n.Models.PlayContext.TYPE_DFAULT),n.trigger("player:addSongs",e,n.Models.Player.playSpecialIndexes.DEFAULT,!0,t)}})},setArtistInfo:function(e,t,n){var r="",i="";t>0&&(r='<span class="meta-text">'+_.getStringPluralized("ONE_FOLLOWER","NUM_FOLLOWERS",t,{num:t})+"</span>"),n.length&&(i+='<span class="meta-text">'+n+"</span>"),e.html(r+i).parent(".inner").toggleClass("has-info",!!r||!!i)},onAddClick:function(e){e.stopPropagation(),this.isAdded=!this.isAdded,this.options.grid.options.onAddClick(e,this.isAdded),this.runChangeModelSelectors()},onMouseover:function(e){return},onMouseoverFav:function(e){n.Views.Application.titleTooltipHelper(e)},onMouseout:function(e){this.isOnboardingCell&&this.model instanceof n.Models.User&&clearTimeout(this.timeout)},loadMoreDetails:function(){var e=new ChainLoading;if(this.detailsLoading)return;this.detailsLoading=!0,this.$el.addClass("loading-details"),e.pushIgnoreFail(this.model.getTopArtists()),e.pushIgnoreFail(this.model.getPersonalizedTags()),e.done(_.bind(function(){this.$el.removeClass("loading-details")},this))}})}(),function(){n.Views.Modules.OnlineUserCell=n.Views.Modules.Base.extend({className:"module module-cell user-artist online-user grid-item",templateFile:"onlineUserCell",imageSize:70,imageDisplaySize:60,ui:{inner:".inner",title:".title",imgContainer:".img-container",img:"@imgContainer .img",badgesContainer:".online-user-badges",nowPlayingArtist:".np-artist",nowPlayingLinks:".np-links",nowPlayingSong:".np-song",broadcastLink:".bc-link",broadcastTitle:".bc-title"},modelEvents:{model:function(e){var t=e.get("Name"),r=e.get("nowPlayingSong"),i=e.get("currentBroadcastID");this.isLoggedInUser=e.id===n.getLoggedInUserID(),this.isArtist=e.get("isArtist")||!!e.get("ArtistID"),this.ui.$imgContainer.attr({href:e.toUrl(),title:t}),this.ui.$img.attr({src:e.getImageURL(this.imageSize),width:this.imageDisplaySize,height:this.imageDisplaySize}),this.ui.$inner.toggleClass("has-info",!!i||!!r),this.ui.$nowPlayingLinks.toggleClass("hide",!!i||!r),this.renderBadges(e)},"change:ArtistID":function(e){var t=e.get("Name");e.get("ArtistID")?this.ui.$title.data({artistId:e.id,userId:null}).attr("href",e.toUrl()).text(e.get("ArtistName")):this.ui.$title.data({userId:e.id,artistId:null}).attr("href",e.toUrl()).text(t)},"change:currentBroadcastID":function(e){var t=e.get("currentBroadcastID"),n=e.get("currentBroadcastOwner");t?(this.ui.$broadcastLink.removeClass("hide").attr("href",n?n.toUrl("broadcast"):e.toUrl("broadcast")),this.ui.$broadcastTitle.innerText(e.get("currentBroadcastName"))):this.ui.$broadcastLink.addClass("hide")},"change:nowPlayingSong":function(e){var t=e.get("nowPlayingSong");t&&(this.ui.$nowPlayingArtist.innerText(t.get("ArtistName")).attr("href",t.toArtistUrl()),this.ui.$nowPlayingSong.innerText(t.get("SongName")).data("songId",t.get("SongID")))}},renderBadges:function(e){var t=this.childViews.badges;if(!t||t.destroyed||t.item.get("UserID")!==this.model.get("UserID"))t&&!t.destroyed&&t.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.ui.$badgesContainer,item:e}),this.childViews.badges.render()}})}(),function(){n.Views.Modules.UserArtistVerticalCell=n.Views.Modules.Base.extend({className:"module module-cell user-artist-vertical grid-item",cacheKey:"UserArtistVerticalCell",templateFile:"userArtistVerticalCell",changeModelSelectors:{"&":function(e,t){var r;this.model instanceof n.Models.User?(_.$one(t).data({userId:this.model.id,artistId:null}),r=!!this.model.get("Location")):(_.$one(t).data({artistId:this.model.id,userId:null}),this.isOnboardingCell?r=!!n.Models.Tag.fixNameLookup[this.model.get("sampleTagID")]:r=!0),this.isOnboardingCell&&_.$one(t).toggleClass("favorited",this.model.get("isFavorite")),_.$one(t).toggleClass("has-info",r)},".img-container":function(e,t){_.$one(t).attr({href:this.model.toUrl(),title:this.model.get("Name")})},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(142))},".btn":function(e,t){_.$one(t).toggleClass("btn-success",this.model.get("isFavorite")),this.model instanceof n.Models.User?_.$one(t).toggleClass("hide",this.model.id==n.getLoggedInUserID()).removeAttr("data-artist-id").attr("data-user-id",this.model.id).data({userId:this.model.id,artistId:null}):_.$one(t).removeAttr("data-user-id").attr("data-artist-id",this.model.id).data({artistId:this.model.id,userId:null})},".btn .icon":function(e,t){_.$one(t).swapClasses("icon-check","icon-plus",this.model.get("isFavorite"))},".title":function(e,t){this.isOnboardingCell||_.$one(t).attr("href",this.model.toUrl()),this.model instanceof n.Models.User?_.$one(t).innerText(this.model.get("Name")):_.$one(t).innerText(this.model.get("ArtistName"))},".user-info":function(e,t){this.model instanceof n.Models.User?_.$one(t).data("translateText","").innerText(this.model.get("Location")):this.isOnboardingCell?_.$one(t).data("translateText","").innerText(n.Models.Tag.fixNameLookup[this.model.get("sampleTagID")]):_.$one(t).data("translateText","ARTIST").innerText(_.getString("ARTIST"))}}},{estimateSize:function(e,t){return t.$el.find(".module").first().height()}})}(),function(){n.Views.Modules.OwnerRow=n.Views.Modules.Base.extend({className:"module module-row owner",templateFile:"ownerRow",ui:{img:".img",imgContainer:".img-container",inner:".inner",onlineIndicator:".online-indicator",broadcastBtn:".current-broadcast",broadcastBtnIcon:"@broadcastBtn .icon",broadcastBtnLabel:"@broadcastBtn .label",favoriteBtn:".favorite",favoriteBtnIcon:"@favoriteBtn .icon",favoriteBtnLabel:"@favoriteBtn .label",badgesContainer:".badges-container",title:".title",country:".country",followers:".followers",followersNum:"@followers .num",followersLabel:"@followers .label"},initialize:function(e){this.showFollowBtn=e.showFollowBtn,this.showBroadcastJoin=e.showBroadcastJoin,this.user=n.Models.AuthUser.getCached(n.getLoggedInUserID()),this.listenTo(this.user,"change:currentBroadcastID",this.renderBroadcastBtn),n.Views.Modules.Base.prototype.initialize.call(this,e)},modelEvents:{model:function(){this.renderBadges()},"change:followers change:pageNameData change:Country":function(e){var t=e.get("followers"),n=e.get("pageNameData"),r,i;t?r=t.length:n?r=n.FollowedCount||n.FavoriteCount:r=0,i=r===1?"FOLLOWER":"FOLLOWERS",this.ui.$followers.toggleClass("hide",!r),this.ui.$followersNum.innerText(_.truncateNumber(r)),this.ui.$followersLabel.innerText(_.getString(i)).data("translateText",i)},"change:Country":function(e){var t=e.get("Country");this.ui.$country.data("translateText","").innerText(t)},"change:currentBroadcastID":function(){this.renderBroadcastBtn()},"change:broadcastOwnerAvailability":function(e){var t=["online","idle","away","offline"],n=[],r=e.get("broadcastOwnerAvailability"),i=_.indexOf(t,r),s="";i>=0&&(n=t.splice(i,1),this.ui.$onlineIndicator.addClass(n[0]),s=String(n[0]||"").toUpperCase()),this.ui.$onlineIndicator.removeClass(t.join(" ")).data("translateText",s)},"change:isFavorite":function(e){var t=e.get("isFavorite"),n=e.get("UserID"),r=e.get("ArtistID"),i=t?"UNFOLLOW":"FOLLOW";this.ui.$favoriteBtn.toggleClass("hide",!this.showFollowBtn).toggleClass("btn-success",!!t).toggleClass("helper-tooltip",!!t).data({artistID:r,userID:n}).data("translateTitle","UNFOLLOW"),this.ui.$favoriteBtnLabel.text(_.getString(i)).data("translateText",i),this.ui.$favoriteBtnIcon.swapClasses("icon-check","icon-plus",t)},"change:Name change:ArtistName change:Picture":function(e){var t=e.get("Name")||e.get("ArtistName"),n=e.getImageURL(70),r=e.toUrl();this.ui.$title.attr("href",r).text(t),this.ui.$imgContainer.attr({href:r,title:t}),this.ui.$img.attr("src",n)},"change:sampleTagID change:Location":function(e){var t=e.get("sampleTagID"),n=e.get("Location"),r;this.isArtist?r=!1:r=!!n,this.ui.$inner.toggleClass("has-info",r)}},renderBroadcastBtn:function(){if(!this.rendered)return;var e=this.model.get("currentBroadcastID"),t=e&&this.user&&this.user.get("currentBroadcastID")===e,n=t?"LEAVE_BROADCAST":"JOIN_LIVE_BROADCAST";this.ui.$broadcastBtn.toggleClass("hide",!this.showBroadcastJoin||!e).swapClasses("leave-broadcast","join-broadcast",t).data("broadcastId",e),this.ui.$broadcastBtnIcon.swapClasses("icon-x","icon-broadcast",t),this.ui.$broadcastBtnLabel.text(_.getString(n)).data("translateText",n)},renderBadges:function(){var e=this.childViews.badges;e&&!e.destroyed&&(this.childViews.badges.destroy(!1),this.childViews.badges=null);if(!e||e.destroyed||e.item.get("UserID")!==this.model.get("UserID"))e&&!e.destroyed&&e.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.ui.$badgesContainer,item:this.model}),this.childViews.badges.render()}})}(),function(){n.Views.Modules.SuggestedFriends=n.Views.Modules.Base.extend({className:"card suggested-friends",cacheKey:"SuggestedFriends",templateFile:"suggestedFriends",defaultVisibleCount:6,events:{"click .remove-suggestion":"hideSuggestion","click .remove-card":"onClose"},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.visibleCount=_.orEqual(e.visibleCount,this.defaultVisibleCount)},render:function(){var e=_.toArray(arguments),t=new ChainLoading,n=$.Deferred();return t.fail(_.bind(n.reject,n)),t.push(this.model.getFavoritesByType("Users")),t.push(this.model.getRecommendedUsers().done(t.bind(this.onRecommendedUsers,this))),t.push(this._super.apply(this,["render"].concat(e)).done(t.bind(this.renderRecommendedUsers,this))),t.done(_.bind(function(){this.$el.toggleClass("hide",!this.recommendations.length),n.resolve(this.recommendations)},this)),n.promise()},onClose:function(){_.isFunction(this.options.onClose)&&this.options.onClose()},onRecommendedUsers:function(e){if(!e||!e.models)return;var t=this.model.get("favoriteUsers");t?(e=_.difference(e.models,t.models),t.on("add",this.onNewFavoriteUser,this)):e=e.models,e=_.shuffle(e),this.recommendations=new n.Models.Collections.Users(e)},renderRecommendedUsers:function(){if(!this.recommendations||!this.recommendations.models||!this.recommendations.length)return;var e=[],t=this.$(".grid");while(this.recommendations.length&&e.length<this.visibleCount)e.push(this.recommendations.shift());e=new n.Models.Collections.Users(e),this.childViews.grid=new n.Views.SuggestedUserGridTall({el:t,collection:e}),this.visibleUserIDs=e.pluck("UserID"),this.childViews.grid.render()},onNewFavoriteUser:function(e){if(!this.childViews.grid||_.indexOf(this.visibleUserIDs,e.id)===-1)return;_.delay(_.bind(this.removedSuggestion,this,e.id),2e3)},hideSuggestion:function(e){var t=$(e.currentTarget),r=t.data("userId");r&&n.Services.API.userHideRecommendedUser(r).done(_.bind(this.removedSuggestion,this,r)).fail(function(){n.trigger("notification:add",{description:_.getString("ERROR_HIDE_SUGGESTION"),type:"error",duration:5e3})})},removedSuggestion:function(e){this.childViews.grid.collection.remove(e),this.recommendations.remove(e);if(this.recommendations.length&&this.childViews.grid.collection.length<this.defaultVisibleCount){var t=this.recommendations.shift();this.childViews.grid.collection.add(t),this.visibleUserIDs.push(t.id)}}})}(),function(){n.Views.Modules.BroadcastRowTall=n.Views.Modules.Base.extend({className:"module module-row broadcast tall grid-item",cacheKey:"BroadcastRowTall",templateFile:"broadcastRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID")),this.model.get("activeStatus")===1?_.$one(t).removeClass("inactive"):_.$one(t).addClass("inactive")},".img":function(e,t){_.$one(t).attr({src:this.model.getImageURL(40),attr:this.model.escape("Name")})},".join-toggle":n.Views.Modules.BroadcastRowLarge.prototype.changeModelSelectors[".join-toggle"],".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".broadcaster":function(e,t){var n=this.model.getOwner();_.$one(t).attr("href",n.toUrl()).innerText(n.get("Name"))},".listeners":function(e,t){var n=_.toInt(this.model.get("PeakSubscribers")||this.model.get("listenersCount"));_.$one(t).html(_.getStringPluralized("ONE_LISTENER","NUM_LISTENERS",n,{num:n}))},".byline":function(e,t){var n=this.model.getOwner();_.$one(t).html(_.getString("BY_USER",{user:'<a href="'+n.toUrl()+'" class="broadcaster meta-text helper-tooltip-measured">'+n.escape("Name")+"</a>"}))}},initialize:function(e){this.$el.data("broadcastId",this.model.get("BroadcastID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.BroadcastRow=n.Views.Modules.Base.extend({className:"module module-row broadcast grid-item",cacheKey:"BroadcastRow",templateFile:"broadcastRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".bc-link":function(e,t){_.$one(t).attr("href",this.model.toUrl(!0)).innerText(_.getFormattedDate(this.model.get("TSCreated")))}},initialize:function(e){this.$el.data("broadcastId",this.model.get("BroadcastID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}})}(),function(){n.Views.Modules.BroadcastGroupRow=n.Views.Modules.Base.extend({className:"module broadcast-group-row",cacheKey:"BroadcastGroupRow",templateFile:"broadcastGroupRow",events:{"click .show-all":"showAllBroadcasts"},changeModel:function(e){this._super.apply(this,["changeModel"].concat(_.toArray(arguments))),this.model.get("broadcasts").length>this.model.get("visibleBroadcasts").length?this.model.set("shownAll",!1,{silent:!0}):this.model.set("shownAll",!0,{silent:!0})},changeModelSelectors:{"&":function(e,t){var r=this.model.get("broadcasts"),i=this.model.get("visibleBroadcasts"),s=this.constructor.estimateSize(this.model);_.$one(t).toggleClass("shown-all",this.model.get("shownAll")),this.size!==s&&this.tmpSize!==s&&(_.$one(t).outerHeight(s),this.tmpSize=s),this.broadcastGrid?(i&&this.broadcastGrid.collection.reset(i.models),this.broadcastGrid.options.playContext=new n.Models.PlayContext(this.model)):this.rendered&&this.makeChildGrid()},".bc-name":function(e,t){var n=this.model.get("broadcasts"),r=n.first().get("Name");n.length>1?_.$one(t).removeAttr("href").addClass("no-link"):_.$one(t).attr("href",n.first().toUrl(!0)).removeClass("no-link"),_.$one(t).innerText(r)},".bc-cover":function(e,t){_.$one(t).css("background-image","url("+this.model.get("BroadcastImage")+")")},".tag-container":function(e,t){var n=this.model.get("Tag"),r=n&&n.get("Tag");_.$one(t).toggleClass("hide",!r)},".tag-name":function(e,t){var n=this.model.get("Tag"),r=n&&n.get("Tag");_.$one(t).text(r?r:"").attr("href",n&&n.toUrl())},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("broadcasts").first().get("BroadcastID"))},".show-all .label":function(e,t){var n=this.model.get("broadcasts").length-this.model.get("visibleBroadcasts").length;_.$one(t).text(_.getStringPluralized("MORE_BROADCASTS","MORE_BROADCASTS_PLURAL",n,{count:n}))}},initialize:function(e){var t=this.model.get("broadcasts"),n=this.model.get("visibleBroadcasts");this.model.set("shownAll",t.length>n.length?!1:!0,{silent:!0}),this.model.get("shownAll")?this.$el.addClass("shown-all"):this.$el.removeClass("shown-all"),this._super.call(this,"initialize",e)},destroy:function(e){this._super.call(this,"destroy",e),this.rendered=!1,this.broadcastGrid&&this.broadcastGrid.off(null,null,this)},completeRender:function(e){this._super.apply(this,["completeRender"].concat(_.toArray(arguments))),this.rendered=!0,_.defer(_.bind(this.makeChildGrid,this))},makeChildGrid:function(){var e=this.$(".broadcast-grid"),t=this.model.get("broadcasts"),r=this.model.id;this.broadcastGrid&&(this.stopListening(this.broadcastGrid.selectedItems),this.stopListening(this.broadcastGrid),this.broadcastGrid.destroy(!1)),t.comparator=function(e){return e.attributes.TSCreated*-1},t.sort(),this.broadcastGrid=new n.Views.BroadcastDateGrid({el:e,collection:new n.Models.Collections.Broadcasts(this.model.get("visibleBroadcasts").models),playContext:new n.Models.PlayContext(this.model),header:!1,parentGrid:this.grid,parentModel:this.model,addStreamType:this.grid.options.addStreamType}),this.broadcastGrid.on("resized",this.childResized,this),this.broadcastGrid.render(),this.childViews.push(this.broadcastGrid)},showAllBroadcasts:function(e){this.model.get("visibleBroadcasts").reset(this.model.get("broadcasts").models),$(e.currentTarget).addClass("hide"),this.model.set("shownAll",!0),n.trigger("page:redrawUpdate")},childResized:function(){var e=this.model.get("broadcasts"),t=this.constructor.estimateSize(this.model);this.size!==t&&(this.size=t,this.tmpSize!==t&&(this.$el.outerHeight(t),this.tmpSize=null),this.trigger("resized"))}},{estimateSize:function(e){var t=e.attributes.visibleBroadcasts,n=30,r=70,i=t.length*39;return n+r+i}})}(),function(){var e,t;n.Views.Modules.ChatActivity=n.Views.Modules.Base.extend({className:"module chat-activity",cacheKey:"ChatActivity",templateFile:"chatActivity",events:{"click .upvote-btn":"onUpvoteClick","click .downvote-btn":"onDownvoteClick","click .approve-btn":"onApproveClick","click .dropdown":"onBroadcastUserOptionsClick","click .enable-chat":"onEnableChatClick","mouseenter .helper-tooltip":"showHelperTooltip",click:"clickChatMessage","click .play":"onPlayClick","click .invite-from-chat":"clickInviteLink"},changeModelSelectors:{"&":function(e,t){var n=this.model.get("type"),r=n!==this.type,i=this.model.get("user");_.$one(t).data("chatActivityId",this.model.get("ChatActivityID")),i?_.$one(t).data({model:i,userId:i.get("UserID")}):(_.$one(t).removeData("model"),_.$one(t).removeData("userId")),this.update(!r)},".img":function(e,t){var r,i=this.model.get("infoType");this.model.get("type")==="message"?(r=this.model.get("user")||this.model.get("artist"),_.$one(t).addClass("user-img")):!i||i!==n.Models.ChatActivity.SONGS_ADDED_BY_VIP&&i!==n.Models.ChatActivity.SONG_ADDED_BY_VIP?(r=this.model.get("song"),_.$one(t).removeClass("user-img")):(r=this.model.get("user"),_.$one(t).addClass("user-img")),r?_.$one(t).removeClass("hide").attr("src",r&&r.getImageURL(30)||""):_.$one(t).addClass("hide")},".username-container":function(e,t){this.model.get("type")==="message"&&this.model.get("user")?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".username":function(e,t){var n;this.model.get("type")==="message"&&(n=this.model.get("user"),n&&_.$one(t).data("userId",n.get("UserID")).attr("href",n.toUrl()).innerText(n.get("Name")))},".title":function(e,t){var r=this.model.get("infoType");r===n.Models.ChatActivity.SUGGESTION_APPROVED?_.$one(t).removeClass("hide").data("translateText","SUGGESTION_APPROVED").text(_.getString("SUGGESTION_APPROVED")):r===n.Models.ChatActivity.SONG_CHANGED?_.$one(t).removeClass("hide").data("translateText","NOW_PLAYING").text(_.getString("NOW_PLAYING")):_.$one(t).addClass("hide")},".message":function(e,t){_.$one(t).html(this.model.getText())},".timestamp":function(e,t){this.model.get("type")==="message"&&!this.model.get("isInitialMessage")?_.$one(t).removeClass("hide").innerText(this.model.getFormattedTimestamp()):_.$one(t).addClass("hide")},".dropdown":function(e,t){var n=this.model.get("user");this.canShowUserActions()?_.$one(t).removeClass("hide").data("userId",n.get("UserID")):_.$one(t).addClass("hide")},".upvote-btn":function(e,t){var r,i,s,o,u;if(this.broadcast&&!this.broadcast.isBroadcasting()){r=this.model.get("song"),s=this.model.get("infoType");switch(s){case n.Models.ChatActivity.SUGGESTION_ADDED:case n.Models.ChatActivity.SUGGESTION_APPROVED:i=r&&r.get("suggester");if(r&&i&&i.get("UserID")!==n.getLoggedInUserID()){r.get("userVote")>0?_.$one(t).removeClass("hide").addClass("btn-active"):_.$one(t).removeClass("hide btn-active");return}break;case n.Models.ChatActivity.SONG_CHANGED:o=n.getCurrentBroadcast(),u=o&&o.get("activeSong");if(r&&r.get("isActiveSong")&&u&&u.get("queueSongID")===r.get("queueSongID")){u.get("userVote")>0?_.$one(t).removeClass("hide").addClass("btn-active"):_.$one(t).removeClass("hide btn-active");return}}}_.$one(t).addClass("hide")},".downvote-btn":function(e,t){var r=this.model.get("infoType"),i,s,o;if(this.broadcast&&!this.broadcast.isBroadcasting()&&r===n.Models.ChatActivity.SONG_CHANGED){i=n.getCurrentBroadcast(),s=i&&i.get("activeSong"),o=this.model.get("song");if(o&&o.get("isActiveSong")&&s&&s.get("queueSongID")===o.get("queueSongID")){s.get("userVote")<0?_.$one(t).removeClass("hide btn-gray").addClass("btn-danger"):_.$one(t).removeClass("hide btn-danger").addClass("btn-gray");return}}_.$one(t).addClass("hide")},".approve-btn":function(e,t){var r=this.model.get("song"),i=r instanceof n.Models.BroadcastSuggestion,s=this.broadcast&&this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS);s&&i&&r?_.$one(t).removeClass("hide").toggleClass("btn-active",r.get("approvalStatus")===1):_.$one(t).addClass("hide")},".play-btn":function(e,t){_.$one(t).toggleClass("hide",this.model.get("infoType")!=="suggestionAdded")},".info-icon":function(e,t){if(this.model.get("type")==="info"){var n=this.iconClass;this.persistent&&!n&&(n="icon-x");if(n){_.$one(t).attr("class","icon info-icon "+n);return}}_.$one(t).addClass("hide")},".wasplaying":function(e,t){if(this.model.get("type")==="message"){var r=this.model.get("playingSongID"),i=r&&n.Models.Song.getCached(r);if(r&&!i&&this.options.broadcast){var s=this.options.broadcast.get("history");s&&(i=s.get(r));var o=this.options.broadcast.get("activeSong");!i&&o&&o.get("SongID")==r&&(i=o)}if(i){_.$one(t).removeClass("hide").data("songId",r).attr("title",_.getString("WASPLAYING_TOOLTIP",{song:i.get("SongName"),artist:i.get("ArtistName")}));return}}_.$one(t).addClass("hide")},".actions":function(e,t){var r=this.model.get("type"),i=this.model.get("infoType"),s=r!=="message"&&r!=="info"||i==="suggestionAdded"||i===n.Models.ChatActivity.SONG_CHANGED;_.$one(t).toggleClass("hide",!s)},".badge":function(e,t){var n=this.model.get("user"),r=n&&n.get("IsPremium"),i=this.model.get("specialFlag"),s=this.model.get("type"),o,u;if(s!=="message"){_.$one(t).addClass("hide");return}i==="owner"?(o="icon-badge-host",u="BADGE_TOOLTIP_HOST"):i==="vip"?(o="icon-badge-guest",u="BADGE_TOOLTIP_GUEST"):i==="gsdev"||i==="admin"?(o="icon-logo",u="BADGE_TOOLTIP_STAFF"):r&&(o="icon-badge-vip",u="BADGE_TOOLTIP_VIP"),o?_.$one(t).attr("class","icon helper-tooltip badge "+o).attr("title",_.getString(u)).data("translateTitle",u):_.$one(t).addClass("hide").removeAttr("title").removeData("translateTitle")},".badge-link":function(e,n){var r=this.model.get("user"),i=t.get("user"),s=r&&r.get("IsPremium"),o=this.model.get("specialFlag");!o&&s&&i?_.$one(n).attr("href",i.getIsPremium()?"#!/settings/subscription":"#!/upgrade"):_.$one(n).removeAttr("href")}},initialize:function(n){this.$el.data("chatActivityId",this.model.get("ChatActivityID")),this.classes=[],n&&n.persistent&&(this.persistent=!0),e=n.gsApp,t=e&&e.model,this.broadcast=n&&n.broadcast,this.update(!0),this._super.call(this,"initialize",n)},addModelListeners:function(){var e=this.model.get("infoType");if(this.model.get("type")=="message")this.author=this.model.get("user"),this.author.on("change:Name",this.handleModelChange,this),this.author.on("change:isFavorite",this.onFavChange,this),this.model.on("change:user",this.onAuthorChanged,this);else if(e==n.Models.ChatActivity.SONG_CHANGED||e==n.Models.ChatActivity.SUGGESTION_ADDED)this.song=this.model.get("song"),this.song.on("change",this.handleModelChange,this),this.model.on("change:song",this.onSongChanged,this);this._super.call(this,"addModelListeners")},removeModelListeners:function(){this.author&&(this.author.off(null,null,this),this.author=null),this.song&&(this.song.off(null,null,this),this.song=null),this.model.off("change:user",this.onAuthorChanged,this),this.model.off("change:song",this.onSongChanged,this),this._super.call(this,"removeModelListeners")},onAuthorChanged:function(e,t){var n=e.previous("user");n&&n.off(null,null,this),this.author=t,this.author.on("change:Name",this.handleModelChange,this),this.author.on("change:isFavorite",this.onFavChange,this),this.onFavChange()},onSongChanged:function(e,t){var n=e.previous("song");n&&n.off(null,null,this),this.song=t,this.song.on("change",this.handleModelChange,this)},update:function(e){var t=this.model.get("type"),r=this.model.get("infoType"),i=["chat-"+t];r&&i.push(r),this.type&&this.type!==t&&(this.classes+=" chat-"+this.type),this.type=t,this.classes.length&&this.$el.removeClass(this.classes);if(t==="info")switch(r){case n.Models.ChatActivity.LEFT_BROADCAST:case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:this.iconClass="icon-user-remove";break;case n.Models.ChatActivity.JOINED_BROADCAST:case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:this.iconClass="icon-user-add"}var s=this.model.get("specialFlag");s&&i.push("chat-"+s),this.model.get("closeable")&&i.push("closeable"),this.persistent&&i.push("persistent"),_.contains(["songChange","suggestionAdded","suggestionApproved","songAddedByVIP","songsAddedByVIP","songRejectedByVIP","calloutAddedByVIP"],r)&&i.push("song-chat"),_.contains(["joinedBroadcast","leftBroadcast","joinedLeftBroadcast","leftJoinedBroadcast"],r)&&i.push("join-leave-notice"),this.isAdminLoggedIn=n.Models.Comment.ADMINS[n.getLoggedInUserID()],this.classes=i.join(" "),this.$el.addClass(this.classes)},onDownvoteClick:function(e){var t=this.model.get("song"),n;if(!this.broadcast||!this.broadcast.isListener())return;n=this.broadcast.get("activeSong"),n&&t&&t.get("queueSongID")===n.get("queueSongID")&&(n.get("userVote")===-1?this.broadcast.voteActiveSong(0):this.broadcast.voteActiveSong(-1))},onUpvoteClick:function(e){var t=this.model.get("song"),r;if(!this.broadcast||!this.broadcast.isListener())return;r=this.broadcast.get("activeSong"),t instanceof n.Models.BroadcastSuggestion?t.get("userVote")<1?this.broadcast.suggestSong(t):this.broadcast.removeSuggestion(t):r&&t&&t.get("queueSongID")===r.get("queueSongID")&&(r.get("userVote")===1?this.broadcast.voteActiveSong(0):this.broadcast.voteActiveSong(1))},onApproveClick:function(e){var t=this.model.get("song");if(!this.broadcast||!this.broadcast.isBroadcasting())return;this.broadcast.approveSuggestedSong(t)},onPlayClick:function(e){e.preventDefault(),e.stopPropagation();var t=this.model.get("song"),r=$(e.currentTarget).data("streamIndex"),i={};if(!t)return;return i.index=n.Models.Player.playSpecialIndexes[r]||n.Models.Player.playSpecialIndexes.DEFAULT,(t._wrapped||t).play(i),!1},onEnableChatClick:function(t){var r=$(t.currentTarget),i=e.model.get("player").get("queue"),s=i?i.get("currentBroadcast"):null,o=_.eventToGUTSCoords(t);o.broadcastID=s?s.get("BroadcastID"):"",s&&!s.get("chatEnabled")&&(s.updateBroadcastPreferences(!0,s.get("suggestionsEnabled")),n.trigger("guts:log","broadcastEnableChatClicked",o))},onBroadcastUserOptionsClick:function(t){var r=$(t.currentTarget),i=this.model.get("user"),s=i&&i.get("UserID"),o=e.model.get("player").get("queue"),u=this.model.get("type")=="message"?this.model.get("messages"):null,a=o?o.get("currentBroadcast"):null,f=this.broadcast&&this.broadcast.isUserVIP(s),l;u&&(u=u.join(" ")),a&&i&&(l=i.getBroadcastOptionMenu(a,!1,this.model.get("specialFlag"),u),amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;this.userMenuOptions={tooltipKey:"chat-msg-menu",delay:0,width:f?260:175,positionSpill:"left",$attached:r,model:i,items:l},this.settingsTooltip=n.Views.Tooltips.Menu.openTooltip(this.userMenuOptions),r.addClass("active")},this)))},onFavChange:function(){var e=this.author.get("isFavorite"),t=this.$el.find(".favorite"),n=t?t.find(".icon"):null;e?(t.addClass("btn-success"),n.removeClass("icon-plus"),n.addClass("icon-check white")):(t.removeClass("btn-success"),n.removeClass("icon-check white"),n.addClass("icon-plus"))},canShowUserActions:function(){var e=this.model.get("user"),t=e&&e.get("UserID"),r=this.broadcast&&this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_CHAT_MODERATE),i=this.model.get("specialFlag")==="owner",s=n.Models.Comment.ADMINS[t],o=this.broadcast&&this.broadcast.isUserVIP(t);if(!e||!this.broadcast||this.model.get("type")!=="message")return!1;if(this.isAdminLoggedIn||r){if(i||s)return!1;if(r&&!o)return!0;if(this.broadcast.isBroadcasting()||this.isAdminLoggedIn)return!0}return!1},showHelperTooltip:function(e){e.stopPropagation(),n.Views.Application.titleTooltipHelper(e,{positionDir:"left"})},clickChatMessage:function(r){if(t.get("appSize")!=="mobile")return;var i=this.model.get("user"),s,o,u;if(!i)return;this.canShowUserActions()?this.onBroadcastUserOptionsClick(r):(s=$(r.currentTarget),o=i&&i.get("isFavorite"),u=o?"UNFOLLOW":"FOLLOW",amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;this.settingsTooltip=n.Views.Tooltips.Menu.openTooltip({tooltipKey:"chat-msg-menu",delay:0,width:260,positionSpill:"left",$attached:s,tooltipClass:"menu",model:i,items:[{type:"html",html:'<a class="menu-item favorite" data-user-id="'+i.get("UserID")+'">'+'<span data-translate-text="'+u+'" class="menu-title">'+_.getString(u)+"</span></a>",click:_.bind(e.onFavoriteClick,e)}]}),s.addClass("active")},this)))},clickInviteLink:function(e){this.broadcast&&$(e.currentTarget).data("broadcastId",this.broadcast.get("BroadcastID"))}})}(),function(){n.Views.Modules.AnalyticsAlbumRow=n.Views.Modules.ArtistAlbumRow.extend({className:"module module-row analytics-album-row",cacheKey:"AnalyticsAlbumRow",templateFile:"analyticsAlbumRow",modelEvents:{"change:CoverArtFilename":function(e){this.ui.$albumImg.attr("src",e.getImageURL(40))}},makeChildGrid:function(){this.childViews.songGrid&&(this.childViews.songGrid.destroy(!1),this.childViews.songGrid=null);var e=this.model.get("songs"),t=new n.Models.Collections.Songs(e?e.models:null),r=this.model.id;t.comparator=function(e){return e.attributes.TrackNumsByAlbumID[r]||""},t.sort(),this.childViews.songGrid=new n.Views.AnalyticsSongGrid({el:this.$el.find(".song-grid")[0],collection:t,showTracks:!0,onClickItem:this.options.grid.options.onClickItem}),this.childViews.songGrid.on("resized",this.childResized,this),this.childViews.songGrid.render()},childResized:function(){var e=51+this.childViews.songGrid.$el.height()+18;this.size!==e&&(this.size=e,this.tmpSize!=e&&(this.$el.outerHeight(e),this.tmpSize=null),this.trigger("resized"))}},{estimateSize:function(e){var t=e.get("songs");return 51+t.length*41+18}})}(),function(){n.Views.Modules.AnalyticsSongRow=n.Views.Modules.Base.extend({className:"module module-row grid-item analytics-song-row song",cacheKey:"AnalyticsSongRow",templateFile:"analyticsSongRow",events:{"click .analytics-row":"onClickRow","click .view-stats":"onClickBtn"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".row-number":function(e,t){_.$one(t).innerText(this.grid.collection.indexOf(this.model)+1)},".title":function(e,t){_.$one(t).innerText(this.model.get("SongName"))}},initialize:function(e){this.onClickItem=_.orEqual(this.options.grid.options.onClickItem,function(){}),this._super.call(this,"initialize",e)},completeRender:function(e,t){this._super.call(this,"completeRender",e,t),this.grid.options&&this.grid.options.showTracks&&this.$el.addClass("show-tracks")},onClickRow:function(e){$(e.currentTarget).find(".view-stats").click()},onClickBtn:function(e){e.stopPropagation(),this.onClickItem(null,$(e.currentTarget))}})}(),function(){n.Views.Modules.CalloutRow=n.Views.Modules.Base.extend({className:"module module-row callout tall grid-item",cacheKey:"CalloutRow",templateFile:"calloutRow",events:{"click .action.callout-row-edit":"onEditClick","mouseenter .action":"onActionHover","blur .edit-input":"onEditInputBlur","keydown .edit-input":"onEditInputKeyDown"},changeModelSelectors:{"&":function(e,t){var n=this.grid&&this.grid.collection&&this.grid.collection.length>1,r=this.model.get("CalloutID");_.$one(t).data("calloutId",r).toggleClass("transcoding",!this.model.get("transcoded")).toggleClass("grid-item",n||!1).toggleClass("editing",!!this.model.get("editing"))},".row-number":function(e,t){_.$one(t).text(this.grid.collection.indexOf(this.model)+1)},".play":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".title":function(e,t){_.$one(t).innerText(this.model.get("Name"))},".edit-input":function(e,t){_.$one(t).val(this.model.get("Name"))},".duration":function(e,t){_.$one(t).innerText(_.millisToMinutesSeconds(this.model.get("EstimateDuration")*1e3))},".progress-complete":function(e,t){_.$one(t).width(Math.min(this.model.get("uploadPercent")/100,1)*100+"%")}},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments)));var t=this.changeModelSelectors[".progress-complete"];_.isFunction(t)&&t.call(this,0,this.$el.find(".progress-complete")),this.model.set("editing",!1),this.listenTo(this.model,"change:editing",this.onEditingChange)},getGutsContext:function(e){var t=$(e.currentTarget),r=t.data("calloutId");return $.extend({calloutID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e))},onEditClick:function(e){var t=$(e.currentTarget),r;this.grid&&this.grid.onEditClick?this.grid.onEditClick(e):(r={closeOnScroll:!1,$attached:t,$menuOpenEl:t.closest(".module"),className:"edit-calloutrow-menu"},_.asyncTooltipMenu(t,r,this.model,"getEditCalloutMenu")),n.trigger("guts:log","OLEditClick",this.getGutsContext(e))},onEditingChange:function(){setTimeout(_.bind(function(){this.$el.find(".edit-input").focus()},this),10)},onEditInputKeyDown:function(e){var t=$(e.currentTarget);switch(e.which){case _.keyboard.ENTER:t.blur();return;case _.keyboard.ESC:e.preventDefault(),t.val(this.model.get("Name")).blur();return}},onEditInputBlur:function(e){var t=$(e.currentTarget),r=this.model.get("CalloutID"),i=t.val();i!==this.model.get("Name")&&n.Services.API.updateCalloutDetails(r,i).done(_.bind(function(){this.model.set({Name:i,SongName:i})},this)).fail(_.bind(function(){n.trigger("notification:add",{description:_.getString("PROBLEM_EDITING_CALLOUT"),type:"error",duration:5e3})},this)),this.model.set("editing",!1)},onActionHover:function(e){n.Views.Application.titleTooltipHelper(e,{y:"top"})}})}(),function(){n.Views.Modules.ShareRow=n.Views.Modules.Base.extend({className:"module module-row share-row tall",cacheKey:"ShareRow",templateFile:"shareRow",events:{"click .like":"onLikeClick"},runChangeModelSelectors:function(){var e=_.toArray(arguments);this.model.getDisplayData().done(_.bind(function(){this._super.apply(this,["runChangeModelSelectors"].concat(e))},this))},changeModelSelectors:{"&":function(e,t){var n=this.model.get("displayObject"),r=n&&n.item;this.itemType=n.itemType;switch(this.itemType){case"album":this.iconClass="icon-disc",this.displayName=r.get("AlbumName"),this.sourceName=r.get("ArtistName"),this.sourceURL=r.toArtistUrl(),this.itemURL=r.toUrl();break;case"playlist":this.iconClass="icon-playlist",this.displayName=r.get("PlaylistName"),this.sourceName=r.get("owner").get("Name"),this.sourceURL=r.get("owner").toUrl(),this.itemURL=r.toUrl();break;case"broadcast":this.iconClass="icon-broadcast",this.displayName=r.get("Name"),this.sourceName=r.get("ownerModel").get("Name"),this.sourceURL=r.get("ownerModel").toUrl(),this.itemURL=r.toUrl();break;case"user":this.iconClass="icon-user",this.displayName=r.get("Name"),this.sourceName=!1,this.sourceURL=!1,this.itemURL=r.toUrl();break;case"artist":this.iconClass="icon-mic",this.displayName=r.get("ArtistName"),this.sourceName=!1,this.sourceURL=!1,this.itemURL=r.toUrl();break;case"song":this.iconClass="icon-musicnote",this.displayName=r.get("SongName"),this.sourceName=r.get("ArtistName"),this.sourceURL=r.toArtistUrl(),this.itemURL=!1,this.songID=r.get("SongID")}},".like .label":function(e,t){var n=this.model.getIsLikedByLoggedInUser()?"UNLIKE":"LIKE";_.$one(t).text(_.getString(n)).data("translateText",n)},".like .count":function(e,t){var n=this.model.get("numLikes");_.$one(t).toggleClass("hide",!n).find(".num").text(n)},".comment":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".comment .count":function(e,t){var n=this.model.get("commentsCount");_.$one(t).toggleClass("hide",!n).find(".num").text(n)},".icon":function(e,t){_.$one(t).attr("class","icon bubble "+this.iconClass)},".title":function(e,t){this.itemURL?_.$one(t).removeClass("song-link").attr("href",this.itemURL).removeData("songId"):this.songID&&_.$one(t).addClass("song-link").removeAttr("href").data("songId",this.songID),_.$one(t).text(this.displayName)},".byline .type":function(e,t){var n=this.itemType.toUpperCase();_.$one(t).text(_.getString(n)).data("translateText",n)},".byline .source":function(e,t){_.$one(t).toggleClass("hide",!this.sourceName).text(this.sourceName),this.sourceURL?_.$one(t).attr("href",this.sourceURL):_.$one(t).removeAttr("href")},".byline .by":function(e,t){_.$one(t).toggleClass("hide",!this.sourceName)}},onLikeClick:function(e){var t=this.model.getIsLikedByLoggedInUser();t?this.model.unlike().fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error"})}):this.model.like().fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error"})})}})}(),function(){var e={onSelection:function(){},hideMultiGenre:!1,tooltipKey:"tag-tooltip",defaultTags:!1,capitalize:!0,icon:"icon-caretdown",allowEmptyTag:!1};n.Views.Modules.TagDropdown=n.Views.Modules.Base.extend({className:"module tag-dropdown",templateFile:"tagDropdown",ui:{name:".name",icon:".icon"},events:{"click .dropdown":"onDropdownClick"},modelEvents:{"change:TagName":function(e){this.$el.data("tag",this.model.get("TagName")),this.ui.$name.text(this.model.get("TagName")),this.ui.$icon.attr("class",["icon",this.options.icon].join(" "))}},initialize:function(t){var n=t||{};this.model=_.orEqual(this.model,new Backbone.Model),this.tooltipOwner=n.tooltipOwner,_.defaults(this.options,e),this.defaultTagName=this.options.defaultTagName||(this.options.hideMultiGenre?"---":_.getString("DEFAULT_TAG")),$(document).on("click."+this.cid,_.bind(this.onDocumentClick,this)),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(e){var t;return e=e||new ChainLoading,e.push(amdModules.requireDeferred("gs/views/tooltips/tagSelector.js")),t=n.Views.Modules.Base.prototype.render.call(this,e),t.done(_.bind(function(){this.model.set("TagName",_.setCasing(this.options.initialTagName||this.defaultTagName,this.options.capitalize))},this)),t},onDestroy:function(){$(document).off("click."+this.cid),this.closeTooltip()},onDocumentClick:function(e){var t=this.$el.has(e.target).length>0,n=this.tagTooltip&&this.tagTooltip.$el.has(e.target).length>0;!t&&!n&&this.closeTooltip()},closeTooltip:function(){this.tagTooltip&&this.tagTooltip.closeTooltip()},getNamedTag:function(e){var t=_.getString("DEFAULT_TAG");if(e&&this.tags&&this.tags[e])return{n:_.setCasing(e,this.options.capitalize),i:this.tags[e]};if(e.toUpperCase()===(typeof t=="string"&&t.toUpperCase()))return{n:_.setCasing(e,this.options.capitalize),i:0};if(e==="---")return null},onDropdownClick:function(e){if(this.tagTooltip){this.tagTooltip.closeTooltip();return}var t=$(e.currentTarget);this.tagsDfd||(this.tagsDfd=n.Models.Tag.getTagList()),this.tagsDfd.done(_.bind(this.showTagTooltip,this,t)).fail(function(){n.trigger("notification:add",{title:_.getString("POPUP_FAILED_TO_GET_TAGS"),type:"error"})})},showTagTooltip:function(e,i){if(this.tagTooltip){this.closeTooltip();return}this.tags=_.clone(i),this.tagLowerName={},_.each(this.tags,_.bind(function(e,t){this.tagLowerName[(t||"").toLowerCase()]=1},this));var s=r.model.get("player").get("queue"),o=s&&s.get("songs"),u=o&&_.filter(o.pluck("Tags"),function(e){return!!e}),a={},f,l,c=this.options.tooltipKey+this.cid,h;_.each(u,function(e){e.each(function(e){var t=e.get("TagID");a[t]?a[t][1]+=1:a[t]=[e,1]})}),f=_.pluck(_.sortBy(a,"1").slice(0,3),"0"),f=new n.Models.Collections.Tags(f),l=f.map(function(e){return(e.get("Tag")||"").toLowerCase()}),this.options.defaultTags?h=this.options.defaultTags:(h=[],this.options.hideMultiGenre||h.unshift(_.getString("DEFAULT_TAG")),this.defaultTagName!==_.getString("DEFAULT_TAG")&&this.defaultTagName!=="---"&&!_.isUndefined(this.getNamedTag(this.defaultTagName))&&h.unshift(this.defaultTagName),h=h.concat(l),h=h.concat(_.difference(_.pluck(n.Models.Tag.topGenres,"tag"),l))),this.options.allowEmptyTag&&h.unshift("---"),_.each(n.Models.Tag.topGenres,_.bind(function(e){var t=e.tag||"",n=t.toLowerCase();t&&!this.tagLowerName[n]&&(this.tags[e.tag]=e.tagID)},this)),f.each(_.bind(function(e){var t=e.get("Tag"),n=t.toLowerCase();t&&!this.tagLowerName[n]&&(this.tags[t]=e.get("TagID"))},this)),this.tagTooltip=new n.Views.Tooltips.TagSelector({model:this.model instanceof n.Models.Broadcast?this.model:t,tooltipKey:c,tags:this.tags,defaultTags:h,capitalize:this.options.capitalize,submit:_.bind(this.onNewTagChosen,this)}),n.trigger("tooltip:open",{views:[this.tagTooltip],tooltipOwner:this.tooltipOwner,$attached:e,persist:!0,tooltipKey:c,positionSpill:"right",width:_.max([e.outerWidth(),150]),closeOnScroll:r.model.get("appMode")!=="mobile",scrollable:$(document)}),e.addClass("active"),$(document).on("keydown."+this.cid,_.bind(this.focusFilterInput,this));var p=this.tagTooltip.onDestroy;this.tagTooltip.onDestroy=_.bind(function(){e.removeClass("active"),$(document).off("keydown."+this.cid),this.tagTooltip.onDestroy=p,p.apply(this.tagTooltip,_.toArray(arguments)),this.tagTooltip=null},this)},focusFilterInput:function(e){var t=e.which.toString(),n=e.metaKey||e.ctrlKey,r=_.keys(_.playerShortcuts),i=_.keys(_.specialKeys);_.indexOf(r,t)===-1&&_.indexOf(i,t)===-1&&!n&&$(".tag-tooltip .tag-filter").focus()},getSelectedTag:function(e){var n=this.model.get("TagName");return e?(n=n.toLowerCase(),n===_.getString("SELECT_TAG").toLowerCase()||n===_.getString("SELECT_TAG_PRIMARY").toLowerCase()||n==="---"?t:this.getNamedTag(n)):n},onNewTagChosen:function(e){var t=this.getNamedTag(e);this.model.set("TagName",_.setCasing(e,this.options.capitalize)),_.isUndefined(t)||(this.model.set("Tag",t),this.options.onSelection(_.setCasing(e,this.options.capitalize),t?t.i:null))}})}(),function(){n.Views.Modules.RowSongSelector=n.Views.Modules.Base.extend({className:"module grid-item module-row song-selector",cacheKey:"RowSongSelector",templateFile:"rowSongSelector",events:{"click .remove":"onRemoveSongClick","keydown .placeholder-input":"onSearchKeydown","focus .placeholder-input":"onSearchFocus","blur .placeholder-input":"onSearchBlur"},changeModelSelectors:{"&":function(e,t){this.$el.toggleClass("has-song",!!this.model.get("song"))},".placeholder-text":function(e,t){var n=this.model.get("song");n?_.$one(t).html(_.getString("SONG_ON_ALBUM",{song:n.escape("SongName"),album:n.escape("AlbumName")})).data("translateText",""):_.$one(t).text(_.getString("ENTER_SONG_NAME")).data("translateText","ENTER_SONG_NAME")}},onDestroy:function(){this.clearTooltip()},onSearchBlur:function(e){$(e.currentTarget).val("").change()},onSearchFocus:function(e){var t=this.model.get("song"),n=$(e.currentTarget);t&&(n.val(t.get("SongName")).change(),_.defer(function(){n.select()}))},onSearchKeydown:function(e){var t=$(e.currentTarget),n,r,i;this.autocompleteTooltip&&(n=this.autocompleteTooltip.$el,r=$(".ac-list-item.selected",n));switch(e.which){case _.keyboard.ENTER:r=r?r.find(".ac-item-link"):null;if(r&&r.length)return i=this.autocompleteTooltip.getModelForRow(r),this.onSelectedItem(r,i),!1;return;case _.keyboard.UP:e.preventDefault(),n&&(!r.length||r.is(":first-child")?$(".ac-list-item:last",n).addClass("selected"):r.prev().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.DOWN:e.preventDefault(),n&&(!r.length||r.is(":last-child")?$(".ac-list-item:first",n).addClass("selected"):r.next().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.ESC:e.preventDefault(),this.clearTooltip();return}this.doAutocomplete(t)},doAutocomplete:_.debounce(function(e){function s(e){return r.filter(function(t){return t.attributes.searchText.indexOf(e)!=-1})}var t=$.trim(e.val().toLowerCase()),r=this.grid.options.sourceSongs,i={sticky:!0,$attached:e,tooltipKey:"autocomplete"};if(!t){this.clearTooltip();return}if(this.autocompleteTooltip){this.autocompleteTooltip.changeQuery(t);return}this.autocompleteTooltip=new n.Views.Autocomplete({type:"songSearch",query:t,maxResults:5,showAllLink:!1,sections:[{type:"Songs",filterFunction:s,search:!1,hideTitle:!0}],handleResultClick:_.bind(this.onSelectedItem,this)}),i.views=[this.autocompleteTooltip],i.noMobile=!0,n.trigger("tooltip:open",i),i.dfd.done(_.bind(function(){this.autocompleteTooltip=null},this))},10),clearTooltip:function(e){this.autocompleteTooltip&&(this.autocompleteTooltip=null,n.trigger("tooltip:close")),e&&this.model.set("song",null)},onSelectedItem:function(e,t){if(!t)return;this.clearTooltip(),this.$el.find(".placeholder-input").blur(),this.model.set("song",t)},onRemoveSongClick:function(){this.$(".placeholder-input").blur(),this.clearTooltip(!0)}})}(),function(){n.Views.Modules.FeaturedFanUpdate=n.Views.Modules.Base.extend({className:"module fan-update module-comment",cacheKey:"FeaturedFanUpdate",templateFile:"featuredFanUpdate",changeModelSelectors:{"&":function(e,t){},".author-image":function(e,t){_.$one(t).attr("href",this.model.get("artist").toUrl())},".artist-img":function(e,t){_.$one(t).attr("src",this.model.get("artist").getImageURL(30))},".author-name":function(e,t){_.$one(t).innerText(this.model.get("artist").get("ArtistName"))},".comment-message":function(e,t){_.$one(t).innerText(this.model.get("Message"))},".comment-reply-link .label":function(e,t){var n=this.model.get("CommentCount"),r="REPLY";n>0?(r="SHOW_REPLIES",_.$one(t).siblings(".label-num").removeClass("hide").find(".replies-num").innerText(n)):_.$one(t).siblings(".label-num").addClass("hide"),_.$one(t).innerText(_.getString(r)).data("translateText",r)},".comment-time":function(e,t){_.$one(t).innerText(_.getFormattedDate(this.model.get("Timestamp")))},".response-row":function(e,t){_.$one(t).data("parentId",this.model.get("CommentID"))}}})}(),function(){n.Views.Modules.AddRelatedArtist=n.Views.Modules.Base.extend({className:"module module-cell artist add-artist clickable",templateFile:"addRelatedArtist",events:{click:"onClick","click .autocomplete-input":"onInputClick","keydown .placeholder-input":"onSearchKeydown","change .placeholder-input":"onSearchKeydown","click .suggestion":"onSuggestionClick"},initialize:function(e){var t=new n.Models.Collections.Artists;e&&e.grid&&(this.grid=e.grid,this.grid.collection.on("add",function(e){t.add(e)},this),this.grid.collection.on("remove",function(e){t.remove(e)},this),t.add(this.grid.collection.models)),e&&e.parentArtist&&(t.add(e.parentArtist),this.parentArtist=e.parentArtist),this.autocompleteIgnoreCollection=t,this._super.call(this,"initialize",e)},onClick:function(){this.$el.parent().find(".add-artist").addClass("clickable"),this.$el.removeClass("clickable"),this.parentArtist&&this.parentArtist.getRelatedArtistsRecs().done(_.bind(this.onSuggestions,this)),this.$el.find(".placeholder-input").trigger("change").focus()},onSuggestions:function(e){var t=this.$el.find(".suggestions");if(!e||e.length<1){t.addClass("hide");return}e.remove(this.autocompleteIgnoreCollection.models);for(var n=0,r,i;n<4;n++)r=e.at(n),i=this.$el.find(".artist-"+n),r?(i.find(".image").attr("src",r.getImageURL()),i.find(".name").text(r.get("ArtistName")),i.data("artist",r),i.removeClass("hide")):i.addClass("hide");t.removeClass("hide")},onInputClick:function(e){e.stopPropagation()},onDestroy:function(){this.clearTooltip(),this.grid&&this.grid.collection.off(null,null,this)},onSearchKeydown:function(e){var t=$(e.currentTarget),n,r,i;this.autocompleteTooltip&&(n=this.autocompleteTooltip.$el,r=$(".ac-list-item.selected",n));switch(e.which){case _.keyboard.ENTER:r=r?r.find(".ac-item-link"):null;if(r&&r.length)return i=this.autocompleteTooltip.getModelForRow(r),this.onSelectedItem(r,i),!1;return;case _.keyboard.UP:e.preventDefault(),n&&(!r.length||r.is(":first-child")?$(".ac-list-item:last",n).addClass("selected"):r.prev().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.DOWN:e.preventDefault(),n&&(!r.length||r.is(":last-child")?$(".ac-list-item:first",n).addClass("selected"):r.next().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.ESC:e.preventDefault(),this.clearTooltip();return}this.doAutocompleteDebounced(t)},doAutocompleteDebounced:_.debounce(function(e){return this.doAutocomplete(e)},750),doAutocomplete:function(e){var t=$.trim(e.val().toLowerCase());if(t.length<1){this.clearTooltip();return}if(this.autocompleteTooltip)this.autocompleteTooltip.changeQuery(t);else{var r={sticky:!0,$attached:this.$el,tooltipKey:"autocomplete",width:270};this.autocompleteTooltip=new n.Views.Autocomplete({type:"artistSearch",query:t,maxResults:7,sections:[{type:"Artists",hideTitle:!0,ignoreCollection:this.autocompleteIgnoreCollection}],handleResultClick:_.bind(this.onSelectedItem,this),showAllLink:!1}),r.views=[this.autocompleteTooltip],r.noMobile=!0,n.trigger("tooltip:open",r),r.dfd.done(_.bind(function(){this.autocompleteTooltip=null},this))}},clearTooltip:function(){this.autocompleteTooltip&&(this.autocompleteTooltip=null,n.trigger("tooltip:close"))},onSuggestionClick:function(e){e.stopPropagation();var t=$(e.currentTarget);this.onSelectedItem(t,t.data("artist"))},onSelectedItem:function(e,t){if(!t)return;this.clearTooltip(),this.$el.find(".placeholder-input").val("").blur().parent().removeClass("has-text"),this.$el.addClass("clickable");var n=this.grid.collection;t.getPageNameData().done(function(){n.add(t)})}})}(),function(){n.Views.Modules.EditableAlbumSongRow=n.Views.Modules.Base.extend({className:"module grid-item module-row tall editable-album-song-row",cacheKey:"EditableAlbumSongRow",templateFile:"editableAlbumSongRow",events:{"change .name":"nameChange","change .track-num":"trackChange","click .edit":"editClick","focus input":"focusInput"},changeModelSelectors:{".name":function(e,t){_.$one(t).val(this.model.get("SongName"))},".track-num":function(e,t){_.$one(t).val(this.model.get("TrackNum"))}},nameChange:function(e){var t=$(e.currentTarget),n=t.val();this.model.set("SongName",n)},trackChange:function(e){var t=$(e.currentTarget),n=_.toInt(t.val());this.model.set("TrackNum",n)},editClick:function(e){n.trigger("lightbox:open","editSong",{song:this.model.get("song")})},focusInput:function(e){_.defer(function(){$(e.currentTarget).select()})}})}(),function(){n.Views.Modules.ArtistRowMini=n.Views.Modules.Base.extend({className:"module module-row sidebar-artist grid-item mini",cacheKey:"ArtistRowMini",templateFile:"artistRowMini",changeModelSelectors:{"&":function(e,t){_.$one(t).data("artist",this.model)},".inner":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".name":function(e,t){_.$one(t).innerText(this.model.get("ArtistName"))}},acceptDrop:function(e){return!1}})}(),function(){n.Views.Modules.ThirdPartyLinkRow=n.Views.Modules.Base.extend({className:"module grid-item third-party-link-module",cacheKey:"ThirdPartyLinkRow",templateFile:"thirdPartyLink",events:{"change .link-input":"onInputChange","click .remove":"onRemoveLink"},changeModelSelectors:{"&":function(e,t){_.$one(t).attr("data-type",this.model.get("type"))},".link-icon":function(e,t){_.$one(t).attr("class","icon icon-"+n.Models.User.urlIcons[this.model.get("type")]+" link-icon")},".link-label":function(e,t){_.$one(t).text(this.thirdPartyName(this.model.get("type")))},".link-input":function(e,t){_.$one(t).val(this.model.get("url"))}},onInputChange:function(e){var t=$(e.currentTarget),n=t.val()||"";n=_.replaceLinkPrefix(this.model.get("type"),n),this.model.set("url",n)},thirdPartyName:function(e){return n.Models.User.urlTypes[e]||e},onRemoveLink:function(e){if(!this.options||!this.options.grid||!this.options.grid.removeDeletedLink)return;this.options.grid.removeDeletedLink(this.model)}})}(),define("/pub/gs/views/modules/genreDropdownRow.js",function(){n.Views.Modules.GenreDropdownRow=n.Views.Modules.Base.extend({className:"module grid-item genre-dropdown",cacheKey:"GenreDropdownRow",templateFile:"genreDropdownRow",changeModelSelectors:{".tag-dropdown":function(e,t){var r=this.$(".tag-dropdown"),i=this.model.get("Tag");this.childViews.dropdown||(this.childViews.dropdown=new n.Views.Modules.TagDropdown({el:r,initialTagName:i||null,icon:this.options.icon,hideMultiGenre:this.options.hideMultiGenre,allowEmptyTag:this.options.allowEmptyTag}),this.dropdownModel=this.childViews.dropdown.model,this.dropdownModel.on("change:Tag",this.onTagChange,this),this.childViews.dropdown.render())}},onDestroy:function(){this.dropdownModel&&this.dropdownModel.off(null,null,this)},onTagChange:function(e,t){t?this.model.set({TagID:t.i,Tag:t.n}):this.options.hideMultiGenre&&this.options.allowEmptyTag?this.model.set({TagID:0,Tag:"---"}):this.model.set({TagID:0,Tag:"multi-genre"})}})}),function(){n.Views.Modules.QuickPlayRow=n.Views.Modules.Base.extend({className:"module grid-item quick-play-row",cacheKey:"QuickPlayRow",templateFile:"quickPlayRow",templateConverted:!0,events:{"click .play-btn":"clickPlayBtn"},changeModelSelectors:{".play-btn":function(e,t){var r=this.model instanceof n.Models.Broadcast;_.$one(t).swapClasses("join-broadcast","play-dropdown",this.model instanceof n.Models.Broadcast)},".title":function(e,t){_.$one(t).innerText(this.getName()),this.model instanceof n.Models.Song?_.$one(t).data("songId",this.model.id).addClass("song-link").removeAttr("href"):_.$one(t).attr("href",this.model.toUrl()).data("songId",null).removeClass("song-link")},".item-icon":function(e,t){var n=_.$one(t).data("icon"),r=this.getIconName();n&&_.$one(t).removeClass(n),_.$one(t).addClass(r).data("icon",r)}},initialize:function(e){this.$el.addClass(_.getItemType(this.model)),this._super.call(this,"initialize",e)},getName:function(){switch(this.model.idAttribute){case"SongID":return this.model.get("SongName");case"BroadcastID":return this.model.get("Name");case"AlbumID":return this.model.get("AlbumName");case"PlaylistID":return this.model.get("PlaylistName");case"UserID":return this.model.get("Name")}return"Unknown model!"},getIconName:function(){var e=_.getItemType(this.model),t="icon-"+e;switch(e){case"playlist":t="icon-playlist-note";break;case"song":t="icon-musicnote"}return t},clickPlayBtn:function(e){var t=this.model instanceof n.Models.Song,r=n.isBroadcastListener(),i={};t&&r&&(i.context=new n.Models.PlayContext,i.context.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),this.model.play(i),e.stopPropagation())}})}(),function(){n.Views.Modules.ContextSwitchRow=n.Views.Modules.Base.extend({className:"module context-switch-row",cacheKey:"ContextSwitchRow",templateFile:"contextSwitchRow",changeModelSelectors:{".context":function(e,t){_.$one(t).data("id",this.model.get("profileID")||this.model.get("UserID"))},".user-img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(30))},".name":function(e,t){_.$one(t).text(this.model.get("ArtistName")||this.model.get("Name"))}}})}(),function(){n.Views.Modules.Taco=n.Views.Modules.Base.extend({className:"module taco-notif",cacheKey:"Taco",templateFile:"taco",events:{"click .btn-notif":"onBtnClick","mouseenter .link":"onNotifEnter","mouseenter .btn-container":"onNotifEnter","mouseleave .link":"onNotifLeave","mouseleave .btn-container":"onNotifLeave"},changeModelSelectors:{"&":function(e,t){this.normalizedObject=this.model.getNormalizedObject();if(!this.normalizedObject){_.$one(t).addClass("hide");return}_.$one(t).removeClass("hide").data("tacoId",this.model.get("TacoID")),_.$one(t).toggleClass("unread",this.model.get("unseen"))},".btn-notif":function(e,t){if(!this.normalizedObject)return;if(this.normalizedObject.btnIcon){_.$one(t).removeClass("hide check plus btn-grey btn-success btn-primary").addClass(this.normalizedObject.btnIcon),this.normalizedObject.btnIcon=="plus"||this.normalizedObject.btnIcon=="thinarrow-right"?_.$one(t).addClass("btn-grey btn-inactive"):this.normalizedObject.btnIcon=="check"?_.$one(t).addClass("btn-success btn-inactive"):this.normalizedObject.btnIcon=="play-circle-fill"&&_.$one(t).addClass("btn-primary btn-inactive");var n=_.$one(t).data("customClasses");_.$one(t).removeData(),n&&_.$one(t).removeClass(n),this.normalizedObject.btnClass&&_.$one(t).addClass(this.normalizedObject.btnClass).data("customClasses",this.normalizedObject.btnClass),this.normalizedObject.btnData&&_.$one(t).data(this.normalizedObject.btnData)}else _.$one(t).addClass("hide")},".icon":function(e,t){if(!this.normalizedObject||!this.normalizedObject.btnIcon)return;_.$one(t).removeClass("icon-check icon-plus").addClass("icon-"+this.normalizedObject.btnIcon)},".link":function(e,t){if(!this.normalizedObject)return;_.$one(t).attr("href",this.normalizedObject.link)},".notif-images":function(e,t){if(!this.normalizedObject)return;if(!this.normalizedObject.pictures){_.$one(t).addClass("hide");return}var n=[],r=this.normalizedObject.isUserPicture?" user-img":"";_.each(this.normalizedObject.pictures,function(e){n.push('<img src="'+e+'" class="tiny-image'+r+'" />')}),_.$one(t).html(n.join("")).attr("data-count",n.length).removeClass("hide")},".notif-image":function(e,t){if(!this.normalizedObject)return;if(!this.normalizedObject.picture){_.$one(t).addClass("hide");return}_.$one(t).attr("src",this.normalizedObject.picture),_.$one(t).toggleClass("user-img",this.normalizedObject.isUserPicture===!0).removeClass("hide")},".desc":function(e,t){if(!this.normalizedObject)return;_.$one(t).html(_.getString(this.normalizedObject.locale,this.normalizedObject.localeOptions))},".message-container":function(e,t){if(!this.normalizedObject)return;this.normalizedObject.message?_.$one(t).removeClass("hide").find(".message").text(this.normalizedObject.message):_.$one(t).addClass("hide")},".time":function(e,t){if(!this.normalizedObject)return;_.$one(t).text(this.normalizedObject.time)}},onBtnClick:function(e){e.preventDefault();if(!this.normalizedObject)return;if(!this.normalizedObject.onBtnClick){n.router.setHash(this.$(".link").attr("href"));return}this.normalizedObject.onBtnClick(this.normalizedObject).done(_.bind(function(){this.$el.find(".btn-notif").each(_.bind(this.changeModelSelectors[".btn-notif"],this)),this.$el.find(".icon").each(_.bind(this.changeModelSelectors[".icon"],this))},this))},onNotifEnter:function(){this.$el.find(".btn-notif").removeClass("btn-inactive")},onNotifLeave:function(){this.$el.find(".btn-notif").addClass("btn-inactive")}})}(),function(){n.Views.Modules.StatisticRow=n.Views.Modules.Base.extend({className:"module module-row tall statistic grid-item",cacheKey:"StatisticRow",templateFile:"statisticRow",changeModelSelectors:{".title":function(e,t){_.$one(t).text(this.model.get("title"))},".stat":function(e,t){_.$one(t).text(this.model.get("statistic"))}}})}(),function(){n.Views.Modules.SimpleUserRow=n.Views.Modules.Base.extend({className:"module module-row simple-user-row",cacheKey:"SimpleUserRow",templateFile:"simpleUserRow",changeModelSelectors:{".link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".user-img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(30))},".name":function(e,t){_.$one(t).text(this.model.get("ArtistName")||this.model.get("Name"))}}})}(),function(){var e=360;n.Views.Modules.ProfileCompletion=n.Views.Modules.Base.extend({className:"module module-feed-event profile-completion",cacheKey:"ProfileCompletion",templateFile:"profileCompletion",ui:{profileUploadForm:".profile-upload",coverUploadForm:".cover-upload",stateField:".field.state",countryField:".field.country",btnsFooter:".save-cancel"},events:{"click .cancel":"onCancelClick","click .submit":"onSubmitClick","click .close":"onCloseClick","keyup .field":"onFieldChange","change .field":"onFieldChange","change @countryField":"onCountryChange","click .show-more":"onShowMoreLinksClick"},changeModelSelectors:{".event-img-container":function(e,t){var n=this.model.get("step");n=="profile"||n=="cover"||n=="complete"?_.$one(t).removeClass("hide").css("background-image","url("+this.model.get("userCoverPhoto")+")"):_.$one(t).addClass("hide")},".outer-gradient":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")=="cover")},".profile-upload":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!="profile")},".cover-upload":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!="cover")},".current-img":function(e,t){_.$one(t).attr("src",this.user.getImageURL(120))},".completion-content":function(e,t){var n=this.model.get("step");n==="profile"||n==="cover"||n==="complete"?_.$one(t).addClass("hide"):_.$one(t).removeClass("hide")},".bio-content":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!=="bio")},".bio":function(e,t){var n=this.user.get("About")||"";_.$one(t).text(n).closest(".placeholder-container").toggleClass("has-text",!!n)},".location-content":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!=="location")},".country":function(e,t){_.$one(t).val(_.escape(this.user.get("Country")))},".city":function(e,t){var n=_.escape(this.user.get("City"));_.$one(t).val(n).closest(".placeholder-container").toggleClass("has-text",!!n)},".state":function(e,t){_.$one(t).val(_.escape(this.user.get("State"))).parent().toggleClass("hide",this.user.get("Country")!=="US")},".links-content":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!="links")},".field.tw":function(e,t){var n=this.model.get("userProfileURLs").tw||"";_.$one(t).val(n)},".field.yt":function(e,t){var n=this.model.get("userProfileURLs").yt||"";_.$one(t).val(n)},".field.fb":function(e,t){var n=this.model.get("userProfileURLs").fb||"";_.$one(t).val(n)},".field.ig":function(e,t){var n=this.model.get("userProfileURLs").ig||"";_.$one(t).val(n)},".field.site":function(e,t){var n=this.model.get("userProfileURLs").site||"";_.$one(t).val(n)},".show-more":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!="links")},".progress-bar":function(e,t){_.$one(t).width(this.model.get("progress")+"%")},".progress-text":function(e,t){_.$one(t).text(_.getString("PROFILE_IS_PERCENT_COMPLETE",{percent:this.model.get("progress")}))},".completed-content":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!=="complete")},".completed-footer":function(e,t){_.$one(t).toggleClass("hide",this.model.get("step")!=="complete")},".view-profile":function(e,t){_.$one(t).attr("href",this.user.toUrl())}},initialize:function(e){return this.user=e.user,e.model||(this.model=new Backbone.Model),n.Views.Modules.Base.prototype.initialize.call(this,e)},onDestroy:function(){this.ui.$profileUploadForm!=null&&this.ui.$profileUploadForm.imgUpload("destroy"),this.ui.$coverUploadForm!=null&&this.ui.$coverUploadForm.imgUpload("destroy")},render:function(){var e=$.Deferred();return this.updateProgress().done(_.bind(function(){if(this.model.get("progress")==100){e.reject();return}n.Views.Modules.Base.prototype.render.call(this).done(_.bind(function(){this.onRendered(),e.resolve()},this)).fail(_.bind(e.reject,e))},this)).fail(_.bind(e.reject,e)),e.promise()},onRendered:function(){this.bindUIElements();var e=this.ui.$profileUploadForm,n=this.ui.$coverUploadForm;e.imgUpload({imageParam:"userPic",type:"profile",extraParams:{artistID:t},onImageSelected:_.bind(function(){this.ui.$btnsFooter.removeClass("hide")},this)}),n.imgUpload({imageParam:"userCoverPic",type:"cover",extraParams:{cropStartY:0},onImageSelected:_.bind(function(e,t,r){(!e||!t)&&r&&(n.find(".btn-container").addClass("hide"),n.find(".no-preview").html(_.getString("NO_PREVIEW_AVAILABLE")+"<br />"+_.escape(r)).removeClass("hide"),n.find(".upload-info").addClass("hide")),this.ui.$btnsFooter.removeClass("hide")},this)})},updateProgress:function(){if(this.destroyed)return;var t=$.Deferred(),n=new ChainLoading,r=null,i=null,s={},o=1,u=6,a=_.bind(function(e){if(r)return;r=e},this);return n.done(n.bind(function(){this.user.get("Picture")?o++:a("profile")},this)),n.push(this.user.getPageImageURL(e).done(n.bind(function(e){i=e;var t=this.user.get("pageNameData");t&&t.CoverPhoto?o++:a("cover")},this))),n.done(n.bind(function(){this.user.get("City")||this.user.get("State")||this.user.get("Country")?o++:a("location")},this)),n.done(n.bind(function(){this.user.get("About")?o++:a("bio")},this)),n.push(this.user.getPageNameData().done(n.bind(function(e){s=_.extend({},e.URLs),_.keys(s).length>0?o++:a("links")},this))),n.done(n.bind(function(){this.model.set({progress:Math.ceil(o/u*10)*10,step:r||"complete",userCoverPhoto:i,userProfileURLs:s}),t.resolve()},this)),n.fail(n.bind(t.reject,t)),t.promise()},onCountryChange:function(e){var t=$(e.currentTarget);this.ui.$stateField.closest(".field-container").toggleClass("hide",t.val()!=="US")},onShowMoreLinksClick:function(e){var t=$(e.currentTarget);t.addClass("hide"),t.parent().find(".other-links").removeClass("hide")},onSubmitClick:function(){function s(){n.trigger("notification:add",{description:_.getString("POPUP_UNABLE_UPLOAD_COVER_IMAGE"),type:"error",duration:5e3}),t.removeClass("disabled")}function o(){n.trigger("notification:add",{description:_.getString("SAVE_PROFILE_FAILED"),type:"error",duration:5e3}),t.removeClass("disabled")}function u(){this.updateProgress(),this.ui.$btnsFooter.addClass("hide"),t.removeClass("disabled"),this.model.get("step")!=="complete"&&n.trigger("notification:add",{description:_.getString("PROFILE_COMPLETION_SUCCESS",{url:this.user.toUrl()}),type:"success",duration:5e3})}if(this.destroyed)return;var t=this.$(".submit"),r={},i;if(t.hasClass("disabled"))return!1;t.addClass("disabled");switch(this.model.get("step")){case"profile":this.ui.$profileUploadForm.imgUpload("submit").done(_.bind(function(e){e&&e.filename?(this.user.updatePicture(e.filename),u.call(this)):s()},this)).fail(s);break;case"cover":this.ui.$coverUploadForm.imgUpload("submit").done(_.bind(function(t){if(t&&t.filename){var r=this.user.get("pageNameData");r?(r.CoverPhoto=t.filename+"?"+(new Date).getTime(),this.model.set("userCoverPhoto",_.getImageURL(n.Models.User.coverArtPath+e+"_"+t.filename+"?"+(new Date).getTime())),u.call(this)):this.user.getPageNameData(!0).done(_.bind(function(t){this.model.set("userCoverPhoto",_.getImageURL(n.Models.User.coverArtPath+e+"_"+t.CoverPhoto)),u.call(this)},this))}else s()},this)).fail(s);break;case"location":i=this.$(".location-content"),r.Country=$.trim(i.find(".country").val()),r.Country==="US"?r.State=$.trim(i.find(".state").val()):r.State="",r.City=$.trim(i.find(".city").val()),this.user.changeUserInfo(r).done(_.bind(function(e){e&&e.statusCode===1?u.call(this):s()},this)).fail(o);break;case"bio":r.About=$.trim(this.$(".bio").val()),this.user.changeUserInfo(r).done(_.bind(function(e){e&&e.statusCode===1?u.call(this):s()},this)).fail(o);break;case"links":r.fb=_.replaceLinkPrefix("fb",this.$(".fb").val()),r.tw=_.replaceLinkPrefix("tw",this.$(".tw").val()),r.ig=_.replaceLinkPrefix("ig",this.$(".ig").val()),r.yt=_.replaceLinkPrefix("yt",this.$(".yt").val()),r.site=_.replaceLinkPrefix("site",this.$(".site").val()),_.each(r,function(e,t){e||delete r[t]}),this.user.updateProfileURLs(r).done(_.bind(u,this)).fail(o)}},onCancelClick:function(){if(this.destroyed)return;var e=this.model.get("step"),t={},n;switch(e){case"profile":this.ui.$profileUploadForm.imgUpload("clear");break;case"cover":n=this.ui.$coverUploadForm.imgUpload("clear"),n.find(".btn-container").removeClass("hide"),n.find(".no-preview").addClass("hide"),n.find(".upload-info").removeClass("hide");break;case"bio":t[".bio"]=this.changeModelSelectors[".bio"],this.runChangeModelSelectors(t);break;case"location":t[".state"]=this.changeModelSelectors[".state"],t[".city"]=this.changeModelSelectors[".city"],t[".country"]=this.changeModelSelectors[".country"],this.runChangeModelSelectors(t);break;case"links":t[".field.tw"]=this.changeModelSelectors[".field.tw"],t[".field.yt"]=this.changeModelSelectors[".field.yt"],t[".field.fb"]=this.changeModelSelectors[".field.fb"],t[".field.ig"]=this.changeModelSelectors[".field.ig"],t[".field.site"]=this.changeModelSelectors[".field.site"],this.runChangeModelSelectors(t)}this.ui.$btnsFooter.addClass("hide")},onFieldChange:function(){this.ui.$btnsFooter.removeClass("hide")},onCloseClick:function(){this.destroy()}})}(),function(){n.Views.Modules.FeedEventAlbum=n.Views.Modules.Draggable.extend({cacheKey:"FeedEventAlbum",templateFile:"feedEventItems/album",ui:{eventImageContainer:".event-img-container",imageContainer:".img-container",image:".img",title:".title",artistName:".artist-name",genreLink:".genre-link",playDropdown:".play-dropdown"},events:_.extend({},n.Views.Modules.Draggable.prototype.events,{"click .icon-more":"onMoreClick",contextmenu:"handleContextMenuClick"}),modelEvents:{model:function(){var e=this.options.feedEvent.getTag();e&&this.ui.$genreLink.attr("href",e.toUrl()).text(e.get("DisplayName")).data("tagId",e.id),this.ui.$genreLink.toggleClass("hide",!e),this.ui.$imageContainer.attr("href",this.model.toUrl())},"change:CoverArtFilename":function(e){var t=!!e.get("CoverArtFilename");this.ui.$eventImageContainer.toggleClass("has-cover",t),e.getPageImageURL(t).done(_.bind(function(e){this.ui.$eventImageContainer.css("background-image","url("+e+")")},this)),this.ui.$image.attr("src",this.model.getImageURL(80))},"change:AlbumID":function(e){this.ui.$playDropdown.data("albumId",e.get("AlbumID"))},"change:AlbumName":function(e){this.ui.$title.attr("href",e.toUrl()).text(e.get("AlbumName"))},"change:ArtistName":function(e){this.ui.$artistName.html(_.getString("ALBUM_BYLINE",{artist:'<a href="'+e.toArtistUrl()+'">'+e.escape("ArtistName")+"</a>"}))}},initialize:function(e){this.dragData=e.dragData,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onMoreClick:function(e){var t=$(e.currentTarget),n={closeOnScroll:!0,$attached:t,className:"more-album-menu",$menuOpenEl:t.closest(".module"),player:r.model.get("player")},i="getContextMenuForAlbum";_.asyncTooltipMenu(t,n,this.model,i)},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=new n.Models.PlayContext(s);return o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),_.asyncTooltipMenu(t,{show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,playContext:o,items:[s],ev:e,player:r.model.get("player")},s,"getContextMenuForAlbumRightClick"),!1}})}(),function(){n.Views.Modules.FeedEventArtist=n.Views.Modules.Base.extend({templateFile:"feedEventItems/artist",ui:{eventImageContainer:".event-img-container",imageContainer:".img-container",image:".img",title:".title",genreLink:".genre-link",playDropdown:".play-dropdown",viewSongs:".view-songs",favorite:".favorite",followersCount:".followers.count"},events:{"click .icon-more":"onMoreClick",contextmenu:"handleContextMenuClick"},modelEvents:{model:function(e){var t=this.options.feedEvent.getTag();this.$el.toggleClass("favorited",e.get("isFavorite")),this.ui.$imageContainer.attr("href",e.toUrl()),t&&this.ui.$genreLink.attr("href",t.toUrl()).text(t.get("DisplayName")).data("tagId",t.id),this.ui.$genreLink.toggleClass("hide",!t),this.ui.$playDropdown.data("artistId",e.get("ArtistID"))},"change:CoverArtFilename":function(e){this.ui.$image.attr("src",e.getImageURL(80))},"change:PageArtFilename":function(e){var t=!!e.get("PageArtFilename");this.ui.$eventImageContainer.toggleClass("has-cover",t),e.getPageImageURL(t).done(_.bind(function(e){this.ui.$eventImageContainer.css("background-image","url("+e+")")},this))},"change:ArtistName":function(e){this.ui.$title.attr("href",e.toUrl()).text(e.get("ArtistName"))},"change:pageNameData":function(e){var t=e.get("pageNameData"),n=t&&t.SongCount,r=n&&this.options.artistClaimModule,i=t&&t.FavoriteCount;this.ui.$viewSongs.toggleClass("hide",!r),this.ui.$followersCount.text(_.getStringPluralized("ONE_FOLLOWER","NUM_FOLLOWERS",i,{num:_.addCommaSeparators(i)})).toggleClass("hide",!i||i<1),this.ui.$followersCount.attr("href",this.model.toUrl("followers"))},"change:isFavorite":function(e){this.ui.$favorite.data("artistId",e.get("ArtistID")).toggleClass("hide",n.isLoggedInUserArtistProfile(e.get("ArtistID"))).swapClasses("icon-check","icon-plus",e.get("isFavorite"))}},initialize:function(e){this.dragData=e.dragData,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onMoreClick:function(e){var t=$(e.currentTarget),n={closeOnScroll:!0,$attached:t,className:"more-artist-menu",$menuOpenEl:t.closest(".module"),player:r.model.get("player")},i="getContextMenuForArtist";_.asyncTooltipMenu(t,n,this.model,i)},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=new n.Models.PlayContext(s);return o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),_.asyncTooltipMenu(t,{show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,playContext:o,items:[s],ev:e,player:r.model.get("player")},s,"getContextMenuForArtist"),!1}})}(),function(){n.Views.Modules.FeedEventBroadcast=n.Views.Modules.Base.extend({templateFile:"feedEventItems/broadcast",ui:{eventImageContainer:".event-img-container",title:".title",userName:".user-name",genreLink:".genre-link",joinBroadcast:".join-broadcast"},events:{contextmenu:"handleContextMenuClick"},modelEvents:{model:function(e){var t=this.options.feedEvent.getTag();t&&this.ui.$genreLink.data("tagId",t.id).text(t.get("DisplayName")),this.ui.$genreLink.toggleClass("hide",!t),this.ui.$joinBroadcast.data("broadcastId",e.get("BroadcastID"))},"change:ownerModel":function(e){this.ui.$userName.html(_.getString("BROADCAST_BYLINE",{owner:e.get("ownerModel").getAnchorTag()}))},"change:PageArtFilename":function(e){var t=!!e.get("PageArtFilename");this.ui.$eventImageContainer.toggleClass("has-cover",t),e.getPageImageURL(t).done(_.bind(function(e){this.ui.$eventImageContainer.css("background-image","url("+e+")")},this))},"change:Name":function(e){this.ui.$title.attr("href",e.toUrl()).text(e.get("Name"))}},initialize:function(e){this.dragData=e.dragData,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDestroy:function(){this.unmonitor()},completeRender:function(){this._super.apply(this,["completeRender"].concat(_.toArray(arguments))),this.renderActiveSong(),this.listenTo(this.model,"change:activeSong",this.renderActiveSong),this.listenTo(n,"scroll",_.debounce(this.updateMonitor,100)),this.updateMonitor()},renderActiveSong:function(){if(!this.rendered)return;var e=this.model.get("activeSong"),t=this.$(".active-song"),r=this.$(".song-module");if(!e){t.addClass("hide"),this.activeSongModule&&this.activeSongModule.destroy();return}this.activeSongModule&&!this.activeSongModule.destroyed&&this.activeSongModule.destroy(),this.activeSongModule=new n.Views.Modules.SongRowTall({model:this.model.get("activeSong")}),this.activeSongModule.render(),r.html(this.activeSongModule.el),t.removeClass("hide")},updateMonitor:function(e){var t=_.defined(e)?e:$(document).scrollTop(),n=t+document.documentElement.clientHeight,r=this.$el.offset().top,i=r+this.$el.innerHeight(),s=t<i&&n>r;s?this.monitor():this.unmonitor()},monitor:function(){n.Models.Broadcast.getCached(this.model.get("BroadcastID"))||n.Models.Broadcast.cache(this.model),this.model.monitor()},unmonitor:function(){this.model.unmonitor()},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=new n.Models.PlayContext(s);return o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),_.asyncTooltipMenu(t,{show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,playContext:o,items:[s],ev:e,player:r.model.get("player")},s,"getContextMenuForBroadcast"),!1}})}(),function(){n.Views.Modules.FeedEventPlaylist=n.Views.Modules.Draggable.extend({templateFile:"feedEventItems/playlist",ui:{eventImageContainer:".event-img-container",title:".title",followers:".followers",genreLink:".genre-link",playlistByline:".playlist-byline",playDropdown:".play-dropdown",favorite:".favorite"},events:{contextmenu:"handleContextMenuClick"},modelEvents:{model:function(e){var t=this.options.feedEvent.getTag();t&&this.ui.$genreLink.attr("href",t.toUrl()).text(t.get("DisplayName")).data("tagId",t.id),this.ui.$genreLink.toggleClass("hide",!t),this.ui.$playlistByline.html(_.getString("PLAYLIST_BYLINE",{user:e.getAuthorAnchorTag()})),this.ui.$playDropdown.data("playlistId",e.get("PlaylistID"))},"change:CoverPhoto":function(e){var t=!!e.get("CoverPhoto");this.ui.$eventImageContainer.toggleClass("has-cover",t),e.getPageImageURL(640).done(_.bind(function(e){this.ui.$eventImageContainer.css("background-image","url("+e+")")},this))},"change:PlaylistName":function(e){this.ui.$title.attr("href",e.toUrl()).text(e.get("PlaylistName"))},"change:SubscriberCount":function(e){var t=e.get("SubscriberCount");this.ui.$followers.html(_.getStringPluralized("ONE_SUBSCRIBER","NUM_SUBSCRIBERS",t,{num:_.addCommaSeparators(t)})).toggleClass("hide",!t||t<=0)},"change:isFavorite":function(){var e=this.model.get("isFavorite"),t=e?"UNSUBSCRIBE":"SUBSCRIBE";this.ui.$favorite.data("playlistId",this.model.get("PlaylistID")).data("translateTitle",t).removeData("tooltipText").toggleClass("hide",this.model.get("UserID")==n.getLoggedInUserID()).swapClasses("icon-check","icon-plus",e)}},initialize:function(e){this.dragData=e.dragData,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=new n.Models.PlayContext(s);return o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),_.asyncTooltipMenu(t,{show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,playContext:o,items:[s],ev:e,player:r.model.get("player")},s,"getContextMenuForPlaylist"),!1}})}(),function(){var e=_.extend({},n.Views.Modules.Draggable.prototype,{className:"module module-row song feed-song tall",templateFile:"songRowFeed",albumHidden:!0,ui:_.extend({},n.Views.Modules.SongRowBase.prototype.ui,{eventImageContainer:".event-img-container",artist:".artist",image:".img",title:".title",artistName:".artist-name",tag:".tag",genreLink:".genre-link",playDropdown:".play-dropdown"}),events:_.extend({},n.Views.Modules.SongRowBase.prototype.events,n.Views.Modules.Draggable.prototype.events,{contextmenu:"handleContextMenuClick"}),modelEvents:{model:function(e){var t=this.getSongTag();this.ui.$tag.toggleClass("hide",!t),t&&this.ui.$tag.attr("href",t.toUrl()).innerText(t.get("DisplayName")),this.ui.$artist.html(_.getString("SONG_BY_ARTIST",{artist:e.getArtistAnchorTag()}))},"change:CoverArtFilename":function(e){this.ui.$image.attr("src",e.getImageURL(this.options.requestedImageSize||40)).attr("alt",e.get("SongName"))},"change:SongName":function(e){this.ui.$title.text(e.get("SongName")).data("songId",e.get("SongID"))}},initialize:function(e){this._super("initialize",e),this.dragData=e.dragData},getSongTag:function(){var e=this.options&&this.options.feedEvent&&this.options.feedEvent.getTag();return e||this.model.get("Tag")},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=new n.Models.PlayContext;return o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),s.get("isCallout")?!1:(_.asyncTooltipMenu(t,{show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,playContext:o,items:[s],ev:e,player:r.model.get("player")},s,"getContextMenuForSong"),!1)},mobileAction:function(e){var t=new n.Models.PlayContext;e.target.tagName==="DIV"&&(t.addStreamType(n.Models.PlayContext.TYPE_RECOMMENDED),this.model.play({context:t,playOnAdd:!0}))}});delete e.constructor,n.Views.Modules.SongRowFeed=n.Views.Modules.SongRowBase.extend(e)}(),function(){n.Views.Modules.FeedEventUser=n.Views.Modules.Base.extend({templateFile:"feedEventItems/user",ui:{eventImageContainer:".event-img-container",userImageContainer:".user-img-container",title:".title",image:".img",location:".location",favorite:".favorite",playStation:".play-station",topArtistsMeta:".top-artists-meta",topArtists:".top-artists",badgesContainer:".badges-container"},events:{contextmenu:"handleContextMenuClick"},modelEvents:{model:function(e){var t=!!e.get("CoverArtFilename"),r=this.childViews.badges;this.ui.$eventImageContainer.toggleClass("has-cover",t),e.getPageImageURL(t).done(_.bind(function(e){this.ui.$eventImageContainer.css("background-image","url("+e+")")},this)),this.ui.$userImageContainer.attr("href",e.toUrl());if(!r||r.destroyed||r.item.get("UserID")!==e.get("UserID"))r&&!r.destroyed&&r.destroy(!1),this.childViews.badges=new n.Views.Badges({el:this.$(".badges-container"),item:e}),this.childViews.badges.render();this.ui.$playStation.data("userId",e.get("UserID"))},"change:Name":function(e){this.ui.$title.attr("href",e.toUrl()).text(e.get("Name"))},"change:CoverArtFilename":function(e){this.ui.$image.attr("src",e.getImageURL(80))},"change:Location":function(e){var t=e.get("Location");this.ui.$location.toggleClass("hide",!t).text(t)},"change:isFavorite":function(e){var t=e.get("UserID"),r=t===n.getLoggedInUserID();this.$el.toggleClass("favorited",e.get("isFavorite")),this.ui.$favorite.data("userId",t).toggleClass("hide",r).swapClasses("icon-check","icon-plus",e.get("isFavorite"))},"change:topArtists":function(e){var t=e.get("topArtists"),n=[];if(!t||t.length<1){this.ui.$topArtistsMeta.addClass("hide");return}_.each(t.take(3),function(e){n.push(e.getAnchorTag())}),this.ui.$topArtists.empty().append(n.join(", ")).removeClass("hide")}},initialize:function(e){this.dragData=e.dragData,this._super("initialize",e)},changeModel:function(e){this.childViews.badges&&!this.childViews.badges.destroyed&&(this.childViews.badges.destroy(!1),this.childViews.badges=null),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=new n.Models.PlayContext(s);return o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),_.asyncTooltipMenu(t,{show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,playContext:o,items:[s],ev:e,player:r.model.get("player")},s,"getContextMenuForUser"),!1}})}(),define("gs/views/modules/broadcastDateRow.js",function(){n.Views.Modules.BroadcastDateRow=n.Views.Modules.Base.extend({className:"module broadcast-date-row grid-item",cacheKey:"BroadcastDateRow",templateFile:"broadcastDateRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".bc-link":function(e,t){_.$one(t).attr("href",this.model.toUrl(!0)).innerText(_.getFormattedDate(this.model.get("TSCreated")))}}})}),define("gs/views/cards/about.js",function(){n.Views.Cards.About=Backbone.View.extend({templatePath:"cards",templateFile:"about",className:"card about",ui:{cardContent:".card-content",descTitle:".desc-title",description:"@cardContent .description",linkSection:".social-links",linksList:"@linkSection .social-list",cardTitle:".card-title",header:".header",headerTitle:"@header .title",promoImage:".promo-img-container",showMoreContainer:".show-more-container",showMoreBtn:".show-more"},events:{"click @showMoreBtn":"onClickShowMoreBtn"},initialize:function(e){e.owner&&(this.owner=e.owner,this.owner.getPageNameData(),this.model instanceof n.Models.Broadcast?this.isOwner=this.model.isLoggedInUserOwner():this.isOwner=this.owner.id==n.getLoggedInUserID()),this.followLocale=e.followLocale,this.isArtist=this.model instanceof n.Models.Artist,this.cardTitleLocale=e.cardTitleLocale,this.descTitleLocale=e.descTitleLocale,this.hideLinks=e.hideLinks,this.isOwner&&(this.cardTitleLocale=this.descTitleLocale),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=_.isFunction(this.model.getPageNameData),t=new ChainLoading;return this.renderDfd||(this.renderDfd=new $.Deferred),this.rendered||(this.rendered=!0,e?t.push(this.model.getPageNameData()):this.owner&&!this.hideLinks&&t.push(this.owner.getPageNameData()),t.push(this.fetchTemplate(this.templateFile).always(t.bind(this.onTemplate,this)))),this.renderDfd},onTemplate:function(e){this.$el.html(this.renderTemplate(e)),this.bindUIElements(),this.ui.$header.toggleClass("hide",!this.cardTitleLocale),this.cardTitleLocale&&this.ui.$headerTitle.text(_.getString(this.cardTitleLocale)).data("translateText",this.cardTitleLocale),this.renderComplete=!0,this.listenTo(this.model,"change:About",this.renderDescription),this.listenTo(this.model,"change:Description",this.renderDescription),this.listenTo(this.model,"change:pageNameData",this.renderPageNameData),this.listenTo(this.model,"change:PromoImage",this.renderPromoImage),this.renderPageNameData(),this.hideLinks||(this.listenTo(this.model,"change:URLs",this.renderURLs),this.renderURLs()),this.renderDescription(),this.renderPromoImage(),this.hideIfEmpty(),this.owner&&(this.childViews.ownerRow=new n.Views.Modules.OwnerRow({followLocale:this.followLocale,showFollowBtn:!this.isOwner,model:this.owner}),this.childViews.ownerRow.render(),this.$el.prepend(this.childViews.ownerRow.$el),this.childViews.ownerRow.$el.toggleClass("hide",this.isOwner)),n.trigger("page:redrawUpdate"),this.renderDfd.resolve(!0)},hideIfEmpty:function(){var e=!!this.ui.$linksList.text(),t=!!this.ui.$description.text(),n=!!this.model.get("PromoImage"),r=!e&&!t&&!n;this.$el.toggleClass("hide",r&&(this.isOwner||!this.owner)),this.ui.$cardContent.toggleClass("hide",r)},handleLink:function(e,t){var r="http://",i="globe",s,o;if(!t)return"";switch(e){case"yt":r="http://youtube.com/";break;case"ig":r="http://instagram.com/";break;case"fb":r="http://facebook.com/";break;case"sc":r="http://soundcloud.com/";break;case"bc":r="http://bandcamp.com/";break;case"sk":r="http://songkick.com/";break;case"tw":r="http://twitter.com/";break;case"ms":r="http://myspace.com/";break;case"mr":o="MERCHANDISE";break;case"site":o="WEBSITE"}return o||(s=n.Models.User.urlTypes[e]),n.Models.User.urlIcons[e]&&(i=n.Models.User.urlIcons[e]),!_.startsWith(t,"http:")&&!_.startsWith(t,"https:")&&(t=r+t),this.createLinkElement(e,_.escape(t),i,o,s)},renderPageNameData:function(){var e=this.model.get("pageNameData"),t=e&&e.URLs,n=[],r,i;!t&&this.owner&&(e=this.owner.get("pageNameData"),t=e&&e.URLs);if(this.hideLinks){this.ui.$linkSection.addClass("hide"),this.ui.$linksList.html(""),this.hideIfEmpty();return}if(!t||t.length<1){this.model.get("URLs")||(this.ui.$linkSection.addClass("hide"),this.ui.$linksList.html(""),this.hideIfEmpty());return}for(r in t){if(!t.hasOwnProperty(r)||!t[r])continue;i=this.handleLink(r,t[r]),i&&n.push(i)}this.ui.$linksList.html(_.take(n,5).join("&#124;")),this.ui.$linkSection.removeClass("hide"),this.$el.removeClass("hide")},createLinkElement:function(e,t,n,r,i){!i&&!r;var s;return r&&(i=_.getString(r)),s='<a class="social-link '+e+'" target="_blank" href="'+t+'"><i class="icon icon-'+n+'"></i>',r?s+='<span class="label" data-translate-text="'+r+'">':s+='<span class="label">',s+=i+"</span></a>",s},renderDescription:function(){var e=this.model.get("pageNameData"),t=e&&e.Bio||this.model.get("Bio")||this.model.get("Description")||this.model.get("About"),n=this.descTitleLocale&&_.getString(this.descTitleLocale);this.ui.$descTitle.toggleClass("hide",!this.descTitleLocale||!!this.cardTitleLocale).data("translateText",this.descTitleLocale).text(n),t?(this.ui.$description.html(_.makeSafeLinks(t)).removeAttr("data-translate-text").removeClass("hide"),this.$el.removeClass("hide")):(this.ui.$description.html("").addClass("hide"),this.hideIfEmpty())},renderPromoImage:function(){var e=this.model.get("PromoImage"),t,n;if(!e){this.ui.$promoImage.addClass("hide"),this.ui.$showMoreContainer.addClass("hide");return}n=_.bind(function(){!this.destroyed&&t[0].naturalHeight>this.ui.$promoImage.height()?this.ui.$showMoreContainer.removeClass("hide"):this.ui.$showMoreContainer.addClass("hide"),t.off("load",n)},this),this.$el.hasClass("open")&&(this.$el.removeClass("open"),this.updateShowMoreButton()),t=this.ui.$promoImage.removeClass("hide").find(".promo-img"),t.on("load",n),t.attr("src",this.model.getPromoImageURL())},updateShowMoreButton:function(){this.$el.hasClass("open")?(this.ui.$showMoreBtn.find(".label").attr("translateText","COLLAPSE").text(_.getString("COLLAPSE")),this.ui.$showMoreBtn.find(".icon").removeClass("icon-caretdown").addClass("icon-caretup")):(this.ui.$showMoreBtn.find(".label").attr("translateText","SHOW_MORE").text(_.getString("SHOW_MORE")),this.ui.$showMoreBtn.find(".icon").removeClass("icon-caretup").addClass("icon-caretdown"))},onClickShowMoreBtn:function(){this.$el.toggleClass("open"),this.updateShowMoreButton()},renderURLs:function(){var e=this.model.get("URLs"),t=this.model.get("pageNameData"),n=[],r,i;if(this.hideLinks){this.ui.$linkSection.addClass("hide"),this.ui.$linksList.html(""),this.hideIfEmpty();return}if(!e){t&&!t.URLs&&(this.ui.$linkSection.addClass("hide"),this.ui.$linksList.html(""),this.hideIfEmpty());return}for(r in e){if(!e.hasOwnProperty(r)||!e[r])continue;typeof e[r]=="object"&&(i=e[r].url,r=e[r].type),i=this.handleLink(r,i),i&&n.push(i)}this.ui.$linksList.html(_.take(n,5).join("&#124;")),this.ui.$linkSection.removeClass("hide"),this.$el.removeClass("hide")}})}),define("gs/views/cards/helper.js",function(){n.Views.Cards.HelperCard=Backbone.View.extend({templatePath:"cards",templateFile:"helper",className:"card helper",ui:{helperContent:".helper-content",close:".close"},events:{"click @close":"onCloseClick"},initialize:function(e){var t=e||{};this.model=new Backbone.Model({locale:t.locale,localeOpts:t.localeOpts||{},html:t.html,htmlId:t.htmlId,page:t.page,subpage:t.subpage}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){this.rendered||this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this)),this.rendered=!0},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this)),this.bindUIElements(),this.listenTo(this.model,"change",this.renderContent),this.renderContent()},renderContent:function(){var e=n.Services.Local.get("helperCardsClosed")||[],t=this.model.get("locale"),r=this.model.get("localeOpts"),i=this.model.get("html"),s=this.model.get("htmlId"),o=this.model.get("page"),u=this.model.get("subpage"),a=s||t;u&&(a=u+"-"+a),o&&(a=o+"-"+a);if(!t&&!s||_.indexOf(e,a)>-1){this.$el.addClass("hide");return}i?this.ui.$helperContent.html(i):this.ui.$helperContent.text(_.getString(t,r)).data("translateText",t),this.helperID=a,this.$el.removeClass("hide")},onCloseClick:function(e){var t=n.Services.Local.get("helperCardsClosed")||[];t.push(this.helperID),n.Services.Local.set("helperCardsClosed",t),this.$el.addClass("hide")}})}),function(){function a(e,t){function d(){var e=parseInt(s.css("max-width"),10),t=s.parent().width(),n=e&&t?e<t?e:t:e||t,r=_.defined(n)&&_.calculateTextWidth(s.text(),{fontSize:s.css("font-size"),fontWeight:s.css("font-weight")})<=n;return r}var i=t||{},s=$(e.currentTarget),o=s.hasClass("play"),u=s.data("tooltipText")||"",a=s.data("tooltipDelay")||140,f=s.data("translateText")||s.data("translateTitle")||null,l=s.parents("#sidebar, .sticky").length||!1,c=s.attr("title")||null,h,p;c&&s.attr("title","");if(s.hasClass("no-title-tooltip")||r.model.get("appMode")==="mobile"||s.hasClass("helper-tooltip-measured")&&d())return;o?u=_.getString("PLAY_NOW"):u.length||(f?u=_.getString(f):(h=_.getString(s.find(".accessible-title").data("translateText"))||null,u=c||h||s.text()));if(!u)return;return p=new n.Views.Tooltips.Helper(_.defaults(i,{text:u,fixed:l,delay:a,pointerEvents:"none"})),n.Views.Tooltips.Helper.simpleTooltip(e,p),s.data("tooltipText",u).on("mouseleave.appTooltip",function(){s.off("mouseleave.appTooltip"),_.isFunction(i.onClose)&&i.onClose(p),c&&s.attr("title",c),n.trigger("tooltip:close",p.options.tooltipKey)}),e.stopPropagation(),p}function f(e,t){a(e,t)}function l(e,t){var i=$(e.currentTarget),s=t||{},o=i.find(".icon"),u=n.isBroadcaster(),f=u||n.isBroadcastListener(),l,c,h;s.onClose=function(){$(document.body).off("keydown.appTooltip, keyup.appTooltip"),c&&c({})},l=a(e,s),h=function(e){l&&l.updateText(e)},c=function(e){var t=e.altKey||e.shiftKey;o.swapClasses("icon-plus-circle","icon-play-circle-fill",t),h(t?_.getString("PLAY_LAST"):_.getString("PLAY_NOW"))},$(document.body).on("keydown.appTooltip, keyup.appTooltip",c),f?u?r.model.get("player").playStatusIsPlaying(!0)?h(_.getString("PREVIEW")):h(_.getString("PLAY_NOW")):h(_.getString("PREVIEW")):c(e)}function c(e){var t=$(e.currentTarget),r,i;if(t.hasClass("learn-broadcasts"))r="LB_BROADCAST_ABOUT_TITLE",i="LB_BROADCAST_ABOUT_INFO";else{if(!t.hasClass("learn-feed"))return;r="LEARN_FEED_TITLE",i="LEARN_FEED_MSG"}n.trigger("lightbox:open",{_type:"learnMore",view:{header:r,message:i}})}function h(e){var t=$(e.currentTarget),r=t.closest(".module"),i=t.data(),s=i.playlistId,o=i.songId,u=i.albumId,a=i.userId,f=i.artistId,l=i.tagId,c=i.broadcastId,h=r.data("model"),p;return h||(p=r.data("module"),p&&(h=p.model)),h&&h._wrapped&&(h=h._wrapped),s?h&&h instanceof n.Models.Playlist&&h.get("PlaylistID")===s?$.Deferred().resolve(h).promise():n.Models.Playlist.get(s):o?h&&h instanceof n.Models.Song&&h.get("SongID")===o?$.Deferred().resolve(h).promise():n.Models.Song.get(o):u?h&&h instanceof n.Models.Album&&h.get("AlbumID")===u?$.Deferred().resolve(h).promise():n.Models.Album.get(u):a?h&&h instanceof n.Models.User&&h.get("UserID")===a?$.Deferred().resolve(h).promise():n.Models.User.get(a):f?h&&h instanceof n.Models.Artist&&h.get("ArtistID")===f?$.Deferred().resolve(h).promise():n.Models.Artist.get(f):l?h&&h instanceof n.Models.Tag&&h.get("TagID")===l?$.Deferred().resolve(h).promise():n.Models.Tag.get(l):c?h&&h instanceof n.Models.Broadcast&&h.get("BroadcastID")===c?$.Deferred().resolve(h).promise():n.Models.Broadcast.get(c):h?$.Deferred().resolve(h).promise():$.Deferred().reject().promise()}n.Views=n.Views||{};var i=" - Grooveshark",s="Grooveshark - ",o,u,p=["bg","ca","cs","cy","da","de","el","en","es","eu","et","gl","fi","fr","hr","hu","it","ja","ko","lt","lv","nb","nl","pl","pt","ro","ru","sk","sl","sv","tr","uk","zh"],d="en";n.Views.Application=Backbone.View.extend({el:"body",lastActive:null,events:{"click .module-row":"onModuleClick","click a,.btn,input":"logGenericClick","click .search-link":"searchLink","click .song-link":"songLink","click .comment-link":"commentLink","click .play":"onPlayClick","click .play-genre":"onPlayGenreClick","click .play-station":"onPlayStationClick","click .join-broadcast":"onJoinBroadcastClick","click .open-broadcast":"onOpenBroadcastClick","click .start-broadcast":"onStartBroadcastClick","click .leave-broadcast":"onLeaveBroadcastClick","click .stop-broadcast":"onStopBroadcastClick","click .favorite":"onFavoriteClick","click .share, .song-row-share, .album-cell-share, .artist-cell-share":"onShareClick","click .song-row-add, #np-add":"onAddClick","click #jh-feedback":"onFeedbackClick","click .genre-link":"onGenreTagClick","click .suggest-music":"onSuggestClick","click .play-dropdown":"onPlayDropdownClick","click .capital-ad-report":"openReportAd","click .placeholder-text":"onPlaceholderClick","click .upload-music":"showUploadLightbox","click .invite-friends":"onInviteFriendsClick","click .who-to-follow":"onWhoToFollowClick","click .empty-submit":"submitEmptySearch","click .bc-invite":"onBroadcastInviteClick","click .change-context":"onChangeContextClick","click .logout":"onLogoutClick","submit .do-search":"doSearch","focus .placeholder-input":"onPlaceholderFieldFocus","keyup .placeholder-input":"onPlaceholderFieldChange","keypress .placeholder-input":"onPlaceholderFieldKeypress","change .placeholder-input":"onPlaceholderFieldChange","paste .placeholder-input":"onPlaceholderFieldPaste","blur .placeholder-input":"onPlaceholderFieldBlur","change .radio-field input":"onRadioInputChange","mouseenter .scrollable":"scrollbarFadeIn","mouseleave .scrollable":"scrollbarFadeOut","mouseenter .scrollbar":"onScrollbarMouseenter","mouseleave .scrollbar":"onScrollbarMouseleave","mousedown .scrollable .scrollbar":"onScrollbarMouseDown","mouseenter .song-row-add":"onSongRowAddMouseenter","mouseenter .song-row-favorite":"onSongRowFavMouseenter","mouseenter #np-fav":"onSongRowFavMouseenter","mouseenter #np-add":"onSongRowAddMouseenter","mouseenter .show-user-tooltip":"openUserTooltip","mouseenter .helper-tooltip, .helper-tooltip-measured":_.bind(f,e),"mouseenter .play":_.bind(l,e),"click #app-overlay":"onAppOverlayClick","click .learn-link":_.bind(c,e)},setup:function(){this.scrolling=!1,gsConfig.isMobile?this.model.set("appMode","mobile"):this.model.set("appMode","desktop"),$("body").toggleClass("mobile",gsConfig.isMobile),n.on("setTitle",this.setTitle,this),this.onActivityThrottled=_.throttle(_.bind(this.onActivity,this),1e3),this.$el.on("mousemove."+this.cid,this.onActivityThrottled),this.$el.on("keydown."+this.cid,this.onActivityThrottled),this.onActivity(),gsConfig.isMobile||n.on("fakeScroll",_.bind(this.handleFakeScroll,this));var t=$("#container"),r=this,i=function(){var i=document.clientWidth,s=Math.max(e.innerHeight,e.scrollHeight||0),u=e.outerWidth;typeof o!="undefined"&&o.handleResize(),_.resizeClipboardHandler(),t.css("min-height",s),n.trigger("app:resize",i,s),u>=n.Models.Model.APP_SIZES.desktopXL?r.model.set("appSize","desktopXL"):u>=n.Models.Model.APP_SIZES.desktop?r.model.set("appSize","desktop"):u>=n.Models.Model.APP_SIZES.tablet?r.model.set("appSize","tablet"):r.model.set("appSize","mobile")};$(e).on("resize",i),i(),$(document).on("scroll",_.bind(this.handleScroll,this)),this.footer={render:_.bind(function(){this.fetchTemplate("shared/footer").always(_.bind(function(e){$("#footer").html(e())},this))},this)},this.player=new n.Views.Player({el:$("#player-wrapper")[0],model:this.model}),this.queue=new n.Views.Queue({model:this.model}),this.sidebar=new n.Views.Sidebar({model:this.model}),this.header=new n.Views.Header({model:this.model,gsApp:this}),this.page=new n.Views.Page({model:this.model});var s=_.extend({},Backbone.Events);this.theme=new n.Views.Theme({model:this.model,eventer:s}),this.ad=new n.Views.Ads({model:this.model,eventer:s});var o=this.lightbox=new n.Views.Lightbox({model:this.model});this.tooltip=new n.Views.Tooltip({model:this.model}),this.notification=new n.Views.Notification({model:this.model}),e.nodeWebkit&&(this.desktopNavBar=new n.Views.DesktopNavBar({el:this.$("#desktop-nav-bar")})),this.leapLibLoaded=!1,this.leapLibAttempts=0,this.adRollLoaded=!1,this.model.set("adrollPages",[]),this.model.on("userChange:started",this.onUserChangeStarted,this),this.model.on("userChange:finished",this.onUserChangeFinished,this),this.model.on("change:user",this.onUserChange,this),this.model.on("change:user",i,this),this.model.on("change:userActive",this.loadAdroll,this),this.onUserChange(),this.lastTitleObj={title:(document.title||"").replace(" - Grooveshark","").replace("Grooveshark - ",""),page:this.page.getCurrentPageView()},this.model.get("player").on("change:playStatus",function(){this.setTitle(this.lastTitleObj)},this);var u=(n.Services.Local.get("gs.locale")||gsConfig.lang||this.detectLangauge()||"en").substring(0,2);_.indexOf(p,u)===-1&&(u="en"),n.on("locale:change",this.refreshLanguage,this),$.localize.ready.done(_.bind(function(){this.refreshLanguage(this.model.get("locale")),n.trigger("locale:loaded",u)},this)),this.refreshLanguage(u),n.on("manatee:broadcastGet",function(e){(!e||!e.success)&&n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_GET_FAILED"),type:"error",duration:5e3})}),n.on("manatee:broadcastInvite",this.onBroadcastInvitation,this),$(document).on("keypress",_.bind(function(e){var t=e.target&&e.target.tagName||"",n=["input","textarea","select","object"],r=e.metaKey||e.ctrlKey||e.altKey;if(r||!_.isString(t)||_.indexOf(n,t.toLowerCase())!=-1||e.target.getAttribute("contenteditable"))return;var i=e.which,s=i&&String.fromCharCode(i).replace(/\s+/g,"");if(i==8)history.back();else if(s){var o=$("#sidebar-search").find("input"),u=o.val();return this.onPlaceholderFieldFocus({currentTarget:o[0]}),o.focus(),o.val(u+s),!1}},this)),n.on("leap:loadLib",this.loadLeapLibrary,this),n.on("leap:unloadLib",this.unloadLeapLibrary,this),n.on("manatee:globalAlert",this.handleGlobalAlert,this),n.on("logPlaylistPlay",this.logPlaylistPlay,this),n.on("logAlbumPlay",this.logAlbumPlay,this),n.on("setScrollThumbHeight",this.setScrollThumbHeight,this)},handleScroll:function(){this.scrolling||(this.scrolling=!0,n.trigger("scrollStart")),n.trigger("scroll",$(document).scrollTop()),this.scrollingTimeout&&clearTimeout(this.scrollingTimeout),this.scrollingTimeout=setTimeout(_.bind(function(){this.scrolling=!1,n.trigger("scrollEnd")},this),250)},render:function(){this.sidebar.render(),this.player.render(),this.page.render(),this.lightbox.render(),this.footer.render(),this.desktopNavBar&&this.desktopNavBar.render(),this.showHiringMsg({inConsole:!0,inPoptart:!1}),gsConfig.isMobile&&!0&&this.showMobileWarning()},showMobileWarning:function(){$.localize.ready.done(function(){n.trigger("lightbox:open","generic",{_type:"mobile-warning",view:{header:"HEADS_UP",bigHeader:"MOBILE_LB_SUBTITLE",messageHTML:'<span data-translate-text="MOBILE_LB_WARNING">'+_.getString("MOBILE_LB_WARNING")+'</span><br><br><a class="cancel" data-translate-text="MOBILE_LB_STAY">'+_.getString("MOBILE_LB_STAY")+"</a>",buttonsLeft:[{href:"https://html5.grooveshark.com",label:"MOBILE_LB_LEAVE",className:"btn-success"}]},callbacks:{".cancel":function(e){n.trigger("lightbox:close")}}})})},handleGlobalAlert:function(e){if(!e||!e.messageType)return;if(e.test&&gsConfig.runMode=="production"||e.preview&&!gsConfig.isPreview){console.log("Ignoring test globalAlert message");return}switch(e.messageType){case"message":if(e.id){if(u){if(u.outageType==e.messageType&&u.outageID==e.id&&e.id!="RAW")return;n.trigger("notification:close",u)}var t=this.model.get("user"),r=t.get("isLoggedIn"),i="",s={},o=0,a=0,f;switch(e.id){case-1:case"CLEAR":u&&n.trigger("notification:close",u);break;case 1:case"DATABASE_GOING_DOWN":s.duration=60,e.params.duration&&(a=e.params.duration*60*1e3),i="DATABASE_GOING_DOWN";break;case 2:r&&(i="PLAYLISTS_DOWN");break;case 3:case"NEW_VERSION_ALERT":if(!e.params||!e.params.minVersion||e.params.minVersion>gsConfig.revision)i="NEW_VERSION_ALERT",f=Math.max(15,_.toInt(_.orEqual(e.params&&e.params.delay,60))),o=Math.floor(Math.random()*f*60*1e3);break;case"BROADCASTS_UPGRADED":if(!e.params||!e.params.minVersion||e.params.minVersion>gsConfig.revision)i="BROADCASTS_UPGRADED",f=Math.max(15,_.toInt(_.orEqual(e.params&&e.params.delay,60))),o=Math.floor(Math.random()*f*60*1e3);break;case 4:case"BROADCASTS_DOWN":s.duration=15,e.params.duration&&(a=e.params.duration*60*1e3),i="BROADCASTS_DOWN";break;case 5:i="STREAMS_DOWN";break;case 6:i="INTERMITTENT_DOWN";break;case 7:r&&(i="NOTIFICATIONS_DOWN");break;case 8:i="UPLOADS_DOWN";break;case 9:case"ARTISTS_DOWN":var l=t.get("artistsOwned");l&&l.length&&(i="ARTISTS_DOWN");break;case"BROADCASTS_DOWN_LATER_MINS":s.duration=15,e.params.duration&&(a=e.params.duration*60*1e3),i="BROADCASTS_DOWN_LATER_MINS";break;case"BROADCASTS_DOWN_LATER_HOURS":s.duration=2,e.params.duration&&(a=e.params.duration*60*60*1e3),i="BROADCASTS_DOWN_LATER_HOURS";break;case"PLANNED_MAINTENANCE_MINS":s.duration=15,s.extraInfo="",e.params.duration&&(a=e.params.duration*60*1e3),i="PLANNED_MAINTENANCE_MINS";break;case"PLANNED_MAINTENANCE_HOURS":s.duration=2,s.extraInfo="",e.params.duration&&(a=e.params.duration*60*60*1e3),i="PLANNED_MAINTENANCE_HOURS";break;case"EVERYTHING_COMPLETE_ROCK_ON":a=3e5,i="EVERYTHING_COMPLETE_ROCK_ON";break;case"PLAYLISTS_CLUSTER_DOWN":case"COMMENTS_CLUSTER_DOWN":case"FEEDS_CLUSTER_DOWN":s.extraInfo="",i=e.id;break;case"LOGIN_ISSUES":r||(i=e.id);break;case"PLAYLIST_ISSUES":case"COLLECTION_FAVORITES_ISSUES":case"NOTIFICATIONS_DOWN":case"PLAYLISTS_DOWN":r&&(i=e.id);break;case"UPLOADS_DOWN":case"INTERMITTENT_DOWN":case"STREAMS_DOWN":case"BROADCASTS_ISSUES":case"TAGS_ISSUES":case"POPULAR_ISSUES":case"RAW":i=e.id}a?a=Math.max(a,Math.min(5*a,432e5)):a=432e5;if(!i)return;var c;if(i=="RAW"){if(!e.params.text)return;c=_.escape(e.params.text)}else c=_.getString(i,$.extend(s,e.params));var h=function(){var t;n.trigger("notification:add",{description:c,type:"error",duration:a,initFunc:function(n){t=u=n,n.outageType=e.messageType,n.outageID=e.id},closeAction:function(){u===t&&(u=null)}})};o>0?setTimeout(h,o):h()}break;case"manateeGoingDown":u||n.trigger("notification:add",{description:_.getString("MANATEE_GOING_DOWN"),type:"error",duration:0,initFunc:function(t){u=t,t.outageType=e.messageType},closeAction:function(){u&&u.outageType==e.messageType&&(u=null)}})}},onUserChangeStarted:function(e){this.page.removeCurrentPageView()},onUserChangeFinished:function(t){var r=t.destination,i=e.location.hash||"#!";r||(r="#!/"),t.preventRedirect||n.router.setHash(r),$(e).trigger("hashchange",{force:!0}),n.trigger("leap:unloadLib")},setTitle:function(e){if(!e||!e.title||!e.page)return;e=_.clone(e);var t=e.title,r=e.prepend,o=e.page;_.isArray(t)&&(t=_.filter(t,function(e){return e}),t=t.join(" - ")),this.lastTitleObj=e,_.defer(_.bind(function(){var e=this.page.getCurrentPageView();if(o!==e&&e&&o!==e.broadcastView)return;r=_.orEqual(r,!0);var u="",a=($.browser.version||"").split("."),f=$.browser.webkit;$.browser.chrome&&_.toInt(a[0])>31&&(f=!1),n.Models.Player.isPlayStatusPlaying(!0)&&f&&(u=" "),r?this.lastTitle=u+t+i:this.lastTitle=u+s+t,document.title=this.lastTitle},this))},onUserChange:function(){var e=$("#jh-feedback"),t=this.model.get("user"),n=t.get("subscription").canHideAds(),r=Math.random(),i=.9,s=this.model.get("appMode")==="mobile",o=(new Date).getDay();$(document.body).toggleClass("premium-user",n),$(document.body).swapClasses("logged-in","logged-out",t.get("isLoggedIn")),o>1&&o<6&&(i=.5),s||!n&&r<i?e.addClass("hide"):e.removeClass("hide"),this.footer.render()},detectLangauge:function(){var t=e.navigator;return t.language||t.browserLanguage||t.systemLanguage||t.userLanguage},refreshLanguage:function(e,t){var r=t||{},i=$("#jh-feedback");_.indexOf(p,e)===-1&&(e="en"),$("[data-translate-text]").localize("gs",{language:e,reselect:!0}).done(_.bind(function(){var t,s;$("[data-translate-title]").localize("gs",{language:e,reselect:!0,callback:"titleCallback"}),n.Services.Local.set("gs.locale",e),this.model.set("locale",e);if(e!==d){t=_.getString("WEEK_DAYS"),t&&t.length&&(_.daysOfTheWeek=t.split(",")),s=_.getString("MONTHS"),s&&s.length&&(_.monthsOfTheYear=s.split(",")),console.warn(_.monthsOfTheYear),n.trigger("locale:changed",e),d=e;if(r.userSet){var o=this.model.get("user");o.id>0&&o.saveUserPreferences({locale:e})}}i.hasClass("hide")||i.removeClass().addClass(e)},this))},logGenericClick:function(e){var t=$(e.currentTarget),r=t.data(),i={tag:t.prop("tagName"),classes:t.attr("class"),id:t.attr("id")};for(var s in r)r.hasOwnProperty(s)&&(i["data-"+s]=r[s]);switch(i.tag){case"input":i.inputType=t.attr("type"),i.inputType!=="password"&&(i.value=t.val());break;case"a":i.href=t.attr("href")}_.extend(i,_.eventToGUTSCoords(e)),n.trigger("guts:log","defaultClicked",i)},searchLink:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.data("searchtype"),i=t.data("searchquery");r=r?r:"",i=i?i:"",n.router.performSearch(r,i)},songLink:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.data("songId");this.navigateToSong(n)},navigateToSong:function(e,t){n.Models.Song.get(e,{notifyCache:!0}).done(function(e){e&&e.getToken().done(function(){n.router.setHash(e.toUrl(t))})})},commentLink:function(e){var t=$(e.currentTarget);if(!t.attr("href")){e.preventDefault();var r=t.data("commentId");n.Models.Comment.get(r).done(_.bind(function(e){e&&e.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG?this.navigateToSong(e.get("ItemID"),"comment/"+e.id):e&&n.router.setHash(e.toUrl())},this))}},onShareClick:function(e){if(n.getLoggedInUserID()<1){n.Models.AuthUser.openRequireLoginTooltip("LB_LOGIN_MUST_LOGIN_TO_SHARE",_.bind(function(){this.onShareClick(e)},this),{$attached:$(e.currentTarget)});return}e.preventDefault(),h(e).done(function(e){var t=_.getItemType(e),r;(!e||!t)&&console.warn("Unable to open share",e,t),r={type:t,item:e},n.trigger("lightbox:open","share",r)}).fail(function(){})},onAddClick:function(e){function a(e){e.get("fromLibrary")?o.removeSongsFromLibrary([e]):o.addSongsToLibrary([e],{$attached:t})}var t=$(e.currentTarget),r=t.data("songId"),i=t.closest(".module"),s=i.data("module"),o=this.model.get("user"),u;return s&&(u=s.model),u?(u=u._wrapped||u,a(u)):n.Models.Song.get(r).done(function(e){a(e)}),!1},onFavoriteClick:function(e){var t=$(e.currentTarget),r=t.data(),i=this.model.get("user"),s,o,u=function(e,n,r){var s=!1;return e?s=i.unfavorite(r+"s",n):s=i.favorite(r+"s",n,{$attached:t}),r=="Artist"&&s.done(_.bind(l,this,e,n)),t.hasClass("btn-notif")&&a(e,t),t.hasClass("active-song")&&f(e,t),s},a=function(e,t){var n=t.parents("div.taco-notification").first(),r=n.add(n.siblings('[data-from-user-id="'+n.data("from-user-id")+'"]'));e?r.find(".btn-notif.favorite").removeClass("btn-success").data("selected","false").children(".icon").attr("class","icon icon-plus"):r.find(".btn-notif.favorite").addClass("btn-success").data("selected","true").children(".icon").attr("class","icon icon-check")},f=function(e,t){e?t.removeClass("btn-success").data("selected","false").children(".icon").attr("class","icon icon-plus gray-dark"):t.addClass("btn-success").data("selected","true").children(".icon").attr("class","icon icon-check white")},l=function(e,t){e||n.trigger("notification:add",{title:_.getString("POPUP_FOLLOWED_ARTIST",{artistLink:t.get("ArtistName")}),icon:"mic",type:"success"})};h(e).done(function(e){_.isFunction(e.getModelToFavorite)&&(r.playlistId?o="Playlist":r.userId?o="User":r.artistId?o="Artist":r.songId?o="Song":r.broadcastId&&(o="Broadcast"),o&&(e=e.getModelToFavorite(o)||e)),o=_.ucwords(_.getItemType(e));var i=e.get("isFavorite"),s=t.closest(".module"),a,f;o==="Artist"&&(a=n.Models.User.getCached(e.get("profileID")),a&&(i=a.get("isFavorite"))),f=u(i,e,o),f&&f.done(_.bind(function(){var e=s.data("module"),t=e.model,r=t.get("isFavorite");t&&_.isInstance(t,n.Models.TinyUser)&&t.set("isFavorite",r),s.toggleClass("favorited",!!r)},this))}).fail(function(){}),e.preventDefault()},onModuleClick:function(e){var t=$(e.currentTarget),n=t.data("module"),r=this.model.get("appMode")==="mobile";if(!r||!n||!_.isFunction(n.mobileAction))return;e.preventDefault(),e.stopImmediatePropagation(),n.mobileAction(e)},onPlayClick:function(e){function g(e,t){if(c){n.trigger("player:togglePlay");return}var r=t||{};r.index=m||p[u]||p.DEFAULT,a?r.streamTypes=a.split(","):(r.context=new n.Models.PlayContext,r.context.addStreamType(n.Models.PlayContext.TYPE_DEFAULT)),e.play(r)}e.preventDefault();var t=$(e.currentTarget),r=e.altKey||e.shiftKey,i=t.closest(".grid-item"),s=t.closest(".module"),o=t.data(),u=o.streamIndex,a=o.streamType,f=o.contextClass,l=o.contextId,c=t.hasClass("play-pause"),p=n.Models.Player.playSpecialIndexes,d=this.model.get("player"),v={playOnAdd:!0},m;r&&(v.playOnAdd=!1,m=p.LAST),_.defined(a)||(a=s.data("streamType")),h(e).done(function(e){if(e instanceof n.Models.Song)if(i.length&&i.data("playContext"))v.context=i.data("playContext");else if(f&&l&&n.Models[f]&&n.Models[f].hasOwnProperty("get")){n.Models[f].get(l).done(function(t){v.context=new n.Models.PlayContext(t),g(e,v)}).fail(_.bind(g,this,e,v));return}g(e,v)}).fail(function(){})},onActivity:function(){this.lastActive=Date.now(),this.model.set("userActive",!0),this.setIdleTimer(),n.trigger("userActivity",this.lastActive)},setIdleTimer:function(){var t=18e4;clearTimeout(this.idleTimer),this.idleTimer=setTimeout(_.bind(function(){var n=this.model.get("user");this.lastActive<=Date.now()-t?this.model.set("userActive",!1):this.setIdleTimer(),n.get("isLoggedIn")&&n.get("checkBroadcastInvitesTime")&&n.get("checkBroadcastInvitesTime")<(this.lastActive+e.clientTimeDivergence)/1e3>>0&&n.updateBroadcastInviteableUsers()},this),t)},onGenreTagClick:function(e){var t=$(e.currentTarget),r=t.attr("href");if(r&&r.length)return!0;var i=$(e.currentTarget).data();if(!i.tagId)return!1;n.router.setHash("",{tagID:i.tagId}),_.gaTrackEvent("site","genreTagClick",i.tagId),n.trigger("guts:log","onGenreTagClick",{genreTagTagID:i.tagId})},radioClearQueue:function(e){var t=this.model.get("player"),r=t.get("queue");if((!r.get("songs")||!r.get("songs").length)&&!r.get("currentBroadcast")){e();return}var i=function(){n.trigger("player:stopSong"),n.trigger("player:clear"),e()};n.trigger("lightbox:open","radioClearQueue",{startRadio:i,inBroadcast:!!r.get("currentBroadcast")})},onPlayStationClick:function(e){var t=$(e.currentTarget),r=t.data();if(n.isBroadcaster()){n.trigger("notification:add",{title:_.getString("POPUP_NO_STATION_WHILE_BROADCASTING"),type:"error"});return}_.defined(r.artistId)?n.Models.Artist.get(r.artistId).done(function(e){e.playStation()}):_.defined(r.userId)?n.Models.User.get(r.userId).done(function(e){e.playStation()}):_.defined(r.tagId)?n.Models.Tag.get(r.tagId).done(function(e){e.playStation()}):n.trigger("notification:add",{title:_.getString("ERROR_FETCHING_STATION"),description:"",url:"",type:"error"})},onPlayGenreClick:function(e){var t=$(e.currentTarget),r=t.data("tag"),i=t.data("tagId"),s=this.model.get("player");if(!i){console.log("missing tagId data on element",t),r&&this.onPlayGenreFail(r);return}var o=$.Deferred();return n.Models.Tag.get(i).done(_.bind(function(e){e.play().done(_.bind(o.resolve,o)).fail(_.bind(o.reject,o))},this)).fail(_.bind(o.reject,o)),o.fail(_.bind(this.onPlayGenreFail,this,r)),o},onPlayGenreFail:function(e){n.trigger("notification:add",{title:"Error retrieving tag songs for "+e+".",description:"",url:"",type:"error"})},onSuggestClick:function(e){n.trigger("lightbox:open","share",{service:"grooveshark",serviceLock:!0,toUserID:$(e.currentTarget).data("userId")}),_.gaTrackEvent("site","onSuggestClick"),n.trigger("guts:log","onSuggestClick",{toUserID:$(e.currentTarget).data("userId")})},onFeedbackClick:function(e){e.preventDefault(),n.trigger("lightbox:open","feedback",{type:"feedback"})},onJoinBroadcastClick:function(e){function d(e){var t=e.get("UserID");n.Models.Broadcast.getCached(e.id)&&n.Models.Broadcast.uncacheID(e.id),n.Models.Broadcast.cache(e),f.joinBroadcast(e,t,null,s).done(function(e){r.data({translateText:e}).text(_.getString(e))})}var t=$(e.currentTarget),r=t.find(".title"),i=t.data(),s=_.eventToGUTSCoords(e),o=t.parents(".module"),u=t.closest(".module-feed-event"),a=i.broadcastId,f=this,l,c,h,p;o[0]&&(l=o.data("module"),l?h=l.model:h=o.data("model")),u[0]&&(c=u.data("module"),p=c.model,p&&p.get("EventType")==="recommendation"?s.feedItemType="broadcastRec":p&&(s.feedItemType=p.get("EventType"),s.ownerUserID=p.get("UserID"))),h&&h instanceof n.Models.Broadcast?d(h):n.Models.Broadcast.get(a).done(d)},joinBroadcast:function(e,t,i,s){function h(e,t){u.joinBroadcast(e,t).done(function(){c.resolve("LEAVE_BROADCAST")}).fail(function(e){if(e===4||e===5){c.fail();return}var t="POPUP_ERROR_BROADCAST_JOIN_ERROR";e===2&&(t="POPUP_ERROR_BROADCAST_JOIN_ARTIST"),n.trigger("notification:add",{description:_.getString(t),type:"error",duration:5e3})})}var o=e.id,u=r.model.get("user"),a=r.model.get("player").get("queue"),f=a?a.get("isBroadcasting"):!1,l=a?a.get("parasite"):null,c=$.Deferred();l instanceof n.Models.Broadcast||(l=null);if(o&&l&&l.get("BroadcastID")==o)f?l.end():u.leaveBroadcast(),c.resolve("LISTEN_TO_BROADCAST");else if(o){if(!i&&!t){var e=n.Models.Broadcast.getCached(o);i=e.get("ArtistID"),t=e.get("UserID")}var p;i?p=n.Models.Artist.getCached(i):t&&(p=n.Models.User.getCached(t)),h(e,p)}else t&&(n.router.setHash("/profile/-/"+t+"/broadcast/join"),c.resolve("LEAVE_BROADCAST"));return s=_.orEqual(s,{}),s.broadcastID=o?o:l?l.get("BroadcastID"):"",n.trigger("guts:log","joinBroadcastButtonClicked",s),c.promise()},onOpenBroadcastClick:function(e){var t=$(e.currentTarget),r=t.data();if(r.broadcastId){var i=n.Models.Broadcast.getCached(r.broadcastId);i&&n.router.setHash(i.toUrl())}},onLeaveBroadcastClick:function(e){var t=$(e.currentTarget),i=t.find(".title"),s=t.data(),o=r.model.get("user"),u=r.model.get("player").get("queue"),a=u?u.get("isBroadcasting"):!1,f=u?u.get("currentBroadcast"):null;if(s.broadcastId||f){var l=_.eventToGUTSCoords(e);l.broadcastID=s.broadcastId||f.id;function c(){o.leaveBroadcast();var e="LISTEN_TO_BROADCAST";i.data({translateText:e}).text(_.getString(e))}u&&f&&(!s.broadcastId||f.get("BroadcastID")==s.broadcastId)&&(a?n.trigger("lightbox:open","broadcastListeners",{broadcast:f,endBroadcast:!0,onBroadcastEnded:c}):c()),n.trigger("guts:log","leaveBroadcastButtonClicked",l)}},onStartBroadcastClick:function(e){if(n.getLoggedInUserID()<1){n.Models.AuthUser.openRequireLoginTooltip("LB_LOGIN_MUST_LOGIN_TO_BROADCAST",_.bind(function(){this.onStartBroadcastClick(e)},this),{$attached:$(e.currentTarget)});return}this.model.get("user").createBroadcast()},onStopBroadcastClick:function(e){var t=this.model.get("player").get("queue"),r=t&&t.get("parasite");r&&r instanceof n.Models.Broadcast&&r.end()},onSongRowAddMouseenter:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=n.Models.Song.getCached(r),s="HELPER_ROW_COLLECTION_ADD";if(!i){var o=t.parents(".module"),u;i=o.data("model"),i||(u=o.data("module"),u&&(i=u.model))}if(!i)return;i&&i.get("fromLibrary")&&(s="HELPER_ROW_COLLECTION_REMOVE");var a=new n.Views.Tooltips.Helper({text:_.getString(s)});n.Views.Tooltips.Helper.simpleTooltip(e,a)},onSongRowFavMouseenter:function(e){var t=$(e.currentTarget),r=t.data("songId"),i="HELPER_ROW_FAVORITES_ADD",s=n.Models.Song.getCached(r);if(!s){var o=t.parents(".module"),u;s=o.data("model"),s||(u=o.data("module"),u&&(s=u.model))}if(!s)return;s.get("isFavorite")&&(i="HELPER_ROW_FAVORITES_REMOVE");var a=new n.Views.Tooltips.Helper({text:_.getString(i)});n.Views.Tooltips.Helper.simpleTooltip(e,a)},openUserTooltip:function(e){amdModules.requireDeferred("gs/views/tooltips/userProfile.js").done(_.bind(function(){var t=$(e.currentTarget),r=t.data(),i=[],s=null,o=t.closest(".sidebar-user"),u,a,f,l;if(!r.userId||r.userId==n.getLoggedInUserID())return;l={delay:250,width:360,positionSpill:"right"},r.tooltipCacheKey&&(a=this.model.get("tooltipOptionsCache"),f=a&&a[r.tooltipCacheKey],f&&(l=_.extend(l,f))),o.length&&(t=$(o[0])),s="user:"+r.userId,u=new n.Views.Tooltips.UserProfile({userID:r.userId,appModel:this.model,tooltipKey:s}),i.push(u),l.views=i,l.$attached=t,l.tooltipKey=s,n.trigger("tooltip:open",l)},this))},openReportAd:function(e){var t=$(e.currentTarget),i=t.data("capitalId"),s=$("iframe","#"+i),o=t.parent(".capital-footer"),u={tooltipKey:"reportAdToolTip",$attached:o,width:300,positionDir:t.hasClass("column-report")?"left":"bottom",positionSpill:"right",positionPad:10,autoCorrectPosition:!1,sticky:!0,closeOnScroll:!0,adid:i},a=_.extend({},s.data("adInfo"),{capitalID:i});if(t.data("inactive"))return;if($(".report-"+i).length){n.trigger("tooltip:close");return}s&&s.length&&amdModules.requireDeferred("gs/views/tooltips/reportAd.js").done(_.bind(function(){u.views=[new n.Views.Tooltips.ReportAd({info:a,capitalID:i})],n.trigger("tooltip:open",u),n.trigger("guts:forcelog","openedReportAd",{iframeID:i,country:gsConfig.country.ID}),_.gaTrackEvent("site","openedReportAd",i+"_"+gsConfig.country.ID),r.ad.reportedAd(i)},this))},doSearch:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.attr("data-search-type")||"",i=$(e.currentTarget).find(".search-input").val();console.log(r,i),n.router.performSearch(r,i)},submitEmptySearch:function(e){e.preventDefault();var t=$(e.currentTarget);return t.parent(".empty-search").submit(),!1},showUploadLightbox:function(){var e=function(e){var t=e.get("artistID"),r=t&&n.Models.Artist.getCached(t),i=r?{artist:r}:{};amdModules.requireDeferred("gs/views/lightboxes/upload.js").done(function(){n.trigger("lightbox:open","upload",i)})};if(n.getLoggedInUserID()>0){e(this.model.get("user"));return}n.trigger("lightbox:open","login",{onLogin:e})},loadLeapLibrary:function(){if(!this.leapLibLoaded||this.leapTmpObj){var i=function(){$(".enable-leap").addClass("btn-success").text(_.getString("SETTINGS_LEAP_MOTION_ENABLED")).attr("data-translate-text","SETTINGS_LEAP_MOTION_ENABLED"),n.Services.Local.set("leapLib"+n.getLoggedInUserID(),!0)};if(this.leapTmpObj){e.Leap=this.leapTmpObj,this.leapTmpObj=t,i();return}var s=[];s.push(amdModules.requireDeferred("gs/external/leapGestures.js")),$.after(s).done(_.bind(function(){this.leapLibLoaded=!0,i(),n.External.LeapPlayer.init(r.model)},this));var o=amdModules.getModuleScriptDeferred("leap");o&&o.fail(_.bind(function(){this.leapLibAttempts++,this.leapLibAttempts>1?(this.leapLibAttempts=0,n.trigger("notification:add",{type:"error",duration:5e3,description:_.getString("LEAP_LIB_LOAD_FAILED")})):this.loadLeapLibrary()},this)).done(function(){e.Leap&&define("leap",Leap)})}},unloadLeapLibrary:function(){$(".enable-leap").removeClass("btn-success").text(_.getString("SETTINGS_LEAP_MOTION_ENABLE")).attr("data-translate-text","SETTINGS_LEAP_MOTION_ENABLE"),n.Services.Local.set("leapLib"+n.getLoggedInUserID(),!1),this.leapTmpObj=e.Leap,e.Leap=t},loadAdroll:function(){if(this.adRollLoaded||this.model.get("userActive")||this.model.get("user").get("subscription").isPremium())return;var e=this.model.get("adrollPages"),t=$('<iframe id="adRollFrame" class="hide">'),n,r;e&&(r="&"+e.join(",")),gsConfig.runMode==="production"?n="http://www.gscookiemonster.com/adroll.html":n=gsConfig.assetHost+"/adroll.html",n+="?"+gsConfig.runMode+r,t.attr("src",n).appendTo("body"),t.load(function(){setTimeout(function(){t.remove()},5e3)}),this.adRollLoaded=!0},onPlayDropdownClick:function(e){var t=$(e.currentTarget),r=t.data(),i=t.clone().add(t.parents()),s=$(i.filter(".module").get(0)),o=r.streamType,u=this.model.get("player").get("queue"),a=!!u.songs.models.length,f=!0,l,c;e.preventDefault();if(t.parent().hasClass("menu-open")){n.trigger("tooltip:close");return}l=s&&$(i.filter(".grid").get(0)),l.data("view")&&l.data("view").options?c=l.data("view").options.playContext:(c=new n.Models.PlayContext,c.addStreamType(n.Models.PlayContext.TYPE_DEFAULT)),i.filter(".gs-tooltip").length>0&&(f=!1);if(s.hasClass("song")&&!a)return this.onPlayClick(e);h(e).done(_.bind(function(e){var r=this.page.currentPageView&&this.page.currentPageView.pageType,i=t.closest(".module-row.song"),s=t.hasClass("event-btn"),a,l;s?a=t.closest(".module-feed-event"):i.length?a=i:a=t.parent(),l={className:"play-dropdown",shouldLog:!0,width:130,pageType:r,$attached:t,$menuOpenEl:a,context:c,streamTypes:o?o.split(","):null,closeOthers:f,scrollable:$("body"),closeOnScroll:!0},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){l.items=n.contextMenus.getContextMenuForPlayDropdown(e,{queue:u},l),n.Views.Tooltips.Menu.openTooltip(l)},this))},this)).fail(function(){})},onLogoutClick:function(e){this.model.logout()},onInviteFriendsClick:function(e){n.trigger("lightbox:open","invite")},onWhoToFollowClick:function(){n.router.setHash("/",{mediaType:"people",groupType:"everyone"})},onPlaceholderClick:function(e){e.preventDefault(),$(e.target).closest(".placeholder-container").find(".placeholder-input").focus()},onPlaceholderFieldFocus:function(e){$(e.currentTarget).parent().addClass("focused")},onPlaceholderFieldKeypress:function(e){$(e.currentTarget).closest(".placeholder-container").addClass("has-text")},onPlaceholderFieldBlur:function(e){$(e.currentTarget).parent().removeClass("focused"),this.onPlaceholderFieldChange(e)},onPlaceholderFieldPaste:function(e){_.defer(function(){$(e.currentTarget).change()})},onPlaceholderFieldChange:function(e){var t=$(e.currentTarget),n=t.closest(".placeholder-container"),r=t.is("input,textarea,select")&&t.val(),i=t.attr("contenteditable")&&t.text();r||i?n.addClass("has-text"):n.removeClass("has-text")},onRadioInputChange:function(e){var t=$(e.currentTarget),n=$(".radio-field input[name="+t.attr("name")+"]");n.parent().removeClass("radio-selected"),t.prop("checked")&&t.parent().addClass("radio-selected")},onBroadcastInviteClick:function(t){var i=$(t.currentTarget),s=i.data("userId"),o=r.model.get("player").get("queue"),u=o?o.get("currentBroadcast").get("BroadcastID"):null;if(i.hasClass("disabled"))return;n.Services.API.sendRealtimeBroadcastInvite(s,u).done(_.bind(function(){var t=this.model.get("user"),r=n.Models.User.getCached(s);t&&t.get("isLoggedIn")&&(r.set({canBroadcastInvite:!1,broadcastTimeInvited:(Date.now()+e.clientTimeDivergence)/1e3>>0}),t.updateBroadcastInviteableUsers())},this))},onBroadcastInvitation:function(e){var t=e.userIDFrom?n.Models.User.getCached(e.userIDFrom):n.Models.Artist.getCached(e.artistIDFrom),i=e.ownerUser?n.Models.User.newOrUpdate(e.ownerUser):n.Models.Artist.newOrUpdate(e.ownerArtist),s=e.userIDFrom?t.escape("Name"):t.escape("ArtistName"),o=e.ownerUser?i.escape("Name"):i.escape("ArtistName"),u=n.Models.Broadcast.newOrUpdate(e.broadcastInfo);n.trigger("notification:add",{title:_.getString("INVITED_TO_BROADCAST",{sender:s}),description:_.getString("INVITED_TO_BROADCAST_DESC",{broadcast:u.escape("Name"),owner:o}),click:_.bind(function(){var e=r.model.get("player").get("queue");e&&e.get("currentBroadcast")?n.router.setHash(u.toUrl()):this.joinBroadcast(u,u.get("UserID"),u.get("ArtistID"))},this),duration:1e4})},onChangeContextClick:function(e){var t=$(e.currentTarget),r=t.data("artistId"),i=t.data("userId"),s;i?s={type:"user",artist:{}}:r&&(s={type:"artist",artist:n.Models.Artist.getCached(r)}),this.model.get("user").setContext(s,!0)},showHiringMsg:function(e){if(gsConfig.runMode==="dev")return;e.inConsole&&console.info(['"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""',"Join Our Team! ","We're hiring and you should apply: http://careers.grooveshark.com ",'"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""'].join("\n"));if(e.inPoptart&&gsConfig.country&&gsConfig.country.ID==223&&!n.Services.Local.get("gs.hiringNotif")){function t(){n.trigger("notification:add",{title:_.getString("POPUP_HIRING_TITLE"),description:_.getString("POPUP_HIRING_DESCRIPTION"),icon:"logo icon-large",duration:0,activeDuration:30,click:function(){n.router.setHash("/careers")},closeAction:function(){n.Services.Local.set("gs.hiringNotif",1)}})}setTimeout(t,12e4)}},logPlaylistPlay:function(e){var t=this.model.get("user");t.logPlaylistPlay(e)},logAlbumPlay:function(e){var t=this.model.get("user");t.logAlbumPlay(e)},setScrollThumbHeight:function(e){var t=_.orEqual(e,$(".scrollable"));t.each(function(){var e=$(this),t=e.children(".scroll-view");if(!t.length)return;var n=t.outerHeight(),r=t[0].scrollHeight,i=100*Math.min(1,Math.max(.1,n/r)),s=t.parent().find(".scrollbar");s.toggleClass("no-show",i==100),e.find(".thumb").height(i+"%")})},handleFakeScroll:function(e){if(this.draggingScrollbar)return;var t=$(e.currentTarget),n=t.parent().find(".scrollbar"),r=n.children(".thumb"),i=t.outerHeight(),s=n.outerHeight(),o=t[0].scrollHeight,u=t.scrollTop(),a=u/(o-i),f=Math.ceil(s*a-r.outerHeight()*a);r.css({transform:"translate(0, "+f+"px)","-webkit-transform":"translate(0, "+f+"px)","-moz-transform":"translate(0, "+f+"px)","-ms-transform":"translate(0, "+f+"px)"}),this.scrollbarFadeIn(e),this.setScrollFadeTimer()},scrollbarFadeIn:function(e,t){var n=$(e.currentTarget),r;n.hasClass("scrollable")?r=n.find(".scrollbar"):n.hasClass("scroll-view")?r=n.closest(".scrollable").find(".scrollbar"):r=n,r.removeClass("fadeout"),t||this.setScrollFadeTimer()},scrollbarFadeOut:function(e){var t=$(".scrollbar");t.addClass("fadeout")},setScrollFadeTimer:function(){this.scrollFadeTimer&&clearTimeout(this.scrollFadeTimer),this.scrollFadeTimer=setTimeout(_.bind(this.scrollbarFadeOut,this),900)},onScrollbarMouseenter:function(e){e.stopPropagation(),this.scrollbarFadeIn(e,!0),this.scrollFadeTimer&&clearTimeout(this.scrollFadeTimer)},onScrollbarMouseleave:function(){this.setScrollFadeTimer()},onScrollbarMouseDown:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.children(".thumb"),r=n.outerHeight(),i=n.parent().siblings(".scroll-view"),s=n.position().top,o=e.clientY,u=e,a=0,f=t.outerHeight(),l=i[0].scrollHeight-i.outerHeight(),c,h;this.draggingScrollbar=!0,n.addClass("active"),$(document).on("mousemove.scrollthumb",function(e){u.target!==n[0]&&(s=o-t.offset().top-n.height()/2,n.css({transform:"translate(0px, "+s+"px)"})),a=e.clientY-o,c=Math.max(0,Math.min(f-r,s+a)),n.css({transform:"translate(0, "+c+"px)","-webkit-transform":"translate(0, "+c+"px)","-moz-transform":"translate(0, "+c+"px)","-ms-transform":"translate(0, "+c+"px)"}),h=l*(c/(f-r)),i.scrollTop(h)}),$(document).on("mouseup",_.bind(function(){this.draggingScrollbar=!1,n.removeClass("active"),$(document).off("mousemove.scrollthumb")},this))},onAppOverlayClick:function(){n.trigger("sidebar:close")},disableDocumentScroll:function(){if(this.model.get("appMode")!=="mobile")return;var e=$("body");o=e.scrollTop(),e.addClass("prevent-scroll")},enableDocumentScroll:function(){if(this.model.get("appMode")!=="mobile")return;$("body").removeClass("prevent-scroll").scrollTop(o)}},{titleTooltipHelper:f})}(),define("gs/views/autocomplete.js",function(){n.Views.Autocomplete=Backbone.View.extend({templatePath:"autocomplete",events:{"click .ac-item-link":"onResultClick","click .see-all":"showSearchResults","click .btn.play":"onPlayClick","click .bc-add":"onSuggestClick","mouseenter .ac-list-item":"onListItemMouseenter"},initialize:function(e){return this.sections=_.orEqual(this.options.sections,[{}]),this.showAllLink=_.orEqual(this.options.showAllLink,!0),this.handleResultClick=_.orEqual(this.options.handleResultClick,null),this.maxResults=_.orEqual(this.options.maxResults,0),Backbone.View.prototype.initialize.call(this,e)},show:function(){if(!this.options.overlay)return;$("body").addClass("show-ac-overlay prevent-scroll"),this.$el.scrollTop(0)},hide:function(){if(!this.options.overlay)return;$("body").removeClass("show-ac-overlay prevent-scroll")},getLocalFilterFunction:function(e,t,r){var i=n.Models.AuthUser.getCached(n.getLoggedInUserID()),s=r,o,u;if(i&&i.get("isLoggedIn")&&!r)switch(e){case"Users":s=i.get("favoriteUsers");break;case"Songs":s=i.get("library");break;case"Albums":o=i.get("library");break;case"Artists":s=i.get("favoriteArtists"),o=i.get("library");break;case"Playlists":s=i.get("playlists"),o=i.get("favoritePlaylists")}if(e=="Artists")u=function(e){var t=[];s&&(t=t.concat(s.filter(function(t){return _.startsWith(t.attributes.ArtistName,e)})));if(o){var r={};o.each(function(i){!r[i.attributes.ArtistID]&&_.startsWith(i.attributes.ArtistName,e)&&(r[i.attributes.ArtistID]=1,t.push(n.Models.Artist.newOrUpdate(i.getArtists(i.attributes.ArtistID),{dontCache:!0})))})}return t};else if(e=="Albums")u=function(e){var t=[];s&&(t=t.concat(s.filter(function(t){return _.startsWith(t.attributes.AlbumName,e)})));if(o){var r={};o.each(function(i){!r[i.attributes.AlbumID]&&_.startsWith(i.attributes.AlbumName,e)&&(r[i.attributes.AlbumID]=1,t.push(n.Models.Album.newOrUpdate(i.getAlbums(i.attributes.AlbumID),{dontCache:!0})))})}return t};else if(e=="Playlists")u=function(e){var r=[];return s&&(r=r.concat(s.filter(function(t){return _.startsWith(t.attributes.PlaylistName,e)}))),o&&(r=r.concat(o.filter(function(t){return _.startsWith(t.attributes.PlaylistName,e)}))),t&&r.length>t&&(r=r.sort(n.Models.Playlist.modifiedPlayedSort)),r};else if(e=="Songs")u=function(e){var n=[];return s&&(n=n.concat(s.filter(function(t){return _.startsWith(t.attributes.SongName,e)}))),t&&n.length>t,n};else if(e=="Users")u=function(e){var r=[];return s&&(r=r.concat(s.filter(function(t){return _.startsWith(t.attributes.Name,e)}))),t&&r.length>t&&(r=r.sort(n.Models.User.interactedNiftyFriendSort)),r};else if(e=="Broadcasts"){if(!r)return;u=function(e){var t=[],n=[],i=[];return r.length==0&&!this.pendingBroadcasts?(this.pendingResults++,this.pendingBroadcasts=!0,t):(this.pendingBroadcasts&&this.pendingResults--,e=_.stripBeginningNonWordChars(e),s.each(function(r){if(_.startsWith(_.stripBeginningNonWordChars(r.attributes.Name),e)){t.push(r);return}if(r.attributes.ownerModel&&_.startsWith(_.stripBeginningNonWordChars(r.attributes.ownerModel.attributes.Name),e)){n.push(r);return}if(r.attributes.Tag&&_.startsWith(r.attributes.Tag.n,e)){i.push(r);return}}),t=t.concat(n).concat(i),t)}}return u},render:function(e){e&&(this.tooltip=e,e.dfd&&(this.tooltipDfd=e.dfd)),this.renderDfd=$.Deferred();var t,r,i;for(r=0,i=this.sections.length;r<i;r++)t=this.sections[r],t.type=_.orEqual(t.type,"Artists"),t.filterFunction=_.orEqual(t.filterFunction,null),t.search=_.orEqual(t.search,!0),t.filterResults=[],t.results=new n.Models.Collections[t.type],t.lastDfd=null,t.hideTitle=_.orEqual(t.hideTitle,!1),!t.filterFunction&&t.includeLocal&&(t.filterFunction=this.getLocalFilterFunction(t.type,this.maxResults,t.collection));return this.template=null,this.hasAnyResults=!1,this.changeQuery(this.options.query),this.renderDfd},cancelPendingRequests:function(){var e,t,n;for(t=0,n=this.sections.length;t<n;t++)e=this.sections[t],e.lastDfd&&(e.lastDfd.abort(),e.lastDfd=null)},changeQuery:function(e,t){function r(){this.pendingResults=Math.max(0,this.pendingResults-1)}if(e==this.query&&!t){if(this.hasAnyResults&&this.template){this.onResultsChange();return}if(this.pendingResults>0)return}e=$.trim(e),this.query=e,this.hasAnyResults=!1,this.pendingResults=0,this.pendingBroadcasts=!1;var i,s,o,u,a,f,l=this.options.$searchIco;l&&l.addClass("searching");for(s=0,o=this.sections.length;s<o;s++){i=this.sections[s],i.lastDfd&&i.lastDfd.abort(),u=i.search;if(i.filterFunction){i.filterResults=i.filterFunction.call(this,e),i.filterResults.length>0&&(this.hasAnyResults=!0);if(i.filterResults.length>3||!u)i.results.reset(i.filterResults),u=!1}u&&i.type&&i.results&&(a=i.type.toLowerCase().substr(0,i.type.length-1),this.pendingResults++,i.useCombinedResults?f?i.lastDfd=f.done(_.bind(this.onAutocompleteResults,this,i,a)):e.length<4?this.onAutocompleteResults(i,a,[]):f=i.lastDfd=n.Services.API.getAutocompleteEx(e,"combined").done(_.bind(this.onAutocompleteResults,this,i,a)).fail(_.bind(r,this)):e.length<4?this.onAutocompleteResults(i,a,[]):i.lastDfd=n.Services.API.getAutocompleteEx(e,a).done(_.bind(this.onAutocompleteResults,this,i,a)).fail(_.bind(r,this)))}if(!this.template)this.fetchTemplate("autocomplete").done(_.bind(this.onTemplate,this));else if(!this.pendingResults){this.onResultsChange();return}},onTemplate:function(e){this.template=e,(this.hasAnyResults||!this.pendingResults)&&this.onResultsChange()},onAutocompleteResults:function(e,t,r){var i,s=e.filterResults;this.pendingResults--,t&&r?i=r[t]:i=_.isArray(r.result)?r.result:r,i&&i.length>0&&(s=e.filterResults.concat(i),this.hasAnyResults=!0),s.length>0&&(this.hasAnyResults=!0);if(e.ignoreCollection!=null){var o=[],u=e.type.substr(0,e.type.length-1),a;_.each(s,function(t){a=n.Models[u].newOrUpdate(t);if(!a||e.ignoreCollection.get(a))return;o.push(a)}),e.results.reset(o)}else e.results.reset(s);this.onResultsChange()},onResultsChange:function(){if(!this.template)return;var e=!1,t=this.options.$searchIco;t&&t.removeClass("searching");if(!this.hasAnyResults){!this.pendingResults&&this.tooltip&&n.trigger("tooltip:hide",this.tooltip.tooltipKey);if(!e)return}this.tooltip&&n.trigger("tooltip:show",this.tooltip.tooltipKey);var r,i,s=0,o=0;if(this.maxResults){for(r=0,i=this.sections.length;r<i;r++)this.sections[r].results.length&&s++;o=Math.round(this.maxResults/s)}this.$el.html(this.renderTemplate(this.template,{sections:e?!1:this.sections,showAll:e?!1:this.showAllLink,maxPerType:o,type:this.options.type})),this.tooltipDfd&&this.tooltipDfd.notify("resultsChanged",this),this.renderDfd.resolve()},showSearchResults:function(){this.query&&this.query.length&&($("input[name=q]",this.$attached).blur().val(""),this.closeTooltip(),n.router.performSearch("",this.query))},getModelForRow:function(e){var t=_.indexOf(_.pluck(this.sections,"type"),e.data("section")),n=this.sections[t],r,i;return n&&n.results&&(r=n.type.substr(0,n.type.length-1).toLowerCase(),i=n.results.get(e.data(r+"Id"))),i},onResultClick:function(e){if(this.handleResultClick){e.preventDefault(),e.stopImmediatePropagation();var t=$(e.currentTarget),n=this.getModelForRow(t);this.handleResultClick(t,n)}},onPlayClick:function(e){e.stopImmediatePropagation();var t=this.getModelForRow($(e.currentTarget).parent().find(".song-link")),i=new n.Models.PlayContext,s=r.model.get("player").get("queue"),o=s?s.get("activeSong"):null,u={index:n.Models.Player.playSpecialIndexes.LAST,skipPrompt:!0,context:i};return i.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),$(e.currentTarget).hasClass("play-select")?(t.play(u),this.onResultClick(e)):t&&(o||n.isBroadcastListener())?n.trigger("lightbox:open","previewSong",{songs:[t],playContext:i,showPlayerControls:!0,_showPlayerControls:!0}):(u.playOnAdd=!1,t.play(u)),this.closeTooltip(),!1},onSuggestClick:function(e){e.stopImmediatePropagation();var t=$(e.currentTarget),i=t.parent().find(".song-link"),s=this.getModelForRow(i),o=r.model.get("player").get("queue"),u=o?o.get("currentBroadcast"):{},a=new n.Models.PlayContext,f=_.eventToGUTSCoords(e),l;return f.songID=s.get("SongID"),a.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),o&&(o.get("isBroadcasting")?(l={tooltipKey:"play-options-tooltip",tooltipClass:"play-options-tooltip",model:u,items:[{localeKey:"PLAY_NEXT",click:function(){s.play({index:n.Models.Player.playSpecialIndexes.NEXT,skipPrompt:!0,context:a})}},{localeKey:"PLAY_LAST",click:function(){s.play({index:n.Models.Player.playSpecialIndexes.LAST,skipPrompt:!0,context:a})}}],closeOthers:!1,$attached:t,width:t.outerWidth()+20,positionSpill:"right"},n.trigger("tooltip:close","play-options-tooltip"),amdModules.requireDeferred("gs/views/tooltips/menu.js").done(function(){n.Views.Tooltips.Menu.openTooltip(l)})):(u.suggestSong(s),f.suggesterID=n.getLoggedInUserID(),n.trigger("guts:log","broadcastSuggestClick",f),n.trigger("tooltip:close"))),!1},onListItemMouseenter:function(e){$(".ac-list-item.selected").removeClass("selected"),$(e.currentTarget).addClass("selected")},closeTooltip:function(){this.tooltip&&n.trigger("tooltip:close",this.tooltip.tooltipKey)}})}),function(){n.Views=n.Views||{};var e=15,t={},i=null,s=!1,o=200;n.Views.Player=Backbone.View.extend({templatePath:"player",ui:{imgContainer:"#np-title-actions .img-container",bcVotes:".bc-votes",bcLink:".bc-link",npAction:".np-action",npActions:".np-actions",bcTitle:".bc-title .title",bcMenu:".bc-menu",broadcastLink:"#play-controls .broadcast-link",bcClose:".bc-close"},events:{"click @broadcastLink":"onBroadcastLinkClick","click #now-playing-metadata":"onPlayerMetaClick","click #now-playing-image, @imgContainer":"onImgContainerClick",dropinit:"handleDropInit",dropstart:"handleDropStart",drop:"handleDrop","contextmenu #np-title-actions":"onSongContextMenu","click #progress-bar":"onSeekClick","click #play-pause":"onPlayPauseClick","click #play-next":"onPlayNextSongClick","click #play-prev":"onPlayPreviousSongClick","click .player-option.shuffle":"onShuffleClick","click .player-option.repeat":"onRepeatClick","click #crossfade":"onCrossfadeClick","click #player-upvote, #np-upvote":"onUpvoteClick","click #player-downvote, #np-downvote":"onDownvoteClick","click #np-more":"onActiveSongMenuClick","click #np-playlists":"onPlaylistsClick","click #np-repost":"onRepostClick","click #np-comment":"onActiveSongCommentClick","click #restore-queue":"onRestoreQueueClick","click #mobile-more":"onMobileMoreClick","mousewheel #volume":"onVolumeSliderBarWheel","click #volume":"onVolumeClick","mouseenter #volume":"onVolumeMouseEnter","mouseleave #volume":"onVolumeMouseLeave","dragend .progress-container":"onScrubberDragEnd","dragstart .progress-container":"onScrubberDragStart","drag .progress-container":"onScrubberDrag","click #volume-grip":"onVolumeSliderBarMove","mousedown #volume-grip":"onVolumeSliderBarDown","mousedown #volume-slider .ui-slider-handle":"onVolumeSliderHandleMouseDown","mouseenter #volume-control":"onVolumeControlMouseEnter","mouseleave #volume-control":"onVolumeControlMouseLeave","click #now-playing-metadata .artist":"onArtistClick","mouseenter .helper-tooltip, .np-action":"onHoverShowTooltip","mouseenter @npActions, @npAction":"onActionHover","mouseleave @npActions":"onActionLeave","click @bcClose":"onLeaveBroadcastClick","click .player-option.queue-trash":"onClearQueueClick","click .player-option.queue-options":"onQueueMenuClick","click .player-option.queue-edit":"onQueueEditClick"},initialize:function(e){var t=this.model.get("player");return this.cacheEls(),r.model.on("change:appSize",_.bind(this.showNextAlbumArt,this,!1)),this.listenTo(n,"nowPlaying:close",this.onCloseNowPlaying),this.listenTo(n,"nowPlaying:show",this.showNowPlaying),this.changeVolumeLevelSlider(t.get("volume")),n.on("player:volume:keychange",this.showVolumeBriefly,this),n.on("player:userActiveSongEngagement",this.openFanFeedback,this),n.on("player:openFanFeedback",this.openFanFeedback,this),n.Services.Manatee.chatReady.done(_.bind(function(){$("#broadcast-btn-container").removeClass("hide")},this)),this.lockScrubber=!1,t.on("change",this.onStatusChange,this),this.onStatusChange(t,{all:!0}),Backbone.View.prototype.initialize.call(this,e)},cacheEls:function(){this.$playerWrapper=$("#player-wrapper"),this.$player=$("#player"),this.$progressBar=$("#progress-bar"),this.$seekBuffer=$("#buffered"),this.$seekProgress=$("#elapsed"),this.$seekScrubber=$("#scrubber"),this.$timeElapsed=$("#time-elapsed"),this.$timeTotal=$("#time-total"),this.$nowPlaying=$("#now-playing"),this.$nowPlayingImage=$("#now-playing-image"),this.$nowPlayingMetadata=$("#now-playing-metadata"),this.$songName=this.$nowPlayingMetadata.find(".song"),this.$artistName=this.$nowPlayingMetadata.find(".artist"),this.$playPause=$("#play-pause"),this.$volume=$("#volume"),this.$volumeControl=$("#volume-control"),this.$shuffle=$(".player-option.shuffle"),this.$repeat=$(".player-option.repeat"),this.$playNext=$("#play-next"),this.$playPrevious=$("#play-prev"),this.$volumeSlider=$("#volume-slider"),this.$volumeSliderBar=this.$volumeSlider.find(".ui-slider-range"),this.$volumeSliderHandle=this.$volumeSlider.find(".ui-slider-handle"),this.$playerBgs=$(".player-bg"),this.bindUIElements()},preventSelection:function(e){e.preventDefault()},onStatusChange:function(e,t){var n=e.changed,r=t||{},i=e.get("volume")*100,s=e.get("isMuted"),o=this.$volume.find(".icon");(r.all||!_.isUndefined(n.queue))&&this.onModelQueueChange(),(r.all||!_.isUndefined(n.crossfadeEnabled))&&$("#crossfade").toggleClass("active",e.get("crossfadeEnabled"));if(r.all||!_.isUndefined(n.volume))this.changeVolumeLevelSlider(e.get("volume")),o.swapClasses("icon-volume-muted","icon-volume",i===0);if(r.all||!_.isUndefined(n.isMuted)){if(i===0&&!s)return;o.swapClasses("icon-volume-muted","icon-volume",s),this.$volumeSliderBar.css("width",(s?0:i)+"%"),this.$volumeSliderHandle.css("left",(s?0:i)+"%")}},onModelQueueChange:function(){var e=this.model.get("player"),t=e.previous("queue"),n=e.get("queue");t&&t.off(null,null,this),n&&(n.on("change",this.onQueueChange,this),n.on("audioAdStart",this.onAudioAdStart,this),n.on("audioAdComplete",this.onAudioAdComplete,this),this.onQueueChange(n,{overwrite:!0}))},onQueueChange:function(e,t){t=_.extend({},t);var r=t.overwrite?e.toJSON():e.changed,i=e.get("activeSong"),s=i?i.get("position"):0;_.isUndefined(r.activeSong)||this.onActiveSongChange(),_.isUndefined(r.currentBroadcast)||this.onBroadcastChange(e),_.isUndefined(r.shuffle)?e.get("isBroadcasting")&&this.$shuffle.removeClass("active"):this.$shuffle[r.shuffle?"addClass":"removeClass"]("active");if(!_.isUndefined(r.repeatMode)){var o=n.Models.Player.repeatModes;switch(r.repeatMode){case o.ALL:this.$repeat.addClass("active").removeClass("one");break;case o.ONE:this.$repeat.addClass("active one");break;case o.NONE:default:this.$repeat.removeClass("active one")}}var u=e.get("currentBroadcast")&&!e.get("isBroadcasting"),a=e.get("currentBroadcast")&&e.get("currentBroadcast").isLoggedInUserOwner();a?this.$("#repeat, #crossfade").addClass("disabled"):u?this.$("#shuffle, #repeat, #crossfade").addClass("disabled"):this.$("#shuffle, #repeat, #crossfade").removeClass("disabled"),e.get("nextSong")&&!u?this.$playNext.removeClass("disabled"):this.$playNext.addClass("disabled"),(e.get("previousSong")||e.get("activeSong")&&s>5e3)&&!e.get("currentBroadcast")?this.$playPrevious.removeClass("disabled"):this.$playPrevious.addClass("disabled"),u?this.$playerWrapper.addClass("broadcast-listener"):this.$playerWrapper.removeClass("broadcast-listener"),a?$("body").addClass("is-broadcasting"):$("body").removeClass("is-broadcasting")},onAudioAdStart:function(e){var t=function(e,t){t?this.$playPause.addClass("icon-play paused").removeClass("icon-pause playing buffering disabled"):this.$playPause.addClass("icon-pause playing").removeClass("icon-play paused buffering disabled")};this.disabledPlayBeforeAudioAd=this.$playPause.hasClass("disabled"),this.audioAd=e,this.listenTo(this.audioAd,"change:paused",t),t.call(this,this.audioAd,this.audioAd.get("paused")),this.$nowPlaying.removeClass("buffering")},onAudioAdComplete:function(e){this.$playPause.removeClass("icon-pause playing paused buffering").addClass("icon-play"),this.disabledPlayBeforeAudioAd&&this.$playPause.addClass("disabled"),this.stopListening(this.audioAd),this.audioAd=null,this.disabledPlayBeforeAudioAd=null},onBroadcastChange:function(e){var t=e.get("currentBroadcast"),n=e.get("isBroadcasting"),r=e.previous("currentBroadcast");r&&r.off(null,null,this),this.$el.toggleClass("broadcasting",n).toggleClass("in-broadcast",!!t),t&&(t.on("change:activeSong",this.onBroadcastActiveSongChange,this),t.on("change:Name",this.onBroadcastNameChange,this),t.on("change:isSuspended",this.renderBroadcastIsSuspended,this),this.onBroadcastActiveSongChange(t.get("activeSong")),this.onBroadcastNameChange(t),this.ui.$bcLink.attr("href",t.toUrl()),n?this.ui.$bcClose.data("tooltipText",_.getString("STOP_BROADCASTING")):this.ui.$bcClose.data("tooltipText",_.getString("LEAVE_BROADCAST"))),this.renderBroadcastIsSuspended()},onBroadcastNameChange:function(e){this.ui.$bcTitle.text(e.get("Name"))},renderBroadcastIsSuspended:function(){var e=r.model.get("player").get("queue"),t=e&&e.get("currentBroadcast");this.$el.toggleClass("broadcast-suspended",!!t&&!!t.get("isSuspended"))},onBroadcastActiveSongChange:function(e){if(!e)return;var t=e.previousAttributes().activeSong,n=this.model.get("player").get("queue").get("currentBroadcast").get("activeSong");t&&t.off(null,null,this),n&&(n.on("change:upVotes change:downVotes",this.onBroadcastSongVotesChange,this),n.on("change:userVote",this.onBroadcastSongUserVoteChange,this),this.onBroadcastSongVotesChange(),this.onBroadcastSongUserVoteChange())},onBroadcastSongVotesChange:function(){var e=this.model.get("player").get("queue"),t=e.get("currentBroadcast"),n=t&&t.get("activeSong"),r=n&&n.get("upVotes")||0,i=n&&n.get("downVotes")||0,s=r.length-i.length;this.ui.$bcVotes.text(s),e.get("isBroadcasting")&&s?this.$el.swapClasses("upvoted","downvoted",s>0):this.$el.removeClass("upvoted downvoted")},onBroadcastSongUserVoteChange:function(){var e=this.model.get("player").get("queue").get("currentBroadcast"),t=e&&e.get("activeSong"),n=t&&t.get("userVote")||0;n?this.$el.swapClasses("upvoted","downvoted",n>0):this.$el.removeClass("upvoted downvoted")},onPositionChange:function(e){var t=this.model.get("player"),n=t.get("queue"),r=n&&n.get("activeSong"),i=r?r.changed:{},s=r?Math.min(1,r.get("percentLoaded")):0,o=r?r.get("position"):0,u=r?r.get("duration"):0,a=Math.min(1,o/u),f=this.$progressBar.width(),l=Math.min(100,s*100),c=Math.min(100,a*100),h=Math.min(f,Math.max(0,f*a));l=isNaN(l)?0:l,c=isNaN(c)?0:c,h=isNaN(h)?-1:h-1,this.$seekBuffer.width(l+"%"),this.$seekProgress.width(c+"%"),this.lockScrubber||this.$seekScrubber.css("left",h),(e||!_.isUndefined(i.position))&&this.$timeElapsed.text(_.millisToMinutesSeconds(o,!0)),(e||!_.isUndefined(i.duration))&&this.$timeTotal.text(_.millisToMinutesSeconds(u,!0));var p=t.get("queue");o>5e3&&!n.get("currentBroadcast")?this.$playPrevious.removeClass("disabled"):p.get("previousSong")||this.$playPrevious.addClass("disabled")},onPlayStatusChange:function(){var e=this.model.get("player"),t=e.get("queue"),i=!1,s=t&&t.get("activeSong"),o=n.Models.Player.playStatuses,u=s?s.get("playStatus"):o.NONE,a=s?s.previous("playStatus"):-1,f=e.get("lastSongByStatus"),l=t&&t.get("currentBroadcast"),c;f||(f={},e.set({lastSongByStatus:f}));switch(u){case o.NONE:a!==u&&(this.audioAd||(this.$nowPlaying.removeClass("buffering"),this.$playPause.removeClass("icon-pause playing paused buffering").addClass("icon-play")),r.$el.removeClass("has-active-song song-playing"),this._songPlayingClassSet=!1),i=!1;break;case o.INITIALIZING:a!==u&&!this.audioAd&&(this.$nowPlaying.addClass("buffering"),this.$playPause.removeClass("icon-pause paused").addClass("icon-play buffering")),i=!0;break;case o.LOADING:a!==u&&!this.$playPause.hasClass("buffering")&&!this.audioAd&&(this.$nowPlaying.addClass("buffering"),this.$playPause.removeClass("icon-play playing paused").addClass("icon-pause buffering")),i=!0;break;case o.PLAYING:var h=e.get("duration");r.$el.addClass("song-playing");if(a!==u||f[u]!=s)this.$nowPlaying.removeClass("buffering"),this.$playPause.addClass("icon-pause playing").removeClass("icon-play paused buffering"),a!=o.LOADING&&_.gaTrackEvent("player","loadingTime",s.getCurrentStreamServer(),0),i=!0;this.pauseNextQueueSongID&&s&&this.pauseNextQueueSongID===s.get("queueSongID")&&(this.pauseNextQueueSongID=!1,setTimeout(_.bind(function(){this.pauseSong()},this),10));break;case o.PAUSED:a!==u&&(this.$nowPlaying.removeClass("buffering"),this.$playPause.addClass("icon-play paused").removeClass("icon-pause playing buffering"),r.$el.removeClass("song-playing")),s&&s.set({paused:!0}),i=!0;break;case o.BUFFERING:a!==u&&!this.$playPause.hasClass("buffering")&&!this.audioAd&&(this.$nowPlaying.addClass("buffering"),this.$playPause.addClass("icon-pause buffering").removeClass("icon-play playing paused")),i=!0;break;case o.FAILED:a!==u&&!this.audioAd&&(l?c="ERROR_PLAYING_INBROADCAST":t.get("hasNextSong")?c="ERROR_HASNEXT_MESSAGE":c="ERROR_PLAYING_SONG",n.trigger("notification:add",{title:_.getString(c),type:"error"}),this.$nowPlaying.removeClass("buffering"),r.$el.removeClass("song-playing"),this.$playPause.removeClass("icon-play playing paused buffering").addClass("icon-pause")),i=!1;break;case o.COMPLETED:a!==u&&!this.audioAd&&(this.$nowPlaying.removeClass("buffering"),this.$playPause.removeClass("icon-pause playing paused buffering").addClass("icon-play")),this.$seekBuffer.width("0%"),this.$seekProgress.width("0%"),this.$seekScrubber.css("left","-1px"),r.$el.removeClass("has-active-song song-playing");break;case o.SUSPENDED:a!==u&&!this.audioAd&&(s&&s.get("paused")?(this.$nowPlaying.removeClass("buffering"),this.$playPause.addClass("icon-play paused").removeClass("icon-pause playing buffering"),r.$el.removeClass("song-playing")):this.$playPause.hasClass("buffering")||(this.$nowPlaying.addClass("buffering"),this.$playPause.addClass("icon-pause buffering").removeClass("icon-play playing paused"))),i=!0}f[u]=s,i&&!this._songPlayingClassSet?(r.$el.addClass("has-active-song"),this._songPlayingClassSet=!0):!i&&this._songPlayingClassSet&&(r.$el.removeClass("has-active-song"),this._songPlayingClassSet=!1)},onActiveSongChange:function(){var t=this.model.get("player").get("queue"),s=t.get("activeSong"),o=t.previous("activeSong"),u=r.model.get("appSize")==="mobile",a=u&&t.get("currentBroadcast"),f=a&&a.getTitle(!0),l=this.model.get("user");o&&o.set({active:!1,paused:!0});if(!s)this.$playPause.addClass("disabled"),this.$player.removeClass("playing"),r.$el.removeClass("has-active-song"),this._songPlayingClassSet=!1;else{this.activeSong&&this.activeSong.off("change",this.onActiveSongModelChange),this.activeSong=s,s.on("change",this.onActiveSongModelChange,this);var c={active:!0};s.set(c),this.onPositionChange(!0),this.onPlayStatusChange();var h,p,d=s.get("isCallout");if(d)p=s.escape("Name"),h=['<span data-callout-id="',s.get("CalloutID"),'" class="now-playing-link" title="',p,'">',p,"</a>"],this.$songName.removeClass("song-link"),this.$songName.text(p).data({songId:""}).attr("title",p),f?this.$artistName.text(f).removeClass("hide"):this.$artistName.addClass("hide");else{var v=/^(.{15,25})[\s;]/i,m=function(e){return new RegExp("^(.{"+Math.max(10,e/2)+","+e+"})[s;]","i")},g=s.get("SongName"),y=s.get("ArtistName"),b=_.getString("BY"),w=_.getString("ON"),E="&nbsp;"+b+"&nbsp;"+s.escape("ArtistName"),S=_.calculateTextWidth(g),x=_.calculateTextWidth(E),T=$("#np-meta-container"),N=T.width(),C=S+x,k="",L="";this.model.get("player").get("uiMode")!=="leap-overlay"?this.$songName.addClass("song-link"):this.$songName.removeClass("song-link"),this.$songName.text(g).data({songId:s.get("SongID")}).attr("title",g),f?this.$artistName.text(f).removeClass("hide"):this.$artistName.text(y).data({artistId:s.get("ArtistID")}).attr("title",y).removeClass("hide");var A=this.model.get("tooltipOptionsCache");A&&(!A.playerSong||!A.playerArtist)&&(A.playerArtist={shouldHideAds:!0},A.playerSong={zIndex:2e6,positionDir:"up",positionSpill:"right",shouldHideAds:!0}),n.trigger("browserNotification:add",{tag:"activeSong",title:s.get("SongName"),body:_.getString("SONG_ON_ALBUM_BYLINE",{artist:s.get("ArtistName"),album:s.get("AlbumName")}),icon:s.getImageURL(120),requireFocus:!1})}this.showNextAlbumArt(),this.$playPause.removeClass("disabled"),this.$player.addClass("playing"),i&&(clearTimeout(i),i=null),this.fanFeedbackTooltip&&this.fanFeedbackTooltip.options.closeOnNextSong&&!this.fanFeedbackTooltip.hasUserInteracted()&&this.closeFanFeedbackTooltip(),d?this.$el.find(".np-action").addClass("hide"):(this.$el.find(".np-action").removeClass("hide").data("songId",s.get("SongID")),this.openFanFeedback(),e++)}var O=s?n.Models.Song.getCached(s.get("SongID")):null,M,D;if(l&&O&&O.get("source")!=="recommended"){var P=l.get("settings");if(P&&P.local&&_.isArray(P.local.artistsPlayed)){M=P.local.artistsPlayed;var H=O.get("ArtistID");D=_.indexOf(M,H),D!==-1&&M.splice(D,1),M.unshift(H),M.splice(999,1),l.saveLocalArtistsPlayed(M)}}},showNextAlbumArt:function(e,t){var n=this.model.get("player").get("queue"),i=$("body"),s=e||i.hasClass("show-now-playing"),o=n.get("activeSong"),u=n.previous("activeSong"),a=r.model.get("appSize")==="mobile",f=this.model.get("player").get("uiMode")==="leap-overlay"?500:80,l=$(".player-bg.active"),c=$(".player-bg:not(.active)"),h=this.$player.width(),p=a&&!s?50:143,d=a&&!s?-(this.$player.height()/2-50):0,v=t||0,m,g;if(!o)return;s&&(f=200),m=o&&o.getImageURL(f);if(!h&&v<100){_.delay(_.bind(this.showNextAlbumArt,this,s,++v));return}s&&(g=h>p?h:p,h=g,p=g),this.$nowPlayingImage.attr({src:m,title:o.get("SongName")}),this.$nowPlaying.toggleClass("favorited",o.get("isFavorite")),o.get("CoverArtFilename")&&(a||!u||u&&u.get("CoverArtFilename")!==o.get("CoverArtFilename"))?_.blurImage(m,h,p,"middle",20,2).done(_.bind(function(e){c.attr("src",e).removeClass("loading"),c.css("top",d+"px"),c.removeClass("no-bg").addClass("active"),l.removeClass("active"),s&&i.addClass("show-now-playing")},this)):o.get("CoverArtFilename")||(this.$playerBgs.addClass("no-bg"),s&&i.addClass("show-now-playing"))},onArtistClick:function(e){var t=$(e.currentTarget),i=t.data(),s=r.model.get("appSize")==="mobile",o;!s&&i&&i.artistId&&(o=n.Models.Artist.getCached(i.artistId),o&&n.router.setHash(o.toUrl()))},openFanFeedback:function(){var r=this.model.get("player"),s=this.model.get("player").get("queue"),o=s.get("activeSong");if(!s||!o||o.get("isCallout"))return;var u=o.get("ArtistID"),a=o.getArtists(u),f=this.model.get("user"),l=f.get("isLoggedIn"),c=r.get("duration"),h=r.get("position"),p=l?5:15,d;if(!a||u==f.get("artistID"))return;a=n.Models.Artist.newOrUpdate(a),a.isClaimed()&&c>35e3&&!t[u]&&e>=p&&(d=Math.max(0,(c>12e4?9e4:3e4)-h),i=setTimeout(_.bind(function(){if(s.get("activeSong")!==o||this.isFanFeedbackOpen())return;this.createFanFeedbackTooltip($("#np-comment"),"ARTIST_FAN_FEEDBACK",!0),i=null,t[u]=!0,e=0},this),d))},onActiveSongModelChange:function(e,t){if(!e||e!==this.model.get("player").get("queue").get("activeSong"))return;var n=e.changed,r=e._wrapped&&e._wrapped.changed,i,s;if(_.defined(r.isFavorite)||_.defined(r.fromLibrary))i=e.get("isFavorite"),s=i?"REMOVE_FROM_FAVORITES":"ADD_TO_FAVORITES",$("#now-playing").toggleClass("favorited",i).find("#np-fav").data({songId:e.get("SongID"),translateTitle:s}).removeData("tooltipText"),$("#np-add").toggleClass("active",e.get("fromLibrary"));(!_.isUndefined(n.duration)||!_.isUndefined(n.position)||!_.isUndefined(n.percentLoaded))&&this.onPositionChange(),(!_.isUndefined(n.playStatus)||!_.isUndefined(n.paused))&&this.onPlayStatusChange(),(!_.isUndefined(n.downVotes)||!_.isUndefined(n.upVotes))&&this.onVotesChange()},onPlayPauseClick:function(e){var t;if(this.audioAd){t=this.audioAd.get("paused"),t?this.audioAd.play({click:!0}):this.audioAd.pause({click:!0});return}n.trigger("player:togglePlay")},onRestoreQueueClick:function(e){var t;r.model.get("appMode")!=="mobile"&&(t=new n.Views.Tooltips.Helper({text:_.getString("RESTORE_QUEUE_2")}),n.trigger("tooltip:close"),n.Views.Tooltips.Helper.simpleTooltip(e,t)),n.trigger("player:restore")},onVolumeClick:function(e){var t=this.model.get("player").get("queue").get("currentBroadcast");t?n.trigger("player:togglePlay"):n.trigger("player:volumeMute")},showVolumeBriefly:function(){this.$player.addClass("show-volume"),this.onVolumeMouseLeave()},onVolumeMouseEnter:function(){clearTimeout(this.volumeSliderTimeout);var e=this;this.model.get("player").get("uiMode")!=="leap-overlay"&&(this.volumeSliderTimeout=setTimeout(function(){e.$player.addClass("show-volume")},350))},onVolumeMouseLeave:function(){this.onVolumeControlMouseLeave()},onVolumeControlMouseEnter:function(){this.$volumeControl.on("mousewheel",_.bind(this.onVolumeSliderBarWheel,this)),clearTimeout(this.volumeSliderTimeout)},onVolumeControlMouseLeave:function(){this.$volumeControl.off("mousewheel"),clearTimeout(this.volumeSliderTimeout);var e=this;s?$(document).on("mouseleave.player mouseup.player",_.bind(this.onVolumeControlMouseDrag,this)):this.volumeSliderTimeout=setTimeout(function(){e.$player.removeClass("show-volume")},o)},onVolumeControlMouseDrag:function(e,t){$(document).off("mouseup.player mouseleave.player",_.bind(this.onVolumeControlMouseDrag,this));var n=this;this.volumeSliderTimeout=setTimeout(function(){n.$player.removeClass("show-volume"),s=!1},o)},onVolumeSliderBarDown:function(){s=!0,$(document).on("mousemove.player",_.bind(this.onVolumeSliderBarMove,this)),$(document).on("mouseup.player",_.bind(this.onVolumeSliderBarUp,this))},onVolumeSliderBarUp:function(){s=!1,$(document).off("mousemove.player mouseup.player"),this.$volumeSlider.off("mouseout")},onVolumeSliderBarMove:function(e){var t=e.pageX-this.$volumeSlider.offset().left,n=t/this.$volumeSlider.width();this.changeVolumeLevelSlider(Math.min(Math.max(n,0),1),!0),e.stopImmediatePropagation(),e.stopPropagation()},onVolumeSliderBarWheel:function(e){var t;e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?t=1:t=-1;var n=this.model.get("player").get("volume");return this.changeVolumeLevelSlider(Math.min(Math.max(n+.2*t,0),1),!0),e.preventDefault(),e.stopPropagation(),!1},onVolumeSliderHandleMouseDown:function(e){var t=$(e.currentTarget);t.addClass("dragging"),r.$el.on("mouseup",_.bind(this.onVolumeSliderHandleMouseUp,this))},onVolumeSliderHandleMouseUp:function(){this.$volumeSliderHandle.removeClass("dragging")},changeVolumeLevelSlider:function(e,t){var r=["off","one","two","three","four","five"],i=_.orEqual(Math.ceil((e*100-3)/20),5),s=r[i],o=e*100,u=this.model.get("player");t&&n.trigger("player:volumeChange",e),e<=0?(t&&u.setIsMuted(!0),this.$player.addClass("mute")):(u.setIsMuted(!1),r.push("mute"),this.$player.removeClass("mute"),this.$volume.removeClass(r.join(" ")).addClass(s)),this.$volumeSliderBar.css("width",o+"%"),this.$volumeSliderHandle.css("left",o+"%")},onPlayNextSongClick:function(){this.$playNext.hasClass("disabled")||n.trigger("player:nextSong")},onPlayPreviousSongClick:function(){this.$playPrevious.hasClass("disabled")||n.trigger("player:previousSong")},onShuffleClick:function(e){var t=$(e.currentTarget),r=this.model.get("player").get("queue"),i,s;if(!r||t.hasClass("disabled"))return;i=r.get("currentBroadcast"),i?r.get("isBroadcasting")&&(t.addClass("disabled"),s=setTimeout(function(){t.removeClass("disabled")},2e3),i.remoraShuffleUnplayedSongs().fail(function(){t.removeClass("disabled"),clearTimeout(s)})):n.trigger("player:shuffle")},onRepeatClick:function(){var e=this.model.get("player").get("queue");e&&!e.get("currentBroadcast")&&n.trigger("player:repeat")},onCrossfadeClick:function(e){var t=this.model.get("player"),n=t.get("queue"),r=this.model.get("user").get("subscription").isPremium();if(!r){this.openRequireLoginTooltip(e,"LB_VIP_ONLY_MSG",_.bind(function(){this.onCrossfadeClick(e)},this),{requireVIP:!0});return}n&&!n.get("currentBroadcast")&&t.toggleCrossfade()},onActiveSongMenuClick:function(e){var t=$(e.currentTarget),n=t.parent(),i=this.model.get("player").get("queue").get("activeSong");if(i){var s={positionDir:"up",width:175,fixed:!0,isQueue:!0,$menuOpenEl:n,queueSongClickedQueueSongID:i.get("queueSongID"),appToken:r.model.get("appToken")};_.asyncTooltipMenu(t,s,i,"getContextMenuForSongRowMore")}},onActiveSongCommentClick:function(e){this.isFanFeedbackOpen()?this.closeFanFeedbackTooltip():this.createFanFeedbackTooltip(e.currentTarget,"COMMENT_TOOLTIP_SONG",!1)},createFanFeedbackTooltip:function(e,t,r){var i=$(e),s="active-song-comment",o=this.model.get("player"),u=o.get("queue"),a=u?u.get("activeSong"):null,f;if(!a)return;amdModules.requireDeferred("gs/views/tooltips/comment.js").done(_.bind(function(){var e=new n.Views.Tooltips.Comment({model:a,user:this.model.get("user"),placeholderTextKey:t,tooltipKey:s,closeOnNextSong:r});f={views:[e],$attached:i,positionDir:"up",poistionSpill:"right",persist:!0,tooltipKey:s,model:this},n.trigger("tooltip:open",f),this.fanFeedbackTooltip=e},this))},closeFanFeedbackTooltip:function(){this.fanFeedbackTooltip&&(this.fanFeedbackTooltip.closeTooltip(),this.fanFeedbackTooltip=null)},isFanFeedbackOpen:function(){var e=$(".active-song-comment");return!e||!e.length},onSongContextMenu:function(e){function a(){n.trigger("player:removeSongs",[o])}var t=$(e.currentTarget),i=this.model.get("player"),s=i.get("queue"),o=s.get("activeSong"),u;if(!o)return!1;u={show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,ev:e,player:i,isQueue:!0,queueSongClickedID:o.get("queueSongID"),queueSongClickedQueueSongID:o.get("queueSongID"),autoplay:r.model.get("player").get("autoplay"),onRemoveFromQueue:a},_.asyncTooltipMenu(t,u,o,"getContextMenuForSong"),e.preventDefault()},onSeekClick:function(e){var t=this.model.get("player"),r=t.get("queue");if(r&&r.get("currentBroadcast")&&!r.get("isBroadcasting"))return e.preventDefault(),!1;var i=r.get("activeSong"),s=this.$progressBar.offset(),o=e.pageX-s.left,u=o/this.$progressBar.width(),a=Math.min(Math.max(u,0),1),f;i&&i.getHandleType&&i.getHandleType()=="html5"&&(a=u),f=i.get("duration")*a,n.trigger("player:seekTo",f)},onScrubberDragStart:function(e,t){var r=this.model.get("player"),i=r.get("queue"),s=i&&i.get("currentBroadcast")&&!i.get("isBroadcasting"),o=i&&i.get("activeSong"),u=o&&o.get("playStatus"),a=n.Models.Player.playStatuses,f=e.target==this.$seekScrubber[0];if(!f||u!==a.PLAYING&&u!==a.PAUSED||s)return!1;this.lockScrubber=!0;var l=this.$seekScrubber.css("left");return this.scrubberLeft=_.toInt(l.substring(0,l.length-2)),this.maxScrubberLeft=this.$progressBar.width()-5,this.minScrubberLeft=-5,t.draggedItems=[],t.scrubber=!0,this.$el.on("mouseleave."+this.cid,_.bind(function(e){this.lockScrubber=!1,this.onScrubberDragEnd(e),t.dragging=!1},this)),!0},onScrubberDrag:function(e,t){this.$seekScrubber.css("left",Math.max(this.minScrubberLeft,Math.min(this.scrubberLeft+t.deltaX,this.maxScrubberLeft)))},onScrubberDragEnd:function(e,t){t&&t.scrubber&&this.onSeekClick(e),this.lockScrubber=!1,this.$el.off("mouseleave."+this.cid)},isObjectDroppable:function(e){var t=this.model.get("player"),r=t.get("queue"),i=r?r.get("currentBroadcast"):null,s=r?r.get("isBroadcasting"):!1,o=r&&!0;if(o&&s&&e){var u=t.get("position"),a=t.get("duration");if(i.get("listenersCount")>n.Models.Broadcast.LARGE_THRESHOLD&&r.get("nextSong")===e&&a&&a-u<n.Models.Broadcast.PREVENT_NEXT_POSITION)o=!1;else{var f=r.get("songs"),l=f.indexOf(e);l>-1&&l<f.indexOf(r.get("activeSong"))&&(o=!1)}}return o},handleDropInit:function(e,t){var n=$(e.srcElement).closest(".queue-item"),r=!0;n.length===1?r=this.isObjectDroppable(n.data("module").model):r=this.isObjectDroppable(),this.$el.data("valid-drop",r)},handleDropStart:function(e,t){if(!t.draggedItems||t.draggedItems.length===0)return!1},handleDrop:function(e,t){function h(e,t){!_.isArray(t)&&t.toArray&&(t=t.toArray());var r=this.model.get("player"),i=r&&r.get("queue"),s=i&&i.get("songs");n.trigger("player:addSongs",t,-1,s.length===0,e)}t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);if(t.draggedItemsType=="song"&&t.draggedItems&&t.draggedItems.length){var i=t.draggedItems[0];if(!this.isObjectDroppable(i))return;var s=i.get("queueSongID"),o=this.model.get("player"),u=o&&o.get("queue"),a=u&&u.get("songs");if(s&&a&&a.length){o.moveSongsTo([s],a.length);return}}else if(!this.isObjectDroppable())return;var f,l,c;switch(t.draggedItemsType){case"song":_.bind(h,this)(t.draggedItemsContext,t.draggedItems);break;case"album":case"artist":case"playlist":case"broadcast":for(f=0,c=t.draggedItems.length;f<c;f++)l=t.draggedItems[f],_.isFunction(l.getSongs)&&l.getSongs().then(_.bind(h,this,new n.Models.PlayContext(l)));break;case"tag":var p=t.draggedItems[0];r.playGenre(p.get("DisplayName"),p.get("TagID"));break;case"user":for(f=0,c=t.draggedItems.length;f<c;f++)l=t.draggedItems[f],_.isFunction(l.getFavorites)&&l.getFavorites("Songs").then(_.bind(h,this,new n.Models.PlayContext(l)))}},onUpvoteClick:function(e){this.onVoteLogic(1)},onDownvoteClick:function(e){this.onVoteLogic(-1)},onVoteLogic:function(e){var t=r.model.get("player").get("queue"),n=t&&t.get("currentBroadcast"),i=n&&n.get("activeSong");if(!i||!n)return;i.get("userVote")===e?n.voteActiveSong(0):n.voteActiveSong(e)},onHoverShowTooltip:function(e){$(e.currentTarget).data("tooltipDelay",750)},onMobileMoreClick:function(e){var t=new ChainLoading,n=$(e.currentTarget),r=this.model.get("player"),i=this.model.get("user"),s=r.get("queue").get("activeSong"),o={positionDir:"up",closeOnScroll:!1,$attached:n,$menuOpenEl:n.parent(),authUser:i,player:r,song:s,fixed:!0,callback:function(e){e.addSongs([s],null,!0)}};t.push(i.getPlaylists()),t.push(i.loadSubscription()),t.done(function(){_.asyncTooltipMenu(n,o,s,"getMobilePlayerOptions")})},onPlaylistsClick:function(e){if(n.getLoggedInUserID()<1){this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST",_.bind(function(){this.onPlaylistsClick(e)},this));return}var t=$(e.currentTarget),r=this.model.get("user"),i=this.model.get("player").get("queue").get("activeSong"),s={positionDir:"up",closeOnScroll:!1,$attached:t,tooltipClass:"playlist-np-menu",$menuOpenEl:t.parent(),songs:[i],fixed:!0,collectionCallback:_.bind(function(e,t){t?e.addSongsToLibrary([i]):e.removeSongsFromLibrary([i])},this),callback:_.bind(function(e){e.addSongs([i],null,!0)},this)};r.getPlaylists().done(function(){_.asyncTooltipMenu(t,s,i,"getPlaylistsMenu")})},onRepostClick:function(e){if(n.getLoggedInUserID()<1){this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_SHARE",_.bind(function(){this.onRepostClick(e)},this));return}var t=this.model.get("player").get("queue").get("activeSong");n.trigger("lightbox:open","share",{item:t})},onLeaveBroadcastClick:function(e){var t=this.model.get("player").get("queue"),i=t.get("currentBroadcast"),s=i&&!i.isLoggedInUserOwner();s?r.model.get("user").leaveBroadcast():i.end(),n.trigger("tooltip:close")},openRequireLoginTooltip:function(e,t,r,i){var s=$(e.currentTarget);amdModules.requireDeferred("gs/views/tooltips/requireLogin.js").done(function(){n.Views.Tooltips.RequireLogin.openTooltip(t,r,_.defaults({$attached:s,$menuOpenEl:s},i))})},onActionHover:function(){if(gsConfig.isMobile)return;this.$el.addClass("action-hover")},onActionLeave:function(){this.$el.removeClass("action-hover")},onImgContainerClick:function(e){r.model.get("appSize")==="mobile"&&(e.preventDefault(),e.stopPropagation(),this.showNowPlaying())},showNowPlaying:function(){var e=this.model.get("player").get("queue"),t=e.get("activeSong"),n=t.get("ArtistName"),i=e.get("currentBroadcast"),s=i&&i.getTitle(!0);r.header.updateTitle("NOW_PLAYING"),r.disableDocumentScroll(),this.showNextAlbumArt(!0),s&&this.$artistName.text(n).data({artistId:t.get("ArtistID")}).attr("title",n).removeClass("hide")},onCloseNowPlaying:function(){var e=this.model.get("player").get("queue"),t=e.get("currentBroadcast"),n=t&&t.getTitle(!0);r.enableDocumentScroll(),n&&this.$artistName.text(n).removeClass("hide"),$("body").removeClass("show-now-playing"),_.delay(_.bind(this.showNextAlbumArt,this),300)},onPlayerMetaClick:function(e){var t=r.model.get("player").get("queue"),i=t&&t.get("currentBroadcast");r.model.get("appSize")==="mobile"&&!$("body").hasClass("show-now-playing")&&(e.preventDefault(),e.stopPropagation(),i?n.router.setHash(i.toUrl()):n.trigger("mobile:showQueue"))},onClearQueueClick:function(e){var t=this.model.get("player").get("queue");t&&t.get("songs").length&&!n.isBroadcastListener()&&r.queue.onClearQueueClick(e)},onQueueMenuClick:function(e){r.queue.onQueueMenuClick(e)},onQueueEditClick:function(e){var t=$(e.currentTarget),n=$("body"),r=n.hasClass("queue-edit-mode");t.toggleClass("active",!r),n.toggleClass("queue-edit-mode",!r)},onBroadcastLinkClick:function(e){var t=this.model.get("player").get("queue"),r=t.get("currentBroadcast");n.router.setHash(r.toUrl()),this.onCloseNowPlaying()}})}(),function(){function i(){var e=document.createElement("canvas");return!!e.getContext&&!!e.getContext("2d")}n.Views=n.Views||{};var e={};n.Views.Queue=Backbone.View.extend({el:document.getElementById("queue-container"),templatePath:"queue",openedOnce:!1,autoplay:!1,queueSize:"",openQueueSize:"",bestQueueSize:"",lastUserQueueSize:"",preferredUserQueueSize:"",viewDirty:!1,queueOpen:!1,greatestQueueSongID:0,songsAdded:0,ui:{suggestedBroadcastsContainer:".suggested-broadcasts-container",suggestedBroadcasts:"@suggestedBroadcastsContainer .suggested-bcasts",syncingIcon:".syncing-icon"},events:{"click .queue-song-options .options":"onSongOptionsClick","click #player-radio-label":"onStationsLabelClick","click .smile":"onSmileClick","click .frown":"onFrownClick","click .bc-menu":"onManageBroadcastClick","click .queue-trash":"onClearQueueClick","click .queue-menu":"onQueueMenuClick"},initialize:function(e){var t=this.model.get("player");this.songQueueHelper={},this.$queue=$("#queue"),this.$player=$("#player"),this.$sidebar=$("#sidebar"),this.$playerWrapper=$("#player-wrapper"),this.$main=$("#main"),this.$queueListWindow=$("#queue-list-window"),this.$queueLabel=this.$sidebar.find(".queue-label"),this.$queueCount=$("#queue-count"),this.$queueList=$("#queue-list"),this.$queueNum=$("#queue-num"),this.$queueNumTotal=$("#queue-num-total"),this.$songsText=$("#songs-text"),this.$restore=$(".queue-restore"),this.$body=$("body"),this.$nowPlaying=this.$sidebar.find(".now-playing"),this.onSongsChangedDebounced=_.debounce(function(){this.onSongsChanged()},50),t.on("change:queue",this.onCurrentQueueChange,this),t.on("change:previousQueue",this.onPreviousQueueChange,this),t.get("queue")&&this.onCurrentQueueChange(t,t.get("queue")),this.isDragging=!1,n.on("drag:start",function(e){if(!_.isFunction(e.allowedToDropTo)||e.allowedToDropTo(this))this.isDragging=!0},this),n.on("drag:end",function(){this.isDragging=!1},this),this.lastMouseInteraction=Date.now()-3e4,this.$queue.on("click mousewheel",_.debounce(_.bind(function(){this.lastMouseInteraction=Date.now()},this),100));var r=function(e,t){var r="s";t>=825&&(r="m"),this.queueOpen&&this.bestQueueSize!=r&&n.trigger("queue:setSize",r,!1),this.bestQueueSize=r,this.optionsTooltip&&n.trigger("tooltip:close")};return n.on("app:resize",r,this),r.call(this,0,this.$body.height()),this.notifySongsAdded=_.debounce(_.bind(function(){var e=this.model.get("player").get("queue"),t=$(".main-nav-link.queue","#sidebar"),r=t.find(".songs-added-num");if(!e||n.isBroadcastListener())return;this.songsAdded=Math.max(0,Math.min(this.songsAdded,e.get("songs").length));if(this.songsAdded===0)return;t.addClass("songs-added"),r.text("+"+this.songsAdded),this.songsAddedTimeout&&clearTimeout(this.songsAddedTimeout),this.songsAddedTimeout=setTimeout(_.bind(function(){t.removeClass("songs-added"),this.songsAdded=0},this),5e3)},this),300),this.$queueListWindow.on("scroll",function(e){n.trigger("fakeScroll",e),n.trigger("tooltip:close","queue-song-menu")}),this.$queueListWindow.on("DOMMouseScroll mousewheel",_.preventDocumentScroll),this.bindUIElements(),Backbone.View.prototype.initialize.call(this,e)},onCurrentQueueChange:function(e,t,i){this.greatestQueueSongID=0;var s=e.previous("queue"),o=t.get("songs");if(s){var u=s.get("songs"),a=s.get("currentBroadcast");u.off(null,null,this),s.off("change",null,this),a&&a.off("change",null,this)}this.grid&&(this.grid.destroy(!1),this.grid.off("rendered resized")),t&&(o.on("add remove reset sort",this.onSongsChangedDebounced,this),t.on("change",this.onQueueChange,this),o.on("change",this.addQueuePropertiesToSong,this),this.grid=new n.Views.QueueGrid({el:this.$queueList[0],collection:o,model:this.model.get("player"),scrollElement:this.$queueListWindow,dropListenOn:this.$queue,itemHeight:r.model.get("appMode")==="isMobile"?50:41}),this.grid.on("rendered resized",function(){n.trigger("setScrollThumbHeight",this.$queueListWindow)}),this.grid.render(),this.collection=o,this.updateCurrentSongs(),this.updateRadio(),this.onActiveSongChange(),this.onNextSongChange(),this.onSongsChanged()),this.updateRestoreQueue(),n.trigger("setScrollThumbHeight",this.$queueListWindow)},onPreviousQueueChange:function(){this.updateRestoreQueue()},onQueueChange:function(e,n){var r=e.changedAttributes();if(r.activeSong!==t){var i=e.previous("activeSong");i&&i.trigger("change",i),this.onActiveSongChange()}_.isUndefined(r.nextSong)||this.onNextSongChange();if(r.currentBroadcast!==t){var s=e.previous("currentBroadcast");s&&s.off(null,null,this);var o=r.currentBroadcast;if(o)o.on("change:Name",this.onBroadcastChange,this),o.on("change:isSuspended",this.renderBroadcastIsSuspended,this);else{var u=e.get("songs");u&&u.each(function(e){e.set("broadcastPlayed",!1)})}this.onBroadcastChange(o),this.renderBroadcastIsSuspended()}r.isSyncing!==t&&this.renderQueueSyncing(),_.isUndefined(r.autoplay)||this.updateRadio(),this.updateRestoreQueue()},onActiveSongChange:function(){var e=this.model.get("player"),t=e.get("queue"),n=t.previous("activeSong"),r=t.get("activeSong");if(r){var i=t.get("songs").indexOf(r)+1;n&&n.off(null,null,this),r.on("change:playStatus",this.onActiveSongStatusChange,this),this.$queueNum.text(i),r==this.lastSuggestedSong&&this.lastSuggestedSong.set({suggestion:!1}),r.trigger("change",r),t.get("autoplay")?e.set("scrollAfterRadioAdd",!0):this.scrollToActiveSong()}else this.$queueNum.text("0"),e.set("expectManualSongChange",!1)},onNextSongChange:function(){var e=this.model.get("player").get("queue"),t=e.get("nextSong"),r=e.previous("nextSong");r&&r.set({isNext:!1}),t&&t.set({isNext:!0}),n.isBroadcastListener()&&this.grid.filter("",{filterFunction:function(e){return!e.get("isNext")}})},onActiveSongStatusChange:function(e,t){var r=this.model.get("player"),i=e.get("SongID"),s=e.getCurrentStreamServer(),o=n.Models.Player.playStatuses,u="";switch(t){case o.NONE:u="NONE";break;case o.INITIALIZING:u="INITIALIZING";break;case o.LOADING:u="LOADING";break;case o.PLAYING:u="PLAYING";break;case o.PAUSED:u="PAUSED";break;case o.SUSPENDED:u="SUSPENDED";break;case o.BUFFERING:u="BUFFERING";break;case o.FAILED:u="FAILED";break;case o.COMPLETED:u="COMPLETED";break;default:u="UNKNOWN"}n.trigger("guts:log","playStatusUpdate",{playStatus:u,activeSong:i,streamServer:s})},scrollToActiveSong:function(e){e=_.orEqual(e,!1);var t=this.model.get("player"),n=t.get("queue").get("activeSong");if(!n)return;if(e||t.get("expectManualSongChange")||!this.isDragging&&Date.now()-this.lastMouseInteraction>3e4){var r=this.grid.getScrollPositionToShowItem(n,!0);r!==-1&&this.$queueListWindow.scrollTop(r)}t.set("expectManualSongChange",!1),t.set("scrollAfterRadioAdd",!1)},scrollToEnd:function(){var e=this.grid.getMaxScrollPos();this.$queueListWindow.scrollTop(e)},updateRestoreQueue:function(){var e=this.model.get("player"),t=e.get("queue"),r=e.get("previousQueue");this.$body.removeClass("show-restore-queue"),r&&(!t||!t.get("songs").length)&&!n.isBroadcastListener()?(this.$body.addClass("show-restore-queue").removeClass("show-clear-queue"),this.$sidebar.addClass("show-restore"),this.$playerWrapper.addClass("show-restore"),n.trigger("tutorial:RestoreQueue")):!r&&(!t||!t.get("songs").length)?(this.$body.removeClass("show-clear-queue"),this.$sidebar.removeClass("show-restore"),this.$playerWrapper.removeClass("show-restore")):(this.$body.addClass("show-clear-queue"),this.$sidebar.removeClass("show-restore"),this.$playerWrapper.removeClass("show-restore"))},onClearQueueClick:function(e){e.preventDefault(),n.trigger("player:clear"),n.trigger("tooltip:close")},addQueuePropertiesToSong:function(e){var t=this.model.get("player"),n=t.get("queue"),r=n.get("songs"),i=!1,s=e.get("autoplayVote"),o=e.get("context")||{data:{}},u=n.get("autoplay"),a=r.indexOf(e)==r.length-1,f={},l=!1;return u&&a&&r.length>1&&e.get("source")!="user"&&!o.data.fromUserAction&&(e.get("suggestion")!==!0&&(f.suggestion=!0,l=!0),this.lastSuggestedSong=e),s!==e.previous("autoplayVote")&&(s=_.toInt(s),f.smile=s==1||e.get("source")=="user"&&s===0,f.frown=s==-1,l=!0),e.get("songQueueHelper")!==this.songQueueHelper&&(f.songQueueHelper=this.songQueueHelper,l=!0),l&&e.set(f),e},notifySongsAdded:function(){},updateCurrentSongs:function(){var e=this.model.get("player").get("queue"),t;e.get("songs").length===0?t="QUEUE_NO_SONGS":e.get("songs").length==1?t="QUEUE_ONE_SONG":t="QUEUE_NUM_SONGS",$(".current-songs-text").text(_.getString(t,{numSongs:e.get("songs").length}))},updateRadio:function(){var e=this.model.get("player").get("queue"),t=e.get("autoplay");this.songQueueHelper.autoplay=t,t?(this.$el.addClass("has-some-radio"),this.$queueList.addClass("autoplay")):(this.$el.removeClass("has-some-radio"),this.$queueList.removeClass("autoplay")),this.grid.refresh()},onSongsChanged:function(e){this.updateCurrentSongs();var t=this.collection.length,r=t===1?"SONG":"SONGS",i=this.model.get("appMode")==="mobile";this.lastSongCount?t-=this.lastSongCount:!i&&t>0&&n.trigger("sidebar:setSection","queue"),t>0&&(!e||!e.get("suggestion")&&e.get("queueSongID")>this.greatestQueueSongID)&&(this.songsAdded+=t,this.notifySongsAdded()),this.lastSongCount=this.collection.length,t>0&&e&&e instanceof n.Models.PlayableSong&&this.greatestQueueSongID<e.get("queueSongID")&&(this.greatestQueueSongID=e.get("queueSongID"));if(this.collection.length){var s=this.model.get("player").get("queue"),o=s.get("currentBroadcast"),u=n.isBroadcastListener()||this.model.get("player").get("isJoiningBroadcast"),a=s?s.get("activeSong"):!1;if(a){var f=s.get("songs").indexOf(a)+1;this.$queueNum.text(f)}this.queueSize==="c"&&this.lastUserQueueSize!=="c"&&!u&&n.trigger("queue:setSize",this.lastUserQueueSize||this.bestQueueSize,!1),this.$body.addClass("queue-has-songs"),this.$queueNumTotal.text(this.collection.length),this.$songsText.data("translateText",r).text(_.getString(r)),this.$el.find(".num-text").removeClass("hide")}else this.$el.find(".num-text").addClass("hide"),this.$body.removeClass("queue-has-songs"),this.$queueNum.text("0"),this.$queueNumTotal.text("0"),this.$songsText.data("translateText",r).text(_.getString(r)),this.updateRestoreQueue();this.$queueList.toggleClass("hide",!this.collection.length),this.updateQueueLabel()},onSongOptionsClick:function(e){var t=$(e.currentTarget),n=t.parent(),i=t.parents(".queue-item").data("queueSongId"),s=this.model.get("player").get("queue"),o=s.get("songs"),u=null;for(var a=0;a<o.length;a++)if(o.at(a).get("queueSongID")==i){u=o.at(a);break}if(u){var f={tooltipKey:"queue-song-menu",fixed:!0,positionSpill:"right",$menuOpenEl:n,queueSongClickedQueueSongID:u.get("queueSongID"),appToken:r.model.get("appToken"),scrollable:$(document)};_.asyncTooltipMenu(t,f,u,"getContextMenuForQueueSong")}},onStationsLabelClick:function(e){var t=$(e.currentTarget);t.jjmenu(e,n.Models.Station.getStationsStartMenu(),null,{xposition:"right",yposition:"top",orientation:"top",spill:"left",show:"show",className:"radiomenu",keepState:t})},onQueueMenuClick:function(e){if(this.queueMenu&&this.queueMenu.dfd&&this.queueMenu.dfd.state()==="pending"){this.queueMenu.closeTooltip();return}amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){var t=this.model.get("player"),r=$(e.currentTarget),i="queue-menu";this.queueTooltipOptions={tooltipKey:i,scrollable:$(document),delay:0,width:r.innerWidth(),$attached:r,tooltipClass:"queue-menu",sticky:!0,fixed:!0,model:t.get("queue"),appModel:this.model},this.queueTooltipOptions.items=n.contextMenus.getQueueMenu(t,this.queueTooltipOptions),this.queueMenu=n.Views.Tooltips.Menu.openTooltip(this.queueTooltipOptions),r.addClass("active"),this.queueMenu.dfd.always(function(){r.removeClass("active")})},this))},onBroadcastBtnHover:function(e){var t=r.model.get("user"),n=this.model.get("player").get("queue");(!n||!n.get("currentBroadcast"))&&t.getLastBroadcast()},onBroadcastChange:function(){var e=n.getCurrentBroadcast(),t=n.isBroadcastListener();this.$body.toggleClass("in-broadcast",!!e).toggleClass("broadcast-listener",t),this.updateRestoreQueue(),e&&!n.isBroadcaster()?(this.childViews.suggestedBroadcasts=new n.Views.SuggestedBroadcasts({model:r.model.get("user")}),this.childViews.suggestedBroadcasts.render(),this.ui.$suggestedBroadcasts.empty().append(this.childViews.suggestedBroadcasts.$el),this.ui.$suggestedBroadcastsContainer.removeClass("hide")):this.childViews.suggestedBroadcasts&&(this.ui.$suggestedBroadcastsContainer.addClass("hide"),this.childViews.suggestedBroadcasts.destroy(!0),this.childViews.suggestedBroadcasts=null)},renderBroadcastIsSuspended:function(){var e=n.getCurrentBroadcast();this.$el.toggleClass("broadcast-suspended",!!e&&!!e.get("isSuspended"))},renderQueueSyncing:function(){var e=this.model.get("player").get("queue");this.$el.toggleClass("syncing",!!e&&!!e.get("isSyncing"))},onSmileClick:function(e){var t=$(e.currentTarget),n=t.parents(".queue-item"),r=n.data("module"),i=r&&r.model;this.onAutoplayResponse(i,i.get("smile")?0:1)},onFrownClick:function(e){var t=$(e.currentTarget),n=t.parents(".queue-item"),r=n.data("module"),i=r&&r.model;this.onAutoplayResponse(i,i.get("frown")?0:-1)},onAutoplayResponse:function(e,t){if(!e)return;var r=e.get("queueSongID");e.set({smile:t==1,frown:t==-1,autoplayVote:t}),t<0?(_.gaTrackEvent("player","frown","queueSongID",r),n.trigger("guts:log","songDownVoted",{queueSongID:r,songID:e.get("SongID")})):t>0&&(_.gaTrackEvent("player","smile","queueSongID",r),n.trigger("guts:log","songUpVoted",{queueSongID:r,songID:e.get("SongID")}))},onManageBroadcastClick:function(e){var t=this.model.get("player").get("queue").get("currentBroadcast");n.router.replaceHash(t.toUrl(!1,"queue"))},updateQueueLabel:function(){var e=n.isBroadcastListener(),t=this.$queueNumTotal.html()==0;this.$queueCount.toggleClass("hide",t),this.$queueLabel.toggleClass("hide",e),this.$nowPlaying.toggleClass("hide",!e)}})}(),function(){n.Views=n.Views||{};var e;n.Views.Header=Backbone.View.extend({el:document.getElementById("header"),ui:{logo:".logo",title:".title",metadata:".metadata",songlink:".open-songpage",toggleChat:".toggle-chat",metaTitle:"@metadata .meta-title",metaByline:"@metadata .meta-byline",metaBylineArtist:"@metaByline .artist-name",metaBylineAlbum:"@metaByline .album-name",hamburgerContainer:".hamburger-container",searchInput:"#header-search .placeholder-input"},events:{"click @logo":"onHomeLinkClick","click @toggleChat":"toggleChat","keyup @searchInput":"onSearchKeyup","click .open-queue":"onOpenQueueClick","submit #header-search":"onSearchSubmit","click .close-search":"onCloseSearchClick","click .clear-filter":"onClearSearchClick","click .open-nowplaying":"onOpenNowPlaying","click @hamburgerContainer":"onHamburgerClick","click .open-autocomplete":"onOpenAutocompleteClick"},initialize:function(t){this.bindUIElements(),n.on("change:page",_.bind(this.onPageChange,this)),this.listenTo(n,"header:metadata lightbox:close",this.renderMetadata),e=t.gsApp,this.autocompleteView=new n.Views.Autocomplete({el:$(".ac-overlay"),overlay:!0,sections:[{type:"Artists",search:!0,useCombinedResults:!0},{type:"Users",search:!1},{type:"Songs",search:!0,useCombinedResults:!0},{type:"Albums",search:!0,useCombinedResults:!0},{type:"Playlists",search:!1},{type:"Broadcasts",search:!0,useCombinedResults:!0}]}),this.autocompleteView.render()},onSearchSubmit:function(e){var t=this.ui.$searchInput.val();e&&e.preventDefault(),n.router.setHash("/search?q="+encodeURIComponent(t)),this.autocompleteView.hide()},onPageChange:function(e,t){if(!t||!e)return;this.ui.$toggleChat.toggleClass("hide",t.subpage!="broadcast"),this.onClearSearchClick(),this.autocompleteView.hide()},onHamburgerClick:function(){var e=$("body");e.hasClass("show-ac-overlay")?(this.autocompleteView.hide(),this.ui.$toggleChat.removeClass("hide")):e.hasClass("lb-open")?(n.trigger("tooltip:close"),n.trigger("lightbox:close")):(e.hasClass("show-sidebar")||e.hasClass("show-now-playing")?n.trigger("mobile:hideQueue"):n.trigger("sidebar:open"),n.trigger("nowPlaying:close"),n.trigger("chatSidebar:close"))},onOpenQueueClick:function(){n.trigger("mobile:showQueue")},onOpenNowPlaying:function(){n.trigger("mobile:hideQueue"),n.trigger("nowPlaying:show")},onOpenAutocompleteClick:function(){$("body").hasClass("show-ac-overlay")?this.onSearchSubmit():(this.ui.$toggleChat.addClass("hide"),this.autocompleteView.show(),this.$(".placeholder-input").trigger("focus"))},toggleChat:function(){var e=$("body");e.hasClass("show-sidebar")?n.trigger("mobile:hideQueue"):e.hasClass("show-now-playing")&&n.trigger("nowPlaying:close"),e.hasClass("show-chat-sidebar")?n.trigger("chatSidebar:close"):n.trigger("chatSidebar:open")},onClearSearchClick:function(){this.ui.$searchInput.val("").trigger("change").trigger("focus")},onSearchKeyup:function(e){if(!this.autocompleteView)return;this.autocompleteView.changeQuery(this.ui.$searchInput.val())},onHomeLinkClick:function(t){t.preventDefault();var r=e.page.currentPageView,i;r&&r.pageType==="home"?(i=$(_.getScrollableBody()),i.animate({scrollTop:0},i.scrollTop()/5,"swing")):n.router.setHash("/#!/",{possiblyResetPage:!0})},updateTitle:function(e){this.ui.$title.translateText(e)},renderMetadata:function(e){var t,r,i;if(!e||!(e instanceof n.Models.Song)){this.$el.removeClass("show-metadata"),this.ui.$songlink.addClass("hide");return}t=e.get("SongName"),r=e.get("ArtistName"),i=e.get("AlbumName"),this.ui.$songlink.data("songId",e.get("SongID")),this.ui.$metaTitle.text(t),this.ui.$metaBylineArtist.text(r),i?this.ui.$metaBylineAlbum.removeClass("hide").text(i):this.ui.$metaBylineAlbum.addClass("hide"),this.$el.addClass("show-metadata"),this.ui.$songlink.removeClass("hide")}},{})}(),function(){function s(e,t){return function(n){return e.filter(function(e){return _.startsWith(e.attributes[t],n)})}}n.Views=n.Views||{};var t,i,o=Backbone.View.extend({dropStartTimer:null,events:{dropinit:"onDropInit",dropstart:"onDropStart",drop:"onDrop",dropend:"onDropEnd"},onDropInit:function(e,t){if(n.isBroadcastListener())return!1;e.currentTarget.updateDropOnDrag=_.bind(this.onDropOver,this)},onDropStart:function(e,t){if(!t.draggedItems||t.draggedItems.length===0)return!1;this.dropStartTimer=setTimeout(_.bind(this.onDropPause,this,t),700),this.isActiveDropTarget=!0},onDrop:function(e,t){this.onDropEnd(),t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=this.dropIsValid(t);if(!n||t.dropHandled)return;t.dropHandled=this.acceptDrop(t)},onDropPause:function(e){this.trigger("dropPause"),e.update()},onDropEnd:function(){clearTimeout(this.dropStartTimer),this.dropStartTimer=null,this.resetDrop(),this.isActiveDropTarget=!1},onDropOver:function(e,t){var n=this.dropIsValid(t);if(!this.isActiveDropTarget)return;this.$el.addClass("drop-pending"),this.$el.data("valid-drop",n)},resetDrop:function(){this.$el.removeClass("drop-pending")},dropIsValid:function(e){e.draggedItemsType=e.draggedItemsType||_.getCollectionType(e.draggedItems);switch(e.draggedItemsType){case"song":case"album":case"artist":case"tag":case"playlist":case"user":case"broadcast":return!0;default:return!1}},acceptDrop:function(e){function h(e){return function(r){c=s.get("songs").length?!1:!0,n.trigger("player:addSongs",r.toArray(),t,c,e)}}var t=n.Models.Player.playSpecialIndexes.LAST,i=r.model.get("player"),s=i.get("queue"),o,u,a,f,l,c;e.draggedItemsType=e.draggedItemsType||_.getCollectionType(e.draggedItems);if(!e.draggedItems||!e.draggedItems.length)return!1;switch(e.draggedItemsType){case"song":c=s.get("songs").length?!1:!0,l={index:t,playOnAdd:c,context:e.draggedItemsContext},i.addSongsEx(e.draggedItems,l);break;case"tag":var p=e.draggedItems[0];r.playGenre(p.get("DisplayName"),p.get("TagID"));break;case"album":case"artist":case"playlist":for(o=0,u=e.draggedItems.length;o<u;o++)a=e.draggedItems[o],a.getSongs().then(h(new n.Models.PlayContext(a)));break;case"user":a=e.draggedItems[0],a.playStation&&a.playStation();break;case"broadcast":a=e.draggedItems[0],f=r.model.get("user").joinBroadcast(a);default:return!1}}});n.Views.Sidebar=Backbone.View.extend({el:document.getElementById("sidebar-content"),templatePath:"sidebar",ui:{search:"#sidebar-search",nav:".sidebar-nav",myPlaylists:".my-playlists",subscribedPlaylists:".subscribed-playlists",broadcasts:".content.broadcasts",broadcastsTitle:"@broadcasts .title",searchInput:"@search input",searchPlaceholder:"@search .placeholder",searchPrediction:"@search .prediction",searchClearBtn:"@search .clear-filter",searchSubmitBtn:"@search .icon-search",scrollViews:".scroll-view",navLink:".nav-link",onlineFriends:".nav-link.online-friends",suggestedBroadcast:".suggested-broadcast",suggestedBroadcastsContainer:".suggested-broadcasts",settingsLink:".settings-link",languageLink:".language-link",playlist:".playlist-mini",collapseContentToggles:".collapse-toggle"},events:{"click .logo, .nav-link.home":"onHomeLinkClick","click .sidebar-nav .main-nav-link":"onMainNavClick","click #user-settings-btn":"onSettingsMenu","click @searchSubmitBtn":"onSearchClick","click @searchPlaceholder":"focusSearch","click @searchClearBtn":"onClearFilterClick","keydown @searchInput":"onSearchKeydown","keyup @searchInput":"onSearchKeyup","mousedown @searchInput":"onSearchMousedown","submit @search":"onSearchSubmit","focus @searchInput":"onSearchFocus","click #user-notifications-btn":"showNotifications","click .community-privacy-settings":"onCommunitySettingsMenu","click .sort-mine, .sort-subscribed":"onSidebarPlaylistSortClick","click .create-playlist":"onCreatePlaylistClick","click .more-link":"onMoreLinksClick","click @navLink":"onNavLinkClick","click @suggestedBroadcast":"onBroadcastClick","click @playlist":"onPlaylistClick","click @languageLink":"onLanguageLinkClick","click @collapseContentToggles":"toggleContentSection"},initialize:function(e){this.user=this.model.get("user");var t=this.user.get("UserID"),i=this.user.get("primaryUserID"),s=r.model.get("player").get("queue");return this.listenTo(n,"mobile:showQueue",this.onMobileShowQueue),this.listenTo(n,"mobile:hideQueue",this.close),this.isArtist=i&&i!=t,this.activeSection="home",this.renderedSections={home:!1,community:!1,queue:!0},this.user.getPlaylists(),this.isArtist&&(this.primaryUserDfd=n.Models.User.get(i),this.primaryUserDfd.done(_.bind(function(e){this.primaryUser=e},this))),this.model.on("change:user",_.bind(this.onUserChange,this)),this.addUserListeners(),this.listenTo(n,"manatee:disconnected",this.chatDisconnected),this.listenTo(n,"manatee:connected",this.chatConnected),this.listenTo(n,"sidebar:open",this.open),this.listenTo(n,"sidebar:close",this.close),this.listenTo(n,"sidebar:setSection",this.setActiveSection),this.listenTo(n,"change:page",this.onPageChange),this.listenTo(n,"auth:newNotification",this.onNewNotification),Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){var e=this.model.get("user");e&&e.off(null,null,this),this.$(".scroll-view").off("DOMMouseScroll mousewheel"),this.playlists.off(),this.subscribedPlaylists.off()},onPageChange:function(){var e=r.page.currentPageView,t=e?e.pageType:null,i=e?e.id:null,s=e?e.model.get("subpage"):null,o=e?e.model.get("section"):null,u=this.$(".content-nav .nav-link").removeClass("active"),a=this.model.get("appSize");(a==="tablet"||a==="mobile")&&this.close(!0);if(!e||t=="profile"&&i!=n.getLoggedInUserID())return;s=="collection"&&!o?t="collection":s=="collection"&&o=="favorites"&&(t="favorites"),u.filter("."+t).addClass("active")},open:function(){$("body").addClass("show-sidebar"),r.disableDocumentScroll(),n.trigger("sidebar:opened")},close:function(e){r.model.get("appSize")==="mobile"&&this.setActiveSection("home"),$("body").removeClass("show-sidebar"),r.enableDocumentScroll(),n.trigger("sidebar:closed",null,e)},render:function(){var e=this.$(".main-nav-link.queue"),t;this.bindUIElements();if(this.indexRendered){this.renderSection();return}this.childViews.queueNav=new o({el:e[0]}),this.childViews.queueNav.on("dropPause",function(){this.model.get("appSize")!=="mobile"&&this.setActiveSection("queue")},this),this.indexRendered=!0,t=new ChainLoading,this.renderSection(this.activeSection,t),this.user.get("isLoggedIn")&&this.loadUserInfo(t),this.listenTo(this.model,"change:user",this.renderFooterLinkVisibility),this.listenTo(n,"locale:changed",this.renderFooterLinkVisibility),this.renderFooterLinkVisibility()},renderSection:function(e,t){t||(t=new ChainLoading),this.activeSection=e,this.showActiveSection();if(!this.renderedSections[this.activeSection]){t.push(this.fetchTemplate(this.activeSection).done(t.bind(function(e){var t=this.$(".sidebar-section."+this.activeSection);t.html(this.renderTemplate(e,{user:this.user})),this.bindUIElements(),this.ui.$scrollViews.off("scroll."+this.cid+" DOMMouseScroll mousewheel"),this.ui.$scrollViews.on("DOMMouseScroll mousewheel",_.preventDocumentScroll),this.ui.$scrollViews.on("scroll."+this.cid,_.bind(this.onScrollViewScroll,this)),this.onPageChange(),this.renderedSections[this.activeSection]=!0},this)));switch(this.activeSection){case"home":t.done(_.bind(function(){var e=r.page.currentPageView;this.updateUserItems(),this.renderPlaylists(),this.renderBroadcasts(),!$("#sidebar-search input").val()&&e&&!_.contains(["login","registration"],r.page.currentPageView.pageType)&&this.focusSearch(),this.renderFooterLinkVisibility(),this.updateOnlineNowLinkVisibility()},this))}}else if(this.activeSection==="home")this.renderFooterLinkVisibility();else if(this.activeSection==="queue"){var n=this.childViews.bcListenerSidebar;n&&n.bioCheckHeight()}t.done(this.updateScrollThumb)},updateOnlineNowLinkVisibility:function(){this.ui.$onlineFriends.addClass("hide"),this.user.getFavoritesByType("Users").done(_.bind(function(e){var t=e&&e.length;t?(this.stopListening(e),n.trigger("tutorial:OnlineNow"),this.ui.$onlineFriends.removeClass("hide")):this.listenTo(e,"change reset add remove",this.updateOnlineNowLinkVisibility)},this))},onScrollViewScroll:function(e){n.trigger("fakeScroll",e)},onUserChange:function(){this.user=this.model.get("user");var e=this.user.get("UserID"),r=this.user.get("primaryUserID");this.renderedSections={home:!1,music:!1,community:!1,queue:!0},t&&t.get("UserID")!=this.user.get("UserID")&&(t.off(null,null,this),t.get("playlists")&&t.get("playlists").off(null,null,this),t.get("favoritePlaylists")&&t.get("favoritePlaylists").off(null,null,this),t.get("notifications")&&t.get("notifications").off(null,null,this),t.get("friends")&&t.get("friends").off(null,null,this),t.get("favoriteUsers")&&t.get("favoriteUsers").off(null,null,this),t.get("extraSidebarUsers")&&t.get("extraSidebarUsers").off(null,null,this),this.clearNotificationCount(),this.user.getPlaylists()),t=this.user,this.user.get("isLoggedIn")?(this.user.on("change:sessionPrivacy",this.onUpdatePrivacySettings,this),this.isArtist=r&&r!=e,this.isArtist&&(this.primaryUserDfd=n.Models.User.get(r),this.primaryUserDfd.done(_.bind(function(e){this.primaryUser=e},this))),this.addUserListeners(),this.indexRendered&&this.loadUserInfo()):this.updateNotificationCount(0),this.renderSection("home")},addUserListeners:function(){this.user.on("change:PathName",this.updateUserItems,this),this.user.on("change:Name",this.updateUserItems,this),this.user.on("change:Picture",this.updateUserItems,this),this.user.on("change:artistsOwned",this.updateUserItems,this),this.user.on("change:SettingsFlags",this.updateCollectionLink,this)},loadUserInfo:function(e){return e||(e=new ChainLoading),e.push(this.user.getPageNameData().done(e.bind(this.updateUserItems,this))),e.push(n.Services.API.getFreshTacosCount().done(e.bind(this.updateNotificationCount,this))),e},updateUserItems:function(){if(!this.renderedSections.home)return;var e=this.$("#sidebar-user"),t=e.find(".user-img"),n=e.find(".icon-caretdown"),r=e.find(".user-link .label"),i=e.find(".user-link"),s=this.$(".recent-plays-module"),o=this.user.get("artistID");this.$(".nav-link.favorites").attr("href",this.user.toUrl("collection/favorites")),this.$(".nav-link.collection").attr("href",this.user.toUrl("collection")),this.updateCollectionLink(),s.find(".title").attr("href",this.user.toUrl("listens")),s.find(".play-station").data("userId",this.user.id),this.$(".user-notifs").attr("href",this.user.toUrl("notifications")),i.attr("href",this.user.toUrl()),t.attr("src",this.user.getImageURL(30)),r.text(this.user.get("Name")),n.toggleClass("hide",!this.user.hasArtists()),e.removeClass("loading"),this.updateNotifBubble()},updateCollectionLink:function(){this.$(".coll-link-container").toggleClass("hide",!this.user.getUsesCollection())},focusSearch:function(){$("#sidebar-search input").trigger("focus")},renderPlaylists:function(){var e=n.getLoggedInUserID(),t=!!n.Services.Local.get("collapseSection.myPlaylists"+e),r=!!n.Services.Local.get("collapseSection.subscribedPlaylists"+e),i=$.Deferred(),s=function(e,t){return((t.attributes.TSLastPlayed||0)-(e.attributes.TSLastPlayed||0))*1},o;return this.user.get("isLoggedIn")||(this.ui.$myPlaylists.addClass("hide"),this.ui.$subscribedPlaylists.addClass("hide")),this.setSectionToggleState(this.ui.$myPlaylists,t),this.setSectionToggleState(this.ui.$subscribedPlaylists,r),this.destroyed?i.reject().promise():(o=new ChainLoading,o.push(this.user.getFavoritesByType("Playlists").done(o.bind(function(e){this.subscribedPlaylists=e,this.subscribedPlaylists.comparator=s},this))),o.push(this.user.getPlaylists().done(o.bind(function(e){this.playlists=e,this.playlists.comparator=s},this))),o.done(_.bind(function(){this.renderPlaylistGrids(i),this.listenTo(this.playlists,"add remove reset",function(){this.ui.$myPlaylists.toggleClass("hide",!this.playlists||!this.playlists.length),this.$(".sort-mine").toggleClass("hide",this.playlists.length===1),this.updateScrollThumb()}),this.listenTo(this.subscribedPlaylists,"add remove reset",function(){this.$(".subscribed-playlists").toggleClass("hide",!this.subscribedPlaylists||!this.subscribedPlaylists.length),this.$(".sort-subscribed").toggleClass("hide",this.subscribedPlaylists.length===1),this.updateScrollThumb()})},this)),i.promise())},renderMyPlaylistGrid:function(e){var t=this.$("#my-playlists-grid"),i=this.$(".sidebar-section.home").find(".scroll-view"),s=this.childViews.myPlaylistsGrid,o=r.model.get("appMode"),u=this.user.getPreferredPlaylistSort();s&&(s.off(),s.destroy(!1)),s=new n.Views.PlaylistsGridMini({el:t[0],itemHeight:o==="mobile"?50:32,collection:this.playlists,scrollElement:i}),this.childViews.myPlaylistsGrid=s,this.listenToOnce(s,"rendered",this.updateScrollThumb),s.render(),s.on("resized",function(){this.updateScrollThumb()},this),this.sortPlaylists(u.prop,null,null,null,u.dir),this.$(".sort-mine").toggleClass("hide",this.playlists.length===1),e&&e.resolve(s)},renderSubscribedPlaylistGrid:function(e){var t=this.$(".subscribed-playlists"),i=this.$("#subscribed-playlists-grid"),s=this.$(".sidebar-section.home").find(".scroll-view"),o=this.childViews.subscribedPlaylistsGrid,u=r.model.get("appMode");o&&(o.off(),o.destroy(!1)),o=new n.Views.PlaylistsGridMini({el:i[0],itemHeight:u==="mobile"?50:32,collection:this.subscribedPlaylists,scrollElement:s}),this.childViews.subscribedPlaylistsGrid=o,this.listenToOnce(o,"rendered",this.updateScrollThumb),o.render(),o.on("resized",function(){this.updateScrollThumb()},this),this.sortSubscribedPlaylists(),t.toggleClass("hide",!this.subscribedPlaylists||!this.subscribedPlaylists.length),this.$(".sort-subscribed").toggleClass("hide",this.subscribedPlaylists.length===1),e&&e.resolve(o)},renderPlaylistGrids:function(e){if(!this.playlists&&!this.subscribedPlaylists)return;var t=this.$(".sidebar-section.home"),n=this.playlists?this.playlists.length:0;n+=this.subscribedPlaylists?this.subscribedPlaylists.length:0,t.toggleClass("no-playlists",!n),this.renderMyPlaylistGrid(),this.renderSubscribedPlaylistGrid(),e.resolve(this.childViews.myPlaylistsGrid,this.childViews.subscribedPlaylistsGrid)},storeAndSortPlaylists:function(e,t,r){if(!this.childViews.myPlaylistsGrid)return;var i=e||"PlaylistName",s;i===n.Models.Playlist.createdSort&&(i="TSAdded"),this.sortPlaylists(e,null,r),s=this.childViews.myPlaylistsGrid.lastSortDir,this.user.updatePreferredPlaylistSort(i,s)},sortPlaylists:function(e,t,n,r,i){if(!this.childViews.myPlaylistsGrid)return;e=e||"PlaylistName",n=n||"asc",this.childViews.myPlaylistsGrid.sort(e,i,n,r)},sortSubscribedPlaylists:function(e,t,n){if(!this.childViews.subscribedPlaylistsGrid)return;e=e||"PlaylistName",n=n||"asc",this.childViews.subscribedPlaylistsGrid.sort(e,null,n,null)},onSidebarPlaylistSortClick:function(e){var t=$(e.currentTarget),r=t.hasClass("sort-subscribed"),i={tooltipKey:"sort-toolbar-menu",width:130,positionSpill:"left",tooltipClass:"sort-toolbar-menu",onSortItemClick:r?_.bind(this.sortSubscribedPlaylists,this):_.bind(this.storeAndSortPlaylists,this)};t.hasClass("menu-open")?n.trigger("tooltip:close"):_.asyncTooltipMenu(t,i,[],"getContextMenuForCombinedPlaylistsSort"),n.trigger("guts:log","sidebarClick",{sidebarAction:"playlistSort"})},getContextSwitchMenu:function(){if(this.primaryUserDfd&&this.primaryUserDfd.state()!=="resolved")return!1;var e=this.model.get("user"),t=e.get("artistsOwned"),i=[],s=_.bind(function(e){var t=$(e.currentTarget).find(".context").data("id"),i=r.model.get("player").get("queue"),s=i&&i.get("isBroadcasting"),o=s&&i.get("currentBroadcast"),u=_.bind(function(e,t){e&&e.end(),this.model.authenticateAsAuthorizedUser(t).fail(function(){n.trigger("notification:add",{title:_.getString("CONTEXT_SWITCH_FAIL"),type:"error"})}).always(_.bind(function(e){e&&n.trigger("lightbox:close","contextSwitchConfirm"),n.trigger("tooltip:close")},this,!!e))},this,o,t);o?n.trigger("lightbox:open",{lightboxKey:"contextSwitchConfirm",_type:"contextSwitchConfirm",view:{header:"LB_SWITCH_CONTEXT_CONFIRM_BROADCAST_TITLE",message:"LB_SWITCH_CONTEXT_CONFIRM_BROADCAST_MSG",buttonsLeft:[{label:"CANCEL",className:"close"}],buttonsRight:[{label:"SWITCH_CONTEXT",className:"btn-primary submit"}]},callbacks:{".submit":u}}):u()},this);return this.isArtist&&i.push({type:"module",module:new n.Views.Modules.ContextSwitchRow({model:this.primaryUser,authUser:e}),click:s}),t&&t.length&&t.each(function(t){if(this.isArtist&&t.get("ArtistID")==this.user.get("artistID"))return;i.push({type:"module",module:new n.Views.Modules.ContextSwitchRow({model:t,authUser:e}),click:s})},this),_.each(i,function(e,t){this.childViews["contextSwitchRow_"+t]=e.module},this),i.length?i.length>1?{type:"html",html:'<a class="menu-item"><span data-translate-text="SWITCH_TO_PROFILE" class="menu-title">'+_.getString("SWITCH_TO_PROFILE")+'</span><i class="icon icon-caretright"></i></a>',subMenu:{tooltipClass:"sub-menu context-switch",items:i}}:i[0]:!1},onSettingsMenu:function(t){if(this.settingsTooltip&&this.settingsTooltip.dfd&&this.settingsTooltip.dfd.state()==="pending"){this.settingsTooltip.closeTooltip();return}var r=$(t.currentTarget),i=this.model.get("user"),s=i.get("UserID"),o=i.get("subscription"),u=[],a=this.getContextSwitchMenu();this.user.get("isLoggedIn")?(u.push({localeKey:"SETTINGS",click:function(){var e=s>0?"/#!/settings":"/#!/settings/preferences";n.router.setHash(e)}}),a&&u.push(a),u.push({type:"divider"}),n.isLoggedInUserArtistProfile()||u.push({localeKey:"UPLOAD",click:function(){amdModules.requireDeferred("gs/views/lightboxes/upload.js").done(function(){n.trigger("lightbox:open","upload",{userDefault:!0})})}},{type:"divider"}),u.push({localeKey:"NEW_FEATURES",click:function(){n.router.setHash("/#!/new")}},{localeKey:"LANGUAGE",click:function(){n.trigger("lightbox:open","locale"),n.trigger("guts:log","localeLBOpenedFromSidebar"),_.gaTrackEvent("site","localeLBOpenedFromSidebar")}},{type:"html",html:'<a class="menu-item"><span data-translate-text="HELP" class="menu-title">'+_.getString("HELP")+'</span><i class="icon icon-caretright"></i></a>',subMenu:{items:[{localeKey:"SUPPORT",click:function(){e.open("http://help.grooveshark.com","_blank")}},{localeKey:"KEYBOARD_SHORTCUTS",click:function(){e.open("http://help.grooveshark.com/customer/portal/articles/1482027-keyboard-shortcuts")}}]}}),o&&o.canDirectEmail()&&u.push({localeKey:"GIVE_FEEDBACK",click:function(){n.trigger("lightbox:open","feedback",{type:"feedback"})}}),u.push({type:"divider"}),s<0&&u.push({localeKey:"SIGN_UP",click:function(){n.router.setHash("login")}}),this.user.get("isLoggedIn")&&u.push({localeKey:"SIGN_OUT",click:_.bind(this.signOut,this)})):u.push({localeKey:"SETTINGS",url:"/#!/settings/preferences"},{localeKey:"LANGUAGE",click:function(){n.trigger("lightbox:open","locale"),n.trigger("guts:log","localeLBOpenedFromSidebar"),_.gaTrackEvent("site","localeLBOpenedFromSidebar")}},{localeKey:"HELP",url:"http://help.grooveshark.com"}),this.userMenuOptions={tooltipKey:"sidebar-settings",delay:0,width:175,positionSpill:"right",$attached:r,tooltipClass:"sidebar-settings",model:i,appModel:this.model,sticky:!0,fixed:!0,items:u},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){this.settingsTooltip=n.Views.Tooltips.Menu.openTooltip(this.userMenuOptions),r.addClass("active"),this.settingsTooltip.dfd.always(function(){r.removeClass("active")})},this)),n.trigger("guts:log","sidebarSettingsClick"),_.gaTrackEvent("sidebar","onSettingsClick")},onSearchKeydown:function(e){this.user.getLibrary();var t=this.$el.find("input","#sidebar-search"),r,i,s,o,u,a,f,l,c;this.autocompleteTooltip&&(i=this.autocompleteTooltip.$el,s=$(".ac-list-item.selected",i),o=s.parents(".ac-section"));switch(e.which){case _.keyboard.ENTER:if(s&&s.length){e.preventDefault(),u=s.find(".ac-item-link").attr("href");if(u){n.router.setHash(u),t.val("");return}a=s.find(".ac-item-link").data("songId");if(a){var h=n.Models.Song.getCached(a);if(h){h.getToken().done(function(){n.router.setHash(h.toUrl())}),t.val("");return}}}r=t.parents("form"),r&&r.length&&r.submit(),t.blur();return;case _.keyboard.ESC:i?(this.autocompleteTooltip=null,n.trigger("tooltip:close")):(t.val(""),this.doAutocompleteDebounced(t));return;case _.keyboard.UP:e.preventDefault(),i&&(f=s.is(":first-child"),l=o.is(":first-child"),!s.length||l&&f?$(".ac-list-item:last",i).addClass("selected"):f?o.prev(".ac-section").children(".ac-list").children(":last-child").addClass("selected"):s.prev().addClass("selected"),s.removeClass("selected"));return;case _.keyboard.DOWN:e.preventDefault(),i&&(selLast=s.is(":last-child"),listLast=o.is(":last-child"),!s.length||selLast&&listLast?$(".ac-list-item:first",i).addClass("selected"):selLast?o.next(".ac-section").children(".ac-list").children(":first-child").addClass("selected"):s.next().addClass("selected"),s.removeClass("selected"));return;case _.keyboard.TAB:c=this.ui.$searchPrediction.text();return}this.displaySearchHelpers(e),this.cancelAutocompleteRequests(),this.doAutocompleteDebounced(t)},onSearchKeyup:function(e){this.displaySearchHelpers(e);var t=$(e.currentTarget);t.val()||t.focus()},displaySearchHelpers:function(e){var t=$(e.currentTarget),n=e.which,r=String.fromCharCode(n).replace(/[\b]/g,""),i=String.fromCharCode(n).replace(/[\s]/g,"");if(i&&i.length>0){var s=!t.val()||t.val()===""&&r&&r.length<1;this.ui.$searchPlaceholder.toggleClass("hide",!s),this.ui.$searchClearBtn.toggleClass("hide",s),s&&this.setPrediction()}},setPrediction:function(e){return;var t,n,r},onSearchMousedown:function(e){e.which==3&&this.ui.$searchPlaceholder.addClass("hide")},onClearFilterClick:function(e){e.preventDefault(),this.clearSearch(),n.trigger("guts:log","filterTextCancelClicked"),_.gaTrackEvent("user","filterTextCancelClicked")},clearSearch:function(){this.ui.$searchInput.val("").change(),this.autocompleteTooltip&&n.trigger("tooltip:close")},cancelAutocompleteRequests:function(){this.autocompleteTooltip&&this.autocompleteTooltip.cancelPendingRequests()},doAutocompleteDebounced:_.debounce(function(e){return this.doAutocomplete(e)},100),doAutocomplete:function(e){var t=$.trim((e.val()||"").toLowerCase());if(t.length>1&&this.autocompleteTooltip)this.autocompleteTooltip.changeQuery(t);else if(t.length>1){var r=this.user,i=$("#sidebar-search"),o={sticky:!0,width:330,positionSpill:"right",positionPad:5,autoCorrectOffset:!1,$attached:i,tooltipKey:"autocomplete",fixed:!0,tooltipClass:"sidebar-search"},u=!1,a=!1,f=!1,l=!1,c=!1,h=function(){return[]},p=!1,d=!1;r&&(u=r.get("library"),a=r.get("favoriteArtists"),f=r.get("favoriteUsers"),l=r.get("playlists"),c=r.get("favoritePlaylists"));if(a&&a.length||u&&u.length)p=function(e){var t=[];a&&a.length&&(t=t.concat(a.filter(function(t){return _.startsWith(t.attributes.ArtistName,e)})));if(u&&u.length){var r=u.filter(function(t){return _.startsWith(t.get("ArtistName"),e)});r.length&&(r=_.map(r,function(e){return n.Models.Artist.newOrUpdate(e.getArtists(e.attributes.ArtistID))}),t=t.concat(r),t=_.uniq(t))}return t};if(l&&l.length||c&&c.length)d=function(e){var t=[];l&&l.length&&(t=t.concat(l.filter(function(t){return _.startsWith(t.attributes.PlaylistName,e)})));if(c&&c.length){var n=c.filter(function(t){return _.startsWith(t.attributes.PlaylistName,e)});n.length&&(t=t.concat(n),t=_.uniq(t))}return t};this.autocompleteTooltip=new n.Views.Autocomplete({query:t,maxResults:12,sections:[{type:"Artists",filterFunction:p||h,search:!0,useCombinedResults:!0},{type:"Users",filterFunction:f&&f.length?s(f,"Name"):h,search:!1},{type:"Songs",filterFunction:u&&u.length?s(u,"SongName"):h,search:!0,useCombinedResults:!0},{type:"Albums",search:!0,useCombinedResults:!0},{type:"Playlists",filterFunction:d||h,search:!1},{type:"Broadcasts",search:!0,useCombinedResults:!0}]}),o.views=[this.autocompleteTooltip],o.noMobile=!0,n.trigger("tooltip:open",o);var v=_.bind(function(e){var t,n;switch(e){case"progress":n=arguments[1];if(n=="resultsChanged"||n=="rendered")t=arguments[2];break;case"fail":case"done":t={}}t&&(t.sections&&_.each(t.sections,_.bind(function(e){if(e.type==="Artists"){var t=e.results.models;this.lastPrediction=t&&t[0]&&t[0].get("ArtistName")||this.lastPrediction||""}},this)),this.setPrediction())},this);o.dfd.progress(_.bind(v,this,"progress")),o.dfd.done(_.bind(v,this,"done")),o.dfd.fail(_.bind(v,this,"fail")),o.dfd.then(_.bind(function(){this.autocompleteTooltip=null},this))}else this.autocompleteTooltip&&(this.autocompleteTooltip=null,n.trigger("tooltip:close"))},onHomeLinkClick:function(e){e.preventDefault();var t=r.page.currentPageView,i=$(e.currentTarget),s=t.childViews.genreSelector,o;t&&t.pageType==="home"?(o=$(_.getScrollableBody()),o.animate({scrollTop:0},o.scrollTop()/5,"swing"),s&&s.model.set("selectedTag","all")):n.router.setHash("/#!/",{possiblyResetPage:!0}),i.hasClass("nav-link")||n.trigger("guts:log","sidebarClick",{sidebarAction:"homeClick"})},onSearchClick:function(e){this.ui.$searchInput.val()?this.onSearchSubmit(null,this.ui.$searchInput):this.focusSearch()},onSearchSubmit:function(e,t){var r=e?$(e.currentTarget).find("input").val():t.val();n.router.setHash("/search?q="+encodeURIComponent(r)),this.autocompleteTooltip&&(this.autocompleteTooltip=null,n.trigger("tooltip:close")),e&&e.preventDefault(),n.trigger("guts:log","sidebarSearchSubmit")},onSearchFocus:function(e){var t=$(e.currentTarget),n=this.model.get("appSize");(n=="tablet"||n=="mobile")&&$("body").addClass("search-overlay"),t.val()&&this.doAutocompleteDebounced(t)},updateNotificationCount:function(e){this.unreadCount=_.toInt(e),this.updateNotifBubble()},updateNotifBubble:function(){var e=this.unreadCount;e>99&&(e=99),this.$el.toggleClass("has-notif",e>0).find(".notification-count").text(e||"-")},onNewNotification:function(){if(this.unreadCount>0)return;this.unreadCount=1,this.updateNotifBubble()},showNotifications:function(e){if(gsConfig.isMobile)return;e.preventDefault();if(this.tacobellTooltip&&this.tacobellTooltip.openDfd&&this.tacobellTooltip.openDfd.state()==="pending"){n.trigger("tooltip:close");return}amdModules.requireDeferred("gs/views/tooltips/tacobell.js").done(_.bind(function(){var e=$("#user-notifications-btn"),t={sticky:!0,delay:0,positionSpill:"right",width:350,$attached:e,$alternateTriggers:$(".notification-pill, .notification-count"),destroyViewOnClose:!1,fixed:!0};this.tacobellTooltip=new n.Views.Tooltips.Tacobell({model:this.user,appModel:this.model}),t.views=[this.tacobellTooltip],t.tooltipKey="tacobell",n.trigger("tooltip:open",t),this.tacobellTooltip.openDfd=t.dfd,this.tacobellTooltip.renderDfd.done(_.bind(function(){if(this.unreadCount>0){var e=this.user.get("notifications");e&&e.markAllAsSeen().done(_.bind(this.clearNotificationCount,this))}},this)),e.addClass("active"),this.tacobellTooltip.openDfd.always(function(){e.removeClass("active")})},this)),_.gaTrackEvent("site","headerClick","onTacoBell"),n.trigger("guts:log","sidebarClick",{sidebarAction:"onTacoBell"})},clearNotificationCount:function(){this.unreadCount=0,this.updateNotifBubble()},updatePrivacySetting:function(e,t){var r=_.orEqual(t,0);this.user.saveUserPreferences({privacy:{onlinePrivacy:r}}),n.trigger("guts:log","setPrivacySidebar",{setPrivacySetting:r}),_.gaTrackEvent("site","setPrivacySidebar",r)},onUpdatePrivacySettings:function(){this.isOnline=(this.user.get("sessionPrivacy")&4)===0,this.isOnline||(this.communityUsers.remove(this.user.get("extraSidebarUsers").models),this.communityUsers.each(_.bind(function(e){e.set({onlineStatus:0,nowPlayingSong:null,currentBroadcastOwner:null})},this))),n.trigger("tooltip:close");var e=this.$(".offline-privacy-msg");this.isOnline?e.addClass("hide"):e.removeClass("hide")},closeOfflineMsg:function(){this.$(".offline-privacy-msg").addClass("hide")},renderBroadcasts:function(){if(!this.user.get("isLoggedIn"))return;var e=n.getLoggedInUserID(),t=!!n.Services.Local.get("collapseSection.broadcasts"+e),r=this.$(".sidebar-section."+this.activeSection),i=r.find(".scroll-view");this.setSectionToggleState(this.ui.$broadcasts,t),this.childViews.suggestedBroadcasts&&this.childViews.suggestedBroadcasts.destroy(!1),this.childViews.suggestedBroadcasts=new n.Views.SuggestedBroadcasts({el:this.ui.$suggestedBroadcastsContainer,model:this.user,scrollElement:i,visibleCount:2,preferRecent:!0}),this.childViews.suggestedBroadcasts.render(!0).done(_.bind(function(){this.childViews.suggestedBroadcasts.collection.length&&(this.ui.$broadcasts.removeClass("hide"),this.childViews.suggestedBroadcasts.usingRecent||this.ui.$broadcastsTitle.translateText("SUGGESTED_BROADCASTS"))},this))},chatConnected:function(e){var t;if(!e.initial){t=Date.now();if(!i||t-i<18e5)n.Services.API.getFreshTacosCount().done(_.bind(this.updateNotificationCount,this)),i=t}},onManateeReconnectClick:function(){if(r.model.get("manatee").connected){this.chatConnected();return}this.$(".manatee-reconnect-btn").addClass("disabled"),n.trigger("manatee:initReconnect")},onCommunitySettingsMenu:function(e){var t=$(e.currentTarget),r=this.model.get("user"),i=r.get("sessionPrivacy"),s={tooltipKey:"online-settings",tooltipClass:"online-settings",delay:0,width:175,positionSpill:"right",sticky:!0,fixed:!0,model:r,appModel:this.model,$attached:t,items:[]},o,u,a;if(this.communityTooltip&&!this.communityTooltip.destroyed){this.communityTooltip.closeTooltip();return}(i&4)>0?(o="GO_ONLINE",u=0,a=!1):(o="GO_OFFLINE",u=4,a=!0),s.items.push({localeKey:o,click:_.bind(this.updatePrivacySetting,this,null,u)}),a&&s.items.push({type:"html",html:'<a class="menu-item'+(i===0?" checked":"")+'"><i class="icon icon-check"></i>'+'<span data-translate-text="SIDEBAR_EVERYONE" class="menu-title">'+_.getString("SIDEBAR_EVERYONE")+"</span></a>",click:_.bind(this.updatePrivacySetting,this,null,0)},{type:"html",html:'<a class="menu-item'+((i&8)>0?" checked":"")+'"><i class="icon icon-check"></i>'+'<span data-translate-text="SIDEBAR_FRIENDS" class="menu-title">'+_.getString("SIDEBAR_FRIENDS")+"</span></a>",click:_.bind(this.updatePrivacySetting,this,null,8)}),amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){this.communityTooltip=n.Views.Tooltips.Menu.openTooltip(s),t.addClass("active"),this.communityTooltip.dfd.always(function(){t.removeClass("active")})},this)),n.trigger("guts:log","sidebarCommunitySettingsClick"),_.gaTrackEvent("sidebar","onSidebarCommunitySettingsClick")},onMainNavClick:function(e){this.setActiveSection($(e.currentTarget).data("navSection"))},setActiveSection:function(e){var t=$("body"),i=e==="queue"&&t.hasClass("queue-has-songs");if(this.activeSection===e)return;this.childViews.suggestedBroadcasts&&(e==="community"?this.childViews.suggestedBroadcasts.render():this.childViews.suggestedBroadcasts.stopFetchLoop()),i&&n.trigger("tutorial:QueueMenu"),this.renderSection(e),i&&r.queue.scrollToActiveSong(!0),t.toggleClass("show-queue",e==="queue"),n.trigger("guts:log","sidebarClick",{sidebarAction:e+"NavClicked"})},showActiveSection:function(){this.$(".main-nav-link").removeClass("active"),this.$(".main-nav-link."+this.activeSection).addClass("active"),this.$el.attr("data-active-tab",this.activeSection),n.Services.Local.set("gs.lastOpenSidebarTab"+this.user.get("UserID"),this.activeSection)},updateScrollThumb:function(){n.trigger("setScrollThumbHeight")},onCreatePlaylistClick:function(e){var t;this.user.get("isLoggedIn")?n.trigger("lightbox:open","createPlaylist"):(t={$attached:$(e.currentTarget),positionSpill:"right",sticky:!0,fixed:!0,width:250},n.Models.AuthUser.openRequireLoginTooltip("LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST",function(){n.trigger("lightbox:open","createPlaylist")},t))},onNavLinkClick:function(e){var t=$(e.currentTarget),r=t.attr("class");n.trigger("guts:log","sidebarClick",{sidebarAction:"navLinkClick",classes:r})},onBroadcastClick:function(){n.trigger("guts:log","sidebarClick",{sidebarAction:"broadcastClick"})},onPlaylistClick:function(){n.trigger("guts:log","sidebarClick",{sidebarAction:"playlistClick"})},onLanguageLinkClick:function(){n.trigger("lightbox:open","locale")},renderFooterLinkVisibility:function(){var e=$("#sidebar-footer"),t=e.children(".footer-links"),r=t.children('.link:not(".more-link")').removeClass("hide"),i=n.getLoggedInUserID()>0,s=!1,o=45,u=0;this.ui.$languageLink.toggleClass("hide",i),this.ui.$settingsLink.toggleClass("hide",i);while(r.length&&t.height()>o){if(u>100)break;r.last().addClass("hide"),r=r.slice(0,r.length-1),s=!0,u++}t.children(".more-link").toggleClass("hide",!s),r.length&&t.height()>o&&r.last().addClass("hide")},onMoreLinksClick:function(e){var t=$(e.currentTarget),r=$("#sidebar-footer"),i=r.children(".footer-links").children(".link"),s={$attached:t,positionSpill:"left",width:110,minHeight:i.filter(".hide").length*30+12,className:"sidebar-footer-links",$items:i.filter(".hide")};t.hasClass("menu-open")?n.trigger("tooltip:close"):_.asyncTooltipMenu(t,s,this.model,"getSidebarFooterMoreLinks")},signOut:function(){this.model.logout()},onMobileShowQueue:function(){n.trigger("nowPlaying:close"),r.header.updateTitle("QUEUE"),this.setActiveSection("queue"),this.open()},toggleContentSection:function(e){var t=$(e.currentTarget),r=t.parents(".content"),i=r.data("sectionName"),s=r.hasClass("collapsed");this.setSectionToggleState(r,!s),n.Services.Local.set("collapseSection."+i+n.getLoggedInUserID(),!s),n.trigger("page:redrawUpdate")},setSectionToggleState:function(e,t){if(!e||!e.length)return;e.toggleClass("collapsed",!!t).toggleClass("expanded",!t).find(".icon.collapse-toggle").toggleClass("icon-caretright",!!t).toggleClass("icon-caretdown",!t)}},{})}(),function(){n.Views=n.Views||{},n.Views.Theme=n.Views.Theme||{};var r,i,s,o,u,a,f,l;n.Views.Theme=Backbone.View.extend({lastTheme:null,themeRegex:/^#!\/(theme)\/(.*)\/?/,promoRegex:/^#!\/(promotion)\/(.*)\/?/,isFirstVisit:!1,isFirstVisitPending:!1,lastPage:null,isTemporary:!1,showWelcomeBanner:!1,ids:{PREMIUM:999,WELCOME:1e3,SIGNUP:1896,TRIAL:1897,BANNER:1877},el:"#theme-container",initialize:function(){return f=this.eventer=this.options.eventer,this.eventer.theme=_.extend({},Backbone.Events),this.appSize=this.options.model.get("appSize"),l=this.model,n.on("theme:get",_.bind(this.getTheme,this)),n.on("change:page",_.bind(this.onPageChange,this)),n.on("change:page:type",_.bind(this.onPageChange,this)),n.on("theme:click",_.bind(this.onThemeClick,this)),n.on("theme:preserveThemeHeight",_.bind(this.preserveThemeHeight,this)),n.on("app:resize",_.bind(function(e,t){f.trigger("theme:resize",t),this.handleWindowResize()},this)),this.model.on("change:appSize",_.bind(function(){f.trigger("theme:appSize",this.model.get("appSize")),this.handleAppSize()},this)),f.on("theme:windowResize",_.bind(this.handleWindowResize,this)),f.on("theme:appSize",_.bind(this.handleAppSize,this)),n.ready.done(_.bind(this.onAppReady,this)),Backbone.View.prototype.initialize.call(this)},onAppReady:function(){location.hash&&(location.hash.match(this.themeRegex)||location.hash.match(this.promoRegex))&&(n.Models.Theme.themeSetByUser=!0),n.Models.Theme.getThemeDefinitions().always(_.bind(function(){this.model.on("change:user",this.onUserChange,this),_.delay(_.bind(this.onUserChange,this))},this))},onUserChange:function(){var t=!this.user;s=this.user=this.model.get("user"),a=this.user.get("subscription").canHideAds(),a?(this.initialized=!0,f.isFirst=this.isFirstVisit=!1,$("body").removeClass("is-first"),this.destroyTheme(),this.showWelcomeBanner=!n.Services.Local.get("seenWelcomeBanner"),n.Services.Local.set("seenWelcomeBanner",!0),r&&r.canTheme&&this.showWelcomeBanner&&o&&this.setTheme()):(n.Models.Ad.userParams(this.user),t?this.themeSetByUser?(n.Services.Local.set("isFirstVisit",!1),f.isFirst=this.isFirstVisit=!1,this.initialized=!0,this.preserveThemeHeight(null,!0),this.destroyTheme()):(this.isFirstVisit=f.isFirst=!1,l.set("isFirstVisit",!(this.user.get("UserID")>0||_.defined(n.Services.Local.get("isFirstVisit")))),e.location.hash.indexOf("m=1")>=0&&e.location.hash.indexOf("id=")>=0&&(f.isFirst=this.isFirstVisit=!1),this.isFirstVisit?(n.Services.Local.set("isFirstVisit",!1),this.preserveThemeHeight(null,!0),this.destroyTheme(),n.Services.GUTS.beginContext({isFirstVisit:!0}),_.gaSetCustomVariable(1,"User",this.user.getUserStringForAnalytics()+",N:Y")):r&&r.canTheme?this.getTheme():(this.preserveThemeHeight(null,!0),this.destroyTheme()),this.initialized=!0):!this.isFirstVisit&&(!r||!r.canTheme)&&(this.preserveThemeHeight(null,!0),this.destroyTheme())),t&&(this.user.on("change:subscription",_.bind(function(){var e=a!=this.user.getIsPremium();a=this.user.getIsPremium(),n.Models.Ad.userParams(this.user),e&&(a?(this.preserveThemeHeight(null,!0),this.destroyTheme()):this.setTheme())},this)),this.callPageChangeOnUserSet&&this.onPageChange.apply(this,this.callPageChangeOnUserSet))},onPageChange:function(e,i,f){if(!this.user){this.callPageChangeOnUserSet=_.toArray(arguments);return}delete this.callPageChangeOnUserSet,this.lastPage=r,r={type:e,params:i,view:f,subpage:i?i.subpage:null,section:i?i.section:null,canTheme:n.Models.Theme.themePageCheck(e,{section:i?i.section:null})||e==="settings"&&s.get("UserID")<0},r.subpage=r.type==="broadcasts"?t:r.subpage,r.key=r.type+(r.params.artistID||r.params.id)+(r.section&&r.section=="broadcast"?null:r.subpage)+r.section,r.key+=r.type=="search"?r.params.type:"",o=r.type=="home",u=n.Models.Theme.topLevelCheck(r.type);if(!r.canTheme){this.$el.addClass("no-theme"),this.destroyTheme();return}this.$el.removeClass("no-theme");if(r.type==="settings"&&r.canTheme){(!this.lastPage||this.lastPage.type!=="settings")&&this.setTheme();return}if(this.lastPage&&this.lastPage.key==r.key||this.themeSetByUser)return;if(!this.initialized)return;if(a){r&&r.canTheme&&this.showWelcomeBanner&&o?this.setTheme():(this.preserveThemeHeight(null,!0),this.destroyTheme());return}if(o&&this.isFirstVisit){this.setTheme();return}if(location.hash.match(this.promoRegex))return;n.Models.Ad.pageParams({type:e,params:i,view:f}),this.getTheme()},getTheme:function(e){n.Models.Ad.paramFragments.theme=[],e=e||{};var t="grooveshark",i="stingray."+(!r||r.type=="home"?"home":"tl"),s="http://crtl.aimatch.com/gshark/lserver/tserver/site="+t+"/area="+i+"/size=777x777",o=this.getParams("/","/").replace("/dcmt=text/json/sz=777x777/","/"),u=e.id&&e.temporary?["/id="+e.id,"m=1"].join("/"):"/",a={type:"GET",url:s+o+u,data:{},xhrFields:{withCredentials:!1},crossDomain:!0,dataType:"text",beforeSend:_.bind(function(){e.id&&e.temporary?(r=r?r:{type:"home"},n.Models.Theme.themeSetByUser=this.themeSetByUser=!0):this.timeoutID=setTimeout(_.bind(function(){this.setTheme(this.ids.BANNER)},this),12e3)},this),success:_.bind(function(t){this.handleTheme(null,e,t)},this),error:_.bind(function(t){this.handleTheme(null,$.extend({failed:!0},e),t)},this)};$.ajax(a)},handleTheme:function(e,t,r){clearTimeout(this.timeoutID);if(t.failed||!r&&!t.temporary){this.setTheme(this.ids.BANNER);return}if(_.isString(r))try{r=$.parseJSON(r)}catch(i){if(!t.temporary){console.log("Theme: Invalid JSON from theme server",i),this.setTheme(this.ids.BANNER);return}}n.Models.Theme.getThemeDefinitions().always(_.bind(function(){if(t&&t.id&&t.temporary)if(n.Models.Theme.themes[t.id]){if(t.id!=r.id){console.log("Theme: ID mismatch"),this.setTheme(t.id,t);return}}else{if(t.id!=r.id){this.setTheme(),console.log("Theme: Could not find theme");return}n.Models.Theme.themes[t.id]=r}else if(r.id<0){console.log("Theme: Track default"),this.trackDefault(r.id,r.tracking),this.setTheme(this.ids.BANNER);return}n.Models.Theme.themes[r.id]?$.extend(n.Models.Theme.themes[r.themeID],r):n.Models.Theme.themes[r.id]=r,this.setTheme(r.id,t)},this))},setTheme:function(e,t){e||(a?e=this.ids.PREMIUM:n.getLoggedInUserID()>0?e=s.get("subscription").getPrices().hasTrialOption?this.ids.TRIAL:this.ids.WELCOME:e=this.ids.TRIAL),n.Models.Theme.getThemeDefinitions().always(_.bind(function(){if(!n.Models.Theme.themes[e])return;i&&this.destroyTheme();var t=new n.Models.Theme(n.Models.Theme.themes[e]);$.ajax({url:t.getViewPath(),cache:!0}).done(_.bind(function(){if(!r.canTheme){this.destroyTheme();return}i=new n.Views.Themes.CurrentThemeView({model:t}),this.childViews.currentThemeView=i,i.render()},this)).fail(_.bind(function(e){console.log("Theme: Failed to load view."),this.destroyTheme()},this))},this))},destroyTheme:function(){i&&(f.theme.off(),i.destroy()),this.$el.html('<div id="theme">')},handleWindowResize:function(t){if(i&&!i.disableResize){var t=(t||$(e).height())/2.5,n=i.$resize||i.$el;n.height(t)}},handleAppSize:function(){i&&!i.disableAppSize&&_.defer(_.bind(function(){i.$el.removeClass(this.appSize),this.$el.removeClass(this.appSize),this.appSize=this.options.model.get("appSize"),i.$el.addClass(this.appSize),this.$el.addClass(this.appSize)},this))},getParams:function(e,t){var r=[],e=e||";",t=t||";";return n.Models.Ad.getParams(r,e,t,this)},trackDefault:function(e,t){o&&(n.Models.Ad.loadTracking(t),n.Services.API.logTargetedThemeImpression(e),n.Services.GUTS.logEvent("trackDefaultTheme",{id:e}))},onThemeClick:function(e){e&&e.currentTarget&&i&&(e.data={currentTheme:i.model},f.trigger("theme:handleClick",e))},preserveThemeHeight:function(e,t){if(!s)return;var r=a&&(!this.showWelcomeBanner||!o),i;this.zeroOut||r?this.$el.height(0):n.Models.Theme.themePageCheck(e)&&(i=this.$el.height(),i=i?i:300,this.$el.height(i)),n.trigger("page:redrawUpdate")}}),n.Views.Theme.Base=Backbone.View.extend({el:"#theme",initialize:function(){return this.model.set("version",this.model.get("version")||this.version||0),n.Models.Theme.version=this.model.get("version"),this.getStyles(),this.eventer=f,this.currentPage=r,this.appModel=l,this.template=this.model.getTemplatePath(),f.on("theme:handleClick",_.bind(this.handleClick,this)),this.model.get("interactiontimeout")&&(this.handleTimeout=_.bind(function(e){e&&e.type=="interactionTimeout"&&n.Models.Ad.loadTracking(i.get("interactiontimeout").tracking)},this),n.on("lightbox:rendered",this.handleTimeout)),n.Models.Ad.themeParams(this.model),n.Models.Theme.themeSetByUser=!1,f.trigger("theme:set",this),Backbone.View.prototype.initialize.call(this)},render:function(){if(this.destroyed)return;this.fetchTemplate(this.template).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.preRender(),this.$el.html(this.renderTemplate(e,{model:this.model})),this.postRender(),this.bindUIElements(),this.ready(),_.defer(function(){n.trigger("page:redrawUpdate")})},preRender:function(){u&&f.trigger("ad:handleCompanion")},postRender:function(){f.trigger("theme:windowResize"),f.trigger("theme:appResize"),this.bindAssets({section:"#theme",currentTemplate:"clicks",defaultTracking:this.defaults||{}}),this.model.trackView();var e=_.bind(function(){this.$el.parent().css("height","auto"),_.defer(_.bind(function(){f.trigger("theme:windowResize"),n.trigger("page:redrawUpdate")},this)),clearInterval(r)},this),t=0,r=setInterval(_.bind(function(){(this.cssLoaded||++t>=50)&&e(),this.postRendered=!0},this),50);this.once("cssLoaded",e)},onDestroy:function(){this.handleTimeout&&n.off("lightbox:rendered",this.handleTimeout),$("#theme-styles").remove(),n.Models.Theme.version=0,f.trigger("theme:set")},bindAssets:function(e){var t=e.section,r=e.currentTemplate,s=e.defaultTracking,o=this.model.get(r)?this.model.get(r):this.model.set(r,s).get(r),u=$(t).find("a[data-click-id], div[data-click-id]"),a,f,l,c,h,p,d,v=0,m,g;_.each(u,_.bind(function(e,r){e=$(e);var s=o[e.attr("data-click-id")],u=e.attr("data-click-action");u?e.attr("data-"+u+"-id",s):s&&(s=n.Models.Theme.cleanURL(s),e.attr("href",s),e.attr("target")||e.attr("target","_blank")),e.hasClass("flash")?(a=_.orEqual(e.attr("data-flash-wmode"),"opaque"),f=_.orEqual(e.attr("data-flash-width"),"100%"),l=_.orEqual(e.attr("data-flash-height"),"100%"),c=_.orEqual(e.attr("data-flash-src"),null),p=_.orEqual(e.attr("data-flash-params"),""),d=_.orEqual(e.attr("data-flash-visualizer"),null),c&&e.attr("id")&&(m=d?"visualizerTheme":t+"-flash-"+v++,e.append('<div id="'+m+'"></div>'),g="?ver="+this.model.get("version")+"&themeID="+this.model.get("themeID")+"&currentTarget=%23"+e.attr("id")+p,h=swfobject.embedSWF("/themes/"+i.get("location")+"/assets/"+c+g,m,f,l,"9.0.0",null,null,{wmode:a,allowScriptAccess:"always"},null,_.bind(function(e){this.model.trigger("theme:swf:event",e)},this)))):(e.off("click",this.handleClick),e.click({currentTheme:this.model},this.handleClick))},this))},handleClick:function(t){var r=$(t.currentTarget),i=t.data?t.data.currentTheme:null,s;switch(r.attr("data-click-action")){case"link":r.hasClass("flash")&&e.open(s,"_newtab");break;case"song":s=_.toInt(r.attr("data-song-id")),n.Models.Song.get(s).done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",[e],null,!0,t)});break;case"album":s=r.attr("data-album-id"),n.Models.Album.get(s).done(function(e){e&&e.getSongs().done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",e.toArray(),null,!0,t)})});break;case"playlist":s=r.attr("data-playlist-id"),n.Models.Playlist.get(s).done(function(e){e&&e.getSongs().done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",e.toArray(),null,!0,t)})});break;case"station":s=r.attr("data-station-id"),n.Models.Tag.get(s).done(function(e){e.playStation()});break;case"videos":if(i&&i.get("videos")){var o=_.orEqual(r.attr("data-video-index"),0);n.trigger("lightbox:open","video",{videos:i.get("videos"),index:o,eventer:f,contextTheme:!0})}break;case"lightbox":s=r.attr("data-lightbox-name"),s&&n.trigger("lightbox:open",s);break;case"expand":var u=$("#theme-expand-inner"),a=_.toInt(r.attr("data-expand-height"));u.height()>0?u.animate({height:0},200):u.animate({height:a},200)}(r.attr("data-theme-id")||i&&i.id)&&n.Services.API.logThemeOutboundLinkClick(r.attr("data-theme-id")||i.id,r.attr("data-click-id"))},getStyles:function(e){$("#theme-styles").remove(),$("head").append('<link rel="stylesheet" type="text/css" id="theme-styles" />');var t=[gsConfig.assetHost,"themes",this.model.get("location"),"index.css"].join("/")+"?ver="+_.orEqual(this.model.get("version"),1),r=document.getElementById("theme-styles"),i=0,s,o,u;s=_.bind(function(){e&&e(),this.postRendered&&(this.$el[0].style.height="auto",n.trigger("page:redrawUpdate")),this.cssLoaded=!0,this.trigger("cssLoaded"),clearTimeout(u)},this),o=_.bind(function(){if(this.cssLoaded)return;try{r.sheet.cssRules||r.sheet.rules&&r.sheet.rules.length}catch(e){if("NS_ERROR_DOM_SECURITY_ERR"!==e.name&&++i<=50){u=setTimeout(o,50);return}}s()},this),r.onreadystatechange=function(){(this.readyState==="complete"||this.readyState==="loaded")&&s()},r.async="true",r.onload=s,r.href=t,o()},ready:function(){}})}(),function(){function N(){return"gs-"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function C(t,n){n=n||{},n.evalType=n.evalType||"visible",n.scrollOffset=n.scrollOffset||0;if(!$.contains(document,t[0]))return!1;var r=$(e).height(),i=$(e).scrollTop(),s=$(t).offset().top-n.scrollOffset,o=$(t).height()+n.scrollOffset;if(n.evalType==="visible")return s<r+i&&s>i-o;if(n.evalType==="above")return s+o*.5<r+i}n.Views=n.Views||{},n.Views.Capital=n.Views.Capital||{};var t=0,i=0,s=!1,o=!1,u=["login","registration","settings","artistAnalytics","userOnboarding","artistOnboarding","upgrade","newFeatures"],a=new Backbone.Model({home:!1}),f=0,l=0,c=0,h=0,p,d,v,m,g,y,b,w,E,S,x,T;n.Views.Capital.Rotation=function(){return _.extend({intervalID:null,defaultInterval:3e4,maxIdle:18e4,isIdle:!1,idleCount:3e4,init:function(){gsConfig.country.ID==177&&(this.defaultInterval=this.idleCount=12e4)},stop:function(){clearInterval(this.intervalID)},reset:function(){this.stop(),gsConfig.country.ID!=106&&(this.intervalID=setInterval(_.bind(this.rotate,this),this.defaultInterval))},rotate:function(){var t=$.now(),n=t-r.lastActive,i=gsConfig.country.ID==223||gsConfig.country.ID==38||gsConfig.country.ID==221||gsConfig.country.ID==15;if(e.ignoreRotation)return;if(n<=this.maxIdle||i)this.isIdle=n>=this.idleCount,this.trigger("ad:rotate"),m.trigger("ad:rotate")}},Backbone.Events)},n.Views.Ads=Backbone.View.extend({lastPage:null,theme:null,user:null,isFirst:!1,placements:{},adHost:null,initialize:function(e){return m=this.options.eventer,m.ads=_.extend({},Backbone.Events),g=this.model,this.model=new Backbone.Model,this.listenTo(g,"change:user",this.onUserChange),_.defer(_.bind(function(){this.setupAudioAds()},this)),n.ready.done(_.bind(this.onAppReady,this)),Backbone.View.prototype.initialize.call(this,e)},setupAudioAds:function(){var e=g.get("player"),t=e.get("queue");this.listenTo(e,"change:queue",this.onQueueChange),this.onQueueChange(e,t,{})},onQueueChange:function(t,r){var i=this,s=t.previous("queue"),o;s&&(s.off(null,null,this),s.originalPlaySong&&(s.constructor.prototype.playSong=s.originalPlaySong,delete s.originalPlaySong));if(r){o=function(e,t){var r=e?"audioRollImpOnComplete":"audioRollImpOnPlay";n.trigger("guts:log",r,{impCount:t}),n.Services.GUTS.forceSendAsync()},r.on("mark30",function(){var t=g.get("user");if(t.get("subscription").canHideAds()||n.getCurrentBroadcastID()||e.outerWidth<=n.Models.Model.APP_SIZES.desktop)return;f++,l++;if((!p||!d)&&(l===2||f>=5)){var i=r.get("activeSong");i&&(i.off(null,null,this),i.on("change:playStatus",function(e){e._previousAttributes.playStatus&&e.get("playStatus")===n.Models.Player.playStatuses.NONE&&d&&(d=null,c++,o(!0,c),i.off(null,null,this))},this)),f=0,p=!0,d=!0;return;var s}},this),r.on("playNextSong",function(){d&&(d=null,c++,o(!0,c))},this);function u(e,t){function u(){r.trigger("audioAdComplete",s.model),s.destroy(),delete i.childViews.audioRoll,r.originalPlaySong.apply(r,_.toArray(s.lastPlayArgs))}var s=new n.Views.Capital.AudioRollAds({model:e}),o=r.get("activeSong");s.render(),s.resize(),s.lastPlayArgs=t,i.childViews.audioRoll=s,s.on("complete",function(){f=0,u()}),s.on("error",u),e.on("setup",function(){r.trigger("audioAdStart",s.model)}),o&&o.stop()}r.originalPlaySong=r.originalPlaySong||r.playSong,r.constructor.prototype.playSong=function(){var e=g.get("user"),t=p,s=arguments,a;if(i.childViews.audioRoll){i.childViews.audioRoll.lastPlayArgs=arguments;return}p=null,a=function(){r.originalPlaySong.apply(r,_.toArray(s))};if(e.get("subscription").canHideAds()||n.getCurrentBroadcastID()){a();return}if(!t){a();return}a(),h++,o(!1,h);return}}},onAppReady:function(){this.onUserChange()},onUserChange:function(){w=this.user=g.get("user"),E=w.get("subscription").canHideAds();var t=this,r=w.get("subscription"),i=function(){t.listenTo(w,"change:subscription",function(){t.listenTo(r,"ad:handleSub",o),o()}),t.listenTo(r,"ad:handleSub",o),E||(t.adHost=e.location.host.indexOf("preview")>=0?"http://preview.ads-grooveshark.com":gsConfig.runMode=="production"?"http://ads-grooveshark.com":gsConfig.assetHost,t.adHost&&$.receiveMessage(t.adHost).progress(_.bind(t.handlePostMessage,t)),a&&(a=null),$.receiveMessage(e.location.protocol+"//"+e.location.host).progress(_.bind(t.handlePostMessage,t)),n.Models.Ad.userParams(w),t.rotation=new n.Views.Capital.Rotation,t.rotation.init(),t.listenTo(n,"app:resize",t.handleWindowResize),t.listenTo(t.model,"change:appSize",t.appResize),t.listenTo(n,"authUser:personalizedSongsLoaded",function(){w.getPersonalizedTags({}).done(_.bind(function(e){if(e&&e.length){e=new Bedrock.Collection(e);var t=n.Services.Local.get("personalizedTags")||{};t[w.get("UserID").toString()]=e.pluck("TagID"),n.Models.Ad.personalizedTags=t,n.Services.Local.set("personalizedTags",t)}},t))}),t.listenTo(m,"theme:set",t.handleSetTheme),t.listenTo(n,"change:page",t.onPageChange),t.listenTo(n,"ad:handleInCardAds",t.handleInCardAds),t.listenTo(n,"ad:stopRotation",t.handleStopRotation),t.listenTo(m,"ad:destroyChild",t.destroyChild))},s=function(){var e=t.childViews.audioRoll;delete t.childViews.audioRoll,t.cleanupChildViews(null,{remove:!1}),t.stopListening(n),t.stopListening(t.model),t.stopListening(m),t.stopListening(r),t.stopListening(w),n.Views.Ads.AppSize=null,e&&(t.childViews.audioRoll=e)},o=function(){s(),E?t.childViews.audioRoll&&(t.childViews.audioRoll.destroy(),delete t.childViews.audioRoll):i()};s(),i()},onPageChange:function(t,r,i){n.Models.Ad.pageParams({type:t,params:r,view:i}),this.stopListening(this.model,"change:appSize");var s=_.indexOf(u,t)>=0;this.lastPage=a||{},a={type:t,subpage:function(){return n.Views.Pages.Search&&i instanceof n.Views.Pages.Search?i.currentType:n.Views.Pages.Broadcasts&&i instanceof n.Views.Pages.Broadcasts?i.model.get("subpage")+"-"+i.model.get("query").tagID:i.model.get("subpage")}(),section:i.model.get("section"),view:i,params:r,noAdsOnPage:s},a.key=a.type+a.subpage+a.section,y=a.type=="home",b=n.Models.Theme.topLevelCheck(a.type),S=t==="profile"&&r.subpage==="broadcast",x=a.type=="popular",T=a.type=="broadcasts";if(S&&this.lastPage.params&&this.lastPage.params.id==a.params.id){this.lastPage.key=a.key;return}this.lastPage.key!=a.key&&this.stopListening(n,"page:ready"),s?this.destroyChildren():this.lastPage.key!=a.key&&(a.ready=!1,this.listenTo(n,"page:ready",_.bind(this.onPageReady,this))),e.ignoreRotation=!1,m.trigger("ad:pageChange",arguments),this.rotation.reset()},onPageReady:function(e,t){if(t)return;if(a.ready)return;n.trigger("ad:redrawUpdate"),a.ready=!0,this.handleWindowResize(),m.trigger("ad:pageReady"),this.listenTo(this.model,"change:appSize",this.appResize),this.appResize()},handleSetTheme:function(e){v=e},handleWindowResize:function(){var t=e.outerWidth;t>=n.Models.Model.APP_SIZES.desktopXL?this.model.set("appSize","desktopXL"):t>=n.Models.Model.APP_SIZES.desktop?t>=n.Models.Model.APP_SIZES.desktop+475&&t<n.Models.Model.APP_SIZES.desktopXL?this.model.set("appSize","desktopM"):this.model.set("appSize","desktop"):t>=n.Models.Model.APP_SIZES.tablet?t>=n.Models.Model.APP_SIZES.desktop-290&&t<n.Models.Model.APP_SIZES.desktop?this.model.set("appSize","tabletXL"):this.model.set("appSize","tablet"):this.model.set("appSize","mobile")},appResize:function(){var e=n.Views.Ads.AppSize,t=this.model.get("appSize");n.Views.Ads.AppSize=t,n.Views.Ads.AppSizeIsMobile=t==="mobile";if(!a||a.noAdsOnPage)return;switch(t){case"mobile":case"tablet":!y&&!this.childViews.dockAds&&(this.destroyChildren(),this.childViews.dockAds=new n.Views.Capital.DockAds,this.childViews.dockAds.render()),y&&!this.childViews.inCardAds&&(this.destroyChildren(),this.childViews.inCardAds=new n.Views.Capital.InCardAds,this.handleInCardAds());break;case"tabletXL":y?this.childViews.columnAds||(this.destroyChildren(),this.childViews.columnAds=new n.Views.Capital.ColumnAds,this.childViews.columnAds.render()):this.childViews.dockAds||(this.destroyChildren(),this.childViews.dockAds=new n.Views.Capital.DockAds,this.childViews.dockAds.render());break;case"desktop":case"desktopM":case"desktopXL":S?((this.childViews.columnAds||!this.childViews.inCardAds)&&this.destroyChildren(),this.childViews.inCardAds||(this.childViews.inCardAds=new n.Views.Capital.InCardAds)):(this.childViews.columnAds||(this.destroyChildren(),this.childViews.columnAds=new n.Views.Capital.ColumnAds,this.childViews.columnAds.render()),b?this.childViews.inCardAds&&(this.childViews.inCardAds.destroy(),delete this.childViews.inCardAds):this.childViews.inCardAds||(this.childViews.inCardAds=new n.Views.Capital.InCardAds))}t!==e&&this.childViews.audioRoll&&this.childViews.audioRoll.resize(t),m.trigger("ad:appSize",t),n.trigger("ad:redrawUpdate")},handleInCardAds:function(e){this.childViews.inCardAds&&this.childViews.inCardAds.render()},destroyChild:function(e){this.childViews[e]&&(this.childViews[e].destroy(!1),delete this.childViews[e])},destroyChildren:function(e){this.cleanupChildViews(!1,{remove:!1,exclude:{audioRoll:!0}})},handlePostMessage:function(e){_.isString(e)&&(e=JSON.parse(e)),_.each(e,_.bind(function(e,t){m.trigger("ad:postMessageEvent",e)},this))},reportedAd:function(e){m.trigger("ad:report",e)},handleStopRotation:function(){e.ignoreRotation=!0}},{AppSize:null,AppSizeIsMobile:!1}),n.Views.Capital.ColumnAds=Backbone.View.extend({el:"#capital-column",isSticky:!0,disableBTF:!1,aboveFold:null,belowFold:null,initialize:function(e){return e.model||(this.model=new Backbone.Model),this.model.set("offset",0),this.isSticky&&this.listenTo(n,"scroll",this.handleScroll),this.$container=this.$el.parent(),this.listenTo(this.model,"change:offset",this.handleOffset),this.listenTo(n,"ad:redrawUpdate",_.bind(this.calcOffset,this)),this.listenTo(n,"ad:refreshBtnUnhide",_.bind(this.calcOffset,this)),this.listenTo(n,"page:redrawUpdate",_.bind(this.calcOffset,this)),this.listenTo(n,"app:resize",_.bind(this.calcOffset,this)),this.listenTo(m,"ad:rotate",_.bind(this.render,this)),this.listenTo(m,"ad:pageReady",_.bind(this.handlePageReady,this)),this.listenTo(m,"ad:postMessageEvent",_.bind(this.handlePostMessage,this)),this.listenTo(m,"ad:handleCompanion",_.bind(this.handleCompanion,this)),this.listenTo(m,"ad:report",_.bind(this.handleReport,this)),this.listenTo(m,"ad:pageChange",_.bind(this.calcOffset,this)),n.Views.Capital.ColumnAds.isVisible=!0,$("body").addClass("capital-column-show"),Backbone.View.prototype.initialize.call(this,e)},render:function(e){if(this.destroyed)return;if(_.keys(this.childViews).length)(e||!b||!this.aboveFold.isCompanion)&&this.aboveFold.render(),this.belowFold&&this.belowFold.render();else{var t=v&&v.model.get("companion")||!v;this.aboveFold=new n.Views.Capital.Ad({isCompanion:t,onScreen:!0,addClasses:"capital-first",reportAddClasses:"btn btn-full column-report",belowFold:!1,aboveFold:!0}),this.$el.append(this.aboveFold.$el),this.childViews[this.aboveFold.id]=this.aboveFold,this.aboveFold.render(),this.$el.append($('<a id="capital-standalone-upgrade" class="btn btn-vip" href="/#!/upgrade?utm_source=grooveshark&utm_medium=Stacked300x250CTA&utm_campaign=removeadsCTA" target="_self" data-translate-text="STANDALONE_REMOVE_AD"></a>').text(_.getString("STANDALONE_REMOVE_AD"))),this.aboveFold.isCompanion||this.handleBelowFold()}this.calcOffset()},handleCompanion:function(){var e=v&&v.model.get("companion"),t;if(e){if(e.hide){m.trigger("ad:destroyChild","columnAds");return}t=e.displayBelowFold}this.aboveFold&&(this.aboveFold.isCompanion=this.aboveFold.options.isCompanion=!!e,this.aboveFold.render(),!this.aboveFold.isCompanion||t?this.handleBelowFold():this.belowFold&&(this.belowFold.destroy(),delete this.belowFold))},handleBelowFold:function(){if(this.disableBTF)return;this.belowFold?this.belowFold.render():(this.belowFold=new n.Views.Capital.Ad({onScreen:!0,doScroll:!1,visType:"above",belowFold:!0,reportAddClasses:"btn btn-full column-report",scrollOffset:50}),this.$el.append(this.belowFold.el),this.childViews[this.belowFold.id]=this.belowFold,this.belowFold.render())},handlePageReady:function(){b||(this.aboveFold&&this.aboveFold.render(),this.handleBelowFold()),this.calcOffset()},handlePostMessage:function(e){var t=e&&e.id&&this.childViews[e.id];if(t)switch(e.action){case"updateDimensions":t.$el.css({width:e.width,height:e.height});break;case"adLoaded":t.ui.$frame.data("adInfo",e);break;case"guts":n.trigger("guts:log",e.logName,e.logObj);break;case"forceDefault":n.Models.Ad.defaultAreas({areaIn:e.area});break;case"theme":m.trigger("theme:event",e)}},calcOffset:function(){var e,t;if(this.$el._isSticky||this.$el.hasClass("sticky"))return;e=$("#column1").offset();if(!e)return;t=e.top+(x?65:0),this.model.set("offset",t)},handleOffset:function(){if(this.$el._isSticky||this.$el.hasClass("sticky"))return;this.$el.css({marginTop:this.model.get("offset")})},handleScroll:function(t){if(!this.isSticky||$("body").hasClass("lb-open"))return;t=t||$(document).scrollTop();var n=this.$container.find(".sticky-bar:visible"),r=this.$container.find(".refresh:visible"),i=$("#header:visible"),s=30,o=this.model.get("offset"),u,a;n.length&&(s+=n.outerHeight()),r.length&&(s+=36),i.length&&(s+=i.outerHeight()),o-=s,o>0&&t>=o?(this.$el.css("margin-top",s),this.$el._isSticky||(this.$el._isSticky=!0,this.$el.addClass("sticky").css("margin-top",s)),u=e.outerHeight,!this.disableBTF&&this.aboveFold&&this.belowFold&&t/u>1.5&&(a=this.aboveFold.$el.height(),(a>250||u<850)&&this.aboveFold.$el.addClass("capital-collapse"))):this.$el._isSticky&&(this.$el._isSticky=!1,this.$el.removeClass("sticky").css({marginTop:"auto"}),this.handleOffset(),this.aboveFold&&(this.aboveFold.$el.removeClass("capital-collapse"),this.aboveFold.rendered||this.aboveFold.render()))},handleReport:function(e){var t=this.childViews[e];t&&(t.reportCount++,t.firstReport=$.now(),t.render({force:!0}))},onDestroy:function(){n.Views.Capital.ColumnAds.isVisible=!1,$("body").removeClass("capital-column-show"),this.$el.attr({"class":"",style:""})}},{isVisible:!1}),n.Views.Capital.DockAds=Backbone.View.extend({el:"#capital-dock",events:{"click .capital-ad-close":"handleClose"},opt:{mobile:{width:320,height:50,onScreen:!0},tablet:{width:728,height:90,onScreen:!0}},initialize:function(e){this.$themeEl=$("#theme-container"),this.listenTo(g,"change:appSize",_.bind(this.handleAppSize,this)),this.listenTo(n,"scroll",_.bind(this.handleScroll,this)),this.listenTo(m,"ad:rotate",_.bind(this.render,this)),this.listenTo(m,"ad:report",_.bind(this.handleReport,this)),this.listenTo(m,"ad:pageReady",_.bind(this.handlePageReady,this)),this.listenTo(m,"ad:postMessageEvent",_.bind(this.handlePostMessage,this)),Backbone.View.prototype.initialize.call(this,e)},render:function(){if(this.destroyed)return;if(C(this.$themeEl))return;this.childViews.dockAd||(this.childViews.dockAd=new n.Views.Capital.Ad(this.opt[g.get("appSize")]),this.$el.append(this.childViews.dockAd.el)),this.childViews.dockAd.render()},handleAppSize:function(){this.childViews.dockAd&&(this.childViews.dockAd.destroy(),this.childViews.dockAd=null),this.render()},handlePageReady:function(){this.userClosed&&this.listenTo(m,"ad:rotate",_.bind(this.render,this)),this.userClosed=!1},handleScroll:function(){this.childViews.dockAd||this.render();var e=C(this.$themeEl);$("body").toggleClass("capital-dock-show",!e&&!this.userClosed),this.childViews.dockAd&&(this.childViews.dockAd.onScreen=!e)},handleReport:function(e){var t=this.childViews[e];t&&(t.reportCount++,t.firstReport=$.now(),t.render())},handleClose:function(){this.stopListening(m,"ad:rotate"),$("body").removeClass("capital-dock-show"),this.userClosed=!0},handlePostMessage:function(e){var t=this.childViews.dockAd;if(t)switch(e.action){case"updateDimensions":t.$el.css({width:e.width,height:e.height});break;case"adLoaded":t.ui.$frame.data("adInfo",e);break;case"guts":n.trigger("guts:log",e.logName,e.logObj);break;case"forceDefault":n.Models.Ad.defaultAreas({areaIn:e.area})}},onDestroy:function(){n.Views.Capital.DockAds.isVisible=!1,$("body").removeClass("capital-dock-show"),this.$el.attr({"class":"",style:""})}},{isVisible:!1}),n.Views.Capital.Ad=Backbone.View.extend({userActivity:null,preventRotation:!1,onScreen:!0,detached:!0,ui:{inner:".capital-inner",frame:".capital-frame",framewrap:".capital-frame-wrap",footer:".capital-footer",adreport:".capital-ad-report"},initialize:function(e){return _.extend(this,e),this.id=this.id||N(),this.origWidth=this.options.width||300,this.origHeight=this.options.height||250,this.width=this.origWidth,this.height=this.origHeight,this.dimensions=this.width+"x"+this.height,this.isCompanion=!!this.options.isCompanion&&b,this.options.visType=this.options.visType||"visible",this.options.scrollOffset=this.options.scrollOffset||0,this.onScreen=this.options.onScreen||C(this.$el,{evalType:this.options.visType}),o&&(this.rotation=new n.Views.Capital.Rotation,this.listenTo(this.rotation,"ad:rotate",this.render),this.rotation.init()),this.listenTo(n,"tooltip:open",this.handleTooltip,this),this.listenTo(n,"tooltip:closed",this.handleTooltip,this),this.options.doScroll&&this.listenTo(n,"scroll",this.handleScroll,this),this.$el.data({userActivity:null,id:this.id}).attr({id:this.id}).addClass("capital").addClass(this.options.addClasses||"").toggleClass("in-card",!!this.options.inlist).on("mouseover."+this.cid,_.bind(function(e){this.userActivity=Date.now()+9e4},this)).on("mouseout."+this.cid,_.bind(function(e){this.userActivity=null},this)).height(this.height).width(this.width),Backbone.View.prototype.initialize.call(this,e)},render:function(r){r=r||{};var u=r.force,a=this.$el.find(".capital-frame").length;this.isCompanion=!!this.options.isCompanion&&b,this.onScreen=r.onScreen||this.onScreen,this.options.doScroll&&this.handleScroll();if(this.isCompanion&&(!v||v&&!v.model.id)||!this.onScreen||!this.isCompanion&&a>1)return;this.isCompanion&&v&&v.model.get("companion")&&(this.height=v.model.get("companion").height||this.height,this.$el.height(this.height)),this.$el.toggleClass("companion",!!this.isCompanion);if(!this.ui.$inner){var f="REMOVE_AD";switch(n.Views.Ads.AppSize){case"mobile":case"tablet":f="UPGRADE"}this.$el.append($('<div class="capital-inner"/>').append('<div class="capital-frame-wrap"/>').append($('<div class="capital-footer"/>').toggleClass("hide",!!this.options.hideFooter).append($('<a data-translate-text="SKIP_AD"></a>').addClass("capital-ad-report").addClass(this.options.reportAddClasses||"").data({capitalId:this.id}).text(_.getString("SKIP_AD"))).append('<span class="capital-ad-divider">|</span>').append($('<a data-translate-text="'+f+'"></a>').addClass("capital-ad-upgrade").data({capitalId:this.id}).text(_.getString(f)).attr("href","/#!/upgrade")).append($('<a data-translate-text="CLOSE"></a>').addClass("capital-ad-close").data({capitalId:this.id}).text(_.getString("CLOSE"))))),this.bindUIElements()}if(!u&&this.userActivity&&this.userActivity>Date.now())return;if(!u&&this.preventRotation&&this.$el.find("iframe").length)return;this.source=this.getSource(),this.unit=this.getUnit(),this.adParams=[],this.params=this.getParams("/","/"),this.area=this.getArea(),this.site=this.getSite(),this.size=this.getSize(),this.props={id:this.id,width:this.width,height:this.height,host:encodeURIComponent(e.location.protocol+"//"+e.location.host),companion:this.isCompanion?_.extend({themeID:v.model.id},v.model.get("companion")):null,aimatch:{forceDefault:n.Models.Ad.defaultAreas({areaCheck:this.area}),origWidth:this.origWidth,origHeight:this.origHeight,country:gsConfig.country.ID,pageType:Number(y)+Number(b),site:this.site,area:this.area,btf:!!this.options.belowFold,url:encodeURIComponent("http://crtl.aimatch.com/gshark/lserver/tserver/site="+this.site+"/area="+this.area+"/size="+this.size),params:encodeURIComponent(this.params)}};var l={src:this.source.url+"?options="+encodeURIComponent(JSON.stringify(this.props)),"class":"capital-frame",scrolling:"no",frameborder:0,allowTransparency:!0},c={unitName:this.unit+"_"+this.dimensions,itemID:"unknown",extra:""},h=function(){s||p.off("load."+this.cid).remove(),d.css({visibility:"visible"}),this.isCompanion||o&&this.rotation.reset()},p=this.$el.find(".capital-frame"),d=$("<iframe>").css({visibility:p.length&&!s?"hidden":"visible"});s&&p.off("load."+this.cid).remove(),d.on("load."+this.cid,_.bind(h,this)),d.data("adInfo",c),o&&this.rotation.stop(),d.attr(l),this.ui.$framewrap.append(d),this.cWindow=d[0].contentWindow,!i&&$.now()-i>9e5&&(i=0,t=0,this.$el.removeClass("hide-skip"),this.ui.$adreport.removeClass("btn-inactive").data({inactive:!1}));if(this.isCompanion||t>=3)this.$el.addClass("hide-skip"),this.ui.$adreport.addClass("btn-inactive").data({inactive:!0});this.rendered=!0},handleScroll:function(){if(this.isCompanion)return;C(this.$el,{evalType:this.options.visType,scrollOffset:this.options.scrollOffset})?this.onScreen||this.markOnscreen():this.onScreen&&this.markOffscreen(!0)},markOnscreen:function(){this.onScreen=!0,clearTimeout(this.detachID);if(this.ui.$inner&&!$.contains(document,this.ui.$inner[0])){this.$el.append(this.ui.$inner.removeClass("hide"));return}this.detached&&!this.options.preventOnscreenRender&&(this.render(),this.detached=!1),this.ui.$inner&&this.ui.$inner.removeClass("hide")},markOffscreen:function(e){if(e||!C(this.$el,{evalType:this.options.visType,scrollOffset:this.options.scrollOffset})){this.onScreen=!1;if(!this.ui.$inner)return;this.ui.$inner.addClass("hide"),clearTimeout(this.detachID),this.options.doDetach&&(this.detachID=setTimeout(_.bind(function(){this.ui.$inner.detach(),this.detached=!0},this),2e3))}else this.markOnscreen()},handleTooltip:function(e){var t=$(".tooltip-container"),n=t.length,r;while(n--)if(this.doElsCollide(t[n])){r=!0;break}this.$el.toggleClass("capital-hidden-frame",!!r)},doElsCollide:function(e){var t=this.$el,n=$(e);return t.offsetBottom=t.offset().top+t.height(),t.offsetRight=t.offset().left+t.width(),n.offsetBottom=n.offset().top+n.height(),n.offsetRight=n.offset().left+n.width(),!(t.offsetBottom<n.offset().top||t.offset().top>n.offsetBottom||t.offsetRight<n.offset().left||t.offset().left>n.offsetRight)},getSize:function(){var e=this.width===300&&this.aboveFold?",300x600":"";return this.width+"x"+this.height+e},getSite:function(){return n.Views.Ads.AppSizeIsMobile?"html5":"grooveshark"},getUnit:function(){var e="stingray",t=y?"hp":b?"tl":"ros";return n.Views.Ads.AppSizeIsMobile?"html5":[e,t].join("_")},getArea:function(){var e=this.width==300&&!n.Views.Ads.AppSizeIsMobile?"300":this.width+"x"+this.height,t=_.defined(this.options.belowFold)?this.options.belowFold?"_BTF":"_ATF":"";return this.getUnit()+"_"+e+t},getSource:function(){var t=e.location.host.indexOf("preview")>=0?"http://preview.ads-grooveshark.com/stingray":gsConfig.runMode=="production"?"http://ads-grooveshark.com/stingray":gsConfig.assetHost,n="/aimAds.html",r=this.source&&this.source.isCompanion,i=b&&v&&v.model.get("companion")&&this.$el.hasClass("companion");return this.isCompanion&&v&&v.model.get("companion")&&(n="/themes/"+v.model.get("location")+"/"+(v.model.get("companion").source||"companion.html")),{url:t+(this.options.source||n),isCompanion:i,wasCompanion:r}},getParams:function(e,t){return n.Models.Ad.getParams(this.adParams,e,t,this)},getParamsAsObjects:function(){return n.Models.Ad.getParamsAsObjects()},getParamsAsArrays:function(){return n.Models.Ad.getParamsAsArrays()},onDestroy:function(){o&&this.rotation.stop(),this.stopListening(n,"tooltip:open"),this.stopListening(n,"tooltip:closed"),this.stopListening(n,"scroll")}}),n.Views.Capital.InCardAds=Backbone.View.extend({lastAppSize:null,currentAppSize:null,initialize:function(e){return this.listenTo(m,"ad:postMessageEvent",_.bind(this.handlePostMessage,this)),y?(this.containerName=".feed",this.moduleName=".module-feed-event",this.inCardOpt={width:300,height:250,doScroll:!0,scrollOffset:500},this.insertMethod="insertAfter",this.insertionPattern=function(e){return e&&!(e%5)}):(this.listenTo(m,"ad:rotate",this.render),this.inCardOpt={width:728,height:90,doScroll:!0,scrollOffset:250,onScreen:!0},this.containerName=n.Views.Ads.AppSize==="desktop"?".inner-content":"#column1",this.intervalID=setInterval(_.bind(function(){this.container=document.querySelectorAll(this.containerName),this.container.length&&(clearInterval(this.intervalID),this.handleWindowResize(),this.render(),this.listenTo(m,"ad:appSize",this.handleAppSize),S&&(this.listenTo(n,"app:resize",this.handleWindowResize),this.handleWindowResize()))},this),250)),Backbone.View.prototype.initialize.call(this,e)},handleWindowResize:function(){S&&this.container&&_.each(this.childViews,_.bind(function(e,t){e.onScreen=this.inCardOpt.width<$(this.container[0]).outerWidth(),e.$el.toggleClass("hide",!e.onScreen)},this))},handleAppSize:function(){if(!y){switch(n.Views.Ads.AppSize){case"mobile":case"tablet":case"tabletXL":case"desktop":case"desktopM":this.currentAppSize="desktop";break;case"desktopXL":this.currentAppSize="desktopXL"}if(!n.Views.Ads.AppSize||this.currentAppSize===this.lastAppSize)return;this.cleanupChildViews(),this.containerName=this.currentAppSize==="desktop"?".inner-content":"#column1",this.render(),this.lastAppSize=this.currentAppSize}},render:function(){var e=this,t;if(y)this.cleanupChildViews(),$(this.moduleName,this.containerName).each(function(r,i){e.insertionPattern(r)&&(t=new n.Views.Capital.InCardAd(_.extend(e.inCardOpt,{onScreen:!r})),$(t.el)[e.insertMethod]($(i)),t.render(),e.childViews[t.id]=t)});else{if(!this.container||this.inCardOpt.width>$(this.container[0]).outerWidth())return;_.keys(e.childViews).length||e.childViews.length?(e.handleWindowResize(),_.invoke(e.childViews,"render")):(t=new n.Views.Capital.InCardAd(e.inCardOpt),$(e.containerName).prepend(t.el),e.handleWindowResize(),t.render(),e.childViews[t.id]=t)}this.rendered=!0},handlePostMessage:function(e){var t=e&&e.id&&this.childViews[e.id];if(t)switch(e.action){case"updateDimensions":t.$el.css({width:e.width,height:e.height});break;case"adLoaded":t.ui.$frame.data("adInfo",e);break;case"guts":n.trigger("guts:log",e.logName,e.logObj);break;case"forceDefault":n.Models.Ad.defaultAreas({areaIn:e.area})}},onDestroy:function(){clearInterval(this.intervalID)}},{isVisible:!1}),n.Views.Capital.InCardAd=n.Views.Capital.Ad.extend({initialize:function(e){return this.$el.addClass(y?"module-feed-event":"card"),this._super.call(this,"initialize",e),Backbone.View.prototype.initialize.call(this,e)},render:function(){var e=$.Deferred();return this._super.call(this,"render"),e.resolve}}),n.Views.Capital.AudioRollAds=Backbone.View.extend({className:"capital-audioRoll-wrapper",_completed:!1,ui:{container:"#capital-audioRoll",skipbtn:"#capital-audioRoll-skip",cntdown:"#capital-count-down",countMsg:"#capital-count-msg"},events:{"click @skipbtn":"onSkipClick","click .banner":"onBannerClick"},initialize:function(e){var t=e.model;return t||(t=new n.Models.Capital.AudioRoll),this.model=t,this.listenTo(t,"change:timeLeft",function(e,t){var n=_.toInt(t);this.ui.$cntdown.text(" ("+n+")")}),this.listenTo(t,"playing",function(){this.trigger("playing")}),this.listenTo(t,"error",function(){this._completed=!0,this.trigger("complete")}),this.listenTo(t,"complete",function(){this._completed=!0,this.trigger("complete")}),this.listenTo(t,"skip",function(){this._completed=!0,this.trigger("complete")}),Backbone.View.prototype.initialize.call(this,e)},render:function(){if(this.rendered)return;this.rendered=!0,this.model.getAudioRoll().done(_.bind(function(){if(this.destroyed)return;this.fetchTemplate("/shared/audioRoll").always(_.bind(this.onTemplate,this))},this)).fail(_.bind(function(){this.trigger("error")},this))},onTemplate:function(e){if(this.destroyed)return;this.isLightbox||$("body").addClass("capital-audio"),this.$el.html(this.renderTemplate(e,{image:this.model.get("image"),iframe:this.model.get("iframe")})),this.bindUIElements(),this.trigger("onTemplate"),_.defer(_.bind(this.startAudioroll,this)),this.renderComplete=!0},onDestroy:function(){this.model&&this.model.destroy(),clearTimeout(this.timeoutID),$("body").removeClass("capital-audio"),this._completed||(this.trigger("completed"),this._completed=!0),this.isLightbox&&n.trigger("lightbox:close","audioRoll")},onSkipClick:function(){this.skipRange&&this.model.handleSkip()},onBannerClick:function(){this.model.handleClickThrough()},startAudioroll:function(){var e=this.model.get("audio"),t=e.time*1e3,n=_.toInt(t/1e3);e?(this.model.play(),this.model.on("canSkipNow",_.bind(function(){this.ui.$skipbtn.removeClass("btn-hollow capital-disable-btn"),this.skipRange=!0},this)),this.ui.$cntdown.text(" ("+n+")"),this.ui.$countMsg.removeClass("hide"),this.model.get("skip")&&this.$el.addClass("capital-can-skip")):(this.ui.$skipbtn.find(".label").attr("data-translate-text","CLOSE_AD").text("Close Ad"),this.timeoutID=setTimeout(_.bind(function(){this.ui.$skipbtn.removeClass("btn-hollow capital-disable-btn"),this.skipRange=!0},this),5e3))},resize:function(e){this.isLightbox=e==="mobile"||e==="tablet",this.isLightbox?n.trigger("lightbox:open","audioRoll",{_canClose:!1,audioRoll:this}):($("#player").append(this.el),this.render()),this.renderComplete&&$("body").toggleClass("capital-audio",!this.isLightbox)}},{isVisible:!1})}(),function(){function t(t){switch(t._type){case"video":case"record":case"previewSong":case"editBroadcast":case"broadcastEnded":case"editGenres":return}var n=$("#lightbox-inner"),r=$(".lightbox-content"),i=25,s=$(e).height()-i*2,o=n.height()-r.height(),u=s-o;r.css("max-height",u+"px");if(r.length&&r[0].scrollHeight<u)t._hasScrollbarEnhancedWidth&&($("#lightbox").css("width",""),t._hasScrollbarEnhancedWidth=!1);else if(!t._hasScrollbarEnhancedWidth&&r.length){var a=$("#lb-side-nav"),f=a.length?r.width()+a.outerWidth():r.width();t._hasScrollbarEnhancedWidth=!0}}n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Lightbox=Backbone.View.extend({el:document.getElementById("lightbox-outer"),events:{"click .close":"closeHandler","keydown form input":"enterSubmit"},initialize:function(e){return this.$overlay=$("#lightbox-overlay"),this.$lightbox=$("#lightbox"),this.queue=[],this.currentLightbox=!1,this.isOpen=!1,this.model.set({lightboxOpen:!1}),this.docScrollTop=0,n.on("lightbox:open",this.open,this),n.on("lightbox:close",this.close,this),n.on("lightbox:closeAll",this.closeAll,this),n.on("queue:setSize",this.handleResize,this),$(document).on("keydown.lightbox",_.bind(function(e){e.which==_.keyboard.ESC&&this.isOpen&&this.currentLightbox._canClose&&this.close()},this)),$("#lightbox-overlay, #lightbox-outer, #sidebar").on("click",_.bind(this.clickOverlay,this)),n.on("lightbox:rendered",this.onRendered,this),Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){$(document).off(".lightbox")},handleResize:function(){this.isOpen&&t(this.currentLightbox)},render:function(){this.isOpen?(this.currentLightbox instanceof n.Views.Lightboxes.ViewContainer||n.trigger("tooltip:close"),!this.currentLightbox._hideXToClose&&this.currentLightbox._canClose?$("#lightbox-close",this.$el).removeClass("hide"):$("#lightbox-close",this.$el).addClass("hide"),this.$el.removeClass("player-visible"),this.$overlay.removeClass("player-visible"),this.currentLightbox._showPlayerControls&&(this.$el.addClass("player-visible"),this.$overlay.addClass("player-visible")),this.$overlay.removeClass("hide-lb"),this.$lightbox.attr("class","lightbox-"+this.currentLightbox._type),this.currentLightbox.render(),t(this.currentLightbox)):($("#ocean").removeAttr("style"),$(document).scrollTop(this.docScrollTop),this.$el.addClass("hide-lb"),this.$overlay.addClass("hide-lb"),this.$lightbox.css("width",""),t(this.currentLightbox))},onRendered:function(){this.docScrollTop=$(document).scrollTop(),$("#ocean").css({position:"fixed",top:this.docScrollTop*-1+"px",width:"100%"}),this.$el.removeClass("hide-lb"),this.handleResize()},open:function(t,i){var s=i||{};if(t==="payments"){var o=_.orEqual(s.messageVal,"POPUP_PAYMENT_OPEN_AFTER_LOGIN_2"),u=_.orEqual(s.headerVal,"LOGIN_SUCCESSFUL");s=s||{},n.Services.Local.get("gs.locale")&&(s.lang=n.Services.Local.get("gs.locale"));var a=gsConfig.runMode==="production"?"pay.grooveshark.com/":e.location.host+"/payments/",f=e.open("https://"+a+"?"+$.param(s),"payGS"),l,c=_.bind(function(){clearInterval(l),n.trigger("lightbox:close","paymentsOpen"),n.Services.API.getGSConfig().always(_.bind(function(e){var t=n.getLoggedInUserID(),i=this.model.get("adrollPages"),o=s.action!=="cancel",u,a,f;_.toInt(e.user.UserID)!==t&&(t=e.user.UserID,o=!0,r.model.onSignup(e.user),e.user.FName?n.router.setHash("/settings/subscription",{force:!0}):n.router.setHash("/onboarding/user/info")),f=n.Models.AuthUser.getCached(t),u=f.get("subscription").getEndDate(),f.gotNewSubscription(!o,!0).done(function(e){a=e.getEndDate();if(_.indexOf(i,"conversion")!==-1||!a)return;(!u||u<a)&&i.push("conversion")}).fail(function(){n.trigger("notification:add",{description:_.getString("REFRESH_SUB_ERROR_UNKNOWN"),type:"error"})})},this))},this);n.trigger("lightbox:open",{_type:"paymentsOpen",_canClose:!1,view:{header:u,message:o,buttonsLeft:[{label:"CANCEL",className:"cancel"}],buttonsRight:[{label:"OPEN_BILLING_WINDOW",className:"open-billing btn-success"}]},callbacks:{".cancel":function(){f&&f.close(),c()},".open-billing":function(){n.trigger("lightbox:open","payments",s)}}}),l=setInterval(function(){f&&f.closed&&c()},1e3),n.trigger("guts:log","lightboxOpened",{type:t});return}if(t==="login"){n.router.setHash("login",i);return}if(e.gsProduction&&e.gsProduction.LB_CSSURI){var h=_.isUndefined(e.dataURISupport)||dataURISupport?gsProduction.LB_CSSURI:gsProduction.LB_CSS;h&&h.assetPath&&$.getStylesheet(h.assetPath)}typeof t=="object"&&(s=t,t="generic"),s=_.orEqual(s,{});var p=t=="generic"?s._type:t;if(this.isOpen&&this.currentLightbox&&p===this.currentLightbox._type)return;var d=_.bind(function(){var e=n.Views.Lightboxes[v],t=n.getAppMode()==="mobile";if(!e){console.log("invalid lb type (in bind)",v);return}var i=new e({model:new Backbone.Model({appModel:this.model,gsApp:r}),params:s});i._type=p,_.defer(function(){n.trigger("guts:log","lightboxOpened",{type:p})});for(var o=0;o<this.queue.length;o++)if(p===this.queue[o]._type){this.queue[o].destroy(),this.queue[o]=i;return}if(this.isOpen&&this.currentLightbox){if(i._priority<this.currentLightbox._priority){var u=_.sortedIndex(this.queue,i,function(e){return e._priority});this.queue.splice(u,0,i);return}this.currentLightbox.suspend(),this.queue.push(this.currentLightbox)}this.currentLightbox=i,this.isOpen=!0,t&&!_.contains(location.hash,"?lb")&&!_.contains(location.hash,"&lb")&&n.router.setHash(location.hash+(_.contains(location.hash,"?")?"&lb":"?lb")),this.model.set({lightboxOpen:!0}),$("body").addClass("lb-open"),this.render(),n.trigger("lightbox:ready",this,this.currentLightbox)},this),v=t.substr(0,1).toUpperCase()+t.substr(1),m=n.Views.Lightboxes[v];if(!m){var g=["share","suggestTags","feedback","invite","paywall","audioRoll"],y="gs/views/lightboxes/"+t+".js";_.contains(g,t)&&(y=t+"Lightbox"),amdModules.requireDeferred(y).done(d).fail(function(){console.log("invalid lb type",t,arguments,y)});return}d()},close:function(e){var t=e&&_.isString(e)?e:!1,r=e&&_.isInstance(e,n.Views.Lightboxes.Base)?e:!1,i=n.getAppMode()==="mobile";if(t||r){var s=[],o=0,u=this.queue.length,a;for(;o<u;o++)a=this.queue[o],a===r||a._type===t?a.beforeClose()&&a.destroy():s.push(a);this.queue=s}if(!this.currentLightbox||(t||r)&&this.currentLightbox!==r&&this.currentLightbox._type!==t)return;if(!this.currentLightbox.beforeClose())return;this.currentLightbox.destroy(),n.trigger("lightbox:destroyed",this,this.currentLightbox),this.queue.length?(this.currentLightbox=this.queue.pop(),this.currentLightbox.resume()):(this.isOpen=!1,this.model.set({lightboxOpen:!1}),this.currentLightbox=!1,$("body").removeClass("lb-open"),i&&n.router.setHash(location.hash.replace(/[?&]lb/,"")),n.trigger("lightbox:closed")),this.render()},closeAll:function(){if(this.currentLightbox){if(!this.currentLightbox.beforeClose())return;this.currentLightbox.destroy(),n.trigger("lightbox:destroyed",this,this.currentLightbox)}_.forEach(this.queue,_.bind(function(e){if(!e.beforeClose())return!1;e.destroy(),this.queue.pop()},this)),this.queue.length?(this.currentLightbox=this.queue.pop(),this.currentLightbox.resume()):(this.isOpen=!1,this.model.set({lightboxOpen:!1}),this.currentLightbox=!1,n.trigger("lightbox:closed")),this.render()},closeHandler:function(){this.close()},clickOverlay:function(e){var t=$(e.target),n=this.currentLightbox&&this.currentLightbox._canClose;t.is("#lightbox-overlay, #lightbox-outer, #sidebar-overlay")&&n&&this.close()},enterSubmit:function(e){if(e.keyCode==13){var t=$(e.currentTarget),n=t.parents("form");if(!t.hasClass("no-submit"))return n.submit(),!1}}},{trackLightboxView:function(e){var t="/lb/"+e;return _.gaTrackPageView(encodeURI(t))}}),n.Views.Lightboxes.Base=Backbone.View.extend({templatePath:"lightbox",tagName:"div",className:"lbcontainer",_priority:0,_canClose:!0,_showPlayerControls:!1,initialize:function(e){return this.options.params=this.options.params||{},_.defined(this.options.params._priority)&&(this._priority=this.options.params._priority),_.defined(this.options.params._canClose)&&(this._canClose=this.options.params._canClose),_.defined(this.options.params._showPlayerControls)&&(this._showPlayerControls=this.options.params.showPlayerControls),this.$parent=$("#lightbox-inner"),this.viewReported=!1,this.suspended=!1,Backbone.View.prototype.initialize.call(this,e)},handleResize:function(){t(this)},render:function(){if(this.suspended||this.destroyed)return;this.viewReported||(this.viewReported=n.Views.Lightbox.trackLightboxView(this._type)),$.contains(this.$parent[0],this.$el[0])||this.$parent.append(this.$el)},onTemplate:function(){this._canClose&&$("#lightbox-close",this.$el).removeClass("hide"),this.handleResize(),$(".lightbox-content :input:visible:first").focus()},suspend:function(){this.suspended=!0,this.$el.hide()},resume:function(){this.suspended=!1,this.$el.show()},beforeClose:function(){return!0},close:function(){n.trigger("lightbox:close",this)}})}(),define("gs/views/desktopNavBar.js",function(){n.Views=n.Views||{},n.Views.DesktopNavBar=Backbone.View.extend({templateFile:"desktopNavBar",ui:{url:".url",forwardBtn:".forward",backBtn:".back"},events:{"click @forwardBtn":"clickForwardBtn","click @backBtn":"clickBackBtn","click @url":"clickURL"},onDestroy:function(){$("body").removeClass("show-desktop-bar")},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.listenTo(n,"router:change",this.renderNavBtns),this.listenTo(n,"router:change",this.renderURL),this.renderNavBtns(),this.renderURL(),n.External.DesktopBridge.active&&$("body").addClass("show-desktop-bar")},renderNavBtns:function(){this.ui.$backBtn.attr("disabled",!n.router.hasBack),this.ui.$forwardBtn.attr("disabled",!n.router.hasForward)},renderURL:function(){var t=e.location.toString();this.ui.$url.val(t)},clickForwardBtn:function(e){n.router.forward(),e.preventDefault()},clickBackBtn:function(e){n.router.back(),e.preventDefault()},clickURL:function(){this.ui.$url.select()}})}),function(){n.Views=n.Views||{},n.Views.Notifications=n.Views.Notifications||{};var t=1,r=Backbone.Model.extend({defaults:{notifID:0,name:"generic",type:"",duration:6500,slots:[1],timeout:!1,listenersSet:!1,timestamp:null,priority:5,template:"generic",title:"",description:"",image:"",url:"",className:"",target:"_self",options:null,data:{}}});n.Views.Notification=Backbone.View.extend({el:document.getElementById("notifications"),events:{mouseover:"stopTimers",mouseout:"startTimers"},initialize:function(e){return this.notifications=[],this.notifsQueue=[],this.maxOpenNotifs=3,this.pauseNotifications=!1,n.on("notification:add",this.addNotification,this),n.on("notification:close",this.closeNotification,this),Backbone.View.prototype.initialize.call(this,e)},addNotification:function(e){var t=new n.Views.Notifications.Base({model:new r(e)});this.notifsQueue.push(t),this.notifsQueue.sort(function(e,t){return t.model.get("priority")-e.model.get("priority")}),this.renderNotification(),n.trigger("notification:opened",t)},renderNotification:_.throttle(function(){if(this.notifications.length>=this.maxOpenNotifs||this.pauseNotifications){setTimeout(_.bind(this.renderNotification,this),1e3);return}var e=this.notifsQueue.shift();if(!e)return;e.on("notification:rendered",function(){this.$el.prepend(e.$el),e.$el.height(e.$el.height()).removeClass("closed"),this.startTimers([e])},this),e.render(),this.notifications.push(e),this.notifsQueue.length&&this.renderNotification()},2e3),startTimers:function(e){this.pauseNotifications=!1;var t=e&&e.length?e:this.notifications;for(var n=0;n<t.length;n++)t[n].model.get("duration")&&(t[n].timeout||(t[n].timeout=setTimeout(_.bind(this.closeNotification,this,t[n]),t[n].model.get("duration"))))},stopTimers:function(e){e.length||(this.pauseNotifications=!0);var t=e.length?e:this.notifications;for(var n=0;n<t.length;n++)clearTimeout(t[n].timeout),t[n].timeout=null},closeNotification:function(e){if(!e.closing){e.closing=!0;var t=null,n=this,r=_.once(function(){clearTimeout(t);var r=_.indexOf(n.notifications,e);n.notifications.splice(r,1),e.destroy(),n.startTimers(),n.renderNotification(),e.closing=!1});e.$el.addClass("closing"),t=setTimeout(r,1e3)}}},{success:function(e,t){n.trigger("notification:add",_.defaults({description:e,type:"success"},t))},error:function(e,t){n.trigger("notification:add",_.defaults({description:e,type:"error"},t))}}),n.Views.Notifications.Base=Backbone.View.extend({templatePath:"notifications",tagName:"div",className:"popup-notif closed",events:{"click .close":"close","click .action":"onHandleClick"},initialize:function(){var t=this.generateNotificationID();this.model.set("notifID",t),this.model.set("timestamp",new Date),this.$el.attr("id","notif-"+t),this.$el.data("view",this),this.$el.data(this.model.get("data")),this.model.get("className")&&this.$el.addClass(this.model.get("className")),this.model.get("click")&&this.$el.on("click",_.bind(function(e){this.model.get("url")||e.preventDefault(),this.model.get("click")(this),this.close()},this));if(this.model.get("activeDuration")){var n=this.model.get("rate")||1e3,r=this.model.get("activeDuration"),i=!0;$(e).focus(function(){i=!0}).blur(function(){i=!1}),this.timer=setInterval(_.bind(function(){i&&(r--,r<=0&&this.close())},this),n)}var s=this.model.get("initFunc");return _.isFunction(s)&&s(this),Backbone.View.prototype.initialize.call(this)},onDestroy:function(){this.model.get("closeAction")&&this.model.get("closeAction")(),this.timer&&clearInterval(this.timer)},render:function(){var e=this.model.get("template")?this.model.get("template"):this.model.get("name");this.fetchTemplate(e).done(_.bind(this.openNotification,this))},openNotification:function(e){this.$el.append(this.renderTemplate(e)),this.$(".title, .description").find("a").addClass("link"),this.trigger("notification:rendered",this);var t=this.model.get("onOpened");t&&t(this)},generateNotificationID:function(){return t++},onHandleClick:function(e){this.model.get("clickAction")?this.model.get("clickAction")(this,e):this.close()},close:function(e){e&&(e.preventDefault(),e.stopPropagation()),n.trigger("notification:close",this)}})}(),function(){function e(e){var t;if(e.get("isLoggedIn"))t=function(e){return e.attributes.isFavorite};else{var n=e.get("favoriteSongs");t=function(e){return n.get(e.id)}}return t}function t(e,t,n){var r={};if(!_.isArray(t))r[t]=1;else for(var i=0,s=t.length;i<s;i++)r[t[i]]=1;if(e.get("isLoggedIn"))return function(e){return r.hasOwnProperty(e.attributes.ArtistID)&&(!n||e.attributes.isFavorite)};var o=e.get("favoriteSongs");return function(e){return r.hasOwnProperty(e.attributes.ArtistID)&&(!n||o.get(e.id))}}n.Views=n.Views||{},n.Views.Collection=Backbone.View.extend({initialize:function(e){Backbone.View.prototype.initialize.call(this,e),this.rendered=!1,this.user=e.user,this.appModel=e.appModel,e.defaultFavorites&&(this.filterFavorites=!0)},onDestroy:function(){this.artistsFilterGrid&&this.artistsFilterGrid.selectedItems.off(null,null,this)},render:function(){if(this.rendered)return;this.rendered=!0;var e=new ChainLoading;this.filterFavorites&&e.push(this.user.getFavoritesByType("Songs")),e.push(this.user.getLibrary().done(e.bind(this.renderCollection,this))),e.done(_.bind(this.addArtistsFilterGrid,this,this.options.artistsFilterGrid))},renderCollection:function(t){if(!t||this.destroyed)return;this.currentFilter=this.filterFavorites?e(this.user):null;var r=t.models,i=this.appModel.get("appSize")==="mobile",s=new n.Models.Collections.Songs(this.currentFilter?_.filter(r,this.currentFilter):r);s.comparator=_.getModelSort("TSAdded"),s.sort(),t.off(null,null,this),this.listenTo(t,"add",function(e){this.currentFilter?this.currentFilter(e)&&s.add(e):s.add(e),this.updateArtistsFilterList(),e.set("removedFrom",!1)}),this.listenTo(t,"remove",function(e){e.set("removedFrom",!0)}),this.childViews.collectionGridView&&(this.childViews.collectionGridView.off(null,null,this),this.childViews.collectionGridView.destroy());var o=new n.Models.PlayContext(this.user);this.user.get("isLoggedIn")?o.addStreamType(n.Models.PlayContext.TYPE_LIBRARY):o.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),this.childViews.collectionGridView=new n.Views.SongGridTall($.extend({collection:s,playContext:o,scrollElement:this.options.scrollElement,header:!1,dropIndicatorType:"",handleDropInit:_.bind(function(e,t){if(!this.user.get("isLoggedIn"))return!1},this),dropIsValid:_.bind(function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);if(t.draggedItems.length>1&&this.filterFavorites)return!1;switch(t.draggedItemsType){case"song":case"album":case"artist":case"playlist":return!0}return!1},this),acceptDrop:_.bind(function(e){if(this.destroyed||!this.childViews.collectionGridView)return;this.filterFavorites?this.acceptDropToFavorites(e):this.acceptDropToCollection(e)},this),onDelete:_.bind(function(e){if(this.destroyed||!this.childViews.collectionGridView)return;this.user.id===n.getLoggedInUserID()&&this.user.removeSongsFromLibrary(e)},this),showCount:!1},this.options.gridOptions)),this.childViews.collectionGridView.$el.addClass("content-grid"),this.$el.append(this.childViews.collectionGridView.$el),this.childViews.collectionGridView.on("resized",function(){n.trigger("page:redrawUpdate")},this);if(i){this.childViews.collectionGridView.render(),this.updateArtistsFilterList();return}this.childViews.collectionGridToolbarView&&this.childViews.collectionGridToolbarView.destroy();var u={model:this.model,gridView:this.childViews.collectionGridView,playContext:o},a=this;this.filterFavorites?u.page="userMusicFavorites":u.page="userMusic",u.buttons=["play","sort","filterSearch"],this.user.id===n.getLoggedInUserID()&&u.buttons.push("upload","delete"),this.options.showFavoritesSwitcher&&(u.buttons.push("btnGroupNav"),u.btnGroupNavInfo={pages:["userMusic","userMusicFavorites"],icons:["icon-musicnote","icon-heart"],labels:["COLLECTION","FAVORITES"],classNames:["all-music","favorites"]}),u.onButtonClick=function(e){var t=$(e.currentTarget),r=t.siblings(".active");if(t.hasClass("upload")){amdModules.requireDeferred("gs/views/lightboxes/upload.js").done(function(){n.trigger("lightbox:open","upload")});return}if(r[0]===t[0]||!t.hasClass("btn-nav-switch"))return;t.hasClass("favorites")?n.router.setHash(a.user.toUrl("collection/favorites")):t.hasClass("all-music")&&n.router.setHash(a.user.toUrl("collection"))},this.childViews.collectionGridToolbarView=new n.Views.GridToolbar(u),this.childViews.collectionGridToolbarView.$el.addClass("grid-toolbar-container"),this.$el.prepend(this.childViews.collectionGridToolbarView.$el),this.childViews.collectionGridToolbarView.render(),this.childViews.collectionGridView.render(),this.updateArtistsFilterList()},acceptDropToCollection:function(e){function s(e){r=r.concat(e.toArray())}if(this.destroyed||!this.user)return;var t,n,r=[],i=[];switch(e.draggedItemsType){case"song":return this.user.addSongsToLibrary(e.draggedItems),!0;case"album":case"artist":case"playlist":for(t=0;t<e.draggedItems.length;t++)n=e.draggedItems[t],_.isFunction(n.getSongs)&&i.push(n.getSongs().done(s))}return i.length>0&&$.after(i).always(_.bind(function(){r.length&&this.user.addSongsToLibrary(r)},this)),!0},acceptDropToFavorites:function(e){function s(e){r=r.concat(e.toArray())}if(this.destroyed||!this.user)return;var t,n,r=[],i=[];switch(e.draggedItemsType){case"song":return e.draggedItems.length>1||this.user.favorite("Songs",e.draggedItems[0]),!0;case"album":case"artist":case"playlist":for(t=0;t<e.draggedItems.length;t++)n=e.draggedItems[t],_.isFunction(n.getSongs)&&i.push(n.getSongs().done(s))}return i.length>0&&$.after(i).always(_.bind(function(){r.length},this)),!0},resize:function(){this.childViews.collectionGridView&&(this.childViews.collectionGridView.resize(),this.childViews.collectionGridView.resizeColumns())},showFavorites:function(){this.filterFavorites=!0;if(this.childViews.collectionGridView){var t=this.user.get("library"),n=$.Deferred();return this.user.getFavoritesByType("Songs").done(_.bind(function(){var r=this.childViews.collectionGridToolbarView;this.currentFilter=e(this.user),this.childViews.collectionGridView.collection.reset(_.filter(t.models,this.currentFilter)),this.updateArtistsFilterList(),r&&(r.onFilterChange(),r.setPageNavActive("userMusicFavorites")),n.resolve()},this)),n.promise()}return this.user.getLibrary().done(_.bind(this.renderCollection,this))},showAll:function(){var e,t,n;return this.filterFavorites=!1,this.childViews.collectionGridView?(n=this.childViews.collectionGridToolbarView,e=this.user.get("library"),t=$.Deferred().resolve(),this.currentFilter===null?t.promise():(this.currentFilter=null,this.childViews.collectionGridView.collection.reset(e.models),this.updateArtistsFilterList(),n&&(n.onFilterChange(),n.setPageNavActive("userMusic")),t.promise())):this.user.getLibrary().done(_.bind(this.renderCollection,this))},showAllByArtists:function(e,n){if(!e||e.length===0)return this.showAll();this.filterFavorites=!1;if(this.childViews.collectionGridView){var r=this.user.get("library");this.currentFilter=t(this.user,e,this.filterFavorites),this.childViews.collectionGridView.collection.reset(_.filter(r.models,this.currentFilter)),n&&this.updateArtistsFilterList()}else this.user.getLibrary().done(_.bind(this.renderCollection,this))},showFavoritesByArtists:function(e,n){if(!e||e.length===0)return this.showFavorites();this.filterFavorites=!0;if(this.childViews.collectionGridView){var r=this.user.get("library");this.user.getFavoritesByType("Songs").done(_.bind(function(){this.currentFilter=t(this.user,e,this.filterFavorites),this.childViews.collectionGridView.collection.reset(_.filter(r.models,this.currentFilter)),n&&this.updateArtistsFilterList()},this))}else this.user.getLibrary().done(_.bind(this.renderCollection,this))},addArtistsFilterGrid:function(e){if(this.destroyed||!e)return;this.artistsFilterGrid&&this.artistsFilterGrid.selectedItems.off(null,null,this),this.artistsFilterGrid=e,this.artistsFilterGrid.selectedItems.on("add remove reset",this.filterCollectionForArtists,this),this.updateArtistsFilterList()},removeArtistsFilterGrid:function(){if(this.destroyed)return;this.artistsFilterGrid&&(this.artistsFilterGrid.selectedItems.off(null,null,this),this.artistsFilterGrid=null)},updateArtistsFilterList:function(){if(!this.artistsFilterGrid||!this.childViews.collectionGridView)return;this.artistsFilterGrid.selectedItems.reset([],{skipArtistsFilter:!0});var e={},t=[],r;this.childViews.collectionGridView.collection.each(function(i){r=i.attributes.ArtistID;if(e[r]){e[r]++;return}t.push(n.Models.Artist.newOrUpdate(i.getArtists(r))),e[r]=1}),this.artistsFilterGrid.collection.reset(t)},filterCollectionForArtists:_.debounce(function(){if(this.destroyed||!this.artistsFilterGrid)return;var e=this.artistsFilterGrid.selectedItems,t=arguments[arguments.length-1];if(t&&t.skipArtistsFilter)return;this.filterFavorites?this.showFavoritesByArtists(e.pluck("ArtistID")):this.showAllByArtists(e.pluck("ArtistID"))},100)})}(),function(){n.Views=n.Views||{};var e=Backbone.View.extend({events:{dropinit:"onDropInit",dropstart:"onDropStart",drop:"onDrop",dropend:"onDropEnd"},onDropInit:function(e,t){e.currentTarget.updateDropOnDrag=_.bind(this.onDropOver,this)},onDropStart:function(e,t){if(!t.draggedItems||t.draggedItems.length===0)return!1;this.isActiveDropTarget=!0},onDrop:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var r=this.dropIsValid(t);if(!r||t.dropHandled)return;t.dropHandled=n.Models.Playlist.acceptDrop(this.options.playlist,t)},onDropEnd:function(){this.resetDrop(),this.isActiveDropTarget=!1},onDropOver:function(e,t){var n=this.dropIsValid(t);if(!this.isActiveDropTarget)return;this.$el.addClass("drop-pending"),this.$el.data("valid-drop",n)},resetDrop:function(){this.$el.removeClass("drop-pending")},dropIsValid:function(e){e.draggedItemsType=e.draggedItemsType||_.getCollectionType(e.draggedItems);switch(e.draggedItemsType){case"song":case"album":case"artist":case"playlist":return!0;default:return!1}}});n.Views.Playlist=Backbone.View.extend({events:{"click .undo":"onUndoClick"},initialize:function(e){return this.rendered=!1,this.playlist=e.playlist,Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){var e=this.playlist.get("songs");e&&e.off(null,null,this),this.playlist.off(null,null,this)},render:function(){var e=$.Deferred();return this.rendered?e.resolve().promise():(this.rendered=!0,this.playlist.getSongs().done(_.bind(function(t){this.renderSongs(t).done(_.bind(e.resolve,e)).fail(_.bind(e.reject,e))},this)).fail(function(){n.trigger("notification:add",{title:_.getString("LOAD_PLAYLIST_FAILED"),type:"error"})}),e.promise())},addGridUpdateHandles:function(){var e=this.playlist.get("songs");if(!e)return;e.off(null,null,this),e.on("add",function(e){!this.destroyed&&this.childViews.songsGridView&&!this.childViews.songsGridView.destroyed&&(this.childViews.songsGridView.collection.add(e),this.playlistSongsChange())},this),e.on("remove",function(e){!this.destroyed&&this.childViews.songsGridView&&!this.childViews.songsGridView.destroyed&&(this.childViews.songsGridView.collection.remove(e),this.playlistSongsChange())},this),e.once("reset",function(e){!this.destroyed&&this.childViews.songsGridView&&!this.childViews.songsGridView.destroyed&&(this.childViews.songsGridView.collection.reset(e.models),this.playlistSongsChange(),this.addGridUpdateHandles())},this)},playlistSongsChange:function(){var e=this.playlist.get("changeLog");e&&e.length?(this.$(".undo-num").text(e.length),this.$(".undo").removeClass("hide")):this.$(".undo").addClass("hide")},renderSongs:function(t){var r=$.Deferred(),i=this.playlist.get("UserID"),s=n.Models.User.getCached(i),o=new n.Models.PlayContext(this.playlist),u=$("#empty-container"),a=this.playlist.isEditable(),f;if(!t||this.destroyed)return r.reject().promise();this.childViews.songsGridView&&(this.childViews.songsGridView.off(null,null,this),this.childViews.songsGridView.destroy(!1)),this.childViews.emptyPlaylist&&(this.childViews.emptyPlaylist.off(null,null,this),this.childViews.emptyPlaylist.destroy(!1)),a||u.toggleClass("hide",!!t.length).siblings().toggleClass("hide",!t.length);if(!t.length)return f={user:s,titleLocale:a?"ADD_SONGS_TO_YOUR_PLAYLIST":"EMPTY_PLAYLIST",descLocale:a?"EMPTY_PLAYLIST_DESC_OWNER":"EMPTY_PLAYLIST_DESC",emptyClass:"playlists card",actions:!1,search:a?!0:!1},this.playlist.once("songsAddedToPlaylist",_.bind(function(){this.rendered=!1,this.render()},this)),u.is("div")||(u=$(document.createElement("div")),u.attr("id","empty-container").appendTo($("#profile-subpage"))),this.renderEmpty(f,u),a&&(this.childViews.emptyPlaylist=new e({el:u,playlist:this.playlist})),r.resolve().promise();this.childViews.songsGridView=new n.Views.SongGridTall($.extend({collection:t,playlist:this.playlist,playContext:o,header:!1,scrollElement:this.options.scrollElement,handleDropInit:_.bind(function(e,t){var n=this.playlist.isEditable();if(!n)return!1},this),dropIsValid:_.bind(function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);switch(t.draggedItemsType){case"song":case"album":case"artist":case"playlist":return!0}return!1},this),acceptDrop:_.bind(function(e){if(this.destroyed||!this.childViews.songsGridView)return;var t=e.draggedItemsSource===this.childViews.songsGridView.cid;return n.Models.Playlist.acceptDrop(this.playlist,e,this.childViews.songsGridView.lastDropIndex,t)},this),onDelete:_.bind(function(e){var t=this.playlist;if(t.isEditable()){var n=[];_.forEach(e,function(e){var r=t.get("songs").indexOf(e);r!=-1&&n.push(r)}),n.length&&t.removeSongs(n)}},this)},this.options.gridOptions)),this.addGridUpdateHandles(),this.childViews.songsGridView.$el.addClass("content-grid"),this.$el.append(this.childViews.songsGridView.$el),this.childViews.songsGridView.on("resized",function(){n.trigger("page:redrawUpdate")},this),this.childViews.songsGridView.on("rendered",function(){r.resolve()},this),this.playlist.on("songsRemovedFromPlaylist",_.bind(function(){var e=this.playlist.get("songs");if(!e||!e.length)this.playlist.off("songsRemovedFromPlaylist"),this.rendered=!1,this.render()},this)),this.childViews.gridToolbarView&&this.childViews.gridToolbarView.destroy();var l={model:this.model,gridView:this.childViews.songsGridView,page:"playlist",playContext:o,gridSourceModel:this.playlist};return this.playlist.isEditable()?l.buttons=["play","undo","add","delete","sort","filterSearch"]:l.buttons=["play","add","sort","filterSearch"],this.childViews.gridToolbarView=new n.Views.GridToolbar(l),this.childViews.gridToolbarView.$el.addClass("grid-toolbar-container"),this.$el.prepend(this.childViews.gridToolbarView.$el),this.childViews.gridToolbarView.render(),this.playlistSongsChange(),this.childViews.songsGridView.render(),r.promise()},resize:function(){this.childViews.songsGridView&&(this.childViews.songsGridView.resize(),this.childViews.songsGridView.resizeColumns())},renderEmpty:function(e,t){e=_.defaults(e,{search:!1,searchLocale:"SEARCH_FOR_MUSIC_ELLIPSIS",searchType:""}),this.fetchTemplate("/shared/empty").always(_.bind(function(n){t.html(this.renderTemplate(n,e))},this))},onUndoClick:function(e){var t=this.playlist.get("songs");this.playlist.undo().done(_.bind(function(){t.length||this.renderSongs(t)},this))}})}(),function(){n.Views=n.Views||{};var e;n.Views.RecentListens=Backbone.View.extend({templatePath:"user",initialize:function(t){return this.rendered=!1,e=t.appModel,this.user=t.user,Backbone.View.prototype.initialize.call(this,t)},onDestroy:function(){this.recentListens&&this.recentListens.off(null,null,this)},render:function(){if(this.rendered)return;this.rendered=!0;var e=new ChainLoading;e.push(this.user.getRecentListens().done(e.bind(function(e){this.recentListens=e},this))),e.push(this.fetchTemplate("listens").done(e.bind(this.onTemplate,this)))},cleanup:function(){for(var e in this.childViews)this.childViews.hasOwnProperty(e)&&(this.childViews[e].$el.off(),this.childViews[e].off(),this.childViews[e].destroy(),delete this.childViews[e])},onTemplate:function(e){if(this.destroyed)return;var t=this.user.get("listens"),n=_.getTimeBasedGroups(),r=[],i={},s={},o=0,u=t.length,a=!0,f=null,l;for(;o<u&&n.length;o++){l=t[o];while(l.listenTime<n[0].time)n.shift(),a=!0;a?(r.push(n[0]),f=n[0],i[f.gridClass]=[l],s[f.gridClass]=[]):i[f.gridClass].push(l),s[f.gridClass][l.SongID]?s[f.gridClass][l.SongID].push(l.listenDataKey):s[f.gridClass][l.SongID]=[l.listenDataKey],a=!1}this.cleanup(),this.$el.html(this.renderTemplate(e,{groups:r})),this.renderRecentListens(t,i,s)},renderRecentListens:function(t,r,i){if(this.destroyed)return;var s=[],o=[],u=e.get("appSize")==="mobile",a,f,l,c,h,p,d,v,m,g,y,b,w,E;_.each(r,_.bind(function(e,r){e=new n.Models.Collections.Songs(e),m=_.bind(function(e,r,s){if(!this.user.get("isLoggedIn"))return;g=[],y={},b=[],_.each(e,function(e){l=e.get("SongID"),g=g.concat(i[s.options.groupClass][l]),b.push(l)}),n.Services.API.deleteUserListens(g).done(function(){n.trigger("notification:add",{icon:"check",type:"success",duration:3e3,description:_.getString("POPUP_LISTEN_DELETE_TITLE")}),s.collection.remove(e);for(a=0,f=g.length;a<f;a++)y[g[a]]=1;for(a=0;a<t.length;a++)y[t[a].listenDataKey]&&t.splice(a--,1);n.trigger("guts:log","removeSongsFromListens",{removedSongs:b.toString()}),_.gaTrackEvent("user","removeSongsFromListens",b)}).fail(function(){n.trigger("notification:add",{icon:"x",description:_.getString("POPUP_LISTEN_DELETE_FAIL")})})},this),c=new n.Models.PlayContext,c.addDefaultType(),h=this.$el.find("."+r),p=new n.Views.SongGridTall({el:h[0],collection:e,header:!1,forRecentListens:!0,canDelete:this.user.get("isLoggedIn"),onDelete:m,playContext:c,scrollElement:this.options.scrollElement,groupClass:r,showCount:!u}),this.user.get("isLoggedIn")&&(d=function(e,t){e=e.models?e.models:e,m(e,null,t)},p.contextMenuExtra={deleteListens:d}),p.on("resized",function(){n.trigger("page:redrawUpdate")},this),this.childViews.push(p),s.push(p),p.render()},this)),w=this.$el.find(".grid-toolbar-container"),this.user.get("isLoggedIn")?o=["play","delete","filterSearch","extraOptions"]:o=["play","filterSearch"],E=new n.Views.GridToolbar({el:w[0],gridView:s,page:"userListens",buttons:o,onButtonClick:function(e){e.preventDefault();var t=$(e.currentTarget);if(!t.hasClass("extra-options"))return;if(t.hasClass("menu-open")){n.trigger("tooltip:close");return}var r={tooltipKey:"sort-toolbar-menu",width:130,tooltipClass:"sort-toolbar-menu",pageType:"toolbar",page:"userListens"};_.asyncTooltipMenu(t,r,[],"getContextMenuForRecentPlaysOptions")}}),E.on("filterChanged",function(e){_.each(s,function(t){t instanceof n.Views.Grid&&(t.filter(e),t.$el.parent()[(t.visibleCollection.length?"remove":"add")+"Class"]("hide"))})}),this.childViews.push(E),E.render()}})}(),function(){n.Views=n.Views||{},n.Views.ListenAgain=Backbone.View.extend({className:"card listen-again song-list hide",templateFile:"listenAgain",ui:{grid:".grid"},initialize:function(e){return this.user=e.user,this.renderDfd=$.Deferred(),this.model=new Backbone.Model({recentListens:new n.Models.Collections.Songs}),Backbone.View.prototype.initialize.call(this,e)},render:function(){var e=new ChainLoading;return e.push(this.user.getPersonalizedSongs()).done(e.bind(this.updateRecentListens,this)),e.push(this.fetchTemplate(this.templateFile)).done(e.bind(this.onTemplate,this)),this.renderDfd.promise()},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{user:this.user})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model.get("recentListens"),"reset",this.renderRecentListens),this.renderRecentListens(),this.renderDfd.resolve()},renderRecentListens:function(){var e=this.model.get("recentListens");if(!e.length){this.$el.addClass("hide");return}this.$el.removeClass("hide");if(this.childViews.grid&&!this.childViews.grid.destroyed)return;this.childViews.grid=new n.Views.SongGridTall({el:this.ui.$grid,collection:e,header:!1,showCount:!1}),this.childViews.grid.render()},updateRecentListens:function(e){var t=this.model.get("recentListens");e?t.reset(e.take(5)):t.reset([])}})}(),define("gs/views/slider.js",function(){n.Views=n.Views||{},n.Views.Slider=Backbone.View.extend({events:{"click .slide-nav-item":"onSlideNavClick"},initialize:function(e){return this.heightRatio=3/8,n.on("app:resize",_.bind(this.onWindowResize,this)),this.onWindowResize(),this.model.set({slides:e.slides,startIndex:e.startIndex||0,slideDuration:e.slideDuration||1e4}),Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){clearInterval(this.slideInterval)},render:function(){this.fetchTemplate("/shared/slider").done(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this.model)),this.startSlideInterval()},startSlideInterval:function(){this.slideInterval=setInterval(_.bind(this.nextSlide,this),this.model.get("slideDuration"))},nextSlide:function(e){var t=this.$(".slide"),n=this.$(".slide-nav-item"),r=t.length,i=this.$(".slide.active"),s=_.isUndefined(e)?i.index()+1:e;s>r-1&&(s=0);var o=t.eq(s),u=n.eq(s);o.addClass("active").siblings().removeClass("active"),u.addClass("active").siblings().removeClass("active")},onSlideNavClick:function(e){var t=$(e.currentTarget);this.nextSlide(t.index()),clearInterval(this.slideInterval),this.startSlideInterval()},onWindowResize:function(t,n){var r=n||$(e).height(),i=this.$el.width(),s=Math.min(i*this.heightRatio,r*.6);this.$el.height(s)}})}),function(){n.Views=n.Views||{},n.Views.Region=Backbone.View.extend({initialize:function(e){this.model=new Backbone.Model({currentView:e.view}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){this.stopListening(),this.listenTo(this.model,"change:currentView",this.renderCurrentView),this.renderCurrentView()},renderCurrentView:function(){var e=this.model.get("currentView"),t=this.model.previous("currentView");t&&!t.destroyed&&t.destroy(!1),e&&(this.el.innerHTML="",e.setElement(this.el),e.render(),this.childViews.currentView=e)},show:function(e){this.model.set("currentView",e)},empty:function(){this.model.set("currentView",null)}})}(),function(){n.Views=n.Views||{},n.Views.Modules=n.Views.Modules||{},n.Views.Modules.FeedEvent=n.Views.Modules.Base.extend({className:"module-feed-event",templateFile:"feedEvent",maxVisibleItems:5,displayComments:!0,itemRendered:!1,canComment:!0,canDelete:!0,showCommentInput:!1,ui:{like:".like",eventActions:".event-actions",context:".context",showComments:".show-comments",typeTitle:".type-title",repostBtn:".icon-repost"},events:{click:"triggerViewed","click a, input, .btn, .action":"logGenericFeedClick","click .show-comments":"onCommentActionClick","click @like":"onLikeClick","click .feed-event-options":"onOptionsClick","focus .comment-input":"onCommentFocus","blur .comment-input":"onCommentBlur","click .event-img-container":"toggleActions","click .repost":"onRepostClick","click .view-songs":"onViewSongsClick"},modelEvents:{model:function(e){var t=e.get("EventType");this.showLikersText(!0),this.$el.data({eventId:e.get("EventID"),type:t,rankingData:e.get("rankingData")}),this.$el.toggleClass("recommendation",t==="recommendation"),this.$el.toggleClass("featured",t==="featured"),this.ui.$eventActions.toggleClass("hide",t==="recommendation"||t==="featured"),this.ui.$context.toggleClass("hide",t!=="recommendation"&&t!=="featured")},"change:userIDLiked":function(e){if(this.model.get("EventType")==="recommendation"||this.model.get("EventType")==="featured")return;var t=e.getIsLikedByLoggedInUser(),n=this.model.get("numLikes"),r=t?"UNLIKE":"LIKE",i=_.getString(r)+(n?" ("+n+")":"");this.ui.$like.removeClass("hide").data("liked",t).data("translateText",r).text(i)},"change:commentsCount change:fakeCommentsCount":function(e){var t=e.get("commentsCount")+e.get("fakeCommentsCount"),n=_.getString("FEED_COMMENT")+(t?" ("+t+")":"");this.ui.$showComments.text(n)},"change:EventType":function(e){this.renderEventType()}},initialize:function(e){return this.$el.data("event",this.model),this.user=_.orEqual(e.user,r.model.get("user")),this.forPostToFeed=_.orEqual(e.forPostToFeed,!1),this.modelBindings=[],this.model.on("destroy",_.bind(this.destroy,this,!0),this),n.on("locale:changed",this.render,this),(this.templateFile=="communityFeedEvent"||this.templateFile=="singleFeedEvent")&&n.on("manatee:broadcastEnded",this.render,this),e.showCommentInput&&(this.showCommentInput=!0),n.Views.Modules.Base.prototype.initialize.call(this,e)},changeModel:function(){return this.markReadTimeout&&(clearTimeout(this.markReadTimeout),this.markReadTimeout=null,this.markedRead=!1),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))},onDestroy:function(){n.off("locale:changed",null,this),n.off("manatee:broadcastEnded",null,this);var e=this;_.each(this.modelBindings,function(t){t.off(null,null,e)}),this.model.off(null,null,this),n.Models.Playlist.removeCacheCallbacks(this),n.Models.Broadcast.removeCacheCallbacks(this),n.Models.Song.removeCacheCallbacks(this),n.Models.User.removeCacheCallbacks(this),n.Models.Album.removeCacheCallbacks(this),n.Models.Artist.removeCacheCallbacks(this),this.commentsView=null,this.markOffscreen()},triggerViewed:function(){this.model&&(this.markedRead=!0,n.trigger("feed:itemViewed",this.model))},markOnscreen:function(){!this.markReadTimeout&&this.rendered&&(this.markReadTimeout=setTimeout(_.bind(this.triggerViewed,this)))},markOffscreen:function(){this.markReadTimeout&&(clearTimeout(this.markReadTimeout),this.markReadTimeout=null)},toggleActions:function(e){if(!gsConfig.isMobile)return;e.preventDefault(),this.$el.toggleClass("show-actions",!this.$el.hasClass("show-actions"))},renderNewComment:function(){this.render()},render:function(){var e=new ChainLoading,t=$.Deferred();return e.push(this.model.getDisplayData().done(e.bind(function(e){this.templateData=$.extend({},e)},this)).fail(e.bind(function(){this.$el.addClass("hide")},this))),e.push(n.Views.Modules.Base.prototype.render.call(this,e)),e.done(_.bind(t.resolve,t)),e.fail(_.bind(t.reject,t)),t.promise()},completeRender:function(e,t){var r=this.model.get("eventType");this.templateData.maxVisibleItems=this.options.maxVisibleItems,this.templateData.canComment=this.canComment&&this.model.canComment(),this.templateData.canDelete=this.canDelete&&this.model.canDelete(),this.templateData.canRepost=!1,this.templateData.liked=this.model.getIsLikedByLoggedInUser(),this.templateData.eventType=this.model.get("EventType"),this.$el.html(this.renderTemplate(e,this.templateData)),n.Views.Modules.Base.prototype.completeRender.call(this,e,$.extend({skipHTML:!0},t)),this.checkButton(),this.renderItem(),r!=="recommendation"&&r!=="featured"&&this.renderComments(),this.showLikersText(),this.showContextText(),this.trigger("rendered")},checkButton:function(){var e=this.model.get("playlistID"),t=this.model.get("artistID"),r=this.model.get("userID");if(e||t||r){var i,s,o,u=this.$(".feed-favorite");e?(i="Playlist",s=e):t?(i="Artist",s=t):r&&(i="User",s=r),o=n.Models[i].getCached(s),o&&this.updateButton(u,i,o.get("isFavorite"))}},updateButton:function(e,t,n){var r="",i=e.find("span");if(t==="Playlist")r=n?"SUBSCRIBED":"SUBSCRIBE";else if(t==="Artist"||t==="User")r=n?"FOLLOWING":"FOLLOW";i.text(_.getString(r)),i.data("translateText",r),e.swapClasses("btn-success","btn-translucent",n),e.find(".icon").swapClasses("icon-check","icon-plus",n)},renderItem:function(e){if(!this.templateData)return;var t=e||new ChainLoading,r=this.$(".item").addClass("module"),i,s;switch(this.templateData.itemType){case"song":t.push(this.templateData.item.getPageNameData()),s=new n.Views.Modules.SongRowFeed({model:this.templateData.item,feedEvent:this.model,dragData:this.templateData,requestedImageSize:80,showTag:!0}),i=s.render().done(function(){r.append(s.el)});break;case"artist":s=new n.Views.Modules.FeedEventArtist({model:this.templateData.item,feedEvent:this.model,el:r,artistClaimModule:this.options.artistClaimModule,dragData:this.templateData}),i=s.render();break;case"album":s=new n.Views.Modules.FeedEventAlbum({model:this.templateData.item,feedEvent:this.model,el:r,dragData:this.templateData}),i=s.render();break;case"playlist":t.push(this.templateData.item.loadSongCount()),this.templateData.item.get("ownerPicture")==null&&this.templateData.item.get("owner")==null&&t.push(this.templateData.item.getOwner()),s=new n.Views.Modules.FeedEventPlaylist({model:this.templateData.item,feedEvent:this.model,el:r,dragData:this.templateData}),i=s.render();break;case"user":s=new n.Views.Modules.FeedEventUser({model:this.templateData.item,feedEvent:this.model,el:r,dragData:this.templateData}),i=s.render();break;case"broadcast":s=new n.Views.Modules.FeedEventBroadcast({model:this.templateData.item,feedEvent:this.model,el:r}),i=s.render()}s&&this.childViews.push(s),i&&i.done(_.bind(function(){this.bindUIElements(),this.renderEventType(),this.ui.$repostBtn.toggleClass("hide",this.forPostToFeed)},this))},openRequireLoginTooltip:function(e,t,r){var i=$(e.currentTarget);n.Models.AuthUser.openRequireLoginTooltip(t,r,{$attached:i,$menuOpenEl:i})},onRepostClick:function(e){if(!this.templateData||!this.templateData.item)return;n.getLoggedInUserID()<1?this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_SHARE",_.bind(function(){this.onRepostClick(e)},this)):n.trigger("lightbox:open","share",{item:this.templateData.item})},onViewSongsClick:function(e){n.trigger("lightbox:open","songList",{artist:this.templateData.item})},renderComments:function(){if(this.destroyed||!this.canComment)return;var e=this.$(".feed-event-comments"),t=this.model.get("EventID"),r=this.templateData.user,i={el:e,collection:this.model.get("comments"),item:this.model,itemID:t,typeID:n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT,highlightComment:null,showPostBox:this.showCommentInput,createCollectionOnDemand:!0,isStranger:!r.get("isFavorite")&&r.id!==n.getLoggedInUserID()},s=this.model.get("context"),o=this,u,a;s&&s.message&&(u=this.model.getPrimaryUser(),i.initialFakeComment=new n.Models.Comment({user:u,CommentID:"feedmsg"+t,ItemID:t,TypeID:n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT,UserID:u&&u.get("UserID"),Message:s.message,Timestamp:this.model.get("timestamp")},{dontCache:!0,skipCache:!0}),i.initialFakeComment.getMessage(),i.initialFakeComment.get("messageOnlyContainsTags")&&(i.initialFakeComment=null)),a=new n.Views.FeedEventComments(i),i.initialFakeComment&&this.model.set("fakeCommentsCount",1),a.render().done(function(){a.verifyCanComment().done(function(e){if(o.destroyed)return;e=o.canComment&&e,o.$(".show-comments").toggleClass("hide",!e)})}),this.commentsView=a,(this.model.get("commentsCount")||this.model.get("fakeCommentsCount")||this.showCommentInput)&&e.removeClass("hide")},renderEventType:function(){var e=this.model.get("EventType"),t;e==="recommendation"?t="RECOMMENDED":e==="featured"&&(t="SIDEBAR_FEATURED"),this.ui.$typeTitle.toggleClass("hide",!t).data("translateText",t).text(_.getString(t))},showLikersText:function(e){if(!this.templateData)return;var t=this.templateData;e&&(t=this.model.recalculateLikesText());var n=this.$(".like-meta"),r=this.model.get("numLikes"),i=this.model.get("importantLikers");if(!r){n.addClass("hide");return}n.removeClass("hide").html(_.getString(t.likesLocaleKey,t.localeVariables))},showContextText:function(e){if(!this.templateData)return;var t=this.$(".context"),n=this.model.get("EventType");(n!=="recommendation"&&n!=="featured"||!this.templateData.contextText)&&t.addClass("hide"),t.html(this.templateData.contextText)},onCommentActionClick:function(e){if(n.getLoggedInUserID()<1){this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_COMMENT",_.bind(function(){this.onCommentActionClick(e)},this));return}if(!this.canComment)return!1;this.commentsView.toggleCommentBox(!0),this.commentsView.renderShowMore(!0),this.$(".feed-event-comments").removeClass("hide").find(".comment-input").focus()},onLikeClick:function(e){var t=$(e.currentTarget),r=t.data("liked");if(n.getLoggedInUserID()<1){this.openRequireLoginTooltip(e,"LB_LOGIN_MUST_LOGIN_TO_LIKE",_.bind(function(){this.onLikeClick(e)},this));return}r?(t.data("liked",!1),this.model.unlike().fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error"})})):(t.data("liked",!0),this.model.like().done(_.bind(n.trigger,n,"tutorial:ShareButton",this.$(".repost, .song-row-repost"))).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error"})}))},onOptionsClick:function(e){var t=$(e.currentTarget);if(t.hasClass("menu-open")){n.trigger("tooltip:close","feed-event-context");return}amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;var e={positionPad:-6,width:175,$attached:t,tooltipKey:"feed-event-context"};e.items=this.getOptionsMenuItems(t),n.Views.Tooltips.Menu.openTooltip(e),this.$el.addClass("active-context")},this))},getOptionsMenuItems:function(e){var t=[],i=this.templateData.user,s=i.id===n.getLoggedInUserID(),o=i.get("isFavorite"),u=o?"UNFOLLOW_USER":"FOLLOW_USER",a=this.templateData.item,f=this.model.canDelete(),l;return s?t.push({localeKey:"PRIVACY_SETTINGS",click:function(){n.router.setHash("/#!/settings/preferences")}}):t.push({type:"html",html:'<a class="menu-item favorite" data-user-id="'+i.id+'"><span class="menu-title" data-translate-text="'+u+'">'+_.getString(u,{userName:i.get("FName")})+"</span></a>",click:_.bind(r.onFavoriteClick,r)}),f?t.push({type:"divider"},{localeKey:"DELETE",click:_.bind(this.deleteFeedEvent,this)}):a&&(a.get("Tags")||a.get("Tag")||this.model.get("userTag"))&&t.push({localeKey:"FLAG_INCORRECT_GENRE",click:_.bind(this.flagIncorrectGenre,this)}),f||t.push({localeKey:"HIDE_POST",click:_.bind(this.hideFeedEvent,this)}),t[t.length-1]&&t[t.length-1].type==="divider"&&(t=t.splice(0,t.length-1)),t},deleteFeedEvent:function(){var e=this.model;e.deleteFeedEvent().fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_FEED_DELETE_FAILED"),type:"error"})})},flagIncorrectGenre:function(e){this.model.flagBadTag().done(_.bind(function(){n.trigger("notification:add",{description:_.getString("POPUP_FEED_REPORTED_ITEM"),priority:6,click:_.bind(function(){this.hideFeedEvent({})},this),type:"success"})},this))},hideFeedEvent:function(e){this.model.hideFeedEvent().done(_.bind(function(){n.trigger("notification:add",{description:_.getString("POPUP_FEED_HIDDEN"),type:"success"})},this))},onCommentFocus:function(e){this.commentsView.toggleCommentBox(!0)},onCommentBlur:function(e){this.$(".comment-form").find(".comment-input").text().length||this.commentsView.toggleCommentBox(!1)},logGenericFeedClick:function(e){var t=$(e.currentTarget),r=t.data(),i=this.model.get("displayObject"),s=this.model.get("eventType"),o={tag:t.prop("tagName"),classes:t.attr("class"),id:t.attr("id")};_.each(r,function(e,t){_.isObject(e)||(o["data-"+t]=e)});switch(o.tag){case"input":o.inputType=t.attr("type"),o.inputType!=="password"&&(o.value=t.val());break;case"a":o.href=t.attr("href")}s==="recommendation"?o.feedItemType=i&&i.itemType+"Rec":s==="featured"?o.feedItemType=i&&i.itemType+"Featured":(o.feedItemType=this.model.get("EventType"),o.ownerUserID=this.model.get("UserID")),o.feedItemID=i&&i.item&&i.item.id,n.trigger("guts:log","feedItemClicked",o)}}),n.Views.Modules.EmbeddedFeedEventMetadata=n.Views.Modules.FeedEvent.extend({templateFile:"",render:function(){var e=new ChainLoading,t=$.Deferred();return e.push(this.model.getDisplayData().done(e.bind(function(n){this.templateData=$.extend({},n),this.templateData.item&&_.isFunction(this.templateData.item.getPageNameData)&&e.pushIgnoreFail(this.templateData.item.getPageNameData()),e.done(_.bind(this.renderItem,this,e)),e.fail(_.bind(t.reject,t)),e.done(_.bind(t.resolve,t))},this)).fail(e.bind(function(){this.$el.addClass("hide")},this))),t.promise()}}),n.Views.Modules.CommunityFeedEvent=n.Views.Modules.FeedEvent.extend({className:"module-feed-event",templateFile:"communityFeedEvent"}),n.Views.Modules.SingleFeedEvent=n.Views.Modules.FeedEvent.extend({className:"module-feed-event",templateFile:"singleFeedEvent",initialize:function(e){this.$relatedContentEl=e.$relatedContentEl,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},completeRender:function(){this.loadRelatedContent(),this._super.apply(this,["completeRender"].concat(_.toArray(arguments)))},loadRelatedContent:function(){if(!this.templateData||!this.$relatedContentEl)return;var e=this.templateData,t,r,i;switch(e.itemType){case"playlist":if(!e.items&&e.item){var s=e.item.model;if(s){var o=n.Models.User.newOrUpdate({UserID:s.get("UserID"),Name:s.get("UserName")},{updateProfile:!1});t="playlist",i=o.getPlaylists(100),r={playlist:s,owner:o,dragData:e}}}break;case"artist":if(!e.items&&e.item){var u=n.Models.Artist.getCached(e.item.id);u&&(t="similarArtists",i=u.getSimilarArtists(),r={artist:u,dragData:e})}break;case"album":if(!e.items&&e.item){var a=n.Models.Album.getCached(e.item.id);a&&(t="topAlbumSongs",i=a.getSongs(),r={album:a,dragData:e})}break;case"song":if(!e.items&&e.item){var f=n.Models.Song.getCached(e.item.id);if(f){var l=n.Models.Artist.newOrUpdate({ArtistID:f.get("ArtistID"),ArtistName:f.get("ArtistName")});t="topArtistSongs",i=l.getSongs(),r={song:f,artist:l,dragData:e}}}}if(!!t){var c=new ChainLoading;c.push(this.fetchTemplate("/shared/digests/"+t+"Digest").done(c.bind(function(e){r.template=e}))),c.push(i.done(c.bind(this.renderRelatedContent,this,t,r)))}},renderRelatedContent:function(e,t,r){if(!t.template||!r||!this.$relatedContentEl)return;var i,s,o,u,a;switch(e){case"topArtistSongs":var f=t.artist;i=f.get("songs"),t.songs=(i&&i.models||[]).sort(n.Models.Song.popularSort).slice(0,3);if(!t.songs.length)return;break;case"topAlbumSongs":var l=t.album;i=l.get("songs"),t.songs=(i&&i.models||[]).sort(n.Models.Song.popularSort).slice(0,3);if(!t.songs.length)return;break;case"playlist":var c=t.owner;s=c.get("playlists"),t.playlists=(s&&s.models||[]).slice(0,3);if(!t.playlists.length)return;break;case"similarArtists":o=t.artist.get("similarArtists"),t.artists=(o&&o.models||[]).slice(0,3);if(!t.artists.length)return}u=t.template,delete t.template,a=new n.Views.Modules.FeedEventContent({model:this.model,el:this.$relatedContentEl}),a.render(u,t),this.childViews.push(a)}})}();var n=typeof n!="undefined"?n:{};(function(){n.Views=n.Views||{};var i=!1,s=new RegExp("items-per-row-\\d+"),o=function(e){var t=document.createElement("div").style,n=["ms","Webkit","Moz","O"],r=n.length,i,s;if(e in t)return e;while(r--){i=n[r]+e;if(i in t){s=i;break}}return s},u=o("Transform"),a={dimension:["width","height"],item:["itemWidth","itemHeight"],outer:["outerWidth","outerHeight"],inner:["innerWidth","innerHeight"],direction:["left","top"],scrollDir:["scrollLeft","scrollTop"],min:["minWidth","minHeight"]},f=.75;$.browser.msie&&$.browser.version<9&&(f=.4),n.Views.Grid=Backbone.View.extend({templatePath:"grid",lastScrollIndex:0,events:{"click .grid-column":"handleColumnClick","click .grid-resize.resizable":"handleResizeClick","click .grid-item":"handleItemClickProxy","dblclick .grid-item":"handleItemDblclick","selectstart .grid-column":"handleSelectStart","selectstart .grid-item":"handleSelectStart","mousedown .grid-resize.resizable":"handleResizeEvents","contextmenu .grid-item":"handleContextMenuClick"},defaults:{axis:"y",itemHeight:15,bufferBefore:f,bufferAfter:f,itemsPerRow:1,header:!0,multiSelect:!1,allowMultiSelect:!1,keepSelectionOnFilter:!1,pageEl:"#container",variableSize:!1,ignorePageClick:!1,maximumVisibleRows:Infinity,forceAllItemsVisible:!1},rendered:!1,itemsPerRowSet:!1,initialize:function(){function f(e,t){var n=_.extend({},t);delete n.add,delete n.at,delete n.merge,n.fromBaseCollection=!0,this.reloadBareElements().done(_.bind(function(){var t=e.models;this.forceMaxVisibleItems&&(t=e.models.slice(0,this.forceMaxVisibleItems)),this.visibleCollection.reset(t,n)},this))}_.defaults(this.options,this.defaults),this.options.axis=this.options.axis=="x"?"x":"y",this.itemsPerRow=this.options.itemsPerRow||1,this.maximumVisibleRows=this.options.maximumVisibleRows||!1;var t=this.options.axis=="x"?0:1,r=this.options.axis=="x"?1:0,s={},o={};_.each(a,function(e,n){s[n]=e[t],o[n]=e[r]}),this.axisTranslations=s,this.axisTranslationsAntonyms=o,this.createdHeaders=!1,this.renderDfd=$.Deferred(),i=$("body").hasClass("is-ie7"),this.renderers=[],this.rendererDfds=[];var u=this.options.parentGrid;this.selectedItems=u?u.selectedItems:new Backbone.Collection,this.$viewport=$('<div class="grid-viewport" style="position: relative;"><div class="grid-canvas" style="position: absolute;"></div></div>'),this.$canvas=$(this.$viewport[0].childNodes[0]),this.options.header&&(this.$header=$('<div class="grid-header module-row-header"></div>')),this.options.canvasMaxItems&&(this.options.maximumVisibleItems=this.options.canvasMaxItems),this.visibleCollection=new this.collection.constructor(this.collection.models),this.updateItemsPerRow(),this.updateMaximumVisibleItems(),this.options.scrollElement?this.$scrollElement=this.options.scrollElement:this.$scrollElement=$(document),this.scrollOffset=0,this.selectedItems.on("reset sort",function(e,t){var n=t&&t.removed,r,i;if(!n||this.parentGrid)n=_.difference(t.previousModels,e.models);if(n&&n.length)for(r=0,i=n.length;r<i;r++)n[r].trigger(this.cid+":deselect");for(r=0,i=e.models.length;r<i;r++)e.models[r].trigger(this.cid+":select")},this),this.selectedItems.on("reset",function(e,t){e.lastSelect=null,e.lastSelectParent=null,e.length>0&&(e.lastSelect=e.at(-1),e.lastSelectParent=this.options.parentModel||null)},this),this.selectedItems.on("add",function(e,t,n){e.trigger(this.cid+":select")},this),this.selectedItems.on("remove",function(e,t,n){e.trigger(this.cid+":deselect")},this),_.$one(document.body).on("keydown."+this.cid,_.bind(this.handleKeydown,this)),_.$one(e).on("resize."+this.cid,_.animationThrottle(function(){this.resizeColumns();if(typeof this.options.minHeight=="function"||typeof this.options.minWidth=="function")this.resize(!0),this.resize()},this)),this.options.ignorePageClick||$(this.options.pageEl).on("click."+this.cid,_.bind(this.handlePageElClick,this)),this.maximumVisibleItems>this.blockSize+this.bufferAfter&&(this.$scrollElement[0]==$(document)[0]?this.listenTo(n,"scroll",_.bind(this.handleScroll,this,null)):this.$scrollElement.on("scroll."+this.cid,_.bind(this.handleScroll,this))),this.listenTo(n,"scrollStart",this.onScrollStart),this.listenTo(n,"scrollEnd",this.onScrollEnd),this.collection.on("add",function(e,t,n){var r=n||{};r.at=r.index||t.indexOf(e),r.fromBaseCollection=!0,this.reloadBareElements().done(_.bind(function(){this.visibleCollection.add(e,r)},this))},this),this.collection.on("remove",function(e,t,n){var r=n||{};r.fromBaseCollection=!0,this.reloadBareElements().done(_.bind(function(){this.visibleCollection.remove(e,r)},this))},this),this.collection.on("reset sort",f,this),this.collection.on("move",function(e,t,n,r){f.call(this,e,r)},this),this.visibleCollection.on("reset sort",_.bind(this.handleScroll,this,{force:!0}),this),this.options.keepSelectionOnFilter||this.visibleCollection.on("remove reset sort",_.bind(function(){var e=this.selectedItems.toArray(),t=_.intersection(e,this.visibleCollection.toArray()),n=_.difference(e,t);this.selectedItems.remove(n)},this)),this.$el.data({view:this});var l=_.bind(function(e){(typeof this.options.minHeight=="function"||typeof this.options.minWidth=="function")&&this.resize(!0,e.fromBaseCollection),this.resize()},this);return this.visibleCollection.on("reset",_.debounce(function(e,t){l(t)},100),this),this.visibleCollection.on("move",_.debounce(function(e,t,n,r){l(r)},100),this),this.visibleCollection.on("add remove",_.debounce(function(e,t,n){l(n),this.handleScroll({force:!0})},100),this),this.options.variableItemsPerRow&&n.on("app:resize",this.updateItemsPerRow,this),n.on("page:redrawUpdate",this.recalculateScrollOffset,this),Backbone.View.prototype.initialize.call(this)},onDestroy:function(){this.collection.off("add remove reset move sort",null,this),this.visibleCollection.off("add remove reset move sort",null,this),this.selectedItems.off("add remove reset move sort",null,this),this.$el.removeClass("grid-"+this.cid),this.$style&&this.$style.remove(),_.$one(document.body).off("keydown."+this.cid),_.$one(e).off("resize."+this.cid),_.$one(this.options.pageEl).off("click."+this.cid),this.$scrollElement.off("scroll."+this.cid),this.$el.data({view:t}),this.stopListening();var r=this.options.variableSize;_.each(this.renderers,function(e){r&&e.off&&e.off("resized",null,this),e.destroy&&e.destroy()}),_.$one(document).off("mousemove."+this.cid),_.$one(document).off("mouseup."+this.cid),_.$one(document).off("selectstart."+this.cid),n.off("app:resize",null,this),n.off("page:redrawUpdate",null,this)},updateMaximumVisibleItems:function(e){var t=Math.ceil(screen[this.axisTranslations.dimension]/this.options[this.axisTranslations.item]*this.itemsPerRow);!_.isUndefined(e)&&e>0||this.options.maximumVisibleItems?(this.maximumVisibleItems=e||this.options.maximumVisibleItems,this.bufferBefore=0,this.bufferAfter=0,this.blockSize=this.maximumVisibleItems,e&&(this.truncateVisibleItems(e),n.trigger("page:redrawUpdate"))):this.options.forceAllItemsVisible?this.blockSize=this.bufferAfter=this.bufferBefore=this.maximumVisibleItems=this.collection.length:(this.maximumVisibleItems=Math.ceil(t*(1+this.options.bufferBefore+this.options.bufferAfter)),this.bufferBefore=Math.floor(t*this.options.bufferBefore),this.bufferAfter=Math.floor(t*this.options.bufferAfter),this.blockSize=Math.floor((this.maximumVisibleItems-this.bufferBefore)/2))},updateMaximumVisibleRows:function(e){this.maximumVisibleRows=e,this.updateItemsPerRow(!0)},getRenderer:function(e,t){var n,r;if(this.renderers[e])return n=this.renderers[e],t&&!n.changeModel?n.model=t:t&&t!==n.model&&n.changeModel&&n.changeModel(t,{selected:this.selectedItems.indexOf(t)!==-1}),n;if(t&&this._firstRender)r=_.extend({},this.options.moduleOptions,{grid:this,model:t,addClass:this.options.addRowClass}),n=new this.options.itemRenderer(r),this.options.variableSize&&n.on("resized",_.debounce(_.bind(this.moduleResized,this),100),this),this.renderers[e]=n,this.afterBareElements&&this.afterBareElements[0]?n.$el.insertBefore(this.afterBareElements[0]):this.$canvas.append(n.$el),n.render();else if(t)return n={status:1,model:t,grid:this,options:{grid:this},renderDfd:$.Deferred(),show:function(){this.status=1},hide:function(){this.status=0},renderTemplate:Backbone.View.prototype.renderTemplate},this.renderers[e]=n,this.rendererDfds[e]=n.renderDfd,n;return null},renderRenderers:function(e){var t=this.options.itemRenderer||{},n=t.prototype||{},r=n.className,i="",s=[],o=this.renderers.length,u,a,f,l,c,h;this.beforeBareElements&&this.$canvas.prepend(this.beforeBareElements);for(u=0;u<o;u++)a=this.renderers[u],a.model?i=a.renderTemplate(_.bind(e,a)):i="",s.push('<div class="'+r+'">'+i+"</div>");c=$(s.join("")),this.$canvas.append(c),c=c.toArray();for(u=0;u<o;u++){f=this.renderers[u];if(!f.model||f instanceof t)continue;l=c.shift(),l||(l=$('<div class="'+r+'"></div>'),this.$canvas.append(l)),h=_.extend({},this.options.moduleOptions,{el:l,grid:this,model:f.model,addClass:this.options.addRowClass}),a=new t(h),this.options.variableSize&&a.on("resized",_.debounce(_.bind(this.moduleResized,this),100),this),this.renderers[u]=a,a.renderDfd||(a.renderDfd=this.rendererDfds[u]),a.completeRender(e,{skipHTML:!0}),this.rendererDfds[u].resolve(),f.status||a.hide()}this._firstRender=!0,this.afterBareElements&&this.$canvas.append(this.afterBareElements)},recalculateScrollOffset:function(){if(this.destroyed)return;try{var e=0,t=this.$el,n=this.$el,r=0;do r++,t[0]&&t[0]==n[0]&&(e+=t.position()[this.axisTranslations.direction],n=n.offsetParent()),t=t.parent();while(t[0]!=this.$scrollElement[0]&&r<1e4);this.$scrollElement[0]!==document&&this.$scrollElement[0]!==document.documentElement&&(e+=this.$scrollElement.scrollTop()),this.scrollOffset=e}catch(i){console.error("failed to recalculateScrollOffset: grid"+this.cid,this.$el[0].className,i)}},precacheTemplate:function(){return this.options.itemRenderer.precacheTemplate(this.options.itemRenderer)},render:function(){var e=0,n=[],r=[],i={position:"relative"},s;this.options.forceAllItemsVisible&&this.updateMaximumVisibleItems(),_.each(this.visibleCollection.take(this.maximumVisibleItems),_.bind(function(t){var r=this.getRenderer(e,t);n.push(r.renderDfd),e++},this)),r.push(this.reloadBareElements()),r.push(this.precacheTemplate().done(function(e){s=e})),$.after(r).done(_.bind(function(){this.renderRenderers(s)},this)),this.options.minWidth&&typeof this.options.minWidth=="number"&&(i["min-width"]=this.options.minWidth),this.options.minHeight&&typeof this.options.minHeight=="number"&&(i["min-height"]=this.options.minHeight),this.$el.css(i),this.recalculateScrollOffset();var o=["grid-"+this.cid,"grid"];this.options.variableSize&&o.push("variable"),this.options.gridTypeClass&&o.push(this.options.gridTypeClass),(this.options.showTrackNum||this.options.showCount)&&o.push("show-row-numbers"),this.$el.addClass(o.join(" ")),this.createHeaders(),this.$el.append(this.options.header?this.$header:t,this.$viewport),this.resize(),this.rendered&&this.writeCSS(),$.after(n).done(_.bind(function(){this.rendered||(this.rendered=!0,this.writeCSS(),this.renderDfd.resolve(),this.trigger("rendered"))},this))},reloadBareElements:function(){var e=$.Deferred(),t=[],n=!1,r,i,s,o,u,a;return _.isFunction(this.options.getBeforeBareElements)&&t.push(this.options.getBeforeBareElements(this.collection,this.beforeBareElements).done(_.bind(function(e){if(e===this.beforeBareElements&&e&&e.length==this.beforeBareElements.length)return;e||(e=[]);if(this.rendered){u=_.toInt(this.beforeBareElements&&this.beforeBareElements.length),i=Math.max(u,e.length),s=i-u,o=u-i;for(r=i;r>=0;r--)this.beforeBareElements[r+o]?e[r+s]?this.beforeBareElements[r+o][0]!==e[r+s][0]&&(e[r+s].insertBefore(this.beforeBareElements[r+o]),this.beforeBareElements[r+o].detach()):this.beforeBareElements[r+o].remove():(e[r+s].hide(),this.$canvas.prepend(e[r+s]));i!=e.length&&(n=!0)}this.beforeBareElements=e},this))),_.isFunction(this.options.getAfterBareElements)&&t.push(this.options.getAfterBareElements(this.collection,this.afterBareElements).done(_.bind(function(e,t){if(e===this.afterBareElements&&e&&e.length==this.afterBareElements.length)return;e||(e=[]);if(this.rendered){u!=e.length&&(n=!0),u=_.toInt(this.afterBareElements&&this.afterBareElements.length),i=Math.max(u,e.length);for(r=i-1;r>=0;r--)e[r]?(this.afterBareElements[r]?this.afterBareElements[r][0]!==e[r][0]&&(e[r].insertBefore(this.afterBareElements[r]),this.afterBareElements[r].detach()):(e[r].hide(),this.$canvas.append(e[r])),n&&(a=e[r].position(),e[r].css({position:"absolute",top:a.top,left:a.left}))):(console.log("removed!",r),this.afterBareElements[r].remove());if(t)for(r=0,i=t.length;r<i;r++)t[r].remove()}this.afterBareElements=e},this))),$.after(t).done(function(){e.resolve(n)}),e.promise()},refresh:function(){var e=0,t=this.maximumVisibleItems,n;for(;e<t;e++)n=this.getRenderer(e),n&&n.renderDfd.then(_.bind(n.handleModelChange,n))},resize:function(e,t){var n=this.beforeBareElements&&this.beforeBareElements.length||0,r=this.afterBareElements&&this.afterBareElements.length||0,i=this.visibleCollection.length+n+r,s=0,o=this.maximumVisibleRows==Infinity,u,a;this.updateItemsPerRow(t),o?this.options.canvasMaxItems?a=Math.ceil(Math.min(i,this.options.canvasMaxItems)/this.itemsPerRow):a=Math.ceil(i/this.itemsPerRow):a=this.maximumVisibleRows;if(this.options.variableSize){var f=this.options.itemRenderer.estimateSize;for(var l=0,c=this.visibleCollection.length;l<c;l++)s+=f(this.visibleCollection.at(l),this,!1)}else s=a*this.options[this.axisTranslations.item];u=s+(this.options.header?this.$header[this.axisTranslations.dimension]():0);if(!e&&typeof this.options[this.axisTranslations.min]=="function"){var h=this.options[this.axisTranslations.min]()||0;u=Math.max(h,u)}o&&u!=this.lastDimensionSize&&this.maximumVisibleItems>this.blockSize+this.bufferAfter?(this.$el.css(this.axisTranslations.dimension,u),this.lastDimensionSize=u,this.trigger("resized")):this.$canvas.css("position","relative")},updateItemsPerRow:function(e){if(!this.options.variableItemsPerRow)return;var t=this.$el.width(),n=Math.max(Math.floor(t/this.options.itemWidth),1),r=this.options.maximumVisibleItems>1&&n===1?this.options.maximumVisibleItems:n*this.maximumVisibleRows,i,o;if(this.itemsPerRow!==n||!this.itemsPerRowSet||e)this.itemsPerRow=Math.min(n,this.visibleCollection.length,10),o="items-per-row-"+this.itemsPerRow,i=this.$el[0].className.replace(s,o),i.indexOf("items-per-row-")>-1?this.$el[0].className=i:this.$el.addClass(o),this.writeCSS(),this.truncateVisibleItems(Math.min(r,this.collection.length)),this.itemsPerRowSet=!0},truncateVisibleItems:function(e){var t=this.renderers.length-e,n;this.rendered?t&&(t>0&&(n=this.renderers.splice(e,t),_.each(n,function(e){this.options.variableSize&&e.off("resized",null,this),e.destroy&&e.destroy()},this)),this.handleScroll({force:!0})):this.visibleCollection.reset(this.collection.take(e))},moduleResized:function(){this.resize(),this.options.overrideScrollPos||this.handleScroll({force:!0})},writeCSS:function(){var e=[],t=this.$el.width()||this.options.minWidth,n=this.cid,r=0,s=this.renderers.length&&this.renderers[0].$el,o,u,a;i&&s&&(o=function(e,t){var n=(s.find(t).css("padding")||"").replace(/px/g,"").split(" ");switch(n.length){case 1:e-=(n[0]-0)*2;break;case 2:e-=(n[1]-0)*2;break;case 4:e-=n[1]-0+(n[3]-0)}return e});if(this.$columns){var f,l;this.$columns.each(function(i,s){f=_.$one(s).data(),l=_.$one(s).outerWidth(),u=o?o(l,f.resizeSelector):l,a=Math.floor(u/t*1e4)/100,e.push([".grid-",n," ",f.resizeSelector," { width:",a,"% !important;left: "+r+"% !important; }"].join("")),r+=a})}else this.columns&&_.each(this.columns,function(i){u=o?o(i.width,i.selector):i.width,a=Math.floor(u/t*1e4)/100,e.push([".grid-",n," ",i.selector," { width:",a,"% !important;left: "+r+"% !important; }"].join("")),r+=a});if(e.length||this._lastCSSRules&&this._lastCSSRules.length){this.$style||(this.$style=$('<style type="text/css"></style>'),$("head").append(this.$style));var c=e.join("\n");if(c!=this._lastCSSRules){this._lastCSSRules=c;if(this.$style[0].styleSheet)this.$style[0].styleSheet.cssText=this._lastCSSRules;else{var h=this.$style[0].childNodes[0];h?this.$style[0].replaceChild(document.createTextNode(this._lastCSSRules),h):this.$style[0].appendChild(document.createTextNode(this._lastCSSRules))}}}},createHeaders:function(){if(!this.options.columns||!this.options.columns.length||this.createdHeaders)return;this.columns=[];var e=this.options.header!==!1,t=[],n=[],r=this.columns||[],i=this.options.columns||[],s=this.$el.width()||this.options.minWidth,o=0,u,a,f,l,c,h,p,d,v,m,g,y,b;for(l=0,c=i.length;l<c;l++)h=_.clone(i[l]),r[l]=h,h.resizable=h.resizable!==!1,h.minimumSize=h.minimumSize||10,h.width=Math.max(h.minimumSize,h.width||h.percent*s||10),o+=h.width;u=Math.max(0,o-s),a=Math.abs(Math.min(0,o-s));for(l=0,c=r.length;l<c;l++)h=r[l],p=h.resizable,d=h.minimumSize,v=h.width,p&&u&&d<v?(m=r[l+1]||{},g=u,y=Math.floor(g/2),m.resizable&&m.minimumSize<m.width-y&&(g=Math.ceil(g/2)),g>d&&(g=v-d),v-=g,u-=g):p&&a&&(m=r[l+1]||{},g=a,m.resizable&&(g=Math.ceil(g/2)),v+=g,a-=g),h.width=v,e&&(b=Math.floor(h.width/s*1e4)/100,f='<div class="module-row-column grid-column" style="width:'+b+'%;float:left;"><a class="header-link"><span'+(h.locale?' data-translate-text="'+h.locale+'"':"")+">"+(_.getString(h.locale)||"&nbsp;")+'<i class="icon icon-caretup"></i><i class="icon icon-caretdown"></i></span></a><div class="grid-resize drag-handle '+(p?"resizable":"")+'"></div></div>',n.push(f),t.push({columnKey:l,sortKey:h.sortKey,resizable:p,minimumSize:d,resizeSelector:h.selector}));if(e){this.$columns=$(n.join(""));for(l=0,c=this.$columns.length;l<c;l++)_.$one(this.$columns[l]).data(t[l]);this.$header.append(this.$columns)}this.createdHeaders=!0},resizeColumns:function(){if(!this.options.columns||!this.options.columns.length||!this.createdHeaders)return;var e=this.$el.width()||this.options.minWidth,t=0,n=this.$columns&&this.$columns.length||this.columns.length,r=[],i,s,o,u,a,f,l,c,h,p,d,v;if(this.$columns)this.$columns.each(function(e,n){c=_.$one(n),l=c.data("minimumSize"),i=Math.max(l,c.width()),r[e++]=i,t+=i});else{if(!this.columns)return;_.each(this.columns,function(n){n.width=Math.max(n.minimumSize,n.width||n.percent*e||10),t+=n.width})}o=Math.max(0,t-e),u=Math.abs(Math.min(0,t-e));for(v=0;v<n;v++)a=this.columns[v],f=a.resizable,l=a.minimumSize,c=this.$columns&&_.$one(this.$columns[v]),c?i=r[v]:i=a.width,f&&o&&l<i?(h=this.columns[v+1]||{},p=o,d=Math.floor(p/2),h.resizable&&h.minimumSize<h.width-d&&(p=Math.ceil(p/2)),p>l&&(p=i-l),i-=p,o-=p):f&&u&&(h=this.columns[v+1]||{},p=u,h.resizable&&(p=Math.ceil(p/2)),i+=p,u-=p),a.width=i,c&&(s=Math.floor(i/e*1e4)/100,c.css("width",s+"%"));this.writeCSS()},getScrollPositionToShowItem:function(e,t){t=_.orEqual(t,!1);if(!this.visibleCollection)return-1;e=this.visibleCollection.find(function(t){return t.id==e.id});var n=this.visibleCollection.indexOf(e);if(n==-1)return-1;this.itemsPerRow>1&&(n+=n%this.itemsPerRow);var r=this.$scrollElement[this.axisTranslations.dimension](),i=Math.max(0,this.options[this.axisTranslations.item]*this.visibleCollection.length-r),s=Math.floor(r/this.options[this.axisTranslations.item]);return t&&(n=Math.max(0,n-s/2)),Math.min(i,n*this.options[this.axisTranslations.item])},getMaxScrollPos:function(){var e=this.$scrollElement[this.axisTranslations.dimension]();return Math.max(0,this.options[this.axisTranslations.item]*this.visibleCollection.length-e)},indexFromScrollPosition:function(e){if(this.options.variableSize){var t=this.options.itemRenderer.estimateSize,n=0,r=0,i=this.visibleCollection.length;for(;r<i;r++){n+=t(this.visibleCollection.at(r),this);if(n>=e)return r}}return this.options.canvasMaxItems?0:Math.floor(e/this.options[this.axisTranslations.item])*this.itemsPerRow},offsetFromIndex:function(e){if(this.options.variableSize){var t=this.options.itemRenderer.estimateSize,n=0,r=0;for(;r<e;r++)n+=t(this.visibleCollection.at(r),this);return n}return Math.ceil(e*this.options[this.axisTranslations.item]/this.itemsPerRow)},onScrollStart:function(){this.$canvas.addClass("scrolling")},onScrollEnd:function(){this.$canvas.removeClass("scrolling")},handleScroll:function(e,t){var n=e&&e.force===!0||!1,r=this.visibleCollection.length,i=this.beforeBareElements&&this.beforeBareElements.length||0,s=this.afterBareElements&&this.afterBareElements.length||0,o=this.visibleCollection.length<this.maximumVisibleItems,a,f,l,c,h,p,d,v;if(!e&&!_.isNumber(t))return;if(o&&!n)return;_.isNumber(t)?p=t-this.scrollOffset:p=_.toInt(this.$scrollElement[this.axisTranslations.scrollDir]()-this.scrollOffset),d=this.indexFromScrollPosition(p),o&&(d=0),d=Math.max(0,Math.floor(Math.min(d,r-this.bufferAfter+s)/this.blockSize)*this.blockSize),this.itemsPerRow>1&&(d-=d%this.itemsPerRow);if(this.lastScrollIndex==d&&!n)return;l=0,c=d;if(d<i||this.lastScrollIndex<i)for(h=i-1;h>=0;h--)h>=i+(d-i)?(this.beforeBareElements[h].show(),l++):this.beforeBareElements[h].hide();c=Math.max(0,c-i),this.options.forceAllItemsVisible&&this.updateMaximumVisibleItems();for(var m=0,g=Math.max(this.maximumVisibleItems,this.renderers.length);m<g;m++,c++){f=this.visibleCollection.models[c],a=this.getRenderer(m,f);if(!a)continue;!f||l>=g?a.hide():(a.show(),l++)}if(l<this.maximumVisibleItems||r-this.maximumVisibleItems>=this.lastScrollIndex)for(h=0;h<s;h++)this.afterBareElements[h].css({position:"",top:"",left:""}),l<this.maximumVisibleItems?(this.afterBareElements[h].show(),l++):this.afterBareElements[h].hide();this.lastScrollIndex=d;var y=this.offsetFromIndex(d);if(y!=this.lastOffset){if(u){var b;this.axisTranslations.direction==="top"?b=["translate(0, ",y,"px)"].join(""):b=["translate(",y,"px, 0)"].join(""),this.$canvas.css(u,b)}else this.$canvas.css(this.axisTranslations.direction,y);this.lastOffset=y}},handleItemClick:function(e){if(!$(e.target).is("a, i, input")&&!$(e.target).parents("a").length){e.preventDefault();var t=jQuery.data(e.currentTarget,"module"),n=t.model;this.handleItemEvent(e,n);if(_.isFunction(this.options.onItemClick))return this.options.onItemClick.call(this,n)}},handleItemClickProxy:function(e){var t=jQuery.data(e.currentTarget,"module");if(!this.lastClick||this.lastClick[0]!=t||e.timeStamp-this.lastClick[1]>300)this.lastClick=[t,e.timeStamp],this.handleItemClick(e)},handleItemDblclick:function(e){p(e)},handleColumnClick:function(e){e.stopPropagation(),e.preventDefault();var t=$(e.currentTarget),n=t.data(),r=n.sortKey;if(!r)return;this.sort(r)},handleContextMenuClick:function(e){var t=$(e.currentTarget),i=t.data("module"),s=i.model,o={},u,a,f,l,c;if(e.target.nodeName=="INPUT")return;(!this.selectedItems.length||this.selectedItems.indexOf(s)==-1)&&this.handleItemEvent(e,s),f=this.selectedItems.length;if(t.hasClass("song"))c="Song";else if(t.hasClass("queue-item"))l="Song",c="PlayableSong";else if(t.hasClass("artist"))c="Artist";else if(t.hasClass("album"))c="Album";else if(t.hasClass("playlist"))c="Playlist";else{if(!t.hasClass("user"))return!1;c="User"}l=l||c,this.options.playContext&&(o.playContext=this.options.playContext);if(this.contextMenuExtra||this.options.contextMenuExtra)o=_.extend(o,this.contextMenuExtra?this.contextMenuExtra:this.options.contextMenuExtra);if(f==1){if(c=="PlayableSong"||o.source=="nowPlaying"){o.isQueue=!0,o.queueSongClickedID=s.get("queueSongID"),o.queueSongClickedQueueSongID=s.get("queueSongID"),o.autoplay=r.model.get("player").get("autoplay");function h(){n.trigger("player:removeSongs",[s])}o.onRemoveFromQueue=h}if(!s)return!1;this.options.playlist&&(o.playlist=this.options.playlist,o.playlistSongID=s.get("playlistSongID")),a="getContextMenuFor"+l,u=s}else if(c=="Song"){this.options.playContext&&this.options.playContext.type=="playlist"&&(o.playlist=this.options.playlist,o.playlistSongIDS=this.selectedItems.pluck("playlistSongID"));if(o.source=="nowPlaying"){var p=this.selectedItems.toArray();function d(){n.trigger("player:removeSongs",p)}o.onRemoveFromQueue=d}a="getMultiContextMenuFor"+l+"s",u=this.selectedItems.toArray()}var v=_.extend({show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,ev:e,player:r.model.get("player"),grid:this},o);return _.asyncTooltipMenu(t,v,u,a),!1},sort:function(e,t,r,i){var s=!1;if(i){i.songStats.sort(function(e,t){return i.sortKey===i.lastMetric&&!i.reversed?_.toInt(e[i.sortKey])-_.toInt(t[i.sortKey]):_.toInt(t[i.sortKey])-_.toInt(e[i.sortKey])}),i.gridOptions.selectedStatColumn=i.columnSelected;var o=new n.Models.Collections.Songs(i.songStats);this.collection.reset(o.models),i.filterVal&&this.filter(i.filterVal),_.each(this.renderers,function(e){e.handleModelChange()}),i.sortKey===i.lastMetric&&!i.reversed?this.options.reversed=!0:this.options.reversed=!1,this.options.lastMetric=i.sortKey;return}this.lastSortColumn&&($(this.lastSortColumn).removeClass("desc asc"),this.lastSortColumn=null);if(_.isArray(e)){this.visibleCollection.comparator=null,this.lastSortKey=null,this.visibleCollection.reset(e,{sorted:!0});return}if(_.isFunction(e)){this.lastSortKey!==e||!!t&&this.lastSortDir!=t?(t=t||r,t&&t!==r&&(s=!0)):(t=t=="asc"?"desc":"asc",s=!0),s&&(e=function(e){return function(t,n){return-1*e(t,n)}}(e)),this.visibleCollection.comparator=e,this.visibleCollection.sort({sorted:!0}),this.lastSortKey=e,this.lastSortDir=t;return}t||(this.lastSortKey!=e?t=r||"asc":this.lastSortDir?t=this.lastSortDir=="desc"?"asc":"desc":t="asc");if(e==="default"){this.visibleCollection.comparator=null;var u=_.intersection(this.collection.models,this.visibleCollection.models);this.resetSortCaret(),t!==r&&u.reverse(),this.visibleCollection.reset(u,{sorted:!0}),this.lastSortKey=e,this.lastSortDir=t;return}var a=t=="asc"?1:-1,f=t=="asc"?-1:1,l=this.options.sortType;!l&&e=="TrackNum"?l="number":!l&&e=="TSAdded"&&(l="date");var c=function(t,n){var r=t.get(e),i=n.get(e);return _.isString(r)&&(r=r.toLowerCase()),_.isString(i)&&(i=i.toLowerCase()),r>i?a:f},h=function(t,n){var r=t.get(e),i=n.get(e);return r=_.toInt(r),i=_.toInt(i),r>i?a:f},p=function(t,n){var r=t.get(e),i=n.get(e);return r<i?a:f},d=null;this.options.getSortComparator&&(d=this.options.getSortComparator(e,t=="asc")),d?this.visibleCollection.comparator=d:l=="number"?this.visibleCollection.comparator=h:l=="date"?this.visibleCollection.comparator=p:this.visibleCollection.comparator=c;var v=0,m=this.$columns&&this.$columns.length,g;for(;v<m;v++)_.$one(this.$columns[v]).data("sortKey")==e&&(g=$(this.$columns[v]));g&&(g.removeClass(t=="asc"?"desc":"asc").addClass(t),this.lastSortColumn=g[0]),this.lastSortKey=e,this.lastSortDir=t,this.visibleCollection.sort({sorted:!0})},resetSortCaret:function(){$(".desc",this.$el).removeClass("desc"),$(".asc",this.$el).removeClass("asc"),this.lastSortDir=t,this.lastSortKey=t},filter:function(e,t){var n=_.orEqual(e,"").toLowerCase(),r=_.defaults(_.orEqual(t,{}),{sorted:!0,filterAttribute:"searchText",src:"collection"}),i;_.isFunction(r.filterFunction)?i=this[r.src].filter(r.filterFunction):r.filterAttribute==="searchText"?i=this[r.src].filter(function(e){var t=e.get("searchText");return t&&t.indexOf(n)>-1}):i=this[r.src].filter(function(e){var t=e.get(r.filterAttribute);return t?t.toLowerCase().indexOf(n)>-1:!1}),this.options.canvasMaxItems&&(i=_.take(i,this.options.canvasMaxItems)),this.visibleCollection.reset(i,r)},handleResizeClick:function(e){e.stopPropagation()},handleKeydown:function(e){if(this.options.isParentGrid||!this.selectedItems.length||$(e.target).is("input,textarea,select"))return!0;if(this.options.parentGrid)return!0;switch(e.which){case 8:case 46:if(_.isFunction(this.options.onDelete)&&this.selectedItems.length){e.stopPropagation(),e.preventDefault(),this.options.onDelete(this.selectedItems);return}break;case _.keyboard.UP:case _.keyboard.DOWN:case _.keyboard.LEFT:case _.keyboard.RIGHT:return this.handleArrowKeyPress(e);case 65:if(e.metaKey||e.ctrlKey){e.stopPropagation(),e.preventDefault(),this.selectedItems.reset(this.visibleCollection.models);return}}},handleArrowKeyPress:function(e){if(e.metaKey||e.ctrlKey)return;var t=this.visibleCollection.indexOf(this.selectedItems.lastSelect),n=this.options.axis==="x",r,i,s;if(e.which===_.keyboard.UP&&!n||e.which===_.keyboard.LEFT&&n)this.options.cycleSelect&&t===0?r=this.visibleCollection.length-1:r=Math.max(0,t-1);else{if(!(e.which===_.keyboard.DOWN&&!n||e.which===_.keyboard.RIGHT&&n))return;this.options.cycleSelect&&t===this.visibleCollection.length-1?r=0:r=Math.min(this.visibleCollection.length,t+1)}e.stopPropagation(),e.preventDefault(),i=this.visibleCollection.models[r];if(!i)return;for(var o=0,u=this.renderers.length;o<u;o++)if(this.renderers[o].model==i){s=this.renderers[o];break}this.handleItemEvent(e,i),this.scrollToModule(s)},scrollToModule:function(t){if(!t)return;var n=this.$scrollElement[0]===document,r=n?$(e):this.$scrollElement,i=t.$el.offset()[this.axisTranslations.direction],s=t.$el[this.axisTranslations.outer](),o=n?$(e)[this.axisTranslations.scrollDir]():r.offset()[this.axisTranslations.direction],u=r[this.axisTranslations.outer](),a=i-o,f=a+s-u,l;f>0?(l=r[this.axisTranslations.scrollDir](),r[this.axisTranslations.scrollDir](l+f)):a<0&&(l=r[this.axisTranslations.scrollDir](),r[this.axisTranslations.scrollDir](l+a))},handleItemEvent:function(e,t){if(this.options.isParentGrid)return;var n=this.visibleCollection.indexOf(t),r=this.selectedItems.lastSelect,i=this.selectedItems.lastSelectParent,s=$(e.currentTarget),o=$(e.target),u=s.data("module");this.options.cycleSelect&&this.selectedItems.remove(r),this.selectedItems.lastSelect=t,this.options.parentModel&&(this.selectedItems.lastSelectParent=this.options.parentModel);if(u&&u.disabled||o.hasClass("action"))return;if((e.metaKey||e.ctrlKey||this.options.multiSelect)&&this.selectedItems.indexOf(t)!==-1){if(this.selectedItems.anchor){var a=this.visibleCollection.at(n+1),f=this.visibleCollection.at(n-1);this.selectedItems.indexOf(a)!==-1?this.selectedItems.anchor=a:this.selectedItems.indexOf(f)!==-1?this.selectedItems.anchor=f:this.selectedItems.anchor=null}this.selectedItems.remove(t);return}if(this.options.allowMultiSelect&&e.shiftKey&&this.selectedItems.anchor){var l=this.visibleCollection.indexOf(this.selectedItems.anchor),c=this.visibleCollection.indexOf(r),h=Math.min(n,l),p=Math.max(n,l),d=[],v=[],m;i?(m=this.options.getModelsBetweenPoints(i,r,this.options.parentModel,t),m&&m.length&&v.push.apply(v,m)):c<l?v.push.apply(v,this.visibleCollection.slice(c,l+1)):c>l&&v.push.apply(v,this.visibleCollection.slice(l+1,c+1)),this.options.parentGrid&&this.selectedItems.anchorParentModel!=this.options.parentModel&&(m=this.options.getModelsBetweenPoints(this.selectedItems.anchorParentModel,this.selectedItems.anchor,this.options.parentModel,t),m&&m.length&&(d.push.apply(d,m),h=0,p=-1)),h<=p&&d.push.apply(d,this.visibleCollection.slice(h,p+1)),this.selectedItems.remove(v),this.selectedItems.add(d);return}e.shiftKey||(this.selectedItems.anchor=t,this.selectedItems.anchorParentModel=this.options.parentModel),this.selectedItems.length&&(!this.options.allowMultiSelect||!e.metaKey&&!e.ctrlKey&&!e.shiftKey&&!this.options.multiSelect)?this.selectedItems.length>1||this.selectedItems.indexOf(t)==-1?this.selectedItems.reset(t,{removed:[].concat(this.selectedItems.models)}):this.selectedItems.reset([],{removed:[].concat(this.selectedItems.models)}):this.selectedItems.add(t)},handlePageElClick:function(e){if(!this.selectedItems.length||this.options.isParentGrid)return;var t=this.$el.parents(".card"),n=t.length?[t[0]]:[this.$el.parent()[0]],r=$(e.target),i=!0;this.options.dontDeselectFor&&(n=n.concat(this.options.dontDeselectFor));while(r.length){if(_.indexOf(n,r[0])!=-1){i=!1;break}if(n.length===1&&_.$one(r[0]).hasClass("grid-viewport")&&r[0]!=this.$viewport[0])break;r=r.parent()}i&&this.deselectItems({fromPageEvent:e})},deselectItems:function(e){var t=_.extend({removed:this.selectedItems.models},e);this.selectedItems.reset([],t),this.selectedItems.lastSelect=null,this.selectedItems.lastSelectParent=null},handleSelectStart:function(e){return e.preventDefault(),!1},handleResizeEvents:function(){var e=arguments[arguments.length-1],t=arguments.length>1?arguments[arguments.length-2]:null,n=t&&$(t)||$(e.currentTarget),r=n.parent(".grid-column"),i=r.next();switch(e.type){case"mousedown":n.data({resizeStart0:r.width(),resizeStart1:i.width(),resizeStartX:e.pageX}),_.$one(document).on("mousemove."+this.cid,_.bind(this.handleResizeEvents,this,e.currentTarget)),_.$one(document).on("mouseup."+this.cid,_.bind(this.handleResizeEvents,this,e.currentTarget)),_.$one(document).on("selectstart."+this.cid,_.bind(this.handleSelectStart,this));break;case"mousemove":var s=n.data();if(!s.resizeStart0)return;var o=e.pageX-s.resizeStartX,u=s.resizeStart0+o,a=s.resizeStart1-o,f=r.data(),l=i.data(),c=f&&f.minimumSize&&f.minimumSize-u,h=l&&l.minimumSize&&l.minimumSize-a,p=Math.max(0,c)||Math.min(0,h*-1);o+=p,r.width(s.resizeStart0+o),i.width(s.resizeStart1-o),this.writeCSS();break;case"mouseup":n.data("resizeStart0",null),_.$one(document).off("mousemove."+this.cid),_.$one(document).off("mouseup."+this.cid),_.$one(document).off("selectstart."+this.cid)}},onActiveSongChange:function(){}});var l={events:$.extend({},n.Views.Grid.prototype.events),defaults:$.extend({},n.Views.Grid.prototype.defaults,{canDragFrom:!1,canDragTo:!1,dropIndicatorType:"betweenRows",dropIsValid:null,acceptDrop:null,$dragListenOn:null,$dropListenOn:null}),initialize:function(){this._super.call(this,"initialize"),this.createDragListeners()},createDragListeners:function(e){var t=e||{};this.$dragListenOn=t.dragListenOn||this.options.dragListenOn||this.$el,this.$dropListenOn=t.dropListenOn||this.options.dropListenOn||this.$el,this.$dragListenOn.on("draginit."+this.cid,_.bind(this.handleDragInit,this)),this.$dragListenOn.on("dragstart."+this.cid,_.bind(this.handleDragStart,this)),this.$dragListenOn.on("drag."+this.cid,_.bind(this.handleDrag,this)),this.$dragListenOn.on("dragend."+this.cid,_.bind(this.handleDragEnd,this)),this.$dropListenOn.on("dropinit."+this.cid,_.bind(this.handleDropInit,this)),this.$dropListenOn.on("dropstart."+this.cid,_.bind(this.handleDropStart,this)),this.$dropListenOn.on("drop."+this.cid,_.bind(this.handleDrop,this)),this.$dropListenOn.on("dropend."+this.cid,_.bind(this.handleDropEnd,this))},onDestroy:function(){this._super.call(this,"onDestroy"),this.$dragListenOn.off("draginit."+this.cid),this.$dragListenOn.off("dragstart."+this.cid),this.$dragListenOn.off("drag."+this.cid),this.$dragListenOn.off("dragend."+this.cid),this.$dropListenOn.off("dropinit."+this.cid),this.$dropListenOn.off("dropstart."+this.cid),this.$dropListenOn.off("drop."+this.cid),this.$dropListenOn.off("dropend."+this.cid)},handleDragInit:function(e,t){var n=_.isFunction(this.options.canDragFrom)?this.options.canDragFrom.call(this):!!this.options.canDragFrom;if(!n||gsConfig.isMobile)return!1},handleDragStart:function(e,t){var r=$(e.target),i=0,s,o,u;r.hasClass("grid-item")||(r=r.parents(".grid-item")),s=r.data("module"),o=s.model,r.length&&this.selectedItems.indexOf(o)==-1&&r.click();if(!this.selectedItems.length||!r.length)return!1;t.draggedItemsContext=this.options.playContext,t.draggedItems=this.selectedItems.toArray(),t.draggedItemsSource=this.cid;var a=$('<div class="grid-drag-proxy"/>').mousewheel(_.globalDragProxyMousewheel);return u=this.selectedItems.indexOf(o),u>0&&(i=(u*this.options[this.axisTranslations.item]-1)*-1,a.css("top",i)),this.lastDragOffset=i*-1,this.itemsToDragProxy(t.draggedItems).done(function(e){typeof e=="string"?a.html(e):a.append(e),a.children(".module"),a.appendTo("body"),$("body").addClass("is-dragging"),n.trigger("drag:start",t)}),_.isFunction(this.options.handleDragStart)?this.options.handleDragStart.call(this,e,t,a):a},handleDrag:function(e,t){_.globalDragHandler(e,t)},handleDragEnd:function(e,t){_.globalDragCleanup(e,t),n.trigger("drag:end",t),_.isFunction(this.options.handleDragEnd)&&this.options.handleDragEnd.call(this,e,t)},handleDropInit:function(e,t){if(this.$el.hasClass("disable-drop"))return!1;e.currentTarget.updateDropOnDrag=_.bind(this.handleDragOver,this);if(_.isFunction(this.options.handleDropInit))return this.options.handleDropInit.call(this,e,t)},handleDropStart:function(e,t){var n=_.isFunction(this.options.canDragTo)?this.options.canDragTo.call(this,e,t):!!this.options.canDragTo;if(!n||!t.draggedItems||t.draggedItems.length===0)return delete e.currentTarget.updateDropOnDrag,!1;if(this.options.dropIndicatorType=="betweenRows"||this.options.dropIndicatorType=="rearrange"){var r={display:"none"};r[this.options.axis]=0,r[this.axisTranslations.dimension]=2,r[this.axisTranslationsAntonyms.dimension]=this.$canvas[this.axisTranslationsAntonyms.inner](),this.lastDropIndex=-1,this.$dropIndicator=$("<div class='grid-drop-indicator'/>").css(r).appendTo(this.$viewport)}},handleDragOver:function(e,t){var n=this.dropIsValid(e,t);this.$dropListenOn.data("valid-drop",n),this.updateDropIndicator(e,t,n)},dropIsValid:function(e,t){return _.isFunction(t.allowedToDropTo)&&!t.allowedToDropTo(this)?!1:_.isFunction(this.options.dropIsValid)?this.options.dropIsValid.call(this,e,t):!1},updateDropIndicator:function(e,n,r){var i="round";if(!r){this.lastDropIndex=-1,this.$dropIndicator&&this.$dropIndicator.hide();return}switch(this.options.dropIndicatorType){case"onRow":$(".grid-item.drop-active",this.$viewport).removeClass("drop-active"),$(".grid-item",this.$viewport).within(e.clientX,e.clientY-this.$scrollElement.scrollTop()).eq(0).addClass("drop-active");break;case"rearrange":i="floor";case"betweenRows":var s=0,o=this.visibleCollection.length,u=this.axisTranslations.direction,a;if(this.currentInsertIndex!==t)s=this.currentInsertIndex,delete this.currentInsertIndex;else{var f=_.getCombinedScrollValuesParents(this.$viewport),l=f.parents[0]&&f.parents[0].offset(),c=l||this.$viewport.offset();if(l){var h=_.getCombinedPositionToParent(this.$viewport,f.parents[0]);c.top+=h.top+f.top,c.left+=h.left+f.left}if(!this.options.variableItemsPerRow){var p="client"+this.options.axis.toUpperCase();a=e[p]-c[this.axisTranslations.direction]+f[this.axisTranslations.direction],this.lastDragOffset&&(a-=this.lastDragOffset),s=Math.max(0,Math.min(Math[i](a/this.options[this.axisTranslations.item]),o))}else{var d=Math.max(1,this.itemsPerRow),v=0,m=0;a=e.clientY-c.top+f.top,v=Math.max(0,Math[i](a/this.options.itemHeight)),a=e.clientX-c.left+f.left,m=Math.max(0,Math.min(d-1,Math[i](a/this.options.itemWidth))),s=Math.max(0,Math.min(d*v+m,o))}}_.each(this.dragRenderers,function(e){e.updateOnDrag()});if(s!==this.lastDropIndex){if(this.options.dropIndicatorType=="rearrange"&&n.draggedItemsSource==this.cid){var g=this.selectedItems.models.length,y=Math.max(0,Math.min(s,o-g)),b=y,w,E,S,x;this.lastDropIndex<b&&b++,w=this.renderers[b-this.lastScrollIndex],E=this.$viewport.find(".invisible"),S=E.first().data("module");if(w!==S){this.moveModels(this.selectedItems.models,b),n.lastMovedToIndex=b,E.removeClass("invisible");for(x=y-this.lastScrollIndex;x<Math.min(o,y+g)-this.lastScrollIndex;x++)this.renderers[x]&&this.renderers[x].$el.addClass("invisible")}}else this.$dropIndicator&&(this.$dropIndicator.css(u,s*this.options[this.axisTranslations.item]),this.$dropIndicator.show());this.lastDropIndex=s}}},handleDropEnd:function(e,t){switch(this.options.dropIndicatorType){case"onRow":this.$viewport.find(".grid-item.drop-active").removeClass("drop-active");break;case"betweenRows":case"rearrange":this.$dropIndicator&&(this.$dropIndicator.remove(),delete this.$dropIndicator)}},handleDrop:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=this.dropIsValid(e,t);if(!n||t.dropHandled)return;switch(this.options.dropIndicatorType){case"onRow":var r=$(".grid-item",this.$viewport).within(e.clientX,e.clientY-this.$scrollElement.scrollTop()).eq(0);if(r.length){var i=r.data("module");if(i&&i.acceptDrop(t)){t.dropHandled=!0;return}}}t.dropHandled=this.acceptDrop(t)},itemsToDragProxy:function(e){return _.globalItemsToDragProxy(e)},acceptDrop:function(e){return _.isFunction(this.options.acceptDrop)?this.options.acceptDrop.call(this,e):!1}},c;c=$.extend({},l),c.defaults.canDragFrom=!0,n.Views.DraggableGrid=n.Views.Grid.extend(c),c=$.extend({},l),c.defaults.canDragTo=!0,n.Views.DroppableGrid=n.Views.Grid.extend(c),c=$.extend({},l),c.defaults.canDragFrom=!0,c.defaults.canDragTo=!0,n.Views.DraggableDroppableGrid=n.Views.Grid.extend(c);var h=function(e,t){return t.draggedItemsSource==this.cid};n.Views.RearrangeableGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{canDragTo:h,dropIndicatorType:"rearrange"}),dropIsValid:h,allowedToDropTo:function(e,t){return e.draggedItemsSource==t.cid},itemsToDragProxy:function(e){var t=[],n=[],r=[],i=this.options.itemRenderer||{},s=i.prototype||{},o=s.className,u=this.options.addRowClass||"",a=$.Deferred(),f,l,c;for(var h=0,p=e.length;h<p;h++)l=$('<div class="'+o+' grabbing"></div>'),r.push(l),c=_.extend({},this.options.moduleOptions,{el:l,grid:this,model:e[h],addClass:u}),f=new i(c),n.push(f.renderDfd),t.push(f),f.render();return $.when(n).done(function(){a.resolve(r)}),this.dragRenderers?this.dragRenderers=this.dragRenderers.concat(t):this.dragRenderers=t,a.promise()},handleDragStart:function(e,t){var r=$(e.target);r.hasClass("grid-item")||(r=r.parents(".grid-item"));if(!r.length)return!1;var i=this;t.allowedToDropTo=function(e){return i.allowedToDropTo(this,e)};var s=n.Views.DraggableDroppableGrid.prototype.handleDragStart.call(this,e,t),o=r.offset(),u=$(document),a=u.scrollTop(),f=u.scrollLeft(),l=o.top-a,c=o.left-f,h=this.options.itemWidth||this.$el.width();s.addClass(this.$el[0].className).css("width",Math.floor(h)+"px"),t.proxyOffsetX=e.clientX-c,t.proxyOffsetY=e.clientY-l;var p=this.renderers,d=this.visibleCollection,v;return this.selectedItems.each(_.bind(function(e){v=d.indexOf(e)-this.lastScrollIndex,v>-1&&p[v].$el.addClass("invisible")},this)),s},handleDragEnd:function(e,t){return _.each(this.dragRenderers,function(e){e.destroy()}),this.$viewport.find(".invisible").removeClass("invisible"),n.Views.DraggableDroppableGrid.prototype.handleDragEnd.call(this,e,t)},handleDrop:function(e,r){if(h.call(this,e,r)){if(r.lastMovedToIndex===t)return;return this.handleMoved(this.selectedItems.models,r.lastMovedToIndex)}return n.Views.DraggableDroppableGrid.prototype.handleDrop.call(this,e,r)},handleMoved:function(e,t){if(_.isFunction(this.options.handleMoved))return this.options.handleMoved.call(this,e,t)},moveModels:function(e,t){this.collection.move(e,t)}});var p=function(e){var t=$(e.target);if(!t.is("a")&&!t.parents("a").length&&!t.is("i")&&!t.parents("i").length){e.preventDefault(),e.stopPropagation();var r=$(e.currentTarget),i=r.data("module"),s=i.model,o=this.options&&this.options.playContext||r.data("playContext"),u=r.data("streamType");u&&(u=u.split(",")),s instanceof n.Models.PlayableSong?s.playInQueue({context:o,playOnAdd:!0,streamTypes:u}):s?s.play({context:o,playOnAdd:!0,streamTypes:u}):console.log("Double click happened on",t[0],"but no model was found")}return!1},d=function(e){var t=$(e.currentTarget),r=t.data("songId"),i=n.Models.Song.getCached(r),s=t.closest(".grid-item"),o;return s&&s[0]&&(o={currentTarget:s[0]}),{songID:r,song:i,gridItem:s,$el:t,fakeEvent:o}},v=function(e){var t=d(e);t.song&&!t.song.get("fromLibrary")&&t.fakeEvent&&n.trigger("guts:logsearch","OLlibraryClick",this,t.fakeEvent)},m=function(e){var t=d(e);t.fakeEvent&&n.trigger("guts:logsearch","OLartistPageLoad",this,t.fakeEvent)},g=function(e){var t=d(e);t.fakeEvent&&n.trigger("guts:logsearch","OLalbumPageLoad",this,t.fakeEvent)},y=function(e){var t=d(e);t.fakeEvent&&n.trigger("guts:logsearch","OLsongPageLoad",this,t.fakeEvent)},b=function(e){try{var t=d(e),i=r.model.get("player").get("queue").get("songs").length;t.fakeEvent&&(i===0?n.trigger("guts:logsearch","OLplayButton",this,t.fakeEvent):n.trigger("guts:logsearch","OLaddButton",this,t.fakeEvent))}catch(s){console.log(s)}},w=function(e){var t=d(e);t.fakeEvent&&n.trigger("guts:logsearch","OLshareClick",this,t.fakeEvent)},E=function(e){var t=d(e);t.fakeEvent&&n.trigger("guts:logsearch","OLfavoriteClick",this,t.fakeEvent)},S=[{title:"",selector:".primary",minimumSize:60,visible:!1,resizable:!1},{title:"Song Name",selector:".module-row-cell.song",minimumSize:120,locale:"SONG_NAME",sortKey:"SongName"},{title:"Artist Name",selector:".artist",minimumSize:120,locale:"ARTIST_NAME",sortKey:"ArtistName"},{title:"Album Name",selector:".album",minimumSize:100,locale:"ALBUM_NAME",sortKey:"AlbumName"},{title:"Track",selector:".track-num",minimumSize:60,resizable:!1,locale:"TRACK",sortKey:"TrackNum",sortType:"number"},{title:"",selector:".secondary",minimumSize:95,visible:!1,resizable:!1}],x=S.slice(0,3).concat(S.slice(4)),T=S.slice(0,2).concat(S.slice(3)),N=S.slice(0),C=x.concat([]),k=T.concat([]),L=x.concat([]);C.splice(3,1),k.splice(3,1),N.splice(4,1),L.splice(2,1),n.Views.SongGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{getSortComparator:n.Models.Song.getLayeredSort,itemRenderer:n.Views.Modules.SongRow,itemHeight:51,itemsPerRow:1,allowMultiSelect:!0,showCount:!0,showTrackNum:!1,columns:S,playlist:!1}),handleItemClick:function(e){this._super("handleItemClick",e)},handleItemDblclick:p,onLibraryClick:v,onArtistLinkClick:m,onAlbumLinkClick:g,onSongLinkClick:y,onSongPlayClick:b,onSongShareClick:w,onSongFavoriteClick:E}),n.Views.SongGrid.columnsNoAlbum=x,n.Views.SongGrid.columnsNoArtist=T,n.Views.SongGrid.columnsNoTrack=N,n.Views.SongGrid.columnsNoAlbumTrack=C,n.Views.SongGrid.columnsNoArtistTrack=k,n.Views.SongGrid.columnsNoAlbumArtist=L,n.Views.SongGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{getSortComparator:n.Models.Song.getLayeredSort,itemRenderer:n.Views.Modules.SongRowTall,itemHeight:51,itemsPerRow:1,allowMultiSelect:!0,showCount:!0,showTrackNum:!1}),handleItemDblclick:p,onLibraryClick:v,onArtistLinkClick:m,onAlbumLinkClick:g,onSongLinkClick:y,onSongPlayClick:b,onSongShareClick:w,onSongFavoriteClick:E}),n.Views.SongGridBlock=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongCell,itemHeight:237,itemWidth:210,header:!1}),handleItemDblclick:p,onLibraryClick:v,onArtistLinkClick:m,onAlbumLinkClick:g,onSongLinkClick:y,onSongPlayClick:b,onSongShareClick:w,onSongFavoriteClick:E}),n.Views.CalloutGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.CalloutRow,itemHeight:51,itemsPerRow:1,allowMultiSelect:!1,header:!1}),handleItemClick:function(){},handleItemDblclick:function(e){$(e.currentTarget).closest(".module-row").hasClass("editing")||this._super("handleItemDblclick",e)}}),n.Views.AnalyticsDigestSongsGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.AnalyticsDigestSongRow,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.SongSuggestGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongRowBC,itemHeight:51,itemsPerRow:1,allowMultiSelect:!0,showCount:!0,isSuggestion:!0}),handleItemClick:function(e){this.options.isBroadcastOwner&&this._super("handleItemClick",e)},handleItemDblclick:p}),n.Views.AlbumGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{gridTypeClass:"grid-type-album",itemRenderer:n.Views.Modules.AlbumCellVertical,itemHeight:248,itemWidth:172,variableItemsPerRow:!0,header:!1})}),n.Views.AlbumGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.AlbumRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.ArtistAlbumGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistAlbumRow,variableSize:!0,itemHeight:160,itemsPerRow:1,header:!1,isParentGrid:!0})}),n.Views.AnalyticsAlbumGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.AnalyticsAlbumRow,variableSize:!0,itemHeight:100,itemsPerRow:1,allowMultiSelect:!1,header:!1,isParentGrid:!0}),handleItemDblclick:function(){}}),n.Views.AnalyticsSongGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.AnalyticsSongRow,itemHeight:42,itemsPerRow:1,allowMultiSelect:!1,header:!1,showTracks:!1}),handleItemClick:function(e){e.stopPropagation()},handleItemDblclick:function(){}}),n.Views.PromotionAlbumBlock=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.PromotionAlbumCell,itemHeight:178,itemsPerRow:3,header:!1})}),n.Views.PromotionSongBlock=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.SongCell,itemHeight:178,itemsPerRow:4,header:!1})}),n.Views.UserArtistGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{gridTypeClass:"grid-type-user-artist",itemRenderer:n.Views.Modules.UserArtistCell,itemHeight:90,itemWidth:300,variableItemsPerRow:!0,header:!1}),handleItemDblclick:function(){}}),n.Views.UserArtistVerticalGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{gridTypeClass:"grid-type-user-artist-vertical",itemRenderer:n.Views.Modules.UserArtistVerticalCell,itemWidth:165,variableItemsPerRow:!0,header:!1,variableSize:!0}),handleItemDblclick:function(){}}),n.Views.UserArtistOnboardingGrid=n.Views.UserArtistGrid.extend({defaults:$.extend({},n.Views.UserArtistGrid.prototype.defaults,{itemHeight:110,itemsPerRow:2,isOnboardingGrid:!0,variableItemsPerRow:!1})}),n.Views.ShareGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ShareRow,itemHeight:50,itemsPerRow:1,header:!1})}),n.Views.UserGridTall=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.UserRowTall,itemHeight:52,itemsPerRow:1,header:!1})}),n.Views.SuggestedUserGridTall=n.Views.UserGridTall.extend({defaults:$.extend({},n.Views.UserGridTall.prototype.defaults,{itemRenderer:n.Views.Modules.SuggestedUserRowTall,itemHeight:51})}),n.Views.MutualFriendGridTall=n.Views.UserGridTall.extend({defaults:$.extend({},n.Views.UserGridTall.prototype.defaults,{itemRenderer:n.Views.Modules.MutualFriendRow,itemHeight:64,showFavoriteBtn:!1})}),n.Views.BroadcastUserGridTall=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.UserRowTall,itemHeight:52,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.BroadcastUserGridMini=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.UserRowBCMini,itemHeight:50})}),n.Views.ArtistAlbumGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistAlbumRow,variableSize:!0,itemHeight:157,itemsPerRow:1,header:!1,isParentGrid:!0})}),n.Views.InviteUserGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.InviteUserRow,itemHeight:38,itemsPerRow:1,header:!1,allowMultiSelect:!0,cycleSelect:!0})}),n.Views.InviteUserGridCell=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.InviteUserCell,itemHeight:45,itemsPerRow:2,header:!1,multiSelect:!0,allowMultiSelect:!0})}),n.Views.BroadcastFriendUserGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastFriendUserCell,itemHeight:26,itemsPerRow:5,header:!1,multiSelect:!1,allowMultiSelect:!1,maximumVisibleItems:5})}),n.Views.AnalyticsDigestFansGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.AnalyticsDigestFanRow,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.StatisticsGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.StatisticRow,itemHeight:40,itemsPerRow:1,header:!1})}),n.Views.ArtistGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{gridTypeClass:"grid-type-artist",itemRenderer:n.Views.Modules.ArtistCell,allowMultiSelect:!1,itemHeight:332,itemWidth:300,variableItemsPerRow:!0,header:!1,editable:!1})}),n.Views.ArtistGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.ArtistSelectGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistSelectRow,itemHeight:51,itemsPerRow:1,header:!1}),handleContextMenuClick:function(){}}),n.Views.ArtistRelatedGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{gridTypeClass:"grid-type-artist-related",itemRenderer:n.Views.Modules.ArtistCell,allowMultiSelect:!1,forceAllItemsVisible:!0,itemHeight:260,itemWidth:300,itemsPerRow:2,variableItemsPerRow:!0,maximumVisibleRows:1,header:!1,editable:!1})}),n.Views.EditableArtistRelatedGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.RearrangeableGrid.prototype.defaults,{gridTypeClass:"grid-type-editable-artist-related",itemRenderer:n.Views.Modules.ArtistCell,allowMultiSelect:!1,forceAllItemsVisible:!0,itemHeight:260,itemWidth:300,itemsPerRow:2,variableItemsPerRow:!0,maximumVisibleItems:6,header:!1,editable:!0})}),n.Views.BroadcastRowTallGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastRowTall,itemHeight:67,itemsPerRow:1,header:!1,showCount:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.BroadcastGroupGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastGroupRow,variableSize:!0,itemHeight:129,itemsPerRow:1,header:!1,isParentGrid:!0})}),n.Views.BroadcastDateGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastDateRow,itemHeight:39,itemsPerRow:1,allowMultiSelect:!1,playlist:!1,handleItemClick:function(){},handleContextMenuClick:function(){}})}),n.Views.BroadcastHistorySongRowGrid=n.Views.SongGridTall.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongRowBC,itemHeight:51,itemsPerRow:1,header:!1,isHistory:!0,showCount:!0,allowMultiSelect:!0}),handleContextMenuClick:function(e){var t=$(e.currentTarget),n=t.data("module"),r=n.model;return r.get("isCallout")?!1:this._super.apply(this,["handleContextMenuClick"].concat(_.toArray(arguments)))}}),n.Views.BroadcastGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastCell,itemHeight:312,itemsPerRow:3,header:!1}),initialize:function(){this._super.call(this,"initialize"),this.collection.on("reset sort",_.bind(this.filterVisibleCollection,this))},filter:function(e){this.filterSearchText=_.orEqual(e,"").toLowerCase(),this.filterVisibleCollection()},filterByTag:function(e){this.filterTagID=e,this.filterVisibleCollection()},filterVisibleCollection:function(){var e={silent:!!this.filterTagID};this._super.apply(this,["filter",this.filterSearchText,e]),this.filterTagID&&this.visibleCollection.reset(this.visibleCollection.getForTag(this.filterTagID),{sorted:!0})}}),n.Views.BroadcastRowLargeGrid=n.Views.BroadcastGrid.extend({defaults:$.extend({},n.Views.BroadcastGrid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastRowLarge,itemHeight:180,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.BroadcastsGridMini=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastRowMini,itemHeight:25,itemsPerRow:1,dropIndicatorType:"onRow",header:!1}),dropIsValid:function(e,t){return!1},handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents(".scrollable"),i=r.data(n);return r&&(!i||t.drop!==i)&&r.data(n,t.drop),this._super("handleDropInit",e,t)}}),n.Views.UserSidebarGrid=n.Views.DroppableGrid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.SidebarUser,itemHeight:42,itemsPerRow:1,canDragTo:!0,dropIndicatorType:"onRow",header:!1,dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=["song","artist","album","playlist"];return t.draggedItems.length==1&&_.indexOf(n,t.draggedItemsType)!=-1}}),handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents(".scrollable"),i=r.data(n);return r&&(!i||t.drop!==i)&&r.data(n,t.drop),this._super("handleDropInit",e,t)}}),n.Views.PlaylistsGridMini=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.PlaylistRowMini,itemHeight:32,itemsPerRow:1,header:!1,dropIndicatorType:"onRow"}),dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=$(".grid-item",this.$viewport).within(e.clientX,e.clientY-this.$scrollElement.scrollTop()).eq(0);if(n.length&&t.draggedItemsType!=="broadcast"){var r=n.data("module").model;return r&&r.isEditable()?!0:!1}},handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents(".scrollable"),i=r.data(n);return r&&(!i||t.drop!==i)&&r.data(n,t.drop),this._super("handleDropInit",e,t)}}),n.Views.PlaylistGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.PlaylistRow,itemHeight:141,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleItemDblclick:function(){},handleContextMenuClick:function(){}}),n.Views.EventGridTall=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.EventRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.StationGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.StationRow,itemHeight:30,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){},handleItemDblclick:function(e){var t=$(e.currentTarget).data("tagId");n.Models.Tag.get(t).done(function(e){e.play()}),n.trigger("lightbox:close")}}),n.Views.TagGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.RearrangeableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.Tag,itemHeight:46,itemsPerRow:1,header:!1}),handleDragStart:function(e,t){return t.restrictXMovement=!0,n.Views.RearrangeableGrid.prototype.handleDragStart.apply(this,_.toArray(arguments))}}),n.Views.ThirdPartyLinkGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.RearrangeableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ThirdPartyLinkRow,itemHeight:46,itemsPerRow:1,header:!1}),handleDragStart:function(e,t){return t.restrictXMovement=!0,n.Views.RearrangeableGrid.prototype.handleDragStart.apply(this,_.toArray(arguments))},removeDeletedLink:function(e){this.collection.remove(e)},addNewLink:function(e){this.collection.add({type:e,url:""})}}),n.Views.ThemeGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ThemeCell,itemHeight:122,itemsPerRow:4,header:!1})}),n.Views.QueueGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongRowQueue,itemHeight:41,itemsPerRow:1,header:!1,dropIndicatorType:"rearrange",canDragTo:!0}),allowedToDropTo:function(e,t){return!0},dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);if(t.draggedItemsType==="song"&&t.draggedItems&&t.draggedItems.length){if(!this.isObjectDroppable(t.draggedItems[0]))return!1}else if(!this.isObjectDroppable())return!1;var n="client"+this.options.axis.toUpperCase(),r=this.axisTranslations.direction,i=e[n]-this.$viewport.offset()[r]+$(document).scrollTop();return this.lastDragOffset&&(i-=this.lastDragOffset),this.currentInsertIndex=Math.max(0,Math.min(Math.round(i/this.options[this.axisTranslations.item]),this.visibleCollection.length)),this.isObjectDroppable(this.visibleCollection.at(this.currentInsertIndex))?this.isPositionDroppable(this.currentInsertIndex):!1},isObjectDroppable:function(e){var t=this.model,r=t.get("queue"),i=r.get("activeSong"),s=r?r.get("currentBroadcast"):null,o=r?r.get("isBroadcasting"):!1,u=r&&!0;if(s&&!o)return!1;if(u&&o&&e){var a=i&&i.get("position"),f=i&&i.get("duration");s.get("listenersCount")>n.Models.Broadcast.LARGE_THRESHOLD&&r.get("nextSong")===e&&f&&f-a<n.Models.Broadcast.PREVENT_NEXT_POSITION?u=!1:e.get("broadcastPlayed")&&(u=!1)}return u},isPositionDroppable:function(e){var t=this.model.get("queue"),n=t?t.get("isBroadcasting"):!1;if(n&&_.isNumber(e)){var r=t.get("songs");if(r&&e<=r.lastIndexOf(t.get("activeSong")))return!1}return!0},handleDropInit:function(e,t){var r="dropinitScrollbarHandler",i=this.$el.parents("#queue"),s=i.data(r);return i&&(!s||t.drop!==s)&&i.data(r,t.drop),this.$dropListenOn.data("valid-drop",!1),n.Views.RearrangeableGrid.prototype.handleDropInit.call(this,e,t)},acceptDrop:function(e){function c(e){return function(r){l=o.get("songs").length?!1:!0,n.trigger("player:addSongs",r.toArray(),t+i,l,e),i++}}e.draggedItemsType=e.draggedItemsType||_.getCollectionType(e.draggedItems);var t=this.lastDropIndex,i=0,s=r.model.get("player"),o=s.get("queue"),u,a,f,l;switch(e.draggedItemsType){case"song":e.draggedItemsSource==this.cid?s.moveSongsTo(_.pluck(e.draggedItems,"id"),t):(l=o.get("songs").length?!1:!0,f={index:t,playOnAdd:l,context:e.draggedItemsContext},s.addSongsEx(e.draggedItems,f));break;case"tag":var h=e.draggedItems[0];r.playGenre(h.get("DisplayName"),h.get("TagID"));break;case"album":case"artist":case"playlist":for(u=0;u<e.draggedItems.length;u++)a=e.draggedItems[u],a.getSongs().then(c(new n.Models.PlayContext(a)));break;case"user":for(u=0;u<e.draggedItems.length;u++)a=e.draggedItems[u],_.isFunction(a.getFavorites)&&a.getFavorites("Songs").then(c(new n.Models.PlayContext(a)));break;default:return!1}return!0},moveModels:function(e,t){var n=r.model.get("player"),i=[];_.each(e,function(e){var t=e.get("queueSongID");i.push(t)}),n.moveSongsTo(i,t,{dragging:!0})},handleMoved:function(e,t){var n=r.model.get("player"),i=[];_.each(e,function(e){var t=e.get("queueSongID");i.push(t)}),n.moveSongsTo(i,t)}}),n.Views.EditableFeaturedSongsGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.RearrangeableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.RowSongSelector,allowMultiSelect:!1,itemHeight:46,itemsPerRow:1,header:!1}),initialize:function(){var e=this.collection;e.on("change:song",function(t,n){var r=e.length-1;if(n){var i=e.indexOf(t);if(i===0)return;for(r=i-1;r>=0;r--)if(e.at(r).get("song")){r++;break}if(r==i)return}e.move(t,r)}),this._super.call(this,"initialize")},onDestroy:function(){this.collection.off(null,this,this),this._super.call(this,"onDestroy")}}),n.Views.EditableAlbumSongsGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.RearrangeableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.EditableAlbumSongRow,allowMultiSelect:!1,itemHeight:51,itemsPerRow:1,forceAllItemsVisible:!0,header:!1}),initialize:function(e){var t=e.songs.map(function(e){return{song:e,SongName:e.get("SongName"),TrackNum:e.get("TrackNum"),Flags:e.get("Flags"),Tags:e.get("Tags")}});this.collection=new Backbone.Collection(t),this.collection.comparator="TrackNum",this.collection.sort(),this.collection.on("change:TrackNum",this.collection.sort,this.collection),this.collection.on("move",this.updateTrackNumOnMove,this),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},updateTrackNumOnMove:function(e,t,n){var r=t[0],i=e.at(n-1),s=e.at(n+1),o=r.get("TrackNum"),u=i&&i.get("TrackNum"),a=s&&s.get("TrackNum");if(u&&u>o){r.set("TrackNum",u),i.set("TrackNum",o);return}if(a&&a<o){r.set("TrackNum",a),s.set("TrackNum",o);return}}}),n.Views.ArtistsGridMini=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistRowMini,itemHeight:30,itemsPerRow:1,allowMultiSelect:!0,header:!1})}),n.Views.GenreDropdownGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.GenreDropdownRow,itemHeight:44,itemsPerRow:1,header:!1}),initialize:function(e){var t=e.tags.map(function(e){return{TagID:e.get("TagID"),Tag:e.get("Tag")}});if(e.minimum)while(t.length<e.minimum)t.push({TagID:0,Tag:"---"});this.collection=new Backbone.Collection(t),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.ProfileSectionGrid=n.Views.RearrangeableGrid.extend({defaults:$.extend({},n.Views.RearrangeableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ProfileSection,allowMultiSelect:!1,itemHeight:294,itemsPerRow:1,forceAllItemsVisible:!0,header:!1}),initialize:function(e){this.collection=new Backbone.Collection(e.sections||[0,1,2,3]),this.saveSectionOrder=e.saveCallback||function(){},this.collection.on("move",this.saveSectionOrder,this),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.TagRowSimpleGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.TagRowSimple,itemHeight:38,itemsPerRow:1,header:!1})})})();var n=typeof n!="undefined"?n:{};(function(){n.Views=n.Views||{};var i=function(e){var t=document.createElement("div").style,n=["ms","Webkit","Moz","O"],r=n.length,i,s;if(e in t)return e;while(r--){i=n[r]+e;if(i in t){s=i;break}}return s},s=Backbone.Model.extend({className:"list",defaults:{maxRenderableItems:Infinity},initialize:function(e,t){this.options=t,this.set({collection:t.collection||new Backbone.Collection([]),renderableItems:new t.collection.constructor(t.collection.models),selectedItems:new t.collection.constructor([]),maxRenderableItems:t.maxRenderableItems||this.defaults.maxRenderableItems,maxRenderedViews:0,visibleItems:null,views:new Backbone.Collection([]),listInnerTop:0})}});n.Views.List=Backbone.View.extend({defaults:{view:null,viewOptions:{},itemBuffer:30,pixelBuffer:100,selectableItems:!1,contextmenu:!0},events:{"click .module":"onItemClickProxy","dblclick .module":"onItemDblClick","contextmenu .module":"onContextMenuClick"},initialize:function(e){var t;return _.defaults(this.options,this.defaults),this.model=new s({},e),this.transformsProp=i("Transform"),this.calcMaxRenderedViews(),this.rendered=!1,this.firstItemIndex=0,this.$scrollEl=$(e.scrollEl||document),this.$listInner=$('<div class="list-inner"></div>'),this.$el.append(this.$listInner),(this.options.showCount||this.options.showTrackNum)&&this.$el.addClass("show-row-numbers"),t=this.model.get("collection"),this.model.set({visibleItems:new e.collection.constructor(_.take(e.collection.models,Math.min(this.model.get("maxRenderedViews"),this.model.get("maxRenderableItems"))))}),this.listenTo(n,"page:redrawUpdate",this.onPageRedrawUpdate),this.listenTo(n,"app:resize",this.onResize),this.listenTo(this.model,"change:maxRenderableItems",this.onMaxRenderableItemsChange),this.listenTo(this.model,"change:maxRenderedViews",this.onRenderedViewsChange),this.listenTo(this.model,"change:listInnerTop",this.repositionListInner),this.listenTo(t,"add",this.onCollectionAdd),this.listenTo(t,"remove",this.onCollectionRemove),this.listenTo(t,"reset",this.onCollectionReset),this.listenTo(this.model.get("renderableItems"),"add remove reset sort",this.onRenderableItemsChange),this.listenTo(this.model.get("visibleItems"),"reset",this.onVisibleItemsChange),this.listenTo(this.model.get("selectedItems"),"add",this.onSelectedItemsAdd),this.listenTo(this.model.get("selectedItems"),"remove",this.onSelectedItemsRemove),this.listenTo(this.model.get("selectedItems"),"reset",this.onSelectedItemsReset),this.onResize(),$("#page-inner").on("click."+this.cid,_.bind(this.onPageInnerClick,this)),this.onRenderableItemsChange(),this.collection=this.model.get("collection"),this.visibleCollection=this.model.get("renderableItems"),this.selectedItems=this.model.get("selectedItems"),Backbone.View.prototype.initialize.apply(this,_.toArray(arguments))},onDestroy:function(){$("#page-inner").off("click."+this.cid),this.$scrollEl.off("scroll."+this.cid)},render:function(){return this.renderDfd=$.Deferred(),this.viewEls=[],this.precacheTemplate().done(_.bind(function(e){this.onRenderableItemsChange(),this.viewTemplate=e,this.renderViewHtml()},this)),this.renderDfd.promise()},precacheTemplate:function(){var e=this.options.view,t=this.options.view.precacheTemplate(e);return t},renderViewHtml:function(){if(!this.viewTemplate)return;var e=this.options.view.prototype.className,t=this.model.get("visibleItems"),n=this.model.get("views"),r=t.length-n.length,i=t.takeRight(r),s=[],o,u;_.each(i,_.bind(function(t){u=this.renderTemplate(_.bind(this.viewTemplate,{model:t})),s.push('<div class="'+e+'">'+u+"</div>")},this)),o=$(s.join("")),this.$listInner.append(o),this.viewEls=this.viewEls.concat(o.toArray()),this.makeViews(i,o)},makeViews:function(e,t){var n=this.model.get("views"),r=this.model.get("visibleItems"),i=[],s,o;_.each(e,_.bind(function(e,n){o=_.extend({},{model:e,el:t[n],list:this},this.options.viewOptions),s=new this.options.view(o),i.push(new Backbone.Model({view:s})),s.completeRender(this.viewTemplate,{skiptHTML:!0})},this)),n.add(i),this.rendered=!0,this.renderDfd.resolve(),this.trigger("rendered")},onItemClickProxy:function(e){var t=$(e.currentTarget).data("module");if(!this.lastClick||this.lastClick[0]!=t||e.timeStamp-this.lastClick[1]>300)this.lastClick=[t,e.timeStamp],this.onItemClick(e)},onItemClick:function(e){var t=$(e.target),n=this.model.get("selectedItems"),r=this.model.get("renderableItems"),i,s,o,u,a;if((t.is("a, i, input")||!this.options.selectableItems||t.parents("a").length)&&!e.metaKey&&!e.shiftKey&&!e.ctrlKey)return;e.preventDefault(),t.hasClass("module")?i=t:i=t.closest(".module"),s=i.data("module").model,this.selectAnchor||(this.selectAnchor=s),!this.options.multiSelectDefault&&(e.metaKey||e.ctrlKey)?n.indexOf(s)>-1?(n.remove(s),this.selectAnchor=null):(n.add(s),this.selectAnchor=s):e.shiftKey?(o=r.indexOf(this.selectAnchor),u=r.indexOf(s),u<o?a=r.slice(u,o):a=r.slice(o,u+1),n.add(a)):(this.selectAnchor=s,n.reset([s]))},onContextMenuClick:function(e){if(!this.options.contextmenu)return;var t=$(e.currentTarget),i=t.data("module"),s=i.model,o=this.model.get("selectedItems"),u={},a,f,l,c,h;if(e.target.nodeName=="INPUT")return;(!o.length||o.indexOf(s)==-1)&&this.onItemClick(e),l=o.length;if(t.hasClass("song"))h="Song";else if(t.hasClass("queue-item"))c="Song",h="PlayableSong";else if(t.hasClass("artist"))h="Artist";else if(t.hasClass("album"))h="Album";else if(t.hasClass("playlist"))h="Playlist";else{if(!t.hasClass("user"))return!1;h="User"}c=c||h,this.options.playContext&&(u.playContext=this.options.playContext);if(this.contextMenuExtra||this.options.contextMenuExtra)u=_.extend(u,this.contextMenuExtra?this.contextMenuExtra:this.options.contextMenuExtra);if(l==1){if(h=="PlayableSong"||u.source=="nowPlaying"){u.isQueue=!0,u.queueSongClickedID=s.get("queueSongID"),u.queueSongClickedQueueSongID=s.get("queueSongID"),u.autoplay=r.model.get("player").get("autoplay");function p(){n.trigger("player:removeSongs",[s])}u.onRemoveFromQueue=p}if(!s)return!1;this.options.playlist&&(u.playlist=this.options.playlist,u.playlistSongID=s.get("playlistSongID")),f="getContextMenuFor"+c,a=s}else if(h=="Song"){this.options.playContext&&this.options.playContext.type=="playlist"&&(u.playlist=this.options.playlist,u.playlistSongIDS=o.pluck("playlistSongID"));if(u.source=="nowPlaying"){var d=o.toArray();function v(){n.trigger("player:removeSongs",d)}u.onRemoveFromQueue=v}f="getMultiContextMenuFor"+c+"s",a=o.toArray()}var m=_.extend({show:"show",className:"contextmenu",shouldLog:!0,contextMenu:!0,ev:e},u);return _.asyncTooltipMenu(t,m,a,f),!1},onPageInnerClick:function(e){var t=$(e.target);!t.closest(this.$el[0]).length&&!t.closest(".grid-toolbar-container").length&&(this.model.get("selectedItems").reset([]),this.selectAnchor=null)},onSelectedItemsAdd:function(e){e.trigger(this.cid+":select")},onSelectedItemsRemove:function(e){e.trigger(this.cid+":deselect")},onSelectedItemsReset:function(e,t){var n=t&&t.removed;n||(n=_.difference(t.previousModels,e.models)),n.length&&_.each(n,_.bind(this.onSelectedItemsRemove,this)),e.length&&e.each(_.bind(this.onSelectedItemsAdd,this))},setupScrollableList:function(){this.setListHeight(),this.lastScrollPos=this.$scrollEl.scrollTop(),this.scrollDir=null,this.offset=this.$el.offset().top,this.$scrollEl[0]==document?this.listenTo(n,"scroll",_.bind(this.onScroll,this,null)):this.$scrollEl.on("scroll."+this.cid,_.bind(this.onScroll,this)),this.scrollable=!0,this.onScroll()},filter:function(e,t){var n=_.orEqual(e,"").toLowerCase(),r=_.defaults(_.orEqual(t,{}),{sorted:!0,src:"collection"}),i;_.isFunction(r.filterFunction)?i=this[r.src].filter(r.filterFunction):i=this.model.get("collection").filter(function(e){var t=e.get("searchText");return t&&t.indexOf(n)>-1}),this.model.get("renderableItems").reset(i,r)},sort:function(e,t,r,i){var s=this.model.get("collection"),o=this.model.get("renderableItems");if(i){i.songStats.sort(function(e,t){return i.sortKey===i.lastMetric&&!i.reversed?_.toInt(e[i.sortKey])-_.toInt(t[i.sortKey]):_.toInt(t[i.sortKey])-_.toInt(e[i.sortKey])}),i.gridOptions.selectedStatColumn=i.columnSelected;var u=new n.Models.Collections.Songs(i.songStats);s.reset(u.models),i.filterVal&&this.filter(i.filterVal),_.each(this.renderers,function(e){e.handleModelChange()}),i.sortKey===i.lastMetric&&!i.reversed?this.options.reversed=!0:this.options.reversed=!1,this.options.lastMetric=i.sortKey;return}if(_.isArray(e)){o.comparator=null,this.lastSortKey=null,o.reset(e,{sorted:!0});return}if(_.isFunction(e)){this.lastSortKey===e&&this.lastSortDir==t&&(t=t=="asc"?"desc":"asc",e=function(e){return function(t,n){return-1*e(t,n)}}(e)),o.comparator=e,o.sort({sorted:!0}),this.lastSortKey=e,this.lastSortDir=t;return}t||(this.lastSortKey!=e?t=r||"asc":this.lastSortDir?t=this.lastSortDir=="desc"?"asc":"desc":t="asc");if(e==="default"){o.comparator=null;var a=_.intersection(s.models,o.models);t!==r&&a.reverse(),o.reset(a,{sorted:!0}),this.lastSortKey=e,this.lastSortDir=t;return}var f=t=="asc"?1:-1,l=t=="asc"?-1:1,c=this.options.sortType;!c&&e=="TrackNum"?c="number":!c&&e=="TSAdded"&&(c="date");var h=function(t,n){var r=t.get(e),i=n.get(e);return _.isString(r)&&(r=r.toLowerCase()),_.isString(i)&&(i=i.toLowerCase()),r>i?f:l},p=function(t,n){var r=t.get(e),i=n.get(e);return r=_.toInt(r),i=_.toInt(i),r>i?f:l},d=function(t,n){var r=t.get(e),i=n.get(e);return r<i?f:l},v=null;this.options.getSortComparator&&(v=this.options.getSortComparator(e,t=="asc")),v?o.comparator=v:c=="number"?o.comparator=p:c=="date"?o.comparator=d:o.comparator=h,this.lastSortKey=e,this.lastSortDir=t,o.sort({sorted:!0})},removeScrollableEvents:function(){this.scrollDir=null,this.stopListening(n,"scroll"),this.$scrollEl.off("scroll."+this.cid),this.scrollable=!1,this.onScroll()},setListHeight:function(){this.$el.css({height:this.options.itemHeight*Math.min(this.model.get("maxRenderableItems"),this.model.get("renderableItems").length)}),this.onScroll(),this.trigger("resized")},onPageRedrawUpdate:function(){this.offset=this.$el.offset().top,this.onScroll()},onResize:function(){this.windowHeight=$(e).height(),this.calcMaxRenderedViews()},calcMaxRenderedViews:function(){this.model.set("maxRenderedViews",Math.ceil($(e).height()/this.options.itemHeight+this.options.itemBuffer))},onMaxRenderableItemsChange:function(){var e=this.model.get("maxRenderableItems"),t=this.model.get("collection"),n=this.model.get("renderableItems");n.reset(t.take(e))},onRenderedViewsChange:function(){var e=this.model.get("views").length,t=this.model.get("maxRenderedViews");e<t&&this.updateVisibleItems()},onScroll:function(e){if(!this.rendered||!this.scrollable)return;var n=e!==t,r=_.orEqual(e,$(document).scrollTop()),i=r-this.offset,s=this.$listInner.height(),o=this.$el.height(),u=this.model.get("listInnerTop"),a=u+s,f=0,l=o-s,c;n?(this.scrollDir=r>this.lastScrollPos?"down":"up",this.scrollDir==="down"&&i+this.windowHeight>=a-this.options.pixelBuffer?c=Math.min(i-this.options.pixelBuffer,l):i<=u+this.options.pixelBuffer&&i>0?c=Math.max(i+this.windowHeight+this.options.pixelBuffer-s,f):i<=0&&(c=0),this.lastScrollPos=r):c=Math.max(Math.min(i-this.options.pixelBuffer,l),f),_.defined(c)&&c!==u&&(this.firstItemIndex=Math.ceil(c/this.options.itemHeight),c=this.firstItemIndex*this.options.itemHeight,this.model.set("listInnerTop",c))},repositionListInner:function(){var e=this.model.get("listInnerTop");this.transformsProp?this.$listInner.css(this.transformsProp,"translateY("+e+"px)"):this.$listInner.css("top",e),this.updateVisibleItems()},onCollectionAdd:function(e,t,n){var r=this.model.get("renderableItems");r.length<this.model.get("maxRenderableItems")&&r.add(e)},onCollectionRemove:function(e){this.model.get("renderableItems").remove(e)},onCollectionReset:function(e){this.model.get("renderableItems").reset(_.take(e.models,this.model.get("maxRenderableItems")))},onRenderableItemsChange:function(){var e=Math.min(this.model.get("maxRenderableItems"),this.model.get("renderableItems").length)>this.model.get("maxRenderedViews");this.updateVisibleItems(),e&&!this.scrollable?this.setupScrollableList():!e&&this.scrollable&&this.removeScrollableEvents(),this.setListHeight()},updateVisibleItems:function(){var e=this.model.get("renderableItems"),t=this.model.get("visibleItems"),n=Math.max(this.model.get("views").length,Math.min(this.model.get("maxRenderedViews"),this.model.get("maxRenderableItems"))),r=e.slice(this.firstItemIndex,this.firstItemIndex+n);t.reset(r)},onVisibleItemsChange:function(){var e=this.model.get("visibleItems"),t=this.model.get("views"),n;e.length>t.length&&this.renderViewHtml(),this.model.get("views").each(function(t,r){n=e.at(r),n?(t.get("view").changeModel(n),t.get("view").show()):t.get("view").hide()}),this.setListHeight()}}),n.Views.DraggableList=n.Views.List.extend({events:$.extend({},n.Views.List.prototype.events,{draginit:"onDragInit",dragstart:"onDragStart",drag:"onDrag",dragend:"onDragEnd"}),onDragInit:function(e,t){var n=_.isFunction(this.options.canDragFrom)?this.options.canDragFrom.call(this):!!this.options.canDragFrom;if(!n||gsConfig.isMobile)return!1},onDragStart:function(e,t){var r=$(e.target),i=0,s=this.model.get("selectedItems"),o=$('<div class="grid-drag-proxy" style="pointer-events: none"/>').mousewheel(_.globalDragProxyMousewheel),u,a,f,l;return r.hasClass("module")?u=r:u=r.closest(".module"),a=u.data("module"),f=a.model,u.length&&s.indexOf(f)==-1&&u.trigger("click"),t.draggedItemsContext=this.options.playContext,t.draggedItems=s.toArray(),t.draggedItemsSource=this.cid,l=s.indexOf(f),l>0&&(i=(l*this.options.itemHeight-1)*-1,o.css("top",i)),this.lastDragOffset=i*-1,this.itemsToDragProxy(t.draggedItems).done(function(e){typeof e=="string"?o.html(e):o.append(e),o.appendTo("body"),n.trigger("drag:start",t)}),_.isFunction(this.options.handleDragStart)?this.options.handleDragStart.call(this,e,t,o):o},onDrag:function(e,t){_.globalDragHandler(e,t)},onDragEnd:function(e,t){_.globalDragCleanup(e,t),n.trigger("drag:end",t),_.isFunction(this.options.handleDragEnd)&&this.options.handleDragEnd.call(this,e,t)},itemsToDragProxy:function(e){return _.globalItemsToDragProxy(e)}});var o=function(e){var t=$(e.target);if(!t.is("a")&&!t.parents("a").length&&!t.is("i")&&!t.parents("i").length){e.preventDefault(),e.stopPropagation();var r=$(e.currentTarget),i=r.data("module"),s=i.model,o=this.options&&this.options.playContext||r.data("playContext"),u=r.data("streamType");u&&(u=u.split(",")),s instanceof n.Models.PlayableSong?s.playInQueue({context:o,playOnAdd:!0,streamTypes:u}):s.play({context:o,playOnAdd:!0,streamTypes:u})}return!1};n.Views.SongRowTallList=n.Views.DraggableList.extend({defaults:$.extend({},n.Views.List.prototype.defaults,{view:n.Views.Modules.SongRowTall,itemHeight:51,header:!1,canDragFrom:!0,selectableItems:!0}),onItemDblClick:o}),n.Views.CalloutList=n.Views.List.extend({defaults:$.extend({},n.Views.List.prototype.defaults,{view:n.Views.Modules.CalloutRow,itemHeight:51,selectableItems:!1,contextmenu:!1}),onItemDblClick:function(e){$(e.currentTarget).closest(".module-row").hasClass("editing")||this._super("onItemDblClick",e)}}),n.Views.UserRowTallList=n.Views.List.extend({defaults:$.extend({},n.Views.List.prototype.defaults,{view:n.Views.Modules.UserRowTall,itemHeight:52})}),n.Views.SuggestedBroadcastsList=n.Views.List.extend({defaults:$.extend({},n.Views.List.prototype.defaults,{view:n.Views.Modules.SuggestedBroadcastRow,itemHeight:43,allowMultiSelect:!1,selectableItems:!1,header:!1})})})(),function(){n.Views=n.Views||{},n.Views.GridToolbar=Backbone.View.extend({templatePath:"shared",ui:{toolbarInner:".grid-toolbar-inner",addDropdown:".add-dropdown",deleteButton:".delete-button"},events:{"click .btn":"onButtonClick","click .play-button":"onPlayClick","click .play-toolbar-dropdown":"onPlayDropdownClick","click .suggest-button":"onSuggestClick","click .add-button":"onAddClick","click .add-menu":"onAddMenuClick","click .sort-button":"onSortClick","click .edit-button":"onEditClick","click .playlist-new-button":"newPlaylist","keyup input.filter":"onFilterChange","submit form.search-bar":"onFilterSubmit","click .search-bar":"onSearchBarClick","click input.filter":"onFilterClick","click .clear-filter":"onClearFilterClick","focus input.search":"onFilterFocus","blur input.search":"onFilterBlur","click @deleteButton":"onDeleteClick","click .merge-button":"onMergeClick","click .invite-friends":"onInviteFriendsClick","click .btn-nav-switch":"onPageNavSwitchClick","click @addDropdown":"onAddDropdownClick","click .popular-range":"onPopularRangeClick"},initialize:function(e){this.$el._isSticky=!1,this.gridView=this.options.gridView||this.options.listView||[],_.isArray(this.gridView)||(this.gridView=[this.gridView]),this.page=this.options.page,this.playContext=this.options.playContext,this.playOptions=this.options.playOptions||{},this.titleLocale=this.options.titleLocale||"",this.buttons={},_.isFunction(this.options.onButtonClick)&&(this.onButtonClick=this.options.onButtonClick),this.popularTimeRange=this.options.popularTimeRange,this.lastSort={type:this.page!="album"?"original":"track",dir:"asc"};switch(this.page){case"playlist":this.lastSort.label="PLAYLIST_ORDER";break;case"playlists":case"subscribedPlaylists":this.lastSort.label="PLAYLIST_LAST_EDITED_2";break;case"artist":this.lastSort.label="POPULARITY";break;case"album":this.lastSort.label="TRACK_NUM";break;case"tag":case"search":this.lastSort.label="RELEVANCE";break;case"userMusic":case"userMusicFavorites":this.lastSort.label="DATE_ADDED";break;case"dashboardAlbums":this.lastSort.label="PLAYS";break;default:this.lastSort.label=""}var t=this.options.buttons,i,s;for(i=0,s=t.length;i<s;i++)typeof t[i]=="object"?this.buttons[t[i].name]=t[i].value:this.buttons[t[i]]=!0;(this.buttons.sort||this.buttons.filterSearch)&&this.changeGridView(this.gridView),this.buttons.btnGroupNav&&(this.btnGroupNavInfo=this.options.btnGroupNavInfo),this.buttons.primaryBtnGroupNav&&(this.primaryBtnGroupNavInfo=this.options.primaryBtnGroupNavInfo),this.buttons.dropdown&&(this.dropdownItems=this.options.dropdownItems),this.setCSSdelayed=_.bind(function(){setTimeout(_.bind(this.setCSS,this),200)},this),this.$scrollElem=$(document),gsConfig.isMobile||this.listenTo(n,"scroll sidebar:opened sidebar:closed",this.handleScroll),this.listenTo(r.model,"change:appSize",this.setCSSdelayed),this.listenTo(r.model.get("player"),"change:queue",this.onQueueChange),this.onQueueChange(),n.on("page:redrawUpdate",this.calculateOffsetPosition,this),n.on("manatee:broadcastEnded",this.onBroadcastEnded,this);for(i=0,s=this.gridView.length;i<s;i++)this.gridView[i].on("rendered resized",_.bind(this.calculateOffsetPosition,this));return Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){for(var e=0,t=this.gridView.length;e<t;e++)this.gridView[e].off("resized",null,this);this.changeGridView(),this.gridView=[],this.$scrollElem&&this.$scrollElem.off("scroll."+this.cid),n.off("page:redrawUpdate",null,this),n.off("manatee:broadcastEnded",null,this)},changeGridView:function(e,t){t||this.clearFilter();var r,i,s;for(r=0,i=this.gridView.length;r<i;r++)s=this.gridView[r],s.selectedItems.off(null,null,this),s.visibleCollection.off(null,null,this),s.collection.off(null,null,this),s.off(null,null,this);if(e){this.currentOrder=[],_.isArray(e)||(e=[e]),this.gridView=e;for(r=0,i=this.gridView.length;r<i;r++)s=this.gridView[r],this.currentOrder.push(new s.collection.constructor(s.collection.models)),s.selectedItems.on("add remove reset",this.updateSelectionCount,this),s.visibleCollection.on("add remove reset sort",this.updateSortLabel,this),s.collection.on("add remove reset",this.updatePlayButton,this),s.on("resized",function(){n.trigger("page:resize")},this);this.updateSelectionCount(),this.updateSortLabel()}this.onFilterChange()},render:function(){return this.fetchTemplate("gridToolbar").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e,this)),this.buttons.tagDropdown&&(this.tagDropdown=new n.Views.Modules.TagDropdown({el:this.$el.find(".module.tag-dropdown")[0],tooltipKey:"tag-tooltip",onSelection:_.bind(this.onTagFilterChange,this),defaultTagName:_.getString("SEE_ALL_GENRES").toLowerCase()}),this.tagDropdown.render(),this.childViews.push(this.tagDropdown)),this.buttons.dropdown&&(this.dropdown=new n.Views.Dropdown({el:this.$el.find(".module.dropdown")[0],items:this.dropdownItems,tooltipOptions:{tooltipKey:"grid-toolbar-dropdown"},onSelect:this.options.dropdownSelect||function(){}}),this.dropdown.render(),this.childViews.push(this.dropdown)),this.buttons.nameFilter&&(this.nameFilter=new n.Views.NameFilterDropdown(_.defaults(this.options.nameFilterOptions,{el:this.$el.find(".name-filter")[0],collection:this.gridView[0].collection,tooltipOptions:{tooltipKey:"grid-toolbar-name-filter"},titleAttribute:"SongName",showItemCounts:!1,defaultItem:null,onSelect:_.bind(this.onNameFilterChange,this)})),this.nameFilter.render(),this.childViews.push(this.nameFilter),this.filteredName=!1,this.nameFilterAttribute=this.nameFilter.options.titleAttribute),this.bindUIElements(),this.updateSortLabel(),this.trigger("rendered"),this.calculateOffsetPosition(),this.trigger("rendered"),this.rendered=!0,this.updatePlayButton()},onQueueChange:function(){var e=r.model.get("player"),t=e.get("queue"),n=e.previous("queue");n&&this.stopListening(n.songs),this.listenTo(t.songs,"change reset",this.updatePlayButton),this.updatePlayButton()},updatePlayButton:function(){var e,t,n,i;if(!this.rendered)return;e=r.model.get("player").get("queue"),t=e.songs.length,n=this.getRelevantModels("song").models,i=!t&&n&&n.length===1,this.ui.$toolbarInner.toggleClass("single-item",i)},onTagFilterChange:function(e){e===this.tagDropdown.options.defaultTagName&&(e=!1);for(var t=0,n=this.gridView.length;t<n;t++)this.gridView[t].filterByTag(e)},onNameFilterChange:function(e){this.filteredName=e,this.gridView[0].filter(e||"",{filterAttribute:this.nameFilterAttribute})},calculateOffsetPosition:function(){this.$el._isSticky||(this.offset=this.$el.offset().top),this.gridScrollBottom=0;if(this.gridView&&this.gridView.length)for(var e=this.gridView.length;e>0;e--)if(this.gridView[e-1].$el.is(":visible")){this.gridScrollBottom+=this.gridView[e-1].$el.offset().top+this.gridView[e-1].$el.height()-this.$el.height();break}},onBroadcastEnded:function(){this.$(".suggest-button").addClass("hide"),this.$("li>.add-menu").addClass("hide"),this.$(".play-btn").removeClass("hide"),this.$(".add-button").removeClass("hide"),this.$(".btn-group>.add-menu").removeClass("hide")},updateSelectionCount:function(){var e=this.$(".add-label"),t=this.$(".play-label"),n=this.$(".edit-label"),r=this.$(".delete-label"),i=this.$(".merge-label"),s=0,o,u,a,f,l,c,h,p,d;for(var v=0,m=this.gridView.length;v<m;v++)s+=this.gridView[v].selectedItems.length;c=s?" ("+s+")":"",s?(h="EDIT_COUNT",p="REMOVE_COUNT",d="MERGE_COUNT",o=_.getString("ADD"),u=_.getString("PLAY")):(h="EDIT_ALL",p=r.data("defaultLocale")||"REMOVE_ALL",d="MERGE",o=_.getString("ADD_ALL"),u=_.getString("PLAY_ALL")),a=_.getString(h,{count:s}),f=_.getString(p,{count:s}),l=_.getString(d,{count:s}),e.text(o+c),e.attr("data-translate-text",o),t.text(u+c),t.attr("data-translate-text",u),n.text(a),n.data({translateText:h,count:s}),r.text(f),r.data({translateText:p,count:s}),i.text(l),i.data({translateText:d,count:s}),c?($(".delete-button.hide").removeClass("hide").addClass("show"),$(".suggest-button").removeClass("disabled")):($(".delete-button.show").addClass("hide").removeClass("show"),$(".suggest-button").addClass("disabled"))},updateSortLabel:function(){if(this.gridView&&this.gridView[0]&&!this.bypassGridSort)switch(this.gridView[0].lastSortKey){case"SongName":this.lastSort.label="SONG";break;case"ArtistName":this.lastSort.label="ARTIST";break;case"AlbumName":this.lastSort.label="ALBUM";break;case"TrackNum":this.lastSort.label="TRACK_NUM"}var e=$(".sort-label"),t=this.lastSort.label;e.attr("data-translate-text",t),e.text(_.getString(t))},clearFilter:function(){this.$el.find(".filter").val("").parent(".search-bar").removeClass("has-text"),this.onFilterChange()},onClearFilterClick:function(e){this.clearFilter(),n.trigger("guts:log","filterTextCancelClicked"),_.gaTrackEvent("user","filterTextCancelClicked")},onDeleteClick:_.debounce(function(e){var t;_.each(this.gridView,function(n){t=null,n&&n.selectedItems&&n.selectedItems.length&&(t=n.selectedItems.toArray()),t&&t.length&&_.isFunction(n.options.onDelete)&&n.options.onDelete(t,e,n)})},300),onMergeClick:function(e){var t,n;for(n=0;n<this.gridView.length;n++)this.gridView[n].selectedItems.length?t=this.gridView[n].selectedItems.toArray():t=this.gridView[n].visibleCollection.toArray(),t.length&&_.isFunction(this.gridView[n].options.onMerge)&&this.gridView[n].options.onMerge(t,e)},newPlaylist:function(e){this.model.get("appModel").get("user").id>0?n.trigger("lightbox:open","createPlaylist"):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST"),onLogin:function(e){n.trigger("lightbox:open","createPlaylist")}})},onPlayClick:function(e){var t=e.metaKey||e.ctrlKey;e.preventDefault(),this.play(n.Models.Player.playSpecialIndexes.DEFAULT,!t)},onPlayDropdownClick:function(e){var t=$(e.currentTarget),i=r.model.get("player").get("queue"),s=i.songs.length,o=this.getRelevantModels("song"),u;e.preventDefault();if(t.hasClass("menu-open")){n.trigger("tooltip:close");return}if(!s&&o.models.length==1)return this.onPlayClick(e);u={tooltipKey:"play-toolbar-menu",width:130,pageType:"toolbar",$attached:t,fixed:this.$el._isSticky,fromGrid:!0},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){u.items=n.contextMenus.getContextMenuForPlayDropdown(o.models,{fromGrid:!0,queue:i},u),n.Views.Tooltips.Menu.openTooltip(u)},this))},onAddDropdownClick:function(e){e.preventDefault();var t=$(e.currentTarget),r,i,s,o;if(t.hasClass("menu-open")){n.trigger("tooltip:close");return}if(this.destroyed||this.suspended)return;r=this.getRelevantModels("song"),i=r.models,s={fromGrid:!0,pageType:this.pageItemType||this.pageType||this.page||"toolbar",isSelection:!!r.selectedModels.length},o={tooltipKey:"add-menu",width:130,$attached:t,fixed:this.$el._isSticky,pageType:this.pageItemType||this.pageType||"toolbar",fromGrid:!0},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){o.items=n.contextMenus.getContextMenuForAddDropdown(i,s,o),n.Views.Tooltips.Menu.openTooltip(o)},this))},play:function(e,t){var r=this.getRelevantModels("song"),i=r.models,s=r.selectedModels.length,o=this.options.gridSourceModel,u=_.clone(this.playOptions),a={search:1,artist:1,tag:1,popular:1},f=this.gridView[0].visibleCollection;this.playContext&&!u.context&&(u.context=this.playContext.clone()),s==0&&u.context&&a[u.context.type]&&u.context.addStreamType(n.Models.PlayContext.TYPE_PLAY_ALL),u.index=e,u.playOnAdd=t,u.collectionComparator=f.comparator;if(o&&_.isFunction(o.play)&&f.length===this.gridView[0].collection.length&&s==0){o.play(u);return}n.trigger("player:addSongs",i,u.index,u.playOnAdd,u.context)},onSuggestClick:function(e){e.preventDefault();var t=$(e.currentTarget);if(t.hasClass("disabled"))return;var r=this.playContext,i=this.getRelevantModels("song"),s=i.models;n.trigger("player:addSongs",s,n.Models.Player.playSpecialIndexes.LAST,!1,r)},onAddClick:function(e){e.preventDefault(),this.play(n.Models.Player.playSpecialIndexes.LAST,!1)},onSortClick:function(e){e.preventDefault();var t=$(e.currentTarget);if(t.hasClass("menu-open")){n.trigger("tooltip:close");return}var r=this.getRelevantModels("song"),i={tooltipKey:"sort-toolbar-menu",width:130,tooltipClass:"sort-toolbar-menu",pageType:"toolbar",onSortItemClick:_.bind(this.onSortItemClick,this),page:this.page,collection:this.gridView[0].collection,fixed:this.$el._isSticky};_.asyncTooltipMenu(t,i,r.models,"getContextMenuForSort")},onEditClick:function(){var e=this.getRelevantModels("song"),t=e&&e.models;if(!t||!t[0])return;amdModules.requireDeferred("gs/views/lightboxes/editSong.js").done(function(){n.trigger("lightbox:open","editSong",{song:t[0],relatedSongs:t.length>0?new n.Models.Collections.Songs(t):null})})},onButtonClick:function(){},onPageNavSwitchClick:function(e){var t=$(e.currentTarget),n=t.data("page");n!=null&&(this.page=n)},onFilterChange:function(e){var t=e?$(e.currentTarget):this.$el.find("input.filter"),r=t.val(),i=!0;if(!t.length)return;t.siblings(".clear-filter").css({visibility:r.length?"visible":"hidden"});for(var s=0,o=this.gridView.length;s<o;s++)this.filteredName&&this.gridView[s].filter(this.filteredName,{filterAttribute:this.nameFilterAttribute}),this.gridView[s].filter(r,{src:this.filteredName?"visibleCollection":"collection"}),this.gridView[s].visibleCollection.length&&(i=!1);this.trigger("filterChanged",r);if(e&&e.which==_.keyboard.ENTER&&r.length&&$.trim(r)!==""&&i){n.router.performSearch("",r);return}},onFilterSubmit:function(e){return!1},onFilterClick:function(){n.trigger("guts:log","filterTextClicked"),_.gaTrackEvent("user","filterTextClicked")},onSearchBarClick:function(e){$(".search-bar .placeholder",this.$el).hide(),$("#filter-search",this.$el).focus()},onFilterFocus:function(e){$(".search-bar .placeholder",this.$el).hide()},onFilterBlur:function(e){e.currentTarget.value===""&&$(".search-bar .placeholder",this.$el).show()},onSortItemClick:function(e,t,n,r){e==="default"?this.bypassGridSort=!0:this.bypassGridSort=!1;var i=this.$el.find("input.filter"),s=i.val(),o,u,a;for(var f=0,l=this.gridView.length;f<l;f++)u=null,r&&(o=this.gridView[f].options,a=o.columns,u={sortKey:r,gridOptions:o,songStats:this.model.get("songStats0"),columnSelected:_.indexOf(a,r),lastMetric:o.lastMetric?o.lastMetric:a[0],reversed:o.reversed,filterVal:s}),this.gridView[f].sort(e,null,n||"asc",u);this.lastSort.label=t,this.updateSortLabel()},handleScroll:function(e){if(!this.offset||$("body").hasClass("lb-open"))return;var t=r.model.get("appSize").indexOf("desktop")===-1?$("#header").height():0,n=e||this.$scrollElem.scrollTop(),i=this.offset-t;n>=i&&n<=this.gridScrollBottom?(this.$el.removeClass("passed-grid"),this.$el._isSticky||(this.$el._isSticky=!0,this.setCSS(),this.closeToolbarMenus(),this.$el.addClass("sticky"))):n>=this.gridScrollBottom&&this.gridScrollBottom>0?this.$el.addClass("passed-grid"):this.$el._isSticky&&(this.$el._isSticky=!1,this.setCSS(),this.closeToolbarMenus(),this.$el.removeClass("sticky passed-grid"))},closeToolbarMenus:function(){n.trigger("tooltip:close","play-toolbar-menu"),n.trigger("tooltip:close","sort-toolbar-menu")},setCSS:function(){if(!this.rendered)return;if(this.$el._isSticky){var t=this.$el.offset(),n=this.$el.outerWidth(),r=t.left,i=$(e).width()-n-r;this.ui.$toolbarInner.css({left:r+"px",right:i+"px"})}else this.ui.$toolbarInner.css({left:"",right:""})},setPageNavActive:function(e){var t=$(".btn-nav-switch"),n=t.filter(".active"),r=$();t.each(function(t,n){var i=$(n);if(i.data("page")===e)return r=i,!1});if(!r.hasClass("btn-nav-switch")||n[0]===r[0])return;n.removeClass("active"),r.addClass("active")},getRelevantModels:function(e){var t=_.getCollectionType(this.gridView[0]&&this.gridView[0].collection),r=[],i=[],s=!1,o=0,u=this.gridView.length,a,f;e=e||t;for(;o<u;o++)this.gridView[o].options.canvasMaxItems?(f=Math.min(this.gridView[o].options.canvasMaxItems,this.gridView[o].visibleCollection.length),r.push.apply(r,this.gridView[o].visibleCollection.take(f))):r.push.apply(r,this.gridView[o].visibleCollection.models),this.gridView[o].selectedItems.length&&(s=!0,i.push.apply(i,this.gridView[o].selectedItems.models));s&&(t=_.getItemType(i[0]));if(e!==t&&e==="song"&&t=="album"){var l=s?i:r;if(!(l[0]instanceof n.Models.Song)){var c=[];_.each(l,function(e){var t=e.get("songs");t&&t.models&&c.push.apply(c,t.models)}),s?i=c:r=c}a=s?i[0]:r[0],a&&(t=_.getItemType(s?i[0]:r[0]))}return e!==t&&(r=[]),s&&i.length==r.length&&_.getItemType(i[0])==_.getItemType(r[0])&&(s=!1,i=[]),{models:s?i:r,allModels:r,selectedModels:i}},onInviteFriendsClick:function(){n.trigger("lightbox:open","invite")},onPopularRangeClick:function(e){var t=$(e.currentTarget),n={className:"popular-range",shouldLog:!0,$menuOpenEl:t,closeOthers:!0,scrollable:$(document),closeOnScroll:!0};_.asyncTooltipMenu(t,n,[],"getContextMenuForPopularRange")}},{})}(),define("gs/views/dropdown.js",function(){n.Views.Dropdown=Backbone.View.extend({className:"dropdown",templatePath:"shared",templateFile:"dropdown",events:{"click .btn":"dropdownClick"},options:{items:[{value:"",title:"",selected:!0}],tooltipOptions:{},onSelect:function(){}},initialize:function(){this.tooltipOpen=!1,this.tooltipOptions=_.defaults(this.options.tooltipOptions,{width:150,persist:!0,scrollable:$(document),tooltipKey:"generic-tooltip",onItemClick:_.bind(this.itemClick,this),items:this.options.items});var e=_.findWhere(this.options.items,{selected:!0});e||(this.options.items[0].selected=!0),$(document).on("click."+this.cid,_.bind(function(e){var t=this.$el.has(e.target).length>0,n=this.tooltip&&this.tooltip.$el.has(e.target).length>0;!t&&!n&&this.hideTooltip()},this))},onDestroy:function(){$(document).off("click."+this.cid),this.hideTooltip(),this.tooltip=null},render:function(){return this.renderDfd=$.Deferred(),this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this)),this.renderDfd.promise()},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.showSelection(),this.renderDfd.resolve(e),this.trigger("rendered")},select:function(e){var t=_.findWhere(this.options.items,{value:e});t&&(_.each(this.options.items,function(e){e.selected=!1}),t.selected=!0,this.showSelection(),this.options.onSelect(e))},selected:function(){return _.findWhere(this.options.items,{selected:!0}).value},showSelection:function(){var e=_.findWhere(this.options.items,{selected:!0});this.$el.find(".title").text(e.title)},itemClick:function(e){this.select(e.value),this.hideTooltip()},dropdownClick:function(e){this.tooltipOpen?this.hideTooltip():this.showTooltip()},showTooltip:function(){amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;var e=this.$(".btn");this.tooltip=n.Views.Tooltips.Menu.openTooltip(_.extend(this.tooltipOptions,{$attached:e})),e.addClass("active"),this.tooltipOpen=!0},this))},hideTooltip:function(){this.tooltip&&this.tooltip.closeTooltip(),this.$(".btn").removeClass("active"),this.tooltipOpen=!1}})}),define("gs/views/nameFilterDropdown.js",function(){n.Views.NameFilterDropdown=n.Views.Dropdown.extend({cacheKey:"NameFilterDropdown",initialize:function(e){this.titleAttribute=this.options.titleAttribute||"SongName",this.collection=this.options.collection,this.updateItems(),this.listenTo(this.collection,"add remove reset",this.onCollectionChange),n.Views.Dropdown.prototype.initialize.call(this,e)},updateItems:function(){var e={},n=this.titleAttribute,r=this.options.showItemCounts,i=[],s,o,u,a,f;this.collection.each(function(u){var a;s=u.get(n);if(s==null)return;o=s.toLowerCase(),e[o]===t?(a={value:s,selected:!1},r?(a.type="html",a.html="",a.selectedHTML=""):a.title=_.escape(s),i.push(a),e[o]=1):e[o]++});if(r)for(u=0,a=i.length;u<a;u++)s=i[u].value,o=s.toLowerCase(),i[u].selectedHTML='<span class="count">('+_.toInt(e[o])+')</span><span class="title">'+_.escape(s)+"</span>",i[u].html='<div class="menu-item">'+i[u].selectedHTML+"</div>";i.sort(function(e,t){var n=e.value.toLowerCase(),r=t.value.toLowerCase();return n>r?1:n<r?-1:0}),this.options.defaultItemLocale&&(f='<span class="count">('+this.collection.length+")</span>"+'<span class="title" data-translate-text="'+this.options.defaultItemLocale+'">'+_.getString(this.options.defaultItemLocale)+"</span>",i.unshift({value:!1,selected:!0,type:"html",html:'<div class="menu-item">'+f+"</div>",selectedHTML:f})),this.options.items=i},onCollectionChange:function(){this.updateItems(),this.tooltipOptions&&(this.tooltipOptions.items=this.options.items),this.hideTooltip(),this.showSelection()},showSelection:function(){var e=_.findWhere(this.options.items,{selected:!0});if(e.title){this.$el.find(".title").text(e.title);return}this.$el.find(".title").remove(),this.$el.find(".count").remove(),this.$el.find(".btn").append(e.selectedHTML)}})}),function(){function e(){var e=this.selectedItem&&this.selectedItem.get("Tags"),t;e&&e.length?t=(e.models[0].get("Tag")||"").toLowerCase():this.selectedTag=null,this.onNewTagChosen(t)}n.Views=n.Views||{},n.Views.PostToFeed=Backbone.View.extend({messageBlurTimeout:0,events:{"click .option":"onAttachmentOptionClick","click .cancel":"onCancelClick","keydown .autocomplete-input":"onSearchKeydown","keydown .msg-input":"onMessageKeyDown","focus .autocomplete-input":"onSearchFocus","click .post":"postToFeed","blur .msg-input":"onMessageBlur","click .genre-post-selector":"onGenreSelectorClick","click .remove-genre":"onRemoveGenreClick","submit .placeholder-container":"blockSubmit"},initialize:function(e){return this.params=e,this.rendered=!1,this.user=e.user,this.selectedType=e.type||null,this.selectedItem=e.item||null,this.selectedTag=e.tag||null,!this.selectedTag&&this.selectedItem&&(this.selectedTag=this.selectedItem.get("tag")),Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){this.clearAutocompleteTooltip(),n.trigger("tooltip:close")},render:function(e){var t=$.Deferred(),n=e||new ChainLoading;return this.rendered?t.resolve():n.push(this.fetchTemplate("postToFeed").done(n.bind(this.onTemplate,this,t))),t.promise()},onTemplate:function(e,t){if(this.destroyed){e.reject();return}this.$el.html(this.renderTemplate(t,this)),this.selectedItem&&this.onSelectedItem(null,this.selectedItem),this.rendered=!0,e.resolve()},blockSubmit:function(e){return e.preventDefault(),!1},onCancelClick:function(){this.cancel(),this.trigger("cancel")},cancel:function(){this.selectedType=null,this.selectedItem=null;var e=this.$(".options, .event-action");e.removeClass("hide single").find(".selected").removeClass("selected"),e.find(".placeholder-input").val(""),this.$(".action-text").data("translateText","SHARE_WITH_THE_GROOVESHARK_COMMUNITY").text(_.getString("SHARE_WITH_THE_GROOVESHARK_COMMUNITY")),this.$(".content").addClass("hide"),this.childViews.embeddedEvent&&this.childViews.embeddedEvent.destroy(!1),this.$(".post-container, .event-footer, .event-actions").addClass("hide"),this.$(".msg-input").tagging("destroy"),this.destroyTaggingTooltip(),this.$(".privacy-option").addClass("hide"),this.clearAutocompleteTooltip(),this.$(".close").addClass("hide"),this.$(".event-action").removeClass("hide")},destroyTaggingTooltip:function(){var e=this.childViews.taggingTooltip;e&&(e.destroy(),e.options&&e.options.views&&this.stopListening(e.options.views[0],"show"),this.stopListening(e,"show"),this.childViews.taggingTooltip=null)},destroyGenreTagTooltip:function(){var e=this.childViews.genreTagTooltip;e&&(e.destroy(),e.options&&e.options.views&&this.stopListening(e.options.views[0],"show"),this.stopListening(e,"show"),this.childViews.genreTagTooltip=null)},onAttachmentOptionClick:function(e){var t=$(e.currentTarget),n=t.data("type"),r=n.toUpperCase(),i=this.$(".options, .event-action"),s="SEARCH_"+r+"_TO_SHARE",o="FEED_POST_SHARE_"+r;if(t.hasClass("selected")){t.hasClass("swirl")||(t.addClass("swirl"),setTimeout(_.bind(function(){t.removeClass("swirl")},this),2500));return}t.addClass("selected"),i.addClass("single"),this.$(".action-text").data("translateText",o).text(_.getString(o)),i.find(".placeholder-text").data("translateText",s).text(_.getString(s)),i.find(".placeholder-input").focus(),this.selectedType=n,this.$(".close").removeClass("hide"),this.user.getLibrary()},onSearchKeydown:function(e){if(!this.selectedType)return;var t=$(e.currentTarget),n,r,i;this.autocompleteTooltip&&(n=this.autocompleteTooltip.$el,r=$(".ac-list-item.selected",n));switch(e.which){case _.keyboard.ENTER:r=r?r.find(".ac-item-link"):null;if(r&&r.length)return i=this.autocompleteTooltip.getModelForRow(r),this.onSelectedItem(r,i),!1;return;case _.keyboard.UP:e.preventDefault(),n&&(!r.length||r.is(":first-child")?$(".ac-list-item:last",n).addClass("selected"):r.prev().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.DOWN:e.preventDefault(),n&&(!r.length||r.is(":last-child")?$(".ac-list-item:first",n).addClass("selected"):r.next().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.ESC:return e.preventDefault(),this.clearAutocompleteTooltip(),!1}this.doAutocompleteDebounced(t)},onSearchFocus:function(e){this.doAutocomplete($(e.currentTarget))},doAutocompleteDebounced:_.debounce(function(e){return this.doAutocomplete(e)},100),doAutocomplete:function(e){if(!this.selectedType||this.destroyed)return;var t=$.trim(e.val().toLowerCase());if(t.length<1){this.clearAutocompleteTooltip();return}if(this.autocompleteTooltip)this.autocompleteTooltip.changeQuery(t);else{var r={sticky:!0,$attached:this.$(".autocomplete-input"),tooltipKey:"autocomplete",width:270},i=this.selectedType=="broadcast",s=i?new n.Models.Collections.Broadcasts([],{slient:!0,source:"memcache",modelOptions:{skipCache:!0,dontCache:!0}}):null;this.autocompleteTooltip=new n.Views.Autocomplete({type:this.selectedType+"Search",query:t,maxResults:7,sections:[{type:_.ucwords(this.selectedType)+"s",hideTitle:!0,includeLocal:!0,search:!i,collection:s}],handleResultClick:_.bind(this.onSelectedItem,this),showAllLink:!1}),i&&n.Models.Broadcast.getTopBroadcastsCombined(!1).done(_.bind(function(e){if(!this.autocompleteTooltip||this.destroyed||this.selectedType!="broadcast")return;_.each(e,_.bind(s.push,s)),s.filterBestBroadcasts(),this.autocompleteTooltip.changeQuery(this.autocompleteTooltip.query,!0)},this)),r.views=[this.autocompleteTooltip],r.noMobile=!0,n.trigger("tooltip:open",r),r.dfd.done(_.bind(function(){this.autocompleteTooltip=null},this))}},clearAutocompleteTooltip:function(){this.autocompleteTooltip&&(this.autocompleteTooltip.closeTooltip(),this.autocompleteTooltip=null)},onSelectedItem:function(e,t){var r=Date.now(),i=_.getItemType(t),s={},o=this.$(".content"),u=o.find(".item"),a=u.data("type"),f;a?u.removeClass(a):u[0]||(u=$('<div class="item"></div>').append($('<div class="item-inner"></div>')),o.append(u)),u.addClass(i),u.data("type",i),s[i]={},s[i][t.id]=t,f=new n.Models.FeedEvent({itemID:"fake"+r,itemType:"fake",userID:n.getLoggedInUserID(),metadata:[{metatype:i,metaID:t.id}],timestamp:Math.floor(r/1e3)},{skipCache:!0,dontCache:!0,metaByType:s}),this.selectedItem=t;var l=new ChainLoading;l.push(this.user.getFollowers()),l.push(amdModules.requireDeferred("gs/views/tooltips/taggingSelector.js")),l.push(amdModules.requireDeferred("tagging").done(l.bind(function(){this.showEmbeddedFeedEvent(f)},this)))},showEmbeddedFeedEvent:function(e){var t=this.$(".content"),r=new n.Views.Modules.EmbeddedFeedEventMetadata({el:t,model:e,forPostToFeed:!0});this.childViews.embeddedEvent=r,this.clearAutocompleteTooltip(),this.$(".options").addClass("hide").removeClass("single"),t.removeClass("hide"),this.$(".event-footer, .event-actions").removeClass("hide"),this.$(".event-action").addClass("hide"),r.render({getPageNameData:!0}).done(_.bind(function(){this.showMessageForm(),this.$(".msg-input").focus()},this))},showMessageForm:function(){var t=this.$(".msg-input"),n=this.$(".genre-post-selector");this.$(".post-container").removeClass("hide"),_.defer(_.bind(this.renderTaggingTooltip,this,t)),_.defer(_.bind(this.renderGenreTagTooltip,this,n)),e.call(this)},renderTaggingTooltip:function(e){e&&this.childViews.taggingTooltip&&this.childViews.taggingTooltip.options.$taggingEl[0]!==e[0]&&this.destroyTaggingTooltip();if(this.childViews.taggingTooltip){this.childViews.taggingTooltip.calculateOffset();return}amdModules.requireDeferred("gs/views/tooltips/taggingSelector.js").done(_.bind(function(){var t=e||this.$(".msg-input"),r="taggingSelector"+Date.now(),i=this.$(".privacy-option"),s=$.Deferred(),o=_.extend({},this.options.taggingOptions,{tooltipKey:r,sticky:!0,dfd:s,$attached:t,width:270,persist:!0,startHidden:!0}),u;if(!t.length)return;u=new n.Views.Tooltips.TaggingSelector({users:this.user.get("followers"),$taggingEl:t,tooltipKey:r,addedCallback:function(){i.removeClass("hide")},removedCallback:function(){var e=t.tagging("value"),n=!1,r=e.length,s;for(s=0;s<r;s++)if(_.isObject(e[s])){n=!0;break}n||i.addClass("hide").find(".private-check").attr("checked",!1)}}),o.views=[u],this.childViews.taggingTooltip=new n.Views.ManagedTooltip(o,{clone:!1}),this.childViews.taggingTooltip.open(),this.listenTo(u,"show",this.clearMessageBlurTimeout),s.done(_.bind(function(){this.childViews.taggingTooltip=null},this))},this))},renderGenreTagTooltip:function(t){t&&this.childViews.genreTagTooltip&&this.childViews.genreTagTooltip.options.$attached[0]!==t[0]&&this.destroyGenreTagTooltip();if(this.childViews.genreTagTooltip){this.childViews.genreTagTooltip.calculateOffset();return}var r=t||this.$(".genre-input"),i="tag-tooltip share-tooltip"+this.cid,s=$.Deferred(),o=_.extend({},this.options.taggingOptions,{tooltipKey:i,sticky:!0,dfd:s,$attached:r,width:_.max([r.outerWidth(),150]),scrollable:$(document),persist:!1,startHidden:!0});if(!r.length)return;this.tagsDfd||(this.tagsDfd=n.Models.Tag.getTagList()),this.tagsDfd.done(_.bind(function(t){var r=_.clone(t),i,u;this.tags=t,e.call(this),_.each(n.Models.Tag.topGenres,_.bind(function(e){r[e.tag]=e.tagID},this)),i=new n.Views.Tooltips.TagSelector({tags:r,defaultTags:_.pluck(n.Models.Tag.topGenres,"tag"),capitalize:!0,submit:_.bind(this.onNewTagChosen,this)}),o.views=[i],u=new n.Views.ManagedTooltip(o,{clone:!1}),u.open(),u.beforeClose=_.bind(function(){if(!this.destroyed)return u.hide(),!1},this),u.on("hidden",_.bind(function(){this.$(".genre-post-selector").removeClass("focused")},this)),u.on("visible",_.bind(function(){this.$(".genre-post-selector").addClass("focused")},this)),this.childViews.genreTagTooltip=u,$(document).on("keydown."+this.cid,_.bind(this.focusGenreFilterInput,this)),s.done(_.bind(function(){$(document).off("keydown."+this.cid),this.childViews.genreTagTooltip=null},this))},this))},renderSelectedTag:function(){var e=this.$(".genre-selected"),t=e.find("span"),n=this.$(".genre-post-selector"),r=n.find(".placeholder-text"),i=this.selectedTag&&this.selectedTag.get("Tag");t.text(i||""),e.toggleClass("hide",!i),r.toggleClass("hide",!!i)},focusGenreFilterInput:function(e){var t=e.which.toString(),n=e.metaKey||e.ctrlKey,r=_.keys(_.playerShortcuts),i=_.keys(_.specialKeys),s=this.childViews.genreTagTooltip,o=s&&s.options&&s.options.views;o&&o.length&&_.indexOf(r,t)===-1&&_.indexOf(i,t)===-1&&!n&&o[0].$(".tag-filter").focus()},onMessageKeyDown:function(e){switch(e.which){case _.keyboard.ESC:if(this.childViews.taggingTooltip&&this.childViews.taggingTooltip.isOpen)return e.preventDefault(),this.childViews.taggingTooltip.hide(),!1}},onMessageBlur:function(e){this.messageBlurTimeout=setTimeout(_.bind(function(){this.childViews.taggingTooltip&&this.childViews.taggingTooltip.hide()},this),150)},onGenreSelectorClick:function(e){var t=this.childViews.genreTagTooltip,n=t&&t.options&&t.options.views;t&&(this.childViews.genreTagTooltip.calculateOffset(),this.childViews.genreTagTooltip.show(),n&&n.length&&n[0].$(".tag-filter").focus())},onRemoveGenreClick:function(e){this.selectedTag=null,this.renderSelectedTag(),e.preventDefault(),e.stopImmediatePropagation()},onNewTagChosen:function(e){var t=_.setCasing(e||"",!0),r=this.tags&&this.tags[t],i,s;if(t&&!r)for(s in this.tags)if(this.tags.hasOwnProperty(s)&&s.toLowerCase()==t.toLowerCase()){r=this.tags[s],t=e;break}i={n:t,i:r},i.n&&r&&(this.selectedTag=n.Models.Tag.newOrUpdate(i)),this.renderSelectedTag(),this.childViews.genreTagTooltip&&this.childViews.genreTagTooltip.hide()},clearMessageBlurTimeout:function(){clearTimeout(this.messageBlurTimeout)},postToFeed:function(){if(!this.selectedItem)return;var e=this.$(".msg-input"),t=this.$(".private-check").is(":checked"),r=_.getItemType(this.selectedItem),i=/#/g,s={},o=!1,u=null,a=null,f=this.selectedItem.get("Tags"),l=_.map(e.tagging("value"),function(e){var t;return _.isObject(e)?e.allFollowers?(t=["##-2##",e.text.replace(i,"\\#"),"##"].join(""),o=!0):e.id>=1&&(t=["##",e.id,"##",e.text.replace(i,"\\#"),"##"].join(""),s[e.id]=e.model):t=e.replace(i,"\\#"),t}).join("");f&&f.length&&(a=f.models[0].get("TagID")),this.selectedTag&&(u=this.selectedTag.get("TagID")),a==u&&(u=null);if(l.length>3e3){n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_TOO_LONG_2"),type:"error"});return}n.Services.API.postToFeed(r,this.selectedItem.id,[],l,t,u,o).done(_.bind(this.onShareSuccess,this,s)).fail(_.bind(this.onShareFail,this))},onShareSuccess:function(e,t){var r,i;if(!t||!t.feedItem){this.onShareFail();return}r=e?{user:e}:{},i=_.getItemType(this.selectedItem),r[i]||(r[i]={}),r[i][this.selectedItem.id]=this.selectedItem,n.trigger("feed:postSuccess",t.feedItem,r),n.trigger("guts:forcelog","shareFeed",{type:i,id:this.selectedItem.id}),this.onCancelClick(),n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_SUCCESS_2"),icon:"user",type:"success",url:this.user.toUrl("share/"+t.feedItem.itemID)})},onShareFail:function(){n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_FAILED"),type:"error"})}})}(),function(){n.Views=n.Views||{},n.Views.GenreBio=Backbone.View.extend({className:"module-feed-event genre-bio loading",ui:{title:".title",browse:".browse",showMore:".read-more",description:".description",playStation:".play-station",similarContainer:".similar-genres",showMoreContainer:".show-more-container",showMoreLabel:"@showMoreContainer .label",similarGenres:"@similarContainer .genres",descriptionContent:"@description .content"},events:{"click @showMore":"onShowMore","click @browse":"onBrowse"},onBrowse:function(){n.router.setHash(this.model.get("tag").toUrl()+"/list/songs")},onShowMore:function(){var e=this.model.get("tag");n.trigger("lightbox:open","genreBio",{tagName:e.get("DisplayName"),description:e.get("Description")})},initialize:function(e){return this.model=new Backbone.Model({tagID:e.tagID,showFull:!1}),this.showDescToggle=!!e.showDescToggle,this.onChangeTagID(this.model,e.tagID),Backbone.View.prototype.initialize.call(this,e)},render:function(){this.fetchTemplate("genreBio").done(_.bind(this.onTemplate,this))},onChangeTagID:function(e,t){this.$el.addClass("loading"),n.Models.Tag.getMulti([t]).done(_.bind(function(e){if(!e||!e.length)return;this.model.set("tag",e[0])},this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this)),this.bindUIElements(),this.listenTo(this.model,"change:tagID",this.onChangeTagID),this.listenTo(this.model,"change:tag",this.renderContent),this.model.get("tag")&&this.renderContent()},renderContent:function(){var e=this.model.get("tag"),t=e.get("RelatedTags"),n=e.get("ShortDescription"),r=!t||!t.length,i=this.showDescToggle?"READ_MORE":"BROWSE";this.ui.$title.text(e.get("DisplayName")),this.ui.$playStation.data("tagId",e.get("TagID")),this.ui.$similarContainer.toggleClass("hide",r),this.ui.$showMoreContainer.toggleClass("hide",this.showDescToggle&&!n),this.ui.$description.toggleClass("hide",!n),this.ui.$showMoreLabel.text(_.getString(i)).data("translateText",i),this.ui.$showMoreContainer.swapClasses("read-more","browse",!!this.showDescToggle),r||(this.ui.$similarGenres.empty(),_.each(t.take(3),function(e){var t=$("<a>").attr({"class":"genre",href:e.toUrl()}).text(e.get("DisplayName"));this.ui.$similarGenres.append(t)},this)),n&&this.ui.$description.html(n),this.$el.removeClass("loading")}})}(),function(){function s(e){if(e&&e.item===this.itemID&&e.type===this.typeID&&e.result){var t=e.result.comment;n.Models.Comment.handleUsersArtistsInResult([e.result.comment],e.result.users,e.result.artists),t=new n.Models.Comment(t,{dontCache:!0}),this.collection?this.collection.unshift(t,{newComment:!0}):this.options.createCollectionOnDemand&&(this.collection=n.Models.Comment.newCollectionForItem(this.itemID,this.typeID,[t]),this.item.set("comments",this.collection));if(t.get("ParentID")){var r=n.Models.Artist.getCached(t.get("ParentID"));r&&r.get("comments")&&r.get("comments").unshift(t,{newComment:!0})}}}function o(e){if(!this.collection)return;if(e&&e.item===this.itemID&&e.type===this.typeID&&e.result){var t=this.collection.get(e.commentID),r=e.result.response;n.Models.Comment.handleUsersArtistsInResult([e.result.response],e.result.users,e.result.artists),t.addResponse(r)}}function u(e){e&&e.item===this.itemID&&e.type===this.typeID&&e.result&&this.renderFeaturedFanUpdate(new n.Models.FanUpdate(e.result))}n.Views=n.Views||{};var e=400,i=400;n.Views.Comments=Backbone.View.extend({template:"shared/comments",module:"Comment",direction:"newestAtTop",events:{"submit .comment-form":"commentSubmit","keydown .comment-input":"onCommentInputKeyBlur","click .share-post":"commentSubmit","blur .comment-input":"onCommentInputKeyBlur","submit .module-item-respond":"responseSubmit","input #comment-submit-message":"checkCommentLength","input .module-item-respond":"checkReplyLength","click .show-more":"showMore"},initialize:function(e){return this.rendered=!1,this.subscribed=!1,this.highlightComment=null,this.commentLimit=this.options.commentLimit||25,this.showPostBox=_.orEqual(this.options.showPostBox,!0),this.options.comment?(this.subscribed=!0,this.collection=new n.Models.Collections.Comments([this.options.comment],{modelOptions:{dontCache:!0}})):this.options.highlightComment&&(this.highlightComment=this.options.highlightComment),this.collection&&this.subscribeToCollection(),this.itemID=this.options.itemID,this.typeID=_.toInt(this.options.typeID),this.item=this.options.item,this.item.on("change:comments",this.onCommentsChange,this),this.itemName=_.orEqual(this.options.itemName,""),this.getUserPicture=_.bind(n.getLoggedInUserPicture,n),this.listenTo(n,"manatee:newComment",s),this.listenTo(n,"manatee:newResponse",o),this.listenTo(n,"manatee:newFanUpdate",u),this.listenTo(r.model,"change:user",this.onChangeAuthUser),Backbone.View.prototype.initialize.call(this,e)},onCommentsChange:function(e,t){this.collection&&this.collection.off(null,null,this),this.visibleCollection=null,this.collection=t,this.subscribeToCollection(),this.cleanupChildViews(),this.rendered=!1,this.render()},subscribeToCollection:function(){this.collection.on("add",this.onAddedComment,this),this.collection.on("remove",this.onDeletedComment,this)},onDestroy:function(){this.item.off(null,null,this),this.collection.off(null,null,this),this.subscribed&&r.model.get("manatee").unsubscribeFromChannels(["itemComments:"+this.itemID+":"+this.typeID]),this.commentNameTooltip&&!this.commentNameTooltip.destroyed&&(this.commentNameTooltip.closeTooltip(),this.commentNameTooltip=null)},subscribe:function(){if(this.subscribed)return;r.model.get("manatee").subscribeToChannels(["itemComments:"+this.itemID+":"+this.typeID]),this.subscribed=!0},render:function(){var e=$.Deferred();if(this.rendered)return e.reject().promise();this.rendered=!0;var t=new ChainLoading;return t.push(this.fetchTemplate(this.template)).done(_.bind(this.onTemplate,this)),this.fetchOwnerPageNameData(t),this.collection?t.push(this.collection.setPerPage(this.initialCommentLimit||this.commentLimit)).done(_.bind(this.onPageSizeSet,this,e)):t.done(_.bind(function(){this.options.createCollectionOnDemand&&this.subscribe(),e.resolve()},this)),t.done(_.bind(function(){this.options.initialFakeComment&&this.renderInitialFakeComment(this.options.initialFakeComment)},this)),e.promise()},fetchOwnerPageNameData:function(e){var r,i;return e||(e=new ChainLoading),this.item instanceof n.Models.Playlist?(r=this.item.get("UserID"),i=this.item.get("owner"),i||(i=n.Models.User.newOrUpdate({UserID:r,FName:this.item.get("UserName")||t}),this.item.set("owner",i)),this.itemOwner=i,e.push(i.getPageNameData()).done(_.bind(this.storeOwnerPageNameData,this))):this.item instanceof n.Models.FeedEvent?(i=this.item.getPrimaryUser(),this.itemOwner=i,e.push(i.getPageNameData()).done(_.bind(this.storeOwnerPageNameData,this))):this.item instanceof n.Models.Artist||this.item instanceof n.Models.User?(this.itemOwner=this.item,e.push(this.item.getPageNameData()).done(_.bind(this.storeOwnerPageNameData,this))):this.item instanceof n.Models.Profile?(this.itemOwner=this.item.get("user"),e.push(this.itemOwner.getPageNameData()).done(_.bind(this.storeOwnerPageNameData,this))):(this.ownerPageNameData=null,this.itemOwner=null),e},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this)),this.$commentsEl=this.$(".comments-grid"),this.options.fanUpdate&&this.renderFeaturedFanUpdate(this.options.fanUpdate)},onChangeAuthUser:function(){this.ownerPageNameData=t,this.fetchOwnerPageNameData().done(_.bind(function(){this.ownerPageNameData&&this.showPostBox&&this.toggleCommentBox(this.showPostBox)},this))},storeOwnerPageNameData:function(e){this.ownerPageNameData=e||null,this.ownerPageNameData&&this.toggleCommentBox(this.showPostBox)},onPageSizeSet:function(e,t){this.$el.find(".page-loading").remove(),t.length==0?(!(this.item instanceof n.Models.User)||!this.item.get("isLoggedIn"))&&this.$(".first-comment-message").removeClass("hide"):this.renderComments(t),this.visibleCollection=t,this.renderHighlightedComment(),this.renderShowMore(),this.subscribe(),e.resolve()},renderFeaturedFanUpdate:function(e){if(!e||this.destroyed||!this.rendered)return;var t=new n.Views.Modules.FeaturedFanUpdate({model:e}),r=$("#featured-fan-update").children().first();r.length&&r.data("module").destroy(),this.$("#featured-fan-update").append(t.$el),this.childViews.fanUpdateView=t,t.render()},renderComments:function(e){if(this.destroyed||!this.rendered)return;this.rendered=!0;var t=[],r=this.highlightComment?this.highlightComment.id:0;e.each(_.bind(function(e){if(!e.get("author")||e.get("Reports")>=3||e.id===r)return;var i=new n.Views.Modules[this.module]({model:e,pageItemID:this.itemID,pageTypeID:this.typeID,getUserPicture:this.getUserPicture,parentItem:this.item});this.childViews.push(i),i.render(),t.push(i.$el[0])},this)),this.visibleCollection&&this.visibleCollection.add(e.models,{dontCache:!0,silent:!0}),this.direction==="newestAtBottom"?(t.reverse(),this.childViews.initialFakeComment&&this.childViews.initialFakeComment.rendered?this.childViews.initialFakeComment.$el.after(t):this.$commentsEl.prepend(t)):this.$commentsEl.append(t)},renderHighlightedComment:function(){if(!this.highlightComment||!this.rendered||this.destroyed)return;if(this.highlightComment===-1)return;var e=new n.Views.Modules[this.module]({model:this.highlightComment,highlighted:!0,pageItemID:this.itemID,pageTypeID:this.typeID,getUserPicture:this.getUserPicture,parentItem:this.item});this.childViews.highlightedComment=e,e.render(),e.$el.addClass("highlight"),this.$commentsEl.prepend(e.$el[0])},renderInitialFakeComment:function(e){if(!e||!this.rendered||this.destroyed)return;var t=new n.Views.Modules[this.module]({model:e,showOptions:!1,pageItemID:this.itemID,pageTypeID:this.typeID,getUserPicture:this.getUserPicture,parentItem:this.item});this.childViews.initialFakeComment=t,t.render(),this.$commentsEl.prepend(t.$el[0]),this.renderShowMore()},renderShowMore:function(){if(!this.collection||this.destroyed)return;var e=this.$(".show-more");this.collection.hasNextPage()?e.removeClass("hide"):e.addClass("hide")},onAddedComment:function(e,t,n){n&&n.newComment&&this.renderNewComment(e)},onDeletedComment:function(e){_.each(this.childViews,function(t){t.model instanceof n.Models.Comment&&t.model.id===e.id&&t.destroy()})},renderNewComment:function(e){if(!this.rendered||!this.$commentsEl||this.destroyed)return;if(!e.get("author"))return;var t=new n.Views.Modules[this.module]({model:e,pageItemID:this.itemID,pageTypeID:this.typeID,getUserPicture:this.getUserPicture,parentItem:this.item});this.childViews.push(t),t.render(),this.direction==="newestAtBottom"?this.$commentsEl.append(t.$el[0]):this.$commentsEl.prepend(t.$el[0]),$(".first-comment-message").hide()},responseSubmit:function(e){e.preventDefault();var t=$("input",e.currentTarget),n=t.val();if(t.hasClass("pending")||!n)return;var r=$(e.currentTarget).data("parentId"),s=this.collection.get(r);if(!(t.val().length<=i))return;s.storeResponse(n).done(function(){t.val(""),t.removeClass("pending")}).fail(function(){t.removeClass("pending")}),t.addClass("pending")},commentSubmit:function(t,i){t&&t.preventDefault();var s=t?$(t.currentTarget):null,o=this.$(".comment-form"),u=o.find(".comment-input"),a=u.val()||u.text(),f=r.model.get("user");if(o.hasClass("pending")&&!i||!a)return;if(!f.get("isLoggedIn")){n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_COMMENT"),preventRedirect:!0,onClose:function(){o.removeClass("pending")}});return}if(a.length>e){n.trigger("notification:add",{description:_.getString("POPUP_FEED_POST_TOO_LONG_2"),type:"error",duration:5e3});return}if(f.get("hasDefaultName")||f.get("Name").replace(/\s/g,"").match(/(gr[o0]{2}veshark)/i)){var l=$.Deferred();l.done(_.bind(this.commentSubmit,this,t,!0)),amdModules.requireDeferred("gs/views/tooltips/displayName.js").done(_.bind(function(){this.commentNameTooltip=new n.Views.Tooltips.DisplayName({onSubmitDeferred:l,tooltipKey:"displayNameTooltip",authUser:f}),n.trigger("tooltip:open",{delay:0,width:280,views:[this.commentNameTooltip],positionDir:"up",positionSpill:"left",$attached:s||u,tooltipKey:"displayNameTooltip",persist:!0})},this))}else jQuery.fn.cleanInputText?this.finishSubmitNewComment():amdModules.requireDeferred("cleanInputText").done(_.bind(function(){this.finishSubmitNewComment()},this));o.addClass("pending")},finishSubmitNewComment:function(){if(!this.item)return;var e=this.$(".comment-form"),t=e.find(".comment-input"),r=this.collection,i;t.cleanInputText("match"),i=t.val()||t.text(),n.Models.Comment.storeComment(this.itemID,this.typeID,i).done(function(n){r&&r.unshift(n,{newComment:!0}),t.val("").html("").blur(),e.removeClass("pending")}).fail(function(){e.removeClass("pending")})},onCommentInputKeyBlur:function(e){var t=$("#comment-submit");e.which?e.which===_.keyboard.ENTER&&$(".comment-input").text().length&&!e.shiftKey?(e.preventDefault(),this.commentSubmit()):t.addClass("focused"):$(e.currentTarget).val()||t.removeClass("focused")},checkCommentLength:function(t){var n=this.$(".comment-input"),r=$("#comment-submit-btn");n.toggleClass("error",n.val().length>e),r.toggleClass("disabled",n.val().length>e)},checkReplyLength:function(e){var t=$("input",e.currentTarget);t.toggleClass("error",t.val().length>i)},showMore:function(e){e.preventDefault();if(!this.collection||this.destroyed)return;this.collection.getNextPage().done(_.bind(this.renderComments,this)).done(_.bind(this.renderShowMore,this))},verifyCanComment:function(){var e=$.Deferred();return this.ownerPageNameData===t?e.reject():this.ownerPageNameData&&this.ownerPageNameData.CommentsRestriction==="noone"?e.resolve(!1):this.ownerPageNameData&&this.ownerPageNameData.CommentsRestriction==="followers"&&this.itemOwner!==r.model.get("user")?this.itemOwner.get("isFollower")!==t?e.resolve(this.itemOwner.get("isFollower")===!0):r.model.get("user").getFollowers().done(_.bind(function(t){var r=this.itemOwner.get("UserID");this.itemOwner instanceof n.Models.Artist&&(r=this.itemOwner.get("profileID")),t&&t.get(r)?e.resolve(!0):e.resolve(!1)},this)):e.resolve(!0),e.promise()},toggleCommentBox:function(e){this.showPostBox=e;if(!e){this.showHideCommentBox(e);return}this.verifyCanComment().done(_.bind(function(e){this.showHideCommentBox(e)},this))},showHideCommentBox:function(e){}}),n.Views.FeedEventComments=n.Views.Comments.extend({template:"shared/feedEventComments",module:"FeedEventComment",direction:"newestAtBottom",initialize:function(e){return this.initialCommentLimit=this.options.initialCommentLimit||3,this.options.commentLimit||(this.options.commentLimit=10),n.Views.Comments.prototype.initialize.call(this,e)},renderShowMore:function(e){if(!this.visibleCollection&&(!this.options.isStranger||!this.options.initialFakeComment)||this.destroyed)return;var t=this.$(".show-more"),n=this.item.get("commentsCount"),r=this.visibleCollection?this.visibleCollection.length:0,i=this.options.initialFakeComment?n+1:n,s=this.options.isStranger&&!e,o=s?i:n-r;this.$(".comments-grid").toggleClass("hide",s),t.parent().toggleClass("hide",o<=0),o===1?t.text(_.getString(s?"SHOW_ONE_COMMENT":"VIEW_ONE_MORE_COMMENT")):o>1&&t.text(_.getString(s?"SHOW_COUNT_COMMENTS":"VIEW_COUNT_MORE_COMMENTS",{count:o}))},finishSubmitNewComment:function(){var e=this.$(".comment-form"),t=e.find(".comment-input"),n;t.cleanInputText("match"),n=t.val()||t.text(),this.item.storeComment(n).done(function(t){e.find(".comment-input").val("").html("").blur(),e.removeClass("pending")}).fail(function(){e.removeClass("pending")})},subscribe:function(){if(n.getLoggedInUserID()>0)return n.Views.Comments.prototype.subscribe.call(this)},showMore:function(e){e.preventDefault();if(!this.collection&&(!this.options.isStranger||!this.options.initialFakeComment)||this.destroyed)return;this.collection?this.collection.getPerPage()===this.initialCommentLimit?this.collection.setPerPage(this.commentLimit).done(_.bind(function(e){this.visibleCollection&&this.visibleCollection.each(_.bind(e.remove,e)),this.renderComments(e),this.renderShowMore(!0)},this)):this.collection.getNextPage().done(_.bind(this.renderComments,this)).done(_.bind(this.renderShowMore,this,!0)):(this.$(".comments-grid").removeClass("hide"),this.$(".show-more").parent().addClass("hide"))},showHideCommentBox:function(e){this.$(".comment-form").toggleClass("hide",!e)}})}(),function(){n.Views=n.Views||{};var t=[],s=0,o;n.Views.Feed=Backbone.View.extend({templatePath:"shared",feedCols:0,minColWidth:365,colSpacing:40,ui:{tempFeedModules:".temp-feed-modules"},constructor:function(e){return e.model||(this.model=new Backbone.Model),Backbone.View.prototype.constructor.call(this,e)},initialize:function(t){o=t.appModel,this.model.set({user:t.user,mediaType:t.mediaType,groupType:t.groupType}),this.rendered=!1,Backbone.View.prototype.initialize.call(this,t),this.listenTo(n,"feed:postSuccess",this.onPostSuccess),this.listenTo(n,"locale:loaded",this.onLocaleChanged),this.listenTo(n,"locale:changed",this.onLocaleChanged),this.listenTo(n,"scroll",_.bind(this.handleScrollForFeed,this,!0)),$(e).on("resize."+this.cid,_.bind(this.handleResize,this)),this.listenTo(n,"sidebar:opened sidebar:closed",this.handleResize),this.listenTo(r.model,"change:user",this.onUserChange),n.on("feed:itemViewed",this.onFeedItemViewed,this)},onDestroy:function(){$(e).off("resize."+this.cid),this.loadingFeedDfd&&this.loadingFeedDfd.state()==="pending"&&this.loadingFeedDfd.abort(),this.sendFeedItemViews(!0)},suspend:function(){this.suspended=!0,this.sendFeedItemViews(!0),this.loadingFeedDfd&&this.loadingFeedDfd.state()==="pending"&&this.loadingFeedDfd.abort()},resume:function(){this.suspended=!1},onLocaleChanged:function(e){if(this.destroyed)return;this.childViews.postToFeed&&this.childViews.postToFeed.$el&&(this.childViews.postToFeed.$el.find("[data-translate-text]").localize("gs",{language:e}),this.childViews.postToFeed.$el.find("[data-translate-title]").localize("gs",{language:e,callback:"titleCallback"})),_.each(this.unshownFeedModules,function(t){t.$el.find("[data-translate-text]").localize("gs",{language:e}),t.$el.find("[data-translate-title]").localize("gs",{language:e,callback:"titleCallback"})})},onUserChange:function(){t=[]},render:function(){var e=new ChainLoading,t=this.model.get("user"),r=t.get("isLoggedIn"),i=this.model.get("mediaType"),s=this.model.get("groupType"),o,u;return this.loadingFeedDfd&&this.loadingFeedDfd.state()==="pending"&&this.loadingFeedDfd.abort(),this.childViews.postToFeed&&this.childViews.postToFeed.destroy(!0),this.childViews.genreBio&&(this.childViews.genreBio.destroy(!0),this.childViews.genreBio=null),this.profileCompletion&&(this.profileCompletion.destroy(),this.profileCompletion=null),e.push(this.fetchTemplate("feed").done(e.bind(this.onTemplate,this))),r&&e.push(t.getFavoritesByType("Users")),this.options.feedItemIDs?u=this.loadingFeedDfd=n.Models.FeedEvent.getFeedEventsByIDs(this.options.feedItemIDs):(r&&(this.childViews.postToFeed=new n.Views.PostToFeed({user:t}),this.childViews.listenAgain=new n.Views.ListenAgain({user:t}),e.push(this.childViews.postToFeed.render()),e.push(this.childViews.listenAgain.render())),this.options.tagID?o=[this.options.tagID]:this.options.tagIDs&&(o=this.options.tagIDs),o&&o.length===1&&o[0]&&(this.filteredTagIDs=o,this.childViews.genreBio=new n.Views.GenreBio({tagID:o[0]}),this.childViews.genreBio.render()),this.loadingFeedDfd=t.getMaterializedFeed(o,i,s),this.loadingFeedDfd.loadMoreDfd?u=this.loadingFeedDfd.loadMoreDfd:u=this.loadingFeedDfd),this.options.renderWaitDfd&&(e.push(this.options.renderWaitDfd),delete this.options.renderWaitDfd),e.done(_.bind(this.handleResize,this,null,!0)),e.push(u.done(e.bind(this.onMaterializedFeed,this))),e.fail(_.bind(this.onFeedFailed,this)),e.promise()},onTemplate:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e)),this.options.feedItemIDs&&this.$(".feed-loading").addClass("hide"),this.bindUIElements(),this.rendered=!0},onMaterializedFeed:function(e){_.each(this.unshownFeedModules,function(e){e.destroy()}),this.detachStaticFeedModules(),this.$(".feed").empty(),this.feedInitialized=!1,this.feedModuleDivs=[],this.unreadFeedModules=[],this.unshownFeedModules=[],this.receivedInitialFeedPage=!1,this.listenTo(e,"change:hidden",this.onFeedEventHidden),this.loadingFeedDfd=e.setPerPage(20).done(_.bind(this.onFeedLoaded,this)).fail(_.bind(this.onFeedFailed,this)),this.renderedFeed=e},onFeedLoaded:function(e){$.localize.ready.done(_.bind(function(){this.renderFeed(e)},this))},onPostSuccess:function(e,t){var r=this.model.get("user"),i=new n.Models.FeedEvent(e,{metaByType:t,dontCache:!0}),s=new n.Views.Modules.CommunityFeedEvent({model:i,user:r});this.unreadFeedModules.unshift(s),this.unshownFeedModules.unshift(s),this.childViews.push(s),s.render(),this.feedModuleDivs.unshift(s.el),this.$cols[0].children().first().after(s.el)},renderFeed:function(e){if(this.destroyed)return;var t=this.model.get("user"),r=new ChainLoading,i,s,u;this.filteredTagIDs&&this.filteredTagIDs.length?(i=0,s=0,u=0):(i=.1,s=.2,u=.2),n.Models.Comment.loadCommentsForItemsType(e.pluck("EventID"),n.Models.Comment.COMMENT_PAGE_TYPES.FEED_EVENT,!1,e),e.each(_.bind(function(e,a){this.options.includeProfileCompletion&&(this.profileCompletion==null||this.profileCompletion.destroyed)&&Math.random()<i&&(this.profileCompletion=new n.Views.Modules.ProfileCompletion({user:t}),r.pushIgnoreFail(this.profileCompletion.render()).fail(_.bind(function(){if(this.destroyed||!this.profileCompletion)return;var e=_.indexOf(this.feedModuleDivs,this.profileCompletion.$el[0]);e>-1&&this.feedModuleDivs.splice(e,1),e=_.indexOf(this.unshownFeedModules,this.profileCompletion),e>-1&&this.unshownFeedModules.splice(e,1),this.profileCompletion.destroy(),this.profileCompletion=null},this)),this.profileCompletion!=null&&(this.unshownFeedModules.push(this.profileCompletion),this.childViews.push(this.profileCompletion),this.feedModuleDivs.push(this.profileCompletion.$el[0]))),this.options.includePeopleYouMayKnow&&(this.peopleYouMayKnow==null||this.peopleYouMayKnow.destroyed)&&Math.random()<s&&(this.peopleYouMayKnow=new n.Views.Modules.SuggestedFriends({model:t,visibleCount:3,onClose:_.bind(function(){var e=_.indexOf(this.feedModuleDivs,this.peopleYouMayKnow.$el[0]);e>-1&&this.feedModuleDivs.splice(e,1),e=_.indexOf(this.unshownFeedModules,this.peopleYouMayKnow),e>-1&&this.unshownFeedModules.splice(e,1),this.peopleYouMayKnow.destroy(),this.peopleYouMayKnow=null},this)}),r.pushIgnoreFail(this.peopleYouMayKnow.render().fail(this.peopleYouMayKnow.options.onClose)),this.peopleYouMayKnow!=null&&(this.unshownFeedModules.push(this.peopleYouMayKnow),this.childViews.push(this.peopleYouMayKnow),this.feedModuleDivs.push(this.peopleYouMayKnow.$el[0]))),this.tips==null&&Math.random()<u&&(this.tips=new n.Views.FeedTip({appModel:o,onClose:_.bind(function(){var e=_.indexOf(this.feedModuleDivs,this.tips.$el[0]);e>-1&&this.feedModuleDivs.splice(e,1),e=_.indexOf(this.unshownFeedModules,this.tips),e>-1&&this.unshownFeedModules.splice(e,1),this.tips.destroy(),this.tips=null},this)}),r.pushIgnoreFail(this.tips.render().fail(this.tips.options.onClose)),this.tips!=null&&(this.unshownFeedModules.push(this.tips),this.childViews.push(this.tips),this.feedModuleDivs.push(this.tips.$el[0])));var f=new n.Views.Modules.CommunityFeedEvent({model:e,user:t});this.unshownFeedModules.push(f),this.unreadFeedModules.push(f),this.childViews.push(f),r.pushIgnoreFail(f.render()),this.feedModuleDivs.push(f.$el[0])},this)),e.length||r.push(amdModules.requireDeferred("gs/views/cards/emptyFeed.js")).done(_.bind(function(){var e=new n.Views.Cards.EmptyFeed({genre:this.childViews.genreBio&&this.childViews.genreBio.model.get("tag"),filter1:this.model.get("mediaType"),filter2:this.model.get("groupType"),user:t});this.unshownFeedModules.push(e),this.childViews.push(e),this.filteredTagIDs&&this.filteredTagIDs.length?n.Models.Tag.getMulti(this.filteredTagIDs).done(_.bind(function(t){if(!t||!t.length)return;e.genre=t[0],e.render()},this)):e.render(),this.feedModuleDivs.push(e.$el[0])},this)),this.hasResults=!e.length,r.done(_.bind(this.columnizeFeed,this,!0)),this.receivedInitialFeedPage=!0,r.done(_.bind(this.handleScrollForFeed,this,!1))},columnizeFeed:function(e){if(this.rendered&&this.feedModuleDivs&&!this.suspended){var t=this.feedInitialized?this.unshownFeedModules:this.feedModuleDivs,r=t[0]instanceof n.Views.Modules.Base,i=t.length,s=this.model.get("user"),o=this.hasResults?1:this.feedCols,u,a;if(!this.feedInitialized){this.$feed=$(".feed"),this.detachStaticFeedModules();for(u=0;u<i;u++)r?t[u].$el.detach():$(t[u]).detach();this.$feed.empty(),this.$cols=[],this.colHeights=_.range(0,o,0),this.$shortestCol={},this.shortestIndex=null;for(u=0;u<o;u++)this.$cols.push($('<div id="feed-col'+u+'" class="feed-col" style="width: '+100/o+'%;"></div>'));this.$feed.append(this.$cols),this.hasResults||(this.childViews.genreBio?this.$cols[0].append(this.childViews.genreBio.$el):this.childViews.postToFeed&&this.$cols[0].append(this.childViews.postToFeed.$el)),this.childViews.listenAgain&&(!this.filteredTagIDs||!this.filteredTagIDs.length)&&_.last(this.$cols).append(this.childViews.listenAgain.$el),this.colHeights[0]=this.$cols[0].height(),this.feedInitialized=!0}if(e&&o>1){this.setFeedModuleHeights(t,r);for(u=0;u<i;u++){this.shortestIndex=_.indexOf(this.colHeights,_.min(this.colHeights));if(this.shortestIndex===-1)continue;this.$shortestCol=this.$cols[this.shortestIndex];if(!this.$shortestCol)continue;r?this.$shortestCol.append(t[u].el):this.$shortestCol.append(t[u]),this.colHeights[this.shortestIndex]+=this.feedModuleHeights[u]+this.colSpacing}}else if(o===1)r?this.$cols[0].append(_.pluck(t,"el")):this.$cols[0].append(t);else for(u=0;u<i;u++){var f=u%o;r?this.$cols[f].append(t[u].el):this.$cols[f].append(t[u])}_.defer(_.bind(function(){(n.Views.Ads.AppSize==="mobile"||n.Views.Ads.AppSize==="tablet")&&n.trigger("ad:handleInCardAds",{container:this.$feed})},this))}},setFeedModuleHeights:function(e,t){t?this.ui.$tempFeedModules.append(_.pluck(e,"el")):this.ui.$tempFeedModules.append(e),this.feedModuleHeights=[];for(i=0,l=e.length;i<l;i++)t?this.feedModuleHeights[i]=e[i].el.clientHeight:this.feedModuleHeights[i]=e[i].clientHeight;t?$(_.pluck(e,"el")).detach():$(e).detach()},handleResize:function(e,t){var n=this.$(".feed"),r=n.width(),i=Math.max(1,Math.floor(r/this.minColWidth));i!==this.feedCols&&(this.feedInitialized=!1,this.feedCols=i,t||this.columnizeFeed()),this.handleScrollForFeed()},handleScrollForFeed:function(t,n){var r,i,s,o,u,a;if(this.suspended||!this.renderedFeed||!this.receivedInitialFeedPage)return;r=this.unshownFeedModules.length,this.$(".feed-loading").toggleClass("hide",!this.fetchingNextPage&&!this.renderedFeed.hasNextPage());if(r<5&&t){(!this.fetchingNextPage||this.fetchingNextPage.state()!=="pending")&&this.renderedFeed.hasNextPage()&&(this.fetchingNextPage=this.renderedFeed.getNextPage().done(_.bind(this.renderFeed,this)));if(!r&&!this.unreadFeedModules.length)return}i=$(e).height(),n=n||$(document).scrollTop();for(s=0;s<this.unreadFeedModules.length;s++){u=this.unreadFeedModules[s];if(u.$el.hasClass("hide")){o=_.indexOf(this.unshownFeedModules,u),o!==-1&&this.unshownFeedModules.splice(o,1);continue}if(u.markedRead){this.unreadFeedModules.splice(s,1),s--;continue}a=u.$el.offset().top+u.$el.height(),n+i>a?(o=_.indexOf(this.unshownFeedModules,u),o!==-1&&this.unshownFeedModules.splice(o,1),n<u.$el.offset().top?u.markOnscreen():u.markOffscreen()):u.markOffscreen()}},updateFeed:function(e){if(this.destroyed)return;var t=this.model.get("user"),r=this.model.get("mediaType"),i=this.model.get("groupType"),s;this.loadingFeedDfd&&this.loadingFeedDfd.state()==="pending"&&this.loadingFeedDfd.abort(),delete this.options.tagID,e==="default"?(this.childViews.genreBio&&(this.childViews.genreBio.destroy(!0),this.childViews.genreBio=null),this.options.tagIDs&&this.options.tagIDs.length&&(s=this.options.tagIDs),this.filteredTagIDs=[]):(s=e,s.length===1&&s[0]&&(this.filteredTagIDs=s,this.childViews.genreBio?this.childViews.genreBio.model.set("tagID",s[0]):(this.childViews.genreBio=new n.Views.GenreBio({tagID:s[0]}),this.childViews.genreBio.render()))),this.loadingFeedDfd=t.getMaterializedFeed(s,r,i),this.loadingFeedDfd.done(_.bind(this.onMaterializedFeed,this)).fail(_.bind(this.onFeedFailed,this))},refreshFeed:function(){var e=this.model.get("user"),t=this.model.get("mediaType"),n=this.model.get("groupType"),r;this.loadingFeedDfd&&this.loadingFeedDfd.state()==="pending"&&this.loadingFeedDfd.abort(),this.options.tagIDs&&this.options.tagIDs.length&&(r=this.options.tagIDs),this.loadingFeedDfd=e.getMaterializedFeed(r,t,n,!0),this.loadingFeedDfd.done(_.bind(this.onMaterializedFeed,this))},onFeedFailed:function(e){if(e&&e.aborted)return;n.trigger("notification:add",{description:_.getString("PAGE_LOAD_FAIL"),type:"error"})},onFeedEventHidden:function(e,t,n){t&&(this.renderedFeed.remove(e),_.each(this.childViews,_.bind(function(t,n){var r;if(t.model===e)return r=_.indexOf(this.feedModuleDivs,t.el),r>-1&&this.feedModuleDivs.splice(r,1),delete this.childViews[n],t.destroy(),!1},this)),this.columnizeFeed(!0))},detachStaticFeedModules:function(){this.childViews.postToFeed&&!this.childViews.postToFeed.destroyed&&$.contains(document,this.childViews.postToFeed.el)&&this.childViews.postToFeed.$el.detach(),this.childViews.genreBio&&!this.childViews.genreBio.destroyed&&$.contains(document,this.childViews.genreBio.el)&&this.childViews.genreBio.$el.detach(),this.childViews.listenAgain&&!this.childViews.listenAgain.destroyed&&$.contains(document,this.childViews.listenAgain.el)&&this.childViews.listenAgain.$el.detach()},onFeedItemViewed:function(e){if(n.getLoggedInUserID()<1||!e)return;var r=_.indexOf(t,e);r===-1&&t.push(e),this.sendFeedItemViewsDebounced()},sendFeedItemViews:function(e){var r=Date.now(),i=t,o=[],u=[];if(n.getLoggedInUserID()<1||t.length<1){t.length>0&&(t=[]);return}if(e||t.length>=50||r-s>=3e4)_.each(t,function(e){e.get("EventType")==="recommendation"?u.push(e.id):o.push(e.id)}),n.Services.API.feeds3ItemIDsViewed(o,u).fail(function(){t=t.concat(i),s-=3e4}),t=[],s=r},sendFeedItemViewsDebounced:_.debounce(function(){this.sendFeedItemViews()},1e3)})}(),define("pub/gs/views/feedTip.js",function(){function o(){var e=t.get("UserID"),r=_.orEqual(n.Services.Local.get("visitCount."+e),0);return e===-1&&r<=1}function u(){var e=t.get("UserID"),r=_.orEqual(n.Services.Local.get("visitCount."+e),0);return e===-1&&r===2}function a(){var e=t.get("recentBroadcasts");return e&&e.length===0}function f(){var e=t.get("favoriteUsers");return e&&e.length===0}function l(){var e=t.get("favoriteUsers");return e&&e.length>=1&&e.length<=3}function c(){var e=t.get("favoriteUsers");return e&&e.length===0&&!n.Services.Twitter.connected}function h(){var e=t.get("favoriteUsers");return e&&e.length===0&&n.Services.Google.connected}function p(){var e=t.get("BroadcastListens");return!e}function d(){var e=t.get("playlists"),n=t.get("followers"),r=t.get("BroadcastListens");return!e||!n||n.length<10||r>0?!1:(e=e.filter(function(e){var t=e.get("songs");return t.length>=20}),e.length>=6)}function v(){var n=e.get("player").get("queue"),r=n&&n.get("songs"),i=t.get("BroadcastListens"),s;return!r||r.length<60||i>0?!1:(s=_.uniq(r.pluck("ArtistID")),s.length>=40)}function m(t){var r=e.get("appToken");n.Services.Twitter.login(r)}function g(t){var r=e.get("appToken");n.Services.Google.login(r)}function y(e){n.router.setHash("#!/",{mediaType:"people"})}var e,t,r,i,s;s=Backbone.Model.extend({initialize:function(e,t){this.set({currentTip:null,tipSets:{},hasTips:!0})},getNextTip:function(){var e=$.Deferred();return t.getUserMiscData().done(_.bind(function(t){var n=t&&t.Tips&&t.Tips.TipSets||{},i=[],s,o;_.each(r,function(e){if(i.length&&e.set!==s)return!1;(!n[e.set]||!n[e.set].Flags)&&e.predicate()&&(s=e.set,i.push(e))}),o=_.sample(i),o?this.set({currentTip:o,tipSets:n,hasTips:!0}):this.set({currentTip:null,tipSets:n,hasTips:!1}),e.resolve()},this)),e.promise()},markCurrentTipViewed:function(){var e=this.get("currentTip"),n=this.get("tipSets"),r;e&&(r=_.orEqual(n[e.set]&&n[e.set].Flag,0),t.markTipViewed(e.set,r|e.flag))}}),i=Backbone.View.extend({templatePath:"feedTip",templateFile:"button",copyLocale:"",btnLocale:"",btnIcon:"",btnHref:"",btnClass:"btn-success",btnClick:function(){},ui:{btn:".btn"},events:{"click @btn":"clickBtn"},initialize:function(e){this.tip=e.tip||{},this.onInteraction=e.onInteraction||function(){},Backbone.View.prototype.initialize.call(this,e)},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this)),this.bindUIElements(),n.trigger("guts:log","feedTipDisplayed",{set:this.tip.set,flag:this.tip.flag})},clickBtn:function(e){this.btnClick(e),this.onInteraction(),n.trigger("guts:log","feedTipInteracted",{set:this.tip.set,flag:this.tip.flag})}}),r=[{set:"new_users",flag:1,predicate:o,view:i.extend({copyLocale:"TIP_LOGGED_OUT_FIRST_TIME_A",btnLocale:"LEARN_MORE",btnHref:"#!/new"})},{set:"new_users",flag:2,predicate:o,view:i.extend({copyLocale:"TIP_LOGGED_OUT_FIRST_TIME_B",btnLocale:"LEARN_MORE",btnHref:"#!/new"})},{set:"new_users",flag:4,predicate:o,view:i.extend({copyLocale:"TIP_LOGGED_OUT_FIRST_TIME_C",btnLocale:"LEARN_MORE",btnHref:"#!/new"})},{set:"new_users",flag:8,predicate:o,view:i.extend({copyLocale:"TIP_LOGGED_OUT_FIRST_TIME_D",btnLocale:"LEARN_MORE",btnHref:"#!/new"})},{set:"new_users",flag:16,predicate:u,view:i.extend({copyLocale:"TIP_LOGGED_OUT_SECOND_TIME_A",btnLocale:"SIGN_UP",btnHref:"#!/signup"})},{set:"bc_listen",flag:1,predicate:a,view:i.extend({copyLocale:"TIP_NO_BROADCAST_LISTENS_A",btnLocale:"EXPLORE_BROADCASTS",btnHref:"#!/broadcasts"})},{set:"bc_listen",flag:2,predicate:a,view:i.extend({copyLocale:"TIP_NO_BROADCAST_LISTENS_B",btnLocale:"EXPLORE_BROADCASTS",btnHref:"#!/broadcasts"})},{set:"bc_listen",flag:4,predicate:a,view:i.extend({copyLocale:"TIP_NO_BROADCAST_LISTENS_C",btnLocale:"EXPLORE_BROADCASTS",btnHref:"#!/broadcasts"})},{set:"find_friends",flag:1,predicate:f,view:i.extend({copyLocale:"TIP_NO_FOLLOWS_A",btnLocale:"FIND_PEOPLE_TO_FOLLOW",btnClick:y})},{set:"find_friends",flag:2,predicate:f,view:i.extend({copyLocale:"TIP_NO_FOLLOWS_B",btnLocale:"FIND_PEOPLE_TO_FOLLOW",btnClick:y})},{set:"find_friends",flag:4,predicate:f,view:i.extend({copyLocale:"TIP_NO_FOLLOWS_C",btnLocale:"FIND_PEOPLE_TO_FOLLOW",btnClick:y})},{set:"find_friends",flag:8,predicate:l,view:i.extend({copyLocale:"TIP_FEW_FOLLOWS_A",btnLocale:"FIND_PEOPLE_TO_FOLLOW",btnClick:y})},{set:"find_friends",flag:16,predicate:c,view:i.extend({copyLocale:"TIP_NO_FOLLOWS_NO_TWITTER_A",btnLocale:"TWITTER_SERVICE_CONNECT",btnClass:"third-party twitter",btnIcon:"icon-twitter",btnClick:m})},{set:"find_friends",flag:32,predicate:h,view:i.extend({copyLocale:"TIP_NO_FOLLOWS_NO_GOOGLE_A",btnLocale:"GOOGLE_SERVICE_LOGIN",btnClass:"third-party google",btnIcon:"icon-google",btnClick:g})},{set:"bcaster",flag:1,predicate:p,view:i.extend({copyLocale:"TIP_NEVER_BROADCASTED_A",btnLocale:"LEARN_MORE",btnClass:"learn-link learn-broadcasts"})},{set:"bcaster",flag:2,predicate:d,view:i.extend({copyLocale:"TIP_HAS_PLAYLISTS_NEVER_BROADCASTED_A",btnLocale:"LEARN_MORE",btnClass:"learn-link learn-broadcasts"})},{set:"bcaster",flag:4,predicate:v,view:i.extend({copyLocale:"TIP_HAS_QUEUE_NEVER_BROADCASTED_A",btnLocale:"START_BROADCAST",btnClass:"btn-primary start-broadcast",btnIcon:"icon-broadcast"})}],n.Views.FeedTip=Backbone.View.extend({templatePath:"feedTip",templateFile:"index",ui:{closeBtn:".close",tipContainer:".card-content"},events:{"click @closeBtn":"clickCloseBtn"},initialize:function(n){e=n.appModel,t=e.get("user"),this.model=new s,this.renderDfd=$.Deferred(),this.onClose=n.onClose||function(){},Backbone.View.prototype.initialize.call(this,n)},render:function(){var e=new ChainLoading;return e.push(this.model.getNextTip()),e.push(this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))),this.renderDfd.promise()},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:currentTip",this.renderCurrentTip),this.listenTo(this.model,"change:hasTips",this.renderVisibility),this.renderCurrentTip(),this.renderVisibility(),this.renderDfd.resolve()},renderCurrentTip:function(){var e=this.model.get("currentTip");this.childViews.tip&&!this.childViews.tip.destroyed&&(this.childViews.tip.destroy(!1),this.childViews.tip=null),e&&(this.childViews.tip=new e.view({el:this.ui.$tipContainer,tip:e,onInteraction:_.bind(this.model.markCurrentTipViewed,this.model)}),this.childViews.tip.render())},renderVisibility:function(){this.model.get("hasTips")||this.close()},clickCloseBtn:function(e){var t=this.model.get("currentTip");t&&(this.model.markCurrentTipViewed(),n.trigger("guts:log","feedTipClosed",{set:t.set,flag:t.flag})),this.close()},close:function(){this.onClose()}})}),function(){n.Views=n.Views||{};var t;n.Views.GenreSelector=t=Backbone.View.extend({templatePath:"genreSelector",templateFile:"genreSelector",ui:{inner:".sticky-bar",btns:".genre-btns",genreDropdownBtn:".genre-dropdown",genreDropdownBtnLabel:"@genreDropdownBtn .label",btnContainer:".btn-container",refreshBtn:".refresh",filterMedia:".filter-media",filterMediaLabel:"@filterMedia .label",filterUsers:".filter-users",filterUsersLabel:"@filterUsers .label",filterCombined:".filter-combined",filterCombinedLabel:"@filterCombined .label",filterInputContainer:".filter-input-container"},events:{"click .genre-btn":"onGenreClick","click @genreDropdownBtn":"clickGenreDropdownBtn","click @filterMedia":"clickFilterMedia","click @filterUsers":"clickFilterUsers","click @filterCombined":"clickFilterCombined","click @refreshBtn":"clickRefreshBtn"},averageBtnSize:120,initialize:function(e){this.noOffset=e.noOffset,this.showFilterInput=_.orEqual(e.showFilterInput,!1),this.onRefreshFeed=_.isFunction(e.onRefreshFeed)&&e.onRefreshFeed,this.onFilterChange=_.orEqual(e.onFilterChange,function(){}),this.onGenreChange=_.orEqual(e.onGenreChange,function(){}),this.model=new Backbone.Model({mediaType:_.orEqual(e.mediaType,"all"),groupType:_.orEqual(e.groupType,"everyone"),tags:e.tags||new n.Models.Collections.Tags([]),selectedTag:e.selectedTag||{},renderedTags:new n.Models.Collections.Tags([]),refreshTimeout:null}),this.promotedTags=new n.Models.Collections.Tags(e.promotedTags&&e.promotedTags.models||null),this.nonRenderedTags=new n.Models.Collections.Tags(e.tags.models),this.listenTo(n,"app:resize",this.onResize),this.listenTo(n,"app:resize",_.debounce(_.partial(this.calculateOffsetPosition,!0),300)),this.listenTo(this.model.get("renderedTags"),"reset",this.renderBtns),this.listenTo(this.model,"change:selectedTag",this.renderSelectedTag),this.listenTo(this.model,"change:selectedTag",this.onGenreChange),this.listenTo(r.model,"change:appSize",this.onAppSizeChange),this.listenTo(n,"scroll",this.handleScroll),this.listenTo(n,"page:redrawUpdate",_.bind(function(){this.calculateOffsetPosition(!0),this.handleScroll()},this)),Backbone.View.prototype.initialize.call(this,e)},render:function(){this.renderComplete=!1;var e=new ChainLoading;e.push(this.fetchTemplate(this.templateFile).done(e.bind(this.onTemplate,this,e))),e.push(this.fetchTemplate("genreBtns").done(e.bind(this.onBtnsTemplate,this,null,null))),e.done(e.bind(function(){this.calculateOffsetPosition(),this.handleScroll(),this.options.dontSelect||this.renderSelectedTag(),this.renderComplete=!0},this)),this.rendered=!0},onTemplate:function(e,t){this.$el.html(this.renderTemplate(t,{noOffset:this.noOffset})),this.bindUIElements(),this.listenTo(this.model,"change:refreshTimeout",this.renderRefreshBtn),this.listenTo(this.model,"change:mediaType",this.renderMediaFilter),this.listenTo(this.model,"change:groupType",this.renderGroupFilter),this.listenTo(n,"locale:loaded locale:changed",this.renderMediaFilter),this.listenTo(n,"locale:loaded locale:changed",this.renderGroupFilter),this.updateRefreshTimeout(),this.renderRefreshBtn(),this.renderMediaFilter(),this.renderGroupFilter(),this.renderFilterInput(),n.trigger("page:redrawUpdate")},renderFilterInput:function(){if(!this.showFilterInput||this.childViews.filterInput&&!this.childViews.filterInput.destroyed)return;this.ui.$filterInputContainer.removeClass("hide"),this.childViews.filterInput=new n.Views.FilterInput({el:this.ui.$filterInputContainer}),this.childViews.filterInput.render(),this.listenTo(this.childViews.filterInput.model,"change:filter",function(){var e=this.childViews.filterInput.model.get("filter");this.onFilterChange(e)})},renderBtns:function(e){var t=new $.Deferred;return this.btnsTemplate?this.onBtnsTemplate(t,e,this.btnsTemplate):this.fetchTemplate("genreBtns").done(_.bind(this.onBtnsTemplate,this,t,e)),t.promise()},renderMediaFilter:function(){var e=this.model.get("mediaType"),n=t.mediaTypes[e],r=_.getString(n);!e||!n||!r,r&&(this.ui.$filterMediaLabel.text(_.getString("SHOW_TYPE",{type:r})),this.ui.$filterMediaLabel.data("translateType",_.getString(n))),this.onResize()},renderGroupFilter:function(){if(n.getLoggedInUserID()===-1)return;this.ui.$filterUsers.removeClass("hide");var e=this.model.get("groupType"),r=t.groupTypes[e],i=_.getString(r);!e||!r||!i,i&&(this.ui.$filterUsersLabel.text(_.getString("BY_TYPE",{type:_.getString(r)})),this.ui.$filterUsersLabel.data("translateType",_.getString(r))),this.onResize()},onBtnsTemplate:function(e,t,n){this.btnsTemplate=n,this.renderComplete||this.estimateBtnsFit(),this.ui.$btns.html(this.renderTemplate(n,{tags:t||this.model.get("renderedTags"),excludeAllBtn:!!t})),e&&(e.resolve(),this.onResize())},estimateBtnsFit:function(){var e=Math.floor(this.ui.$inner.width()/this.averageBtnSize)-4,t=this.model.get("tags"),n=this.model.get("tags").slice(0,e);this.model.get("renderedTags").reset(n,{silent:!this.renderComplete}),this.nonRenderedTags.reset(t.slice(e))},onResize:_.debounce(function(){if(r.model.get("appSize")==="mobile")return;var e=this.ui.$btnContainer.width(),t=this.ui.$inner.width(),n;if(!e||!t)return;if(e<t){n=0;while(e<t&&t-e>this.averageBtnSize&&n<100)this.addBtnToRender(),e=this.ui.$btnContainer.width(),t=this.ui.$inner.width(),n++;return}if(e>=t){n=0;while(e>=t&&n<100)this.removeBtnToRender(),e=this.ui.$btnContainer.width(),t=this.ui.$inner.width(),n++}},200),calculateOffsetPosition:function(e){if(!this.$el._isSticky||e)this.offset=this.$el.offset().top},handleScroll:function(t){if(typeof this.offset!="number"||!this.renderComplete||$("body").hasClass("lb-open"))return;var r=e.outerWidth<n.Models.Model.APP_SIZES.desktop?$("#header").height():0,i=this.offset-r;t=t||$(document).scrollTop(),t>=i?this.$el._isSticky||(this.ui.$inner.addClass("sticky"),this.$el._isSticky=!0):this.$el._isSticky&&(this.ui.$inner.removeClass("sticky"),this.$el._isSticky=!1)},addBtnToRender:function(){var e=this.nonRenderedTags.shift();this.model.get("renderedTags").add(e),this.ui.$btns.append(this.renderTemplate(this.btnsTemplate,{tags:new n.Models.Collections.Tags([e]),excludeAllBtn:!0}))},removeBtnToRender:function(){var e=this.model.get("renderedTags").pop();this.nonRenderedTags.unshift(e),this.ui.$btns.children().last().remove()},renderSelectedTag:function(){var e=this.$(".selected"),t=this.model.get("selectedTag"),i;if(r.model.get("appSize")==="mobile"){e.removeClass("selected");return}t instanceof n.Models.Tag?i=this.$("[data-tag-id="+t.get("TagID")+"]"):i=this.$('[data-tag-id="all"]'),!i.length&&t instanceof n.Models.Tag?(i=this.ui.$genreDropdownBtn,this.ui.$genreDropdownBtnLabel.removeData("translateText").text(t.get("Tag"))):this.ui.$genreDropdownBtnLabel.translateText("CHOOSE_GENRE"),e.removeClass("selected"),i.addClass("selected")},onGenreClick:function(e){var t=$(e.currentTarget),n=t.data("tagId"),r=t.data("tag"),i;n==="all"?i="all":i=this.getTagModelForTag(r,n),this.model.set("selectedTag",i),this.ui.$genreDropdownBtnLabel.translateText("CHOOSE_GENRE")},onSelection:function(e){this.model.set("selectedTag",e)},getTagModelForTag:function(e,t){var r=n.Models.Tag.getCached(t);return r||(r=new n.Models.Tag({TagID:t,tag:e})),r},clickFilterMedia:function(e){var r;e.preventDefault();if(this.ui.$filterMedia.hasClass("menu-open")){n.trigger("tooltip:close");return}r={$attached:this.ui.$filterMedia,tooltipKey:"media-selector-menu",width:Math.max(this.ui.$filterMedia.outerWidth(),115),tooltipClass:"menu media-selector-menu",currentType:this.model.get("mediaType"),types:t.mediaTypes,callback:_.bind(function(e){this.model.set("mediaType",e)},this)},_.asyncTooltipMenu(this.ui.$filterMedia,r,this.model,"getGenericSelectMenu")},clickFilterUsers:function(e){var r;e.preventDefault();if(this.ui.$filterUsers.hasClass("menu-open")){n.trigger("tooltip:close");return}r={$attached:this.ui.$filterUsers,tooltipKey:"users-selector-menu",width:Math.max(this.ui.$filterUsers.outerWidth(),140),tooltipClass:"menu users-selector-menu",currentType:this.model.get("groupType"),types:t.groupTypes,callback:_.bind(function(e){this.model.set("groupType",e)},this)},_.asyncTooltipMenu(this.ui.$filterUsers,r,this.model,"getGenericSelectMenu")},clickFilterCombined:function(e){var r=this.model,i=this.model.get("mediaType"),s=this.model.get("groupType"),o=[];e.preventDefault();if(this.ui.$filterCombined.hasClass("menu-open")){n.trigger("tooltip:close");return}_.each(t.mediaTypes,function(e,t){o.push({localeKey:e,type:"html",html:'<a class="menu-item'+(i===t?" checked":"")+'"><i class="icon icon-check"></i>'+'<span data-translate-text="'+e+'" class="menu-title">'+_.getString(e)+"</span></a>",click:function(){r.set("mediaType",t)}})}),o.push({type:"divider"}),_.each(t.groupTypes,function(e,t){o.push({localeKey:e,type:"html",html:'<a class="menu-item'+(s===t?" checked":"")+'"><i class="icon icon-check"></i>'+'<span data-translate-text="'+e+'" class="menu-title">'+_.getString(e)+"</span></a>",click:function(){r.set("groupType",t)}})}),amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){n.Views.Tooltips.Menu.openTooltip({$attached:this.ui.$filterCombined,tooltipKey:"users-selector-menu",width:Math.max(this.ui.$filterCombined.outerWidth(),140),tooltipClass:"users-selector-menu",items:o})},this))},clickRefreshBtn:function(e){this.onRefreshFeed&&(this.onRefreshFeed(),this.updateRefreshTimeout())},clickGenreDropdownBtn:function(e){amdModules.requireDeferred("gs/views/tooltips/feedGenreSelector.js").done(_.bind(function(){var e="feed-genre-selector",t=this.model.get("renderedTags");n.trigger("tooltip:close",e),this.childViews.feedGenreSelector=new n.Views.Tooltips.FeedGenreSelector({onSelection:_.bind(this.onSelection,this),tooltipKey:e,promotedTags:_.difference(this.promotedTags.models,t.models)}),n.trigger("tooltip:open",{views:[this.childViews.feedGenreSelector],$attached:this.ui.$genreDropdownBtn,tooltipKey:e,positionSpill:"left",sticky:!0,width:542})},this))},renderRefreshBtn:function(){var e=this.model.get("refreshTimeout"),t=!!e||!this.onRefreshFeed;this.ui.$refreshBtn.toggleClass("hide",t),t||n.trigger("ad:refreshBtnUnhide")},updateRefreshTimeout:function(){if(!this.onRefreshFeed)return;var e=3e5,t=setTimeout(_.bind(function(){this.model.set("refreshTimeout",null)},this),e);clearTimeout(this.model.get("refreshTimeout")),this.model.set("refreshTimeout",t)},onAppSizeChange:function(e){var t=e.previousAttributes();t.appSize==="mobile"&&this.renderSelectedTag()}},{mediaTypes:{all:"ALL_MEDIA",songs:"SONGS",albums:"ALBUMS",artists:"ARTISTS",playlists:"PLAYLISTS",broadcasts:"BROADCASTS",people:"PEOPLE"},groupTypes:{everyone:"EVERYONE",community:"MY_COMMUNITY"},defaultTags:[10,75,156,424,750,1748,1933,2360,2856,3773,7512]})}(),function(){n.Views=n.Views||{},n.Views.SuggestedBroadcasts=Backbone.View.extend({className:"suggested-broadcasts",defaultVisibleCount:6,initialize:function(e){var t;this.visibleCount=_.orEqual(e.visibleCount,this.defaultVisibleCount),this.visibleBroadcasts=[],this.initialLoad=!0,this._rendered=!1,this.scrollElement=this.options.scrollElement,this.broadcasts=null,this.recentBroadcasts=null,this.preferRecent=e.preferRecent,this.usingRecent=!1,Backbone.View.prototype.initialize.call(this,e),this.preferRecent&&(t=r.model.get("player").get("queue"),this.listenTo(t,"change:currentBroadcast",this.onCurrentBroadcastChange),this.onCurrentBroadcastChange())},onDestroy:function(){this.faveUsers&&this.faveUsers.off(null,null,this),this.stopFetchLoop()},render:function(e){return this.startFetchLoop(this.initialLoad||e),this.initialLoad=!1,this.dfd},fetchLoop:function(){var e=this.model,t=new ChainLoading;this.fetchTimer=null;if(this.destroyed)return;this.dfd=$.Deferred(),t.fail(t.bind(this.dfd.reject,this.dfd)),e.get("isLoggedIn")?(t.push(n.Services.API.getAliveRecentBroadcastsForUser().done(t.bind(this.onRecentBroadcasts,this))),t.push(n.Models.Broadcast.getTopBroadcastsCombined().done(t.bind(this.onBroadcastsCombined,this))),t.push(e.getFavoritesByType("Users").done(t.bind(this.onFavoriteUsers,this)))):t.push(n.Models.Broadcast.getTopBroadcastsCombined().done(t.bind(this.onBroadcastsCombined,this))),t.push(this.fetchTemplate("shared/suggestedBroadcasts").done(t.bind(this.onTemplate,this)))},startFetchLoop:function(e){if(this.fetchTimer)return;n.on("userActivity",function(){this.isIdle&&(this.fetchLoop(),this.isIdle=!1)},this),e&&this.fetchLoop();if(Date.now()-r.lastActive>6e4){this.isIdle=!0;return}this.fetchTimer||(this.fetchTimer=setTimeout(_.bind(this.fetchLoop,this),3e4))},stopFetchLoop:function(){n.off("userActivity",null,this),this.fetchTimer&&(clearTimeout(this.fetchTimer),this.fetchTimer=null)},onCurrentBroadcastChange:function(e){var t=e?e.previous("currentBroadcast"):null,n=e?e.get("currentBroadcast"):null,r,i;t&&(t.get("UserID")===this.model.get("UserID")||t.get("activeStatus")===0)&&(t.markUnreadChatActivitiesRead(),this.collection&&this.collection.remove(t.id)),n?(this.visibleCount=this.options.visibleCount+1,this.collection&&(r=n.get("BroadcastID"),this.collection.remove(r),i=this.collection.findWhere({UserID:n.get("UserID")}),i&&this.collection.remove(i),this.collection.add(n,{at:0}))):this.visibleCount=_.orEqual(this.options.visibleCount,this.defaultVisibleCount)},onTemplate:function(e){var t=r.model.get("player").get("queue"),i=_.sortBy(this.broadcasts,this.onlineNowBroadcastSort,this),s,o,u;return this.totalSuggested=0,this.childViews.list&&(this.childViews.list.favoriteListeners=this.favoriteUsers),this.preferRecent&&this.recentBroadcasts&&t&&(u=t.get("currentBroadcast"),u&&u.get("UserID")!==this.model.get("UserID")&&this.recentBroadcasts.unshift(u)),this.collection||(this.collection=new n.Models.Collections.Broadcasts([],{modelOptions:{dontCache:!0}})),this.preferRecent?this.recentBroadcasts&&this.recentBroadcasts.length?(this.collection.reset(this.recentBroadcasts),this.usingRecent=!0):(s=r.model.get("user").getLocalPersonalizedTagIDs(),o=_.filter(i,function(e){var t=e.Tag;return t&&_.contains(s,t.i)}),o.length<this.visibleCount&&(o=i),this.collection.reset(_.shuffle(_.take(o,20)))):this.collection.reset(i),this._rendered||(this.$el.empty(),this.$el.html(this.renderTemplate(e))),this.visibleCount=Math.min(this.visibleCount,this.collection.length),this.childViews.list||(this.childViews.list=new n.Views.SuggestedBroadcastsList({el:this.$(".suggested-broadcast-grid")[0],collection:this.collection,$scrollEl:this.scrollElement,maxRenderableItems:this.visibleCount}),this.childViews.list.favoriteListeners=this.favoriteUsers,this.childViews.list.render()),this._rendered=!0,this.dfd.resolve(),this},buildFavoriteHash:function(e){this.favoriteUsers={},this.faveUsers.each(function(e){var t=e.get("currentBroadcastID");if(!t)return;this.favoriteUsers[t]?this.favoriteUsers[t].push(e):this.favoriteUsers[t]=[e]},this),e&&this.fetchTemplate("shared/suggestedBroadcasts").done(_.bind(this.onTemplate,this))},onFavoriteUsers:function(e){if(!e||!e.length)return;this.faveUsers&&this.faveUsers.off(null,null,this),this.faveUsers=e,this.faveUsers.on("change:currentBroadcastID",this.buildFavoriteHash,this,!0),this.buildFavoriteHash(),this.recentUsers=this.model.get("recentUsers")},onBroadcastsCombined:function(e){if(!e||!e.length)return;this.broadcasts=e},onRecentBroadcasts:function(e){if(!e||!e.length)return;e.sort(function(e,t){return _.toInt(t.TSListened)-_.toInt(e.TSListened)}),this.recentBroadcasts=e},onlineNowBroadcastSort:function(e){if(!e.ownerUserIDs)return;var t=0,n=this.recentUsers&&this.recentUsers[e.ownerUserIDs[0]],r=e.ownerUserIDs[0],i=e.BroadcastID,s=-1,o,u,a,f;n&&n.TSInteraction&&!this.preferRecent&&(t-=.01*n.TSInteraction),this.recentBroadcasts&&this.recentBroadcasts.length&&(a=_.find(this.recentBroadcasts,function(t){return t.UserID==r?t.BroadcastID===i||t.Tag===e.Tag&&t.Image===e.Image?!0:!1:!1},this),a&&(t-=a.TSListened));if(this.favoriteUsers){f=this.favoriteUsers&&this.favoriteUsers[i],t-=1e6*(f?f.length:0);if(f){u=f&&f.length;for(o=0;o<u;o++)f[o].get("UserID")==r&&(s=o);s!=-1&&(f.splice(s,1),this.favoriteUsers[i]=f)}}return t<0&&this.totalSuggested++,t}})}(),define("gs/views/filterInput.js",function(){n.Views.FilterInput=Backbone.View.extend({templatePath:"shared",templateFile:"filterInput",ui:{filter:".filter",clearBtn:".clear-filter"},events:{"keyup @filter":"keyupFilter","click @clearBtn":"clickClearBtn"},initialize:function(e){this.focusOnKeypress=_.orEqual(e.focusOnKeypress,!1),this.focusOnRender=_.orEqual(e.focusOnRender,!1),this.model=new Backbone.Model({filter:""}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDestroy:function(){this.focusOnKeypress&&$("body").off("keypress."+this.cid)},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.focusOnKeypress&&$("body").on("keypress."+this.cid,_.bind(this.keypressBody,this)),this.focusOnRender&&this.ui.$filter.focus()},keypressBody:function(e){e.target!==this.ui.$filter[0]&&(this.ui.$filter.focus(),e.stopPropagation())},keyupFilter:function(e){e.which===_.keyboard.ESC?(this.ui.$filter.val("").change().focus(),this.model.set("filter","")):this.model.set("filter",$.trim(this.ui.$filter.val()))},clickClearBtn:function(e){this.ui.$filter.val("").change().focus(),this.model.set("filter","")},modifyFilterValue:function(e){if(typeof e!="string")return;this.ui.$filter.val(e).change(),this.model.set("filter",e)}})}),define("gs/views/tagInput.js",function(){var e=Backbone.Model.extend({initialize:function(e,t){this.set({tags:new n.Models.Collections.Tags,selected:new n.Models.Collections.Tags,autocompleteVisible:!1,dfd:null}),this.listenTo(this,"change:dfd",this.updateAutocompleteVisible),n.Models.Tag.getTagList().done(_.bind(this.updateTags,this))},updateTags:function(e){var t=this.get("tags");t.reset(_.map(e,function(e,t){return{TagID:e,Tag:t}}))},updateAutocompleteVisible:function(){var e=this.get("dfd");if(!e){this.set("autocompleteVisible",!1);return}this.set("autocompleteVisible",!0),e.always(_.bind(function(){this.set("autocompleteVisible",!1)},this))},select:function(e){var t=this.get("dfd"),n=this.get("tags"),r=this.get("selected");t&&(t.resolve({id:e.id,model:e,text:e.get("DisplayName")}),n.remove(e),r.add(e))},deselect:function(e){var t=this.get("tags"),n=this.get("selected");t.add(e),n.remove(e)},getSelectedTagIDs:function(){var e=this.get("selected");return e.pluck("TagID")}});n.Views.TagInput=Backbone.View.extend({templatePath:"shared",templateFile:"tagInput",ui:{input:".input"},events:{"keydown @input":"keydownInput"},initialize:function(t){this.model=new e,Backbone.View.prototype.initialize.apply(this,_.toArray(arguments))},onDestroy:function(){this.ui.$input&&this.ui.$input.tagging("destroy")},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.ui.$input.tagging({minMatchLen:1,minMatchLenSansStart:1,searchCallback:_.bind(function(e,t){this.model.set("dfd",t),this.childViews.grid.filter(e||"")},this),removedCallback:_.bind(function(e){var t=e.model;this.model.deselect(t)},this)}),this.listenTo(this.model,"change:autocompleteVisible",this.renderAutocompleteVisible),this.renderAutocompleteVisible()},renderAutocompleteVisible:function(){var e=this.model.get("autocompleteVisible"),t;if(!this.childViews.grid||this.childViews.grid.destroyed)this.childViews.grid=new n.Views.TagRowSimpleGrid({collection:this.model.get("tags"),canvasMaxItems:5,keepSelectionOnFilter:!0,allowMultiSelect:!0,cycleSelect:!0,onItemClick:_.bind(function(e){this.model.select(e),this.ui.$input.focusCursorAtEnd()},this)}),this.listenTo(this.childViews.grid.visibleCollection,"reset",this.renderAutocompleteVisible);if(!this.childViews.autocomplete||this.childViews.autocomplete.destroyed)t=$.Deferred(),this.childViews.autocomplete=new n.Views.ManagedTooltip({tooltipKey:"tagInput."+this.cid,tooltipClass:"tooltip-tag-input",$attached:this.ui.$input,views:[this.childViews.grid],dfd:t,width:this.ui.$input.outerWidth()-2,adjustY:-18,sticky:!0,persist:!0,startHidden:!0},{clone:!1}),this.childViews.autocomplete.open(),t.done(_.bind(function(){this.childViews.autocomplete=null},this));e&&this.childViews.grid.visibleCollection.length?this.childViews.autocomplete.show():this.childViews.autocomplete.hide()},keydownInput:function(e){var t=this.childViews.grid,n;if(!t||!t.visibleCollection.length)return;e.which===_.keyboard.ENTER&&t.selectedItems.length>0?(n=t.selectedItems.first(),this.model.select(n),e.stopPropagation(),e.preventDefault()):(e.which===_.keyboard.TAB&&(e.which=_.keyboard.DOWN),t.handleArrowKeyPress(e))}})}),function(){n.Views=n.Views||{},n.Views.Badges=Backbone.View.extend({templatePath:"shared",templateFile:"badges",ui:{verified:".verified",premium:".premium"},initialize:function(e){this.item=e&&e.item,this.profile=null,this.isArtist=this.item&&!!this.item.get("ArtistID"),this.isPremium=!1,this.isVerified=!1,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){if(!this.item)return;this.fetchTemplate(this.templateFile).done(_.bind(this.onTemplate,this))},onTemplate:function(e){var t=n.Models.AuthUser.newOrUpdate({UserID:n.getLoggedInUserID()}),r;this.$el.html(this.renderTemplate(e,{authUser:t})),this.bindUIElements(),this.stopListening(),this.isArtist?(r=this.item.get("profileID"),this.listenTo(this.item,"change:Flags",this.renderVerified),n.Models.Profile.get(r).done(_.bind(function(e){this.profile=e,this.listenTo(this.profile.get("user"),"change:IsPremium",this.renderPremium),this.renderVerified()},this))):this.listenTo(this.item,"change:IsPremium",this.renderPremium),this.renderPremium(),this.renderVerified(),this.$el.toggleClass("hide",!this.isPremium&&!this.isVerified)},renderPremium:function(){this.isArtist?this.profile&&(this.isPremium=_.toInt(this.profile.get("user").get("IsPremium"))):this.isPremium=this.item.get("IsPremium"),this.ui.$premium.toggleClass("hide",!this.isPremium)},renderVerified:function(){this.ui.$verified.toggleClass("hide",!0),this.isVerified=!1}})}(),function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var t=!1,i=function(){r.model.get("player").attemptAutoRestoreQueue()},s=function(t,r,i){if(this!==this.options.parent.getCurrentPageView())return;i&&(r=r+"/"+i);if(_.isFunction(t.toUrl)){var s=t.toUrl(r);e.location.hash!==s&&e.location.hash.replace(/src=\d/,"")!==s.replace(/src=\d/,"")&&n.router.replaceHash(s)}};n.Views.Page=Backbone.View.extend({el:document.getElementById("container"),initialize:function(){Backbone.View.prototype.initialize.call(this),this.$container=$("#container"),this.hasRendered=!1},render:function(){this.hasRendered=!0,this.currentPageView&&this.currentPageView.render()},getCurrentPageView:function(e){e=e!==!1;var t=this.currentPageView;return e&&t&&_.isFunction(t.getOverridePageView)&&(t=t.getOverridePageView()),t},restorePage:function(e,t,r){this.currentPageView=e,this.$container.append(e.$el),e.delegateEvents(),e.resume(),e.updatePageParams(t),e.title&&e.setTitle(e.title,!1),this.$el.removeClass().addClass(e.pageType),n.trigger("change:page",e.pageType,t,this),n.trigger("page:ready",e),_.defer(function(){$(document).scrollTop(r||0)}),n.trigger("theme:preserveThemeHeight",e.pageType)},setPage:function(s,o){var u=$("#ocean"),a=$.Deferred(),f=!t,l=r.model.get("user"),c=function(){var e=$("#top-hat");e.is(":visible")&&(e.addClass("hide"),e.off("click.handlers"),u.removeClass("vip-required has-top-hat"),r.model.set("hasTopHat",!1),n.trigger("scroll"))},h=function(t,i){var s=$("#top-hat"),o=s.find(".inner"),a=s.find(".close-top-hat"),f=["has-top-hat"];i&&f.push("vip-required"),u.addClass(f.join(" ")),s.removeClass("hide"),s.on("click.handlers",".back-to-old",function(){_.cookie("stingray","0",{path:"/",domain:".grooveshark.com"}),r.model.set("dontAlertOnLeave",!0),setTimeout(function(){e.location="http://retro.grooveshark.com"},50)}),a.toggleClass("hide",i),a.on("click",c),r.model.set("hasTopHat",!0),$.localize.ready.done(function(){o.attr("data-translate-text",t).html(_.getString(t)),n.trigger("scroll")})};t=!0,n.premiumRequired()?(n.External.DesktopBridge.active?h("LB_LOGIN_MUST_UPGRADE_TO_ACCESS_APP",!0):h("LB_SIGNUP_LOGIN_FORM_PREMIUM_REQUIRED_ERROR_STINGRAY",!0),l&&l.get("isLoggedIn")&&!l.get("subscription").isPremium()?s==="userOnboarding"||s==="artistOnboarding"?c():(h("LB_SIGNUP_LOGIN_FORM_PREMIUM_REQUIRED_ERROR_STINGRAY_LOGGED_IN",!0),n.trigger("lightbox:open","payments",{headerVal:"UPGRADE",messageVal:"LB_PAYMENTS_STINGRAY_UPGRADE_MESSAGE",isStingrayPreview:!0}),s="upgrade"):s!=="registration"&&(s="login")):l.get("isArtist")?h("ARTISTS_USE_JAWHARP",!1):c();if(this.currentPageView&&this.currentPageView.pageType===s&&this.currentPageView.options&&this.currentPageView.options.id===o.id&&!o.notFound&&this.currentPageView.options.params&&!this.currentPageView.options.params.notFound)return o.fbComment?a.resolve():(this.$el.parent().scrollTop(0),this.currentPageView.updatePageParams(o),n.trigger("change:page",s,o,this),n.trigger("theme:preserveThemeHeight",s),a.resolve());if(s==="home"&&this.cachedHomePage){if(this.cachedHomePage.options.id===o.id)return this.removeCurrentPageView(),o&&o.possiblyResetPage?this.restorePage(this.cachedHomePage,o,0):this.restorePage(this.cachedHomePage,o,this.lastHomeScrollTop),a.resolve();this.uncacheHomePage()}n.trigger("theme:preserveThemeHeight",s);var p=_.bind(function(e){var t=n.Views.Pages[_.ucwords(s)];if(!t){console.log("page not really loaded",s);return}if(this.lastDfd!==e){console.log("page changed during loading of another page"),f&&i();return}this.removeCurrentPageView(),f&&(o.firstPage=!0);var u=document.getElementById("page-inner");u||(u=document.createElement("div"),u.id="page-inner"),this.$container.append(u),this.currentPageView=new t({el:u,id:o.id,parent:this,model:new Backbone.Model({appModel:this.model,gsApp:r}),params:o});if(this.currentPageView.destroyed){e.resolve();return}this.$el.removeClass().addClass(s),n.trigger("change:page",s,o,this),f&&this.currentPageView.wasFirstPage(),this.hasRendered&&this.currentPageView.render(),e.resolve()},this,a),d=n.Views.Pages[_.ucwords(s)],v=new ChainLoading;this.lastDfd=a;if(!d){var m=["artistDashboard","settings","upgrade","queue","promotion","surveys","artistOnboarding","userOnboarding","mobileUserOnboarding","registration","login","artistAnalytics","feedEvent","taco","notFound","newFeatures"],g="gs/views/pages/"+s+".js";_.contains(m,s)&&(g=s+"Page"),v.push(amdModules.requireDeferred("gs/views/pages/pageHeader.js")),v.push(amdModules.requireDeferred(g)).fail(function(){f&&(t=!1),a.reject()})}else s!=="home"&&v.push(amdModules.requireDeferred("gs/views/pages/pageHeader.js"));return v.done(p),a.promise()},removeCurrentPageView:function(e){var t=e||{},r=!0;this.currentPageView&&(this.currentPageView instanceof n.Views.Pages.Home&&(this.lastHomeScrollTop=$(document).scrollTop(),t.destroyHomePage||(this.cachedHomePage=this.currentPageView,this.cachedHomePage.suspend(),this.cachedHomePage.undelegateEvents(),this.cachedHomePage.$el.detach(),r=!1)),r&&(this.currentPageView.cleanupChildViews(),this.currentPageView.destroy()),$(document).scrollTop(0),this.currentPageView=null)},uncacheHomePage:function(){this.cachedHomePage.destroy(),this.cachedHomePage=null}}),n.Views.Pages.Base=Backbone.View.extend({headerRatio:1280/220,minHeaderHeight:220,maxHeaderHeight:Infinity,setTitle:function(e,t){n.trigger("setTitle",{title:e,prepend:t,page:this})},correctUrl:function(e,t,n){_.delay(_.bind(function(){if(this!==this.options.parent.getCurrentPageView())return;e&&(_.isFunction(e.getPathName)?e.getPathName().then(_.bind(s,this,e,t,n)):s.call(this,e,t,n))},this))},wasFirstPage:i,blockPageChange:function(e){return!1},updatePageParams:function(){},suspend:function(){this.suspended=!0,this.childViews&&_.each(this.childViews,function(e){typeof e.suspend=="function"&&e.suspend()})},resume:function(){this.suspended=!1,this.childViews&&_.each(this.childViews,function(e){typeof e.resume=="function"&&e.resume()})},pageLoadFailed:function(){if(this.destroyed)return;n.router.notFound()},showSubpage:function(e){var t=this.$(".subpage"),n=t.filter('[data-subpage="'+e+'"]'),r=n.siblings(".subpage");n.removeClass("hide"),r.addClass("hide")},teardownSubpage:function(e,t){var n=e||{};this.childViews.pageHeader&&(n.pageHeader=!0),this.childViews.pageNav&&(n.pageNav=!0),this.cleanupChildViews(!1,{exclude:n,remove:!!t})},getPlayMenu:function(e,t){t=_.orEqual(t,{});var r=[{key:"PLAY_NOW",title:_.getString("PLAY_NOW"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Models.Player.playSpecialIndexes.DEFAULT,!0,t.playContext)}},customClass:"jj_menu_item_play"},{key:"PLAY_NEXT",title:_.getString("PLAY_NEXT"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Models.Player.playSpecialIndexes.NEXT,!1,t.playContext)}},customClass:"jj_menu_item_play_next"},{key:"PLAY_LAST",title:_.getString("PLAY_LAST"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Models.Player.playSpecialIndexes.LAST,!1,t.playContext)}},customClass:"jj_menu_item_play_last"},{customClass:"separator"},{key:"REPLACE_QUEUE",title:_.getString("REPLACE_QUEUE"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Models.Player.playSpecialIndexes.REPLACE,!0,t.playContext)}},customClass:"jj_menu_item_replace_playlist"},{key:"START_STATION",title:_.getString("START_STATION"),action:{type:"fn",callback:function(){n.trigger("player:startRadioWithSongs",e)}},customClass:"jj_menu_item_replace_playlist"}];return r},handleFavoriteButtonChange:function(e,t){var n=["artist","playlist","user"],r=$("a.favorite-page",this.el),i=_.getItemType(e);if(_.indexOf(n,i)==-1||_.isUndefined(r))return;var s=this.model.get("appModel").get("user"),o=this.model.get(i).get("isFavorite"),u="",a="";if(i=="playlist")u="SUBSCRIBED",a="SUBSCRIBE";else if(i=="artist"||i=="user")u="FOLLOWING",a="FOLLOW";o?(r.addClass("btn-success"),r.find(".icon").removeClass("icon-plus").addClass("icon-check white"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",u).text(_.getString(u))):(r.removeClass("btn-success"),r.find(".icon").addClass("icon-plus").removeClass("icon-check white"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",a).text(_.getString(a)))},onAddDropdownClick:function(e){e.preventDefault();var t=$(e.currentTarget);if(t.hasClass("menu-open")){n.trigger("tooltip:close");return}amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed||this.suspended)return;var e,i,s,o,u,a,f;switch(this.pageType){case"song":e=this.model.get("song")||n.Models.Song.getCached(t.data("songId"));break;case"album":e=this.model.get("album")||n.Models.Song.getCached(t.data("albumId"));break;case"queuePage":e=n.Models.Song.getCached(t.data("songId"));break;default:return}s={pageType:this.pageItemType||this.pageType},o=r.model.get("user"),u={tooltipKey:"add-menu",sticky:!0,delay:0,width:180,positionSpill:"right",$attached:t,tooltipClass:"add-menu",pageType:this.pageItemType||this.pageType},a=new ChainLoading,o.id>0&&a.push(o.getPlaylists()),a.push(amdModules.requireDeferred("gs/views/tooltips/menu.js")).done(_.bind(function(){u.items=n.contextMenus.getContextMenuForAddDropdown(e,s,u),f=n.Views.Tooltips.Menu.openTooltip(u),t.addClass("active"),f.dfd.always(function(){t.removeClass("active")})},this))},this))}}),n.Views.Pages.ItemPage=n.Views.Pages.Base.extend({commentsRendered:!1,initialize:function(){return this.$el.on("click",".column2-tab",_.bind(this.toggleCommentsActivity,this)),this.model.has("defaultSidebarTab")||this.model.set("defaultSidebarTab","comments"),n.Views.Pages.Base.prototype.initialize.call(this)},toggleCommentsActivity:function(e){var t=$(e.currentTarget),n=$("#comments"),r=$("#activity");t.hasClass("show-comments")?(r.addClass("hide"),n.removeClass("hide")):(n.addClass("hide"),r.removeClass("hide")),t.addClass("active").siblings().removeClass("active")},showActivity:function(){$("#comments").addClass("hide"),$("#activity").removeClass("hide"),$("#comments-tab").removeClass("active"),$("#activity-tab").addClass("active")},showComments:function(){$("#activity").addClass("hide"),$("#comments").removeClass("hide"),$("#comments-tab").addClass("active"),$("#activity-tab").removeClass("active")},handleCommentSubpage:function(){var e=null,t=this.model.get("subpage"),n=this.model.get("section");if(t&&t.indexOf("comment")===0){var r=t.split("/");r[1]?e=r[1]:e=n}return e},loadComments:function(e,t,r){var i;this.pageItemType=="artist"&&(i=this.model.get("artist"),e=i.get("ArtistID"));if(r)return this.highlightSingleComment(r,e,t);var s=$.Deferred(),o;if(this.pageItemType=="artist"){o=i.getCommentsAndLatestFanUpdate();var u=n.Models.Comment.getTypeIDFromTypeString(this.pageItemType);t?t.pushIgnoreFail(o.done(t.bind(function(t){this.renderComments(s,t.comments,e,u,t.hasMoreComments,null,t.fanUpdate)},this))):o.done(_.bind(function(t){this.renderComments(s,t.comments,e,u,t.hasMoreComments,null,t.fanUpdate)},this))}else o=n.Models.Comment.loadComments(this.pageItemType,e),t?t.pushIgnoreFail(o.done(t.bind(this.renderComments,this,s))):o.done(_.bind(this.renderComments,this));return s.promise()},highlightSingleComment:function(e,t,r){var i=$.Deferred(),s;r?s=r.fork():s=new ChainLoading;var o=[i],u=_.bind(function(){this.renderComments.apply(this,o),this.showComments()},this);return s.push(n.Models.Comment.loadComments(this.pageItemType,t).done(s.bind(function(){o=o.concat(_.toArray(arguments))},this))),s.push(n.Models.Comment.get(e).done(s.bind(function(e){o.push(e),u()},this)).fail(s.bind(function(){o.push(-1),u()},this))),r&&r.pushIgnoreFail(s),i.promise()},renderComments:function(e,t,r,i,s,o,u){if(this.destroyed||!this.indexRendered)return;if(o===-1)n.router.notFound();else if(o&&(o.get("TypeID")!==i||o.get("ItemID")!==r)){n.router.replaceHash(o.toUrl());return}if(!t||!(t instanceof n.Models.Collections.Comments))t=new n.Models.Collections.Comments([]);this.childViews.commentsView&&this.childViews.commentsView.destroy(!1);var a=this.model.get(this.pageItemType),f="";switch(i){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:f=a.escape("ArtistName");break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:f=a.escape("AlbumName");break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:f=a.escape("PlaylistName");break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:f=a.escape("Name");break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:f=a.escape("SongName")}var l=$("#comments").empty();this.childViews.commentsView=new n.Views.Comments({el:l[0],collection:t,itemID:r,typeID:i,model:this.model,item:a,itemName:f,highlightComment:o,fanUpdate:u,commentLimit:this.options.commentLimit}),this.childViews.commentsView.showHideCommentBox=_.bind(function(e){this.$("#comment-submit").toggleClass("hide",!e)},this),this.childViews.commentsView.render().done(function(){e&&e.resolve();if(o){var t=$(".comments-grid").offset().top;$("body").animate({scrollTop:t-$("#header").height()},t/5)}}).fail(function(){e&&e.reject()}),this.commentsRendered||this.listenTo(this.model.get("appModel"),"change:user",this.renderComments,e,t,r,i),this.commentsRendered=!0},loadProfileImageLightbox:function(){var e=this.model.get("user"),t='<img class="show-art" src="'+e.getImageURL("")+'">';if(!e.attributes.hasOwnProperty("Picture"))return;n.trigger("lightbox:open","generic",{_type:"image",view:{headerHTML:e.escape("UserName"),messageHTML:t}})}})}(),define("gs/views/pages/home.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e=6e5,t;n.Views.Pages.Home=t=n.Views.Pages.Base.extend({templatePath:"home",pageType:"home",title:"Listen to Free Music Online - Internet Radio - Free MP3 Streaming",ui:{feedContainer:".feed-container"},events:{"click .slide-control.next":"onNextSlideClick","click .slide-control.prev":"onPrevSlideClick"},initialize:function(e){n.Views.Pages.Base.prototype.initialize.call(this,e),this.rendered=!1,this.model.set({sliderPosition:0,user:this.model.get("appModel").get("user")}),e.params.tagID&&this.model.set("tag",n.Models.Tag.newOrUpdate({TagID:e.params.tagID,TagName:e.params.tagName||""}))},onDestroy:function(){this.model.off("change:tab",null,this)},suspend:function(){this._super.call(this,"suspend"),this.childViews.feedView&&this.childViews.feedView.suspend()},resume:function(){this._super.call(this,"resume"),this.childViews.feedView&&this.childViews.feedView.handleResize()},updatePageParams:function(t){var r=this.options.params,i=t.mediaType,s=t.groupType,o;t.tagID?(o=n.Models.Tag.newOrUpdate({TagID:t.tagID,Tag:t.tagName||""}),this.model.set("tag",o)):this.model.set("tag",null),this.options.params=t,r.notFound!==t.notFound||t.possiblyResetPage&&(!this.lastRendered||$.now()-this.lastRendered>e)?(this.cleanupChildViews(),this.render()):t.possiblyResetPage&&$("body").scrollTop(0),this.childViews.genreSelector&&(this.childViews.genreSelector.model.set("mediaType",i||"all"),this.childViews.genreSelector.model.set("groupType",s||"everyone"),this.childViews.genreSelector.model.set("selectedTag",o)),this.updateFeed()},updateFeed:function(){var e=this.model.get("tag")?[this.model.get("tag").get("TagID")]:"default";this.childViews.genreSelector&&!this.childViews.genreSelector.destroyed&&this.childViews.feedView.model.set({mediaType:this.childViews.genreSelector.model.get("mediaType"),groupType:this.childViews.genreSelector.model.get("groupType")}),this.childViews.feedView&&this.childViews.feedView.updateFeed(e)},render:function(){var e=this.model.get("appModel").get("user"),t=new ChainLoading,r=$.Deferred(),i=this.model.get("tag")?this.model.get("tag").get("TagID"):"",s=i?[i]:[],o,u,a;this.setTitle(this.title,!1);if(s.length===0&&e.id<0){o=e.getLocalPersonalizedTagIDs(),o&&o.length&&(s=_.take(o,3));if(s.length&&s.length<3){u=n.Services.Local.get("signedOutExtraTags"),a=Date.now();if(!u||!u.ts||Math.abs(Date.now()-u.ts)<36e5)u={ids:_.shuffle([2856,156,3773,1748]),ts:a},n.Services.Local.set("signedOutExtraTags",u);s=_.take(_.union(s,u.ids),3)}}this.childViews.feedView&&this.childViews.feedView.destroy(),console.log("Rendering homepage feed"),this.childViews.feedView=new n.Views.Feed({appModel:this.model.get("appModel"),user:e,tagIDs:s,renderWaitDfd:r,includeProfileCompletion:!0,includePeopleYouMayKnow:!0,includeListenAgain:!0,mediaType:this.options.params.mediaType,groupType:this.options.params.groupType}),t.push(this.fetchTemplate("index")).done(_.bind(this.onTemplate,this)).done(_.bind(r.resolve,r)),t.push(this.childViews.feedView.render()),e.get("isLoggedIn")?(t.push(e.getRecentListens()),t.push(e.getPersonalizedTags()).done(_.bind(this.onPersonalizedTags,this))):t.done(_.bind(this.onPersonalizedTags,this,!1)),t.fail(_.bind(this.onRenderFailed,this))},onRenderFailed:function(e){if(e&&e.aborted)return;var t={};e&&e.code?(t.code=e.code,t.message=e.message,t.method=e.apiMethod):typeof e=="string"?t.message=e:e instanceof Error&&(t.message=e.message),n.Services.Log.notify("Home page failed to load","ERROR",t)},onTemplate:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e)),this.bindUIElements(),this.ui.$feedContainer.empty().append(this.childViews.feedView.$el),this.stopListening(),this.listenTo(this.model,"change:sliderPosition",this.renderSliderPosition),this.rendered=!0,this.lastRendered=$.now(),this.options.params.possiblyResetPage&&($("body").scrollTop(0),delete this.options.params.possiblyResetPage),n.trigger("page:ready",this)},onPersonalizedTags:function(e){if(this.destroyed)return;var t=gsConfig.countryTags,r=_.bind(function(e){if(!e)return;if(this.destroyed)return;this.childViews.genreSelector&&(this.childViews.genreSelector.destroy(!1),this.stopListening(this.childViews.genreSelector.model));var r=_.sortBy(n.Models.Tag.topGenres,function(e){return e.tag}),i=new n.Models.Collections.Tags(e),s,o;i.add(t),s=i.clone(),i.add(r),o=new n.Views.GenreSelector({el:this.$(".genre-selector-container"),promotedTags:s,tags:i,selectedTag:this.model.get("tag"),onRefreshFeed:_.bind(this.onRefreshFeed,this)}),this.listenTo(o.model,"change:selectedTag",this.onGenreSelected),this.listenTo(o.model,"change:mediaType change:groupType",this.updateFeed),o.render(),this.$(".genre-selector-container").removeClass("hide"),this.childViews.genreSelector=o},this);if(!e||!e.length){if(t){r([]);return}e=_.shuffle(n.Views.GenreSelector.defaultTags)}n.Models.Tag.getMetaMulti(e.pluck("TagID")).done(r)},onGenreSelected:function(e,t){if(this.destroyed||!this.childViews.feedView)return;var r;if(t=="all")r="/#!/";else{if(!t)return;r="/genre/"+_.cleanNameForURL(t.get("Tag"))+"/"+t.get("TagID")}n.router.setHash(r)},onRefreshFeed:function(){this.childViews.feedView&&!this.childViews.feedView.destroyed&&this.childViews.feedView.refreshFeed()}},{})}),define("gs/views/pages/profile.js",function(){function i(e){return e.get("IsVerified")}function s(e){return e.get("ReleaseType")>0&&e.get("ReleaseType")<4}n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var r;n.Views.Pages.Profile=n.Views.Pages.ItemPage.extend({templatePath:"profile",pageType:"profile",defaultSubpage:"profile",defaultCardOrder:[{Name:"about"},{Name:"bcRow"},{Name:"shareCard"},{Name:"topArtists"},{Name:"favorites"},{Name:"recentListens"},{Name:"following"},{Name:"playlists"}],events:{"click .upload-music":"onUploadClick","click .create-playlist":"onCreatePlaylistClick","click #user-image.has-art":"loadProfileImageLightbox","click .suggest-tags":"onSuggestTagsClick","click .edit-featured-songs":"editFeaturedSongs","click .cancel-edit-featured":"showHideTopSongs","click .save-featured-songs":"saveFeaturedSongs","click .switch-top-songs":"switchBackToTopSongs","click .undo-related-artists":"undoRelatedArtistsChanges","click #notifications-show-more":"loadMoreNotifications","click #music-grid-show-more":"onShowMoreClick","click #secondary-grid-show-more":"toggleNiceAlbums","click .toggle-hidden-cards":"onToggleHiddenCardsClick"},initialize:function(e){var t=this.options.params;t.subpage=_.orEqual(t.subpage,this.defaultSubpage),r=this.model.get("gsApp"),n.Views.Pages.Base.prototype.initialize.call(this,e),this.rendered=!1,this.renderCalled=!1,this.modelBindings=[];var i=_.toInt(t.id),s=_.toInt(t.artistID);if(!s&&i<1){n.router.notFound();return}t.section==="join"&&(t.section="",t.subpageData="join"),this.model.set({userID:i,artistID:s,subpage:_.orEqual(t.subpage,this.defaultSubpage),subpageData:t.subpageData,section:_.orEqual(t.section,"")}),this.firstPage=t&&t.firstPage,e.profile?this.onProfileLoad(e.profile):this.loadModel()},loadModel:function(){if(!this.modelLoadDfd){this.modelLoaded=!1;var e=this.model.get("userID");e<0&&(e=null),this.modelLoadDfd=n.Models.Profile.get(e,this.model.get("artistID"),!0,!0,{notifyCache:!0}).done(_.bind(this.onProfileLoad,this)).fail(_.bind(this.onProfileFail,this))}return this.modelLoadDfd},onDestroy:function(){r.model.off("change:user",null,this),_.each(this.modelBindings,_.bind(function(e){e.off(null,null,this)},this));var e=this.model.get("user"),t=this.model.get("artist");if(e){e.off(null,null,this),this.subscribedToStatus&&(e.unsubscribeFromStatus("userPage"),this.subscribedToStatus=!1);var n=e.get("followers");n&&n.off(null,null,this);var i=e.get("favoriteUsers");i&&i.off(null,null,this)}t&&t.off(null,null,this),this.broadcastView&&(this.broadcastView.cleanupChildViews(),this.broadcastView.destroy(!1),this.broadcastView=null)},wasFirstPage:function(){},updatePageParams:function(e){var t=this.rewriteSubpages(e),n=this.model.get("subpage"),r=this.model.get("section"),i=this.model.get("subpageData");t.section==="join"&&(t.section="",t.subpageData="join");if(n===t.subpage&&r===t.section&&i===t.subpageData)return;this.model.set({subpage:t.subpage,section:t.section,subpageData:t.subpageData});if(this.broadcastView&&e.subpage==="broadcast"&&this.broadcastView.updatePageParams(_.clone(t)))return;this.pageItemType=="artist"?this.updateArtistSubpage(t.subpage):this.updateUserSubpage(t.subpage)},rewriteSubpages:function(e,t){var r=this.model.get("user"),i=this.model.get("artist"),s=i&&n.isLoggedInUserOwnerOfArtist(i.get("ArtistID")),o=i||r,u=e,a=u.subpage||"",f=t;a==="profile"&&(a="");if(o){switch(u.subpage){case"music":i&&!s?u.subpage="":u.subpage="collection",f=!0;break;case"favorites":u.subpage="collection",u.section="favorites",f=!0;break;case"fans":u.subpage="followers",f=!0;break;case"collection":i&&!s&&(u.subpage="",f=!0)}f&&this.correctUrl(o,a+(u.section&&a!==""?"/"+u.section:""),u.subpageData)}return u},onUsernameChange:function(){var e=this.model.get("artist")||this.model.get("user"),t=this.options.params,n=t.subpage;n==="profile"&&(n=""),this.correctUrl(e,n+(t.section&&n!==""?"/"+t.section:""),t.subpageData)},onProfileLoad:function(e){var t=e.get("user");if(!t){this.onProfileFail();return}this.model.set({user:t,userID:t.get("UserID")}),this.modelLoaded=!0,this.listenTo(t,"change:isFavorite",this.handleFavoriteButtonChange),this.listenTo(t,"change:listens",this.renderListens),this.listenTo(t,"change:PathName",this.onUsernameChange);var i=e.get("artist");i?(this.model.set("artist",i),this.pageItemType="artist"):this.pageItemType="user",this.isLoggedInUser=n.getLoggedInUserID()===t.get("UserID"),this.options.params=this.rewriteSubpages(this.options.params,!0),this.renderCalled&&this.render();var s=_.extend(this.options.params,{artistID:i&&i.id});n.trigger("change:page:type",this.pageType,s,r.page)},onProfileFail:function(){n.router.notFound()},render:function(){if(this.destroyed)return;if(!this.modelLoaded){this.waitingForLoad||this.loadModel().done(_.bind(this.render,this)),this.waitingForLoad=!0;return}this.indexRendered=!1,this.renderCalled=!0;if(this.rendered)return;this.cleanupChildViews();var e=this.model.get("user"),t=this.model.get("section"),i=this.model.get("subpage"),s=this.model.get("subpageData"),o;if(!e)return;i!=="broadcast"?(this.fetchTemplate("index").done(_.bind(this.renderIndex,this)),this.firstPage&&(this.firstPage=!1,n.Views.Pages.Base.prototype.wasFirstPage.call(this))):(this.lastBroadcastRenderChain&&this.lastBroadcastRenderChain.stop(),o=new ChainLoading,o.push(amdModules.requireDeferred("gs/views/pages/archivedBroadcast.js")),o.push(amdModules.requireDeferred("gs/views/pages/broadcast.js")),o.push(e.getPageNameData()),this.subscribedToStatus||(o.push(e.subscribeToStatus("userPage")),this.subscribedToStatus=!0),o.done(_.bind(function(){if(this.destroyed)return;var i=e.get("currentBroadcastID"),o,u,a;this.broadcastView&&(this.broadcastView.destroy(!1),this.broadcastView=null),t&&t!==i&&t!=="current"?(o=new Backbone.Model({appModel:r.model,gsApp:r}),this.broadcastView=new n.Views.Pages.Archivedbroadcast({el:this.el,model:o,params:{broadcastID:t}}),this.broadcastView.render()):(u=s==="join"||this.firstPage,o=new Backbone.Model({appModel:r.model,gsApp:r,owner:e,joinOnLoad:u}),this.options.params&&this.options.params.broadcast&&(a=this.options.params.broadcast,delete this.options.params.broadcast),this.broadcastView=new n.Views.Pages.Broadcast({el:this.el,broadcastID:t,broadcast:a,model:o,subpage:s||null}),this.broadcastView.render())},this)),this.lastBroadcastRenderChain=o)},renderIndex:function(e){if(this.destroyed||!this.model.get("user"))return;var t=this.model.get("appModel"),r=t.get("user"),i=this.model.get("user"),s=this.model.get("artist"),o=i.get("UserID"),u=this.model.get("subpage"),a=[],f=[],l,c,h,p,d;if(s){var v=s.get("ArtistID");d=s.get("ArtistName"),p=s.getImageURL(120),l=r.get("artistID")==v,a.push({url:s.toUrl(),subpage:"profile",locale:"OVERVIEW"},l?{url:s.toUrl("collection"),subpage:"collection",locale:"COLLECTION"}:null,{url:s.toUrl("events"),subpage:"events",locale:"EVENTS"},{url:s.toUrl("similar-artists"),subpage:"similar-artists",locale:"RELATED_ARTISTS"},{url:s.toUrl("followers"),subpage:"followers",locale:"FOLLOWERS",className:"followers"},{url:s.toUrl("following"),subpage:"following",locale:"FOLLOWING",className:"following"}),f.push({btnClass:"play-station btn-primary",icon:"icon-play-circle-fill icon-large",btnLocale:l&&!gsConfig.isMobile?"PLAY_MY_STATION":"PLAY_STATION",dataAttr:"artist-id",dataVal:s.get("ArtistID")},l?null:{btnClass:"favorite btn-translucent",icon:"icon-plus",btnLocale:"FOLLOW",dataAttr:"artist-id",dataVal:s.get("ArtistID")},{btnClass:"share btn-translucent",icon:"icon-repost",btnLocale:gsConfig.isMobile?"SHARE":"SHARE_TO_FEED",dataAttr:"artist-id",dataVal:s.get("ArtistID")},l?{url:"/#!/settings",btnClass:"btn-translucent",icon:"icon-edit",btnLocale:gsConfig.isMobile?"EDIT":"EDIT_PROFILE",dataAttr:"artist-id",dataVal:s.get("ArtistID")}:null),h=s.get("CoverArtFilename"),c={subpage:u,item:s,type:this.pageItemType,name:s.get("ArtistName"),artistID:v,userOwnsPage:l,canHideAds:t.get("user").get("subscription").canHideAds()}}else d=i.get("Name"),p=i.getImageURL(120),l=n.getLoggedInUserID()==i.get("UserID"),a.push({url:i.toUrl(),subpage:"profile",locale:"OVERVIEW"},gsConfig.isMobile?{url:i.toUrl("collection/favorites"),subpage:"collection",locale:"FAVORITES",section:"favorites"}:null,{url:i.toUrl("collection"),subpage:"collection",locale:"COLLECTION"},{url:i.toUrl("playlists"),subpage:"playlists",locale:"PLAYLISTS",className:"playlists"},{url:i.toUrl("followers"),subpage:"followers",locale:"FOLLOWERS",className:"followers"},{url:i.toUrl("following"),subpage:"following",locale:"FOLLOWING",className:"following"}),f.push({btnClass:"play-station btn-primary",icon:"icon-play-circle-fill icon-large",btnLocale:l&&!gsConfig.isMobile?"PLAY_MY_STATION":"PLAY_STATION",dataAttr:"user-id",dataVal:i.get("UserID")},l?null:{btnClass:"favorite btn-translucent",icon:"icon-plus",btnLocale:"FOLLOW",dataAttr:"user-id",dataVal:i.get("UserID")},{btnClass:"share btn-translucent",icon:"icon-repost",btnLocale:gsConfig.isMobile?"SHARE":"SHARE_TO_FEED",dataAttr:"user-id",dataVal:i.get("UserID")},l?{btnClass:"btn-translucent",url:"/#!/settings",icon:"icon-edit",btnLocale:gsConfig.isMobile?"EDIT":"EDIT_PROFILE",dataAttr:"user-id",dataVal:i.get("UserID")}:null),h=i.get("Picture"),c={subpage:u,item:i,type:this.pageItemType,name:i.get("Name"),userID:o,userOwnsPage:o===n.getLoggedInUserID(),canHideAds:t.get("user").get("subscription").canHideAds()};this.$el.html(this.renderTemplate(e,c)),this.indexRendered=!0,this.currentSubpage=null,s?this.updateArtistSubpage(u):this.updateUserSubpage(u),this.childViews.pageHeader=new n.Views.PageHeader({el:this.$("#page-header"),item:s||i,navItems:a,model:this.model,actions:f,title:d,picture:h,imageURL:p}),this.childViews.pageHeader.render(),n.trigger("page:ready",this)},handleSubpageAndComments:function(e){e||(e="profile",this.model.set("subpage","profile"));var t=this.handleCommentSubpage();t&&(e=this.defaultSubpage,this.model.set({subpage:e,section:""}));if(this.currentSubpage===e){switch(e){case"followers":case"following":return""}return e}return this.currentSubpage=e,this.showSubpage(e),this.highlightedCommentID=t,e},renderShareCard:function(e,t){var r=this.model.get("user"),i=!r||!r.get("isArtist"),s=n.getLoggedInUserID()==(r&&r.get("UserID")),o=i&&s,u=!t||!t.length,a,f;this.childViews.shareCard&&(this.childViews.shareCard.destroy(!0),this.childViews.shareCard=null);if(u){if(!o)return;a=n.Views.Cards.extendArrangeable(n.Views.Cards.Empty),f={title:"EMPTY_SHARES",desc:"EMPTY_SHARES_DESC",cardName:"shareCard",cardTitle:"SHARES",hideAction:!0,onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)}}else a=o?n.Views.Cards.extendArrangeable(n.Views.Cards.ShareList):n.Views.Cards.ShareList,f={cardName:"shareCard",seeAllUrl:r.toUrl("shares"),showMoreVal:25,showFull:e,appModel:this.model.get("gsApp").model,gridOptions:{collection:t},showLengthInTitle:!0,onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)};this.childViews.shareCard=new a(f),this.childViews.shareCard.render(),e&&this.$("#shares-subpage").append(this.childViews.shareCard.$el)},renderAboutCard:function(){var e=this.model.get("user"),t=this.model.get("artist"),r=e&&!e.get("artistID"),i=n.getLoggedInUserID()==(e&&e.get("UserID")),s=r&&i,o=r?e&&e.get("pageNameData"):t.get("pageNameData"),u=o&&o.Bio,a=o&&o.URLs,f,l,c;t&&!u?u=t.get("Bio")||t.get("Description")||t.get("About"):e&&!u&&(u=e.get("Bio")||e.get("Description")||e.get("About")),f=!a&&!u,this.childViews.about&&(this.childViews.about.destroy(!0),this.childViews.about=null);if(f){if(!s)return;c=n.Views.Cards.extendArrangeable(n.Views.Cards.Empty),l={title:"EMPTY_PROFILE_TITLE_OWNER",desc:"EMPTY_PROFILE_DESC_OWNER",actionLabel:"EDIT_PROFILE",action:function(){n.router.setHash("/settings")},cardName:"about",cardTitle:"ABOUT",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)}}else c=s?n.Views.Cards.extendArrangeable(n.Views.Cards.About):n.Views.Cards.About,l={cardTitleLocale:"ABOUT",model:this.model.get("artist")||this.model.get("user"),cardName:"about",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)};this.childViews.about=new c(l),this.childViews.about.render(),r||this.$("#about-container").empty().append(this.childViews.about.$el).removeClass("hide")},updateUserSubpage:function(e){var t=n.getAppSize()==="mobile",r,i,s,o,u,a;e=this.handleSubpageAndComments(e);if(!e)return;if(this.broadcastView&&e!=="broadcast"){this.broadcastView.cleanupChildViews(),this.broadcastView.destroy(!1),this.broadcastView=null,this.rendered=!1,this.render();return}r=new ChainLoading,i=this.model.get("user"),s=i&&n.getLoggedInUserID()==i.get("UserID");switch(e){case"profile":$("#profile-subpage").find(".content").addClass("hide"),$("#comments-container").removeClass("hide"),this.subscribedToStatus||(i.subscribeToStatus("userPage"),this.subscribedToStatus=!0),s&&r.push(amdModules.requireDeferred("gs/views/cards/arrangeable.js")),r.push(amdModules.requireDeferred("gs/views/cards/empty.js")),r.push(amdModules.requireDeferred("gs/views/cards/topArtists.js")),r.pushIgnoreFail(i.getTopArtists()).done(_.bind(this.renderTopArtists,this)),r.push(amdModules.requireDeferred("gs/views/cards/songList.js")),r.push(i.getRecentListens()).done(_.bind(this.renderRecentListens,this)),r.push(i.getFavoritesByType("Songs")).done(_.bind(this.renderFavoritesCard,this)),r.push(amdModules.requireDeferred("gs/views/cards/userList.js")),r.push(i.getFavoritesByType("Users")).done(_.bind(this.renderFollowingCard,this)),r.push(amdModules.requireDeferred("gs/views/cards/currentBroadcast.js")).done(_.bind(this.renderCurrentBroadcastCard,this)),r.push(amdModules.requireDeferred("gs/views/cards/about.js")).done(_.bind(this.renderAboutCard,this)),r.push(amdModules.requireDeferred("gs/views/cards/playlists.js")),r.push(i.getPlaylists()).done(_.bind(this.renderPlaylistsCard,this,!1,!1)),r.push(amdModules.requireDeferred("gs/views/cards/shareList.js")),r.push(i.getShares()).done(_.bind(this.renderShareCard,this,!1)),r.push(i.getPageNameData()),r.push(r.bind(this.appendByCardOrder,this)),r.push(r.bind(this.renderHelperCard,this,e,{locale:"HELPER_PROFILE_USER_OVERVIEW"})),this.loadComments(this.model.get("userID"),r,this.highlightedCommentID).done(_.bind(function(){if(!this.highlightedCommentID)return;var e=$("#comments-container").offset();e&&$("body").scrollTop(e.top)},this)),i.on("change:nowPlayingSong",this.onNowPlayingSongChange,this),i.on("change:currentBroadcastID",this.onCurrentBroadcastChange,this),r.push(r.bind(this.onCurrentBroadcastChange,this,i,i.get("currentBroadcastID"))),o={recentListens:!0,about:!0,playlists:!0,topArtists:!0,following:!0,favorites:!0,shareCard:!0,commentsView:!0,bcRow:!0,newUser:!0,helperCard:!0};break;case"collection":r.push(i.getLibrary().done(r.bind(this.renderCollection,this))),o={collectionView:!0,helperCard:!0};break;case"playlists":r.push(amdModules.requireDeferred("gs/views/cards/playlists.js").done(r.bind(this.renderPlaylistsCard,this,!0,!0))),r.push(r.bind(this.renderHelperCard,this,e,{locale:"HELPER_PROFILE_USER_PLAYLISTS"})),o={playlists:!0,helperCard:!0};break;case"following":u=this.model.get("appModel").get("user"),r.pushIgnoreFail(u.getRecentUsers()),r.push(i.getFavoritesByType("Users").done(r.bind(this.renderFollowing,this))),o={followingGridToolbarView:!t,followingGridView:!0};break;case"followers":u=this.model.get("appModel").get("user"),r.pushIgnoreFail(u.getRecentUsers()),r.push(i.getFollowers().done(r.bind(this.renderFollowers,this))),o={followersGridToolbarView:!t,followersGridView:!0};break;case"about":r.push(i.getPageNameData().done(r.bind(this.renderAbout,this)));break;case"listens":r.push(i.getRecentListens().done(r.bind(this.renderListens,this))),o={listensView:!0};break;case"notifications":i.get("isLoggedIn")?(r.push(this.fetchTemplate("/shared/notifications")).done(r.storeArgs),r.push(this.fetchTemplate("/modules/taco")),_.defer(_.bind(function(){r.push(i.getNotifications()).done(r.applyArgs(this.renderNotificationsTemplate,this)).fail(function(){n.trigger("notification:add",{title:"",description:_.getString("NOTIFICATIONS_FAILED_TO_LOAD"),type:"error"})})},this))):this.onProfileFail();break;case"broadcast":a={section:this.model.get("section"),subpage:this.model.get("subpage"),subpageData:this.model.get("subpageData")};if(!this.broadcastView||!this.broadcastView.updatePageParams(a))this.broadcastView&&(this.broadcastView.cleanupChildViews(),this.broadcastView.destroy(!1),this.broadcastView=null),this.cleanUpListeners(e),this.rendered=null,this.render();return;case"shares":this.$("#profile-subpage .card").addClass("hide"),r.push(amdModules.requireDeferred("gs/views/cards/shareList.js")),r.push(i.getShares()).done(r.bind(this.renderShareCard,this,!0)),o={shareCard:!0};break;default:this.onProfileFail()}this.handlePostSubpage(e,o),n.trigger("page:ready",this)},appendByCardOrder:function(){var e=this.model.get("user").get("pageNameData").CardArrangement,t=this.$("#user-modules").empty(),r=this.getHiddenCards();this.appendCards(e||this.defaultCardOrder,t),this.isLoggedInUser&&r.length&&(this.$(".hidden-cards-container").removeClass("hide"),this.appendCards(r,this.$(".hidden-cards"),!0)),this.isLoggedInUser||this.renderNewUserCard(),n.trigger("page:redrawUpdate"),this.model.set("CardArrangement",e||this.defaultCardOrder,{silent:!0})},getHiddenCards:function(){var e=this.model.get("user").get("pageNameData").CardArrangement||this.defaultCardOrder,t=[],n,r,i,s,o;for(r=0,i=this.defaultCardOrder.length;r<i;r++){n=!1;for(s=0,o=e.length;s<o;s++)if(e[s]&&e[s].Name==this.defaultCardOrder[r].Name){n=!0;break}n||t.push(this.defaultCardOrder[r])}return t},appendCards:function(e,t,n){_.each(e,function(e,r){if(!this.childViews[e.Name])return;this.childViews[e.Name].$el.toggleClass("hidden",!!n),t.append(this.childViews[e.Name].$el),(e.Name=="topArtists"||e.Name=="following")&&!n&&this.childViews[e.Name].render(),this.childViews[e.Name].arrangementIndex=n?-1:r},this)},onToggleHiddenCardsClick:function(){var e=this.getHiddenCards(),t=this.$(".hidden-cards"),n=t.hasClass("hide"),r=n?"HIDE_HIDDEN_CARDS":"SHOW_HIDDEN_CARDS",i,s;t.toggleClass("hide",!n);for(i=0,s=e.length;i<s;i++)(e[i].Name=="topArtists"||e[i].Name=="following")&&this.childViews[e[i].Name].render();this.$(".toggle-hidden-cards").data("translateText",r).text(_.getString(r))},renderNewUserCard:function(){var e=this.$("#user-modules"),t=this.model.get("user");this.childViews.newUser&&(this.childViews.newUser.destroy(!0),this.childViews.newUser=null),!this.childViews.favorites&&!this.childViews.recentListens&&!this.childViews.playlists&&(this.childViews.newUser=new n.Views.Cards.Empty({title:"EMPTY_PROFILE_TITLE",desc:"EMPTY_PROFILE_DESC",hideAction:!0}),this.childViews.newUser.render(),e.prepend(this.childViews.newUser.$el))},onCardArrangementChange:function(){var e=this.model.get("appModel").get("user"),t=this.getHiddenCards();e.storeUserPageCardArragement(this.model.get("CardArrangement")),this.$(".hidden-cards-container").toggleClass("hide",!t.length)},onArrangementToggle:function(e,t,n){var r=this.$("#user-modules"),i=this.$(".hidden-cards"),s=this.model.get("CardArrangement");n.arrangementIndex>-1?(t.detach().addClass("hidden"),s.splice(n.arrangementIndex,1),n.arrangementIndex=-1,i.append(t)):(t.detach().removeClass("hidden"),n.arrangementIndex=s.length,s.push({Name:n.options.cardName}),r.append(t)),_.each(s,function(e,t){this.childViews[e.Name].arrangementIndex=t},this),this.model.set("CardArrangement",s),this.onCardArrangementChange()},onArrangementUp:function(e,t,n){var r=n.arrangementIndex-1,i=this.model.get("CardArrangement"),s=i[r],o;if(r<0)return;o=this.childViews[s.Name],o.$el.before(t),o.arrangementIndex=n.arrangementIndex,i[r]=i[n.arrangementIndex],i[n.arrangementIndex]=s,n.arrangementIndex=r,this.model.set("CardArrangement",i),this.onCardArrangementChange()},onArrangementDown:function(e,t,n){var r=n.arrangementIndex+1,i=this.model.get("CardArrangement"),s=i[r],o;if(r>=i.length)return;o=this.childViews[s.Name],o.$el.after(t),o.arrangementIndex=n.arrangementIndex,i[r]=i[n.arrangementIndex],i[n.arrangementIndex]=s,n.arrangementIndex=r,this.model.set("CardArrangement",i),this.onCardArrangementChange()},updateArtistSubpage:function(e){e=this.handleSubpageAndComments(e);if(!e)return;var t=new ChainLoading,r=this.model.get("user"),i=this.model.get("artist"),s=this.$(".content-container"),o,u,a;s.removeClass("sectioned");switch(e){case"profile":$("#profile-subpage").find(".content").addClass("hide"),$("#music-container").removeClass("hide"),$("#comments-container").removeClass("hide"),t.push(i.getAllAlbums()),t.push(i.getSongs().done(_.bind(this.renderMusic,this))),this.loadComments(this.model.get("userID"),t,this.highlightedCommentID),t.push(amdModules.requireDeferred("gs/views/cards/about.js").done(_.bind(this.renderAboutCard,this))),t.push(_.bind(this.renderHelperCard,this,e,{locale:"HELPER_PROFILE_ARTIST_OVERVIEW"})),t.push(_.bind(n.trigger,n,"page:redrawUpdate")),o={about:!0,topSongsGridView:!0,musicGridToolbarView:!0,musicGridView:!0,songsListView:!0,editGridView:!0,commentsView:!0,helperCard:!0},s.addClass("sectioned");break;case"collection":t.push(r.getLibrary().done(t.bind(this.renderCollection,this))),o={collectionView:!0,helperCard:!0};break;case"similar-artists":t.push(i.getRelatedArtists().done(t.bind(this.renderRelated,this))),t.push(t.bind(this.renderHelperCard,this,e,{locale:"HELPER_PROFILE_ARTIST_RELATED_ARTISTS"})),o={similarArtistsGridView:!0,helperCard:!0};break;case"events":t.push(i.getSongkickEvents().done(t.bind(this.renderEvents,this))),t.push(t.bind(this.renderHelperCard,this,e,{locale:"HELPER_PROFILE_ARTIST_EVENTS"})),o={eventsGridToolbarView:!0,eventsGridView:!0,helperCard:!0};break;case"following":u=this.model.get("appModel").get("user"),t.pushIgnoreFail(u.getRecentUsers()),t.push(r.getFavoritesByType("Users").done(t.bind(this.renderFollowing,this))),o={followingGridToolbarView:!0,followingGridView:!0};break;case"followers":u=this.model.get("appModel").get("user"),t.pushIgnoreFail(u.getRecentUsers()),t.push(i.getFollowers().done(t.bind(this.renderFollowers,this))),o={followersGridToolbarView:!0,followersGridView:!0};break;case"about":t.push(i.getPageNameData().done(t.bind(this.renderAbout,this)));break;case"broadcast":a={section:this.model.get("section"),subpage:this.model.get("subpage"),subpageData:this.model.get("subpageData")};if(!this.broadcastView||!this.broadcastView.updatePageParams(a))this.cleanUpListeners(e),this.rendered=null,this.render();return;default:this.onProfileFail()}this.handlePostSubpage(e,o)},handlePostSubpage:function(e,t){var n=this.model.get("user"),i=r.model.get("user"),s=i.get("subscription")&&i.get("subscription").canHideAds(),o=this.model.get("artist"),u=o?o.get("ArtistName"):n.get("FName");this.teardownSubpage(t||{}),this.cleanUpListeners(e),this.setTitle([u,_.ucwords(e)]),this.rendered=e,e!=="analytics"&&(s||($("#column1").removeClass("full"),$("#column2").removeClass("hide")),this.songGraph&&this.songGraph.closeTooltip())},cleanUpListeners:function(e){var t=this.model.get("user");e!=="profile"&&(t.off("change:nowPlayingSong",null,this),t.off("change:currentBroadcastID",null,this))},renderHelperCard:function(e,t){var r=this.model.get("artist"),i=r&&r.get("ArtistID"),s=n.isLoggedInUserOwnerOfArtist(i);if(!this.isLoggedInUser&&!s)return;t.el=$("#column1").children(".helper"),t.page=this.pageType,t.subpage=e,this.childViews.helperCard?this.childViews.helperCard.model.set(_.defaults(t,{html:"",htmlId:""})):(this.childViews.helperCard=new n.Views.Cards.HelperCard(t),this.childViews.helperCard.render())},renderTopArtists:function(){if(this.destroyed||!this.model.get("user")||!this.indexRendered)return;var e=this.model.get("user"),t=e.get("topArtists"),r=!e||!e.get("isArtist"),i=n.getLoggedInUserID()==e.get("UserID"),s=!t||!t.length,o=r&&i,u,a;this.childViews.topArtists&&(this.childViews.topArtists.destroy(!0),this.childViews.topArtists=null);if(s){if(!o)return;a=n.Views.Cards.extendArrangeable(n.Views.Cards.Empty),u={title:"EMPTY_TOP_ARTISTS_TITLE",desc:"EMPTY_TOP_ARTISTS_DESC",hideAction:!0,cardName:"topArtists",cardTitle:"TOP_ARTISTS_2",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)}}else a=o?n.Views.Cards.extendArrangeable(n.Views.Cards.TopArtists):n.Views.Cards.TopArtists,u={model:this.model.get("user"),cardName:"topArtists",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)};this.childViews.topArtists=new a(u)},renderRecentListens:function(e){var t=this.model.get("user"),r=new n.Models.PlayContext(t),i=!t||!t.get("isArtist"),s=n.getLoggedInUserID()==t.get("UserID"),o=i&&s,u=!e||!e.length,a,f;r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),this.childViews.recentListens&&(this.childViews.recentListens.destroy(!0),this.childViews.recentListens=null);if(u){if(!o)return;f=n.Views.Cards.extendArrangeable(n.Views.Cards.Empty),a={title:"EMPTY_LISTENS_OWNER_2",desc:"EMPTY_LISTENS_DESC_OWNER_2",hideAction:!0,cardName:"recentListens",cardTitle:"RECENT_LISTENS",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)}}else f=o?n.Views.Cards.extendArrangeable(n.Views.Cards.SongList):n.Views.Cards.SongList,a={title:"RECENT_LISTENS",seeAllUrl:t.toUrl("listens"),showMoreVal:25,appModel:this.model.get("gsApp").model,gridOptions:{collection:e,playContext:r,showCount:!1},emptyParams:{user:t,titleLocale:this.isLoggedInUser?"EMPTY_LISTENS_OWNER_2":"EMPTY_LISTENS_2",descLocale:this.isLoggedInUser?"EMPTY_LISTENS_DESC_OWNER_2":"EMPTY_LISTENS_DESC_2",emptyClass:"listens",actions:!1,search:this.isLoggedInUser?!0:!1},cardName:"recentListens",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this),forceShowAll:!0};this.childViews.recentListens=new f(a),this.childViews.recentListens.render()},renderCollection:function(e){var t=$("#collection-subpage").find(".card-content"),r=this.model.get("user"),i,s,o;if(this.destroyed||!this.model.get("user")||!e||this.currentSubpage!=="collection")return;this.model.get("section")=="favorites"?o={html:_.getString("HELPER_PROFILE_USER_FAVORITES"),htmlId:"HELPER_PROFILE_USER_FAVORITES"}:o={locale:"HELPER_PROFILE_USER_COLLECTION"},this.renderHelperCard("collection",o);if(this.childViews.collectionView){s=this.model.get("section")!==this.model.previous("section"),s&&this.childViews.collectionView&&(this.model.get("section")==="favorites"?this.childViews.collectionView.showFavorites():this.childViews.collectionView.showAll());return}if(!e.length){i={user:r,titleLocale:this.isLoggedInUser?"EMPTY_COLLECTION_OWNER_2":"EMPTY_COLLECTION_2",descLocale:this.isLoggedInUser?"EMPTY_COLLECTION_DESC_OWNER_2":"EMPTY_COLLECTION_DESC_2",emptyClass:"collection",actions:!1,search:this.isLoggedInUser?!0:!1},this.renderEmpty(i,t);return}this.childViews.collectionView&&this.childViews.collectionView.destroy(!1),this.childViews.collectionView=new n.Views.Collection({el:t[0],user:this.model.get("user"),showFavoritesSwitcher:!0,appModel:this.model.get("gsApp").model,defaultFavorites:this.model.get("section")=="favorites"}),this.childViews.collectionView.render()},renderPlaylistsCard:function(e,t,r){var i=this.model.get("user"),s=this.model.get("subpage"),o=this.model.get("section"),u=s==="playlists"?$("#playlists-subpage").find(".card"):!1,a=new n.Models.PlayContext(i),f=!i||!i.get("isArtist"),l=n.getLoggedInUserID()==i.get("UserID"),c=f&&l&&s!=="playlists",h=c?n.Views.Cards.extendArrangeable(n.Views.Cards.Playlists):n.Views.Cards.Playlists,p,d;a.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),this.childViews.playlists&&(this.childViews.playlists.destroy(!1),this.childViews.playlists=null),this.isLoggedInUser?d={user:i,titleLocale:o==="subscribed"?"EMPTY_SUBSCRIBED_PLAYLISTS_OWNER":"EMPTY_PLAYLISTS_OWNER_2",descLocale:o==="subscribed"?"EMPTY_SUBSCRIBED_PLAYLISTS_DESC_OWNER":"EMPTY_PLAYLISTS_DESC_OWNER_2",emptyClass:"playlists",actions:[{btnRef:!1,btnLocale:"CREATE_A_PLAYLIST",btnClass:"btn-blue create-playlist",icon:!1}]}:d={user:i,titleLocale:o==="subscribed"?"EMPTY_SUBSCRIBED_PLAYLISTS":"EMPTY_PLAYLISTS_2",descLocale:o==="subscribed"?"":"EMPTY_PLAYLISTS_DESC_2",emptyClass:"playlists",actions:!1},p={profile:i,showToolbar:e,showFull:t||!1,gridOptions:{playContext:a},emptyParams:d,cardName:"playlists",currentType:o||null,onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)},u&&(p.el=u),this.childViews.playlists=new h(p),this.childViews.playlists.render()},renderFollowingCard:function(e){var t=this.model.get("user"),r=new n.Models.Collections.Users(e.models),i=!t||!t.get("isArtist"),s=n.getLoggedInUserID()==t.get("UserID"),o=i&&s,u=!e||!e.length,a,f;r.comparator=n.Models.User.interactedNiftyFriendSort,r.sort(),this.childViews.following&&(this.childViews.following.destroy(!0),this.childViews.following=null);if(u){if(!o)return;f=n.Views.Cards.extendArrangeable(n.Views.Cards.Empty),a={cardName:"following",cardTitle:"FOLLOWING",title:"EMPTY_FOLLOWERS_OWNER_2",desc:"EMPTY_FOLLOWERS_DESC_OWNER_2",hideAction:!0,onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)}}else f=o?n.Views.Cards.extendArrangeable(n.Views.Cards.UserList):n.Views.Cards.UserList,a={title:"FOLLOWING",profile:t,gridOptions:{collection:r},emptyParams:{user:t,titleLocale:this.isLoggedInUser?"EMPTY_FOLLOWING_OWNER_2":"EMPTY_FOLLOWING_USER",descLocale:this.isLoggedInUser?"EMPTY_FOLLOWING_DESC_OWNER_2":"EMPTY_FOLLOWING_DESC",emptyClass:"following",actions:[{btnRef:this.isLoggedInUser?"#!/signup/twitter":!1,btnLocale:this.isLoggedInUser?"TWITTER":!1,btnClass:this.isLoggedInUser?"share-btn third-party twitter":!1,icon:this.isLoggedInUser?"icon-twitter":!1},{btnRef:this.isLoggedInUser?"#!/signup/google":!1,btnLocale:this.isLoggedInUser?"GOOGLE":!1,btnClass:this.isLoggedInUser?"share-btn third-party google":!1,icon:this.isLoggedInUser?"icon-google":!1}]},cardName:"following",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)};this.childViews.following=new f(a)},renderFavoritesCard:function(e){var t=this.model.get("user"),r=new n.Models.PlayContext(t),i=!t||!t.get("isArtist"),s=n.getLoggedInUserID()==t.get("UserID"),o=i&&s,u=!e||!e.length,a,f;r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),this.childViews.favorites&&(this.childViews.favorites.destroy(!0),this.childViews.favorites=null),e.comparator=_.getModelSort("TSAdded"),e.sort();if(u){if(!o)return;f=n.Views.Cards.extendArrangeable(n.Views.Cards.Empty),a={title:"EMPTY_FAVORITES_OVERLAY",desc:"EMPTY_FAVORITES_OVERLAY_DESC",hideAction:!0,cardName:"favorites",cardTitle:"FAVORITES",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)}}else f=o?n.Views.Cards.extendArrangeable(n.Views.Cards.SongList):n.Views.Cards.SongList,a={title:"FAVORITES",seeAllUrl:t.toUrl("collection/favorites"),showMoreVal:25,appModel:this.model.get("gsApp").model,gridOptions:{collection:e,playContext:r,showCount:!1},showLengthInTitle:!0,cardName:"favorites",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)};this.childViews.favorites=new f(a),this.childViews.favorites.render()},renderFollowing:function(e){if(this.destroyed||!this.model.get("user")&&!this.model.get("artist")||!this.indexRendered||this.currentSubpage!=="following")return;var t=this.model.get("appModel").get("user"),r=this.model.get("user"),i=new n.Models.Collections.Users(e.models),s=$("#following-subpage"),o=n.getAppSize()==="mobile",u,a;i.comparator=n.Models.User.interactedNiftyFriendSort,i.sort();if(!this.childViews.followingGridView){var f=$("#following-grid").empty();u=new n.Views.UserArtistGrid({el:f[0],collection:i}),this.childViews.followingGridView=u,u.render()}if(!o&&!this.childViews.followingGridToolbarView){var l=this.$("#following-grid-toolbar-container").empty(),c=new n.Views.GridToolbar({el:l[0],model:this.model,gridView:u,page:"following",buttons:this.model.get("user").id==n.getLoggedInUserID()?["inviteFriends","whoToFollow","filterSearch"]:["filterSearch"]});this.childViews.followingGridToolbarView=c,c.render()}if(!e||!e.length)a={user:r,titleLocale:this.isLoggedInUser?"EMPTY_FOLLOWING_OWNER_2":"EMPTY_FOLLOWING_USER",descLocale:this.isLoggedInUser?"EMPTY_FOLLOWING_DESC_OWNER_2":"EMPTY_FOLLOWING_DESC",emptyClass:"following",actions:[{btnRef:this.isLoggedInUser?"#!/signup/twitter":!1,btnText:this.isLoggedInUser?"Twitter":!1,btnClass:this.isLoggedInUser?"share-btn third-party twitter":!1,icon:this.isLoggedInUser?"icon-twitter":!1},{btnRef:this.isLoggedInUser?"#!/signup/google":!1,btnText:this.isLoggedInUser?"Google":!1,btnClass:this.isLoggedInUser?"share-btn third-party google":!1,icon:this.isLoggedInUser?"icon-google":!1}]},this.renderEmpty(a,s)},renderFollowers:function(e){if(this.destroyed||!this.model.get("user")&&!this.model.get("artist")||!this.indexRendered||this.currentSubpage!=="followers")return;var t=this.model.get("appModel").get("user"),r=this.model.get("user"),i=new n.Models.Collections.Users(e.models),s=$("#followers-subpage"),o=n.getAppSize()==="mobile",u,a;i.comparator=n.Models.User.interactedNiftyFriendSort,i.sort();if(!this.childViews.followersGridView){var f=$("#followers-grid").empty();u=new n.Views.UserArtistGrid({el:f[0],collection:i}),this.childViews.followersGridView=u,u.render()}if(!o&&!this.childViews.followersGridToolbarView){var l=this.$("#followers-grid-toolbar-container").empty(),c=new n.Views.GridToolbar({el:l[0],model:this.model,gridView:u,page:"followers",buttons:this.model.get("user").id==n.getLoggedInUserID()?["inviteFriends","whoToFollow","filterSearch"]:["filterSearch"]});this.childViews.followersGridToolbarView=c,c.render()}if(!e||!e.length){var h;this.model.get("user")?h=this.model.get("user"):h=this.model.get("artist"),a={user:r,titleLocale:this.isLoggedInUser?"EMPTY_FOLLOWERS_OWNER_2":"EMPTY_FOLLOWERS_2",descLocale:this.isLoggedInUser?"EMPTY_FOLLOWERS_DESC_OWNER_2":"EMPTY_FOLLOWERS_DESC_2",emptyClass:"following",actions:[{btnRef:!1,btnLocale:this.isLoggedInUser?"SHARE_PROFILE":!1,btnClass:this.isLoggedInUser?"btn-blue share-profile":!1,icon:!1}]},this.renderEmpty(a,s)}},renderAbout:function(){var e=this.model.get("user"),t=this.model.get("artist"),n=t&&t.get("pageNameData")||e&&e.get("pageNameData"),r=n&&n.Bio||e.get("About"),i=n&&n.URLs||{},s=[],o="",u="Website",a=this.$(".bio-container"),f=this.$(".link-container"),l=this.$(".bio-content"),c=this.$(".bio-source"),h=this.$(".link-list"),p=$("#about-subpage"),d,v,m,g,y,b;if(!t&&!n.length&&(!r||!r.length)){b={user:e,titleLocale:this.isLoggedInUser?"EMPTY_ABOUT_OWNER":"EMPTY_ABOUT",descLocale:this.isLoggedInUser?"EMPTY_ABOUT_DESC_OWNER":"EMPTY_ABOUT_DESC",emptyClass:"about",actions:[{btnRef:this.isLoggedInUser?"/#!/settings/profile":!1,btnLocale:this.isLoggedInUser?"EDIT_PROFILE":!1,btnClass:this.isLoggedInUser?"btn-blue edit-profile":!1,icon:!1}]},this.renderEmpty(b,p);return}if(t&&!n.length&&(!r||!r.length)){b={user:e,titleLocale:this.isLoggedInUser?"EMPTY_ARTIST_ABOUT_OWNER":"EMPTY_ARTIST_ABOUT",descLocale:this.isLoggedInUser?"EMPTY_ARTIST_ABOUT_DESC_OWNER":"EMPTY_ABOUT_DESC",emptyClass:"about",actions:[{btnRef:this.isLoggedInUser?"/#!/settings/profile":!1,btnLocale:this.isLoggedInUser?"EDIT_PROFILE":!1,btnClass:this.isLoggedInUser?"btn-blue edit-profile":!1,icon:!1}]},this.renderEmpty(b,p);return}n&&(n.Bio&&(r=n.Bio),n.BioAttribution&&(o=n.BioAttribution)),r&&(a.removeClass("hide"),l.html(_.makeSafeLinks(r)),o&&_.isString(o)&&(o.match(/\/\/[a-z]*\.?wikipedia\.org/)&&(u="Wikipedia"),c.html(_.getString("SOURCE",{source:'<a href="'+_.escape(o)+'" class="source-link" data-translate-text="SOURCE">'+u+"</a>"}))));for(d in i)if(i.hasOwnProperty(d)){g=null;switch(d){case"site":i[d].indexOf("http://")!==0&&i[d].indexOf("https://")!==0?v="http://"+i[d]:v=i[d],m=100,g="globe",y="Website";break;case"fb":v="http://facebook.com/"+i[d],m=90,g="facebook",y="Facebook";break;case"tw":v="http://twitter.com/"+i[d],m=80,g="twitter",y="Twitter";break;case"wp":v=i[d],m=70,g="wikipedia",y="Wikipedia"}g&&s.push({url:v,icon:g,name:y,weight:m})}s.length&&(s=s.sort(function(e,t){return e.weight<t.weight}),this.fetchTemplate("/shared/links").done(_.bind(function(e){h.html(this.renderTemplate(e,{links:s})),f.removeClass("hide")},this)))},renderTopSongs:function(e){if(this.destroyed||this.currentSubpage!=="profile")return;var t=this.model.get("artist"),r=t.get("songs"),i=$("#top-songs-container"),s=n.isLoggedInUserOwnerOfArtist(t.get("ArtistID"));if(!s&&(!e||e.length<3||r.length<8&&_.difference(r.models,e.models)<3)){i.addClass("hide"),this.childViews.topSongsGridView&&(this.childViews.topSongsGridView.destroy(!1),delete this.childViews.topSongsGridView);return}i.removeClass("hide");var o=this.$("#top-songs-grid").empty(),u=i,a=this.$(".top-songs-header"),f=new n.Models.PlayContext(this.model.get("artist")),l=new n.Models.Collections.Songs(e.take(5));f.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),t.has("featuredSongs")?a.data("translateText","FEATURED_SONGS").text(_.getString("FEATURED_SONGS")):a.data("translateText","TOP_SONGS").text(_.getString("TOP_SONGS")),this.childViews.topSongsGridView&&this.childViews.topSongsGridView.destroy(!1),this.childViews.topSongsGridView=new n.Views.SongGridTall({el:o[0],collection:l,header:!1,playContext:f}),this.childViews.topSongsGridView.render(),u.find(".songs-header").removeClass("hide"),n.isLoggedInUserOwnerOfArtist(t.get("ArtistID"))&&u.find(".edit-featured-songs").removeClass("hide"),u.find(".instructions").addClass("hide"),$("#music-container").find(".edit-featured-songs").addClass("hide")},renderMusic:function(e){if(this.destroyed||!this.indexRendered||!this.model.get("artist")||!e||this.currentSubpage!=="profile")return;var t=$("#music-grid").empty(),r=$("#music-container"),s=$("#music-grid-toolbar-container").empty(),o=this.model.get("artist"),u=new n.Models.PlayContext(o),a=e.models.concat([]).sort(n.Models.Song.verifiedPopularSort),f=new n.Models.Collections.Songs(a),l=f.filter(i),c=l.length,h=f.length>100,p=n.getAppSize()==="mobile",d=n.isLoggedInUserOwnerOfArtist(this.model.get("artist").get("ArtistID")),v=this.model.get("user"),m,g;if(!e.length){g={user:v,titleLocale:this.isLoggedInUser?"EMPTY_ARTIST_SONGS_OWNER":"EMPTY_ARTIST_SONGS_2",descLocale:this.isLoggedInUser?"EMPTY_ARTIST_SONGS_DESC_OWNER":"EMPTY_ARTIST_SONGS_DESC_2",emptyClass:"artist-songs",actions:[{btnRef:!1,btnLocale:this.isLoggedInUser?"UPLOAD_YOUR_MUSIC":!1,btnClass:this.isLoggedInUser?"btn-blue upload-music":!1,icon:!1}]},this.renderEmpty(g,r);return}this.listenTo(e,"remove",function(e){f.remove(e)}),this.listenTo(e,"add",function(e){f.add(e)}),this.listenTo(e,"reset",function(){a=e.models.concat([]).sort(n.Models.Song.popularSort),f.reset(a)}),this.childViews.songsListView||(this.childViews.songsListView=new n.Views.SongRowTallList({el:t,collection:f,showCount:!0,playContext:u,maxRenderableItems:100,verifiedSongsCount:c,moduleOptions:{hideArtistName:!0}}),this.childViews.songsListView.render()),h?c<5?this.toggleVisibleSongs(2,!0):c<100?this.toggleVisibleSongs(2):this.toggleVisibleSongs(1):this.toggleVisibleSongs(),!p&&!this.childViews.musicGridToolbarView&&(m=["play","sort","switchView"],d&&m.unshift("edit"),m.push("filterSearch"),this.childViews.musicGridToolbarView=new n.Views.GridToolbar({el:s[0],model:this.model,gridView:this.childViews.songsListView,page:"artist",buttons:m,playContext:u,onButtonClick:_.bind(function(e){var t=$(e.currentTarget);t.hasClass("albums")?this.switchMusicView(!1):t.hasClass("songs")&&this.switchMusicView(!0)},this)}),this.childViews.musicGridToolbarView.on("filterChanged",_.bind(function(e){e.length&&!this.songsShowing&&this.switchMusicView(!0)},this)),this.childViews.musicGridToolbarView.render())},onShowMoreClick:function(e){var t=!1,n;typeof this.currentVisibleSongsFlag=="number"?this.currentVisibleSongsFlag===3&&this.childViews.songsListView.options.verifiedSongsCount<5?(n=2,t=!0):n=this.currentVisibleSongsFlag===3?1:this.currentVisibleSongsFlag+1:n=1,this.toggleVisibleSongs(n,t)},toggleVisibleSongs:function(e,t){if(!this.childViews.songsListView)return;var n=$("#music-grid-show-more"),r=n.find(".show-more"),s=r.find(".label"),o=r.find(".icon"),u={},a=this.childViews.songsListView.collection.length,f;e===1&&this.childViews.songsListView.options.verifiedSongsCount<=100&&(e=2);switch(e){case 1:f="SHOW_MORE",u.filterFunction=i,a=100;break;case 2:f="SHOW_ALL",t?a=100:u.filterFunction=i;break;case 3:f="SHOW_LESS_2";break;default:n.addClass("hide");return}n.removeClass("hide"),s.translateText(f),o.swapClasses("icon-caretup","icon-caretdown",e===3),this.childViews.songsListView.model.set("maxRenderableItems",a),this.childViews.songsListView.filter("",u),this.currentVisibleSongsFlag=e},toggleNiceAlbums:function(e){if(!this.childViews.musicGridView)return;var t=this.albumsViewOnlyNice=_.isBoolean(e)?e:!this.albumsViewOnlyNice,n=$("#secondary-grid-show-more"),r=n.find(".show-more"),i=r.find(".label"),o=r.find(".icon"),u={},a=t?"SHOW_ALL":"SHOW_LESS_2";t&&(u.filterFunction=s),i.data("translateText",a).text(_.getString(a)),o.swapClasses("icon-caretdown","icon-caretup",t),this.childViews.musicGridView.filter("",u),n.removeClass("hide")},switchMusicView:function(e){var t=this.$el.find("#music-grid"),r=$("#music-grid-show-more"),i=this.$el.find("#secondary-grid"),s=$("#secondary-grid-show-more"),o=this.childViews.musicGridView,u=this.childViews.songsListView,a=this.childViews.musicGridToolbarView,f=this.model.get("artist"),l=new n.Models.Collections.Albums,c=f.get("fullAlbums"),h=f.get("singlesEPs"),p=f.get("others"),d=new n.Models.PlayContext(f),v;this.songsShowing=e;if(e){i.addClass("hide"),s.addClass("hide");if(!u)return;a.changeGridView(u),t.removeClass("hide"),a.$el.length&&(a.$el.find(".sort-button").closest("li").removeClass("hide"),a.$el.find(".edit-button").closest("li").removeClass("hide"),a.$el.find(".songs").addClass("active"),a.$el.find(".albums").removeClass("active"),a.$el.find("input.filter").val("")),_.defined(this.currentVisibleSongsFlag)&&this.toggleVisibleSongs(this.currentVisibleSongsFlag)}else o||(c&&c.length&&l.add(c.filter(n.Models.Album.hasSongsFilter).sort(_.getModelSort("Year"))),h&&h.length&&l.add(h.filter(n.Models.Album.hasSongsFilter).sort(_.getModelSort("Year"))),p&&p.length&&l.add(p.filter(n.Models.Album.hasSongsFilter).sort(_.getModelSort("Year"))),l.length||(v=f.get("albums"),l.add(v.filter(n.Models.Album.hasSongsFilter).sort(_.getModelSort("Year")))),d.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),o=new n.Views.ArtistAlbumGrid({el:i[0],collection:l,addStreamType:"TYPE_DEFAULT",bufferBefore:.05,bufferAfter:.05,playContext:d}),this.childViews.musicGridView=o,o.render()),a.changeGridView(o,!0),_.defined(this.albumsViewOnlyNice)?this.toggleNiceAlbums(this.albumsViewOnlyNice):(!c||!c.length)&&(!h||!h.length)?$("#secondary-grid-show-more").addClass("hide"):($("#secondary-grid-show-more").removeClass("hide"),this.toggleNiceAlbums(!0)),t.addClass("hide"),r.addClass("hide"),i.removeClass("hide"),a.$el.length&&(a.$el.find(".sort-button").closest("li").addClass("hide"),a.$el.find(".edit-button").closest("li").addClass("hide"),a.$el.find(".songs").removeClass("active"),a.$el.find(".albums").addClass("active"));n.trigger("page:redrawUpdate")},renderRelated:function(e){if(this.destroyed||!this.indexRendered||this.currentSubpage!=="similar-artists")return;var t=$("#similar-artists-grid").empty(),r=this.model.get("artist"),i=n.isLoggedInUserOwnerOfArtist(r.get("ArtistID")),s=this.model.get("appModel").get("user").get("subscription").canHideAds(),o=this.model.get("user"),u,a;if(!e.length&&!i){this.childViews.similarArtistsGridView&&(this.childViews.similarArtistsGridView.destroy(),this.childViews.similarArtistsGridView.collection.off(null,null,this)),a={user:o,titleLocale:"EMPTY_SIMILAR_ARTISTS_2",descLocale:"EMPTY_SIMILAR_ARTISTS_DESC",emptyClass:"suggest-tags",actions:[{btnRef:!1,btnLocale:"SUGGEST_TAGS",btnClass:"btn-blue suggest-tags",icon:!1}]},this.renderEmpty(a,t);return}this.initialRelatedArtists=_.take(e.models,6);if(this.childViews.similarArtistsGridView)this.childViews.similarArtistsGridView.collection.reset(this.initialRelatedArtists),i||this.childViews.similarArtistsGridView.collection.off(null,null,this);else{var f=new n.Models.Collections.Artists(this.initialRelatedArtists),l={el:t[0],collection:f};i?(l.getAfterBareElements=function(e,t){t||(t=[]);var i=e.length,s=[],o=[],a=0,f;for(;a<t.length-6+i;a++)f=t.shift(),f&&(f.data("module").destroy(!1),o.push(f));for(a=0;i<6;i++,a++)f=t[a],f||(f=new n.Views.Modules.AddRelatedArtist({model:new Backbone.Model,grid:u,parentArtist:r}),u.childViews.push(f),f.render(),f=f.$el),s[a]=f;return $.Deferred().resolve(s,o).promise()},u=new n.Views.EditableArtistRelatedGrid(l),f.on("add remove reset",this.saveRelatedArtistsOnGridUpdate,this)):u=new n.Views.UserArtistGrid(l),this.childViews.similarArtistsGridView=u,u.render()}n.Models.Artist.loadArtistsPageNameDatas(this.initialRelatedArtists)},renderEditableFeaturedSongs:function(e){if(this.destroyed)return;var t=this.model.get("artist"),r=t.get("songs"),i=$("#top-songs-container"),s=[],o;for(var u=0;u<5;u++)o={id:u,song:e&&e.at(u)||null},s.push(new Backbone.Model(o));var a=$("#top-songs-grid"),f=a.data("view");f&&f.destroy(!1),a.removeClass("grid-cell-vertical");var l=new n.Views.EditableFeaturedSongsGrid({el:a[0],collection:new Backbone.Collection(s),sourceSongs:r});this.childViews.editGridView=l,l.render(),i.removeClass("hide"),i.find(".songs-header").addClass("hide"),i.find(".edit-header").removeClass("hide"),i.find(".instructions").removeClass("hide")},saveRelatedArtistsOnGridUpdate:function(){var e=$("#similar-artists-grid").data("view"),t=this.model.get("artist"),r=n.isLoggedInUserOwnerOfArtist(t.get("ArtistID"));if(!r||!e)return;if(this.pendingRelatedArtistsSave){this.pendingRelatedArtistsSave=e.collection.models;return}$(".undo-related-artists").removeClass("hide"),this.pendingRelatedArtistsSave=e.collection.models,setTimeout(_.bind(function(){this.pendingRelatedArtistsSave&&this.saveRelatedArtists(this.pendingRelatedArtistsSave)},this),3e3)},renderEvents:function(){if(this.destroyed||!this.model.get("artist")||!this.indexRendered||this.currentSubpage!=="events")return;var e,t=$("#events-subpage"),r=this.model.get("user"),i;if(!this.childViews.eventsGridView){var s=$("#events-grid").empty(),o=this.model.get("artist").get("songkickEvents");if(!o.length){i={user:r,titleLocale:this.isLoggedInUser?"EMPTY_ARTIST_EVENTS_OWNER":"EMPTY_ARTIST_EVENTS",descLocale:this.isLoggedInUser?"EMPTY_ARTIST_EVENTS_DESC_OWNER":"EMPTY_ARTIST_EVENTS_DESC",emptyClass:"events",actions:[{btnRef:this.isLoggedInUser?"http://songkick.com/signup":!1,btnLocale:this.isLoggedInUser?"LB_SIGNUP_SONGKICK":!1,btnClass:this.isLoggedInUser?"btn-blue songkick-signup":!1,icon:!1}],search:this.isLoggedInUser?!1:!0,searchLocale:"SEARCH_FOR_EVENTS",searchType:"events"},this.renderEmpty(i,t);return}e=new n.Views.EventGridTall({el:s[0],collection:new n.Models.Collections.Events(o.models),header:!1}),this.childViews.eventsGridView=e,e.render()}if(!this.childViews.eventsGridToolbarView){var u=this.$("#events-grid-toolbar-container").empty(),a=new n.Views.GridToolbar({el:u[0],model:this.model,gridView:e,page:"artist",buttons:["filterSearch"]});this.childViews.eventsGridToolbarView=a,a.render()}n.Services.API.getSongkickArtist(this.model.get("artist").id).done(function(e){e&&e.length&&e[0].SongkickArtistID&&$("#artist-edit-tour-dates").attr("href","http://www.songkick.com/artists/"+e[0].SongkickArtistID).removeClass("hide")})},getEmptySuggestions:function(e,t){e=_.orEqual(e,"/user/empty/collection"),t=_.orEqual(t,$("#column1"));var r=this.model.get("user");n.getLoggedInUserID()==r.get("UserID")?r.getPersonalizedSongs(!0).done(_.bind(function(n){if(!n.length){this.getPopularSuggestions(e,t);return}this.fetchTemplate(e).done(_.bind(this.renderEmptySuggestions,this,n,t))},this)):this.fetchTemplate(e).done(_.bind(this.renderEmptySuggestions,this,[],t))},getPopularSuggestions:function(e,t){n.Services.API.popularGetSongsPreview().done(_.bind(function(r){var i=new n.Models.Collections.Songs(r.Songs.slice(0,5));this.fetchTemplate(e).done(_.bind(this.renderEmptySuggestions,this,i,t))},this))},renderEmptySuggestions:function(e,t,r){t.html(this.renderTemplate(r,{user:this.model.get("user")}));if(!e||!e.length)return;var i=5;this.model.get("subpage")!=="collection"&&(i=4);var s=new n.Views.SongGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:i,el:t.find(".empty-suggestions"),collection:new n.Models.Collections.Songs(e.take(i)),mediumGrid:!0});this.childViews.push(s),s.render()},renderEmpty:function(e,t){e=_.defaults(e,{search:!1,searchLocale:"SEARCH_FOR_MUSIC_ELLIPSIS",searchType:""}),this.fetchTemplate("/shared/empty").always(_.bind(function(n){t.html(this.renderTemplate(n,e))},this)),this.$(".songkick-signup").length&&$(".songkick-signup").attr("target","_blank")},renderNotificationsTemplate:function(e,t){if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.currentSubpage!=="notifications")return;var n=this.$("#notifications-subpage");n.html(this.renderTemplate(e)),n.find(".card-content").toggleClass("no-notifs",t.length===0),this.renderedNotifications=!1,this.renderNotifications(t.resetPosition().getCurrentPage())},renderNotifications:function(e){if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.currentSubpage!=="notifications")return;var t=this.$("#notifications-subpage"),r=this.model.get("user"),i=r.get("notifications"),s=_.getTimeBasedGroups(),o=[],u={},a=0,f=0;e.each(_.bind(function(e){if(!e.getNormalizedObject())return;e.get("unseen")&&a++;var t,r;while(e.attributes.Timestamp<s[f].time)++f;u[f]==null&&(r=$(document.createElement("div")),r.addClass("notification-group-container"),u[f]=$('<div class="notification-group"></div>'),r.append(u[f]),o.push(r)),t=new n.Views.Modules.Taco({model:e}),this.childViews.push(t),t.render(),u[f].append(t.$el[0])},this)),t.find(".card-content").append(o),t.find(".show-more-container").toggleClass("hide",!e.hasMore());if(!i||i.findWhere({unseen:true})==null){this.renderedNotifications=!0;return}if(!this.renderedNotifications&&a==e.length){this.renderedNotifications=!0,this.loadMoreNotifications();return}this.renderedNotifications=!0,setTimeout(_.bind(function(){if(this.destroyed||this.currentSubpage!=="notifications")return;i.markAllAsSeen()},this),1e3)},loadMoreNotifications:function(){if(!this.model.get("user")||this.currentSubpage!=="notifications")return;var e=this.model.get("user").get("notifications");if(!e)return;e.getNextPage().done(_.bind(this.renderNotifications,this)).fail(_.bind(function(){if(this.destroyed||this.currentSubpage!=="notifications")return;e.hasMore()||this.$("#notifications-subpage .show-more-container").addClass("hide"),n.trigger("notification:add",{title:"",description:_.getString("NOTIFICATIONS_FAILED_TO_LOAD"),type:"error"})},this))},renderListens:function(e){var t=$("#listens-subpage"),i=this.model.get("user"),s;if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.model.get("subpage")!=="listens")return;if(!e.length){s={user:i,titleLocale:this.isLoggedInUser?"EMPTY_LISTENS_OWNER_2":"EMPTY_LISTENS_2",descLocale:this.isLoggedInUser?"EMPTY_LISTENS_DESC_OWNER_2":"EMPTY_LISTENS_DESC_2",emptyClass:"listens",actions:!1},this.renderEmpty(s,t);return}this.childViews.listensView&&this.childViews.listensView.destroy(!1),this.childViews.listensView=new n.Views.RecentListens({el:t[0],appModel:r.model,user:this.model.get("user")}),this.childViews.listensView.render()},handlePlaylistSubpageChange:function(e){if(!e||!this.playlistsGridView)return!1;var t=this.model.get("user"),r=this.model.get("subpage"),i=_.bind(function(e){if(this.destroyed||!this.model.get("user")||!e)return!1;e=new n.Models.Collections.Playlists(e.models),e.comparator=n.Models.Playlist.modifiedSort,e.sort(),this.playlistsGridView.collection.reset(e.models),this.$(".empty-page").remove()},this),s=_.bind(function(){if(this.destroyed)return!1;r=="subscribed"?($(".grid-toolbar .btn.my-playlists").removeClass("active"),$(".grid-toolbar .btn.subscribed").addClass("active")):($(".grid-toolbar .btn.my-playlists").addClass("active"),$(".grid-toolbar .btn.subscribed").removeClass("active"))},this);r=="subscribed"?t.getFavoritesByType("Playlists").done(i).done(s):t.getPlaylists().done(i).done(s)},renderCurrentBroadcastCard:function(){if(!_.isFunction(n.Views.Cards.extendArrangeable))return;var e=this.model.get("user"),t=!e||!e.get("isArtist"),i=n.getLoggedInUserID()==(e&&e.get("UserID")),s=t&&i,o=s?n.Views.Cards.extendArrangeable(n.Views.Cards.CurrentBroadcast):n.Views.Cards.CurrentBroadcast,u;if(this.destroyed||!this.indexRendered)return;this.childViews.bcRow||(this.childViews.bcRow=new o({model:e,queue:r.model.get("player").get("currentQueue"),isOwner:i,cardName:"bcRow",onToggleCard:_.bind(this.onArrangementToggle,this),onMoveUp:_.bind(this.onArrangementUp,this),onMoveDown:_.bind(this.onArrangementDown,this)})),u=this.childViews.bcRow.model.get("currentBroadcastID"),u||n.Models.Broadcast.fetchRealtimeBroadcast(u,!1,!0).done(_.bind(this.onBroadcastInfo,this)),this.childViews.bcRow.render()},showCurrentBroadcast:function(){if(!this.childViews.bcRow||this.destroyed||!this.indexRendered)return;this.childViews.bcRow.render(),n.trigger("page:redrawUpdate")},handleFavoriteButtonChange:function(e,t){var n=["artist","playlist","user"],r=$("a.favorite-page",this.el),i=_.getItemType(e);if(_.indexOf(n,i)==-1||_.isUndefined(r))return;var s=this.model.get("appModel").get("user"),o=this.model.get(i).get("isFavorite"),u="",a="";if(i=="playlist")u="SUBSCRIBED",a="SUBSCRIBE";else if(i=="artist"||i=="user")u="FOLLOWING",a="FOLLOW";o?(r.addClass("btn-success"),r.find(".icon").removeClass("icon-plus").addClass("icon-check white"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",u).text(_.getString(u))):(r.removeClass("btn-success"),r.find(".icon").addClass("icon-plus").removeClass("icon-check white"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",a).text(_.getString(a)))},loadProfileImageLightbox:function(){var t=$(e).height(),r=$(e).width(),i=this.model.get(this.pageItemType),s=this.pageItemType==="artist"?i.escape("ArtistName"):i.escape("Name"),o='<img class="show-art" src="'+i.getImageURL("")+'" style="max-width:'+(r-60)+"px; max-height:"+(t-109)+'px">';if(!i.get("Picture")&&!i.get("CoverArtFilename"))return;n.trigger("lightbox:open","generic",{_type:"image",view:{headerHTML:s,messageHTML:o}})},onUploadClick:function(){this.model.get("user").id>0?amdModules.requireDeferred("gs/views/lightboxes/upload.js").done(function(){n.trigger("lightbox:open","upload",{userDefault:!0})}):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_UPLOAD"),onLogin:function(){amdModules.requireDeferred("gs/views/lightboxes/upload.js").done(function(){n.trigger("lightbox:open","upload",{userDefault:!0})})}})},onCreatePlaylistClick:function(){this.model.get("user").id>0?n.trigger("lightbox:open","createPlaylist"):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST"),onLogin:function(){n.trigger("lightbox:open","createPlaylist")}})},onSuggestTagsClick:function(){var e=this.model.get("artist");n.trigger("lightbox:open","suggestTags",{id:e.get("ArtistID"),type:"artist"})},editFeaturedSongs:function(e){$(e.currentTarget).addClass("hide");var t=this.model.get("artist"),n=new ChainLoading;n.push(t.getSongs()),n.push(t.getTopSongs().done(n.bind(this.renderEditableFeaturedSongs,this)))},saveFeaturedSongs:function(){var e=this.model.get("artist"),t=$("#top-songs-grid"),r=t.data("view"),i=[],s;if(!r)return;r.collection.each(function(e){s=e.get("song");if(!s)return;i.push(s)}),i=new n.Models.Collections.Songs(i),e.updateFeaturedSongs(i).done(_.bind(function(){this.showHideTopSongs()},this))},switchBackToTopSongs:function(e){var t=this.model.get("artist"),r=t.updateFeaturedSongs(!1);r.done(_.bind(function(){this.showHideTopSongs()},this)),r.fail(_.bind(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_FAILED_RESET_TOP_SONGS"),type:"error"}),this.showHideTopSongs()},this))},saveRelatedArtists:function(e){this.pendingRelatedArtistsSave=t;var r=$(".related-artists-saved").stop().addClass("hide"),i=new n.Models.Collections.Artists(e),s=this.model.get("artist");return s.updateRelatedArtists(i).done(function(){r.removeClass("hide").css("opacity",1),setTimeout(function(){r.animate({opacity:0},2e3,function(){r.addClass("hide")})},2900)}).fail(_.bind(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_FAILED_RELATED_ARTISTS"),type:"error",click:_.bind(function(){var e=$("#similar-artists-grid").data("view");this.saveRelatedArtists(e.collection.models)},this),duration:1e4})},this))},showHideTopSongs:function(){var e=this.model.get("artist");this.$(".edit-header").addClass("hide"),e.getTopSongs().done(_.bind(this.renderTopSongs,this))},undoRelatedArtistsChanges:function(){if(this.destroyed||!this.indexRendered||this.model.get("section")!=="similar-artists")return;var e=$("#similar-artists-grid").data("view"),t=this.model.get("artist");if(!e)return;e.collection.reset(this.initialRelatedArtists),this.saveRelatedArtists(this.initialRelatedArtists),$(".undo-related-artists").addClass("hide")},onCurrentBroadcastChange:function(e,t){if(this.destroyed||!this.indexRendered)return;var r=this.model.get("subpage");t?(r==="profile"||r==="broadcasts")&&n.Models.Broadcast.getBroadcastInfo(t).done(_.bind(this.onBroadcastInfo,this)):r==="profile"&&this.renderCurrentBroadcastCard()},onNowPlayingSongChange:function(e,t){if(this.destroyed||!this.indexRendered)return;var n=e.get("currentBroadcastID");if(!n||!e.get("isOwnerOfCurrentBroadcast"))return;this.childViews.bcRow&&this.childViews.bcRow.model.get("BroadcastID")==n&&this.childViews.bcRow.model.set("activeSong",t)},onBroadcastInfo:function(e){if(this.destroyed||!this.indexRendered||!e||!e.get("activeStatus"))return;var t=this.model.get("user"),n=t?t.get("isOwnerOfCurrentBroadcast"):!1;if(t&&t.get("currentBroadcastID")!==e.get("BroadcastID"))return;t&&n&&e.getOwner()!==t&&e.handleUserCached(t.id,t),this.showCurrentBroadcast()}})}),define("gs/views/pages/static.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="",t="",r;n.Views.Pages.Static=n.Views.Pages.Base.extend({templatePath:"static",pageType:"static",events:{"mouseenter .menu-dropdown":"showMenuDropdown","mouseleave .menu-dropdown":"hideMenuDropdown","submit #advertising-contact":"submitAdvertising"},initialize:function(i){return r=this.model.get("gsApp"),this.rendered=!1,this.menuTimer={},$(document.body).on("mouseenter.about-dropdown",".menu-dropdown",_.bind(this.stayShowingMenuDropdown,this,this.menuTimer)),$(document.body).on("mouseleave.about-dropdown",".menu-dropdown",_.bind(this.hideMenuDropdown,this,this.menuTimer)),this.model.set({subpage:_.orEqual(this.options.params.subpage,t),section:_.orEqual(this.options.params.section,e)}),n.Views.Pages.Base.prototype.initialize.call(this,i)},onDestroy:function(){$(document.body).off(".about-dropdown")},render:function(){if(this.options.params.notFound){n.router.setHash("/#!/notFound");return}this.options.params.section&&this.options.params.subpage?this.fetchTemplate(this.options.params.section+"/"+this.options.params.subpage).done(_.bind(this.onTemplate,this)).fail(_.bind(function(){this.model.get("subpage")&&n.router.setHash("/"+this.model.get("section"))},this)):this.options.params.section&&this.fetchTemplate(this.options.params.section).always(_.bind(this.onTemplate,this)),this.setTitle(_.ucwords((this.options.params.section||"").toLowerCase().replace("_"," "))),this.rendered=!0},updatePageParams:function(n){var r=this.options.params;this.options.params=n;var i=_.orEqual(n.subpage,t),s=_.orEqual(n.section,e);r.notFound!==n.notFound&&this.render();if(i!=r.subpage||s!=r.section)this.model.set({subpage:_.orEqual(n.subpage,t),section:_.orEqual(n.section,e)}),this.render()},onTemplate:function(r){if(this.destroyed)return;if(!r){n.router.notFound();return}this.$el.html(this.renderTemplate(r,{subpage:_.orEqual(this.model.get("subpage"),t),section:_.orEqual(this.model.get("section"),e),pageNavOptions:this.getPageNavOptions()})),$(".about-slider").tinycarousel({interval:!0,duration:750,intervaltime:5e3,pager:!0})},showMenuDropdown:function(e){var t=$(e.currentTarget);this.menuTimer&&this.menuTimer.timer&&(clearTimeout(this.menuTimer.timer),this.menuTimer.timer=null),t.jjmenu(e,this.getMenuOptions(t),null,{xposition:"left",yposition:"bottom",show:"default",spill:"right",keepState:t,append:document.body,className:"menu-dropdown",shouldLog:!0})},hideMenuDropdown:function(e){this.menuTimer&&this.menuTimer.timer&&clearTimeout(this.menuTimer.timer),this.menuTimer.timer=setTimeout(_.bind(this.closeMenuDropDown,this),200)},stayShowingMenuDropdown:function(e){e&&e.timer&&clearTimeout(e.timer)},getPageNavOptions:function(){var e=this.model.get("subpage"),t=this.model.get("section");return{navItems:[{url:"#!/about",isActive:t==="about"||t==="",locale:"ABOUT",className:"menu-dropdown about"},{url:"#!/artists",isActive:t==="artists",locale:"ARTISTS"},{url:"#!/press",isActive:t==="press"||t=="logo",locale:"PRESS",className:"menu-dropdown press"},{url:"#!/contact",isActive:t==="contact",locale:"CONTACT"},{url:"#!/legal",isActive:t==="legal",locale:"LEGAL",className:"menu-dropdown legal"}]}},getMenuOptions:function(e){return e.hasClass("about")?this.menu=[{title:"The Team",action:{type:"gourl",url:"#!/about/team"}},{title:"Grooveshark University",action:{type:"gourl",url:"#!/about/university"}},{title:"Advertising",action:{type:"gourl",url:"#!/about/advertising"}},{title:"Grooveshark API",action:{type:"gourl",url:"http://developers.grooveshark.com/",target:"_blank"}}]:e.hasClass("legal")?this.menu=[{title:"Terms",action:{type:"gourl",url:"#!/legal/terms"}},{title:"Artist Profile Terms",action:{type:"gourl",url:"#!/legal/artist_terms"}},{title:"Privacy",action:{type:"gourl",url:"#!/legal/privacy"}},{title:"Responsible Disclosure",action:{type:"gourl",url:"#!/legal/responsible_disclosure"}},{title:"DMCA Policy",action:{type:"gourl",url:"#!/legal/dmca"}},{title:"DMCA Form",action:{type:"gourl",url:"http://www.grooveshark.com/dmca_form",target:"_blank"}}]:e.hasClass("press")&&(this.menu=[{title:"Media Resources",action:{type:"gourl",url:"#!/logo"}}]),this.menu},closeMenuDropDown:function(e){$(".menu-dropdown").trigger("contextmenu")},submitAdvertising:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.serializeArray(),i={},s=[];_.each(r,function(e){i[e.name]=e.value}),i["full-name"]==""&&s.push("full-name"),i.email==""&&s.push("email"),i.phone==""&&s.push("phone"),$(".control.error",t).removeClass("error");var o=$(".error-message");o.addClass("hide");if(s.length){_.each(s,function(e){$("#advertising-"+e,t).parent().addClass("error")});return}var u=function(){var e=$(".error-message");e.html("There was an error sending the email - please retry or contact us at advertising@grooveshark.com if this problem persists!"),e.removeClass("hide")};n.Services.API.sendAdvertisingEmail(i).done(function(e){if(!e){u();return}t.html('<p class="advertising-success">Sent! Look out for an email from us soon with more information.</p>')}).fail(u)}})}),define("gs/views/pages/artists.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="",t="";n.Views.Pages.Artists=n.Views.Pages.Base.extend({templatePath:"artists",pageType:"artists",initialize:function(){return this.rendered=!1,this.model.set({subpage:_.orEqual(this.options.params.subpage,t),section:_.orEqual(this.options.params.section,e)}),n.Views.Pages.Base.prototype.initialize.call(this)},render:function(){if(this.options.params.notFound){n.router.setHash("/#!/notFound");return}this.options.params.section&&this.options.params.subpage?this.fetchTemplate(this.options.params.section+"/"+this.options.params.subpage).always(_.bind(this.onTemplate,this)):this.options.params.section?this.fetchTemplate(this.options.params.section).always(_.bind(this.onTemplate,this)):this.fetchTemplate("index").always(_.bind(this.onTemplate,this)),this.setTitle("Artists"),this.rendered=!0},updatePageParams:function(n){var r=this.options.params;this.options.params=n;var i=_.orEqual(n.subpage,t),s=_.orEqual(n.section,e);r.notFound!==n.notFound&&this.render();if(i!=r.subpage||s!=r.section)this.model.set({subpage:_.orEqual(n.subpage,t),section:_.orEqual(n.section,e)}),this.render()},onTemplate:function(r){if(this.destroyed)return;this.$el.html(this.renderTemplate(r,{subpage:_.orEqual(this.model.get("subpage"),t),section:_.orEqual(this.model.get("section"),e)})),n.trigger("page:ready",this)}})}),define("gs/views/pages/search.js",function(){function i(e){var t=_.ucwords(e);return t!="Everything"&&t.charAt(t.length-1)!="s"&&(t+="s"),t}n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="everything",r;n.Views.Pages.Search=n.Views.Pages.Base.extend({templatePath:"search",pageType:"search",events:{"click #did-you-mean-search-link":"trackSuggestionClick"},initialize:function(s){r=this.model.get("gsApp");var o=String(s.params.query||s.params.q||""),u=r.model,a=u.get("user").get("searchVersion")||u.get("searchVersion")||t,f=n.Services.GUTS.currentTest,l=$.Deferred(),c;return this.indexRendered=!1,this.finishedReturnResults=!1,this.renderedTabs=[],this.loggingDfd=l,this.currentType=i(s.params.type||e),l.always(_.bind(function(e){this.reportGutsInformation(e)},this)),f&&f.name&&f.name.indexOf("Interleaving_")===0&&(a=f.name),o.indexOf("ppVersion:",0)===0&&(c=o.split(/\s+/),a=c[0].split(":")[1],o=c.splice(1,c.length).join(" ")),o=$.trim(o.replace(/\s+/g," ")),this.model=new n.Models.Search({query:o,ppOverride:a}),this.model.set("subpage",(this.currentType||"").toLowerCase()),n.Views.Pages.Base.prototype.initialize.call(this,s)},onDestroy:function(){this.sectionTemplate=null,this.model.abortRequests()},updatePageParams:function(t){var r=this.currentType;this.currentType=i(t.type||e),this.model.set("subpage",(this.currentType||"").toLowerCase()),this.currentType!==r&&($("#column1").find(".tab-section").addClass("hide").filter('[data-section="search-'+this.currentType.toLowerCase()+'"]').removeClass("hide"),n.router.setHash(this.getUrl(this.currentType)),this.renderResults()),n.trigger("page:ready",this)},render:function(){this.indexRendered=!1;var e=this.currentType,t=this.model,i=t.get("query");this.leftToFetch=["Songs","Artists","Albums","Broadcasts","Playlists","Users","Events"];var s=_.indexOf(this.leftToFetch,e);if(s!=-1){var o=this.leftToFetch.splice(s,1);this.leftToFetch.unshift(o[0])}e&&e!=="Everything"?this.setTitle("All "+_.ucwords(e)+" Results: "+i):this.setTitle("Search: "+i),this.setFirstTab="search-"+e.toLowerCase();var u=new ChainLoading,a;u.push(this.fetchTemplate("index").done(u.bind(this.renderIndex,this))),a=this.getResults(e),u.push.apply(u,a),u.push(this.fetchTemplate("section").done(u.bind(this.onSectionTemplate,this))),u.done(_.bind(this.renderResults,this)),a.length&&u.done(_.bind(function(){this.loggingDfd.resolve(r.model.get("searchVersion"));while(this.leftToFetch.length)a=this.getResults(this.leftToFetch[0]),u.push.apply(u,a);u.done(_.bind(function(){this.finishedReturnResults=!0,this.renderResults()},this))},this)),u.pushIgnoreFail(n.Services.API.getGoogleSuggest(i).done(u.bind(this.showSuggestion,this)))},renderIndex:function(e){if(this.destroyed)return;var t={currentType:this.currentType,getUrl:_.bind(this.getUrl,this),canHideAds:r.model.get("user").get("subscription").canHideAds()},i;this.$el.html(this.renderTemplate(e,t)),i=encodeURIComponent(this.model.get("query")),i=i.replace(/%20/g,"+"),this.model.set("escapedQuery",i);var s=[{subpage:"everything",locale:"EVERYTHING",url:"/#!/search?q="+i},{subpage:"songs",locale:"SONGS",url:"/#!/search/song?q="+i},{subpage:"artists",locale:"ARTISTS",url:"/#!/search/artist?q="+i},{subpage:"albums",locale:"ALBUMS",url:"/#!/search/album?q="+i},{subpage:"users",locale:"PEOPLE",url:"/#!/search/user?q="+i},{subpage:"playlists",locale:"PLAYLISTS",url:"/#!/search/playlist?q="+i},{subpage:"broadcasts",locale:"BROADCASTS",url:"/#!/search/broadcasts?q="+i},{subpage:"events",locale:"EVENTS",url:"/#!/search/event?q="+i}];this.childViews.pageHeader=new n.Views.PageHeader({el:this.$("#page-header"),navItems:s,actions:[],model:this.model,item:this.model,titleProperty:"query",picture:"",imageURL:""}),this.childViews.pageHeader.render(),this.indexRendered=!0,n.trigger("page:ready",this)},onSectionTemplate:function(e){if(this.destroyed)return;this.sectionTemplate=e},getResults:function(e){var t,n;switch(e){case"Playlists":t=this.model.getResults(["Playlists"]);break;case"Users":t=this.model.getResults(["Users"]);break;case"Events":t=this.model.getResults(["Events"]);break;case"Broadcasts":t=this.model.getResults(["Broadcasts"]);break;case"Everything":case"Songs":case"Artists":case"Albums":this.leftToFetch=_.without(this.leftToFetch,"Songs","Artists","Albums"),t=this.model.getResults(["Songs","Artists","Albums"]);break;default:t=[]}return n=_.indexOf(this.leftToFetch,e),n>=0&&this.leftToFetch.splice(n,1),t},prefetchSongStreamKeys:function(){if(this.prefetchedStreamKeys)return;var e=this.model.get("songs"),t=[];for(var r=0,i=Math.min(e.length,3);r<i;r++)t.push(e.at(r).get("SongID"));t.length&&n.Models.PlayableSong.precacheStreamKeys(t),this.prefetchedStreamKeys=!0},renderResults:function(){var e=this.model.get("query"),t={query:e},i=r.model.get("user").get("subscription").canHideAds(),s,o,u,a,f;if(this.destroyed)return;switch(this.currentType){case"Everything":_.indexOf(this.renderedTabs,"everything")===-1&&(this.prefetchSongStreamKeys(),this.model.selectTopResult(),this.model.get("topResult")?(this.fetchTemplate("topResult").done(_.bind(function(e){this.renderTopResult(e)},this)),this.hasTopResultArtist=this.model.get("topResult")instanceof n.Models.Artist):this.hasTopResultArtist=!1,this.finishedReturnResults&&this.renderedTabs.push("everything")),o=0,u=!1,a=$("#search-everything-tab"),f=[{title:_.getString("SONGS"),type:"songs",rows:25}],this.hasTopResultArtist||f.push({title:_.getString("ARTISTS"),type:"artists",rows:i?1:2}),f.push({title:_.getString("ALBUMS"),type:"albums",rows:i?1:2},{title:_.getString("PEOPLE"),type:"users",rows:2},{title:_.getString("BROADCASTS"),type:"broadcasts",rows:3},{title:_.getString("PLAYLISTS"),type:"playlists",rows:5},{title:_.getString("EVENTS"),type:"events",rows:3},{title:_.getString("GENRES"),type:"tags",rows:1}),this.updateNoResults(!1);var l=_.bind(function(){var e=f.shift(),t=e.type,n=this.model.get(t),r=a.find(".search-"+t+"-piece"),i,s;!r.length&&n&&n.length&&(r=$('<div class="search-everything-piece search-'+t+'-piece card"></div>'),r.appendTo(a),e.$section=r,e.type!="songs"&&(e.hideGridToolbar=!0),this.renderGrid(e),n.length>e.rows&&(s="SEE_ALL_"+t.toUpperCase().substring(0,t.length-1)+"_RESULTS",i=$('<div class="show-more-container"><a class="show-more"><span class="label"></span><i class="icon icon-caretright"></i></a></div>'),i.find(".show-more").attr("href","/#!/search/"+t+"?q="+this.model.get("escapedQuery")),i.find(".label").data("translateText",s).text(_.getString(s)),i.appendTo(r)),o+=100),n&&n.length&&(u=!0),f.length&&o?setTimeout(function(){l()},o):f.length?l():u||this.updateNoResults(!0)},this);l();return;case"Songs":s={title:_.getString("SONG_RESULTS_FOR",t),type:"songs"};break;case"Artists":s={title:_.getString("ARTIST_RESULTS_FOR",t),type:"artists"};break;case"Albums":s={title:_.getString("ALBUM_RESULTS_FOR",t),type:"albums"};break;case"Users":s={title:_.getString("PEOPLE_RESULTS_FOR",t),type:"users"};break;case"Broadcasts":s={title:_.getString("BROADCAST_RESULTS_FOR",t),type:"broadcasts"};break;case"Playlists":s={title:_.getString("PLAYLIST_RESULTS_FOR",t),type:"playlists"};break;case"Events":s={title:_.getString("EVENT_RESULTS_FOR",t),type:"events"}}if(s){var c=s.type;c===this.currentType.toLowerCase()&&this.updateNoResults(!this.model.get(c).length,c);if(_.indexOf(this.renderedTabs,s.type)!==-1)return;this.finishedReturnResults&&this.renderedTabs.push(s.type),this.renderGrid(s)}n.trigger("page:redrawUpdate")},renderGrid:function(e){var t=e||{},i=t.type,s=this.model.get(i),o=1,u=r.model.get("user").get("subscription").canHideAds(),a=t.selector||"#search-"+this.currentType.toLowerCase()+"-tab",f=t.$section||this.$(a),l=this.currentType=="Everything";if(!s.length)return;f.html(this.renderTemplate(this.sectionTemplate,t));var c=f.find(".title"),h=f.find(".grid-toolbar-container"),p=f.find(".grid"),d=new n.Models.PlayContext({contextType:"search",query:this.model.get("query")}),v,m,g;d.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),c.text(t.title),!t.hideGridToolbar&&h.length&&c.parent().addClass("has-grid-toolbar");switch(i){case"songs":g={el:p[0],collection:s,canvasMaxItems:t.rows,header:!1,playContext:d};var y={searchContext:!0},b=n.Views.SongGridTall.extend({handleItemDblclick:function(e){return n.trigger("guts:logsearch","dblClick",this,e),this._super.apply(this,["handleItemDblclick"].concat(_.toArray(arguments)))},handleDragEnd:function(e,t){return n.trigger("guts:logsearch","drag",this,e),this._super.apply(this,["handleDragEnd"].concat(_.toArray(arguments)))},contextMenuExtra:y});v=new b(g),y.grid=v;break;case"albums":m=l?"AlbumGrid":"AlbumGridTall",g={el:p[0],collection:s,header:!1,showArtist:!0},l&&(g=_.extend(g,{maximumVisibleRows:1})),v=new n.Views[m](g);break;case"artists":g={el:p[0],collection:s,header:!1,hideInfo:!0},l&&(g=_.extend(g,{maximumVisibleRows:1})),v=new n.Views.UserArtistGrid(g);break;case"broadcasts":v=new n.Views.BroadcastRowLargeGrid({el:p[0],collection:s,canvasMaxItems:t.rows,header:!1});break;case"playlists":m="PlaylistGrid",g={el:p[0],collection:s,canvasMaxItems:t.rows,header:!1},l&&(g=_.extend(g,{maximumVisibleRows:1})),v=new n.Views[m](g);break;case"users":o=u?3:2,g={el:p[0],collection:s,header:!1},l&&(g=_.extend(g,{maximumVisibleRows:2})),v=new n.Views.UserArtistGrid(g);break;case"events":v=new n.Views.EventGridTall({el:p[0],collection:s,canvasMaxItems:t.rows,header:!1});break;case"tags":v=new n.Views.TagGrid({el:p[0],collection:s,canvasMaxItems:t.rows,header:!1});break;default:return}this.currentType!=="Everything"&&v.$el.addClass("medium"),this.childViews.push(v),v.render();if(!t.hideGridToolbar&&h.length){var w=new n.Views.GridToolbar({el:h[0],model:this.model,gridView:v,playContext:d,page:"search",buttons:i=="songs"?["play","add","sort","filterSearch"]:["sort","filterSearch"]});this.childViews.push(w),h.removeClass("hide"),w.render()}},showSuggestion:function(e){if(e==this.model.get("query"))return;var t=$("#did-you-mean");t.find("a.search-link").text(e).attr("title",e).data({searchquery:e,suggestionSource:"eg",searchtype:this.currentType?this.currentType:""}),t.removeClass("hide");var r=this.currentType=="Everything"?"songs":this.currentType.toLowerCase(),i=this.model.get(r),s=i?i.length:0;_.gaTrackEvent("search","suggest","eg"),n.trigger("guts:log","suggest",{suggest:e,source:"eg",numSongs:s})},trackSuggestionClick:function(e){var t=$(e.currentTarget),r=t.data("suggestionSource"),i=t.data("suggestion"),s=this.currentType=="digest"?"Songs":this.currentType,o=this.results&&this.results[s]?this.results[s].length:0;_.gaTrackEvent("search","suggestClick",r,o),n.trigger("guts:log","suggestClick",{suggest:i,source:r,numSongs:o})},reportGutsInformation:function(e){e=_.orEqual(e,this.overrideSearchVersion);var t={type:this.currentType||"song",searchString:this.model.get("query"),searchVersion:e};this.isTagSearch&&(t.isTagSearch=!0,t.tagID=this.tagID),n.trigger("guts:log","search",t);var r={mostRecentSearch:this.model.get("query"),mostRecentSearchType:this.currentType||"song",mostRecentSearchVersion:e};this.isTagSearch&&(r.mostRecentTagSearched=this.tagID),n.trigger("guts:begincontext",r),!this.isTagSearch&&n.Services.GUTS&&n.Services.GUTS.context.hasOwnProperty("mostRecentTagSearched")&&n.trigger("guts:endcontext","mostRecentTagSearched")},updateNoResults:function(e,t){var n=$("#search-no-results");if(!e){n.addClass("hide");return}var r=$("#search-no-match-header"),i;switch(t){case"songs":i=_.getString("NO_SONG_MATCHES");break;case"albums":i=_.getString("NO_ALBUM_MATCHES");break;case"artists":i=_.getString("NO_ARTIST_MATCHES");break;case"broadcasts":i=_.getString("NO_BROADCAST_MATCHES");break;case"playlists":i=_.getString("NO_PLAYLIST_MATCHES");break;case"users":i=_.getString("NO_USER_MATCHES");break;case"events":i=_.getString("NO_EVENT_MATCHES");break;default:i=_.getString("NO_SEARCH_RESULTS")}r.text(i),n.removeClass("hide")},renderTopResult:function(e){var t=this.model.get("topResult"),r=_.getItemType(t),i,s,o,u,a;switch(r){case"song":u=new n.Views.Modules.SongProfileCard({model:t,hideSuggestTags:!0});break;case"artist":u=new n.Views.Modules.ArtistProfileCard({model:t,hideSuggestTags:!0}),a=!0;break;case"album":u=new n.Views.Modules.AlbumProfileCard({model:t,hideSuggestTags:!0});break;case"tag":u=new n.Views.Modules.TagRow({model:t});break;case"broadcast":u=new n.Views.Modules.BroadcastRowLarge({model:t})}if(!u||!t||this.destroyed)return;i=this.$(".search-top-result-piece"),i.length||(i=$('<div class="search-everything-piece search-top-result-piece"></div>')),i.html(this.renderTemplate(e)),s=i.find("#top-result"),o=s.find(".title"),o.text(_.getString("TOP_RESULT_FOR_SEARCH",{query:this.model.get("query")})),r!=="tag"&&(u.small=!0),s.find(".card-content").append(u.$el),$("#search-everything-tab").prepend(i),a&&(i=$('<div class="show-more-container"><a class="show-more view-all-artists"><span class="label"></span><i class="icon icon-caretright"></i></a></div>'),i.find(".view-all-artists").attr("href","/#!/search/artist?q="+this.model.get("escapedQuery")),i.find(".label").data("translateText","SEE_ALL_ARTIST_RESULTS").text(_.getString("SEE_ALL_ARTIST_RESULTS")),s.append(i)),u.render(),u.on("rendered",function(){n.trigger("page:redrawUpdate")}),this.childViews.push(u),t&&t instanceof n.Models.Artist?n.Models.Profile.get(null,t.get("ArtistID"),!1,!0).done(function(){u.changeModel(t,{force:!0})}):t&&t.getPageNameData&&t.getPageNameData(),t.get("ArtistID")&&n.trigger("theme:notification",{artistID:t.get("ArtistID"),timeout:750})},getUrl:function(e){var t=(e||"").toLowerCase(),n=encodeURIComponent(this.model.get("query"));return n=n.replace(/%20/g,"+"),t&&t!=="everything"?(t.charAt(t.length-1)==="s"&&(t=t.substr(0,t.length-1)),"/#!/search/"+t+"?q="+n):"/#!/search?q="+n}},{GENRE_TAGS:{"40s":2837,"50s":1087,"60s":266,"70s":588,"80s":55,"8bit":2145,"90s":9,acapella:4263,acidjazz:3519,acoustic:105,alternativerock:1259,ambient:75,americana:922,anime:120,banda:4264,bass:585,beach:912,beat:1475,bhangra:130,blackmetal:4265,bluegrass:96,blues:230,bluesrock:1106,britpop:534,celtic:513,chanson:3692,chillout:251,chinese:4266,christian:439,christianmetal:4267,christianrock:4268,christmas:703,classical:750,classiccountry:4269,classicrock:3529,club:1038,contemporarychristian:4270,country:80,crunk:748,cumbia:4271,dance:71,dancehall:269,darkwave:2139,dcima:4272,deathmetal:4273,desi:2512,disco:899,disney:623,dnb:273,downtempo:153,dub:3501,dubstep:2563,electro:162,electronic:123,electronica:67,electropop:893,emo:131,eurodance:4028,experimental:191,flamenco:85,folk:122,folkrock:925,funk:397,funky:398,goa:2556,gospel:1489,grime:268,grunge:134,hardcore:245,hardstyle:4274,heavymetal:1054,hiphop:29,house:48,indie:136,indiefolk:1221,indiepop:573,indierock:1138,industrial:275,island:2294,jazz:43,jazzblues:4275,jazzfusion:4276,jesus:1356,jpop:568,jrock:434,jungle:248,kpop:1765,lounge:765,mathrock:4277,medieval:2585,meditation:700,melodic:929,merengue:84,metal:17,metalcore:705,minimal:2177,motown:4278,mpb:819,neofolk:1139,neosoul:4279,noise:171,nujazz:3518,numetal:1103,oi:4280,oldies:102,opera:1535,orchestra:2760,pagode:3606,pop:56,poppunk:1333,poprock:3468,posthardcore:1332,postrock:422,powermetal:4063,progressive:97,progressiverock:4137,psychedelic:1168,psychobilly:3909,punkrock:1754,ragga:4281,rap:3,rave:271,rb:4282,reggae:160,reggaeton:940,relax:1941,rnb:877,"r&b":877,rock:12,rockabilly:1086,rocksteady:4283,rootsreggae:4284,rumba:3454,salsa:81,samba:4285,schlager:3162,screamo:166,sertanejo:4286,singersongwriter:923,ska:100,skapunk:1110,smoothjazz:3855,softrock:1311,soul:520,soundtrack:72,southernrock:1298,surf:1408,swing:1032,symphonicmetal:4287,synthpop:163,tango:2868,techno:47,tejano:789,texascountry:4288,thrashmetal:4289,trance:69,triphop:158,turkish:689,underground:468,vallenato:89,videogame:115,vocal:6,world:313,zydeco:4290}})}),define("gs/views/pages/popular.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="songs",t="daily",r;n.Views.Pages.Popular=n.Views.Pages.Base.extend({templatePath:"popular",pageType:"popular",events:{"click .popular-play":"onPopularPlayClick"},initialize:function(e){r=this.model.get("gsApp"),this.rendered=!1,this.timeRange=e.params.type||t,this.model.set("timeRange",this.timeRange),this.model.on("change",this.onModelChange,this),this.model.on("change:type",this.onTypeChange,this),n.Views.Pages.Base.prototype.initialize.call(this,e),this.updatePageParams(this.options.params)},render:function(){this.indexRendered=!1,this.songsRendered=!1,this.fetchTemplate("index").always(_.bind(this.renderIndex,this)),this.rendered=!0,this.setTitle(["Popular",_.ucwords(this.model.get("subpage"))])},renderIndex:function(e){if(this.destroyed||!this.popularSongs||this.indexRendered)return;var t={subpage:this.model.get("subpage"),timeRange:this.model.get("timeRange")},r=this.$(".slider").empty(),i=new n.Views.Slider({el:r[0],model:new Backbone.Model,slides:[{title:"Slide 1"},{title:"Slide 2"},{title:"Slide 3"}]});this.$el.html(this.renderTemplate(e,t)),this.childViews.slider=i,i.render(),this.indexRendered=!0,this.renderSongs(),n.trigger("page:ready",this)},renderSongs:function(){if(this.destroyed||!this.indexRendered||!this.popularSongs||!this.popularSongs.length||this.model.get("subpage")!="songs")return;var e=$("#grid.popular").empty(),t=new n.Models.PlayContext({contextType:"popular"}),r=new n.Views.SongRowTallList({el:e,collection:this.popularSongs,showCount:!gsConfig.isMobile,playContext:t}),i=n.getAppSize()==="mobile",s=this,o,u;i||(o={el:this.$(".grid-toolbar-container"),model:this.model,listView:r,playContext:t},o.buttons=["play","add","popular","filterSearch"],u=new n.Views.GridToolbar(o),u.on("rendered",function(){s.onTypeChange()}),u.render(),this.childViews.gridToolbarView=u),this.childViews.gridView=r,r.render(),this.songsRendered=!0},updatePageParams:function(n){var r=_.orEqual(n.subpage,e),i=_.orEqual(n.type,t),s={};r!==this.model.get("subpage")&&(s.subpage=r),i!==this.model.get("type")&&(s.type=i),_.keys(s).length&&this.model.set(s)},onModelChange:function(){var e=this.model.get("subpage"),t=this.model.get("type");t&&t!==this.timeRange&&(n.router.replaceHash("/popular/"+t),this.timeRange=t,this.model.set("timeRange",this.timeRange));switch(e){case"songs":n.Services.API.popularGetSongs(t).done(_.bind(function(e){this.popularSongs=new n.Models.Collections.Songs(e&&e.Songs||[]),this.songsRendered?this.childViews.gridView?this.childViews.gridView.collection.reset(this.popularSongs.models,{sorted:!0}):console.log("no grid view",this):this.render()},this));break;default:n.router.notFound();return}},onTypeChange:function(){var e=this.model.get("type");e==="daily"?$(".today").addClass("active").siblings().removeClass("active"):e==="weekly"?$(".week").addClass("active").siblings().removeClass("active"):e==="monthly"&&$(".month").addClass("active").siblings().removeClass("active"),this.childViews.gridToolbarView&&this.childViews.gridToolbarView.clearFilter()},onPopularPlayClick:function(e){if(!this.popularSongs)return;var t=new n.Models.PlayContext;t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",this.popularSongs,n.Models.Player.playSpecialIndexes.REPLACE,!0,t)}})}),define("gs/views/pages/genre.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{},n.Views.Pages.Genre=n.Views.Pages.Base.extend({templatePath:"genre",pageType:"genre",ui:{toolbar:".grid-toolbar-container",genreBio:".genre-bio",column1:"#column1",grid:".grid"},initialize:function(e){var t=e&&e.params&&e.params.tagID;this.model.set("tagID",t||null),t&&this.updateTag(),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){this.fetchTemplate("index").always(_.bind(this.onTemplate,this)),this.rendered=!0},onTemplate:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e)),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:tagID",this.updateTag),this.listenTo(this.model,"change:tag",this.renderContent),this.renderHelperCard(),this.renderContent(),n.trigger("page:ready",this)},renderHelperCard:function(){if(!this.model.get("tag")||this.destroyed)return;this.childViews.helperCard&&this.childViews.helperCard.destroy(!1),this.childViews.helperCard=new n.Views.Cards.HelperCard({el:$("#column1").find(".helper"),locale:"HELPER_PAGE_GENRES",localeOpts:{genre:this.model.get("tag").get("DisplayName")},page:"genrepage"}),this.childViews.helperCard.render()},renderContent:function(){if(!this.model.get("tag")||this.destroyed)return;var e=new n.Models.PlayContext({contextType:"genre"}),t=this.model.get("gsApp").model.get("appSize")==="mobile",r;this.childViews.genreBio&&this.childViews.genreBio.destroy(!0),this.childViews.genreBio=new n.Views.GenreBio({tagID:this.model.get("tagID"),showDescToggle:!0}),this.childViews.genreBio.render(),this.childViews.genreBio.$el.prependTo(this.ui.$column1),this.childViews.gridView=new n.Views.SongGridTall({el:this.ui.$grid.empty(),collection:this.model.get("tag").get("Songs"),showCount:!t,header:!1,playContext:e}),r={el:this.ui.$toolbar,model:this.model,gridView:this.childViews.gridView,playContext:e,buttons:["play","add","filterSearch"]},this.childViews.gridToolbarView=new n.Views.GridToolbar(r),this.childViews.gridToolbarView.render(),this.childViews.gridView.render(),this.setTitle(["Genre",this.model.get("tag").get("DisplayName")])},updateTag:function(){n.Models.Tag.getMulti([this.model.get("tagID")]).done(_.bind(function(e){if(!e||!e.length)return;this.model.set("tag",e[0])},this))}})}),define("gs/views/pages/onlineFriends.js",function(){function e(e){var t=e.attributes.currentBroadcastID&&e.attributes.nowPlayingSong,n=e.attributes.currentBroadcastID,r,i;return e.id<-100&&(e=e.attributes.artist||e),e.attributes.currentBroadcastID&&e.attributes.currentBroadcastOwner&&(r=e.attributes.currentBroadcastOwner,r&&(t=r.attributes.nowPlayingSong,r.attributes.currentBroadcastID!=n&&(n=null))),t?0+n+(e.attributes.isOwnerOfCurrentBroadcast?0:1):(i=e.attributes.Name||e.attributes.ArtistName,1+(e.attributes.onlineStatus?0:1)+(e.attributes.nowPlayingSong?0:1)+i.toLowerCase())}function t(){if((this.user.get("sessionPrivacy")&4)!==0)return;this.get("onlineFriends").reset(this.communityUsers.where({onlineStatus:1})),this.loadingDfd.resolve(this.get("onlineFriends"))}n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var i,s;i=Backbone.Model.extend({subscribedToFriendsChange:!1,settingChatFriends:!1,loadingFriends:!0,initialize:function(t){var r=t||{},i=new n.Models.Collections.Users;i.comparator=e,this.loadingDfd=$.Deferred(),this.set({onlineFriends:i,dfd:this.loadingDfd.promise()}),this.user=r.user,this.communityUsers=new n.Models.Collections.Users,this.listenTo(n,"manatee:connected",this.chatConnected),this.user.getFavoritesByType("Users").done(_.bind(function(e){this.loadingFriends=!1,e&&(this.updateFriends(),this.listenTo(e,"add remove reset sort",this.updateFriends))},this)),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},initialOnlineFriendsUpdate:function(){_.delay(_.bind(function(){this.stopListening(n,"manatee:friendsStatus"),this.listenTo(this.communityUsers,"change:onlineStatus",this.updateOnlineFriendsThrottle),this.listenTo(this.communityUsers,"change:nowPlayingSong",this.updateOnlineUserSong),this.listenTo(this.communityUsers,"change:currentBroadcastID",this.updateOnlineFriendsThrottle),t.call(this),this.subscribedToFriendsChange=!1},this),50)},updateFriends:function(){var e=this.user.get("favoriteUsers"),t=e?e.models:[];this.communityUsers.reset(t),this.sendFriendsToManatee()},sendFriendsToManatee:function(){if(this.user&&!this.loadingFriends){var e=this.user.get("favoriteUsers"),t=[];if(!e)return;this.communityUsers&&(this.stopListening(this.communityUsers),this.subscribedToFriendsChange||(this.listenTo(n,"manatee:friendsStatus",this.initialOnlineFriendsUpdate),this.subscribedToFriendsChange=!0));if(this.settingChatFriends)return;this.settingChatFriends=!0,e.each(function(e){t.push(e.id)}),r.model.get("manatee").monitorUsers(t,"sidebar",{replace:!0}).done(_.bind(function(){this.settingChatFriends=!1},this))}},updateOnlineFriendsThrottle:_.throttle(t,30),updateOnlineUserSong:function(e,t,n){var r=e.previous("nowPlayingSong");(r&&!t||t&&!r)&&this.updateOnlineFriendsThrottle()},removeUserMonitor:function(){r.model.get("manatee").monitorUsers([],"sidebar",{replace:!0})},chatConnected:function(e){this.sendFriendsToManatee()}}),s=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{gridTypeClass:"grid-type-online-user",itemRenderer:n.Views.Modules.OnlineUserCell,itemHeight:90,itemWidth:300,variableItemsPerRow:!0,header:!1}),handleItemDblclick:function(){}}),n.Views.Pages.Onlinefriends=n.Views.Pages.Base.extend({templatePath:"onlineFriends",pageType:"onlinefriends",ui:{grid:".grid",onlineFriends:".card.online-friends",empty:".empty",cardTitle:".card-title",filter:"@cardTitle .filter-input",count:"@cardTitle .count",spinner:".page-loading",num:"@count .num"},initialize:function(e){var t=e.params&&e.params.user;this.model=new i({user:t}),n.Views.Pages.Base.prototype.initialize.call(this,arguments)},onDestroy:function(){this.model.stopListening(),this.model.removeUserMonitor()},render:function(){if(this.rendered)return;this.setTitle(["Online Friends"]),this.fetchTemplate("index").done(_.bind(this.onTemplate,this)),this.rendered=!0},onTemplate:function(e){var t,r;if(this.destroyed)return;t=new ChainLoading,this.$el.html(this.renderTemplate(e)),this.bindUIElements(),this.renderTitleCount(),this.listenTo(this.model.get("onlineFriends"),"add remove change reset",this.updateCount),r=this.model.get("dfd"),t.push(r).done(_.bind(this.renderContent,this)),t.push(_.bind(this.updateCount,this)),t.push(_.bind(n.trigger,n,"page:ready",this)),r.state()==="pending"&&_.delay(_.bind(function(){this.model.get("dfd").state()==="pending"&&this.renderContent()},this),2e3)},renderEmptyCard:function(){var e;if(this.childViews.emptyCard)return;n.Services.Twitter.connected?e={el:this.ui.$empty,cardTitle:"MY_COMMUNITY_EMPTY_2",title:"MY_COMMUNITY_EMPTY_SUBTITLE",desc:"MY_COMMUNITY_EMPTY_DESC",actionLabel:"BROWSE_MY_FEED",action:function(){n.router.setHash("home")}}:e={el:this.ui.$empty,cardTitle:"MY_COMMUNITY_EMPTY_2",title:"MY_COMMUNITY_EMPTY_SUBTITLE",desc:"MY_COMMUNITY_EMPTY_DESC_TWITTER",actionLabel:"TWITTER_SERVICE_CONNECT",action:function(){n.router.setHash("settings/connect")}},this.childViews.emptyCard=new n.Views.Cards.Empty(e),this.childViews.emptyCard.render()},updateCount:function(){var e=!this.model.get("onlineFriends").length;this.renderTitleCount(),this.ui.$empty.toggleClass("hide",!e),this.ui.$onlineFriends.toggleClass("hide",e)},renderTitleCount:function(){var e=this.model.get("onlineFriends").length;this.ui.$count.toggleClass("hide",!e),this.ui.$num.text(_.addCommaSeparators(e))},renderContent:function(){var e;if(this.destroyed)return;this.ui.$spinner.addClass("hide"),e=!this.model.get("onlineFriends").length,this.updateCount(),e?amdModules.requireDeferred("gs/views/cards/empty.js").done(_.bind(this.renderEmptyCard,this)):!e&&!this.childViews.grid&&this.renderGrid()},renderGrid:function(){this.childViews.filterInput=new n.Views.FilterInput({el:this.ui.$filter}),this.childViews.filterInput.render(),this.listenTo(this.childViews.filterInput.model,"change:filter",this.updateGridFilter),this.childViews.grid=new s({el:this.ui.$grid,collection:this.model.get("onlineFriends")}),this.childViews.grid.render()},updateGridFilter:function(){var e=this.childViews.filterInput.model.get("filter");this.childViews.grid.filter(e)}})}),define("loginPage",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var t;n.Views.Pages.Login=n.Views.Pages.Base.extend({templatePath:"login",templateFile:"index",pageType:"login",ui:{error:".error",message:".message",formContainer:".form",form:"form",username:"#login-username",password:"#login-password",submitBtn:".submit",googleBtn:".google",twitterBtn:".twitter",forgotBtn:".forgot",signupBtn:".open-signup"},events:{"click @submitBtn":"clickSubmit","click @forgotBtn":"clickForgot","click @googleBtn":"clickGoogle","click @twitterBtn":"clickTwitter","click @signupBtn":"clickSignup","keypress input":"keypressInput","submit form":"submitForm"},initialize:function(e){t=this.model.get("appModel");var r=t.get("adrollPages"),i=e.params||{};return this.username=i.username,this.premiumRequired=_.orEqual(i.premiumRequired,!1),this.canClose=_.orEqual(i._canClose,!1),this.preventRedirect=_.orEqual(i.preventRedirect,!1),this.destination=_.orEqual(i.destination,""),this.onClose=_.orEqual(i.onClose,function(){}),this.onLogin=_.orEqual(i.onLogin,function(){}),this.model.set({error:i.error,message:i.message}),_.indexOf(r,"signin")===-1&&r.push("signin"),n.Views.Pages.Base.prototype.initialize.call(this,e)},onDestroy:function(){var e=this.$("#gs-login-form");e.length||(e=$("#gs-login-form")),e.detach(),$("#login-password",e).val(""),$("#gs-login-container").append(e),_.defer(this.onClose),this.stopListening()},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){var t=$("#gs-login-form").detach();this.$el.html(this.renderTemplate(e)),this.$(this.ui.formContainer).append(t),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:error",this.renderError),this.listenTo(this.model,"change:message",this.renderMessage),this.renderError(),this.renderMessage(),this.username&&this.ui.$username.val(this.username),_.each([this.ui.$username,this.ui.$password],function(e){if(!e.value)return e.focus(),!1})},renderError:function(){var e=this.model.get("error");e?this.ui.$error.removeClass("hide").html(e):this.ui.$error.addClass("hide")},renderMessage:function(){var e=this.model.get("message");e?this.ui.$message.removeClass("hide").html(e):this.ui.$message.addClass("hide")},clickForgot:function(e){n.trigger("lightbox:open","forget",{premiumRequired:this.premiumRequired,canClose:this.canClose})},clickSubmit:function(e){this.ui.$form.submit()},clickGoogle:function(e){t.login("google",null,null,this.destination).done(_.bind(this.loginSuccess,this)).fail(_.bind(this.loginFailed,this))},clickTwitter:function(e){t.login("twitter",null,null,this.destination).done(_.bind(this.loginSuccess,this)).fail(_.bind(this.loginFailed,this))},clickSignup:function(e){n.router.setHash("signup",{destination:this.destination,onClose:this.onClose,onLogin:this.onLogin})},submitForm:function(n){var r=this.ui.$username.val(),i=this.ui.$password.val(),s;e.external&&_.has(e.external,"AutoCompleteSaveForm")&&e.external.AutoCompleteSaveForm(document.getElementById("gs-login-form")),this.model.set("error",null),s=t.login("normal",r,i,this.destination,this.preventRedirect),s.then(_.bind(this.loginSuccess,this)),s.fail(_.bind(this.loginFailed,this))},keypressInput:function(e){e.which===_.keyboard.ENTER&&this.ui.$form.submit()},loginSuccess:function(e){this.ui.$password.val(""),_.isFunction(this.onLogin)&&_.defer(this.onLogin,e)},loginFailed:function(e){var t;e.error?t=_.getString(e.error)||e.error:(e&&e.loginReason==1?t="LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING":e&&e.authType==="google"?t="GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG":e&&e.authType==="twitter"?t="TWITTER_MISSING_LOGIN_INFO_ERROR_MSG":e&&e.userID===0?t="LB_SIGNUP_LOGIN_FORM_AUTH_ERROR":t="LB_SIGNUP_LOGIN_FORM_GENERAL_ERROR",t=_.getString(t)),t&&_.gaTrackPageView("/sub-funnel/login-lb-error/error-"+t),this.ui.$password.val(""),this.model.set("error",t)}})}()),define("gs/views/pages/newFeatures.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{},n.Views.Pages.Newfeatures=n.Views.Pages.Base.extend({templatePath:"newFeatures",templateFile:"index",pageType:"newFeatures",ui:{featuresCard:"#features-card-container"},initialize:function(e){this.user=this.model.get("appModel").get("user"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.renderFeaturesCard(),n.trigger("page:ready",this)},renderFeaturesCard:function(){amdModules.requireDeferred("gs/views/cards/newFeatures.js").done(_.bind(function(){if(this.childViews.newFeaturesCard&&!this.childViews.newFeaturesCard.destroyed)return;this.childViews.newFeaturesCard=new n.Views.Cards.NewFeatures({user:this.user,el:this.ui.$featuresCard}),this.childViews.newFeaturesCard.render()},this))}},{})}),define("gs/views/pages/upgrade.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{},n.Views.Pages.Upgrade=n.Views.Pages.Base.extend({templatePath:"upgrade",templateFile:"index",pageType:"upgrade",ui:{upgradeCard:"#upgrade-card-container"},initialize:function(e){this.user=this.model.get("appModel").get("user"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=new ChainLoading;e.push(this.fetchTemplate(this.templateFile)).always(e.storeArgs),e.push(this.user.loadSubscription()).done(e.storeArgs).done(_.bind(function(t){if(t.hasSubscription()){n.router.setHash("settings/subscription");return}e.push(t.loadSpecialPricing()).done(e.applyArgs(this.onTemplate,this))},this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.renderUpgradeCard(),n.trigger("page:ready",this)},renderUpgradeCard:function(){amdModules.requireDeferred("gs/views/cards/upgrade.js").done(_.bind(function(){if(this.childViews.upgradeCard&&!this.childViews.upgradeCard.destroyed)return;this.childViews.upgradeCard=new n.Views.Cards.Upgrade({user:this.user,el:this.ui.$upgradeCard}),this.childViews.upgradeCard.render()},this))}},{})}),function(){n.Views=n.Views||{},n.Views.Highchart=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"highchart",ui:{dateDropdown:".date-dropdown",dateDropdownLabel:"@dateDropdown .label",chart:".chart"},events:{"click @dateDropdown":"getFilterMenu"},initialize:function(e){this.model=new Backbone.Model({days:30,artist:e.artist,user:e.user}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=this.model.get("artist"),t=this.model.get("user").get("artistsOwned");e.getDailyStats(t).always(_.bind(function(e){this.model.set("stats",e),this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:days",this.renderDateDropdown),this.listenTo(this.model,"change:stats",this.renderGraph),this.listenTo(this.model,"change:days",this.updateStats),this.renderDateDropdown(),this.renderGraph()},renderDateDropdown:function(){var e=this.model.get("days"),t={7:"LAST_7_DAYS",14:"LAST_14_DAYS",30:"LAST_30_DAYS",60:"LAST_60_DAYS"};e?this.ui.$dateDropdownLabel.text(_.getString(t[e])).data("translateText",t[e]):this.ui.$dateDropdownLabel.text("2012 - "+(new Date).getFullYear()).removeData("translateText")},renderGraph:function(){var e=this.model.get("stats"),t=this.model.get("days");!this.childViews.graph||this.childViews.graph.destroyed?(this.childViews.graph=new n.Views.AnalyticsGraph({el:this.ui.$chart.empty(),stats:e.dailyStats,days:t}),this.childViews.graph.render()):this.childViews.graph.model.set({stats:e.dailyStats,days:t})},updateStats:function(){var e=this.model.get("stats"),t=this.model.get("days"),n=this.model.get("user"),r=this.model.get("artist");r.getDailyStats(n.get("artistsOwned"),t).done(_.bind(function(e){this.model.set("stats",e)},this))},getFilterMenu:function(e){var t=this.ui.$dateDropdown.outerWidth(),r=[{localeKey:"LAST_7_DAYS",click:_.bind(this.model.set,this.model,"days",7)},{localeKey:"LAST_14_DAYS",click:_.bind(this.model.set,this.model,"days",14)},{localeKey:"LAST_30_DAYS",click:_.bind(this.model.set,this.model,"days",30)},{localeKey:"LAST_60_DAYS",click:_.bind(this.model.set,this.model,"days",60)},{title:"2012 - "+(new Date).getFullYear(),click:_.bind(this.model.set,this.model,"days",0)}],i={tooltipKey:"filter-menu",tooltipClass:"filter-menu",width:t,$attached:this.ui.$dateDropdown,items:r};if(this.filterMenu&&this.filterMenu.dfd&&this.filterMenu.dfd.state()==="pending"){this.filterMenu.closeTooltip();return}amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;this.filterMenu=n.Views.Tooltips.Menu.openTooltip(i),this.ui.$dateDropdown.addClass("active"),this.filterMenu.dfd.always(_.bind(function(){this.ui.$dateDropdown.removeClass("active")},this))},this))}})}(),function(){n.Views=n.Views||{},n.Views.TopSongs=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"digest",ui:{metricDropdown:".metric-dropdown",metricDropdownLabel:"@metricDropdown .label",subheader:".description",grid:".grid"},events:{"click @metricDropdown":"getFilterMenu"},initialize:function(e){this.model=new Backbone.Model({metric:"Streams",stats:null,artist:e.artist,showAll:!1}),this.topSongs=new n.Models.Collections.Songs,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=this.model.get("artist");e.getDailySongsStats().done(_.bind(function(e){this.model.set("stats",e),this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{titleLocale:"POPULAR_SONGS_DIGEST_DASHBOARD"})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:metric",this.renderMetricDropdown),this.listenTo(this.model,"change:metric",this.updateTopSongs),this.listenTo(this.model,"change:showAll",this.updateTopSongs),this.updateTopSongs(),this.renderMetricDropdown(),this.renderGrid()},renderMetricDropdown:function(){var e=this.model.get("metric");e==="Streams"?this.ui.$metricDropdownLabel.text(_.getString("PLAYS")).data("translateText","PLAYS"):this.ui.$metricDropdownLabel.text(_.getString("FAVORITES")).data("translateText","FAVORITES")},renderGrid:function(){var e=this.model.get("artist");if(this.childViews.grid&&!this.childViews.grid.destroyed)return;this.childViews.grid=new n.Views.AnalyticsDigestSongsGrid({el:this.ui.$grid.empty(),collection:this.topSongs,playContext:new n.Models.PlayContext(e)}),this.childViews.grid.render()},updateTopSongs:function(){var e=this.model.get("metric"),t=this.model.get("artist"),n=t.get("songs"),r=this.model.get("stats"),i=this.model.get("showAll")?51:10,s=[];r.sort(function(t,n){return _.toInt(n[e])-_.toInt(t[e])}),_.each(_.take(r,i),function(t){var r=n.get(t.songID),i=t[e];r&&i>0&&(r.set("statsForDashboardColumns",i,{silent:!0}),s.push(r))}),this.topSongs.reset(s)},getFilterMenu:function(e){if(this.filterMenu&&this.filterMenu.dfd&&this.filterMenu.dfd.state()==="pending"){this.filterMenu.closeTooltip();return}var t=this.ui.$metricDropdown,r=t,i=[{localeKey:"PLAYS",click:_.bind(function(){this.model.set("metric","Streams"),n.trigger("guts:log","artistDashboardChangeDigestMetric",{toMetric:"Streams",digestType:"popularSongs"})},this)},{localeKey:"FAVORITES",click:_.bind(function(){this.model.set("metric","Favorites"),n.trigger("guts:log","artistDashboardChangeDigestMetric",{toMetric:"Favorites",digestType:"popularSongs"})},this)}];this.filterTooltipOptions={tooltipKey:"filter-menu",tooltipClass:"filter-menu",width:t.outerWidth(),$attached:r,items:i},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;this.filterMenu=n.Views.Tooltips.Menu.openTooltip(this.filterTooltipOptions),r.addClass("active"),this.filterMenu.dfd.always(function(){r.removeClass("active")})},this))}})}(),function(){n.Views=n.Views||{},n.Views.TopFans=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"digest",ui:{metricDropdown:".metric-dropdown",metricDropdownLabel:"@metricDropdown .label",subheader:".description",grid:".grid"},events:{"click @metricDropdown":"getFilterMenu"},initialize:function(e){this.model=new Backbone.Model({metric:"Streams",stats:null,artist:e.artist}),this.topFans=new n.Models.Collections.Users,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=this.model.get("artist");e.getWeeklyTopStats().always(_.bind(function(e){this.model.set("stats",e),this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{titleLocale:"BIGGEST_FANS_DIGEST_DASHBOARD"})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:metric",this.renderMetricDropdown),this.listenTo(this.model,"change:metric",this.updateTopFans),this.updateTopFans(),this.renderMetricDropdown(),this.renderGrid()},renderMetricDropdown:function(){var e=this.model.get("metric");e==="Streams"?this.ui.$metricDropdownLabel.text(_.getString("PLAYS")).data("translateText","PLAYS"):this.ui.$metricDropdownLabel.text(_.getString("FAVORITES")).data("translateText","FAVORITES")},renderGrid:function(){if(this.childViews.grid&&!this.childViews.grid.destroyed)return;this.childViews.grid=new n.Views.AnalyticsDigestFansGrid({el:this.ui.$grid.empty(),collection:this.topFans}),this.childViews.grid.render()},updateTopFans:function(){var e=this.model.get("metric"),t=this.model.previous("metric"),r=this.model.get("stats"),i=["Streams","Favorites"],s=_.indexOf(i,e),o=[],u,a,f,l,c,h,p;if(s<0)return;if(!r||!r[s]){a=!1;if(r){u=_.indexOf(i,t);if(r[u])s=u,a=!0;else for(f=0,l=i.length;f<l;f++)if(r[f]){s=f,a=!0;break}}if(!a)return}c=_.toArray(r[s]),c.sort(function(e,t){return _.toInt(e.Rank)-_.toInt(t.Rank)});for(f=0,l=c.length;f<l;f++)p=c[f],p.UserID&&(h=n.Models.User.getCached(p.UserID),h||(h=n.Models.User.newOrUpdate({UserID:_.toInt(p.UserID),FName:p.UserName,Picture:p.UserPicture})),h.set("statsForDashboardColumns",_.toInt(p[e]),{silent:!0}),o.push(h));this.topFans.reset(o)},getFilterMenu:function(e){if(this.filterMenu&&this.filterMenu.dfd&&this.filterMenu.dfd.state()==="pending"){this.filterMenu.closeTooltip();return}var t=$(e.currentTarget),r=t,i=[{localeKey:"PLAYS",click:_.bind(function(){this.model.set("metric","Streams"),n.trigger("guts:log","artistDashboardChangeDigestMetric",{toMetric:"Streams",digestType:"topFans"})},this)},{localeKey:"FAVORITES",click:_.bind(function(){this.model.set("metric","Favorites"),n.trigger("guts:log","artistDashboardChangeDigestMetric",{toMetric:"Favorites",digestType:"topFans"})},this)}];this.filterTooltipOptions={tooltipKey:"filter-menu",tooltipClass:"filter-menu",width:t.outerWidth(),$attached:r,items:i},amdModules.requireDeferred("gs/views/tooltips/menu.js").done(_.bind(function(){if(this.destroyed)return;this.filterMenu=n.Views.Tooltips.Menu.openTooltip(this.filterTooltipOptions),r.addClass("active"),this.filterMenu.dfd.always(function(){r.removeClass("active")})},this))}})}(),function(){n.Views=n.Views||{},n.Views.Statistics=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"statistics",ui:{highchart:".highchart",topSongs:".top-songs",topFans:".top-fans",showMoreBtn:".show-more",showMoreLabel:"@showMoreBtn .label",showMoreIcon:"@showMoreBtn .icon"},events:{"click @showMoreBtn":"clickShowMore"},initialize:function(e){this.model=new Backbone.Model({user:e.user,artist:e.artist}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=new ChainLoading,t=this.model.get("user"),n=this.model.get("artist");e.push(n.getAllAlbums()),e.push(n.getSongs()),e.push(t.getOwnedArtists().done(e.bind(function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},this)).fail(e.bind(this.pageLoadFailed,this)))},onTemplate:function(e){var t=this.model.get("user"),r=this.model.get("artist"),i=r.get("ArtistID");if(this.destroyed)return;if(!n.isLoggedInUserOwnerOfArtist(i)){n.router.replaceHash(n.Models.Artist.getArtistUrl(i,null));return}if(!r){this.pageLoadFailed();return}this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.childViews.highchart=new n.Views.Highchart({el:this.ui.$highchart,artist:r,user:t}),this.childViews.highchart.render(),this.childViews.topSongs=new n.Views.TopSongs({el:this.ui.$topSongs,artist:r}),this.childViews.topSongs.render(),this.childViews.topFans=new n.Views.TopFans({el:this.ui.$topFans,artist:r}),this.childViews.topFans.render(),this.stopListening(),this.listenTo(this.childViews.topSongs.model,"change:showAll",this.renderShowMoreBtn),this.renderShowMoreBtn()},renderShowMoreBtn:function(){var e=this.childViews.topSongs.model.get("showAll");e?(this.ui.$showMoreLabel.data("translateText","SHOW_FEWER").text(_.getString("SHOW_FEWER")),this.ui.$showMoreIcon.removeClass("icon-caretdown").addClass("icon-caretup")):(this.ui.$showMoreLabel.data("translateText","SHOW_MORE").text(_.getString("SHOW_MORE")),this.ui.$showMoreIcon.removeClass("icon-caretup").addClass("icon-caretdown"))},clickShowMore:function(e){var t=this.childViews.topSongs.model.get("showAll");this.childViews.topSongs.model.set("showAll",!t)}})}(),define("artistAnalyticsPage",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{},n.Views.Pages.Artistanalytics=n.Views.Pages.Base.extend({templatePath:"artistAnalytics",templateFile:"index",pageType:"artistAnalytics",ui:{subpage:".subpage-container",navLinks:".nav-link"},initialize:function(e){this.model=new Backbone.Model({section:_.orEqual(e.params.section,"statistics")}),this.user=e.model.get("appModel").get("user"),this.artist=e.params.profile.get("artist"),n.Views.Pages.Base.prototype.initialize.call(this,e)},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{artist:this.artist})),this.bindUIElements(),this.listenTo(this.model,"change:section",this.renderSection),this.renderSection(),n.trigger("page:ready",this)},renderSection:function(){var e=this.model.get("section"),t={el:this.$el.find(".helper.card"),page:"analytics",subpage:e},r;this.ui.$navLinks.removeClass("selected"),this.ui.$navLinks.filter('[data-section="'+e+'"]').addClass("selected");switch(e){case"traffic":r=new n.Views.Traffic({artist:this.artist}),t.locale="HELPER_DASHBOARD_TRAFFIC";break;case"statistics":r=new n.Views.Statistics({user:this.user,artist:this.artist}),t.locale="HELPER_DASHBOARD_STATS"}this.childViews.region?this.childViews.region.show(r):(this.childViews.region=new n.Views.Region({el:this.ui.$subpage,view:r}),this.childViews.region.render()),this.childViews.helperCard?this.childViews.helperCard.model.set(_.defaults(t,{html:"",htmlId:""})):(this.childViews.helperCard=new n.Views.Cards.HelperCard(t),this.childViews.helperCard.render())},updatePageParams:function(e){this.model.set("section",_.orEqual(e.section,"statistics"))}})}),function(){n.Views=n.Views||{},n.Views.Traffic=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"traffic",ui:{platforms:".platforms",social:".social"},initialize:function(e){this.artist=e.artist,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.childViews.platformTraffic=new n.Views.PlatformTraffic({el:this.ui.$platforms,artist:this.artist}),this.childViews.platformTraffic.render(),this.childViews.socialTraffic=new n.Views.SocialTraffic({el:this.ui.$social,artist:this.artist}),this.childViews.socialTraffic.render()}})}(),function(){n.Views=n.Views||{},n.Views.SocialTraffic=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"trafficSection",ui:{grid:".grid",chart:".chart"},initialize:function(e){this.artist=e.artist,this.model=new Backbone.Model({stats:null}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDestroy:function(){this.chart&&(this.chart.destroy(),this.chart=null)},render:function(){var e=new ChainLoading;e.push(this.artist.getTrafficStats().done(e.bind(function(e){this.model.set("stats",new Backbone.Collection(e.social))},this))),e.push(this.fetchTemplate(this.templateFile).always(e.bind(this.onTemplate,this)))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{titleLocale:"SOCIAL_SHARES"})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:stats",this.renderGrid),this.listenTo(this.model,"change:stats",this.renderChart),this.renderGrid(),this.renderChart()},renderGrid:function(){var e=this.model.get("stats"),t=new Backbone.Collection(e.map(function(e){return{title:e.get("name"),statistic:_.getStringPluralized("ONE_SHARE","COUNT_SHARES",e.get("shares"),{count:_.addCommaSeparators(e.get("shares"))})}}));this.childViews.grid=new n.Views.StatisticsGrid({el:this.ui.$grid.empty(),collection:t}),this.childViews.grid.render()},renderChart:function(){var e=this.model.get("stats");this.childViews.chart=new n.Views.Doughnut({el:this.ui.$chart,collection:e,labelKey:"name",valueKey:"shares",colors:{Facebook:"#3b5b99",Twitter:"#00acee","Google+":"#dd4c39",Reddit:"#ff4500","Custom Widgets":"#cc61de",URL:"#46be9c"}}),this.childViews.chart.render()}})}(),function(){n.Views=n.Views||{},n.Views.PlatformTraffic=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"trafficSection",ui:{grid:".grid",chart:".chart"},initialize:function(e){this.artist=e.artist,this.model=new Backbone.Model({stats:null}),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDestroy:function(){this.chart&&(this.chart.destroy(),this.chart=null)},render:function(){var e=new ChainLoading;e.push(this.artist.getTrafficStats().done(e.bind(function(e){this.model.set("stats",new Backbone.Collection(e.platforms))},this))),e.push(this.fetchTemplate(this.templateFile).always(e.bind(this.onTemplate,this)))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{titleLocale:"TOP_PLATFORMS_AND_DEVICES"})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change:stats",this.renderGrid),this.listenTo(this.model,"change:stats",this.renderChart),this.renderGrid(),this.renderChart()},renderGrid:function(){var e=this.model.get("stats"),t=new Backbone.Collection(e.map(function(e){return{title:e.get("platform"),statistic:_.getStringPluralized("ONE_PLAY","NUM_PLAYS",e.get("plays"),{num:_.addCommaSeparators(e.get("plays"))})}}));this.childViews.grid=new n.Views.StatisticsGrid({el:this.ui.$grid.empty(),collection:t}),this.childViews.grid.render()},renderChart:function(){var e=this.model.get("stats");this.childViews.chart=new n.Views.Doughnut({el:this.ui.$chart,collection:e,labelKey:"platform",valueKey:"plays"}),this.childViews.chart.render()}})}(),define("gs/views/pages/artistAnalytics/analyticsGraph.js",function(){function e(e,t){var n=new Date,r=[],i,s;n.setDate(n.getDate()-t);for(s=0;s<e;s++)i=n.getFullYear()+"-"+_.padLeft(n.getMonth()+1,2,"0")+"-"+_.padLeft(n.getDate(),2,"0"),r.push(i),n.setDate(n.getDate()-1);return r}n.Views=n.Views||{},n.Views.AnalyticsGraph=Backbone.View.extend({templatePath:"shared",templateFile:"analyticsGraph",ui:{chart:".chart-container",statBoxes:".stats .stat",selector:".selector",selectorLabel:".selector-container .label",empty:".no-graph"},events:{"click @statBoxes":"onStatBoxClick","change @selector":"changeSelector"},initialize:function(e){return this.model=new Backbone.Model({stats:e.stats,metric:"Streams",days:e.days}),Backbone.View.prototype.initialize.call(this,e)},onDestroy:function(){this.chart&&(this.chart.destroy(),this.chart=null)},render:function(){var e=new ChainLoading;e.push(amdModules.requireDeferred("gs/resources/Chart.min.js")),e.push(this.fetchTemplate(this.templateFile).done(e.bind(this.onTemplate,this)))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.stopListening(),this.listenTo(this.model,"change",this.renderGraph),this.listenTo(this.model,"change",this.renderStatBoxes),this.listenTo(this.model,"change:metric",this.renderSelector),this.renderGraph(),this.renderStatBoxes(),this.renderSelector()},renderGraph:function(){var t=this.model.get("stats"),n=this.model.get("metric"),r=this.model.get("days"),i=e(r+1,1),s=t.hasOwnProperty(i[0]),o=0,u=5,a,f,l,c,h,p,d,v;s?i.pop():i.shift(),i.reverse(),d=_.map(i,function(e){var t=e.split("-");return _.shortMonthsOfTheYear[_.toInt(t[1])-1]+" "+t[2]}),v=_.map(i,function(e){var r;return!t[e]||!t[e][n]?0:(r=_.toInt(t[e][n]),o=Math.max(o,r),r)});if(!t||!o)this.ui.$chart.addClass("hide"),this.ui.$empty.removeClass("hide");else if(!r)this.ui.$chart.addClass("hide"),this.ui.$empty.addClass("hide");else{a=document.createElement("canvas"),f=Math.floor(_.min(v)*.8),l=Math.ceil(_.max(v)*1.2),c=Math.ceil(l/u);switch(n){case"Streams":h="SONG_PLAY",p="SONG_PLAYS";break;case"UniqueListeners":h="LISTENER",p="LISTENERS";break;case"Favorites":h="FAVORITE",p="FAVORITES";break;case"LibraryAdds":h="COLLECTED",p="COLLECTED"}this.chart&&this.chart.destroy(),this.ui.$chart.removeClass("hide").html(a),this.ui.$empty.addClass("hide"),this.chart=(new Chart(a.getContext("2d"))).Line({labels:d,datasets:[{fillColor:"#c7ebe1",strokeColor:"#c7ebe1",pointColor:"#46be9c",pointStrokeColor:"#46be9c",pointHighlightFill:"#fff",pointHighlightStroke:"#46be9c",data:v}]},{responsive:!0,maintainAspectRatio:!1,bezierCurve:!1,datasetStroke:!1,pointDotRadius:6,pointDotStrokeWidth:1,pointHitDetectionRadius:3,datasetStrokeWidth:2,scaleOverride:!0,scaleStartValue:f,scaleStepWidth:c,tooltipTemplate:'<%= _.addCommaSeparators(value) %> <%= _.getStringPluralized("'+h+'", "'+p+'", value) %>  <%= label %>',scaleSteps:u})}},renderStatBoxes:function(){var e=this.ui.$statBoxes.filter('[data-metric="'+this.model.get("metric")+'"]'),t=this.model.get("days"),n=this.model.get("stats").Cumulative;this.ui.$statBoxes.removeClass("selected"),e.addClass("selected"),this.ui.$statBoxes.each(function(e,r){var i=$(r),s=i.find(".number"),o=i.data("metric"),u;o==="UniqueListeners"?o="Uniques":o==="LibraryAdds"&&(o="Libraries"),t?u=o+"_"+t:u=o+"_s2012",n?s.text(_.truncateNumber(_.toInt(n[u]))):s.text(0)})},renderSelector:function(){var e=this.model.get("metric");this.ui.$selector.val(e),this.ui.$selectorLabel.text(_.getString(this.ui.$selector.find(":selected").data("translateText")))},onStatBoxClick:function(e){var t=$(e.currentTarget).data("metric");this.model.set("metric",t),n.trigger("guts:log","artistProfileChangeGraph",{metric:t}),_.gaTrackEvent("artistProfile","changeGraphMetric",t)},changeSelector:function(e){var t=this.ui.$selector.val();this.model.set("metric",t),n.trigger("guts:log","artistProfileChangeGraph",{metric:t}),_.gaTrackEvent("artistProfile","changeGraphMetric",t)}})}()),function(){n.Views=n.Views||{},n.Views.Doughnut=Backbone.View.extend({templatePath:"artistAnalytics",templateFile:"doughnut",ui:{chart:".doughnut-chart",legend:".doughnut-legend"},initialize:function(e){this.collection=e.collection,this.model=new Backbone.Model({data:null}),this.valueKey=e.valueKey,this.labelKey=e.labelKey,this.maxItems=_.orEqual(e.maxItems,3),e.colors&&_.isObject(e.colors)?this.colors=_.defaults({},e.colors,{Other:"#45be9c"}):this.colors=["#45be9c","#6bcbb0","#90d8c4","#b5e5d7"]},onDestroy:function(){this.chart&&(this.chart.destroy(),this.chart=null)},render:function(){var e=new ChainLoading;e.push(amdModules.requireDeferred("gs/resources/Chart.min.js")),e.push(this.fetchTemplate(this.templateFile).always(e.bind(this.onTemplate,this)))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.bindUIElements(),this.updateData(),this.renderChart(),this.renderLegend(),this.stopListening(),this.listenTo(this.collection,"change",this.updateData),this.listenTo(this.model,"change:data",this.renderChart),this.listenTo(this.model,"change:data",this.renderLegend)},renderChart:function(){var e=this.model.get("data"),t=document.createElement("canvas"),n=t.getContext("2d"),r={responsive:!0,maintainAspectRatio:!1,segmentShowStroke:!1,animationEasing:"easeIn",animationSteps:45,percentageInnerCutout:35,tooltipTemplate:"<%= label %>: <%= _.addCommaSeparators(value) %>"};this.chart&&this.chart.destroy(),this.ui.$chart.html(t),this.chart=(new Chart(n)).Doughnut(e,r)},renderLegend:function(){var e=this.model.get("data"),t=_.map(e,function(e){return _.format('<div class="item"><div class="color" style="background: %s;"></div><div class="label">%s - %s%</div></div>',e.color,e.label,Math.round(e.percent*100))});this.ui.$legend.html(t.join(""))},updateData:function(){var e=this.collection.toJSON(),t=_.map(e,_.bind(function(e){return{label:e[this.labelKey],value:e[this.valueKey]}},this)),n=_.reduce(t,function(e,t){return e+t.value},0),r=_.sortBy(t,"value").reverse(),i,s;r.length>this.maxItems&&(s=_.reduce(_.drop(r,this.maxItems),function(e,t){return e+t.value},0),r=_.take(r,this.maxItems).concat({label:"Other",value:s}),r=_.sortBy(r,"value").reverse()),i=_.map(r,_.bind(function(e,t){var r;return _.isArray(this.colors)?r=this.colors[t]:r=this.colors[e.label],{label:e.label,value:e.value,percent:e.value/n,color:r,highlight:_.lighten(r,.3)}},this)),this.model.set("data",i)}})}(),define("gs/views/pages/notFound.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{},n.Views.Pages.Notfound=n.Views.Pages.Base.extend({templatePath:"notFound",templateFile:"index",pageType:"notFound",render:function(){this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{}))}})}),define("gs/views/lightboxes/generic.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Lightboxes.Generic=n.Views.Lightboxes.Base.extend({initialize:function(e){this._super("initialize",e),this.view=e.params.view},onDestroy:function(){this.$el.off("click.generic"),this.options.params&&_.isFunction(this.options.params.onDestroy)&&this.options.params.onDestroy.call(this)},render:function(){this._super("render"),this.fetchTemplate("generic").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.suspended||this.destroyed)return;var t=this.options.params,r=_.orEqual(this.view.buttonsLeft,[]),i=_.orEqual(this.view.buttonsRight,[]),s=r.concat(i);s=_.map(s,function(e){return{href:e.href,btnClass:(e.className||"")+" "+(e.disabled||""),text:e.label,data:e.data?{property:e.data.label,val:e.data.value}:null}}),this.$el.html(this.renderTemplate(e,{type:this._type||t&&t.type,view:this.view,buttons:s}));var o=this.$el;_.forEach(this.options.params.callbacks,function(e,t){o.on("click.generic",t,e)}),this._super("onTemplate"),n.trigger("lightbox:rendered")}})}),define("gs/views/lightboxes/locale.js",function(){function t(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1}n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{};var e=[{locale:"ca",name:"Catal"},{locale:"cs",name:"etina"},{locale:"hr",name:"hrvatski"},{locale:"cy",name:"Cymraeg"},{locale:"da",name:"Dansk"},{locale:"de",name:"Deutsch"},{locale:"el",name:""},{locale:"en",name:"English"},{locale:"es",name:"Espaol"},{locale:"et",name:"Eesti"},{locale:"eu",name:"Euskara"},{locale:"fr",name:"Franais"},{locale:"gl",name:"Galego"},{locale:"hu",name:"magyar"},{locale:"ko",name:""},{locale:"nl",name:"Nederlands"},{locale:"lv",name:"Latvijas"},{locale:"lt",name:"Lietuvi"},{locale:"pl",name:"Polski"},{locale:"pt",name:"Portugus"},{locale:"ru",name:""},{locale:"sk",name:"Slovenina"},{locale:"fi",name:"Suomi"},{locale:"sv",name:"Svenska"},{locale:"tr",name:"Trke"},{locale:"uk",name:"Y"},{locale:"zh",name:""},{locale:"bg",name:""},{locale:"it",name:"Italiano"},{locale:"ja",name:""},{locale:"nb",name:"Norsk "},{locale:"ro",name:"Romn"},{locale:"sl",name:"Slovenina"}];n.Views.Lightboxes.Locale=n.Views.Lightboxes.Base.extend({events:{"click a.language":"onLanguageClick"},initialize:function(){this._super("initialize"),this.model.set("languages",e.sort(t))},render:function(){this._super("render"),this.fetchTemplate("locale").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.suspended||this.destroyed)return;this.$el.html(this.renderTemplate(e)),this._super("onTemplate"),n.trigger("lightbox:rendered")},onLanguageClick:function(e){var t=e.currentTarget,r=$(t).attr("rel");n.trigger("locale:change",r,{userSet:!0}),n.trigger("guts:log","localeChangePerformed",{newLocale:r,navigatorLanguage:navigator.language,browserLanguage:gsConfig.lang}),n.trigger("guts:endcontext","locale"),n.trigger("guts:begincontext",{locale:r}),_.gaTrackEvent("site","localeChangePerformed",r),this.close()}})}),define("gs/views/lightboxes/forget.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{};var e=5,t=32;n.Views.Lightboxes.Forget=n.Views.Lightboxes.Base.extend({events:{"click .login":"onLoginClick","click .submit":"onSubmitClick","submit form":"onFormSubmit"},initialize:function(){this._super("initialize"),this.model.set({reset:this.options.params.hasOwnProperty("resetCode"),canClose:this.options.params.canClose,user:this.options.params.user})},render:function(){this._super("render"),this.fetchTemplate("forget").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.suspended||this.destroyed)return;var t=this.model.get("user"),r={reset:this.model.get("reset"),canClose:this.model.get("canClose"),email:t&&t.escape("Email")||""};this.$el.html(this.renderTemplate(e,r)),this._super("onTemplate"),n.trigger("lightbox:rendered")},showError:function(e){this.$el.find(".error-text").text(e),this.$el.find(".error").removeClass("hide")},onLoginClick:function(e){this.close(),n.trigger("lightbox:open","login",{premiumRequired:this.options.params.premiumRequired,canClose:!this.options.params.premiumRequired})},onSubmitClick:function(e){$("#lightbox-forget-form").submit()},onFormSubmit:function(r){r.preventDefault();var i=$("#forget-username").val(),s,o;return this.model.get("reset")?(s=$("#forget-new-password").val(),o=$("#forget-confirm-password").val(),s==o&&s.length&&s.length>=e&&s.length<=t?n.Services.API.resetPassword(i,this.options.params.resetCode,s).done(_.bind(this.resetSuccess,this,i,s)).fail(_.bind(this.resetFailed,this)):this.showError(_.getString("POPUP_SIGNUP_FORM_PASSWORD_INVALID_NO_MATCH"))):n.Services.API.userForgotPassword(i).done(_.bind(this.serviceSuccess,this)).fail(_.bind(this.serviceFailed,this)),!1},serviceSuccess:function(e){if(!e||e&&e.userID==0)return this.serviceFailed(e);this.close(),n.trigger("notification:add",{title:_.getString("LB_RESET_PASSWORD_SUCCESS"),icon:"gear",type:"success"})},serviceFailed:function(e){this.showError(_.getString("POPUP_SIGNUP_FORGOT_FORM_RESPONSE_ERROR"))},resetSuccess:function(e,t,n){if(!n||n.success!=1)return this.resetFailed(n);this.model.get("appModel").login("normal",e,t),this.close()},resetFailed:function(e){_.defined(e.success)?e.success==0?this.showError(_.getString("LB_FORGET_RESET_ERROR_BADUSER")):this.showError(_.getString("LB_FORGET_RESET_ERROR_BADCODE")):this.showError(_.getString("LB_FORGET_RESET_ERROR_UNKNOWN"))},close:function(){this._super("close"),this.options.params.premiumRequired&&n.trigger("lightbox:open","login",{premiumRequired:this.options.params.premiumRequired,canClose:!this.options.params.premiumRequired})}})}),define("gs/views/lightboxes/viewContainer.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Lightboxes.ViewContainer=n.Views.Lightboxes.Base.extend({templateFile:"viewContainer",ui:{container:".container"},initialize:function(e){this.view=e.params.view,this.tooltipOwner=e.params.tooltipOwner,n.Views.Lightboxes.Base.prototype.initialize.call(this,e)},onDestroy:function(){this.view.destroy(!0),this.tooltipOwner&&!this.closed&&(this.closed=!0,this.tooltipOwner.close())},render:function(){n.Views.Lightboxes.Base.prototype.render.call(this),this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){!this.suspended&&!this.destroyed&&(this.$el.html(this.renderTemplate(e)),this.bindUIElements(),this.view.render(),this.ui.$container.html(this.view.el),n.Views.Lightboxes.Base.prototype.onTemplate.call(this,e),n.trigger("lightbox:rendered"))}})}),define("gs/views/tooltip.js",function(){n.Views=n.Views||{},n.Views.Tooltips=n.Views.Tooltips||{},n.Views.Tooltip=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-container",initialize:function(e){return this.tooltips={},this.model.set("tooltipOptionsCache",{}),n.on("tooltip:open",_.bind(this.open,this)),n.on("tooltip:close",_.bind(this.close,this)),n.on("tooltip:hide",_.bind(this.hide,this)),n.on("tooltip:show",_.bind(this.show,this)),n.getAppMode()==="desktop"&&n.on("router:change",_.bind(function(){this.close(null,"routerChange")},this)),n.getAppMode()==="desktop"&&($(document).on("mouseenter.tooltips","*",_.bind(this.onMouseEvent,this)),$(document).on("click.tooltips","*",_.bind(this.onMouseEvent,this))),Backbone.View.prototype.initialize.call(this,e)},open:function(e){var t=e.tooltipKey,r=n.getAppMode()!=="desktop",i;return t&&this.tooltips[t]?this.tooltips[t].dfd:(t||(e.tooltipKey=Date.now(),t=e.tooltipKey),r&&!e.noMobile&&(e.isMobile=!0),e.tooltip?(i=e.tooltip,e=e.tooltip.options,i.tooltipKey=t):(i=new n.Views.ManagedTooltip(e,{clone:!1}),e.tooltip=i),e.dfd=i.dfd,i.options.closeOthers&&this.close(),this.tooltips[t]=i,e.startHidden&&i.hide(),i.options.delay&&!r?(i.lastTimeout=setTimeout(_.bind(function(e){e.render()},this,i),i.options.delay),!i.options.persist&&!i.options.sticky&&i.options.$attached.on("mouseleave.tooltips",_.bind(function(){clearTimeout(i.lastTimeout),this.close(t)},this))):i.render(),e.startHidden||this.show(t),i.dfd)},close:function(e,t){_.each(this.tooltips,_.bind(function(n,r){if(!n||e&&r!=e||!e&&n.options.persist||t=="routerChange"&&n.options.persistOnRouterChange)return;if(_.isFunction(n.beforeClose)&&n.beforeClose(e,t)===!1)return;this.hide(r),n.destroy(),n.dfd&&n.dfd.state()!="resolved"&&n.dfd.resolve(),delete this.tooltips[r]},this)),n.trigger("tooltip:closed")},hide:function(e){if(!e)return;var t=this.tooltips[e];if(!t||!t.isOpen)return;t.hide()},show:function(e){if(!e)return;var t=this.tooltips[e];if(!t||t.isOpen)return;t.show()},onMouseEvent:function(e){_.each(this.tooltips,_.bind(function(t,n){if(!t||t.options.persist||t.options.sticky&&e.type=="mouseenter")return;var r=t.options.$attached,i=t.options.$alternateTriggers||[],s=e.target===r[0],o=t.options.sensitivity,u=t.options.hideDelay,a=[],f=$(e.target).parents(),l=t.options&&t.options.views||[],c;t.options.contextMenu||a.push(r[0]),o!=="mouseout"&&(s=s||e.target===t.$el[0],a.push(t.$el[0])),_.each(i,function(e){a.push(e)}),_.each(l,_.bind(function(e){e.subMenuOptions&&e.subMenuOptions.tooltipKey&&(c=this.tooltips[e.subMenuOptions.tooltipKey],c&&a.push(c.$el[0]))},this));if(!s)for(var h=0,p=f.length;h<p;h++)if(_.indexOf(a,f[h])!=-1){s=!0;break}t.hideTimeout&&s?(clearTimeout(t.hideTimeout),t.hideTimeout=null):!t.hideTimeout&&!s&&!t.lastTimeout&&!t.options.sticky?t.hideTimeout=setTimeout(_.bind(this.close,this,n),u):!t.hideTimeout&&!s&&this.close(n)},this))}})}),define("gs/views/tooltips/managedTooltip.js",function(){n.Views.ManagedTooltip=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-container",hideTimeout:null,options:{sensitivity:"normal",hideDelay:300,sticky:!1,persist:!1,metadata:null,views:null,delay:0,zIndex:12999,width:320,scrollable:$("body"),positionDir:"bottom",positionSpill:"center",positionPad:3,autoCorrectOffset:!0,tooltipClass:"",destroyViewOnClose:!0,closeOthers:!0,fixed:!1,closeOnScroll:!1,isMobile:!1,pointerEvents:"auto"},initialize:function(e){var t=e.dfd;t||(t=$.Deferred(),e.dfd=t),this.dfd=t,this.options.metadata=[];var r=_.defaults(e,this.options);return this.listenTo(n,"lightbox:ready",function(e){e.currentLightbox._type==="viewContainer"&&e.$el.addClass("slide-in")}),this.listenTo(n,"lightbox:destroyed",function(e){e.currentLightbox._type==="viewContainer"&&e.$el.removeClass("slide-in")}),this.$contents=this.$el,this.$container=$(document.createElement("div")).append(this.$contents),this.$container.addClass("tooltip-container"),this.uniqueClass="gs-tooltip"+Math.floor(Math.random()*1e7),this.tooltipKey=this.options.tooltipKey,r.$attached||(console.log("Tooltip not attached to anything, attaching to body",r),r.$attached=$(document.body)),r.$menuOpenEl||(r.$menuOpenEl=r.$attached),r.contextMenu&&(r.contextMenuX=r.ev.pageX,r.contextMenuY=r.ev.pageY,r.$attached=$(document.body)),this.options=r,Backbone.View.prototype.initialize.call(this,e)},render:function(){if(!this.options||this.destroyed)return;if(this.options.isMobile){this.onRendered();return}var e=[],t=[];this.lastTimeout=null,this.options.$attached.off("mouseleave.tooltips"),this.$el.attr("class","tooltip gs-tooltip "+(this.options.tooltipClass||"")+" "+this.uniqueClass);if(this.options.views){var r,i;for(var s=0,o=this.options.views.length;s<o;s++){i=this.options.views[s],e.push(i.$el[0]),r=i.render(this);if(!this.options)return;if(!r||!r.done){console.log("No dfd for tooltip view",this,i);continue}t.push(r)}}else this.renderDfd||(this.renderDfd=$.Deferred()),t.push(this.renderDfd);var u=_.bind(function(){e.length&&this.$contents.empty().append(e),this.onRendered()},this);this.dfd&&this.dfd.notify("loading",this,t),t.length?$.after(t).done(u).fail(function(){n.trigger("tooltip:close")}):u()},onRendered:function(){if(this.destroyed)return;this.hideTimeout=null,this.options.isMobile||this.options.$menuOpenEl.addClass("menu-open"),this.options.$activeEl&&this.options.$activeEl.addClass("active");if(this.options.isMobile){this.dfd&&this.dfd.notify("rendered",this),this.trigger("rendered");return}$.browser.mozilla&&_.toInt($.browser.version)<6?$("#theme_home").find(".flash object").each(function(e,t){t.style.visibility="hidden"}):$("#theme_home").find(".flash object").hide(),this.options.scrollable||(this.options.scrollable=_.getScrollableParent(this.options.$attached)),this.attachedToDOM||(this.options.scrollable[0]===document&&(this.options.scrollable=$(document.body)),this.options.scrollable.append(this.$container[0]),this.attachedToDOM=!0);var e={},t=this.options.fixed?"fixed":"absolute",n=this.$container.find(".sub-menu");this.options.width?e.width=this.options.width:e.maxWidth=this.options.maxWidth,this.options.minHeight&&(e.minHeight=this.options.minHeight),this.options.scrollable||(n.length?n.on("DOMMouseScroll mousewheel",_.preventDocumentScroll):this.$container.on("DOMMouseScroll mousewheel",_.preventDocumentScroll)),this.$container.css({position:t,top:0,left:0}),this.$contents.css(e),this.calculateOffset(),this.$container.show(),this.dfd&&this.dfd.notify("rendered",this),this.trigger("rendered")},onDestroy:function(){if(this.options.views)for(var e=0,t=this.options.views.length;e<t;e++)this.options.views[e].destroy(this.options.destroyViewOnClose);this.$container.remove(),clearTimeout(this.hideTimeout),clearTimeout(this.lastTimeout),this.hideTimeout=null,this.lastTimeout=null,this.dfd&&this.dfd.resolve()},getScrollableVal:function(e,t){var n;return t?n=t[e]():this.options.scrollable[0]===document.body?n=$(document)[e]():n=this.options.scrollable[e](),n},getIsInFixedPositionParent:function(t){while(t[0]&&t[0]!==document.body&&t[0]!==e){if(t.css("position")==="fixed")return t;t=t.parent()}return!1},calculateOffset:function(){var e=this.options;if(e.contextMenu){this.calculateContextMenu();return}if(!e.$attached||!e.$attached.length)return;var t=e.positionDir||"bottom",n=e.positionSpill||"center",r=e.positionPad,i=e.$attached.offset(),s={width:e.$attached.outerWidth(),height:e.$attached.outerHeight(),top:i.top,left:i.left},o={width:this.$contents.outerWidth(!0),height:this.$contents.outerHeight(!0),zIndex:e.zIndex,pointerEvents:e.pointerEvents},u=e.fixed===1||e.fixed===!0,a=this.getIsInFixedPositionParent(e.$attached),f=s.top,l=s.left,c,h,p;e.scrollable[0]!==document.body&&(s.top+=this.getScrollableVal("scrollTop"),s.left+=this.getScrollableVal("scrollLeft"),a&&(c=a.offset(),s.top-=c.top,s.left-=c.left,a[0]!==e.scrollable[0]&&(h=e.scrollable.offset(),s.top+=c.top-h.top,s.left+=c.left-h.left)),f=s.top,l=s.left);switch(t){case"up":f-=o.height+r,p="vert";break;case"right":l+=s.width+r,p="horiz";break;case"bottom":f+=s.height+r,p="vert";break;case"left":l-=o.width+r,p="horiz"}if(p==="horiz")switch(n){case"up":f-=o.height-s.height;break;case"center":case"middle":f-=(o.height-s.height)/2}else if(p==="vert")switch(n){case"left":l-=o.width-s.width;break;case"center":case"middle":l-=(o.width-s.width)/2}u&&(l-=this.getScrollableVal("scrollLeft"),f-=this.getScrollableVal("scrollTop")),o.position=u?"fixed":"absolute",e.autoCorrectOffset?this.autoCorrectOffset(o,f,l,p,s):(delete o.height,this.setContainerCss(o,f,l,e))},autoCorrectOffset:function(t,n,r,i,s){var o=this.options,u=o.scrollable.is("body"),a=o.fixed===1,f=a?0:this.getScrollableVal("scrollLeft"),l=a?0:this.getScrollableVal("scrollTop"),c=o.positionPad,h,p,d={};u?(d.width=$(e).width(),d.height=$(e).height()):(d.width=o.scrollable.width(),d.height=o.scrollable.height()),o.isSubmenu&&(h=o.$attached.context.parentElement,p=$(h).offset());switch(i){case"horiz":n<0?n=0:n+t.height-l>d.height&&(n=d.height-t.height+l),r<0?r=s.left+s.width+c:r+t.width-f>d.width&&(o.isSubmenu&&(r=p.left),r=s.left-t.width-c);break;case"vert":r<0?r=0:r+t.width-f>d.width&&(r=d.width-t.width),n<0?n=s.top+s.height+c:n+t.height-l>d.height&&(n=s.top-t.height-c)}delete t.height,this.setContainerCss(t,n,r,o)},calculateContextMenu:function(){var t=this.options,n=t.contextMenuY,r=t.contextMenuX,i=this.$contents.outerHeight(!0),s=this.$contents.outerWidth(!0),o={width:$(e).width()+this.getScrollableVal("scrollLeft"),height:$(e).height()+this.getScrollableVal("scrollTop")};r+s>o.width&&(r=o.width-s),n+i>o.height&&(n-=i),this.setContainerCss({width:s,zIndex:t.zIndex,pointerEvents:t.pointerEvents},n,r,{})},setContainerCss:function(e,t,n,r){r.adjustX&&(n+=r.adjustX),r.adjustY&&(t+=r.adjustY),e.top=Math.round(t),e.left=Math.round(n),this.$container.css(e)},open:function(){n.trigger("tooltip:open",{tooltip:this,tooltipKey:this.tooltipKey||null})},close:function(){$("#lightbox-outer").removeClass("slide-in"),n.trigger("tooltip:close",this.tooltipKey),this.options.isMobile&&n.trigger("lightbox:close","viewContainer")},hide:function(){if(this.options.isMobile){n.trigger("lightbox:close","viewContainer"),this.isOpen=!1,this.trigger("hidden");return}this.$container.addClass("hide");if(this.options.views)for(var e=0,t=this.options.views.length;e<t;e++)this.options.views[e]&&_.isFunction(this.options.views[e].suspend)&&this.options.views[e].suspend();this.options.shouldHideAds&&showAds(),this.options.$attached&&this.options.$attached.off("mouseleave.tooltips"),this.options.scrollable&&this.options.scrollable.off("scroll.tooltips"),_.isNumber(this.lastTimeout)&&clearTimeout(this.lastTimeout),_.isNumber(this.hideTimeout)&&clearTimeout(this.hideTimeout),this.options.$menuOpenEl.hasClass("menu-open")&&this.options.$menuOpenEl.removeClass("menu-open"),this.options.$activeEl&&this.options.$activeEl.hasClass("active")&&this.options.$activeEl.removeClass("active"),this.isOpen=!1,this.trigger("hidden")},show:function(){var r=this.options.tooltipOwner;if(this.options.isMobile){r===t&&(r=this),n.trigger("lightbox:open","viewContainer",{view:this.options.views[0],tooltipOwner:r}),this.isOpen=!0,this.trigger("visible");return}this.$container.removeClass("hide"),this.options.closeOnScroll&&(this.options.scrollable.is("body")?this.listenTo(n,"scroll",_.bind(this.close,this)):this.options.scrollable.on("scroll.tooltips",_.bind(this.close,this)));if(this.options.closeDelay){var i=this.$container,s=this.options.closeDelay,o=1500,u=function(t){clearTimeout(e.menuIntentTimer),e.menuIntentTimer=setTimeout(_.bind(function(){i.off("mouseenter","mouseleave"),$(document).off("mousemove."+this.cid),n.trigger("tooltip:close"),this.isOpen=!1},this),t)};i.on("mouseenter",function(){clearTimeout(e.menuIntentTimer)}).on("mouseleave",function(e){var t=e.toElement&&e.toElement.name&&e.toElement.name.indexOf("zeroclipboard");t?$(e.toElement).on("mouseleave",function(){u(s)}):u(s)}),this.options.isSubmenu||u(o)}this.isOpen=!0,this.trigger("visible")}})}),define("gs/views/tooltips/helper.js",function(){n.Views.Tooltips.Helper=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-helper",initialize:function(e){var t=e.text||e.html,i=t&&t.length,s=i?_.calculateTextWidth(t.substring(0,63),null,{html:!!e.html}):0;return i?this.tooltipOptions=_.defaults(e,{delay:500,width:e.width||e.minWidth||s+30,tooltipClass:e.extraClass,tooltipKey:"helperTip"+this.cid,sensitivity:"mouseout",closeOthers:!1,hideDelay:0,isHelper:!0,fixed:!1,scrollable:$(document)}):this.tooltipOptions={},_.each(r.tooltip.tooltips,function(e,t){e.options.isHelper&&!e.options.persist&&n.trigger("tooltip:close",t)}),Backbone.View.prototype.initialize.call(this,e)},render:function(){var e=this.options.addClasses||"",t=$('<div class="tooltip-helper-text '+e+'"></div>');return this.options.html?t.html(this.options.html):t.text(this.options.text),this.options.minWidth&&t.css({minWidth:this.options.minWidth}),this.options.maxWidth&&t.css({maxWidth:this.options.maxWidth}),this.options.width&&t.css({width:this.options.width}),this.options.breakText&&t.css({wordBreak:"break-all"}),this.renderDfd=$.Deferred(),this.$helperDiv=t,this.$el.append(t[0]),this.renderDfd.resolve(),this.renderDfd},updateText:function(e){var t=String(e||""),n=_.calculateTextWidth(t.substring(0,63),null),r=this.$el.parents(".tooltip-container");this.options.text=t,this.$helperDiv&&this.$helperDiv.text(t),r&&r.css({width:n})}},{simpleTooltip:function(e,t){var r=$(e.currentTarget),i=r.data();i||(i={}),i.tooltipKey||(i.tooltipKey=+(new Date));var s=t.tooltipOptions;s.helperTooltip=!0,s.views=[t],s.$attached=r,s.zIndex=999999,s.tooltipClass="helper",s.noMobile=!0,s.tooltipKey||(s.tooltipKey=i.tooltipKey),n.trigger("tooltip:open",s)}})}),function(){function t(e){return function(){try{return store[e].apply(store,arguments)}catch(t){}}}n.Services=n.Services||{};if(!e.store)throw"store.js didn't load!";var r;n.Services.Local={init:function(e){r=e}};for(var i in e.store)e.store.hasOwnProperty(i)&&_.isFunction(store[i])&&(n.Services.Local[i]=t(i))}(),function(){function l(){this.requests=[],this.pendingRequest=null}function c(e,t){return e[e.length-1]===t?{}:e[e.length-1]}function p(t){var r=[].slice.call(arguments,1),i=(new Date).valueOf(),s=[this,null].concat(r),o=new(_.bind.apply(_,s)),u=6e5,a=o.getCacheKey(),f;if(o.options.uncache)return o.send=h,o.uncache(),o;if(t){typeof t=="number"&&(u=t);var l=o.pendingCallCache[a];_.defined(l)&&(l.state()=="pending"||i-l.lastResolution<u)?o=l:(o.pendingCallCache[a]=o,f=function(){o.pendingCallCache[a]===o&&o.uncache()},setTimeout(f,u+Math.floor(Math.random()*5e3)))}if(o.options.canPreload){var c=o.apiMethod;_.each(o.parameters,function(e,t){if(_.isString(e)||_.isNumber(e))c+=":"+e});var p=function(t,r,i){if(typeof e[t]=="object"&&e[t][c]!=null)o.resolve(e[t][c]),delete e[t][c];else if(typeof e[t]=="undefined"){var s=o.send,u=null;o.send=function(){return u=_.toArray(arguments)||[],o.promise()},n.on(r,function(e){e[c]!=null?(o.resolve(e[c]),delete e[c]):u&&s.apply(o,u),o.send=s}),setTimeout(function(){typeof e[t]=="undefined"&&(e[t]={},n.trigger(r,{}))},i)}};o.apiMethod==="getCommunicationToken"?(c=o.apiMethod,p("tokenData","tokenData",3e3)):p("preloadedData","preloadedData",1e4)}return o}function d(){return this.parameters}function v(e,t,n,r){function o(e){s.isPending=!1,s.aborted||(s.lastResolution=(new Date).valueOf())}this.id=i++,this.method="POST",this.contentType="application/json",this.apiMethod=_.orEqual(e,""),this.parameters=_.orEqual(t,{}),this.options=_.orEqual(n,{}),this.useHTTPS=_.orEqual(r,!1),this.overrideHeaders={},this.type="normal",this.failedAuth=!1,this.isPending=!1,this.numRetries=0,this.lastFault=null,this.lastResolution=0,this.successFilters=[],this.faultFilters=[],this._dfd=$.Deferred();var s=this;this._dfd.abort=function(){if(s.ajaxRequest&&s.state()==="pending")return s.abort=!0,s.ajaxRequest.abort()},this._dfd.always(o)}function m(){return p.apply(v,arguments)}function g(t,n,r){v.call(this,null,n),this.type="flattr",this.url="https://api.flattr.com/rest/v2/"+t,this.method=_.orEqual(r,"POST"),n&&n.grant_type==="authorization_code"&&(this.httpHeaders={Authorization:"Basic "+e.btoa(n.client_id+":"+n.client_secret)}),this.method==="GET"&&(this.contentType="application/x-www-form-urlencoded")}function y(){function n(t){var n;if(t.origin!="https://"+e.location.host)return;try{n=JSON.parse(t.data);if(n.id===0&&n.data=="loaded"){pt=t.source;for(var r=0,i=ct.length;r<i;r++)pt.postMessage(ct[r],"https://"+e.location.host);ct=[]}}catch(s){console.error("cannot read JSON data from https proxy: ",t.data,s)}n&&n.id!==0&&n.data!=="loaded"&&lt[n.id]&&(lt[n.id](n),delete lt[n.id])}var t=$("<iframe></iframe>");e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),t.css({position:"absolute",display:"none",height:1,width:1,top:0,left:0}),t.attr("src","https://"+e.location.host+"/httpsProxy.html"),$("body").append(t)}function b(t){function o(e){var r={};switch(e.error){case"parsererror":r.code=et.PARSE_ERROR,r.message=$.localize.getString("SERVICE_PARSE_JSON");break;case"timeout":r.code=et.HTTP_TIMEOUT,r.message=$.localize.getString("SERVICE_REQUEST_TIMEOUT");break;case"error":case"notmodified":default:r.code=et.HTTP_ERROR,r.message=$.localize.getString("SERVICE_HTTP_ERROR")}delete lt[n],O(r,t)}var n=ft++,r=!1,i,s;lt[n]=function(e){clearTimeout(t.httpsProxyTimeout);if(!e.success){o(e);return}T(e.data,t)},t.isPending=!0,s=t.prepareForSend(),i=$.stringify({id:n,url:t.url,data:s});if(!pt){ht||(ht=!0,y()),ct.push(i);return}try{pt.postMessage(i,"https://"+e.location.host),r=!0}catch(u){console.error("https proxy error: ",u.message),o({error:"error"})}r&&(t.httpsProxyTimeout=setTimeout(function(){t.state()=="pending"&&o({error:"timeout"})},11e3))}function w(e){e.swfTimeout=setTimeout(function(){if(e.state()=="pending"){var t={code:et.SWF_TIMEOUT,message:$.localize.getString("SERVICE_HTTP_ERROR")};O(t,e)}},25e3),_.getFlashObjectDfd("html5ShimSwf","makeRequest").done(function(t){clearTimeout(e.swfTimeout),at&&(at=!1,n.Services.API.swfCallback=E,t.setRequestCallback("GS.Services.API.swfCallback")),e.isPending=!0;var r=e.prepareForSend(),i=t.makeRequest(e.url,e.method,r,e.httpHeaders,e.contentType);ut[i]=e})}function E(e,t,n){var r=ut[e],i={};if(r)if(t==="success")T(n,r);else{switch(n){case"badJSON":i.code=et.PARSE_ERROR,i.message=$.localize.getString("SERVICE_PARSE_JSON");break;case"securityError":console.log("service call through swf failed with security sandbox error",r);case"ioError":default:i.code=et.HTTP_ERROR,i.message=$.localize.getString("SERVICE_HTTP_ERROR")}O(i,r)}delete ut[e]}function S(e){e||(e=1);var t="";for(var n=0;n<6;n++)t+=Math.floor(Math.random()*16).toString(16);return t!=Q||e>4?t:S(++e)}function x(e){e=_.orEqual(e,{});var t={client:nt,clientRevision:rt,privacy:n.getSessionPrivacy(),country:n.Services.API.country,uuid:st};return n.Services.API.sessionID&&(t.session=n.Services.API.sessionID),n.Services.API.collectStats&&(t.collectStats=n.Services.API.collectStats),$.extend(t,e)}function T(e,t){_.defined(e)||(e={fault:{message:"Empty Result",code:et.EMPTY_RESULT}}),e.header&&k(e.header,t),e.fault?O(e.fault,t,0):t.resolve(e.hasOwnProperty("result")?e.result:e)}function N(e){e.ajaxRequest=null}function C(){n.trigger("lightbox:open",{_type:"invalidClient",notCloseable:!0,view:{header:"LB_INVALID_CLIENT_TITLE",message:"LB_INVALID_CLIENT_MSG",buttonsRight:[{label:"LB_REFRESH_GROOVESHARK",className:"btn-primary submit"}]},callbacks:{".submit":function(t){e.location.reload(!0)}}})}function k(e,t){var r=e.session;r&&r!=n.Services.API.sessionID&&(n.Services.API.sessionID=r,J=!1,M(!0)),e.expiredClient&&(Z=!0,n.player&&n.player.expireSWFService(),C());var i=e.secondsUntilDowntime;if(i<0)_.delay(B,5e3);else if(i>0){var s=Math.floor(i/60),o=(new Date).valueOf();s<=60&&(Y===0||s>30&&o-Y>36e5||s<=30&&s>15&&o-Y>18e5||s<=15&&s>10&&o-Y>9e5||s<=10&&s>5&&o-Y>6e5||s<=5&&o-Y>3e5)&&(Y=o,n.trigger("notification:add",{description:_.getString("DATABASE_GOING_DOWN",{duration:s}),type:"error",duration:s*60*1e3}))}if(e.stats&&t.options.logStats!==!1){var u=(+(new Date)-t.startTime)/1e3,a=_.extend({methodName:t.apiMethod,requestTime:u},e.stats);n.trigger("api:stats",a)}}function A(n,r,i){var s=(e.location.protocol+"").split(":",1)[0],o=+(new Date),u=$("#emptyCheck");u.length||(u=$("<iframe></iframe>"),u.css({visibility:"hidden",position:"absolute",top:-20,left:-20,zIndex:1,height:10,width:10}),$("body").append(u[0])),o-L>3e4&&(e[a]=function(){if(r.isPending)return;var n;for(n in f)f.hasOwnProperty(n)&&f.retry(0);e[a]=t},u.attr("src",s+"://"+e.location.host+"/check.html?window="+e.name+"&callback="+a+"&"+o),L=o),r.lastFault=n,r.retry(6e3+r.numRetries*100)}function O(t,r,i){if(u&&i==503){A(t,r,i);return}if(t&&_.defined(t.code)){t.aborted||console.log("HANDLE FAULT CODE",t.code,r.apiMethod);if(t.code==et.INVALID_TOKEN){var s=(new Date).valueOf();if((!K||s-K>=3e5)&&r.numRetries===0){K=!1,r.isPending=!1,r.numRetries++,ot.push(r),M(!0);return}n.trigger("notification:add",{description:_.getString("SERVICE_ERROR_COMMUNICATING"),type:"error",duration:6e4})}else{if(t.code==et.HTTP_TIMEOUT||t.code==et.EMPTY_RESULT){r.lastFault=t,r.retry(100+r.numRetries*100);return}t.code==et.MAINTENANCE?_.delay(B,5e3):t.code==et.INVALID_CLIENT?C():t.code==et.INVALID_SESSION?n.trigger("lightbox:open",{_type:"sessionBad",_canClose:!1,view:{header:"POPUP_SESSION_BAD_TITLE",message:"POPUP_SESSION_BAD_MSG",buttonsLeft:[{label:"LB_REFRESH_GROOVESHARK",className:"submit"}]},callbacks:{".submit":function(t){e.location.reload(!0)}}}):gsConfig.runMode=="dev"&&t.code==et.HTTP_ERROR&&r.apiMethod=="getCommunicationToken"&&(e.gsConfig.httpsFix=!0,e.location="https://"+e.location.host+e.location.hash)}t.apiMethod=r.apiMethod}r.reject(t)}function M(e){if(J)return;var t,r=(new Date).valueOf();if(e!==!0&&r-X<5e3){P(W);return}D(),J=!0;if(n.Services.API.sessionID){var i=hex_md5(n.Services.API.sessionID);t=m(!1,"getCommunicationToken",{secretKey:i},{canPreload:!0},!0),t.promise().then(P,function(e){H(e,t)})}else J=!1;t&&t.send()}function D(){W=null,V=0,X=0}function P(e){var t=new Date;K=!1,W=e,J=!1,X=t.valueOf(),V=15e5+t.valueOf();var r;while(ot.length)r=ot.shift(),r.send();n.dispatcher.trigger("api:ready")}function H(e,t){var n=new Date;J=!1,K=n.valueOf();var r;while(ot.length)r=ot.shift(),r.reject({message:$.localize.getString("SERVICE_CREATE_TOKEN_FAIL"),code:et.INVALID_TOKEN})}function B(){G||(G=!0,n.dispatcher.trigger("lightbox:open",{type:"maintenance",_canClose:!1,view:{header:"POPUP_MAINT_TITLE",message:"POPUP_MAINT_MESSAGE",buttonsLeft:[{label:"POPUP_MAINT_TWITTER_2",href:"http://twitter.com/sharkjanitor"}]}}),F())}function j(){G=!1,n.Views.Lightbox.close("maintenance")}function F(){var e=m(!1,"getServiceStatus");e.promise().then(I,q),e.send()}function I(e,t){e.status==1?j():_.delay(F,2e4)}function q(e,t){_.delay(F,2e4)}function R(e){return _.map(e,function(e){return e.hasOwnProperty("AlbumID")&&delete e.AlbumID,e.hasOwnProperty("AlbumName")&&delete e.AlbumName,e.hasOwnProperty("SongName")&&delete e.SongName,e.hasOwnProperty("Flags")&&delete e.Flags,e})}function U(){var e=new XMLHttpRequest,n={supported:!1,httpsSupported:!1};return"withCredentials"in e?((gsConfig.runMode==="staging"||gsConfig.runMode==="dev"||gsConfig.runMode==="framily")&&$.ajaxSetup({xhrFields:{withCredentials:!0}}),n.supported=!0,n.httpsSupported=!0):typeof XDomainRequest!="undefined"&&(jQuery.ajaxTransport("* text html xml json",function(e){if(e.crossDomain&&e.async){e.timeout&&(e.xdrTimeout=e.timeout,delete e.timeout);var n;return{send:function(r,i){function s(e,r,s,o){n.onload=n.onerror=n.ontimeout=jQuery.noop,n=t,i(e,r,s,o)}n=new XDomainRequest,n.onload=function(){s(200,"OK",{text:n.responseText},"Content-Type: "+n.contentType)},n.onerror=function(){s(500,"Internal Server Error")},n.onprogress=jQuery.noop,n.ontimeout=function(){s(0,"timeout")},n.timeout=e.xdrTimeout||Number.MAX_VALUE,n.open(e.type,e.url),n.send(e.hasContent&&e.data||null)},abort:function(){n&&(n.onload=n.onerror=n.ontimeout=jQuery.noop,n.abort())}}}}),n.supported=!0,n.httpsSupported=!1),n}n.Services=n.Services||{};var i=1,s="frenchFriedDogs",u=!0,a="apiCheck_"+ +(new Date),f={};l.prototype.queue=function(e){function t(){if(this.requests.length){this.pendingRequest=this.requests.shift();var e=this;this.pendingRequest.promise().always(function(){e.pendingRequest=null,t.call(e)}),this.pendingRequest.send()}}this.requests.push(e),this.pendingRequest||t.call(this)};var h=function(){return this._dfd.reject(),this.promise()};v.createRequest=function(){return p.apply(this,arguments)},v.prototype=$.extend(v.prototype,{promise:function(){var e=this._dfd.promise();return e.abort=this._dfd.abort,e},state:function(){return this._dfd.state()},resolve:function(e){for(var t=0;t<this.successFilters.length;t++)_.isFunction(this.successFilters[t])&&(e=this.successFilters[t](e));this.lastResolution=(new Date).valueOf(),this._dfd.resolve(e)},resolveWith:function(e,t){for(var n=0;n<this.successFilters.length;n++)_.isFunction(this.successFilters[n])&&(t=this.successFilters[n](t));this.lastResolution=(new Date).valueOf(),this._dfd.resolveWith(e,t)},reject:function(e){for(var t=0;t<this.faultFilters.length;t++)_.isFunction(this.faultFilters[t])&&(e=this.faultFilters[t](e));this._dfd.reject(e)},rejectWith:function(e,t){for(var n=0;n<this.faultFilters.length;n++)_.isFunction(this.faultFilters[n])&&(t=this.faultFilters[n](t));this._dfd.rejectWith(e,t)},pendingCallCache:{},cacheKeyProps:["apiMethod","parameters","type"],getCacheKey:function(){var e,t,n="";for(e in this.cacheKeyProps)this.cacheKeyProps.hasOwnProperty(e)&&(t=this[this.cacheKeyProps[e]],t instanceof String?n+=t:n+=$.stringify(t));return hex_md5(n)},uncache:function(){var e=this.getCacheKey();delete this.pendingCallCache[e]},prepareForSend:function(){var e={header:x(this.overrideHeaders),method:this.apiMethod,parameters:this.parameters};if(W){Q=S();var t=hex_sha1([this.apiMethod,W,s,Q].join(":"));e.header.token=Q+t}return this.startTime=+(new Date),n.Services.API.lastRequestTime=this.startTime,e},send:function(t){t&&t.length==2&&this.promise().then(t[0],t[1]);var i=this,s=!0,o=(new Date).valueOf(),u=!1,a=!1,l=n.Services.API.corsSupport,c,h;f[this.id]&&delete f[this.id];if(this.isPending||this.state()=="resolved")return this.promise();if(Z)return this.reject({message:$.localize.getString("POPUP_INVALID_CLIENT_MSG"),code:et.INVALID_CLIENT}),this.promise();this.isPending=!0;if(this.numRetries>=3)return this.reject(this.lastFault),this.promise();this.numRetries>0&&(s=!1);if(this.type=="flattr"||this.type=="dfp")u=!0;if(V>o||_.indexOf(["getCommunicationToken","initiateSession","getServiceStatus"],this.apiMethod)!=-1){if(G&&this.apiMethod!="getServiceStatus")return this.reject({message:$.localize.getString("SERVICE_DOWN_MAINTENANCE"),code:et.MAINTENANCE}),this.promise();h="http://"+tt+"/"+it+"?"+this.apiMethod;if(this.useHTTPS||gsConfig.forceHTTPS)h=h.replace("http:","https:");this.url=h,(this.useHTTPS||gsConfig.forceHTTPS)&&!l.httpsSupported&&(a=!0),(this.useHTTPS||gsConfig.forceHTTPS)&&!l.supported&&typeof gsConfig.neverUseSWF=="undefined"&&(u=!0);if(u)return w(this),this.promise();if(a)return b(this),this.promise();c=this.prepareForSend(),this.ajaxRequest=$.ajax($.extend({},this.options,{contentType:"text/plain",dataType:"json",type:"POST",data:$.stringify(c),cache:s,url:h,xhr:function(){var t=jQuery.ajaxSettings.xhr();return e.XMLHttpRequest&&t instanceof e.XMLHttpRequest&&(t.url=h),t},success:function(e,t,n){T(e,i),N(i)},error:function(e,t,n){var r=e.status,s;try{s=(e.responseText||"").substr(0,150)}catch(o){}console.warn("ajax error: "+n+" ("+t+")",s,e,this);var u={};switch(t){case"parsererror":u.code=et.PARSE_ERROR,u.message=$.localize.getString("SERVICE_PARSE_JSON");break;case"timeout":u.code=et.HTTP_TIMEOUT,u.message=$.localize.getString("SERVICE_REQUEST_TIMEOUT");break;case"error":case"notmodified":default:u.code=et.HTTP_ERROR,u.message=$.localize.getString("SERVICE_HTTP_ERROR")}t=="abort"&&(i.abort=!0,u.aborted=!0),O(u,i,r),N(i)}}))}else this.isPending=!1,ot.push(this),M();return this.promise()},retry:function(e){this.isPending=!1,this._retryTimer&&(this._retryTimer=t,clearTimeout(this._retryTimer)),e===0?this.send():(f[this.id]=this,this._retryTimer=_.delay(_.bind(function(){this.numRetries++,this.send()},this),e))},queue:function(e){_.defined(v.prototype.queues)||(v.prototype.queues={});var t=v.prototype.queues[e];return _.defined(t)||(t=v.prototype.queues[e]=new l),t.queue(this),this.promise()}}),n.getAPIReqInfo=function(e,t,n){var i={header:x(t),method:e,parameters:n||{}};if(W){Q=S();var o=hex_sha1([e,W,s,Q].join(":"));i.header.token=Q+o}var u="http://"+tt+"/"+it+"?"+e;return{req:i,url:u}},g.createRequest=function(){return p.apply(this,arguments)},g.prototype=$.extend(g.prototype,v.prototype,{prepareForSend:d});var L=0,z="nuggetsOfBaller",W=null,X=0,V=0,J=!1,K=!1,Q=null,G=!1,Y=0,Z=!1,et={INVALID_CLIENT:1024,RATE_LIMITED:512,INVALID_TOKEN:256,INVALID_SESSION:16,MAINTENANCE:10,MUST_BE_LOGGED_IN:8,HTTP_TIMEOUT:6,PARSE_ERROR:4,HTTP_ERROR:2,EMPTY_RESULT:-256,SWF_TIMEOUT:-512},tt=e.location.host,nt="htmlshark",rt="20130520",it="more.php",st="",ot=[],ut={},at=!0,ft=1,lt={},ct=[],ht=!1,pt;o=n.Services.API={sessionID:null,sessionPart:null,collectStats:null,country:null,privacy:0,lastRequestTime:0,corsSupport:{},init:function(e){this.sessionID=e.sessionID,this.sessionPart=hex_md5(e.sessionID).substr(0,6),this.country=e.country,this.corsSupport=U(),st=e.uuid,it=_.orEqual(it,e.defaultEndpoint),st||n.Services.Log.notify("Invalid UUID received in API.init","ERROR"),this.sessionID||n.Services.Log.notify("Invalid SessionID received in API.init","ERROR"),s=z},newTokenSuccess:P,isFirstVisit:function(){var e=$.Deferred();return _.getFlashObjectDfd("html5ShimSwf","isFirstVisit").done(function(t){e.resolve(t.isFirstVisit())}).fail(function(){e.resolve(!0)}),e.promise()},makeRequest:function(e,t,n,r){var i={};r&&r.extraHeaders&&(i=r.extraHeaders,delete r.extraHeaders);var s=m(e,t,n,r);return _.extend(s.overrideHeaders,i),s.send()},makeLastfmRequest:function(e,t,n){var r=new $.Deferred;return t.format="json",n=n||"GET",$.ajax({type:n,url:e,data:t,xhrFields:{withCredentials:!1},crossDomain:!0,dataType:"text",success:function(e){r.resolve(e)},error:function(e){r.reject(e)}}),r.promise()},makeFlattrRequest:function(e,t,n){var r=g.createRequest(!1,e,t,n);return r.send()},getThemeFromDFP:function(e,t){e=e||"grooveshark.wall",t=t||"";var n=m(!1,"getThemeFromDFP");return n.type="dfp",n.method="GET",n.contentType="application/json",n.url="http://ad.doubleclick.net/pfadx/"+e+"/"+t,n.send()},getNotificationFromDFP:function(e,t,n){e=e||"";var r=c(arguments,n),i=m(!1,"getNotificationFromDFP",{},r);return i.type="dfp",i.method="GET",i.url="http://ad.doubleclick.net/pfadx/grooveshark.notif/"+e,i.send([t,n])},getGSConfig:function(){var e=m(!1,"getGSConfig");return e.send()},getAlbumByID:function(e){var t=m(!1,"getAlbumByID",{albumID:e},{canPreload:!0});return t.send()},getArtistByID:function(e){var t=m(!1,"getArtistByID",{artistID:e},{canPreload:!0});return t.send()},getPlaylistByID:function(e){var t=m(!1,"getPlaylistByID",{playlistID:e});return t.send()},getPlaylistMetaByID:function(e){var t=m(!1,"getPlaylistMetaByID",{playlistID:e});return t.send()},getQueueSongListFromSongIDs:function(e){var t=m(!0,"getQueueSongListFromSongIDs",{songIDs:e});return t.send()},getAutoplaySong:function(e){console.warn("getAutoplaySong",arguments);var t=m(!1,"getAutoplaySong",{autoplayState:e});return t.send()},getSongFromToken:function(e){var t=m(!0,"getSongFromToken",{token:e,country:this.country});return t.send()},getSongAmazonUrl:function(e){var t=m(!0,"getAffiliateDownloadURLs",{songName:e.get("SongName"),artistName:e.get("ArtistName")});return t.send()},getTokenForSong:function(e,t,n){var r=c(arguments,n),i=m(!0,"getTokenForSong",{songID:e,country:this.country},r);return i.send([t,n])},getUserByID:function(e){var t=m(3e5,"getUserByID",{userID:e});return t.send()},getProfileInfoByID:function(e,t,n,r){var i=m(!1,"getProfileInfoByID",{profileID:e,artistID:t,includeMetadata:n,includePageName:r});return i.send()},albumGetAllSongs:function(e,t){var n=m(!1,"albumGetAllSongs",{albumID:e,includeUnlisted:t},{canPreload:!0});return n.send()},artistGetArtistSongs:function(e,t,n){var r=m(!1,"artistGetArtistSongs",{artistID:e,limit:t,includeUnlisted:n},{canPreload:!0});return r.send()},artistGetArtAttribution:function(e){var t=m(!1,"artistGetArtAttribution",{artistID:e});return t.send()},artistGetAllAlbums:function(e,t){var n=m(!1,"artistGetAllAlbums",{artistID:e,includeUnlisted:t});return n.send()},playlistGetSongs:function(e,t){var n=m(!t,"playlistGetSongs",{playlistID:e});return n.send()},getUserRecentListens:function(e){var t=m(!1,"getUserRecentListens",{userID:e});return t.send()},getPersonalizedTagsForUser:function(e,t){var n=t?0:3e4,r=m(n,"getPersonalizedTagsForUser",{userID:e},{canPreload:!0});return t&&r.uncache(),r.send()},saveUserTagPreferences:function(e,t,n){var r=m(!1,"saveUserTagPreferences",{flags:e,customTags:t,blacklistTags:n},null);return r.send()},getUserTagPreferences:function(){var e=m(!1,"getUserTagPreferences",{},null);return e.send()},deleteUserListens:function(e){var t=m(!1,"deleteUserListens",{keys:e});return t.send()},popularGetSongs:function(e){var t={daily:!0,weekly:!0,monthly:!0};t[e]||(e="daily");var n=m(864e5,"popularGetSongs",{type:e},{canPreload:!0});return n.send()},popularGetSongsPreview:function(){var t=this,r=$.Deferred(),i=function(e){var s=e.popularGetSongsPreview;s?r.resolve(s):t.popularGetSongs("daily").done(function(e){e||r.reject(),r.resolve({Songs:_.take(e.Songs,30)})}).fail(function(){r.reject()}),n.off("preloadedData",i)};return e.preloadedData?i(e.preloadedData):n.on("preloadedData",i),r.promise()},featuredGetCurrentFeatured:function(e){var t=m(!0,"featuredGetCurrentFeatured",{date:e},{canPreload:!0});return t.send()},getRecommendedSongs:function(e,t){var n=m(864e5,"getRecommendedSongs",{artistIDs:e,excludeArtistIDs:t},{});return n.send()},artistGetFans:function(e,t){t=_.orEqual(t,0);var n=m(!1,"artistGetFans",{artistID:e,offset:t});return n.send()},playlistGetFans:function(e){var t=m(!1,"playlistGetFans",{playlistID:e});return t.send()},userGetFollowersEx:function(e){var t=m(!1,"getUsersFollowingUser",{userID:e});return t.send()},authenticateUser:function(e,t){var n=m(!1,"authenticateUser",{username:e,password:t},null,!0);return n.send()},authenticateAsAuthorizedUser:function(e){var t=m(!1,"authenticateAsAuthorizedUser",{userID:e},null,!0);return t.send()},authenticateGoogleUser:function(e,t,n){var r=m(!1,"authenticateGoogleUserEx",{googleUID:e,googleEmailAddress:t,accessToken:n},null,!0);return r.send()},authenticateTwitterUser:function(e,t,n){var r=v.createRequest(!1,"authenticateTwitterUser",{twitterUserID:e,oauthToken:t,oauthSecret:n},null,!0);return r.send()},logoutUser:function(){var e=m(!1,"logoutUser");return e.send()},userForgotPassword:function(e){var t=m(!1,"userForgotPassword",{usernameOrEmail:e});return t.send()},resetPassword:function(e,t,n){var r=m(!1,"resetPassword",{usernameOrEmail:e,secretResetCode:t,newPassword:n},null,!0);return r.send()},changePassword:function(e,t){var n=m(!1,"changePassword",{oldPassword:e,newPassword:t},null,!0);return n.send()},registerUser:function(e){var t=c(arguments,e),n=m(!1,"registerUser",e,t,!0);return n.send()},userDisableAccount:function(e,t,n,r){var i=m(!1,"userDisableAccount",{password:e,reason:t,details:n,contact:r},{},!0,!0);return i.send()},getIsUsernameEmailAvailable:function(e,t){var n=m(!1,"getIsUsernameEmailAvailable",{username:e,emailAddress:t});return n.send()},sendInvites:function(e){var t=m(!1,"sendInvites",{emailAddresses:e});return t.send()},getTopArtistsForUser:function(e){var t=m(!1,"getTopArtistsForUser",{userID:e});return t.send()},changeUserInfoEx:function(e,t,n,r,i,s,o){var u=c(arguments,o),a=m(!1,"changeUserInfoEx",{shitToChange:e,password:t,regAuthToken:n,thirdPartyLogin:r,oldShit:i},u,!0);a.send([s,o])},changeUserCoverPhotoSettings:function(e,t,n,r){var i=m(!1,"changeUserCoverPhotoSettings",{coverPhoto:e,stockCoverPhotoID:t,coverPhotoFlags:n,coverPhotoY:r});return i.send()},changePlaylistCoverPhotoSettings:function(e,t,n,r,i){var s=m(!1,"changePlaylistCoverPhotoSettings",{playlistID:e,coverPhoto:t,stockCoverPhotoID:n,flags:r,coverPhotoY:i});return s.send()},updateUserProfileURLs:function(e,t){var n=m(!1,"updateUserProfileURLs",{urls:e,urlTypesOrder:t});return n.send()},storeUserPageCardArragement:function(e,t){var n=m(!1,"storeUserPageCardArragement",{cards:e,clearArrangement:t});return n.send()},getSubscriptionDetails:function(){var e=m(!1,"getSubscriptionDetails",{},null,!0);return e.send()},userGetSongsInLibrary:function(e,t,n){t=_.orEqual(t,0),n=_.orEqual(n,!0);var r=m(n,"userGetSongsInLibrary",{userID:e,page:t});return r.send()},userGetLibraryTSModified:function(e){var t=m(!1,"userGetLibraryTSModified",{userID:e},{canPreload:!0});return t.send()},userAddSongsToLibrary:function(e){var t=m(!1,"userAddSongsToLibrary",{songs:e});return t.queue("library")},userRemoveSongsFromLibrary:function(e,t,n,r){var i=m(!1,"userRemoveSongsFromLibrary",{userID:e,songIDs:t,albumIDs:n,artistIDs:r});return i.queue("library")},getFavorites:function(e,t){t=_.orEqual(t,"Songs");var n={};t=="Songs"&&(n.canPreload=!0);var r=m(!1,"getFavorites",{userID:e,ofWhat:t},n);return r.send()},getSubscribedPlaylistsBroadcasts:function(){var e=m(!1,"getSubscribedPlaylistsBroadcasts",{});return e.send()},userGetFavoriteSongsSongIDs:function(){var e=m(!1,"userGetFavoriteSongsSongIDs",{},{canPreload:!0});return e.send()},userGetSongIDsInLibrary:function(){var e=m(!1,"userGetSongIDsInLibrary",{});return e.send()},favorite:function(e,t,n,r,i){var s=m(!1,"favorite",{what:e,ID:t,details:n});return s.queue("library")},unfavorite:function(e,t){var n=m(!1,"unfavorite",{what:e,ID:t});return n.queue("library")},favoriteBroadcast:function(e,t,n,r){var i=m(!1,"favoriteBroadcast",{broadcastID:e,broadcastName:t,ownerUserID:n,ownerArtistID:r});return i.send()},unfavoriteBroadcast:function(e){var t=m(!1,"unfavoriteBroadcast",{broadcastID:e});return t.send()},getFavoriteBroadcasts:function(e){var t=m(!1,"getFavoriteBroadcasts",{userID:e});return t.send()},userGetPlaylists:function(e,t){var n={userID:e};t&&(n.limit=t);var r=m(!1,"userGetPlaylists",n,{canPreload:!0});return r.send()},createPlaylist:function(e,t,n,r){var i=m(!1,"createPlaylistEx",{playlistName:e,songIDs:t,playlistAbout:n,customTagID:r});return i.send()},deletePlaylist:function(e,t){var n=m(!1,"deletePlaylist",{playlistID:e,name:t});return n.queue("playlist")},playlistUndelete:function(e){var t=m(!1,"playlistUndelete",{playlistID:e});return t.queue("playlist")},overwritePlaylist:function(e,t,n){var r=m(!1,"overwritePlaylistEx",{playlistID:e,playlistName:t,songIDs:n});return r.queue("playlist")},modifyPlaylistCustomTag:function(e,t,n){var r=m(!1,"modifyPlaylistCustomTag",{playlistID:e,tagID:t,removeCustomTag:n});return r.queue("playlist")},playlistAddSongToExisting:function(e,t,n){var r=m(!1,"playlistAddSongToExistingEx",{playlistID:e,songID:t,song:n});return r.queue("playlist")},renamePlaylist:function(e,t,n){var r=m(!1,"renamePlaylist",{playlistID:e,playlistName:t,broadcast:n});return r.queue("playlist")},setPlaylistAbout:function(e,t,n){var r=m(!1,"setPlaylistAbout",{playlistID:e,about:t,broadcast:n});return r.queue("playlist")},tagRadioGetAllSongs:function(e){var t=m(!1,"tagRadioGetAllSongs",{tagID:e});return t.send()},getResultsFromSearch:function(e,t,r){var i=m(!0,"getResultsFromSearch",{query:e,type:t,guts:n.guts?n.getGuts().shouldLog:0,ppOverride:r});return t==="Artists"?i.successFilters.push(function(e){return $.isArray(e.result)&&(e.result=R(e.result)),e}):$.isArray(t)&&i.successFilters.push(function(e){return e.result.Artists&&$.isArray(e.result.Artists)&&(e.result.Artists=R(e.result.Artists)),e}),i.send()},getAutocompleteEx:function(e,t){var n=m(!0,"getAutocompleteEx",{query:e,type:t});return n.send()},getGoogleSuggest:function(t){t=$.trim(t);var n=new $.Deferred,r="http://google.com/complete/search?output=json&q="+t+" lyrics&client=serp";return e.google||(e.google={}),e.google.ac||(e.google.ac={}),e.google.ac.h=function(e){var r=!1;if(e[1].length>0){e=e[1],r=e[0][0],r=r.replace(/<[^>]+>/ig,""),r=r.substring(0,r.lastIndexOf("lyrics")),r=$.trim(r);var i=document.createElement("div");i.innerHTML=r,r=i.innerText||i.text||i.textContent}r&&r.toLowerCase()!==t.toLowerCase()?n.resolve(r):n.reject()},$.ajax({url:r,dataType:"jsonp",jsonp:!1,jsonpCallback:"window.google.ac.h",success:function(e,t,n){},error:function(e,t,r){_.delay(function(){n.state()=="pending"&&n.reject()},100)}}),n.promise()},changeFollowFlagsEx:function(e){var t=m(!1,"changeFollowFlagsEx",{userIDsFlags:e},{});return t.send()},postToFeed:function(e,t,n,r,i,s,o){var u={what:e,ID:t,people:n,message:r,hidden:i,tagID:s,shareToAllFollowers:o},a=m(!1,"postToFeed",u);return a.send()},getTacobellCarryOut:function(e,t){var n=m(!1,"getTacobellCarryOut",{tacosMadeBeforeTS:t,lastTSNewest:e});return n.send()},getFreshTacosCount:function(){var e=m(!1,"getFreshTacosCount",{},{canPreload:!0});return e.send()},markTacosAsEaten:function(e){var t=m(!1,"markTacosAsEaten",{tsNewest:e});return t.send()},markTipViewed:function(e,t,n){var r=m(!1,"markTipViewed",{set:e,newFlag:t,miscName:n});return r.send()},getUserMiscellaneousData:function(e){var t=m(!1,"getUserMiscellaneousData");return t.send()},getTacoByGroupID:function(e){var t=m(!1,"getTacoByGroupID",{groupID:e});return t.send()},logTargetedThemeImpression:function(e){var t=m(!1,"logTargetedThemeImpression",{themeID:e});return t.send()},logThemeOutboundLinkClick:function(e,t){var n=m(!1,"logThemeOutboundLinkClick",{themeID:e,linkID:t});return n.send()},logThemeCounter:function(e,t){var n=m(!1,"logThemeCounter",{name:e,amount:t});return n.send()},getSongkickEventsFromArtists:function(e,t){var n=m(!0,"getSongkickEventsFromArtists",{artistIDs:e,names:t});return n.send()},getSongkickArtist:function(e){var t=m(!0,"getSongkickArtist",{artistID:e});return t.send()},broadcastSong:function(e,t,n,r,i,s,o,u,a){var f=c(arguments,a),l=m(!1,"broadcastSong",{songID:e,message:t,username:n,password:r,saveCredentials:i,service:s,song:o},f,!0);l.send([u,a])},getUserGoogleAccessToken:function(){var e=m(!1,"getUserGoogleAccessToken",{},null,!0);return e.send()},saveUserGoogleData:function(e,t,n){var r=m(!1,"saveUserGoogleDataEx",{googleUID:e,googleEmailAddress:t,flags:n},null,!0);return r.send()},updateUserGoogleData:function(e,t,n){var r=m(!1,"updateUserGoogleDataEx",{googleUID:e,googleEmailAddress:t,flags:n},null,!0);return r.send()},removeUserGoogleData:function(e,t,n,r){var i=c(arguments,r),s=m(!1,"removeUserGoogleData",{googleUID:e,googleEmailAddress:t},i);s.send([n,r])},saveUserTwitterData:function(e,t,n,r,i){var s=v.createRequest(!1,"saveUserTwitterData",{twitterUserID:e,oauthToken:t,oauthSecret:n},null,!0);return s.send()},updateUserTwitterData:function(e,t,n){var r=v.createRequest(!1,"updateUserTwitterData",{twitterUserID:e,oauthToken:t,oauthSecret:n},null,!0);return r.send()},removeUserTwitterData:function(e,t,n){var r=arguments[arguments.length-1]===n?{}:arguments[arguments.length-1],i=v.createRequest(!1,"removeUserTwitterData",{twitterUserID:e},r);i.send([t,n])},postTwitterStatus:function(e,t,n,r,i){var s=v.createRequest(!1,"postTwitterStatus",{message:e,oauthToken:t,oauthSecret:n},null);return s.send()},getUsernameSuggestions:function(e,t,n){var r=m(!0,"getUsernameSuggestions",{baseUsername:e,fullName:t,idOrRand:n},null);return r.send()},registerGoogleUser:function(e){var t=c(arguments,e),n=m(!1,"registerGoogleUserEx",e,t,!0);return n.send()},registerTwitterUser:function(e){var t=c(arguments,e),n=m(!1,"registerTwitterUser",e,t,!0);return n.send()},updateLastfmService:function(e,t,n,r,i,s,o){var u=c(arguments,o),a=m(!1,"updateLastfmService",{session:e,token:t,username:n,flagsAdd:r,flagsRemove:i},u);a.send([s,o])},saveLastfmService:function(e,t,n,r,i,s){var o=c(arguments,s),u=m(!1,"saveLastfmService",{session:e,token:t,username:n,flags:r},o);u.send([i,s])},removeLastfmService:function(e,t,n){var r=c(arguments,n),i=m(!1,"removeLastfmService",{lastfmUsername:e},r);i.send([t,n])},saveUserFlattrData:function(e,t,n){var r=v.createRequest(!1,"saveUserFlattrData",{flattrUsername:t,accessToken:e,flags:n},null,!0);return r.send()},updateUserFlattrData:function(e,t,n){var r=v.createRequest(!1,"updateUserFlattrData",{flattrUsername:t,accessToken:e,flags:n},null,!0);return r.send()},removeUserFlattrData:function(){var e=v.createRequest(!1,"removeUserFlattrData",{});return e.send()},userGetExtraData:function(){var e=m(!1,"userGetExtraData",{},null,!0);return e.send()},userGetRecommendedUsers:function(){var e=v.createRequest(!1,"userGetRecommendedUsers",{});return e.send()},userHideRecommendedUser:function(e){var t=v.createRequest(!1,"userHideRecommendedUser",{recommendedUserID:e});return t.send()},provideVIPFeedback:function(e,t,n){var r=m(!1,"provideVIPFeedback",{fromAddress:e,message:t,type:n});return r.send()},artistGetSimilarArtists:function(e){var t=m(!1,"artistGetSimilarArtists",{artistID:e});return t.send()},getItemByPageName:function(e){var t=m(!1,"getItemByPageName",{name:e});return t.send()},getPageInfoByIDType:function(t,r,i,s){t===n.getLoggedInUserID()&&r==="user"&&(s||(s={}),s.canPreload=!0);var o=m(!i,"getPageInfoByIDType",{id:t,type:r},s||{});return o.promise().done(function(i){i.Name&&e.GS&&n.router&&n.router.cachePageName(i.Name,r,t)}),o.send()},getPageInfoByIDsType:function(t,r){var i=c(arguments,r),s=m(!0,"getPageInfoByIDsType",{ids:t,type:r},i);return s.promise().done(function(t){if(!t||!t.length)return;for(var i=0,s=t.length;i<s;i++)t[i].Name&&e.GS&&n.router&&n.router.cachePageName(t[i].Name,r,t[i].ItemID)}),s.send()},getPageMetaInfoByIDsType:function(t,r){var i=c(arguments,r),s=m(!0,"getPageMetaInfoByIDsType",{ids:t,type:r},i);return s.promise().done(function(t){if(!t||!t.length)return;for(var i=0,s=t.length;i<s;i++)t[i].Name&&e.GS&&n.router&&n.router.cachePageName(t[i].Name,r,t[i].ItemID)}),s.send()},getTopLevelTags:function(){var e=m(!0,"getTopLevelTags",{},{});return e.send()},getTagList:function(){var e=m(!0,"getTagList",{},{});return e.send()},getTagsSampleSongs:function(e){var t=m(!0,"getTagsSampleSongs",{tagIDs:e},{});return t.send()},userGetPoints:function(){var e=m(!1,"userGetPoints",{},{});return e.send()},redeemPointsForAnywhere:function(){var e=m(!1,"redeemPointsForAnywhere",{},{});return e.send()},sendAdvertisingEmail:function(e){var t=m(!1,"sendAdvertisingEmail",{contents:e});return t.send()},logPerformanceTracking:function(e){var t=m(!1,"logPerformanceTracking",{stats:e},{logStats:!1});return t.send()},getBroadcast:function(e,t){var n=m(!1,"getBroadcast",{broadcastID:e,getSongs:!!t});return n.send()},getUserBroadcasts:function(e,t){var n=m(!1,"getUserBroadcasts",{userID:e,page:t});return n.send()},getUserLastBroadcast:function(){var e=m(!1,"getUserLastBroadcast",{});return e.send()},broadcastUpdateExtraData:function(e){var t=m(!1,"broadcastUpdateExtraData",e);return t.send()},deleteBroadcast:function(e,t){var n=m(!1,"deleteBroadcast",{broadcastID:e,asArtistID:t});return n.send()},undeleteBroadcast:function(e,t){var n=m(!1,"undeleteBroadcast",{broadcastID:e,asArtistID:t});return n.send()},getTopBroadcasts:function(e){var t=m(3e4,"getTopBroadcasts",{manateeTags:e});return t.send()},getTopBroadcastsCombinedEx:function(e){var t=m(3e4,"getTopBroadcastsCombinedEx",{withStagingEvents:e});return t.send()},getLeaderboardBroadcasters:function(e,t,n){var r=m(6e4,"getLeaderboardBroadcasters",{date:e,tagID:t,unit:n});return r.send()},submitUserInfoForCampaign:function(e,t){var n=m(!1,"submitUserInfoForCampaign",{campaignID:e,campaignData:t});return n.send()},userGetArtistsOwned:function(){var e=m(!1,"userGetArtistsOwned",null,null);return e.send()},artistUpdateProfileEx:function(e,t,n){var r=m(!1,"artistUpdateProfileEx",{artistID:e,profile:t,previousProfile:n});return r.send()},artistUpdatePageName:function(e,t){var n=m(!1,"artistUpdatePageName",{artistID:e,newPageName:t});return n.send()},artistRequestPageNameTakeover:function(e,t){var n=m(!1,"artistRequestPageNameTakeover",{artistID:e,newPageName:t});return n.send()},artistEditAlbum:function(e,t){var n=m(!1,"artistEditAlbum",{album:e,previousAlbum:t});return n.send()},artistEditSongs:function(e,t){var n=m(!1,"artistEditSongs",{songs:e,previousSongs:t});return n.send()},addSongToAlbum:function(e,t,n,r){var i=m(!1,"addSongToAlbum",{songID:e,newAlbumID:t,newAlbumTrackNum:n,newAlbumIsPrimary:r});return i.send()},artistDisownSongs:function(e,t,n){var r=m(!1,"artistDisownSongs",{songIDs:e,albumIDs:t,artistID:n});return r.send()},artistDeleteSongs:function(e,t,n){var r=m(!1,"artistDeleteSongs",{songIDs:e,artistID:n,albumIDs:t});return r.send()},artistCreateAlbum:function(e){var t=m(!1,"artistCreateAlbum",{album:e});return t.send()},artistMergeSongDuplicates:function(e,t){var n=m(!1,"artistMergeSongDuplicates",{correctSongID:e,duplicateSongIDs:t});return n.send()},sendArtistFansUpdate:function(e,t,r,i){var s=m(!1,"sendArtistFansUpdate",{artistID:e,message:t,item:r,type:i}),o={};return o.artistID=e,i&&i.length&&(o.itemType=i),t&&t.length&&(o.messageLength=t.length),i==="artist"?o.itemID=r.artistID:i==="album"?o.itemID=r.albumID:i==="playlist"?o.itemID=r.playlistID:i==="song"&&(o.itemID=r.songID),n.trigger("guts:log","sendArtistFansUpdate",o),_.gaTrackEvent("site","sendArtistFansUpdate",i+"_"+e),s.send()},getArtistsDailyArtistStatsEx:function(e,t,n){var r=m(3600,"getArtistsDailyArtistStatsEx",{artistIDs:e,dayCount:t,includeCumulative:n});return r.send()},getArtistDailySongsStats:function(e,t){var n=m(3600,"getArtistDailySongsStats",{artistID:e,dayCount:t});return n.send()},getArtistWeeklyTopStats:function(e){var t=m(3600,"getArtistWeeklyTopStats",{artistID:e});return t.send()},claimArtist:function(e){var t=m(!1,"claimArtist",e);return t.send()},claimSongs:function(e,t,n,r){var i=m(!1,"claimSongs",{artistID:e,message:r,songIDs:t,album:n});return i.send()},artistModifyFeaturedSongIDs:function(e,t){var n=m(!1,"artistModifyFeaturedSongIDs",{artistID:e,songIDs:t});return n.send()},modifyArtistRelatedArtists:function(e,t){var n=m(!1,"modifyArtistRelatedArtists",{artistID:e,artists:t});return n.send()},verifyFacebookURL:function(e,t){var n=m(!1,"verifyFacebookURL",{facebookUsername:e,gsUsername:t});return n.send()},userVerifyEmail:function(e){var t=m(!1,"userVerifyEmail",{token:e});return t.send()},resendEmailToken:function(e){var t=m(!1,"resendEmailToken",{lastToken:e});return t.send()},userGetFollowersFollowing:function(e){var t=m(!1,"userGetFollowersFollowingExt",{limit:e},{canPreload:!0});return t.send()},getCommentByID:function(e){var t=m(!1,"getCommentByID",{commentID:e});return t.send()},getCommentsForItem:function(e,t,n){var r=m(!1,"getCommentsForItem",{itemID:e,typeID:t,page:n});return r.send()},getRecentCommentsForItems:function(e,t,n){var r=m(!1,"getRecentCommentsForItems",{itemIDs:e,typeID:t,minNeeded:n});return r.send()},reportComment:function(e){var t=m(!1,"reportComment",{commentID:e});return t.send()},deleteComment:function(e,t,n,r){var i=m(!1,"deleteComment",{commentID:e,fromArtistID:t,itemID:n,typeID:r});return i.send()},deleteCommentFromMyPage:function(e,t,n){var r=m(!1,"deleteCommentFromMyPage",{commentID:e,itemID:t,typeID:n});return r.send()},storeCommentForItem:function(e,t,n){var r=m(!1,"storeCommentForItemExt",{itemID:e,typeID:t,message:n});return r.send()},storeResponseToComment:function(e,t,n,r){var i=m(!1,"storeResponseToCommentExt",{commentID:e,itemID:t,typeID:n,message:r});return i.send()},reportResponseToComment:function(e,t){var n=m(!1,"reportResponseToComment",{responseID:t,commentID:e});return n.send()},deleteResponseToComment:function(e,t,n){var r=m(!1,"deleteResponseToComment",{responseID:t,commentID:e,fromArtistID:n});return r.send()},deleteResponseToCommentFromMyPage:function(e,t,n,r){var i=m(!1,"deleteResponseToCommentFromMyPage",{responseID:t,commentID:e,itemID:n,typeID:r});return i.send()},updateNotificationReadTime:function(){var e=m(!1,"updateNotificationReadTime",{});return e.send()},getClaimHistory:function(){var e=m(!1,"getClaimHistory",{});return e.send()},nautilusFetchSubscriptionStatusEx:function(){var e=m(!1,"nautilusFetchSubscriptionStatusEx",{},null,!0);return e.send()},nautilusCancelCurrentSubscriptionEx:function(){var e=m(!1,"nautilusCancelCurrentSubscriptionEx",{},null,!0);return e.send()},paypalInitPaymentEx:function(e,t,n,r,i){var s=m(!1,"paypalInitPaymentEx",{amount:e,tax:t,subType:n,description:r,responseProtocol:i},null,!0);return s.send()},promoSubscribeEx:function(e){var t=m(!1,"promoSubscribeEx",{promoCode:e},null,!0);return t.send()},verifyPromoCode:function(e){var t=m(!1,"verifyPromoCode",{code:e},null,!0,!1);return t.send()},purchasePromoCode:function(e,t,n){var r=m(!1,"purchasePromoCode",{numMonths:e,amount:t,cardInfo:n},null,!0);return r.send()},emailPromoCode:function(e,t){var n=m(!1,"emailPromoCode",{code:t,email:e});return n.send()},getUserSpecialPricing:function(){var e=m(!1,"getUserSpecialPricing",{});return e.send()},getUserSpecialPricingEx:function(){var e=m(!1,"getUserSpecialPricingEx",{},null,!0);return e.send()},getUserPricing:function(){var e=m(!1,"getUserPricing",{});return e.send()},getUserFreeCodes:function(){var e=m(!1,"getUserFreeCodes",{});return e.send()},userSawPendingNotification:function(e){var t=m(!1,"userSawPendingNotification",{notificationName:e});return t.send()},getChatSignedUserData:function(){var e=m(!1,"getChatSignedUserData",{});return e.send()},reportBadAd:function(e,t,n,r,i){var s=m(!1,"reportBadAd",{placement:e,desc:t,info:n,type:r,itemID:i});return s.send()},getCallout:function(e){var t=m(!1,"getCallout",{calloutID:e});return t.send()},getUserCallouts:function(e){var t=m(!1,"getUserCallouts",{userID:e});return t.send()},updateCalloutDetails:function(e,t){var n=m(!1,"updateCalloutDetails",{calloutID:e,name:t});return n.send()},deleteCallout:function(e){var t=m(!1,"deleteCallout",{calloutID:e});return t.send()},modifyCustomArtistTags:function(e,t){var n=m(!1,"modifyCustomArtistTags",{artistID:e,tags:t});return n.send()},artistDeleteAlbum:function(e,t){var n=m(!1,"artistDeleteAlbum",{albumID:e,deletePrimarySongs:t});return n.send()},logGuts:function(e,t){var n=m(!1,"logGuts",{data:e},t);return n.send()},sendRealtimeBroadcastInvite:function(e,t){var n=m(!1,"sendRealtimeBroadcastInvite",{recipientUserID:e,broadcastID:t});return n.send()},getPastBroadcastInvites:function(){var e=m(!1,"getPastBroadcastInvites");return e.send()},sendEmailBroadcastInvites:function(e,t,n){var r=m(!1,"sendEmailBroadcastInvites",{recipientUserIDs:e,broadcastID:t,message:n});return r.send()},getArtistsFromName:function(e){var t=m(!0,"getArtistsFromName",{name:e});return t.send()},deleteFeedEvents:function(){var e=m(!1,"deleteFeedEvents");return e.send()},getCommentsAndFanUpdateForArtist:function(e,t){var n=m(t?!1:180,"getCommentsAndFanUpdateForArtist",{artistID:e});return n.send()},getInterestingPeople:function(){var e=m(!1,"getInterestingPeople");return e.send()},getSampleArtistsFromTagIDs:function(e){var t=m(!1,"getSampleArtistsFromTagIDs",{tagIDs:e});return t.send()},getGroovesharkUsersFromTwitterUserIDs:function(e){var t=m(!1,"getGroovesharkUsersFromTwitterUserIDs",{twitterUserIDs:e});return t.send()},getTwitterFriends:function(e,t,n){var r=m(!1,"getTwitterFriends",{twitterUserID:e,oauthToken:t,oauthSecret:n});return r.send()},logPlaylistPlayEvent:function(e,t,n){var r=m(!1,"logPlaylistPlayEvent",{playlistID:e,metadata:t,isOwnPlaylist:n});return r.send()},logBroadcastPlayEvent:function(e,t){var n=m(!1,"logBroadcastPlayEvent",{broadcastID:e,metadata:t});return n.send()},logAlbumPlayEvent:function(e){var t=m(!1,"logAlbumPlayEvent",{albumID:e});return t.send()},modifyCustomAlbumsTags:function(e,t){var n=m(!1,"modifyCustomAlbumsTags",{albumIDs:e,tags:t});return n.send()},modifyCustomSongsTags:function(e,t,n){var r=m(!1,"modifyCustomSongsTags",{songIDs:e,tags:t,removeCustomTags:n});return r.send()},getRecentBroadcastsPlaylistsUsers:function(){var e=m(300,"getRecentBroadcastsPlaylistsUsers",{});return e.send()},feeds3GetMaterialization:function(e,t,n,r,i,s){var o=t&&t.length==0?null:t,u={lastCursor:e,tagIDs:o,filterFollowingByTag:n,types:r,followingOnly:i,skipCache:s},a=m(!1,"feeds3GetMaterialization",u);return a.send()},feeds3ItemIDsViewed:function(e,t){var n=m(!1,"feeds3ItemIDsViewed",{itemIDs:e,recommendationIDs:t});return n.send()},feeds3LikeItem:function(e){var t=m(!1,"feeds3LikeItem",{itemID:e});return t.send()},feeds3UnlikeItem:function(e){var t=m(!1,"feeds3UnlikeItem",{itemID:e});return t.send()},feeds3DeleteItem:function(e){var t=m(!1,"feeds3DeleteItem",{itemID:e});return t.send()},feeds3ItemIDBadlyTagged:function(e){var t=m(!1,"feeds3ItemIDBadlyTagged",{itemID:e});return t.send()},feeds3HideItemID:function(e){var t=m(!1,"feeds3HideItemID",{itemID:e});return t.send()},feeds3GetFeedItemsByIDs:function(e){var t=m(!1,"feeds3GetFeedItemsByIDs",{itemIDs:e});return t.send()},feeds3GetUserShares:function(e,t,n){var r=m(!1,"feeds3GetUserShares",{userID:e,limit:t||25,lastTSAdded:n});return r.send()},getAliveRecentBroadcastsForUser:function(){var e=m(!1,"getAliveRecentBroadcastsForUser",{});return e.send()},changeUserPreferences:function(e,t,n,r,i,s){var o=m(!1,"changeUserPreferences",{appSettings:e,playerSettings:t,privacySettings:n,notificationPrefs:r,oldNotificationPrefs:i,locale:s});return o.send()},updateUserCommentsRestriction:function(e){var t=m(!1,"updateUserCommentsRestriction",{restriction:e});return t.send()}}}(),function(){function y(){if(!p||!p.state()=="pending")p=$.Deferred(),X.chatReady=p.promise()}function b(e){this.logger||(this.logger=[]),this.logger.length>a&&this.logger.splice(0,a*.2),this.logger.push([e,_.rest(arguments)])}function w(e){var t=0,n=e.length,r;for(r=0;r<n;r++)e[r]&&(t+=e[r].weight||1);var i=Math.floor(Math.random()*t),s;t=0;for(r=0,n=e.length;r<n;r++){if(!e[r])continue;s=t,t+=e[r].weight||1;if(s<=i&&t>i)return e[r]}return e[0]}function E(e,t,n){var r=_.indexOf(t,e);r>-1&&t.splice(r,1),r=_.indexOf(n,e),r==-1&&n.push(e),e.lastFailedTime=Date.now()}function S(e,t,r){var i=new U(this,"identify",t);return i.done(_.bind(function(t){if(!t||!t.success||!t.success.id){this.verificationStatus>0&&this.verificationStatus===1&&(this.commandsOnConnectQueue.push.apply(this.commandsOnConnectQueue,this.commandsSentWhileIdentifyAssumption),this.commandsSentWhileIdentifyAssumption=[]);if(r){e.reject(t.error);return}!t.error||t.error=="bad_session"||t.error=="dead"?x.call(this,!0).done(function(t){e.resolve(t),n.trigger("manatee:identified")}).fail(function(t){e.reject(t)}):e.reject(t.error)}var i=t.success,s=this.user.get("isLoggedIn")?this.user.id:0,o=i&&i.id||{};o.userid&&(o.userid=_.toInt(o.userid)),o.artistid&&(o.artistid=_.toInt(o.artistid));if(!this.user&&o.userid>0||s!=o.userid){b.call(this,m.ERROR,"Invalid userID returned from manatee!",this.user,o),e.reject("Invalid userID returned from manatee!");return}this.lastUserID=this.userID,this.lastUUID=this.uuid,this.userID=i.id.userid,this.uuid=i.id.uid,i.id.userid?b.call(this,m.LOG,"We are identified!! UUID:"+this.uuid+" User:"+i.id.userid):b.call(this,m.LOG,"We are identified!! UUID:"+this.uuid+" User: logged out"),this.verificationStatus=2,F.call(this,this.commandsOnConnectQueue)&&this.commandsOnConnectQueue.splice(0,this.commandsOnConnectQueue.length),this.commandsSentWhileIdentifyAssumption=[],(this.lastUserID!==i.id.userid||this.lastUUID!==i.id.uid)&&T.call(this),e.resolve(t.success),n.trigger("manatee:identified")},this)).fail(_.bind(e.reject,e)),j.call(this,i,!0),e.promise()}function x(e,t){if(!this.socket||!this.socket.isOpen()||this.verificationStatus>1&&!t||this.verificationStatus===1&&!e)return $.Deferred().reject().promise();this.verificationStatus=1;if(!t&&this.identifyDfd&&this.identifyDfd.state()==="pending")return this.identifyDfd.promise();var n={sessionid:gsConfig.sessionID,invisible:this._invisible},r=$.Deferred();return p&&r.done(_.bind(p.resolve,p)).fail(_.bind(p.reject,p)),r.fail(_.bind(function(){this.verificationStatus=0},this)),this.identifyDfd=r,this.user&&this.user.get("isLoggedIn")?(n.userid=String(this.user.get("UserID")),n.app_data=this.user.get("chatUserData"),n.app_sig=this.user.get("chatUserDataSig"),e||!n.app_data||!n.app_sig||this.user.get("chatUserDataSigExpires")<Date.now()?this.user.refreshChatUserData().done(_.bind(function(){n.app_data=this.user.get("chatUserData"),n.app_sig=this.user.get("chatUserDataSig"),S.call(this,r,n,e)},this)).fail(_.bind(r.reject,r)):S.call(this,r,n,e)):S.call(this,r,n,e),r.promise()}function T(){if(this.verificationStatus<1)return;this.updateChannelList(),this.updateMonitorChannelList(),this.updateMonitorUserList();if(!this.isPrimary)return;var e=[{sub:"global",overwrite_params:!1,create_when_dne:!0,try_to_own:!1}],t,r;this.user.get("isLoggedIn")?(this.userInfoKeyUpdate(),t=this.user.id,r="user:"+t,e.push(r),this.statusTimer.reset(),this.statusTimer.start()):this.statusTimer.stop();var i=this.subscribeToChannels(e),s=this;i.command&&i.command.done(function(e){if(e.type!=="success"||!e.success)return;_.each(e.success,function(e){if(!e.sub)return;if(e.sub==="global")e.params&&e.params.a&&n.trigger("manatee:globalAlert",e.params.a);else if(r&&e.sub===r){if(!e.params||!e.params.owners)return;var i,o,u,a;for(o=0,u=e.params.owners.length;o<u;o++)if(e.params.owners[o].type==="userid"&&e.params.owners[o].name==t){i=!0;break}i||(a=new U(s,"set",{sub:r,keyvals:[{key:"owners",value:[{type:"userid",name:String(t)}]},{key:"unsub_alert",value:!0}]},!0),j.call(s,a)||console.error("Failed to send 'set' on user's channel to change owners!"))}})}),N.call(this)}function N(){if(!this.user.get("isLoggedIn"))return;var t=this.user.getCurrentStatus();this.receivedRestore=!1,t.done(_.bind(function(t){var r;b.call(this,m.LOG,"RESTORE",t),this.receivedRestore=!0;if(t&&!t.error){r=Date.now()+(e.clientTimeDivergence||0);if(!t.bcastOwner&&(!t.status||r-t.time>n.Models.User.MAX_ONLINE_IDLE_TIME||!t.songEx))k.call(this);else{var i=this.loggedInMaster?this.loggedInMaster.uuid:null;this.loggedInMaster={uuid:null,lastMouseMove:t.time,lastUpdate:t.time,currentBroadcast:t.bcast?t.bcast:null,isBroadcasting:t.bcastOwner?1:0,currentlyPlayingSong:t.songEx?1:0,remora:_.toInt(t.remora||0)},!t.remora&&r-t.time>c||t.remora&&r-t.time>h?C.call(this):i&&(i==this.uuid||i==this.lastUUID)&&k.call(this)}}else k.call(this)},this))}function C(){if(!this.receivedRestore)return;if(!this.masterWaitingTimer)this.masterWaitingTimer=new Timer(f,1),this.masterWaitingTimer.on("timer",function(){k.call(this)},this);else{if(this.masterWaitingTimer.running)return;this.masterWaitingTimer.reset()}this.publishToSelf("masterPing",null),this.masterWaitingTimer.start()}function k(){if(!this.user.get("isLoggedIn")||!this.isPrimary)return;var t=Date.now()+(e.clientTimeDivergence||0);if(this.loggedInMaster&&this.loggedInMaster.remora&&t-this.loggedInMaster.lastUpdate<=h)return;this.loggedInMaster=O.call(this),this.loggedInMaster.lastUpdate=t,A.call(this),this.publishToSelf("masterPromotion",this.loggedInMaster)}function L(){if(this._invisible||!this.user||this.user.id<=0||this.verificationStatus<1)return;var t=r.model.get("player"),n=t.get("queue"),i=n&&n.get("currentBroadcast")?n.get("currentBroadcast").id:null,s=!!n&&!!n.get("isBroadcasting"),o=!!this.currentSong;if(s)return;if(this.loggedInMaster&&this.loggedInMaster.uuid===this.uuid){var u=!!this.loggedInMaster.currentlyPlayingSong,a=!!this.loggedInMaster.isBroadcasting;if(s!==a||i!=this.loggedInMaster.currentBroadcast||o!==u){k.call(this);return}A.call(this);return}var f=Date.now()+(e.clientTimeDivergence||0),c=r.lastActive+(e.clientTimeDivergence||0),h=this.loggedInMaster&&c-this.loggedInMaster.lastMouseMove>l;h&&this.loggedInMaster.isBroadcasting&&f-this.loggedInMaster.lastUpdate<l&&(h=!1),(!this.loggedInMaster||s||h||i&&!this.loggedInMaster.isBroadcasting||this.currentSong&&!this.loggedInMaster.currentBroadcast)&&k.call(this)}function A(e){e=_.orEqual(e,!1);if(this.user.id<=0||this.verificationStatus<1||!this.loggedInMaster||this.loggedInMaster.uuid!==this.uuid||!this.isPrimary)return;var t=M.call(this),r={key:"s",value:t},i={type:"statusUpdate",params:t,sessionPart:n.Services.API.sessionPart},s,o,u;e&&this._visibleToUserIDs&&(o=_.clone(r),o.value.visible=this._visibleToUserIDs,s=new U(this,"set",{keyvals:[o]},!0),j.call(this,s));if(this._invisible)r.readable=[];else if(this._onlyVisibleToFriends){var a=[];_.each(this._onlyVisibleToFriends,function(e){a.push({type:"userid",name:e.toString()})}),r.readable=a}else r.readable="global";u={keyvals:[r],userid:this.user.id.toString()},s=new U(this,"set",u,!0),j.call(this,s),u={type:"data",value:i,subs:[{type:"sub",name:"user:"+this.user.id}]},s=new U(this,"pub",u,!0),j.call(this,s)}function O(){var t=r.model.get("player"),n=t.get("queue"),i=n&&n.get("currentBroadcast");return{uuid:this.uuid,isBroadcasting:n&&n.get("isBroadcasting")?1:0,currentBroadcast:i?i.id:null,currentlyPlayingSong:t.playStatusIsPlaying(!0)?1:0,lastMouseMove:r.lastActive+(e.clientTimeDivergence||0)}}function M(t){t=_.orEqual(t,!0);var n=r.model.get("player"),i=n.get("queue"),s=i&&i.get("currentBroadcast"),o=s&&s.get("ownerModel"),u=this.currentSong,a=Date.now()+(e.clientTimeDivergence||0),f,l;return!u||this._invisible||this._ignoreSongChanges&&!o?u=null:f={SongID:u.id,SongName:u.get("SongName"),AlbumName:u.get("AlbumName"),AlbumID:u.get("AlbumID"),ArtistName:u.get("ArtistName"),ArtistID:u.get("ArtistID"),CoverArtFilename:u.get("CoverArtFilename"),TrackNum:u.get("TrackNum"),Flags:u.get("Flags"),EstimateDuration:u.get("EstimateDuration")},l={status:1,time:a,songEx:u?u.toManateeProperties():null},t&&(l.song=f),s&&s.get("ownerSubscribed")&&(l.bcast=s.id,l.bcastName=s.get("Name"),l.bcastPic=s.get("Image"),s.isLoggedInUserOwner()?l.bcastOwner=1:(l.bcastOwner=0,o&&(l.bcastOwnerInfo={u:!0,n:o.get("Name"),i:o.id,p:o.get("Picture")}))),l}function D(e){var t=e;return typeof t!="string"&&(t instanceof U?t=t.text:t=$.stringify(t)),t?(t[t.length-1]!=="\n"&&(t+="\n"),t):(b.call(this,m.LOG,"got bad manatee data!!",e),!1)}function P(){var e=this.lazyDataQueue.length;e>0&&j.call(this,this.lazyDataQueue.splice(0,e).join(""))}function H(e){var t=D(e);if(this.lazyTimeout&&t){this.lazyDataQueue.push(t);return}this.lazyTimeout=setTimeout(_.bind(P,this),1e3)}function B(e){e instanceof U&&this.commandsOnConnectQueue.push(e)}function j(e,t){var n=!1,r;if(!this.socket||!this.socket.isOpen())return B.call(this,e),!0;r=D(e);if(!r)return!1;if(!t&&this.verificationStatus<1){x.call(this);if(this.verificationStatus<1)return!1}else!t&&this.verificationStatus===1&&e instanceof U&&this.commandsSentWhileIdentifyAssumption.push(e);return _.isArray(e)&&b.call(this,m.WARN,"got array for sendCommand commands",e),this.socket.readyState===g.CONNECTING?(B.call(this,e),!0):(this.socket.isOpen()&&(n=this.socket.write(r),n&&(this.lastSocketWrite=Date.now(),e instanceof U&&e.setIsSent(!0))),n)}function F(e,t){var n=[],r,i,s,o;for(s=0,o=e.length;s<o;s++)i=D(e[s]),n.push(i);if(!n.length)return!0;r=j.call(this,n.join(""),t);if(r)for(s=0,o=e.length;s<o;s++)e[s].setIsSent(!0);return r}function I(e){var t=["ws://",e.host,":","80","/ws"].join(""),r;this.server=e;try{r=new WebSocket(t)}catch(i){console.log("failed to connect via WebSockets",i),n.Services.Log.notify(i,null,{webSocket:!0}),this.trigger("error",this,i),o=!1;return}this.rawSocket=r,this.rawSocket.onerror=_.bind(this._handleEvent,this,"error"),this.rawSocket.onopen=_.bind(this._handleEvent,this,"open"),this.rawSocket.onclose=_.bind(this._handleEvent,this,"close"),this.rawSocket.onmessage=_.bind(this._handleEvent,this,"message"),Object.defineProperty?Object.defineProperty(this,"readyState",{configurable:!0,enumerable:!0,get:function(){return r.readyState},set:function(){}}):this.__defineGetter__("readyState",function(){return r.readyState})}function q(e,t){this.server=e,this.readyState=0,this.socketID=null,b.call(this,m.LOG,"Attempting flash socket connection to "+e.host+":"+e.port),this._swf=t;var n=this._swf.createStrippedSocket(e);if(!n||n==-1)return;this.socketID=n,q.socketEvents.on(n,this.onSocketData,this)}function U(e,t,n,r,i){this.manatee=e,this.id=R++,this.successCallbacks=null,this.failCallbacks=null,this.canRetry=r,this.sent=!1,this._state="pending",i||(i={}),i._cid=this.id,this.text=D({command:t,params:n,blackbox:i}),this.result=null,this.register()}function z(e,t,n){this.manatee=e,this._listeners=[],this._keys=t?_.toArray(t):null,this._state=1,this._options=n}function W(e,t){this.manatee=t,this._listeners=[],this._locks=[],this._forceStatusLocks=[],this._isMetaSubbed=!1,this._isStatusSubbed=!1,this.userID=e,this._isOnline=!1}function X(e,t){this.availableServers=e,this.failedServers=[],this.isPrimary=_.orEqual(t,!0),this.socket=null,this.lastSocketWrite=0,this.lazyTimeout=0,this.currentChannels={},this.currentChannelsMonitors={},this.currentUserMonitors={},this.dirtyChannelList=!1,this.dirtyMonitorChannelList=!1,this.dirtyMonitorUserList=!1,this.lazyDataQueue=[],this.registeredCommands={},this.loggedInMaster=null,this.connected=!1,this.connects=0,this.destroyed=!1,this.listeningToMouseMove=!1,this.uuid=null,this.lastUUID=null,this.verificationStatus=0,this.commandsOnConnectQueue=[],this.commandsSentWhileIdentifyAssumption=[],this.reconnectTimer=new Timer((Math.floor(Math.random()*5)+5)*1e3,1),this.reconnectTimer.on("complete",this.onReconnectTimer,this),this.failedToConnectTimer=new Timer(7e3,1),this.failedToConnectTimer.on("complete",this.onFailedToConnect,this),this.pingSocketTimer=new Timer(25e3),this.pingSocketTimer.on("timer",this.pingSocket,this),this.statusTimer=new Timer((300+Math.floor(Math.random()*60))*1e3),this.statusTimer.on("timer",this.periodicStatusUpdate,this)}n.Services=n.Services||{};var i=!1,s=!!e.WebSocket,o=s,u=n.Services.Local.get("failedWebSockets"),a=100,f=5e3,l=9e5,c=1e4,h=3e5,p,d,v,m,g;u&&(o=!1),m={ERROR:3,WARN:2,INFO:1,LOG:0},g={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},_.extend(I.prototype,Backbone.Events,{isOpen:function(){return this.rawSocket.readyState===g.OPEN},write:function(e){try{this.rawSocket.send(e)}catch(t){return b.call(this,m.ERROR,"could not send data on WebSocket",t),n.Services.Log.notify(t,"ERROR",{readyState:this.rawSocket.readyState}),!1}return!0},close:function(){return this.rawSocket.close()},destroy:function(){this.close(),this.rawSocket.onerror=null,this.rawSocket.onopen=null,this.rawSocket.onclose=null,this.rawSocket.onmessage=null,this.rawSocket=null},_handleEvent:function(e,t){switch(e){case"open":case"close":this.trigger(e,this,t.reason);break;case"error":this.trigger(e,this,t);break;case"message":this.trigger(e,this,t.data)}}}),q.socketEvents=_.extend({},Backbone.Events),_.extend(q.prototype,Backbone.Events,{isOpen:function(){return this.readyState===g.OPEN},write:function(e){return this.socketID===null||this.readyState!==g.OPEN?!1:this._swf.writeToStrippedSocket(this.socketID,e)},close:function(){if(this.socketID===null)return;this.readyState<2&&(this.readyState=2,this._swf.closeStrippedSocket(this.socketID))},destroy:function(){if(this.socketID===null)return;this.close(),this._swf.destroyStrippedSocket(this.socketID),q.socketEvents.off(null,null,this),this.socketID=null},onSocketData:function(e,t){b.call(this,m.LOG,"onSocketData",e,t),e==="open"?this.readyState=1:e==="close"&&(this.readyState=3),this.trigger(e,this,t)}});var R=1;_.extend(U.prototype,{updateCommand:function(e,t,n){n||(n={}),n._cid=this.id,this.text=D({command:e,params:t,blackbox:n})},setIsSent:function(e){this.sent=e},register:function(){this.manatee.registeredCommands[this.id]=this},unregister:function(){delete this.manatee.registeredCommands[this.id]},resolve:function(e){this.result=e,this._state="resolved",this.unregister();if(this.successCallbacks!==null){for(var t=0;t<this.successCallbacks.length;t++)typeof this.successCallbacks[t]=="function"&&this.successCallbacks[t](e);this.successCallbacks=null}return this.failCallbacks=null,this},reject:function(e){if(this.canRetry){this.canRetry=!1,j.call(this.manatee,this,!0);return}this.result=e,this._state="rejected",this.unregister();if(this.failCallbacks!==null){for(var t=0;t<this.failCallbacks.length;t++)typeof this.failCallbacks[t]=="function"&&this.failCallbacks[t](e);this.failCallbacks=null}return this.successCallbacks=null,this},done:function(e){return this._state==="resolved"?e(this.result):this._state==="pending"&&(this.successCallbacks===null?this.successCallbacks=[e]:this.successCallbacks.push(e)),this},fail:function(e){return this._state==="rejected"?e(this.result):this._state==="pending"&&(this.failCallbacks===null?this.failCallbacks=[e]:this.failCallbacks.push(e)),this},then:function(e,t){return typeof e=="function"&&this.done(e),typeof t=="function"&&this.fail(t),this},state:function(){return this._state},promise:function(){return this},progress:function(){return this}}),_.extend(z.prototype,{listen:function(e){if(!this._listeners||!_.isFunction(e))return;this._listeners.push(e)},removeListener:function(e){if(!this._listeners||!_.isFunction(e))return;var t=_.indexOf(this._listeners,e);t!==-1&&this._listeners.splice(t,1)},trigger:function(){var e=this._listeners&&this._listeners.length,t;if(!e)return;t=_.toArray(arguments);while(e--)this._listeners[e].apply(this,t)},stop:function(e){var t=this.manatee,n=this._keys;this._listeners=null,this._keys=null,this._options=null,this.manatee=null,this._state=0,t&&!e&&(_.isArray(n)?t.removeChannelMonitor(this):t.removeChannel(this))},getState:function(){return this._state},getKeys:function(){return this._keys||[]},getOptions:function(){return this._options||{}}}),_.extend(W.prototype,{monitorsByLockName:{},listen:function(e){if(!this._listeners||!_.isFunction(e))return;this._listeners.push(e)},trigger:function(){var e=this._listeners&&this._listeners.length,t;if(!e)return;t=_.toArray(arguments);while(e--)this._listeners[e].apply(this,t)},setOnlineStatus:function(e,t){this._isOnline=e;if(this._isOnline&&!this._isStatusSubbed||!this._isOnline&&this._isStatusSubbed&&!this._forceStatusLocks.length)this.manatee.dirtyMonitorUserList=!0,t||this.manatee.updateMonitorUserList();this._isOnline||this.updateStatus({status:0,time:Date.now()})},updateStatus:function(e){var t=Date.now();e.hasOwnProperty("time")&&t-e.time>n.Models.User.MAX_ONLINE_IDLE_TIME?e={status:0,time:t}:e.hasOwnProperty("songEx")&&(e.song=n.Models.Song.convertManateeSongCalloutProperties(e.songEx),delete e.songEx);var r=n.Models.User.getCached(this.userID);if(!r){_.isUndefined(n.Models.User.getUserStatusDfds[this.userID])||n.Models.User.getUserStatusDfds[this.userID].resolve(e,this.userID);return}r.updateStatusFromManatee(e)},addLock:function(e,t,n){_.indexOf(this._locks,e)===-1&&this._locks.push(e),t&&_.indexOf(this._forceStatusLocks,e)===-1&&this._forceStatusLocks.push(e),this.monitorsByLockName[e]||(this.monitorsByLockName[e]=[]),_.indexOf(this.monitorsByLockName[e],this)===-1&&this.monitorsByLockName[e].push(this),t&&!this._isStatusSubbed&&(this.manatee.dirtyMonitorUserList=!0,n||this.manatee.updateMonitorUserList())},removeLock:function(e,t){var n=_.indexOf(this._locks,e),r=this.manatee;n!==-1&&this._locks.splice(n,1),n=_.indexOf(this._forceStatusLocks,e),n!==-1&&this._forceStatusLocks.splice(n,1),this.monitorsByLockName[e]&&(n=_.indexOf(this.monitorsByLockName[e],this),n!==-1&&this.monitorsByLockName[e].splice(n,1)),this._locks.length===0?(this._listeners=null,this.manatee=null,r&&(r.dirtyMonitorUserList=!0,t||r.updateMonitorUserList())):this._isStatusSubbed&&this._forceStatusLocks.length===0&&!this._isOnline&&r&&(r.dirtyMonitorUserList=!0,t||r.updateMonitorUserList())}}),_.extend(X.prototype,Backbone.Events,{destroy:function(){this.removeSocket(),this.reconnectTimer&&(this.reconnectTimer.reset(),this.reconnectTimer.off(null,null,this)),this.failedToConnectTimer&&(this.failedToConnectTimer.reset(),this.failedToConnectTimer.off(null,null,this)),this.pingSocketTimer&&(this.pingSocketTimer.reset(),this.pingSocketTimer.off(null,null,this)),this.retryCommandsTimer&&(this.retryCommandsTimer.reset(),this.retryCommandsTimer.off(null,null,this)),this.statusTimer&&(this.statusTimer.reset(),this.statusTimer.off(null,null,this)),this.stopListening(),$("body").off("mousemove.manatee"),this.listeningToMouseMove=!1,this.destroyed=!0},cleanup:function(){this.isPrimary=!1,this.stopListening(),this.destroy()},setUser:function(e){var n=!1,r;if(e===this.user)return;this.user!==t&&e!==this.user&&(this.user.off(null,null,this),this.user.get("favoriteUsers")&&this.user.get("favoriteUsers").off(null,null,this),n=this.user.id!==e.id,n&&this.user.id>0&&(r="user:"+this.user.id,this.currentChannels.hasOwnProperty(r)&&(this.unsubscribeFromChannels([r],!0),this.dirtyChannelList=!0))),this.user=e,this.receivedRestore=!1,this.loggedInMaster=null,this.listenTo(e,"change:Name change:Picture change:IsPremium",this.onUserAttributesChangePreDebounce),this.listenTo(e,"change:sessionPrivacy change:favoriteUsers",this.onUserAttributesChange),this.pendingChangedAttributes={},this.userPrivacyUpdate(),n&&this.isPrimary&&(this.verificationStatus=0,y(),x.call(this,!1,!0).fail(_.bind(function(e){this.verificationStatus=0,this.trigger("identifyFailed",e)},this)))},onUserAttributesChangePreDebounce:function(e){_.extend(this.pendingChangedAttributes,e.changed),this.onUserAttributesChange(e)},onUserAttributesChange:_.debounce(function(e){var t=this.pendingChangedAttributes;this.pendingChangedAttributes={},this.handleAttributesChange(e,t)},3e3,{leading:!0}),handleAttributesChange:function(e,t){var n=t||e.changed,r=!1,i=!1,s=!1,o,u,a;for(o in n){if(!n.hasOwnProperty(o))continue;switch(o){case"Name":case"Picture":case"IsPremium":r=!0;break;case"sessionPrivacy":i=!0;break;case"favoriteUsers":i=!0,s=!0,u=e.previous("favoriteUsers"),u&&this.stopListening(u),a=e.get("favoriteUsers"),a&&this.listenTo(a,"add remove reset",this.userFriendsChanged)}}r&&(this.userInfoKeyUpdate(),this.verificationStatus=0,x.call(this)),i&&this.userPrivacyUpdate(s)},userFriendsChanged:function(){this.userPrivacyUpdate(!0)},userPrivacyUpdate:function(e){if(!this.user)return;var t=this.user.get("sessionPrivacy"),n=this.user.get("favoriteUsers"),r=(t&10)>0,i=!r&&(t&4)>0;this._ignoreSongChanges=(t&1)>0,n&&(r!==this._onlyVisibleToFriends||e)&&(this._visibleToUserIDs=n.pluck("UserID"),e=!0),this._onlyVisibleToFriends=r,i!==this._invisible?(this._invisible=i,x.call(this,!1,!0)):A.call(this,e)},userInfoKeyUpdate:function(){if(!this.user||!this.user.get("isLoggedIn"))return;var e={n:this.user.get("Name"),p:this.user.get("Picture")};this.setUserKey("i",e)},setUserKey:function(e,t){if(!this.user||!this.user.get("isLoggedIn"))return;var n={keyvals:[{key:e,value:t,readable:"global"}]},r=new U(this,"set",n,!0);return j.call(this,r),r.promise()},setCurrentSongStatus:function(e,t){if(!this.isPrimary)return;var r=!1;n.Models.Player.isPlayStatusPlaying(t)?(e!==this.currentSong&&(this.currentSong=e,r=!0),this.stopActiveSongStoppedTimer()):t===n.Models.Player.playStatuses.PAUSED?this.startActiveSongStoppedTimer(!0):this.startActiveSongStoppedTimer(!1),this.user&&!this._invisible&&r&&L.call(this)},startActiveSongStoppedTimer:function(e){var t=(e?1:120)*1e3;this.activeSongStoppedTimer?(this.activeSongStoppedTimer.reset(),this.activeSongStoppedTimer.delay=t):(this.activeSongStoppedTimer=new Timer(t,1),this.activeSongStoppedTimer.on("timer",this.markActiveSongStopped,this)),this.activeSongStoppedTimer.start()},stopActiveSongStoppedTimer:function(){this.activeSongStoppedTimer&&this.activeSongStoppedTimer.reset()},markActiveSongStopped:function(){var e=this.currentSong?this.currentSong.get("playStatus"):0;n.Models.Player.isPlayStatusPlaying(e)||(this.currentSong=null,this.user&&!this._invisible&&L.call(this))},setServers:function(e){this.availableServers=e,this.failedServers=[];if(this.socket){var t=this.socket.server,n=!1;for(var r=0,i=e.length;r<i;r++)if(e[r]&&e[r].host==t.host&&e[r].port==t.port){n=!0;break}n||this.reconnect()}},removeSocket:function(){if(this.socket){this.connected&&(this.connected=!1,this.isPrimary&&n.trigger("manatee:disconnected"),this.trigger("disconnected"));var e=this.socket;this.socket=null,this.stopListening(e),e.destroy(),this.userID=null,this.uuid=null,this.dirtyChannelList=!0,this.dirtyMonitorChannelList=!0,this.dirtyMonitorUserList=!0}},storeServerOutage:function(e){e<30&&(e=30);var t=e*1e3;t+=Math.random()*Math.min(6e4,t),b.call(this,m.LOG,"Manatee going down for "+e+" seconds, waiting for "+t+" milliseconds."),v?(v.reset(),v.delay=t):(v=new Timer(t,1),v.on("timer",this.onOutageTimer,this)),v.start()},onOutageTimer:function(){if(this.socket&&this.socket.connected)return;v.off(null,null,this),v=null,this.reconnect(!0,!0)},reconnect:function(e,t){this.listeningToMouseMove&&($("body").off("mousemove.manatee"),this.listeningToMouseMove=!1);if(!e&&(this.socket&&!this.socket.isOpen()||this.failedToConnectTimer&&this.failedToConnectTimer.running))return;if(v&&v.running)return;this.reconnectTimer&&this.reconnectTimer.stop();if(t||!this.availableServers.length)this.availableServers.push.apply(this.availableServers,this.failedServers),this.failedServers=[];this.removeSocket();var r=w(this.availableServers);if(!r){b.call(this,m.ERROR,"Couldn't connect to Manatee server. No available servers!"),this.trigger("connectionError",{type:"noServersAvailable"}),b.call(this,m.LOG,"No more servers available");return}o?(this.socket=new I(r),this.listenTo(this.socket,"error",this.onSocketError),this.listenTo(this.socket,"open",this.onSocketOpen),this.listenTo(this.socket,"close",this.onSocketClose),this.listenTo(this.socket,"message",this.onSocketMessage),this.failedToConnectTimer.start()):(d||(d=_.getFlashObjectDfd("html5ShimSwf","createStrippedSocket").done(_.bind(function(e){e.setSocketEventCallback("GS.Services.Manatee.onSWFSocketEvent")},this))),d.done(_.bind(function(e){this.socket=new q(r,e),this.listenTo(this.socket,"error",this.onSocketError),this.listenTo(this.socket,"open",this.onSocketOpen),this.listenTo(this.socket,"close",this.onSocketClose),this.listenTo(this.socket,"message",this.onSocketMessage),this.failedToConnectTimer.start()},this)).fail(_.bind(function(){if(s)return;gsConfig.isMobile?amdModules.requireDeferred("gs/views/lightboxes/unsupportedBrowser.js").done(function(){n.trigger("lightbox:open","unsupportedBrowser")}):n.trigger("lightbox:open","flashRequired")},this)))},retryIdentify:function(e){if(!this.socket||!this.socket.isOpen()){this.reconnect(!0,e);return}if(this.verificationStatus>1)return;x.call(this,!1,!0).fail(_.bind(function(e){this.verificationStatus=0,this.trigger("identifyFailed",e)},this))},onFailedToConnect:function(){if(!this.socket||this.socket.readyState!==g.CONNECTING)return;this.onSocketClose(this.socket,"connectTimeout")},onSocketError:function(e){this.onSocketClose(e,"socketError")},onSocketClose:function(t,r){if(t!==this.socket)return;b.call(this,m.LOG,"Manatee socket closed! Reason: "+r),this.pingSocketTimer.reset(),this.failedToConnectTimer.reset(),this.reconnectTimer.reset(),this.trigger("connectionError",{type:r||"close"}),E(this.socket.server,this.availableServers,this.failedServers),this.removeSocket(),this.verificationStatus=0,this.availableServers.length>0?(this.reconnecting=!0,this.reconnectTimer.start()):o&&this.connects===0?(e.WebSocket&&!i&&n.Services.Log.notify("Failed to connect to any manatee servers over WebSockets","WARNING"),n.Services.Local.set("failedWebSockets",!0),o=!1,this.reconnect(!0,!0)):(this.reconnecting=!1,this.trigger("connectionError",{type:"noServersAvailable"}),b.call(this,m.LOG,"No more servers available"),setTimeout(_.bind(function(){!this.listeningToMouseMove&&!this.destroyed&&!this.isConnected()&&($("body").on("mousemove.manatee",_.bind(function(){!this.destroyed&&!this.isConnected()&&this.reconnect(!1,!0)},this)),this.listeningToMouseMove=!0)},this),Math.random()*1e4+1e4)),this.connected&&(this.connected=!1,this.isPrimary&&(n.trigger("manatee:disconnected"),this.trigger("disconnected")))},onReconnectTimer:function(){(!this.socket||!this.socket.connected||this.verificationStatus<-1)&&(!this.failedToConnectTimer||!this.failedToConnectTimer.running)&&this.reconnect()},onSocketOpen:function(e){var t;if(e!==this.socket)return;this.connected||(t=this.connects===0,o?i=!0:s&&t&&!u&&n.Services.Log.notify("Reconnected using flash after all servers failed on websockets","NOTIFY"),this.connected=!0,this.reconnecting=!1,this.isPrimary&&(n.trigger("manatee:connected",{initial:t}),this.trigger("connected",{initial:t})),this.connects++),this.failedToConnectTimer.reset(),b.call(this,m.LOG,"Connected to manatee!"),this.pingSocketTimer.start(),this.verificationStatus=0,_.defer(_.bind(function(){this.retryIdentify(),F.call(this,this.commandsOnConnectQueue)&&this.commandsOnConnectQueue.splice(0,this.commandsOnConnectQueue.length)},this))},onSocketMessage:function(e,t){var r=this.user&&this.user.id,i,s,o,u,a,f,l,c,h,p,d,v;try{i=$.parseJSON(t);if(!i)return}catch(g){b.call(this,m.ERROR,"Failed to parse Manatee message!",t);return}i.blackbox&&i.blackbox._cid&&(s=this.registeredCommands[i.blackbox._cid]),d=i.publish&&i.publish.id;switch(i.command+":"+i.type){case"push:logged_in":i.logged_in.type==="userid"&&(c=this.currentUserMonitors[i.logged_in.name],c&&c.setOnlineStatus(!0,!0));break;case"push:logged_out":i.logged_out.type==="userid"&&(c=this.currentUserMonitors[i.logged_out.name],c&&c.setOnlineStatus(!1,!0));break;case"push:key_change":if(i.key_change.hasOwnProperty("destination")||i.key_change.hasOwnProperty("sub")){o=i.key_change.destination||i.key_change.sub,u=this.currentChannelsMonitors[o];if(u&&u.length){h=u.length;while(h--)u[h].trigger(o,i.key_change.keyvals,i.key_change.id)}}else if(i.key_change.hasOwnProperty("userid")){l=i.key_change.userid,c=this.currentUserMonitors[l];if(c)for(h=0,p=i.key_change.keyvals.length;h<p;h++)if(i.key_change.keyvals[h].key==="s"){c.updateStatus(i.key_change.keyvals[h].value);break}}break;case"push:publish":o=i.publish.destination||i.publish.sub;if(o==="global"&&d&&d.sudo){v=i.publish.value;if(v)switch(v.messageType){case"serversUpdate":v.servers&&_.isArray(v.servers)&&(!v.test||gsConfig.runMode!=="production")&&this.setServers(v.servers);break;case"disableLogs":this.logsDisabled=!0;break;case"manateeGoingDown":(!publishData.duration||publishData.duration<1800)&&this.storeServerOutage(_.toInt(publishData.duration));default:n.trigger("manatee:globalAlert",v)}}else if(r>0&&o==="user:"+this.user.id&&d&&(d.userid==this.user.id||d.sudo))this.handleSelfMessage(i);else if(r>0&&o===""+r&&d&&(d.userid==this.user.id||d.sudo))this.user.onDirectUserManateePublish(i.publish.value);else{a=this.currentChannels[o];if(a&&a.length){h=a.length;while(h--)a[h].trigger(o,i.publish.value,d)}i.publish.value&&i.publish.value.messageType&&n.trigger("manatee:"+i.publish.value.messageType,i.publish.value,d)}break;case"push:sub_alert":o=i.sub_alert.destination||i.sub_alert.sub,a=this.currentChannels[o];if(a&&a.length){h=a.length;while(h--)a[h].trigger(o,i,i.sub_alert.id)}break;case"push:unsub_alert":o=i.unsub_alert.destination||i.unsub_alert.sub,a=this.currentChannels[o];if(a&&a.length){h=a.length;while(h--)a[h].trigger(o,i,i.unsub_alert.id)}break;case"push:subinfo_change":case"info:sub_list_with_extra":break;default:b.call(this,m.LOG,i)}s&&(s.resolve(i),b.call(this,m.LOG,"command",s)),this.dirtyMonitorUserList&&this.updateMonitorUserList()},handleSelfMessage:function(t){if(this.uuid===t.publish.id.uid||!this.isPrimary||!t.publish.value)return;var i=t.publish.value.params,s=Date.now()+(e.clientTimeDivergence||0),o=r.model.get("player");switch(t.publish.value.type){case"statusRequest":this.publishToSelf("statusReply",M.call(this));break;case"masterPing":this.loggedInMaster&&this.loggedInMaster.uuid===this.uuid&&this.publishToSelf("masterPong",O.call(this));break;case"masterPong":this.loggedInMaster=i,this.loggedInMaster.lastUpdate=s,this.masterWaitingTimer&&this.masterWaitingTimer.reset(),n.trigger("manatee:selfMasterStatus",{status:i,userID:this.user.id});break;case"masterElection":var u=r.lastActive+(e.clientTimeDivergence||0),a=o.playStatusIsPlaying(!0);(i.isBroadcasting||i.lastMouseMove>u&&(i.currentlyPlayingSong||!a))&&this.masterWaitingTimer&&this.masterWaitingTimer.reset();break;case"queueTransferRequest":var f=o.get("queue"),l=f&&f.get("isBroadcasting");i.uuid==this.uuid||i.hasOwnProperty("uuid")&&!i.uuid||i.isBroadcasting&&l;break;case"masterPromotion":var c=(!this.loggedInMaster||this.loggedInMaster.uuid==this.uuid)&&i.uuid!==this.uuid;this.loggedInMaster=i,this.masterWaitingTimer&&this.masterWaitingTimer.reset();if(this.loggedInMaster&&this.loggedInMaster.remora&&s-this.loggedInMaster.lastUpdate>h){this.loggedInMaster=null,b.call(this,m.LOG,"got a masterPromotion with old remora ts",i),C.call(this);return}this.loggedInMaster.lastUpdate=s,c,n.trigger("manatee:selfMasterStatus",{status:i,userID:this.user.id});break;case"queueTransferResponse":var p=[];if(i.songs&&_.isArray(i.songs))for(var d=0,v=i.songs.length;d<v;d++)p.push(n.Models.Song.convertManateeSongCalloutProperties(i.songs[d]));i.decodedSongs=p;case"statusUpdate":i.songEx&&(i.song=n.Models.Song.convertManateeSongCalloutProperties(i.songEx),delete i.songEx);default:}},isConnected:function(){return this.socket&&this.socket.isOpen()},isReconnecting:function(){return this.socket&&this.socket.readyState===g.CONNECTING},subscribeToChannels:function(e,t,n){var r=[],i=[],s,o,u,a,f;for(var l=0,c=e.length;l<c;l++){if(!e[l])continue;u={},typeof e[l]=="string"?(a=e[l],u.overwrite_params=!1):(a=e[l].sub,e[l].create_when_dne===!1&&(u.create_when_dne=!1),u.overwrite_params=!1);if(!a)continue;u.sub=a,f=this.currentChannels[a],o=new z(this,null,u),o.channelName=a,f||(f=this.currentChannels[a]=[]),n?this.currentChannels[a].unshift(o):this.currentChannels[a].push(o),r.push(o),i.push(u)}return t||(s=new U(this,"sub",{add:!0,subs:i}),j.call(this,s)||(s.reject({sendFailed:!0}),this.dirtyChannelList=!0)),{subscriptions:r,command:s}},inChannel:function(e){return this.currentChannels.hasOwnProperty(e)&&this.currentChannels[e].length},unsubscribeFromAllChannels:function(e,t){var n={},r=this.currentChannels,i,s;return _.each(r,function(t,i){if(!t||!t.length||e&&_.indexOf(e,i)>0){n[i]=r[i];return}s=t.length;while(s--)t[s].stop(!0)}),this.currentChannels=n,this.dirtyChannelList=!0,t||(i=this.updateChannelList()),i},unsubscribeFromChannels:function(e,t){var n=[],r,i,s,o,u,a;for(o=0,u=e.length;o<u;o++){s=e[o];if(this.currentChannels.hasOwnProperty(s)){i=this.currentChannels[s],a=i.length;while(a--)n.push(i[a].getOptions()),i[a].stop(!0);delete this.currentChannels[s]}}return t||(r=new U(this,"sub",{rm:!0,subs:n}),j.call(this,r)||(r.reject({sendFailed:!0}),this.dirtyChannelList=!0)),r},monitorChannelsKeys:function(e,t,n,r){var i=[],s,o,u,a;for(var f=0,l=e.length;f<l;f++){if(!e[f]||typeof e[f]!="string")continue;u=e[f],o=this.currentChannelsMonitors[u],a=new z(this,t),a.channelName=u,o||(o=this.currentChannelsMonitors[u]=[]),o.push(a),i.push(a),this.dirtyMonitorChannelList=!0}return r||(s=this.updateMonitorChannelList()),{monitors:i,command:s}},unmonitorChannels:function(e,t){var n,r,i,s,o,u;for(s=0,o=e.length;s<o;s++){n=e[s];if(this.currentChannelsMonitors.hasOwnProperty(n)){i=this.currentChannelsMonitors[n],u=i.length;while(u--)i[u].stop(!0);delete this.currentChannelsMonitors[n],this.dirtyMonitorChannelList=!0}}return t||(r=this.updateMonitorChannelList()),r},publishToChannels:function(e,t,n,r,i){var s=[];for(var o=0,u=e.length;o<u;o++)e[o]&&s.push({type:"sub",name:e[o]});var a={type:"data",value:t,subs:s,async:n||!1,persist:r||!1},f=new U(this,"pub",a,!0,i);return j.call(this,f)||f.reject({sendFailed:!0}),f},publishToSelf:function(e,t){this.publishToChannels(["user:"+this.user.id],{type:e,params:t,sessionPart:n.Services.API.sessionPart})},removeChannel:function(e){var t,n;if(!e)return;if(e.getState()){e.stop();return}t=this.currentChannels[e.channelName];if(!t)return;n=_.indexOf(t,e),n!==-1&&(t.splice(n,1),t.length===0&&(this.dirtyChannelList=!0,this.updateChannelList()))},updateChannelList:function(e){if(!this.dirtyChannelList)return this.lastSubCommand?this.lastSubCommand:$.Deferred().resolve([]);var t=[],n={subs:t},r,i,s,o;for(i in this.currentChannels)if(this.currentChannels.hasOwnProperty(i)&&this.currentChannels[i]){s=this.currentChannels[i];if(!s[0]){delete this.currentChannels[i];continue}for(o=s.length;o>0;){if(!s[0].getState()){s.splice(0,1),o--;continue}t.push(s[0].getOptions());break}}return e&&!t.length?$.Deferred().resolve([]):(r=new U(this,"sub",n,!0),this.lastSubCommand&&!this.lastSubCommand.sent?(this.lastSubCommand.updateCommand("sub",{subs:t}),r=this.lastSubCommand,this.dirtyChannelList=!1):j.call(this,r)?this.dirtyChannelList=!1:r.reject({sendFailed:!0}),this.lastSubCommand=r,r)},removeChannelMonitor:function(e){var t,n;if(!e)return;if(e.getState()){e.stop();return}t=this.currentChannelsMonitors[e.channelName];if(!t)return;n=_.indexOf(t,e),n!==-1&&(t.splice(n,1),this.dirtyMonitorChannelList=!0,this.updateMonitorChannelList())},updateMonitorChannelList:function(e){if(!this.socket||!this.socket.isOpen()||!this.dirtyMonitorChannelList||this.verificationStatus<0)return $.Deferred().reject({error:"badState"});var t=[],n={type:"sub_keys"},r,i,s,o;for(r in this.currentChannelsMonitors){if(!this.currentChannelsMonitors.hasOwnProperty(r))continue;i=this.currentChannelsMonitors[r],o=i.length,s=[];while(o--)s.push.apply(s,i[o].getKeys());if(_.isEmpty(s)){this.unmonitorChannels([r],!0);continue}t.push({sub:r,keys:_.unique(s)})}if(e&&!t.length)return $.Deferred().reject({error:"noSubKeys"});n.sub_keys=t;var u=new U(this,"meta_sub",n,!0);return j.call(this,u)?this.dirtyMonitorChannelList=!1:u.reject({sendFailed:!0}),u},monitorUsers:function(e,t,n){var r=n||{},i,s,o,u,a;r.overwrite&&(this.currentUserMonitors={});if(r.replace){a=W.prototype.monitorsByLockName[t];if(a){a=a.concat();for(i=0,s=a.length;i<s;i++)_.indexOf(e,a[i].userID)===-1&&a[i].removeLock(t,!0)}}for(i=0,s=e.length;i<s;i++)o=e[i],u=this.currentUserMonitors[o],u||(u=new W(o,this),this.currentUserMonitors[o]=u),u.addLock(t,r.forceSub,!0);return this.dirtyMonitorUserList=!0,this.updateMonitorUserList()},removeUserMonitor:function(e,t){var n=opts||{},r,i,s;for(r=0,i=e.length;r<i;r++)s=this.currentUserMonitors[e[r]],s&&s.removeLock(t,!0);this.dirtyMonitorUserList=!0,this.updateMonitorUserList()},updateMonitorUserList:function(){if(!this.socket||!this.socket.isOpen()||!this.dirtyMonitorUserList||this.verificationStatus<0)return $.Deferred().reject({error:"badState"});var e={type:"userids",userids:[]},t={type:"userid_keys",userid_keys:[]},r=!1,i=!1,s,o,u,a,f;for(u in this.currentUserMonitors){if(!this.currentUserMonitors.hasOwnProperty(u))continue;a=this.currentUserMonitors[u],a._locks.length===0?(delete this.currentUserMonitors[u],a._isMetaSubbed&&(r=!0),a._isStatusSubbed&&(i=!0)):(e.userids.push(u.toString()),a._isMetaSubbed||(a._isMetaSubbed=!0,r=!0),a._forceStatusLocks.length||a._isOnline?(t.userid_keys.push({userid:u.toString(),keys:["s"]}),a._isStatusSubbed||(a._isStatusSubbed=!0,i=!0)):a._isStatusSubbed&&(i=!0))}return r&&(s=new U(this,"meta_sub",e,!0),j.call(this,s),s.done(_.bind(function(e){var t,n,r,i;for(t=0,n=e.success.length;t<n;t++){r=e.success[t];if(r.hasOwnProperty("userid")&&r.hasOwnProperty("status")){i=this.currentUserMonitors[r.userid];if(!i)continue;r.status==="logged_in"?i.setOnlineStatus(!0,!0):r.status==="logged_out"&&i.setOnlineStatus(!1,!0)}}},this))),i&&(o=new U(this,"meta_sub",t,!0),j.call(this,o),o.done(_.bind(function(e){var t,r,i,s;for(t=0,r=e.success.length;t<r;t++){i=e.success[t];if(i.hasOwnProperty("userid")&&i.hasOwnProperty("values")){s=this.currentUserMonitors[i.userid];if(!s)continue;s.updateStatus(i.values[0])}}n.trigger("manatee:friendsStatus")},this))),this.dirtyMonitorUserList=!1,r&&!i?s:!r&&i?o:$.when(s,o)},getUsersKeys:function(e,t){var n=[],r,i,s,o;if(!e||!e.length||!t||!t.length)return $.Deferred().reject({badMetadata:!0});for(s=0,o=e.length;s<o;s++)n.push({userid:String(e[s]),keys:t});return r={multikeys:n},i=new U(this,"multiget",r,!0),j.call(this,i)||i.reject({sendFailed:!0}),i},getChannelKeys:function(e,t){var n,r;return!e||!t||!t.length?$.Deferred().reject({badMetadata:!0}):(n={sub:e,keys:t},r=new U(this,"get",n,!0),j.call(this,r)||r.reject({sendFailed:!0}),r)},getChannelsKeys:function(e,t){var n,r;return!e||!e.length||!t||!t.length?$.Deferred().reject({badMetadata:!0}):(n=[],_.each(e,function(e){n.push({sub:e,keys:t})}),r=new U(this,"multiget",n,!0),j.call(this,r)||r.reject({sendFailed:!0}),r)},getChannelSubscribers:function(e){var t,n;return e?(t={type:"sub_list_with_extra",sub_list_with_extra:e},n=new U(this,"info",t,!0),j.call(this,n)||n.reject({sendFailed:!0}),n):$.Deferred().reject({badMetadata:!0})},getChannelSubscriberCount:function(e){var t,n;return e?(t={type:"sub_count",sub_count:{type:"sub",name:e}},n=new U(this,"info",t,!0),j.call(this,n)||n.reject({sendFailed:!0}),n):$.Deferred().reject({badMetadata:!0})},getSelfMasterStatus:function(){if(this.user.id<=0||!this.isPrimary)return;var t=Date.now()+(e.clientTimeDivergence||0);this.loggedInMaster&&this.loggedInMaster.uuid===this.uuid?n.trigger("manatee:selfMasterStatus",{status:O.call(this),userID:this.user.id}):this.loggedInMaster&&this.loggedInMaster.remora&&t-this.loggedInMaster.lastUpdate<=h?n.trigger("manatee:selfMasterStatus",{status:this.loggedInMaster,userID:this.user.id}):C.call(this)},getSelfMasterQueueSongs:function(){if(this.user.id<=0||!this.isPrimary)return;this.publishToSelf("queueTransferRequest",{uuid:this.loggedInMaster?this.loggedInMaster.uuid:null})},getSelfBroadcasterQueueSongs:function(){if(this.user.id<=0||!this.isPrimary)return;this.publishToSelf("queueTransferRequest",{uuid:"nothing",isBroadcasting:!0})},createBroadcast:function(e){var t=$.Deferred(),r=hex_md5(e.userID+Date.now()+""),i=[{type:"sub",name:gsConfig.remoraChannel}],s=!1,o=this.subscribeToChannels([r]),u=o.subscriptions[0],a=o.command,f=setTimeout(function(){t.state()==="pending"&&t.reject("timeout")},3e4),l=new U(this,"pub",{type:"data",value:{setup:r},subs:i}),c=_.bind(function(o,a,l){if(!l.sudo)return;if(a.available!=null&&!s){this.remoraInstance=a.available,e.queueChannel=r,e.isBroadcast=!0,s=!0;var h=new U(this,"pub",{type:"data",value:{setupQueue:r,ownerID:this.remoraInstance,queue:e},subs:i});h.fail(_.bind(t.reject,t)),j.call(this,h)}if(a.action&&a.action==="setupQueueSuccess"&&a.broadcast&&a.broadcast.BroadcastID){clearTimeout(f),u.removeListener(c);var p=n.Models.Broadcast.newOrUpdate(_.extend({UserID:e.userID,ownerUser:n.Models.User.getCached(e.userID),controlChannel:r,controlMonitor:u,Name:e.name,Description:e.description,Image:e.image,IsRandomName:e.isRandomName,Privacy:e.privacy,Tag:e.tag,Songs:[],suggestions:[]},a.broadcast));t.resolve(p)}else a.action==="setupQueueFailed"&&t.reject(a.reason)},this);u.listen(c);var h=this,p=new U(this,"set",{sub:r,keyvals:[{key:"owners",value:[{type:"userid",name:e.userID.toString()}]},{key:"sub_alert",value:!0}]});return a.done(function(){j.call(h,p),p.done(function(){j.call(h,l)})}).fail(_.bind(t.reject,t)),l.fail(_.bind(t.reject,t)),t.promise()},getPublicUID:function(){return this.uuid?hex_sha1(this.uuid).substr(0,12):""},pingSocket:function(){if(this.socket&&this.socket.isOpen()){var e=Date.now();e-this.lastSocketWrite>3e4&&j.call(this,".",!0)}},periodicStatusUpdate:function(){var t=Date.now()+(e.clientTimeDivergence||0);this.loggedInMaster&&this.loggedInMaster.uuid===this.uuid?A.call(this):C.call(this)},retryData:function(e,t){t&&!e&&(e={command:t}),e&&(typeof e=="string"?(e.charAt(e.length-1)!=="\n"&&(e+="\n"),this.retryCommandQueue.push(e)):(e.blackbox?e.blackbox.retried=!0:e.blackbox={retried:!0},this.retryCommandQueue.push(e))),this.retryCommandsTimer?this.retryCommandsTimer.running||(this.retryCommandsTimer.reset(),this.retryCommandsTimer.start()):(this.retryCommandsTimer=new Timer((Math.floor(Math.random()*6)+8)*1e3,1),this.retryCommandsTimer.on("complete",this.onRetryDataSend,this),this.retryCommandsTimer.start())},removeCommandFromRetryQueue:function(e){for(var t=0,n=this.retryCommandQueue.length;t<n;t++)typeof this.retryCommandQueue[t]=="object"&&this.retryCommandQueue[t].command==e&&(this.retryCommandQueue.splice(t,1),t--)},getRetryDataToSend:function(){if(!this.retryCommandQueue.length)return"";var e={},t="",n,r;for(var i=0,s=this.retryCommandQueue.length;i<s;i++){if(typeof this.retryCommandQueue[i]=="string"){t+=this.retryCommandQueue[i];continue}if(!this.retryCommandQueue[i].hasOwnProperty("command"))continue;n=this.retryCommandQueue[i].command;if(e[n])continue;r="";switch(n){case"identify":case"meta_sub":break;default:try{r=$.stringify(this.retryCommandQueue[i])}catch(o){r=""}}if(!r)continue;t+=r+"\n"}for(n in e)e.hasOwnProperty(n)&&e[n]&&(t+=e[n]+"\n");return t},onRetryDataSend:function(){!this.socket||!this.socket.connected?(this.removeCommandFromRetryQueue("sub"),this.reconnect()):this.verificationStatus<1&&x.call(this);var e=this.getRetryDataToSend();this.retryCommandQueue=[],e&&j.call(this,e)},outputRecentLogs:function(e){var t=_.clone(this.logger||[]),n,r,i;e&&(t=t.slice(e*-1));for(n=0,r=t.length;n<r;n++){i=["manatee:"].concat(t[n][1]);switch(t[n][0]){case 1:console.info.apply(console,i);break;case 2:console.warn.apply(console,i);break;case 3:console.error.apply(console,i);break;case 0:default:console.log.apply(console,i)}}}}),X.onSWFSocketEvent=function(e,t,n){q.socketEvents.trigger(""+e,t,n)},X.convertGSConfigServerList=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({host:n,port:443,weight:e[n]});return t},n.Services.Manatee=X,y()}(),function(){n.Services=n.Services||{};var i=[{targetRange:[0,.1],dateRange:["2013-01-23","2013-01-29"],name:"Interleaving_HTP4PopArtist_HTP4",groups:["0"]},{targetRange:[.1,.2],dateRange:["2013-07-01","2013-07-08"],name:"guts-json",groups:["0"]},{targetRange:[.4,.9],dateRange:["2013-03-05","2013-03-13"],name:"paymentsPopup",groups:[0,1]}],s=6048e5,o;n.Services.GUTS={shouldLog:!1,server:"/guts",appID:"html",context:!1,debug:!1,abTest:null,bufferLength:10,localLogs:[],canLogStats:Math.random()>=.5,localStats:[],statsTimer:0,lastStatsTime:0,lastUserChangeTime:0,searchClickLpid:"searchClick",loggedNormally:!1,eligibleForABTest:!1,abTestBucket:null,currentTest:null,currentGroup:null,loggingStatusExpirationDate:null,init:function(t){o=t,this.context={},this.server=_.orEqual(gsConfig.gutsServer,!1),this.setLoggingStatus(),this.debug=gsConfig.runMode!=="production",this.createdAt=Date.now(),this.debug&&(this.bufferLength=1,this.shouldLog=!0),this.currentPage={},this.currentPage.pageType="home",this.currentPage.section="",this.currentPage.subpage="",this.currentPage.id="",gsConfig.isPreview&&(this.appID="preview",this.shouldLog=!0);var r=_.browserDetect(),i=o.get("user"),s=(e.location.hostname||"").replace(/\.?grooveshark.com/i,"")||"live";this.beginContext({version:"stingray",host:s}),_.gaSetCustomVariable(4,"misc","V:JH02"),this.beginContext({sessionID:gsConfig.sessionID}),this.beginContext({initTime:(new Date).getTime()}),this.beginContext({country:gsConfig.country.ID});if(i.id>0){var u=i.get("subscription").getTypeString().length?i.get("subscription").getTypeString():!1;this.beginContext({userID:i.id}),u&&this.beginContext({subscription:u}),o.get("user").get("Flags")&n.Models.User.FLAG_ARTIST_CLAIMED&&this.beginContext({hasArtists:!0})}_.gaSetCustomVariable(1,"User",o.get("user").getUserStringForAnalytics()),o.on("change:user",this.onUserChange,this),this.logEvent("init",{browser:r.browser,browserVersion:r.version,os:navigator.platform,ip:gsConfig.remoteAddr,locale:o.get("locale")}),n.on("change:page",this.handlePageLoad,this),n.on("player:restore",this.handlePlayerRestoreQueue,this),n.on("api:stats",this.handleAPIStats,this),$(document).click(_.bind(function(e){if(Math.random()<.001){var t=$(e.target.outerHTML).html("").get(0).outerHTML;this.logEvent("globalClick",{outerHTML:t})}},this)),this.onShouldLogChange(),n.on("guts:log",this.onLog,this),n.on("guts:logsearch",this.onLogSearch,this),n.on("guts:forcelog",this.onForceLog,this),n.on("guts:begincontext",this.onBeginContext,this),n.on("guts:endcontext",this.onEndContext,this),n.on("guts:startNewAutoplayContext",this.onStartNewAutoplayContext,this),n.on("guts:startAutoplayFallbackContext",this.onStartAutoplayFallbackContext,this),n.on("guts:clearAllAutoplayContexts",this.onClearAllAutoplayContexts,this),n.on("guts:handleFieldClick",this.onHandleFieldClick,this),n.on("guts:navClick",this.handleNavClick,this)},onShouldLogChange:function(){if(!n.Services.API||!this.canLogStats)return;this.shouldLog?(n.Services.API.collectStats=!0,this.statsTimer||(this.statsTimer=setInterval(_.bind(this.sendStats,this),1e4))):(this.localStats=[],n.Services.API.collectStats=null,clearTimeout(this.statsTimer),this.statsTimer=0)},onUserChange:function(){var e=o.get("user"),t=_.defined(this.context.userID),r=_.defined(this.context.subscription),i=_.defined(this.context.hasArtists),s=e.get("subscription").getTypeString().length?e.get("subscription").getTypeString():!1,u=e.id;t&&this.endContext("userID"),r&&this.endContext("subscription"),i&&this.endContext("hasArtists");if(u>0){var a=_.browserDetect(),f={userID:u,browser:a.browser,browserVersion:a.version,os:navigator.platform,ip:gsConfig.remoteAddr};s&&(f.subscription=s),this.logEvent("login",f),this.beginContext({userID:u}),s&&this.beginContext({subscription:s}),e.get("Flags")&n.Models.User.FLAG_ARTIST_CLAIMED&&this.beginContext({hasArtists:!0})}else t&&this.logEvent("logout",{});_.gaSetCustomVariable(1,"User",e.getUserStringForAnalytics()),this.lastUserChangeTime=(new Date).getTime()},setLoggingStatus:function(){var e=new Date,t=n.Services.Local,r,o,u,a,f=t.get("currentTest"),l=t.get("currentGroup");if(f){r=t.get("abTestBucket"),o=t.get("eligibleForABTest"),u=t.get("loggedNormally");if(typeof r=="number"&&r>=0&&r<=1&&o&&u===!1&&f.name&&typeof l=="number")for(var c=0;c<i.length;c++)if(i[c].name===f.name&&f.dateRange){var h=new Date(f.dateRange[0]),p=new Date(f.dateRange[1]);if(e>=h&&e<p){this.eligibleForABTest=o,this.loggedNormally=u,this.currentTest=f,this.currentGroup=l,this.beginContext({abtest:this.currentTest.name,group:this.currentGroup}),this.shouldLog=!0,_.gaSetCustomVariable(2,"GUTSLoggingStatus",this.currentTest.name+"_"+this.currentGroup,2),this.onShouldLogChange();return}break}this.clearLoggingStatus()}r=t.get("abTestBucket"),o=t.get("eligibleForABTest"),u=t.get("loggedNormally"),a=t.get("loggingStatusExpirationDate"),a&&(a=new Date(a));var d=Math.random();a&&e>a&&(this.clearLoggingStatus(),u=t.get("loggedNormally"),o=t.get("eligibleForABTest"),r=t.get("abTestBucket"),l=t.get("currentGroup"));if(r&&o&&u===!1){this.abTestBucket=r,this.setCurrentTest();return}_.defined(u)||(u=d<=.1,t.set("loggedNormally",u)),this.loggedNormally=u,this.loggedNormally?(this.eligibleForABTest=!1,this.shouldLog=!0,t.set("eligibleForABTest",!1),_.gaSetCustomVariable(2,"GUTSLoggingStatus","normal",2),this.onShouldLogChange()):_.defined(o)?this.eligibleForABTest=o:(this.eligibleForABTest=d>.1&&d<=.2,t.set("eligibleForABTest",this.eligibleForABTest)),this.eligibleForABTest?(this.abTestBucket=Math.random(),t.set("abTestBucket",this.abTestBucket)):(this.abTestBucket=null,t.set("abTestBucket",this.abTestBucket)),this.loggingStatusExpirationDate=new Date(e.getTime()+s),t.set("loggingStatusExpirationDate",this.loggingStatusExpirationDate),this.abTestBucket&&this.setCurrentTest()},forceABTest:function(e,t){e&&typeof t=="number"&&(this.currentTest={},this.currentTest.name=e,this.currentGroup=t,this.beginContext({abtest:this.currentTest.name,group:this.currentGroup}),this.shouldLog=!0,this.debug=!0,this.loggedNormally=!1,this.eligibleForABTest=!0,this.onShouldLogChange())},forceExistingABTest:function(e,t,r){if(e&&typeof t=="number")for(var s=0;s<i.length;s++){var o=i[s];if(o.name===e){this.currentTest=o,this.currentGroup=t,this.shouldLog=!0,this.debug=!0,this.loggedNormally=!1,this.eligibleForABTest=!0,this.abTestBucket=(o.targetRange[0]+o.targetRange[1])/2;if(r){var u=n.Services.Local;u.set("loggedNormally",!1),u.set("eligibleForABTest",!0),u.set("abTestBucket",this.abTestBucket),u.set("currentTest",this.currentTest),u.set("currentGroup",this.currentGroup)}this.onShouldLogChange();break}}},clearLoggingStatus:function(){var e=n.Services.Local;e.set("loggedNormally",null),e.set("eligibleForABTest",null),e.set("abTestBucket",null),e.set("currentTest",null),e.set("currentGroup",null),e.set("loggingStatusExpirationDate",null),this.shouldLog=!1,this.loggedNormally=null,this.eligibleForABTest=null,this.abTestBucket=null,this.currentTest=null,this.currentGroup=null,_.gaSetCustomVariable(2,"GUTSLoggingStatus","",2),this.onShouldLogChange()},setCurrentTest:function(){if(this.abTestBucket){var e,t,r,s=new Date,o=n.Services.Local;for(var u=0;u<i.length;u++){e=i[u],t=new Date(e.dateRange[0]),r=new Date(e.dateRange[1]);if(e.targetRange[0]<=this.abTestBucket&&e.targetRange[1]>=this.abTestBucket&&t<=s&&r>=s){this.currentTest=e,o.set("currentTest",e);var a=(e.targetRange[1]-e.targetRange[0])/e.groups.length;return this.currentGroup=Math.min(Math.floor((this.abTestBucket-e.targetRange[0])/a),e.groups.length-1),o.set("currentGroup",this.currentGroup),this.beginContext({abtest:e.name,group:this.currentGroup}),this.shouldLog=!0,_.gaSetCustomVariable(2,"GUTSLoggingStatus",e.name+"_"+this.currentGroup,2),this.onShouldLogChange(),e}}}return null},beginContext:function(e){_.forEach(e,function(t,n){e.hasOwnProperty(n)&&(this.context[n]=e[n])},this)},endContext:function(e){_.defined(this.context[e])&&delete this.context[e]},doLogEvent:function(e,t){var n=this.currentTest;if(n&&n.dateRange&&n.dateRange.length==2){var r=new Date,i=new Date(n.dateRange[1]);if(r>i){this.clearLoggingStatus(),this.setLoggingStatus();if(!this.shouldLog)return}}var s=(new Date).getTime(),o={time:s,appID:this.appID,lpID:e,state:{},context:{}},u=this.context;_.forEach(u,function(e,t){u.hasOwnProperty(t)&&($.isArray(u[t])?(this.context[t]=[],_.forEach(u[t],function(e,t){this.push(t)},this.context[t])):this.context[t]=_.orEqual(u[t],"").toString())},o),_.forEach(t,function(e,n){t.hasOwnProperty(n)&&(o.state[n]=_.orEqual(e,"").toString())},o),this.localLogs.push(o),(this.debug||this.checkSendCondition())&&this.sendLogs()},logEvent:function(e,t){this.shouldLog&&this.doLogEvent(e,t)},onBeginContext:function(e){this.beginContext(e)},onEndContext:function(e){this.endContext(e)},onStartNewAutoplayContext:function(e,t,n,r){this.startNewAutoplayContext(e,t,n,r)},onStartAutoplayFallbackContext:function(e,t,n,r){this.startAutoplayFallbackContext(e,t,n,r)},onLogSearch:function(e,t,n,r){this.logSearchEvent(e,t,n,r)},onClearAllAutoplayContexts:function(){this.clearAllAutoplayContexts()},onForceLog:function(e,t){var n=this.checkLogForErrors(e,t,!0);n&&this.forceLogEvent(n.lpID,n.state)},onHandleFieldClick:function(e,t,n,r){this.handleFieldClick(e,t,n,r)},checkLogForErrors:function(e,t,n){n=_.defined(n)?n:!1;var r={lpID:e,state:t};if(!n&&!this.shouldLog)return!1;try{if(_.isNull(e)||_.isUndefined(e))throw{msg:"missing lpID in log event",cause:r};if(typeof e!="string")throw{msg:"invalid param type of lpID, expected string:",cause:r};if(_.isNull(t)||_.isUndefined(t))r.state={};else{if(typeof t!="object")throw{msg:"invalid param type of state, expected object:",cause:r};var i=_.keys(t),s=i.length;for(var o=0;o<s;o++){var u=i[o];if(typeof t[u]=="object"&&!_.isArray(t[u]))throw{msg:"state property in log function cannot contain objects:",cause:r}}}return r}catch(a){return console.log("GUTS logging error -",a.msg,a.cause),!1}},onLog:function(e,t){var n=this.checkLogForErrors(e,t);n&&this.doLogEvent(n.lpID,n.state)},forceLogEvent:function(e,t){t||(t={}),t.forceLogged=!0,this.doLogEvent(e,t)},logSearchEvent:function(e,i,s,o){try{var u="",a={},f=r.model.get("searchVersion"),l=new n.Models.Collections.Songs,c=s?jQuery.data(s.currentTarget,"module"):null,h;switch(e){case"OLlibraryClick":case"OLfavoriteClick":case"OLartistPageLoad":case"OLalbumPageLoad":case"OLsongPageLoad":case"OLshareClick":case"OLplayButton":case"OLaddButton":u=e;break;case"dblClick":u="handleItemDblclick";break;default:u="searchClick",a.clickType=e}if(u!="searchClick"&&s&&c&&c.model)h=c.model,l.push(h);else{if(!i.selectedItems.length){console.log("No items for logSearchEvent");return}l.reset(i.selectedItems.models)}if(h){a.rank=i.collection.indexOf(h)+1;var p=r.page.getCurrentPageView();h.get("ppVersion")&&_.isInstance(p,n.Views.Pages.Search)&&(a.ppVersion=h.get("ppVersion"))}else{var d=Infinity,v=[];l.each(function(e){var t=i.collection.indexOf(e)+1;d=Math.min(d,t),v[t]=e.get("ppVersion")}),d!=Infinity&&(a.rank=d),v=_.without(v,t),v.length&&(a.ppVersions=v.join(","))}l.length==1?a.songID=l.models[0].get("SongID"):a.songIDs=l.pluck("SongID"),o&&(a=_.extend(a,o)),this.logEvent(u,a)}catch(m){console.log(m)}},checkSendCondition:function(){return this.localLogs.length>=this.bufferLength&&(new Date).getTime()-this.lastUserChangeTime>1e4},forceSendAsync:function(){this._internalSend(!0,0)},forceSend:function(){this.sendLogs(!0)},sendLogsTimeout:!1,sendLogsWait:function(){var e=(new Date).getTime()-this.lastUserChangeTime;return e>=1e4?1e3:1e4-e},sendLogs:function(e){var t=this.debug?0:this.sendLogsWait();e?this._internalSend(!1):this._internalSend(!0,t)},sendStats:function(e){var t=+(new Date);e=e||(t-n.Services.API.lastRequestTime)/1e3>=20||(t-this.lastStatsTime)/1e3>=300||this.localStats.length>100,e&&this.lastStatsTime&&this.localStats&&this.localStats.length?(this.lastStatsTime=0,n.Services.API.logPerformanceTracking(this.localStats).always(_.bind(function(){this.lastStatsTime=t},this)),this.localStats=[]):this.lastStatsTime||(this.lastStatsTime=t)},_internalSend:function(t,r){clearTimeout(this.sendLogsTimeout),r=_.isNumber(r)?r:500,t=_.orEqual(t,!0);var i=0,s=0,o=_.bind(function(){var u=Date.now()-this.createdAt;i+=r,s++;if(r&&t&&$.active&&u>1e4&&(i<=2e3||s<=2)){this.sendLogsTimeout=setTimeout(o,r);return}var a=this.toTransmissionFormat(this.localLogs);if(this.localLogs.length>0){this.debug&&console.log(a);var f=this;this.currentTest?($.ajax({contentType:"text/xml",type:"POST",data:a,url:"/guts-ab.php",cache:!1,async:t,success:function(e,t,n){},error:function(e,t,n){}}),this.currentTest.name=="guts-json"&&n.Services.API.logGuts({logpoints:this.localLogs,clientTimeDivergence:e.clientTimeDivergence},{async:t})):$.ajax({contentType:"text/xml",type:"POST",data:a,url:this.server,cache:!1,async:t,success:function(e,t,n){},error:function(e,t,n){}}),this.localLogs=[]}},this);t?this.sendLogsTimeout=setTimeout(o,r):o()},toTransmissionFormat:function(e){var t=(new Date).getTime()+"\n",n={result:t,appID:this.appID};return _.forEach(e,function(t,n){var r=/\:/g,i=/\\/g,s=e[n];this.result+=this.appID+"	",this.result+=s.lpID+"	";var o=s.context;_.forEach(o,function(e,t){o.hasOwnProperty(t)&&(this.result+=t+":"+o[t].replace(i,"\\\\").replace(r,"\\:")+"	")},this);var u=s.state;_.forEach(u,function(e,t){u.hasOwnProperty(t)&&(this.result+=t+":"+u[t].replace(i,"\\\\").replace(r,"\\:")+"	")},this),this.result+=s.time+"\n"},n),n.result},handlePageLoad:function(t,n){var r={};r.destinationPageType=t;if(n.firstPage){r.firstPage=!0;try{var i=_.cookie("referrerURL"),s;i?(s=i,_.cookie("referrerURL",null,{domain:e.location.host})):s=document.referrer;if(s&&_.isString(s)){var o=/^(?:(?:(.+?):)?\/\/(?:(.+)@)?([^/]+)(?::([0-9]+))?)?\/?/,u=s.match(o);u&&(r.referrerHost=u[3]||"grooveshark.com",r.referrer=s)}}catch(a){console.log("error parsing referrer",a.message)}}switch(t){case"home":n&&n.redeemingPromoCard&&(r.reason="redeem"),n.notFound?(r.reason="pageNotFound",this.logEvent("pageNotFound",{})):n.reason&&(r.reason=n.reason);break;case"user":case"profile":r.destinationPageID=n.id,r.destinationSubpageType=n.section&&!n.subpage?n.section:n.subpage,n.section=="broadcast"&&(r.destinationSubpageType="broadcast"),r.destinationSubpageType==="broadcast"&&(r.destinationTab="now_playing",r.destinationSubTab="np-about"),r.destinationSubpageType=_.orEqual(r.destinationSubpageType,"profile");break;case"playlist":case"album":case"artist":case"promotion":case"tag":r.destinationPageID=n.id,r.destinationSubpageType=n.subpage,r.destinationSubpageType||(t=="album"?r.destinationSubpageType="tracklist":t=="artist"&&(r.destinationSubpageType="overview"));break;case"search":r.destinationSubpageType=n.type||"everything";break;case"song":r.destinationPageID=n.id,r.destinationSubpageType=n.subpage;break;case"settings":r.destinationSubpageType=_.orEqual(n.subpage,"profile");break;case"popular":r.destinationTimeRange=n.type||"daily";case"surveys":case"explore":case"trending":n.subpage&&(r.destinationSubpageType=n.subpage);case"artistDashboard":n.subpage&&(r.destinationSubpageType=n.subpage),n.id&&(r.destinationPageID=n.id);case"static":n.section&&(r.destinationSubpageType=n.section);break;case"broadcasts":r.destinationSubpageType=n.tagID||"All";break;case"userOnboarding":n.section&&(r.destinationSubpageType=n.section)}!r.destinationPageID&&_.toInt(n.id)&&(r.destinationPageID=_.toInt(n.id)),r.destinationPageID&&r.destinationPageID<=0&&delete r.destinationPageID,this.pageParamsAreDifferent(r)&&(r.firstPage&&r.destinationSubpageType==="broadcast"?this.forceLogEvent("loadPage",r):this.logEvent("loadPage",r),r.destinationPageType==="popular"&&this.beginContext({currentTimeRange:n.type||"daily"}),r.destinationSubpageType==="broadcast"&&this.beginContext({currentTab:r.destinationTab,currentSubTab:r.destinationSubTab}),this.context.currentSubpage==="broadcast"&&r.destinationSubpageType!=="broadcast"&&(this.endContext("currentTab"),this.endContext("currentSubTab")),this.context.currentPageType==="popular"&&r.destinationPageType!=="popular"&&this.endContext("currentTimeRange"),this.beginContext({currentPageType:r.destinationPageType}),r.destinationSubpageType?this.beginContext({currentSubpage:r.destinationSubpageType}):this.endContext("currentSubpage"),r.destinationPageID?this.beginContext({currentPageID:r.destinationPageID}):this.endContext("currentPageID"))},handleNavClick:function(e,t){var n={};if(this.context.currentSubpage==="broadcast"){if(e==="pageNav"){n.destinationTab=t.destination;switch(n.destinationTab){case"now_playing":n.destinationSubTab="np-about";break;case"add_song":n.destinationSubTab="sugg-add"}}else e==="tab"&&(n.destinationSubTab=t.destination);this.logEvent("pageNavClick",n);if(e==="pageNav"){this.beginContext({currentTab:n.destinationTab});switch(n.destinationTab){case"now_playing":this.beginContext({currentSubTab:"np-about"});break;case"add_song":this.beginContext({currentSubTab:"sugg-add"});break;default:this.endContext("currentSubTab")}}else e==="tab"&&this.beginContext({currentSubTab:n.destinationSubTab})}else this.logEvent("pageNavClick",t)},startNewAutoplayContext:function(e,t,n,r){console.log("startNewAutoplayContext",arguments),this.clearAllAutoplayContexts(),this.beginContext({autoplay:!0,autoplayType:e,autoplayID:t}),n&&r&&this.beginContext({autoplaySeedType:n,autoplaySeedIDs:r})},startAutoplayFallbackContext:function(e,t,n,r){console.log("startAutoplayFallbackContext",arguments),this.clearAutoplayFallbackContexts(),this.beginContext({autoplayFallbackType:e,autoplayFallbackID:t}),n&&r&&this.beginContext({autoplayFallbackSeedType:n,autoplayFallbackSeedIDs:r})},clearAllAutoplayContexts:function(){console.log("clearAllAutoplayContexts"),this.endContext("autoplay"),this.endContext("autoplayType"),this.endContext("autoplayID"),this.endContext("autoplaySeedType"),this.endContext("autoplaySeedIDs"),this.clearAutoplayFallbackContexts()},clearAutoplayFallbackContexts:function(){this.endContext("autoplayFallbackType"),this.endContext("autoplayFallbackID"),this.endContext("autoplayFallbackSeedType"),this.endContext("autoplayFallbackSeedIDs")},handlePlayerRestoreQueue:function(){_.gaTrackEvent("player","restoreQueue"),this.logEvent("restoreQueue")},handleAPIStats:function(e){this.shouldLog&&(this.localStats.push(e),this.sendStats())},pageParamsAreDifferent:function(e){return!this.context.currentPageType||!this.context.currentSubpage||!this.context.currentPageID?!0:e&&e.destinationPageType&&e.destinationSubpageType&&e.destinationPageID?this.context.currentPageType!=e.destinationPageType?!0:this.context.currentSubpage!=e.destinationSubpageType?!0:this.context.currentPageID!=e.destinationPageID?!0:!1:!0},handleFieldClick:function(e,t,n,r){var i={songID:n,rank:t};r!==null&&r.length>0&&(i.ppVersion=r);var s="";e.indexOf("artist")>-1?s="OLartistPageLoad":e.indexOf("album")>-1?s="OLalbumPageLoad":s="OLsongPageLoad",this.logEvent(s,i)},handleFeedEventClick:function(e,t){var n={},r=$(e)[0].tagName,i;switch(r){case"A":i=$(e).parents(".event");if($(e).attr("href")){var s=$(e).attr("href"),o=s.split("/");n.clickedType=o[1],n.clickedID=o[3]}else n.clickedType=$(e).attr("class");break;case"LI":i=$(e).parents(".event");var u=$(e).attr("class").split(" "),a=u[u.length-1];a=="option"?n.clickedType="playSongs":a=="show"&&(n.clickedType="showSongs");break;default:}n.rank=$(i).index()+1;var f=$(i).attr("class"),o=f.split(" ");n.whoseFeed=o[2].split("user")[1],_.forEach(o,function(e,t){o[t].indexOf("type")>-1&&(n.eventType=o[t].substring(4,o[t].length))},n);var l={},c;$('.what>a[class!="showSongs"]',i).each(function(e,t){var r=$(this).attr("href");if(_.defined(r)){var i=r.split("/"),s=i[1];l[s]?l[s]+=1:l[s]=1;var o=i[3];n[s+l[s]]=o}});var h={};$("#feed>li").each(function(){f=$(this).attr("class"),o=f.split(" ");var e=o[1].substring(4,o[1].length);h[e]?h[e]+=1:h[e]=1});var p="";_.forEach(h,function(e,t){p=p+t+";"+e+","},p),p=p.slice(0,p.length-1),n.counts=p,this.logEvent("feedEventClick",n)},objectListPlayAdd:function(e,t,n){var r,i;switch(n){case"play":r="OLPlayClick";break;case"add":r="OLAddClick";break;default:}var s,o=$("#grid .slick-row.selected",t);o.length>0?(i="",$(o).each(function(){s=parseInt($(this).attr("row"),10),isNaN(s)||(i=i+(s+1)+",")}),i=i.slice(0,i.length-1),this.logEvent(r,{songIDs:e,ranks:i})):(i="all",this.logEvent(r,{songIDs:e,ranks:i}))},songItemGetContexts:function(e){var t={},n="",r=$(e.target).closest(".listens-set-grid");return r.length&&(r.hasClass("today")?n="today":r.hasClass("yesterday")?n="yesterday":r.hasClass("last-week")?n="last-week":r.hasClass("last-month")?n="last-month":r.hasClass("long-ago")&&(n="long-ago")),n.length&&(t.recentListensGroup=n),t},songItemLibraryClick:function(e){this.logEvent("OLlibraryClick",e)},songItemFavoriteClick:function(e){this.logEvent("OLfavoriteClick",e)}}}(),function(){function s(e){_.gaTrackSocial("facebook","like",e)}function o(e){_.gaTrackSocial("facebook","unlike",e)}n.Services=n.Services||{};var t=0,r=!1,i;n.Services.Facebook={lastError:null,loadFacebookJS:function(){if(typeof e.FB=="object"){r||this.onFacebookJSLoaded();return}if($.browser.msie&&$.browser.version<=6)return;var n=null,i=this;t++;try{if($("#facebook-js script").length)$("#facebook-js").empty(),$("#fb-root").empty(),e.FB=null;else if(!document.getElementById("facebook-js")){var s=document.createElement("div");s.id="facebook-js",document.body.appendChild(s)}if(!document.getElementById("facebook-root")){var o=document.createElement("div");o.id="fb-root",document.body.appendChild(o)}var u=document.createElement("script");u.async=!0,u.src=document.location.protocol+"//connect.facebook.net/en_US/all.js",e.fbAsyncInit=_.bind(this.onFacebookJSLoaded,this),document.getElementById("facebook-js").appendChild(u)}catch(u){console.error("Could not load Facebook JS. Fatal Error: ",u)}n=setTimeout(function(){!e.FB&&t<3?i.loadFacebookJS():!e.FB&&t>=3},2e4)},onFacebookJSLoaded:function(){if(typeof e.FB!="object"||!e.FB)return;r||e.FB.init({appId:"111132365592157",status:!1,cookie:!1,xfbml:!1,oauth:!0,channelUrl:"//"+e.location.hostname+"/channel.html"}),r=!0,e.FB.Event.subscribe("edge.create",s),e.FB.Event.subscribe("edge.remove",o),this.parseWidgets()},parseWidgets:function(t){if(typeof e.FB!="object"||!e.FB){this.loadFacebookJS();return}var n=$.Deferred();return e.FB.XFBML.parse(t,function(){n.resolve()}),n.promise()},SERVICE_ID:4,FACEBOOK_ONLY_SERVICE_ID:16,loginDeferred:null,APPLICATION_ID:"111132365592157",PERMISSIONS:"offline_access,publish_stream,email,user_about_me,user_likes,user_interests,user_location,user_birthday,publish_actions",REQUIRED_PERMISSIONS:"offline_access,publish_stream,email,user_about_me,user_location,user_birthday",PUBLISH_PERMISSION:"publish_stream",USER_ACTIONS:"publish_actions",WALL_FAVORITES:8,WALL_PLAYLIST_CREATE:16,SCROBBLING_OFF_FLAG:32,AUTO_RATE_LIMIT:18e6,MINIMUM_DURATION:15,connected:!1,userID:-1,registeredWithFacebook:!1,init:function(t){i=t,n.ready.done(_.bind(this.appReady,this)),this.LISTEN_APPLICATION_ID="111132365592157";if(e.location.host.indexOf("grooveshark.com")>-1&&this.APPLICATION_ID!==this.LISTEN_APPLICATION_ID||!this.APPLICATION_ID)this.APPLICATION_ID=this.LISTEN_APPLICATION_ID},appReady:function(){},shareLink:function(t,n,r,s){var o=$.Deferred(),u=_.getCenteredCoordinates(660,360);return t!==i.model.get("appToken")?o.reject().promise():(e.open("http://facebook.com/share.php?u="+encodeURIComponent(n)+"&ref="+r+"Share","","width=660,height=360,left="+u[0]+",top="+u[1]),o.resolve(!0,!0),o.promise())},verifyFacebookUsername:function(e,t){return n.Services.API.verifyFacebookURL(e,t)}}}(),function(){function y(e){e=_.orEqual(e,3600),l=(new Date).getTime()+e*1e3}function b(t){var n=!1,r="414496129962.apps.googleusercontent.com",i={window:e.name,flags:0};t?n=!0:t=[],_.indexOf(t,"profile")===-1&&(t.push("profile"),t.push("email"));var s="online",o="token",u="auto";n&&(s="offline",o="code",i.flags|=v,u="force");for(var a=0;a<t.length;a++)i.flags|=g[t[a]];return"https://accounts.google.com/o/oauth2/auth?response_type="+o+"&client_id="+r+"&redirect_uri="+encodeURIComponent(e.location.protocol+"//"+e.location.hostname+"/googleCallback.php")+"&access_type="+s+"&approval_prompt="+u+"&scope="+encodeURIComponent(t.join(" "))+"&state="+encodeURIComponent(JSON.stringify(i))}function w(){if(!this.shouldScrobble()||!f||p.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=p.get("queue").get("activeSong");if(!e||typeof e.get("queueSongID")!="number"){d=null;return}if(!!d&&e.get("queueSongID")===d.queueSongID&&e.get("SongID")===d.songID)return;d={songID:e.get("SongID"),queueSongID:e.get("queueSongID"),secondsListened:0,scrobbled:!1}}function E(){if(!this.shouldScrobble()||!f||p.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=p.get("queue").get("activeSong");if(!e||typeof e.get("queueSongID")!="number"){d=null;return}if(!d||e.get("queueSongID")!==d.queueSongID||e.get("SongID")!==d.songID)return;d.secondsListened+=.5;if(p.get("duration")>this.MINIMUM_DURATION*1e3&&d.secondsListened>30&&!d.scrobbled){d.scrobbled=!0;var t=e.toUrl();if(t.toLowerCase().indexOf("notfound")>-1)return;t=t.replace("#!/","http://grooveshark.com/"),S.call(this,null,t)}}function S(e,t){var n={type:"http://schemas.google.com/ListenActivity",target:{url:t}};x.call(this,e,n)}function x(t,n){(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.client!="object")&&P.call(this),i.done(function(){k().done(function(){e.gapi.auth.setToken({access_token:f,expires_in:3600});var r={path:"/plus/v1moments/people/me/moments/vault?debug=true",method:"POST",body:JSON.stringify(n),callback:_.bind(T,this,t)};e.gapi.client.request(r)})})}function T(e,t){console.log("Moment write response",t),e&&e.resolve(t)}function k(){return C?C.promise():(C=$.Deferred(),!f||l<(new Date).getTime()?++N>3?C.reject():n.Services.API.getUserGoogleAccessToken().always(function(e){e&&e.access_token?(N=0,f=e.access_token,y(),C.resolve()):C.reject()}):C.resolve(),C.promise())}function L(){(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.client!="object")&&P.call(this);var t=new $.Deferred,n=this;return i.done(function(){k().done(function(){e.gapi.auth.setToken({access_token:f,expires_in:3600});var r={path:"/oauth2/v2/userinfo",method:"GET",callback:_.bind(A,n,t)};e.gapi.client.request(r)}).fail(_.bind(t.reject,t))}).fail(_.bind(t.reject,t)),t.promise()}function A(e,t){t&&t.name?e.resolve(t):(n.Services.Google.reset(),e.reject())}function O(){if(typeof e.gapi=="object"&&e.gapi&&typeof e.gapi.plusone=="object"){r||M.call(this);return}if($.browser.msie&&$.browser.version<=6)return;var n=null,i=this;t++;try{var s=$("#google-plus-js");if(s.find("script").length)s.empty(),e.gapi=null;else if(!document.getElementById("google-plus-js")){var o=document.createElement("div");o.id="google-plus-js",document.body.appendChild(o)}var u=document.createElement("script");u.async=!0,u.src=document.location.protocol+"//apis.google.com/js/plusone.js?onload=onGAPIPlus",u.text="{parsetags: 'explicit'}",e.onGAPIPlus=function(){setTimeout(function(){if(e.gapi&&e.gapi.plusone){clearTimeout(n),M.call(i);try{delete e.onGAPIPlus}catch(t){}}},100)},document.getElementById("google-plus-js").appendChild(u)}catch(u){console.error("Could not load Google Plus JS. Fatal Error: ",u)}n=setTimeout(function(){!e.gapi&&t<3?O.call(i):(!e.gapi||!e.gapi.plusone)&&t>=3},2e4)}function M(){if(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.plusone!="object")return;r=!0,D.call(this)}function D(t){if(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.plusone!="object"){O.call(this);return}try{e.gapi.plusone.go(t?t:document.body)}catch(n){}}function P(){if(typeof e.gapi=="object"&&e.gapi&&typeof e.gapi.client=="object"){i.state()==="pending"&&H.call(this);return}if($.browser.msie&&$.browser.version<=6)return;var n=null,r=this;t++;try{var s=$("#google-api-js");if(s.find("script").length)s.empty(),e.gapi=null;else if(!document.getElementById("google-api-js")){var o=document.createElement("div");o.id="google-api-js",document.body.appendChild(o)}var u=document.createElement("script");u.async=!0,u.src=document.location.protocol+"//apis.google.com/js/client.js?onload=onGAPIClient",e.onGAPIClient=function(){setTimeout(function(){if(e.gapi&&e.gapi.client){clearTimeout(n),H.call(r);try{delete e.onGAPIClient}catch(t){}}},100)},document.getElementById("google-api-js").appendChild(u)}catch(u){console.error("Could not load Google+ API JS. Fatal Error: ",u)}n=setTimeout(function(){(!e.gapi||!e.gapi.client)&&t<3?P.call(r):(!e.gapi||!e.gapi.client)&&t>=3},2e4)}function H(){if(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.client!="object")return;i.resolve()}function B(){h&&h.off("change:extraData",j,this),h=c.model.get("user"),this.reset(),typeof h.get("extraData")=="undefined"?h.on("change:extraData",j,this):j.call(this)}function j(){if(h&&h.get("isLoggedIn")&&h.hasGoogleDataStored()){this.registeredWithGoogle=(h.get("Flags")&this.GOOGLE_ONLY_SERVICE_ID)>0;var e=h.get("extraData");e&&e.Google?F.call(this,e.Google).fail(function(e){var t="GOOGLE_PROBLEM_CONNECTING_ERROR_MSG";e&&e.error&&(t=e.error),n.trigger("notification:add",{title:_.getString(t),type:"error",click:function(){n.router.setHash("/settings/connect")},duration:3e4})}):gsConfig.runMode!=="production"&&console.error("Supposed to have Google data for auth user but undefined!!",h,e)}}function F(e){var t=$.Deferred();try{return e&&(e.GoogleUID||e.GoogleEmailAddress)?(C=null,s={},s.email=_.orEqual(e.GoogleEmailAddress,null),s.flags=parseInt(e.Flags,10),s.id=_.orEqual(e.GoogleUID,null),this.connected=!0,s.flags&this.SCROBBLING_FLAG&&this.enableScrobbling(),t.resolve(),n.trigger("google:profile:update")):(gsConfig.runMode!=="production"&&console.error("onUserGoogleData returned invalid resp:",e),this.onAuthError("onUserGoogleData returned invalid resp",t),t.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"})),t.promise()}catch(r){gsConfig.runMode!=="production"&&console.error("onUserGoogleData exception thrown:",r)}return this.reset(),t.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"}),t.promise()}function I(e,t){if(!t||!t.success){e.reject();return}var n=h.get("Flags");h.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()}function q(e,t){if(t.error||!t.email)e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"});else{if(!t.id||!t.email||!t.access_token){e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"});return}var r=0;s&&s.flags&&(r=s.flags),C=null,s=t,s.flags=r,t.state&&t.state.flags&&(s.flags|=t.state.flags),s.flags&this.SCROBBLING_FLAG&&this.enableScrobbling(),f=t.access_token,y(t.expires_in),delete s.access_token,delete s.expires_in,h.get("isLoggedIn")?t.stored?U.call(this,e,1):h.get("Flags")&this.SERVICE_ID||h.get("Flags")&this.GOOGLE_ONLY_SERVICE_ID?n.Services.API.updateUserGoogleData(t.id,t.email,s.flags).done(_.bind(U,this,e)).fail(_.bind(e.reject,e)):n.Services.API.saveUserGoogleData(t.id,t.email,s.flags).done(_.bind(U,this,e)).fail(_.bind(e.reject,e)):n.Services.API.authenticateGoogleUser(t.id,t.email,f).done(_.bind(R,this,e)).fail(_.bind(e.reject,e))}}function R(e,t){if(t)if(t.userID<=0){if(t.loginReason==1){e.reject({error:"LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING"});return}W.call(this,e)}else t.accessToken=f,e.resolve(t),n.trigger("google:profile:update");else e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"})}function U(e,t){if(t==1){this.connected=!0,n.trigger("google:profile:update"),t={result:t},t.accessToken=f,e.resolve(t);var r=h.get("Flags");h.set("Flags",r|this.SERVICE_ID)}else t===-1?e.reject({error:"GOOGLE_DUPLICATE_ACCOUNT_ERROR_MSG",signupError:4096}):t===-2?e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"}):e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"})}function z(e,t){if(t&&t.access_token){var n="https://www.googleapis.com/oauth2/v2/userinfo?access_token="+t.access_token;$.ajax({url:n,success:function(n){$.extend(t,n),e.resolve(t)},error:_.bind(function(t){e.reject(t)}),dataType:"jsonp",cache:!0})}else e.reject(t)}function W(e){if(!s||!s.email){e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"});return}var t=s.email.split("@"),r=t[0];r&&(r=r.replace(/^[\.\-_]|[^a-zA-Z0-9\.\-_]|[\.\-_]$/g,""),r=r.replace(/([\.\-_]){2,}/g,"$1"));var i=s.name,o=s.id||Math.floor(Math.random()*997508)+1005;i||r?n.Services.API.getUsernameSuggestions(r,i,o).done(_.bind(X,this,e)).fail(_.bind(function(t){e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"})},this,e)):e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"})}function X(e,t){var r="",i=0,o=0,u=0,a;s.gender==="male"?r="M":s.gender==="female"&&(r="F"),s.birthday&&(a=s.birthday.split("-"),o=_.toInt(a[0]),i=_.toInt(a[1]),u=_.toInt(a[2])),n.router.setHash("signup",{signupType:"google",thirdPartyDetails:{oauthToken:f,googleEmailAddress:s.email,googleUID:s.id},defaultValues:{username:_.orEqual(t[0],""),email:s.email,name:s.name,gender:r,month:i,day:u,year:o}})}n.Services=n.Services||{};var t=0,r=!1,i=new $.Deferred,s={},o=!1,u,a,f,l,c,h,p,d,v=1,m=33,g={profile:0,email:0,"https://www.google.com/m8/feeds/":8,"https://www.googleapis.com/auth/plus.me":16,"https://www.googleapis.com/auth/plus.login":48},N=0,C=null;n.Services.Google={SERVICE_ID:64,GOOGLE_ONLY_SERVICE_ID:32,MINIMUM_DURATION:120,GOOGLE_PLUS_FLAG:16,connected:!1,registeredWithGoogle:!1,lastError:"",init:function(e){c=e,c.model.on("change:user",B,this),p=c.model.get("player"),n.ready.done(_.bind(this.appReady,this))},appReady:function(){B.call(this)},reset:function(){this.connected=!1,this.profileLoaded=!1,this.registeredWithGoogle=!1,f=null,l=null,s={},i.state()==="resolved"&&e.gapi.auth.setToken(null),this.suspendScrobbling(c.model.get("appToken")),d=null,C=null,n.trigger("google:profile:update")},removeFromUser:function(){var e=$.Deferred();return s&&s.googleUID&&s.email?n.Services.API.removeUserGoogleData(s.id,s.email,_.bind(I,this,e)):s&&s.email?n.Services.API.removeUserGoogleData(null,s.email,_.bind(I,this,e)):n.Services.API.removeUserGoogleData(null,_.bind(I,this,e)),e.promise()},login:function(t){var n=$.Deferred(),r=_.getCenteredCoordinates(430,560);return t!==c.model.get("appToken")?n.reject().promise():(u=e.open(b(),"","width=430,height=560,status=1,location=1,resizable=yes,left="+r[0]+",top="+r[1]),a=$.Deferred(),a.always(_.bind(q,this,n)),n.promise())},loginWithGooglePlus:function(t){var n=$.Deferred(),r=_.getCenteredCoordinates(430,600),i=["https://www.googleapis.com/auth/plus.login"];return t!==c.model.get("appToken")?n.reject().promise():(u=e.open(b(i),"","width=430,height=600,status=1,location=1,resizable=yes,left="+r[0]+",top="+r[1]),a=$.Deferred(),a.always(_.bind(q,this,n)),n.promise())},connectionLogout:function(){var t=_.getCenteredCoordinates(890,600);e.open("https://www.google.com/accounts/Logout","","width=890,height=600,status=1,location=1,resizable=yes,left="+t[0]+",top="+t[1])},loadGoogleProfile:function(e,t){var r=new $.Deferred,i=n.getLoggedInUserID();return e!==c.model.get("appToken")?r.reject().promise():(this.connected?!t&&s.name?r.resolve(s):L().done(_.bind(function(e){if(i!=n.getLoggedInUserID())return;$.extend(e,e),this.profileLoaded=!0,r.resolve(e),n.trigger("google:profile:update")},this)).fail(_.bind(r.reject,r)):r.reject(),r.promise())},shareLink:function(t,n,r,i){var s=$.Deferred(),o=_.getCenteredCoordinates(720,420);return t!==c.model.get("appToken")?s.reject().promise():(e.open("https://plus.google.com/share?url="+encodeURIComponent(n),"","width=720,height=420,left="+o[0]+",top="+o[1]),s.resolve(!0,!0),s.promise())},suspendScrobbling:function(e){if(e!==c.model.get("appToken"))return;s&&(s.scrobblingEnabled=!1),o&&(p.off("change:playStatus",w,this),p.off("change:position",E,this),o=!1)},enableScrobbling:function(e){if(e!==c.model.get("appToken"))return;s&&(s.scrobblingEnabled=!0),p&&!o&&(p.on("change:playStatus",w,this),p.on("change:position",E,this),o=!0,w.call(this))},shouldScrobble:function(){return s&&s.flags&m&&s.scrobblingEnabled},getProfile:function(e){if(e!==c.model.get("appToken"))return;return s},getImageURL:function(){return s?s.picture:""},getDisplayName:function(){return s?s.email:""},getFlags:function(){return s?s.flags:0}},e.confirmGoogleConnection||(e.confirmGoogleConnection=function(e){u&&(u.close(),u=null);var t=a;if(!t)return;try{e=$.parseJSON(e)}catch(n){t.reject({error:"parseError"});return}e.mode==="cancel"||e.error==="cancel"?t.reject({error:"cancel"}):z(t,e)})}(),function(){function g(e,t,n){gsConfig.runMode!=="production"&&console.log("onPostTweet",t,n),n.success&&n.response.id?e.resolve(n.response.id,!1):y(e,n)}function y(e,t){var n={error:"POPUP_SHARE_TWITTER_ERROR"};t.response&&t.response.error&&t.response.error.indexOf("Status is over 140 characters.")>-1?n.error="POPUP_SHARE_TWITTER_TOO_LONG":gsConfig.runMode!=="production"&&console.error("postTwitterStatus returned unexpected resp:",t),e.reject(n)}function b(){if(typeof e.twttr=="object"){i||w.call(this);return}if($.browser.msie&&$.browser.version<=6)return;var t=null,n=this;r++;try{var s=$("#twitter-js");if(s.find("script").length)s.empty(),e.twttr=null;else if(!document.getElementById("twitter-js")){var o=document.createElement("div");o.id="twitter-js",document.body.appendChild(o)}var u=document.createElement("script");u.async=!0,u.src=document.location.protocol+"//platform.twitter.com/widgets.js";var a=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){e.twttr&&(clearTimeout(t),w.call(n))},100)};u.onload=u.onreadystatechange=a,document.getElementById("twitter-js").appendChild(u)}catch(u){console.error("Could not load Twitter JS. Fatal Error: ",u)}t=setTimeout(function(){!e.twttr&&r<3?b.call(n):!e.twttr&&r>=3},2e4)}function w(){if(typeof e.twttr!="object"||!e.twttr)return;i=!0,e.twttr.events.bind("tweet",function(e){if(e){var t;if(e.target&&e.target.nodeName==="IFRAME"&&e.target.src){var n=decodeURI(e.target.src),r=n.split("&");for(var i=0,s;s=r[i];++i)s.indexOf("url=")===0&&(t=unescape(s.split("=")[1]))}_.gaTrackSocial("twitter","tweet",t)}}),E.call(this)}function E(){if(typeof e.twttr!="object"||!e.twttr){loadTwitterJS.call(this);return}e.twttr.widgets.load()}function S(){d&&d.off("change:extraData",x,this),d=p.model.get("user"),this.reset(),typeof d.get("extraData")=="undefined"?d.on("change:extraData",x,this):x.call(this)}function x(){if(d&&d.get("isLoggedIn")&&d.hasTwitterDataStored()){this.registeredWithTwitter=(d.get("Flags")&this.TWITTER_ONLY_SERVICE_ID)>0;var e=d.get("extraData");e&&e.Twitter?T.call(this,e.Twitter).fail(function(e){var t="TWITTER_PROBLEM_CONNECTING_ERROR_MSG";e&&e.error&&(t=e.error),n.trigger("notification:add",{title:_.getString(t),type:"error",click:function(){n.router.setHash("/settings/connect")},duration:3e4})}):gsConfig.runMode!=="production"&&console.error("Supposed to have Twitter data for auth user but undefined!!",d,e)}}function T(e){var t=$.Deferred();try{if(e)return e.TwitterUserID&&e.OAuthToken&&e.OAuthSecret&&e.twitterProfileURL?(u={id_str:e.TwitterUserID},this.connected=!0,s=e.OAuthToken,o=e.OAuthSecret,this.loadUserProfile(p.model.get("appToken"),e.twitterProfileURL,e.twitterProfileCallback,!0,t)):(gsConfig.runMode!=="production"&&console.error("onUserTwitterData returned invalid resp:",e),N.call(this,t,"onUserTwitterData returned invalid resp"),t.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"})),t.promise()}catch(n){gsConfig.runMode!=="production"&&console.error("onUserTwitterData exception thrown:",n)}return this.reset(),t.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}),t.promise()}function N(e,t){e&&e.reject()}function C(e,r,i){if(r!=n.getLoggedInUserID())return;i.id_str&&i.profile_image_url?(u=i,this.connected=!0,this.profileLoaded=!0,n.trigger("twitter:profile:update"),e.resolve(u)):(gsConfig.runMode!=="production"&&console.error("onUserProfile returned unexpected resp:",i),N.call(this,t,"onUserProfile returned unexpected resp"),e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}))}function k(e,t){if(!t||!t.success){e.reject();return}var n=d.get("Flags");d.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()}function L(e,t,r){if(t!=n.getLoggedInUserID())return;N.call(this,e,r)}function A(e,t,r){if(r.error)e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"});else{if(!r.oauth_token||!r.oauth_token_secret){e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"});return}if(t){e.resolve(r);return}s=r.oauth_token,o=r.oauth_token_secret,delete r.oauth_token,delete r.oauth_token_secret,u=r,d.get("isLoggedIn")?d.get("Flags")&this.SERVICE_ID||d.get("Flags")&this.TWITTER_ONLY_SERVICE_ID?n.Services.API.updateUserTwitterData(u.id_str,s,o).done(_.bind(M,this,e)).fail(_.bind(e.reject,e)):n.Services.API.saveUserTwitterData(u.id_str,s,o).done(_.bind(M,this,e)).fail(_.bind(e.reject,e)):n.Services.API.authenticateTwitterUser(u.id_str,s,o).done(_.bind(O,this,e)).fail(_.bind(e.reject,e))}}function O(e,t){if(t&&t.TwitterProfile&&t.TwitterProfile.name){u=t.TwitterProfile;if(t.userID<=0){if(t.loginReason==1){e.reject({error:"LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING"});return}D.call(this,e)}else t.oauthToken=s,t.oauthSecret=o,e.resolve(t),n.trigger("twitter:profile:update")}else t&&t.loginReason==1?e.reject({error:"LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING"}):e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"})}function M(e,t){if(t.result==1&&t.twitterProfileURL&&t.twitterProfileCallback){this.loadUserProfile(p.model.get("appToken"),t.twitterProfileURL,t.twitterProfileCallback,!0),t.oauthToken=s,t.oauthSecret=o,this.connected=!0,e.resolve(t);var n=d.get("Flags");!(n&this.SERVICE_ID)&&!(n&this.TWITTER_ONLY_SERVICE_ID),d.set("Flags",n|this.SERVICE_ID)}else t.result===-1?e.reject({error:"TWITTER_DUPLICATE_ACCOUNT_ERROR_MSG"}):t.result===-2?e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}):e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"})}function D(e){if(!u||!u.screen_name){e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"});return}var t=u.screen_name,r=_.orEqual(u.name,""),i=u.id_str||Math.floor(Math.random()*997508)+1005;r||t?n.Services.API.getUsernameSuggestions(t,r,i).done(_.bind(P,this,e)).fail(_.bind(function(t){e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"})},this,e)):e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"})}function P(e,t){n.router.setHash("signup",{signupType:"twitter",thirdPartyDetails:{oauthToken:s,oauthSecret:o,twitterUserID:u.id},defaultValues:{username:_.orEqual(t[0],""),name:u.name}})}function H(e,t,n,r,i){if(i==="success"&&r&&r.length){var s={};_.forEach(r,_.bind(function(e){f[e.id_str]=e,s[e.id_str]=e},this)),e.notify(s,f)}else n.errors++;n.remaining--;if(!n.remaining){if(n.errors===n.total){e.reject();return}a=t,e.resolve(t,f)}}n.Services=n.Services||{};var r=0,i=!1,s=null,o=null,u={},a=[],f={},l=[],c={},h,p,d,v,m;n.Services.Twitter={lastError:null,SERVICE_ID:4096,TWITTER_ONLY_SERVICE_ID:8192,connected:!1,registeredWithTwitter:!1,profileLoaded:!1,init:function(e){p=e,p.model.on("change:user",S,this),n.ready.done(_.bind(this.appReady,this))},appReady:function(){S.call(this)},reset:function(){this.connected=!1,this.profileLoaded=!1,this.registeredWithTwitter=!1,s=null,o=null,u={},a=[],f={},c={},l=[],n.trigger("twitter:profile:update")},removeFromUser:function(){var e=$.Deferred();return u&&u.id_str?n.Services.API.removeUserTwitterData(u.id_str,_.bind(k,this,e)):n.Services.API.removeUserTwitterData(null,_.bind(k,this,e)),e.promise()},loadUserProfile:function(e,t,r,i,s){if(e!==p.model.get("appToken"))return(s||$.Deferred()).reject().promise();if(!i&&v&&v.state()==="pending")return v.promise();var o=n.getLoggedInUserID();return s||(s=$.Deferred()),!i&&this.profileLoaded?s.resolve(u):($.ajax({url:t,success:_.bind(C,this,s,o),error:_.bind(L,this,s,o),dataType:"jsonp",jsonp:!1,jsonpCallback:r,cache:!0}),v=s),s.promise()},login:function(t,n){var r=$.Deferred(),i=_.getCenteredCoordinates(650,600);return t!==p.model.get("appToken")?r.reject().promise():(h=e.open(e.location.protocol+"//"+e.location.host+"/twitterCallback.php?window="+e.name,"","width=650,height=600,left="+i[0]+",top="+i[1]),m=$.Deferred(),m.always(_.bind(A,this,r,n)),r.promise())},connectionLogout:function(){var t=_.getCenteredCoordinates(1e3,580);e.open("https://twitter.com/logout","","width=1000,height=580,status=1,location=1,resizable=yes,left="+t[0]+",top="+t[1])},getTwitterShareMessage:function(e,t,n,r){var i="",s="",o=n&&n.length?25:0;switch(e){case"song":i=t.get("SongName"),i.length>40&&(i=i.substr(0,37)+"..."),s=_.getString("SHARE_TWITTER_SONG",{SongName:i,ArtistName:t.get("ArtistName")});break;case"artist":i=t.get("ArtistName"),i.length>60&&(i=i.substr(0,57)+"..."),s=_.getString("SHARE_TWITTER_ARTIST",{ArtistName:i});break;case"album":i=t.get("AlbumName"),i.length>40&&(i=i.substr(0,37)+"..."),s=_.getString("SHARE_TWITTER_ALBUM",{AlbumName:i,ArtistName:t.get("ArtistName")});break;case"playlist":i=t.get("PlaylistName"),i.length>40&&(i=i.substr(0,37)+"..."),s=_.getString("SHARE_TWITTER_PLAYLIST",{PlaylistName:i,UserName:t.get("UserName")});break;case"broadcast":i=t.get("Name");if(t.isLoggedInUserOwner()){s=_.getString("SHARE_TWITTER_BROADCAST",{BroadcastName:i});if(s>140-o-18){var u=_.getString("SHARE_TWITTER_BROADCAST",{BroadcastName:""}),a;i>140-o-1&&(a=i.substr(0,140-o-3-u.length)+"..."),s=_.getString("SHARE_TWITTER_BROADCAST",{BroadcastName:a})}}else s=_.getString("SHARE_TWITTER_BROADCAST_OTHER");break;case"user":i=t.get("Name"),i.length>40&&(i=i.substr(0,37)+"..."),s=_.getString("SHARE_TWITTER_USER",{UserName:t.get("Name")})}return s.length<128-o-18?s+=" #nowplaying":s.length<137-o-18&&(s+=" #np"),s.length<127-o-18&&(new Date).format("D")==="Mon"&&(s+=" #musicmonday"),s.length<130-o-18&&(new Date).format("D")==="Tue"&&(s+=" #tunesday"),s},shareLink:function(t,r,i,u,a){var f=$.Deferred(),l=_.getCenteredCoordinates(700,280);a&&(u=n.Services.Twitter.getTwitterShareMessage(i,a,r)+" "+r);if(t!==p.model.get("appToken"))return f.reject().promise();if(s&&o){n.trigger("lightbox:open","postTweet",{appToken:t,message:u,url:r,type:i});return}return u=u.replace(r,""),e.open("http://twitter.com/share?related=grooveshark&via=grooveshark&url="+encodeURIComponent(r)+"&text="+encodeURIComponent(u),"","width=700,height=280,left="+l[0]+",top="+l[1]),f.resolve(!0,!0),f.promise()},postTweet:function(e,t,r){var i=$.Deferred();return e!==p.model.get("appToken")?i.reject().promise():(s&&o?(t.length<123&&(t+=" via @grooveshark"),n.Services.API.postTwitterStatus(t,s,o).done(_.bind(g,this,i,r)).fail(_.bind(y,this,i,r))):i.reject(),i.promise())},getFriends:function(e){var t=$.Deferred();return e!==p.model.get("appToken")?t.reject().promise():(a.length&&f?t.resolve(a,f):s&&o?n.Services.API.getTwitterFriends(u.id_str,s,o).done(_.bind(function(e){var n={remaining:e.requests.length,total:e.requests.length,errors:0};a=[],f={},e.requests.length&&e.ids.length?_.each(e.requests,_.bind(function(r){$.ajax({url:r.url,dataType:"jsonp",jsonp:!1,jsonpCallback:r.callback,cache:!0}).always(_.bind(H,this,t,e.ids,n))},this)):t.resolve(e.ids,f)},this)).fail(t.reject):t.reject(),t.promise())},getGroovesharkUsersFromFollowing:function(e){var t=$.Deferred(),r=this.getFriends(e);return e!==p.model.get("appToken")?t.reject().promise():(r.done(function(e){if(!e){t.reject();return}n.Services.API.getGroovesharkUsersFromTwitterUserIDs(e).done(function(e){e?t.resolve(e):t.reject()})}),r.fail(t.reject),t.promise())},getProfile:function(e){if(e!==p.model.get("appToken"))return;return u},getImageURL:function(){return u?u.profile_image_url:""},getDisplayName:function(){return u?u.screen_name:""}},e.confirmTwitterConnection||(e.confirmTwitterConnection=function(e){h&&(h.close(),h=null);var t=m;if(!t)return;try{e=$.parseJSON(e)}catch(n){t.reject({error:"parseError"});return}e.mode==="cancel"||e.error==="cancel"?t.reject({error:"cancel"}):t.resolve(e)})}(),function(){function g(e,t,r){var i=new $.Deferred;return n.Services.API.makeLastfmRequest(e,t,r).done(_.bind(y,this,i)).fail(_.bind(b,this,i)),i.promise()}function y(e,t){if(typeof t!="object")try{t=$.parseJSON(t)}catch(n){}if(t&&t.error){b(e,t);return}e&&e.resolve(t)}function b(e,t){if(typeof t!="object")try{t=$.parseJSON(t)}catch(n){}e&&e.reject(t)}function w(e,t,r){if(t!=n.getLoggedInUserID())return;r.user?($.extend(o,r.user),this.profileLoaded=!0,this.connected=!0,e&&e.resolve(o)):E(e,r)}function E(e,t,r){if(t!=n.getLoggedInUserID())return;this.reset(),e&&e.reject()}function S(){var e,r,s;if(!v||typeof v.get("queueSongID")!="number"){m=null;return}if(!this.shouldScrobble()||!a||v.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;if(!m||v.get("queueSongID")!==m.queueSongID||v.get("SongID")!==m.songID)m={songID:v.get("SongID"),queueSongID:v.get("queueSongID"),secondsListened:0,scrobbled:!1};else{if(d.get("repeatMode")!==n.Models.Player.repeatModes.ONE||v.get("queueSongID")!==m.queueSongID)return;m.scrobbled=!1,m.secondsListened=0}e={album:v.get("AlbumName"),artist:v.get("ArtistName"),method:"track.updateNowPlaying",track:v.get("SongName"),sk:a.session,api_key:t},v.get("TrackNum")&&(r=Number(v.get("TrackNum")),_.isNaN(r)||(e.trackNumber=String(r))),v.get("EstimateDuration")&&(s=Number(v.get("EstimateDuration")),_.isNaN(s)||(e.duration=Math.round(s))),e.api_sig=P(e),g(i,e,"POST").fail(function(){n.trigger("notification:add",{title:_.getString("LASTFM_PROBLEM_SCROBBLING_ERROR_MSG"),type:"error",click:function(){n.router.setHash("/settings/connect")},duration:3e4})})}function x(){var e,r,s;if(!v||typeof v.get("queueSongID")!="number"){m=null;return}if(!this.shouldScrobble()||!a||v.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;if(!m||v.get("queueSongID")!==m.queueSongID||v.get("SongID")!==m.songID)return;m.secondsListened+=.5;if(v.get("duration")>this.MINIMUM_DURATION*1e3&&m.secondsListened>v.get("duration")/2e3&&!m.scrobbled){r=Math.round($.now()/1e3),e={album:v.get("AlbumName"),artist:v.get("ArtistName"),track:v.get("SongName"),timestamp:r,duration:Math.round(v.get("duration")/1e3),method:"track.scrobble",sk:a.session,api_key:t},v.get("TrackNum")&&(s=Number(v.get("TrackNum")),_.isNaN(s)||(e.trackNumber=String(s)));if(v&&v.get("context")){switch(v.get("context").streamType){case n.Models.PlayContext.TYPE_STATION:case n.Models.PlayContext.TYPE_RADIO:case n.Models.PlayContext.TYPE_DMCA_RADIO:case n.Models.PlayContext.TYPE_BROADCAST:e.chosenByUser=0;break;default:e.chosenByUser=1}v.get("context").type=="radio"&&(e.chosenByUser=0)}e.api_sig=P(e),m.scrobbled=!0,m.timestamp=r,g(i,e,"POST").fail(function(){n.trigger("notification:add",{title:_.getString("LASTFM_PROBLEM_SCROBBLING_ERROR_MSG"),type:"error",click:function(){n.router.setHash("/settings/connect")},duration:3e4})})}}function T(){h&&h.off("change:extraData",N,this),h=c.model.get("user"),this.reset(),typeof h.get("extraData")=="undefined"?h.on("change:extraData",N,this):N.call(this)}function N(){var e,t;h&&h.get("isLoggedIn")&&h.hasLastfmDataStored()&&(e=h.get("extraData"),e&&e.Lastfm?C.call(this,e.Lastfm).fail(function(e){t="LASTFM_PROBLEM_CONNECTING_ERROR_MSG",e&&e.error&&(t=e.error),n.trigger("notification:add",{title:_.getString(t),type:"error",click:function(){n.router.setHash("/settings/connect")},duration:3e4})}).done(_.bind(function(){this.loadLastfmProfile(c.model.get("appToken"))},this)):gsConfig.runMode!=="production"&&console.error("Supposed to have Lastfm data for auth user but undefined!!",h,e))}function C(e){var t=$.Deferred();try{return e&&e.Session&&e.LastfmUsername?(o={username:e.LastfmUsername,flags:0},this.connected=!0,a={session:e.Session},e.FlagScrb==null&&e.FlagFav==null?o.flags=1:(e.FlagScrb&&(o.flags=o.flags|this.SCROBBLING_FLAG),e.FlagFav&&(o.flags=o.flags|this.FAVORITES_FLAG)),o.flags&this.SCROBBLING_FLAG&&this.enableScrobbling(c.model.get("appToken")),t.resolve()):(gsConfig.runMode!=="production"&&console.error("onUserLastfmData returned invalid resp:",e),k.call(this,"onUserLastfmData returned invalid resp")),t.promise()}catch(n){gsConfig.runMode!=="production"&&console.error("onUserLastfmData exception thrown:",n)}return this.reset(),t.reject({error:"LASTFM_MISSING_LOGIN_INFO_ERROR_MSG"}),t.promise()}function k(e,t){t&&t.reject()}function L(e,t){var n;if(!t||!t.success){e.reject();return}n=h.get("Flags"),h.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()}function A(e,t){console.log("Lastfm:onLogin",t);if(t.error)e.reject({error:"LASTFM_MISSING_LOGIN_INFO_ERROR_MSG"});else{if(!t.token){e.reject({error:"LASTFM_MISSING_LOGIN_INFO_ERROR_MSG"});return}h.get("Flags")&this.SERVICE_ID?n.Services.API.updateLastfmService("",t.token,"",0,0,_.bind(O,this,e)):(typeof o.flags=="undefined"&&(o.flags=this.DEFAULT_FLAGS),n.Services.API.saveLastfmService("",t.token,"",o.flags,_.bind(O,this,e)),this.enableScrobbling(c.model.get("appToken")))}}function O(e,t){var n;t.result>0&&t.lastfmData&&t.lastfmData.user?(o.username=t.lastfmData.user,a={session:t.lastfmData.session},this.connected=!0,this.loadLastfmProfile(c.model.get("appToken"),!0).done(function(){e.resolve()}).fail(function(){e.reject({error:"LASTFM_PROBLEM_CONNECTING_ERROR_MSG"})}),n=h.get("Flags"),h.set("Flags",n|this.SERVICE_ID)):t.result===-1?e.reject({error:"LASTFM_DUPLICATE_ACCOUNT_ERROR_MSG"}):t.result===-3?e.reject({error:"LASTFM_PROBLEM_CONNECTING_ERROR_MSG"}):e.reject({error:"LASTFM_MISSING_LOGIN_INFO_ERROR_MSG"})}function M(){d&&d.off(null,null,this),d=p.get("queue"),d.on("change:activeSong",D,this)}function D(){v&&v.off(null,null,this),v=d.get("activeSong"),v&&(v.on("change:playStatus",S,this),v.on("change:position",x,this))}function P(e){var t=_.keys(e),n="",r=0,i=t.length;t.sort();for(;r<i;r++)t[r]&&e.hasOwnProperty(t[r])&&(n+=t[r]+e[t[r]]);return n+="f8ed9c4ea2f1b981e61e1d0df1a98406",n=hex_md5(n.toString()),n}n.Services=n.Services||{};var t="b1ecfd8a5f8ec4dbb4cdacb8f3638f6d",r="http://www.last.fm/api/auth",i="http://ws.audioscrobbler.com/2.0/",s,o={},u=!1,a,f,l,c,h,p,d,v,m;n.Services.Lastfm={SERVICE_ID:2,P_VERSION:"1.2.1",CLIENT_ID:"gvs",CLIENT_VERSION:"1",MINIMUM_DURATION:120,SCROBBLING_FLAG:1,DEFAULT_FLAGS:1,connected:!1,init:function(e){c=e,c.model.on("change:user",T,this),p=c.model.get("player"),p.on("change:queue",M,this),M.call(this),n.ready.done(_.bind(this.appReady,this))},appReady:function(){T.call(this)},reset:function(){this.connected=!1,o={},this.profileLoaded=!1,a=null,l=null,this.suspendScrobbling(),m=null},removeFromUser:function(){var e=$.Deferred();return o&&o.username?n.Services.API.removeLastfmService(o.username,_.bind(L,this,e)):n.Services.API.removeLastfmService(null,_.bind(L,this,e)),e.promise()},login:function(n){var i=$.Deferred(),o=_.getCenteredCoordinates(950,700),u;return n!==c.model.get("appToken")?i.reject().promise():(u="http://"+e.location.host+"/lastfmCallback.php?window="+e.name,s=e.open(r+"?api_key="+t+"&cb="+encodeURIComponent(u),"","width=950,height=700,left="+o[0]+",top="+o[1]),f=$.Deferred(),f.always(_.bind(A,this,i)),i.promise())},loadLastfmProfile:function(e,r){var s=$.Deferred(),u={method:"user.getinfo",sk:a.session,api_key:t},f=n.getLoggedInUserID();return e!==c.model.get("appToken")?s.reject().promise():!r&&l&&l.state()==="pending"?l.promise():(!a||!a.session?s.reject():!r&&this.profileLoaded?s.resolve(o):(g(i,u).done(_.bind(w,this,s,f)).fail(_.bind(E,this,s,f)),l=s),s.promise())},suspendScrobbling:function(e){if(e!==c.model.get("appToken"))return;u=!1},enableScrobbling:function(e){if(e!==c.model.get("appToken"))return;u=!0},shouldScrobble:function(){return o&&o.flags&this.SCROBBLING_FLAG&&u},getProfile:function(e){if(e!==c.model.get("appToken"))return;return o},getImageURL:function(){var e;if(o&&o.image)for(e=Math.min(1,o.image.length-1);e>=0;e--)if(o.image[e]["#text"])return o.image[e]["#text"];return"http://cdn.last.fm/flatness/catalogue/noimage/2/default_user_large.png"},getDisplayName:function(){return o?o.username:""},isScrobblingEnabled:function(){return u}},e.confirmLastfmConnection||(e.confirmLastfmConnection=function(e){console.log("lastfm confirm connection",e),s&&(s.close(),s=null);var t=f;if(!t)return;try{e=$.parseJSON(e)}catch(n){t.reject({error:"parseError"});return}t.resolve(e)})}(),function(){function v(){if(typeof e.FlattrLoader=="object"){s||m.call(this);return}if($.browser.msie&&$.browser.version<=6)return;var t=null,n=this;i++;try{var o=$("#flattr-js");if(o.find("script").length)o.empty(),e.FlattrLoader=null;else if(!document.getElementById("flattr-js")){var u=document.createElement("div");u.id="flattr-js",document.body.appendChild(u)}var a=document.createElement("script");a.async=!0,a.src=document.location.protocol+"//api.flattr.com/js/0.6/load.js?mode=manual&popout=0&revsharekey="+r;var f=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){e.FlattrLoader&&(clearTimeout(t),m.call(n))},100)};a.onload=a.onreadystatechange=f,document.getElementById("flattr-js").appendChild(a)}catch(a){console.error("Could not load Flattr JS. Fatal Error: ",a)}t=setTimeout(function(){!e.FlattrLoader&&i<3?v.call(n):!e.FlattrLoader&&i>=3},2e4)}function m(){if(typeof e.FlattrLoader!="object"||!e.FlattrLoader)return;s=!0,g.call(this)}function g(){if(typeof e.FlattrLoader!="object"||!e.FlattrLoader){v.call(this);return}try{e.FlattrLoader.setup()}catch(t){}}function y(){h&&h.off("change:extraData",b,this),h=c.model.get("user"),this.reset(),typeof h.get("extraData")=="undefined"?h.on("change:extraData",b,this):b.call(this)}function b(){if(h&&h.get("isLoggedIn")&&h.hasFlattrDataStored()){var e=h.get("extraData");e&&e.Flattr?w.call(this,e.Flattr):gsConfig.runMode!=="production"&&console.error("Supposed to have Flattr data for auth user but undefined!!",h,e)}}function w(e){var t=$.Deferred();try{e&&e.AccessToken&&e.FlattrUsername?(f=e.AccessToken,o={},o.username=e.FlattrUsername,o.flags=0,o.autoPerMonth=!1,o.autoPerStream=!1,o.autoPerFavorite=!1,this.connected=!0,e.Flags&&(o.flags=e.Flags,e.Flags&this.FLATTR_AUTO_PER_MONTH_FLAG?(o.autoPerMonth=!0,p.on("change:position",C,this)):e.Flags&this.FLATTR_AUTO_PER_STREAM_FLAG&&(o.autoPerStream=!0),e.Flags&this.FLATTR_AUTO_PER_FAVORITE_FLAG&&(o.autoPerFavorite=!0))):(gsConfig.runMode!=="production"&&console.error("onUserFlattrData returned invalid resp:",e),M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"),t.reject());return}catch(n){gsConfig.runMode!=="production"&&console.error("onUserFlattrData exception thrown:",n)}return this.reset(),t.reject(),M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"),t.promise()}function E(e,t){if(t.error)e.reject(),M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG");else{if(!t.accessToken){e.reject(),M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG");return}f=t.accessToken,this.loadFlattrProfile(c.model.get("appToken"),null,!0).done(_.bind(function(){if(!this.profileLoaded||!o.username){M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"),e.reject();return}o.flags==null&&(o.flags=this.DEFAULT_FLAGS),h.get("Flags")&this.SERVICE_ID?n.Services.API.updateUserFlattrData(f,o.username,o.flags).always(_.bind(x,this,e)):n.Services.API.saveUserFlattrData(f,o.username,o.flags).always(_.bind(x,this,e))},this))}}function S(e,t,r){if(t!=n.getLoggedInUserID())return;try{r=$.parseJSON(r)}catch(i){console.warn("Failed to load flattr profile. Result",r),e.reject(),M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG");return}r&&!r.error&&r.username?(r.avatar?o.avatar=r.avatar:o.avatar=gsConfig.assetHost+"webincludes/css/images/services/flattr-small.png",o.link=r.link,o.username=r.username,o.firstname=r.firstname,o.lastname=r.lastname,this.profileLoaded=!0,this.connected=!0,n.trigger("flattr:profile:update"),e.resolve()):(gsConfig.runMode!=="production"&&console.error("flattr::onUserProfile returned unexpected resp:",r),e.reject())}function x(e,t){if(t==1){this.connected=!0,e.resolve();var n=h.get("Flags");h.set("Flags",n|this.SERVICE_ID)}else t===-1?(M.call(this,"FLATTR_NAME_ALREADY_IN_USE"),e.reject()):(M.call(this,"FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"),e.reject())}function T(e,t){if(!t){M.call(this,"FLATTR_PROBLEM_REMOVING_MSG"),e.reject();return}var n=h.get("Flags");h.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()}function N(){var e=c.model.get("player").get("queue");if(!e)return;var t=e.get("activeSong");if(!t||typeof t.get("queueSongID")!="number"){d=null;return}if(!d||t.get("queueSongID")!==d.queueSongID||t.get("SongID")!==d.songID)d={songID:t.get("SongID"),queueSongID:t.get("queueSongID"),secondsListened:0,flattrd:!1,MusicBrainzID:null,artistID:t.get("ArtistID")};else{if(e.get("repeatMode")!==n.Models.Player.repeatModes.ONE||t.get("queueSongID")!==d.queueSongID)return;d.flattrd=!1,d.secondsListened=0}t&&this.connected&&o.autoPerMonth&&p&&p.setFlattr(!0)}function C(){if(!this.connected||this.tmpAutoOff||p.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=c.model.get("player").get("queue");if(!e)return;var t=e.get("activeSong");if(!t||typeof t.get("queueSongID")!="number"){d=null;return}if(!d||t.get("queueSongID")!==d.queueSongID||t.get("SongID")!==d.songID)return;d.secondsListened+=.5,d.secondsListened*1e3/p.get("duration")>=.8&&d.MusicBrainzID&&!d.flattrd&&(d.flattrd=!0,L.call(this,d.MusicBrainzID,{artistID:d.artistID,isSong:d.isSong}))}function k(e){if(!e)return;if(!this.isUserListenAndFlattr())return;var t=e.pageInfo,n=e.songPageInfo;(t.Data.MusicBrainzID||n.Data&&n.Data.MusicBrainzID)&&d&&(d.isSong=n.Data&&n.Data.MusicBrainzID,d.MusicBrainzID=d.isSong?n.Data.MusicBrainzID:t.Data.MusicBrainzID)}function L(e,t){var r=t&&t.isSong?this.musicBrainzSongURL:this.musicBrainzArtistURL,i={"compat-errors":1,access_token:f,url:"http://flattr.com/submit/auto?url="+r+e+"&category=audio&tags=music"};n.Services.API.makeFlattrRequest("flattr",i,"POST").always(_.bind(A,this,t))}function A(e,t){try{t=JSON.parse(t)}catch(n){console.log("onFlattrURLComplete - bad json"),M.call(this);return}if(t.message&&t.message=="ok")e&&e.notify&&D.call(this);else if(t.error)switch(t.error){case"flattr_once":break;case"flattr_owner":break;case"no_means":M.call(this,"FLATTR_SERVICE_TEMP_OFF"),this.tmpAutoOff=!0;break;case"not_found":case"invalid_request":case"unauthorized":default:M.call(this)}}function O(e){if(!e)return;if(!this.isUserFavoriteAndFlattr())return;e.getPageNameData().done(_.bind(function(t){t.MusicBrainzID?L.call(this,t.MusicBrainzID,{artistID:e.get("ArtistID"),notify:!0,isSong:!0}):n.Models.Artist.getCached([e.get("ArtistID")]).getPageNameData().done(_.bind(function(t){L.call(this,t.MusicBrainzID,{artistID:e.get("ArtistID"),notify:!0})},this))},this))}function M(e){if(!e||!e.length)e="FLATTR_SERVICE_DEFAULT_ERROR";var t=_.getString(e);n.trigger("notification:add",{title:"Flattr",description:t,type:"error"})}function D(e){if(!e||!e.length)e="FLATTR_SERVICE_DEFAULT_SUCCESS_FLATTR";var t=_.getString(e);n.trigger("notification:add",{title:"Flattr",description:t,icon:"flattr",type:"success"})}function P(e){var t=$.Deferred(),r={};return e.url=this.musicBrainzArtistURL+e.mbID,n.Services.API.makeFlattrRequest("things/lookup/?compat-errors&url=http://flattr.com/submit/auto?url="+encodeURIComponent(e.url),r,"POST").always(_.bind(function(e,t){try{t=JSON.parse(t),e.resolve(t)}catch(n){M.call(this),e.reject()}},this,t)),t.promise()}function H(e){var t=$.Deferred(),r={count:30};return n.Services.API.makeFlattrRequest("things/"+e+"/flattrs",r,"GET").always(_.bind(function(e,t){try{t=JSON.parse(t),e.resolve(t)}catch(n){M.call(this),e.reject()}},this,t)),t.promise()}function B(){e.FlattrLoader&&$.each($("a.FlattrButton"),function(t,n){e.FlattrLoader.loadButton(n)})}function j(e,t,n){var r="flattr;popout:0;category:audio;tags:music",i=e.data("song")?this.musicBrainzSongURL:this.musicBrainzArtistURL;n&&(r="flattr;button:compact;popout:0;category:audio;tags:music");var s=$('<a class="FlattrButton" style="display:none;" rev="'+r+'" href="'+i+t+'"></a>');e.append(s),g.call(this)}n.Services=n.Services||{};var t="QAzyxeB9yS0VqfQ3e0l6AQef5VIVnbW3CmsZqTYPCPBSUhLY8XVyDZEyKcjXe6RG",r="05e1a1",i=0,s=!1,o={},u,a,f,l,c,h,p,d;n.Services.Flattr={SERVICE_ID:131072,URL_USER_AUTH:"https://flattr.com/oauth/authorize",musicBrainzArtistURL:"http://musicbrainz.org/artist/",musicBrainzSongURL:"http://musicbrainz.org/recording/",URL_REST_API:"https://api.flattr.com/rest/v2/",connected:!1,tmpAutoOff:!1,flags:0,DEFAULT_FLAGS:0,FLATTR_AUTO_PER_MONTH_FLAG:1,FLATTR_AUTO_PER_STREAM_FLAG:2,FLATTR_AUTO_PER_FAVORITE_FLAG:4,lastError:"",init:function(e){c=e,c.model.on("change:user",y,this),n.on("flattr:flattrData",_.bind(k,this)),n.on("flattr:flattrCount",_.bind(P,this)),n.on("flattr:songFaved",_.bind(O,this)),n.on("flattr:renderEmbed",_.bind(j,this)),p=c.model.get("player"),p.setFlattr(o.autoPerMonth),p.on("change:queue",function(){p.get("queue").on("change:activeSong",N,this)},this),n.ready.done(_.bind(this.appReady,this))},appReady:function(){y.call(this)},reset:function(){this.connected=!1,o={},this.profileLoaded=!1,d=null,p&&_.isFunction(p.setFlattr)&&p.setFlattr(!1),n.trigger("flattr:profile:update")},loadFlattrProfile:function(e,t,r){if(e!==c.model.get("appToken"))return(t||$.Deferred()).reject().promise();if(!r&&l&&l.state()==="pending")return l.promise();t||(t=$.Deferred());var i={"compat-errors":1,access_token:f},s=n.getLoggedInUserID();return f?!r&&this.profileLoaded?t.resolve(o):(n.Services.API.makeFlattrRequest("user",i,"GET").always(_.bind(S,this,t,s)),l=t):t.reject(),t.promise()},removeFromUser:function(){var e=$.Deferred();return n.Services.API.removeUserFlattrData().always(_.bind(T,this,e)),e.promise()},login:function(n){var r=$.Deferred(),i=_.getCenteredCoordinates(850,600);if(n!==c.model.get("appToken"))return r.reject().promise();var s="http://"+e.location.host+"/flattrCallback.html",o="window-"+e.name;return u=e.open(this.URL_USER_AUTH+"?response_type=token&scope=flattr&client_id="+t+"&redirect_uri="+encodeURIComponent(s)+"&state="+encodeURIComponent(o),"","width=850,height=600,left="+i[0]+",top="+i[1]),a=$.Deferred(),a.always(_.bind(E,this,r)),r.promise()},enableListenAndFlattr:function(e){var t=$.Deferred(),r=o.flags|this.FLATTR_AUTO_PER_MONTH_FLAG;return e!==c.model.get("appToken")?t.reject().promise():(n.Services.API.updateUserFlattrData(f,o.username,r).then(_.bind(function(e,t){o.flags=r,o.autoPerMonth=!0,p.on("change:position",C,this),e.resolve()},this,t)).fail(_.bind(function(e){M.call(this,"FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),t.promise())},disableListenAndFlattr:function(e){var t=$.Deferred(),r=o.flags&~this.FLATTR_AUTO_PER_MONTH_FLAG;return e!==c.model.get("appToken")?t.reject().promise():(n.Services.API.updateUserFlattrData(f,o.username,r).then(_.bind(function(e,t){o.flags=r,o.autoPerMonth=!1,p.off("change:position",C,this),e.resolve()},this,t)).fail(_.bind(function(e){M.call(this,"FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),t.promise())},enableFavoriteAndFlattr:function(e){var t=$.Deferred(),r=o.flags|this.FLATTR_AUTO_PER_FAVORITE_FLAG;return e!==c.model.get("appToken")?t.reject().promise():(n.Services.API.updateUserFlattrData(f,o.username,r).then(_.bind(function(e,t){o.flags=r,o.autoPerFavorite=!0,e.resolve()},this,t)).fail(_.bind(function(e){M.call(this,"FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),t.promise())},disableFavoriteAndFlattr:function(e){var t=$.Deferred(),r=o.flags&~this.FLATTR_AUTO_PER_FAVORITE_FLAG;return e!==c.model.get("appToken")?t.reject().promise():(n.Services.API.updateUserFlattrData(f,o.username,r).then(_.bind(function(e,t){o.flags=r,o.autoPerFavorite=!1,e.resolve()},this,t)).fail(_.bind(function(e){M.call(this,"FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),t.promise())},connectionLogout:function(){var t=_.getCenteredCoordinates(800,720);e.open("https://flattr.com/session/logout","","width=800,height=720,status=1,location=1,resizable=yes,left="+t[0]+",top="+t[1])},isUserConnected:function(){return h&&h.get("isLoggedIn")&&h.get("Flags")&this.SERVICE_ID},isUserListenAndFlattr:function(){return o.autoPerMonth},isUserFavoriteAndFlattr:function(){return o.autoPerFavorite},getProfile:function(e){if(e!==c.model.get("appToken"))return;return o},getImageURL:function(){return o?o.avatar:""},getDisplayName:function(){return o?o.username:""}},e.confirmFlattrConnection||(e.confirmFlattrConnection=function(e){u&&(u.close(),u=null);var t=a;if(!t)return;try{e=$.parseJSON(e)}catch(n){t.reject({error:"parseError"});return}if(!e.hash){t.reject({error:"invalid"});return}var r={accessToken:null},i=e.hash.match(/access\_token\=([a-zA-Z0-9\-\_]+)/);i&&i[1]&&(r.accessToken=i[1]),t.resolve(r)})}(),function(){function a(e,t,r,i,s){if(s.feed&&s.feed.entry){var o=s.feed.entry,a=[],c={};_.forEach(o,function(e){if(!e.media$group||!e.media$group.media$thumbnail)return;c={Author:"",Description:"",Duration:0,Rating:0,LikeRatio:0,VideoID:"",Plays:0,URL:"",Title:"",Thumbnails:[]},e.author&&e.author[0]&&e.author[0].name&&e.author[0].name.$t?c.Author=e.author[0].name.$t:e.media$group.media$credit&&e.media$group.media$credit.$t&&(c.Author=e.media$group.media$credit.$t),e.media$group.media$description&&e.media$group.media$description.$t&&(c.Description=e.media$group.media$description.$t),e.media$group.yt$duration&&e.media$group.yt$duration.seconds&&(c.Duration=parseInt(e.media$group.yt$duration.seconds,10)),e.gd$rating&&e.gd$rating.average&&(c.Rating=parseFloat(e.gd$rating.average)),e.yt$rating&&e.yt$rating.numLikes&&e.yt$rating.numDislikes&&(c.LikeRatio=parseInt(e.yt$rating.numLikes,10)/parseInt(e.yt$rating.numDislikes,10));if(e.media$group.yt$videoid&&e.media$group.yt$videoid.$t)c.VideoID=e.media$group.yt$videoid.$t;else if(e.id){var t=e.id.split(":");c.VideoID=t[t.length-1]}e.yt$statistics&&e.yt$statistics.viewCount&&(c.Plays=parseInt(e.yt$statistics.viewCount,10)),e.title&&e.title.$t&&(c.Title=e.title.$t),e.link&&e.link[0]&&e.link.href&&(c.URL=e.link.href),_.forEach(e.media$group.media$thumbnail,function(e){if(e.yt$name)switch(e.yt$name){case"default":c.Thumbnails.unshift(e);return;case"hqdefault":c.Thumbnails.length&&c.Thumbnails[0].yt$name==="default"?c.Thumbnails.splice(1,0,e):c.Thumbnails.unshift(e);return}c.Thumbnails.push(e)}),c.type="youtube",c=new n.Models.Video(c),a.push(c)}),t&&(a=l(t,a)),u[r]=a,e.resolve(a.slice(0,i))}else f(e,s)}function f(e,t){e.reject(t)}function l(e,t){var n=[],r="";e&&e.get("ArtistName")&&(r=e.get("ArtistName").match(/[a-z0-9]/gi).join("").toLowerCase());var i=9.7,s=8.98,o=4.209,u=4.01,a=2.41,f=2.101,l=1.201,c=.82,h=.203;return _.forEach(t,function(e,p){if(e.get("VideoID")&&e.get("Author")&&e.get("durationSecs")>60){e.weight=Math.floor(u*(t.length-p));var d=e.get("Author").toLowerCase();d.lastIndexOf("vevo")>-1?e.weight*=i:d.lastIndexOf("emimusic")>-1?e.weight*=s:d.lastIndexOf("warnerbrosrecords")>-1?e.weight*=s:d.lastIndexOf("hollywoodrecords")>-1?e.weight*=s:d.lastIndexOf("records")>-1&&(e.weight*=o),r&&d.indexOf(r)>-1&&(e.weight*=f);var v=e.get("Title").toLowerCase();v.lastIndexOf("parody")>-1?e.weight*=h:v.lastIndexOf("official")>-1?e.weight*=a:v.lastIndexOf("cover")>-1?e.weight*=l:v.lastIndexOf("live")>-1&&(e.weight*=c);for(var m=0;m<n.length;m++)if(n[m].weight<e.weight){n.splice(m,0,e);return}n.push(e)}}),n}function c(t,n){var r={callbacks:[],addEvent:function(r,i){if(_.isFunction(i)){var s="yt"+r+n+Math.floor(Math.random()*1001);e[s]=i,i=s,this.callbacks.push(s)}t.addEventListener(r,i)},play:function(){t.playVideo()},playVideoAt:function(e){t.playVideoAt(e)},pause:function(){t.pauseVideo()},isPaused:function(){var e=this.getState();return e!=1&&e!=3},getState:function(){return t.getPlayerState()},stop:function(){t.stopVideo()},getCurrentTime:function(){return t.getCurrentTime()},getDuration:function(){return t.getDuration()},getVideoUrl:function(){return t.getVideoUrl()},getVolume:function(){return t.getVolume()/100},setVolume:function(e){t.setVolume(e*100)},loadVideoById:function(e){t.loadVideoById(e)},loadVideoByUrl:function(e){t.loadVideoByUrl(e)}};return $(t).parent().bind("remove",function(){try{r.callbacks&&r.callbacks.length&&_.forEach(r.callbacks,function(t){e[t]=null})}catch(t){}}),r}n.Services=n.Services||{};var t=[],r="http://gdata.youtube.com/feeds/api/videos",i="AI39si6SJVyxgw9MFbAdbXE-wbtZFdTl8qnY2UWX3dFA97c9PrcfAYDpqUh0iLeVEkurJsjUvDmObBWvLX-wmsy_kW8KHAgN-Q",s="Grooveshark",o,u={};n.Services.Youtube={init:function(n){o=n,e.onYouTubePlayerReady=function(e){var n=c($("#"+e)[0],e);t[e]&&(t[e](n),delete t[e])}},searchViaSong:function(e){var t="",n='"'+e.get("SongName").replace(/[\(\[][a-zA-Z0-9\s]+[\]\)]/g,"")+'"';return e.get("ArtistName").toLowerCase()!="unknown"&&e.get("ArtistName").toLowerCase()!="unknown artist"?t=['"'+e.get("ArtistName")+'"'||"",n||""].join(" "):t=n,t=$.trim(t),this.search(t,5,e)},search:function(e,t,n){var o=$.Deferred();e=$.trim(_.orEqual(e,"")),t=_.orEqual(t,5);if(!e)o.reject();else if(u[e])o.resolve(u[e].splice(0,t));else{var l="jQueryYoutube"+OAuth.nonce(10),c={"max-results":Math.min(t,15),orderBy:"relevance",safeSearch:"none",alt:"json-in-script",time:"all_time","start-index":1,q:e,callback:l,key:i,v:2,category:"music|Music|EMI|VEVO|official|Official",restriction:gsConfig.remoteAddr,format:5},h=r;OAuth.completeRequest({method:"GET",action:h,parameters:c},{consumerKey:s,consumerSecret:i});var p=OAuth.getParameterMap(c);h=h+"?"+$.param(p),$.ajax({url:h,success:_.bind(a,this,o,n,e,t),error:_.bind(f,this,o),dataType:"jsonp",jsonp:!1,jsonpCallback:l,cache:!0})}return o.promise()},attachPlayer:function(e,r,i,s,o){var u=new $.Deferred,a="videoYTObj"+s;if(!e||_.notDefined(e))u.reject();else{var f="http://www.youtube.com/v/"+e+"?version=3&enablejsapi=1&version=3&fs=1&playerapiid="+a,l={},c={allowScriptAccess:"always",allowFullScreen:"true"},h={id:a,name:a,allowFullScreen:"true"};r=r||480,i=i||385,o=_.orEqual(o,!0),t[a]=function(e){return u.resolve(e),o&&e.play(),!0},swfobject.embedSWF(f,s,r,i,"8",null,l,c,h),n.trigger("guts:log","youtubeLoadVideoById",{youtubeVideoID:e}),_.gaTrackEvent("youtube","loadVideoById",e)}return u.promise()}}}(),function(){function o(e){var t={callbacks:[],addEvent:_.bind(e.addEvent,e),loadVideoById:function(t){var n=new $.Deferred,r=$(e.element);return e.unload(),r.attr("src","http://player.vimeo.com/video/"+t+"?api=1&player_id="+r.attr("id")),e=$f(r),e.addEvent("ready",_.bind(u,this,n,e)),n.promise()}};return t}function u(e,t){t=o(t),e.resolve(t)}n.Services=n.Services||{};var t=[],r,i=new $.Deferred,s=0;n.Services.Vimeo={init:function(e){r=e},loadPlayerJS:function(){if(typeof e.Froogaloop=="function"){i.state()==="pending"&&this.onPlayerJSLoaded();return}var t=null,n=this;s++;try{if($("#froogaloop-js script").length)$("#froogaloop-js").empty(),e.Froogaloop=null;else if(!document.getElementById("froogaloop-js")){var r=document.createElement("div");r.id="froogaloop-js",document.body.appendChild(r)}var o=document.createElement("script");o.async=!0,o.src="/gs/resources/froogaloop.min.js";var u=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){e.Froogaloop&&(clearTimeout(t),n.onPlayerJSLoaded())},300)};o.onload=o.onreadystatechange=u,document.getElementById("froogaloop-js").appendChild(o)}catch(o){console.error("Could not load Froogaloop JS. Fatal Error: ",o)}t=setTimeout(function(){!e.Froogaloop&&s<3&&n.loadPlayerJS()},2e4)},onPlayerJSLoaded:function(){if(typeof e.Froogaloop!="function")return;i.resolve()},attachPlayer:function(e,t,r,s){this.loadPlayerJS();var o=new $.Deferred,a="videoVObj"+s;return i.done(_.bind(function(){if(!e||_.notDefined(e))o.reject();else{var i="http://player.vimeo.com/video/"+e+"?api=1&player_id=videoVObj"+s+"&autoplay=1";t=t||480,r=r||385;var f=document.createElement("iframe");f.className="vimeo",f.src=i,f.id=a,f.width=t,f.height=r;if(!document.getElementById(s)){o.reject();return}document.getElementById(s).appendChild(f);var l=$f(f);l.addEvent("ready",_.bind(u,this,o,l)),n.trigger("guts:log","vimeoLoadVideoById",{youtubeVideoID:e}),_.gaTrackEvent("vimeo","loadVideoById",e)}},this)),o.promise()}}}(),function(){function l(){var e=document.createElement("audio");return typeof e.canPlayType=="function"&&e.canPlayType("audio/mpeg").replace(/no/,"")!==""}function c(){return a!==null}function b(e){_.indexOf(y,e.type)==-1&&console.log("audio event",e.type,e,this),_.isFunction(v[e.type])&&v[e.type].call(this,e)}function w(){if(this._el){this._elEventHandler=_.bind(b,this);for(var e=0,t=g.length;e<t;e++)this._el.addEventListener(g[e],this._elEventHandler)}}function E(){if(this._el&&this._elEventHandler)for(var e=0,t=g.length;e<t;e++)this._el.removeEventListener(g[e],this._elEventHandler)}function A(e){(!e||!e.setGlobalVolume)&&n.Services.Log.notify("missing valid swf obj","ERROR",{hasSwf:!!e}),e.setGlobalVolume(this._globalVolume),e.setGlobalMuted(this._globalMute),e.setAudioCallback("GS.Services.AudioHandle._flashCallback"),this._computeSpectrumCallback&&this._swf.setComputeSpectrumCallback("GS.Services.AudioHandle._onSpectrumData",this._useFFT),D._preferredBufferSize&&e.setCurrentBufferSize(D._preferredBufferSize)}n.Services=n.Services||{};var r=["","",2,1],i=["",32e3,4e4,48e3,56e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4],s=[44100,48e3,32e3],o=["",8e3,16e3,24e3,32e3,4e4,48e3,56e3,64e3,8e4,96e3,112e3,128e3,144e3,16e4],u=[22050,24e3,16e3],a=null,f;$(document).ready(function(){try{var t=e.AudioContext||e.webkitAudioContext;a=new t,a.createScriptProcessor=a.createScriptProcessor||a.createJavaScriptNode}catch(n){}if(!a||!a.createScriptProcessor||!e.ArrayBuffer||!e.Uint8Array||!e.XMLHttpRequest||!e.WebSocket)a=null});var h=function(e){this.trigger("update",this,e())},p=_.throttle(h,500),d=_.throttle(h,500),v={canplay:function(e){this._canPlay=!0,this.trigger("canplay")},durationchange:function(e){var t=this,n=function(){return{position:t._el.currentTime*1e3,duration:t._el.duration*1e3}};p.call(this,n)},timeupdate:function(e){var t=this._el.currentTime,n=this,r=function(){return{position:n._el.currentTime*1e3,duration:n._el.duration*1e3}};Math.abs(t-this._lastPosition)>5?h.call(this,r):p.call(this,r),this._lastPosition=t},playing:function(e){this.trigger("playing",this)},waiting:function(e){this.trigger("buffering",this)},progress:function(e){var t=this,n=function(){return{percentLoaded:t._el.buffered.end(0)/t._el.duration}};this._el.duration&&this._el.buffered.length>=1&&d.call(this,n)},ended:function(e){this.trigger("complete",this)},error:function(e){var t="UNKNOWN";switch(e.target.error.code){case e.target.error.MEDIA_ERR_ABORTED:t="MEDIA_ERR_ABORTED";break;case e.target.error.MEDIA_ERR_NETWORK:t="MEDIA_ERR_NETWORK";break;case e.target.error.MEDIA_ERR_DECODE:t="MEDIA_ERR_DECODE";break;case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:t="MEDIA_ERR_SRC_NOT_SUPPORTED"}console.warn("audio tag error",t),this.trigger("error",this,{msg:t})}},m=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"],g=m,y=["timeupdate","suspend","progress"],S=function(e,t,n){var r=e||{},i=n,s=null,o=30,u=0,a=0,f,l,c,h,p,d;n===-1&&(o=4);var v=function(){var e=new ArrayBuffer(a),r=new Uint8Array(e),s=0,o;l=i;for(i=n+1;i<=l;i++)c=t[i],o=new Uint8Array(c.data),r.set(o.subarray(c.firstFrameByte,c.lastFrameLastByte),s),s+=c.lastFrameLastByte-c.firstFrameByte;return c&&(h=s-(c.lastFrameLastByte-c.firstFrameByte),p=c.frames),d=s,n=l,e};for(;;){i++;var m=t[i];if(!m)break;s+=m.frameDuration*m.frames,a+=m.lastFrameLastByte-m.firstFrameByte,u+=m.frames;if(s>=o){f=v();break}}return!f&&r.forceBuffer&&(i--,f=v()),{buffer:f,framesInBuffer:u,lastOneSecondByte:h,lastOneSecondFrames:p,lastFrameLastByte:d,lastCombinedPart:n,totalBytes:a}},x=function(e,t){var n=t[e],r=t[e+1],i=t[e+2],s=t[e+3];return s&127|(i&127)<<7|(r&127)<<14|(n&127)<<21},T=function(e){var t=null,n,a=0,f=null,l=0,c=0,h=0,p=0,d=0,v=new Uint8Array(e),m=0,g=v.length-5,y,b,w,E,S,T,N,C,k,L=0,A;for(;m<g;m++)if(v[m]===255&&m+1<g&&(v[m+1]&226)==226&&(v[m+1]&4)==0){y=r[(v[m+1]&24)>>3];if(!y){console.log("bad frame",m,v[m],v[m+1],(v[m+1]&24)>>3);continue}y==1?(b=i,w=s,C=144):(b=o,w=u,C=72),E=b[(v[m+2]&240)>>4],S=w[(v[m+2]&12)>>2],T=(v[m+2]&2)>>1,N=Math.floor(C*E/S+T);if(m+N>v.length)break;y&&E&&S&&N&&(f==null&&(k=C*8,f=m),d=S,l=m,h=m+N,a++,m+=N-1)}else if(m==0&&v[m]==73&&v[m+1]==68&&v[m+2]==51){var O=x(m+6,v);console.log("found id3v2",m,O),m+=O-1}else{if(v[m]==84&&v[m+1]==65&&v[m+2]==71){console.log("found id3v1",m);break}f!==null&&(c||(c=m),p++)}return p,f!=null&&(L=k/d,A=1/L),h<v.length&&(n=new ArrayBuffer(v.length-h),t=new Uint8Array(n),t.set(v.subarray(h,v.length))),{mp3Version:y,bitRate:E,sampleRate:d,firstFrameByte:f,lastFrameLastByte:h,samplesPerFrame:k,frameDuration:L,frames:a,framesPerSecond:A,excess:n}},N=function(e,t){var n=$.Deferred(),r=e.currentAudioSegment,i,s,o,u,f;return e.processingDfd?e.processingDfd:(t&&(i=t.lastFrameLastByte-t.lastOneSecondByte,s=new ArrayBuffer(e.byteLength+i),o=new Uint8Array(s),u=new Uint8Array(t),f=new Uint8Array(e),o.set(u.subarray(t.lastOneSecondByte,t.lastFrameLastByte)),o.set(f,i)),console.log("starting decode",a.currentTime),e.processingDfd=n,a.decodeAudioData(s||e,function(e){console.log("finished decode",a.currentTime,e.numberOfChannels,e.duration),n.resolve(e)},function(){var t=new Uint8Array(e);console.log("!!! failed to parse audio data",r,t[0],t[1],t[2],t[3],t.length),n.reject()}),n)},C=function(e,t){this.source=e,this.id=t,this._instanceVolume=1,this._interimVolume=D._globalVolume,this._goalVolume=D._globalVolume,this._fadeInterval=0,this._fadeStepSize=0,this._instanceMuted=!1;var r=0,i=0,s=0,o=0,u=0,l=[],c=[],h=-1,p=0,v;this._state=0,this._timer=0,this._lastStartTime=0,this._currentBuffer=-1,this._audioSegments=[],this._frameBuffers=l,this._parsedParts=c,this._gainNode=a.createGain(),this._nodes=[],this.currentTime=0,this.duration=0,this.bytes=Infinity;var m=this;this.playStatuses=n.Models.Player.playStatuses,this._gainNode.gain.value=D._globalMuted?0:this._interimVolume,this._gainNode.connect(a.destination);var g=function(e){e.id3v2Size&&(console.log("id3v2Size",e.id3v2Size,"bytes",e.bytes,e),m.bytes=e.bytes);if(e.done){console.log("done",e);var t=S({forceBuffer:!0},c,h);h=t.lastCombinedPart,w(t,null);var n=0;_.each(m._parsedParts,function(e){n+=e.frameDuration*e.frames}),m.duration=n,m.loaded=!0,m.updatePositionalData()}},y=function(e){var t,n,i,s,o,u;r+=e.byteLength,v?(s=new Uint8Array(v),n=new Uint8Array(e),t=new ArrayBuffer(v.byteLength+e.byteLength),i=new Uint8Array(t),i.set(s),i.set(n,s.length),e=t):console.log("got first?",a.currentTime),o=T(e),v=o.excess,o.data=e;if(!o.lastFrameLastByte)return;c.push(o),u=S({},c,h),h=u.lastCombinedPart;if(!u.buffer)return;w(u,o)},b=function(){this.trigger("buffering",this),this._state=this.playStatuses.BUFFERING,this.off("setup",b,this),f.eventDispatcher.on("json",g),f.eventDispatcher.on("data",y)};this.on("setup",b,this);var w=function(e,t){var n=e.framesInBuffer,a=e.buffer,f=o?s/o:0;a&&(i+=e.totalBytes,s+=n,t&&!o&&(u=t.frameDuration,o=t.framesPerSecond),a.frameDuration=u,a.firstFrameTime=f,a.frames=n,a.currentAudioSegment=p++,a.lastFrameLastByte=e.lastFrameLastByte,a.lastOneSecondByte=e.lastOneSecondByte,a.lastOneSecondFrames=e.lastOneSecondFrames,l.push(a),l.length==1&&(m.trigger("hasBuffers",this),m.trigger("canplaythrough",this)));var c=function(){return console.log(r,m.bytes),{percentLoaded:r/m.bytes}};d.call(m,c)}};_.extend(C.prototype,Backbone.Events,{type:"webAudio",destroy:function(){this._destroyed=!0,this._removeNodes(!0),this._frameBuffers.splice(0,this._frameBuffers.length),this._audioSegments.splice(0,this._audioSegments.length),this._parsedParts.splice(0,this._parsedParts.length),this.destroyed=!0,clearTimeout(this._timer),clearInterval(this.currentTimeTimer)},updatePositionalData:function(e){var t=this,n=function(){var e={position:t.currentTime*1e3};return t.loaded&&(e.duration=t.duration*1e3),e};e?h.call(this,n):p.call(this,n)},play:function(e){var t=e||{},n=this;this.on("hasBuffers",function(){n._decodeBuffers()}),this.on("canplaythrough",function(){n._state!=n.playStatuses.PLAYING&&n._playNextSegment(!0),clearInterval(n.currentTimeTimer),n.currentTimeTimer=setInterval(function(){n.currentTime=a.currentTime-n._referenceTime,n.updatePositionalData(!0)},500)})},pause:function(){console.log("paused???"),this._state=this.playStatuses.PAUSED,clearTimeout(this._timer),this._sourceNode&&this._sourceNode.disconnect(this._gainNode),this._waitingToPlay=!1},seekTo:function(e){var t=this,n=e/1e3,r=this._frameBuffers,i=0,s=0,o=0,u=null;_.each(r,function(e,t){i=s,s+=e.frameDuration*e.frames,t!==r.length-1&&(s-=e.frameDuration*e.lastOneSecondFrames),t!==0&&(i+=e.frameDuration*e.lastOneSecondFrames),n>i&&n<s&&(u=t-1,o=n-i)});if(u===null)return;this._referenceTime=a.currentTime-e/1e3,this._lastStartTime=0,this._removeNodes(),this._currentBuffer=u,clearTimeout(this._timer),this.trigger("seeking"),this._playNextSegment(!0,o),this.updatePositionalData(!0)},_removeNodes:function(e){var n=this;this._nodes.length&&(_.each(this._nodes,function(e){e.disconnect(n._gainNode)}),this._sourceNode=t,this._nodes.splice(0,this._nodes.length)),e&&this._gainNode.disconnect(a.destination)},_completed:function(){this._state=this.playStatuses.COMPLETE,console.log("completed!"),this.trigger("complete",this),this.currentTime=0,clearInterval(this.currentTimeTimer),this._removeNodes()},_playNextSegment:function(e,n){if(!e&&this._state!=this.playStatuses.PLAYING)return;var r=0,i=0,s=n||0,o=0,u=100,f=this,l=this._audioSegments,c=this._frameBuffers,h=this._currentBuffer,p=this._sourceNode,d=l[h],v=c[h],m=l[h+1],g,y;if(!m){g=c[h+1];if(g){this._decodeBuffers(h+1,!0).done(function(){clearTimeout(f._timer),f._timer=setTimeout(_.bind(f._playNextSegment,f,e),10)});return}if(this.loaded&&p){p.onended=function(){f._completed(),p.onended=t};return}clearTimeout(this._timer),this._timer=setTimeout(_.bind(this._playNextSegment,this,e),400);return}v&&(v.lastOneSecondFrames&&(o=v.lastOneSecondFrames*v.frameDuration||0),this._sourceNode&&(y=this._lastStartTime+(d.durationPlayed||d.duration),i=y,r=y,s=o)),m.duration&&(v?u=(r-a.currentTime)/2*1e3:u=m.duration/2*1e3),clearTimeout(this._timer),this._timer=setTimeout(_.bind(this._playNextSegment,this),u);if(!m.duration)return;this._currentBuffer=++h,this._sourceNode&&this._sourceNode.stop(i),this._sourceNode=a.createBufferSource(),this._sourceNode.buffer=m,this._sourceNode.connect(this._gainNode),this._lastStartTime=Math.max(r,a.currentTime),v?this._sourceNode.start(r,s):(this._referenceTime=a.currentTime,this._sourceNode.start(0,s)),m.durationPlayed=m.duration-s,this._nodes.push(this._sourceNode),setTimeout(function(){var e=_.indexOf(f._nodes,p);e!=-1&&(f._nodes.splice(e,1),p.disconnect(f._gainNode))},(r-a.currentTime)*1e3+100),this._state!=this.playStatuses.PLAYING&&(this._state=this.playStatuses.PLAYING,this.trigger("playing",this))},_decodeBuffers:function(e,t){var n=e||this._currentBuffer+1,r=this._frameBuffers[n],i=this._frameBuffers[n-1],s=this,o;if(r)o=N(r,i).done(function(e){s._audioSegments[r.currentAudioSegment]=e});else if(this.loaded&&!t)return $.Deferred().reject();return t||setTimeout(_.bind(s._decodeBuffers,s,n+1),800),o},setVolume:function(e,t){t=_.toInt(t),this.lastVolumeDfd&&this.lastVolumeDfd.state()=="pending"&&this.lastVolumeDfd.resolve("interrupted"),this.lastVolumeDfd=$.Deferred(),clearInterval(this._fadeInterval),this._instanceVolume=e,this._goalVolume=e*D._globalVolume;if(t){var n=D._fadeStepsPerSecond*t/1e3;this._fadeStepSize=(this._goalVolume-this._interimVolume)/n,this._fadeInterval=setInterval(_.bind(function(){this._interimVolume+=this._fadeStepSize,Math.abs(this._goalVolume-this._interimVolume)<Math.abs(this._fadeStepSize)&&(this._interimVolume=this._goalVolume,this.lastVolumeDfd.resolve("complete"),clearInterval(this._fadeInterval)),!this._instanceMuted&&!D._globalMuted&&(this._gainNode.gain.value=this._interimVolume)},this),1/D._fadeStepsPerSecond*1e3)}else this._interimVolume=this._goalVolume,this.lastVolumeDfd.resolve("complete"),!this._instanceMuted&&!D._globalMuted&&(this._gainNode.gain.value=this._interimVolume);return this.lastVolumeDfd.promise()},getVolume:function(){return _.isUndefined(this._interimVolume)?n.Services.AudioHandle._globalVolume:this._interimVolume},setMuted:function(e){e!==this._instanceMuted&&(this._instanceMuted=e,e?this._gainNode.gain.value=0:D._globalMuted||(this._gainNode.gain.value=this._interimVolume))},getMuted:function(){return _.isUndefined(this._instanceMuted)?n.Services.AudioHandle._globalMuted:this._instanceMuted}});var k=function(){var e=this.handle,t=this.position,n=this.volume;e._seekToAttempt(t);if(e._lastVolumeDfd&&e._lastVolumeDfd.state()=="pending")return;e._el.volume=n},L=function(t,n,r){this.source=t,this.isDefaultSource=!!r,this.id=n,this._instanceVolume=1,this._interimVolume=D._globalVolume,this._goalVolume=D._globalVolume,this._fadeInterval=0,this._fadeStepSize=0,this._instanceMuted=!1,this._canPlay=!1,this._el=new e.Audio,this._el.volume=D._globalMuted?0:this._interimVolume,this._el.autoplay=!0,this._el.preload="auto",this.parentEl.appendChild(this._el),w.call(this),t&&(this._el.src=this.source,this._el.pause())};_.extend(L.prototype,Backbone.Events,{type:"html5",setSource:function(e){return this.source&&!this.isDefaultSource||!e?!1:(this.source=e,this._el.src=this.source,this._el.pause(),!0)},destroy:function(){this._destroyed=!0,this.off("canplay",this.play,this),E.call(this),this._el&&$(this._el).remove()},play:function(e){var t=e||{};this._canPlay||!$.browser.firefox?this._el.play():this.once("canplay",this.play,this)},pause:function(){this._el.pause(),this.off("canplay",this.play,this)},seekTo:function(e){var t;this._canPlay||this.off("canplay",k),this._seekToAttempt(e)||this._canPlay||(t=this._el.volume,this._el.volume=0,this.once("canplay",k,{handle:this,position:e,volume:t}))},_seekToAttempt:function(e){if(!this._canPlay)return!1;this.trigger("seeking");try{this._el.currentTime=e/1e3}catch(t){return this._el.seekable&&console.log("failed to seek",t),!1}return!0},setVolume:function(e,t){t=_.toInt(t),this._lastVolumeDfd&&this._lastVolumeDfd.state()=="pending"&&this._lastVolumeDfd.resolve("interrupted"),this._lastVolumeDfd=$.Deferred(),clearInterval(this._fadeInterval),this._instanceVolume=e,this._goalVolume=e*D._globalVolume;if(t){var n=D._fadeStepsPerSecond*t/1e3;this._fadeStepSize=(this._goalVolume-this._interimVolume)/n,this._fadeInterval=setInterval(_.bind(function(){this._interimVolume+=this._fadeStepSize,Math.abs(this._goalVolume-this._interimVolume)<Math.abs(this._fadeStepSize)&&(this._interimVolume=this._goalVolume,this._lastVolumeDfd.resolve("complete"),clearInterval(this._fadeInterval)),!this._instanceMuted&&!D._globalMuted&&(this._el.volume=this._interimVolume)},this),1/D._fadeStepsPerSecond*1e3)}else this._interimVolume=this._goalVolume,this._lastVolumeDfd.resolve("complete"),!this._instanceMuted&&!D._globalMuted&&(this._el.volume=this._interimVolume);return this._lastVolumeDfd.promise()},getVolume:function(){return _.isUndefined(this._interimVolume)?n.Services.AudioHandle._globalVolume:this._interimVolume},setMuted:function(e){e!==this._instanceMuted&&(this._instanceMuted=e,e?this._el.volume=0:D._globalMuted||(this._el.volume=this._interimVolume))},getMuted:function(){return _.isUndefined(this._instanceMuted)?n.Services.AudioHandle._globalMuted:this._instanceMuted}});var O=function(){var e=this.handle,t=this.position,n=this.muted;e._seekToAttempt(t)&&(e.setMuted(n),e.off("buffer",O),e._pendingSeek=!1)},M=function(e,t){this.source=e,this.id=t,this._msLoaded=0,this._downloaded=!1,this._pendingSeek=!1,this._lastMuted=!1,this._volumeDfdID=0,this._hasSWFHandle=!1;if(!e)return;this._swf&&!this._swf.makeHandle(e,t)&&(this._hasSWFHandle=!0)};_.extend(M.prototype,Backbone.Events,{type:"flash",_swf:null,setSource:function(e){return this._hasSWFHandle||!e?!1:(this.source=e,this._swf?(this._swf.makeHandle||n.Services.Log.notify("missing swf makeHandle","ERROR"),this._hasSWFHandle=!0,this._swf.makeHandle(e,this.id)):!0)},destroy:function(){this._destroyed=!0,this._hasSWFHandle&&this._swf.callHandleMethod(this.id,"destroy")},play:function(){this._hasSWFHandle&&this._swf.callHandleMethod(this.id,"play")},pause:function(){this._hasSWFHandle&&this._swf.callHandleMethod(this.id,"pause")},seekTo:function(e){var t;if(!this._hasSWFHandle)return;this._pendingSeek&&(this.off("buffer",O),this._pendingSeek=!1),this._seekToAttempt(e)||(console.log("unable to seek yet",e,this._msLoaded),t=this._lastMuted,this._pendingSeek=!0,this._swf.callHandleMethod(this.id,"setMuted",[!0]),this.on("buffer",O,{handle:this,position:e,muted:t}))},_seekToAttempt:function(e){return this._hasSWFHandle?this._downloaded||e<=this._msLoaded?(console.log("doing seek!"),this.trigger("seeking"),this._swf.callHandleMethod(this.id,"seekTo",[e]),!0):!1:!1},setVolume:function(e,t){var n=_.toInt(t);if(!this._hasSWFHandle){var r=$.Deferred().resolve("missing");return r.promise()}return this._lastVolumeDfd&&this._lastVolumeDfd.state()=="pending"&&this._lastVolumeDfd.resolve("interrupted"),this._instanceVolume=e,this._interimVolume=e,this._lastVolumeDfd=$.Deferred(),this._volumeDfdID++,this._swf.callHandleMethod(this.id,"setVolume",[e,n,this._volumeDfdID]),this.trigger("volumechange",e),this._lastVolumeDfd.promise()},getVolume:function(){return _.isUndefined(this._interimVolume)?n.Services.AudioHandle._globalVolume:this._interimVolume},setMuted:function(e){if(!this._hasSWFHandle)return;this._lastMuted=e,this._swf.callHandleMethod(this.id,"setMuted",[e])},getMuted:function(){return _.isUndefined(this._instanceMuted)?n.Services.AudioHandle._globalMuted:this._instanceMuted},_handleEvent:function(e){switch(e.type){case"playing":case"buffering":case"complete":this.trigger(e.type,this);break;case"error":case"update":e.data&&e.data.msLoaded&&e.data.msLoaded!==this._msLoaded&&(this._msLoaded||this.trigger("canplay"),this._msLoaded=e.data.msLoaded,this.trigger("buffer"),this._msLoaded===e.data.duration&&(this._downloaded=!0,this.trigger("downloaded"))),this.trigger(e.type,this,e.data);break;case"volumeChangeComplete":this._lastVolumeDfd&&this._lastVolumeDfd.state()=="pending"&&e.data.id===this._volumeDfdID&&this._lastVolumeDfd.resolve("complete")}}});var D=n.Services.AudioHandle={_audioType:null,_handles:{},_lastHandleID:0,_swf:null,_flashName:"html5ShimSwf",_flashFailed:0,_audioAPIAvail:l(),_globalVolume:1,_globalMuted:!1,_fadeStepsPerSecond:6,_computeSpectrumCallback:null,_useFFT:!1,_preferredBufferSize:null,setGlobalVolume:function(e){if(e!==this._globalVolume){var t=this._globalVolume;this._globalVolume=e,this._swf&&this._swf.setGlobalVolume(e),_.each(this._handles,function(n){if(n.type=="flash"){n.trigger("volumechange",e);return}n._goalVolume=n._instanceVolume*e;var r=t===0?n._goalVolume:n._interimVolume*e/t;n._interimVolume=r;if(n._instanceMuted)return;n.type=="html5"?n._el.volume=r:n._gainNode.gain.value=r}),this.trigger("volumechange",e)}},setGlobalMuted:function(e){e!==this._globalMuted&&(this._globalMuted=e,this._swf&&this._swf.setGlobalMuted(e),_.each(this._handles,function(t){t.type=="html5"?e?t._el.volume=0:t._instanceMuted||(t._el.volume=t._interimVolume):t.type=="webAudio"?e?t._gainNode.gain.value=0:t._instanceMuted||(t._gainNode.gain.value=t._interimVolume):e?t.trigger("volumechange",0):t._instanceMuted||t.trigger("volumechange",_.isUndefined(t._interimVolume)?D._globalVolume:t._interimVolume)}),this.trigger("muted",e))},setPreferredBufferSize:function(e){this._preferredBufferSize=e,this._swf&&this._preferredBufferSize&&this._swf.setCurrentBufferSize(this._preferredBufferSize)},startComputingSpectrum:function(e,t){t=_.orEqual(t,!1),this._computeSpectrumCallback=e,this._useFFT=t,(!this._audioType||this._audioType=="flash")&&this._swf&&this._swf.setComputeSpectrumCallback("GS.Services.AudioHandle._onSpectrumData",t)},stopComputingSpectrum:function(){this._computeSpectrumCallback=null,this._useFFT=!1,this._swf&&this._swf.setComputeSpectrumCallback("")},_onSpectrumData:function(e){_.isFunction(this._computeSpectrumCallback)&&this._computeSpectrumCallback(e)},getAudioHandle:function(e,t){var r=t||{},i=c(),s;this._swf&&this._audioType==="flash"&&!this._swf.makeHandle&&(n.Services.Log.notify("missing swf makeHandle in getAudioHandle","ERROR"),this._audioType="html5");if(!this._audioType){var o=_.getFlashObject(this._flashName);console.warn("flash obj",o,o&&typeof o.setAudioCallback=="function"),o&&typeof o.setAudioCallback=="function"?(this._audioType="flash",A.call(this,o),this._swf=M.prototype._swf=o):this._flashFailed++,this._flashFailed>3&&this._audioAPIAvail&&(this._audioType="html5")}return r.fastFetch&&!i?!1:(r.fastFetch?s=new C(null,++this._lastHandleID):this._audioType==="flash"?r.isDefaultSrc?s=new M("",++this._lastHandleID):s=new M(e,++this._lastHandleID):this._audioAPIAvail&&(L.prototype.parentEl||(L.prototype.parentEl=document.getElementById("audioWrapper")),s=new L(e,++this._lastHandleID,r.isDefaultSrc)),s?this._handles[s.id]=s:n.Services.Log.notify("failed to get audioHandle","ERROR",{hasSwf:!!this._swf,swfFails:this._flashFailed,lastHandleID:this._lastHandleID,hasAudioAPI:this._audioAPIAvail}),s)},setFastFetchSocket:function(e){f=e},canUseAudioAPI:function(){return this._audioAPIAvail},canUseWebAudioAPI:function(){return a!==null},_flashCallback:function(e){if(!e.id||!e.method)return!1;var t=this._handles[e.id];return!t||!_.isFunction(t[e.method])?!1:(t[e.method].apply(t,e.params||[]),!0)}};_.extend(D,Backbone.Events)}(),function(){function p(e,t){var n=e.split("\n"),r=[],s=t>0?t:i,o,u,a;for(o=0,u=n.length;o<u&&r.length<s;o++){if(!n[o])break;a=n[o].match(c);if(!a||!a[1]){if(r.length==0)continue;break}if(a[1]==="code"&&n[o].indexOf("Global code"))break;r.push(a[1])}return r}function d(e,t){var n=[],r=t>0?t:i,s;while(e&&(r<1||n.length<r)){s=e.toString().match(h);if(!s||!s[1])break;n.push(s[1]),e=e.caller}return n}function v(t){var n="Uncaught Exception",r,a,f,c,h,v,m,g;if(typeof t=="object"){if(!(s&&t instanceof e.ErrorEvent)){console.error("Unknown message sent to onerror",t);return}a=t.filename,f=t.lineno,c=t.colno,h=t.error,r=t.message}else r=t,a=arguments[1],f=arguments[2],c=arguments[3],h=arguments[4];try{h instanceof Error&&h.stack?(r=h.message,n=h.name||n,h.stack&&(m=p(h.stack,i))):arguments.callee&&arguments.callee.caller?m=d(arguments.callee.caller,i):e.event instanceof e.Event&&(g=e.event.target,g!==e&&(m=d(g.constructor,1),m[0]&&o&&g instanceof e.HTMLElement?(g.id?m[0]+=" id:"+g.id:g.className&&(m[0]+=" class:"+g.id),g.src&&(m[0]+=" src:"+g.src)):m[0]&&u&&g instanceof XMLHttpRequest&&g.url&&(m[0]+=" url:"+g.url),m.unshift("Event:"+(e.event.name||e.event.type))))}catch(y){console.error("Failed to calculate stack for error in onerror",y.message),m=null}v=new l.Event({message:r,file:a,line:f,type:n,column:c,level:"ERROR",stack:m}),l.notify(v)}var r=e.WebSocket||null,i=5,s=e.ErrorEvent!==t,o=e.HTMLElement!==t,u=e.XMLHttpRequest!==t,a=!0,f,l,c,h;n.Services=n.Services||{};if(!e.GSLogger){n.Services.Log={notify:function(){},init:function(){}},e.console&&e.console.log&&console.log("Missing GSLogger when loading logEx.js");return}l=e.GSLogger,f=l.Gobbler,f.prototype.connect=function(){var e=this.addr,t;if(!r||!e||!a)return!1;this.wsConnected=!1;try{t=new r("ws://"+e+"/")}catch(n){return a=!1,!1}return t.onopen=_.bind(this.onOpen,this),t.onmessage=_.bind(this.onMessage,this),t.onclose=_.bind(this.onClose,this),this.ws=t,!0},f.prototype.disconnect=function(){this.ws&&this.ws.close()},f.prototype.onOpen=function(){var e=this.ws,t=this.buffer,n,r;if(!e)return;this.wsConnected=!0;for(n=0,r=t.length;n<r;n++)e.send(t[n].toString("ws"));t.length=0},f.prototype.onMessage=function(e){},f.prototype.onClose=function(){this.ws&&this.wsConnected===!1&&(a=!1,this._post()),this.ws=null,this.wsConnected=!1},c=/(?:.*at\s*|<\/)*(?:[^\s\(@]+<\/)*([^\s\(@]+(?:\s*\[[^\(\]@]+\])?)\s*(?:\(|@)/,h=/^function\s*([^\s(]+)/,e.addEventListener&&s&&!e.opera&&(Object.setPrototypeOf||e.webkitURL)?(e.addEventListener("error",v),e.onerror=null):e.onerror=v,n.Services.Log=e.GSLogger}(),function(){function i(e){var i=r.model.get("player").get("queue"),s=i&&i.get("activeSong");s&&i.get("autoplay")&&n.trigger("player:voteSong",s.get("queueSongID"),s.get("autoplayVote")===e?t.NEUTRAL:e)}function s(e){var n=r.model.get("player").get("queue"),i=n&&n.get("currentBroadcast"),s=i&&i.get("activeSong");s&&i.voteActiveSong(s.get("userVote")===e?t.NEUTRAL:e)}n.External=n.External||{};var t={SMILE:1,UPVOTE:1,NEUTRAL:0,FROWN:-1,DOWNVOTE:-1},o=Backbone.Model.extend({initialize:function(e){this._model=e.model,_.each(this.defaults,_.bind(function(e,t){this._model.has(t)&&this.set(t,this._model.get(t))},this)),this.onBind()},onBind:function(){},unbind:function(){this._model&&(this._model.off(null,null,this),this._model=null)}}),u=o.extend({defaults:{playStatus:0,currentQueue:null},onBind:function(){var e=this._model.get("queue");this.set("currentQueue",e?new a({model:e}):null),this._model.on("change:playStatus change:queue",function(){var e=this._model.changedAttributes(),t={};this._model.hasChanged("playStatus")&&(t.playStatus=e.playStatus),this._model.hasChanged("queue")&&(this.get("currentQueue")&&this.get("currentQueue").unbind(),t.currentQueue=e.queue?new a({model:e.queue}):null),this.set(t)},this)},isPlaying:function(){switch(this._model.get("playStatus")){case n.Models.Player.playStatuses.INITIALIZING:case n.Models.Player.playStatuses.LOADING:case n.Models.Player.playStatuses.PLAYING:case n.Models.Player.playStatuses.BUFFERING:return!0;case n.Models.Player.playStatuses.NONE:case n.Models.Player.playStatuses.PAUSED:case n.Models.Player.playStatuses.SUSPENDED:case n.Models.Player.playStatuses.FAILED:case n.Models.Player.playStatuses.COMPLETED:default:return!1}}}),a=o.extend({defaults:{activeSong:null,autoplayEnabled:!1},onBind:function(){var e=this._model.get("activeSong");this.set("activeSong",e?new f({model:e}):null),this._model.on("change:activeSong change:autoplay",function(){var e=this._model.changedAttributes(),t={};this._model.hasChanged("activeSong")&&(this.get("activeSong")&&this.get("activeSong").unbind(),t.activeSong=e.activeSong?new f({model:e.activeSong}):null),this._model.hasChanged("autoplay")&&(t.autoplayEnabled=!!e.autoplay),this.set(t)},this)},hasNext:function(){return!!this._model.get("nextSong")},hasPrev:function(){return!!this._model.get("previousSong")},inBroadcast:function(){return!!this._model.get("currentBroadcast")}}),f=o.extend({defaults:{SongName:"",SongID:0,ArtistName:"",ArtistID:0,AlbumName:"",AlbumID:0,paused:!0,fromLibrary:!1,isFavorite:!1,isCallout:!1,smile:!1,frown:!1},onBind:function(){this._model.on("change:paused change:fromLibrary change:isFavorite change:isCallout change:smile change:frown",function(){var e=this._model.changedAttributes(),t={};this._model.hasChanged("paused")&&(t.paused=!!e.paused),this._model.hasChanged("fromLibrary")&&(t.fromLibrary=!!e.fromLibrary),this._model.hasChanged("isFavorite")&&(t.isFavorite=!!e.isFavorite),this._model.hasChanged("isCallout")&&(t.isCallout=!!e.isCallout),this._model.hasChanged("smile")&&(t.smile=!!e.smile),this._model.hasChanged("frown")&&(t.frown=!!e.frown),this.set(t)},this)},toSongUrl:function(){return this._model.toUrl()},toArtistUrl:function(){return this._model.toArtistUrl()},toAlbumUrl:function(){return this._model.toAlbumUrl()},getImageUrl:function(e){return this._model.getImageURL(e)}});n.External.DesktopBridge={init:function(){this.ready=$.Deferred(),this.player=null,this.active=!1,_.extend(this,Backbone.Events),e.nodeWebkit&&(this.active=!0,e.desktopBridge=this,n.ready.then(_.bind(this._onGsReady,this)))},_onGsReady:function(){this.player=new u({model:r.model.get("player")}),this.ready.resolve(this)},setHash:function(e){return n.router.setHash(e)},prevSong:function(e){return n.trigger("player:previousSong",e)},nextSong:function(){return n.trigger("player:nextSong")},togglePlay:function(){return n.trigger("player:togglePlay")},play:function(){switch(r.model.get("player").get("playStatus")){case n.Models.Player.playStatuses.NONE:case n.Models.Player.playStatuses.FAILED:case n.Models.Player.playStatuses.COMPLETED:return n.trigger("player:playSong");case n.Models.Player.playStatuses.PAUSED:case n.Models.Player.playStatuses.SUSPENDED:default:return n.trigger("player:resumeSong")}},pause:function(){switch(r.model.get("player").get("playStatus")){case n.Models.Player.playStatuses.INITIALIZING:case n.Models.Player.playStatuses.LOADING:return n.trigger("player:stopSong");case n.Models.Player.playStatuses.PLAYING:case n.Models.Player.playStatuses.BUFFERING:default:return n.trigger("player:pauseSong")}},stop:function(){return n.trigger("player:stopSong")},incrementVolume:function(e){var t=r.model.get("player");return n.trigger("player:volumeChange",t.getVolume()+e)},toggleSmile:function(){return i(t.SMILE)},toggleFrown:function(){return i(t.FROWN)},toggleUpvote:function(){return s(t.UPVOTE)},toggleDownvote:function(){return s(t.DOWNVOTE)},toggleRadio:function(){return n.trigger("player:radio")},toggleCollection:function(){var e=r.model.get("user"),t=r.model.get("player").get("queue"),n=t&&t.get("activeSong");n&&(n.get("fromLibrary")?e.removeSongsFromLibrary([n]):e.addSongsToLibrary([n]))},toggleFavorite:function(){var e=r.model.get("user"),t=r.model.get("player").get("queue"),n=t&&t.get("activeSong");n&&(n.get("isFavorite")?e.unfavorite("Songs",n):e.favorite("Songs",n))},toggleShuffle:function(){return n.trigger("player:shuffle")},getSettings:function(){return},setSettings:function(){return}}}(),function(){function h(e,t){var n=t.shift(),r=e[n];return r?t.length?h(r,t):r:null}n.External=n.External||{};var t,r,i,s,o,u,a=[],f=!1,l={0:"none",1:"loading",2:"loading",3:"playing",4:"paused",5:"buffering",6:"failed",7:"completed"},c=["play","add","next"];n.External.PluginAPI={init:function(r){t=r,i=t.get("player"),i.on("change:playStatus change:queue",this._onPlayerChange,this),s=i.get("queue"),s&&(s.on("change:activeSong",this._onPlayerChange,this),o=s.get("activeSong"),o&&o.on("change:smile change:frown change:isFavorite change:fromLibrary change:playStatus",this._onPlayerChange,this)),n.ready.then(_.bind(function(){e.Grooveshark=this;if(e.postMessage&&e.addEventListener){var t=this.getAPIVersion(),n=this.getApplicationVersion();e.addEventListener("message",_.bind(this._onReceiveMessage,this),!1),setTimeout(function(){var r={Grooveshark:n,GroovesharkAPIReady:t};e.postMessage($.stringify(r),"*")},1e3)}},this))},_onReceiveMessage:function(t){var n=this.getApplicationVersion();try{t=$.parseJSON(t.data)}catch(r){f&&console.log("API: processing failed",r)}if(!t||typeof t!="object"||t.Grooveshark||!t.groovesharkAPI)return;var i=t.id,s=t.method||"",o=t.parameters,u;if(!f&&s!="enablePostMessage")return;if(typeof i!="number"&&typeof i!="string"){console.log("API: postMessage id required",t);return}if(!s||typeof s!="string"){console.log("API: postMessage method required",t);return}if(s.indexOf("_")===0||s=="init"){console.log("API: disabled "+s);return}_.isArray(o)||(o=[]);switch(s){case"setSongStatusCallback":u=_.bind(this[s],this)(function(t){var r=$.stringify({Grooveshark:n,id:i,method:s,result:t});e.postMessage(r,"*")});return;default:this[s]&&(u=this[s].apply(this,o))}var a=$.stringify({Grooveshark:n,id:i,method:s,result:u});e.postMessage(a,"*")},_onPlayerChange:function(e,t){var n=e.changedAttributes(),r=!1;if(!_.isEmpty(n)){n.queue&&(r=!0,s&&s.off(null,null,this),s=i.get("queue"),s&&s.on("change:activeSong",this._onPlayerChange,this));if(r||n.activeSong)o&&o.off(null,null,this),s?(o=s.get("activeSong"),o&&o.on("change:smile change:frown change:isFavorite change:fromLibrary change:playStatus",this._onPlayerChange,this)):o=null}a.length&&_.each(a,_.bind(function(e){_.isFunction(e)&&e(this._buildCurrentPlayStatus())},this))},getApplicationVersion:function(){return gsConfig.snapVersion},getAPIVersion:function(){return 1.6},executeProtocol:function(e){var t=e.toLowerCase();t.indexOf("gs://")!=-1&&(e=e.substring(5),t=t.substring(5)),e.charAt(e.length-1)=="/"&&(e=e.substring(0,e.length-1),t=t.substring(0,t.length-1));var r=t.split("/"),i=r.pop();_.indexOf(c,i)==-1&&(r.push(i),i="");if(r[0]=="themes"){n.trigger("lightbox:open","themes");return}if(i){e=e.substring(0,e.length-i.length-1);var s=n.Models.Player.playSpecialIndexes.DEFAULT,o=!1;switch(i){case"play":o=!0;break;case"next":s=n.Models.Player.playSpecialIndexes.NEXT}switch(r[0]){case"s":n.Models.Song.get(r[2]).then(function(e){e.play({index:s,playOnAdd:o})});break;case"song":n.Models.Song.getByToken(r[2]).then(function(e){e.play({index:s,playOnAdd:o})});break;case"album":n.Models.Album.get(r[2]).then(function(e){e.play({index:s,playOnAdd:o})});break;case"playlist":n.Models.Playlist.get(r[2]).then(function(e){e.play({index:s,playOnAdd:o})})}}if(r[0]=="search"){var u=r[r.length-1];e=e.substring(0,e.length-u.length),e+="?q="+u}n.router.setHash("/"+e)},getCurrentSongStatus:function(){return this._buildCurrentPlayStatus()},setSongStatusCallback:function(t){if(_.isFunction(t))a.push(t);else if(_.isString(t)){var n=t.split("."),r=h(e,n);_.isFunction(r)&&a.push(t)}return this._buildCurrentPlayStatus()},_buildCurrentPlayStatus:function(){var e={song:null,status:"none"};return o?(e.song={songID:o.get("SongID"),songName:o.get("SongName"),artistID:o.get("ArtistID"),artistName:o.get("ArtistName"),albumID:o.get("AlbumID"),albumName:o.get("AlbumName"),trackNum:o.get("TrackNum"),estimateDuration:o.get("EstimateDuration")*1e3,artURL:o.getImageURL(),calculatedDuration:i.get("duration"),position:i.get("position"),vote:o.get("smile")?1:o.get("frown")?-1:0,isFavorite:!!o.get("isFavorite"),isInLibrary:!!o.get("fromLibrary")},e.status=l[o.get("playStatus")]):e.status=l[0],e},getPreviousSong:function(){var e=null;if(s){var t=s.get("previousSong");t&&(e={songID:t.get("SongID"),songName:t.get("SongName"),artistID:t.get("ArtistID"),artistName:t.get("ArtistName"),albumID:t.get("AlbumID"),albumName:t.get("AlbumName"),trackNum:t.get("TrackNum"),estimateDuration:t.get("EstimateDuration")*1e3,artURL:t.getImageURL(),vote:t.get("smile")?1:t.get("frown")?-1:0})}return e},getNextSong:function(){var e=null;if(s){var t=s.get("nextSong");t&&(e={songID:t.get("SongID"),songName:t.get("SongName"),artistID:t.get("ArtistID"),artistName:t.get("ArtistName"),albumID:t.get("AlbumID"),albumName:t.get("AlbumName"),trackNum:t.get("TrackNum"),estimateDuration:t.get("EstimateDuration")*1e3,artURL:t.getImageURL(),vote:t.get("smile")?1:t.get("frown")?-1:0})}return e},addSongsByID:function(e,t){var r=[],i=[];_.forEach(e,function(e){var t=n.Models.Song.get(e);t.then(function(e){i.push(e)}),r.push(t)}),$.when.apply($,r).then(function(){n.trigger("player:addSongs",i,n.Models.Player.playSpecialIndexes.DEFAULT,t)})},addSongByToken:function(e,t){n.Models.Song.getByToken(e).done(function(e){e.play({playOnAdd:t})})},addAlbumByID:function(e,t){n.Models.Album.get(e).done(function(e){e.getSongs().done(function(r){r=r&&r.toArray()||[],n.trigger("player:addSongs",r,n.Models.Player.playSpecialIndexes.LAST,t,new n.Models.PlayContext(e))})})},addPlaylistByID:function(e,t){n.Models.Playlist.get(e).done(function(e){e.getSongs().done(function(r){r=r&&r.toArray()||[],n.trigger("player:addSongs",r,n.Models.Player.playSpecialIndexes.LAST,t,new n.Models.PlayContext(e))})})},play:function(){!s.get("currentBroadcast")||s.get("isBroadcasting")?n.trigger("player:playSong"):i.setIsMuted(!1)},pause:function(){!s.get("currentBroadcast")||s.get("isBroadcasting")?n.trigger("player:pauseSong"):i.setIsMuted(!0)},seekToPosition:function(e){n.trigger("player:seekTo",e)},togglePlayPause:function(){!s.get("currentBroadcast")||s.get("isBroadcasting")?n.trigger("player:togglePlay"):i.toggleVolumeMute()},previous:function(){n.trigger("player:previousSong")},next:function(){n.trigger("player:nextSong")},setVolume:function(e){e==0?n.trigger("player:volumeMute",!0):n.trigger("player:volumeChange",e/100)},getVolume:function(){return Math.round(i.get("volume")*100)},setIsMuted:function(e){i.setIsMuted(e)},getIsMuted:function(){return i.get("isMuted")},voteCurrentSong:function(e){n.trigger("player:voteSong",o.get("queueSongID"),e)},getVoteForCurrentSong:function(){return o?o.get("smile")?1:o.get("frown")?-1:0:0},favoriteCurrentSong:function(){o&&t.get("user").favorite("Songs",o)},setPlaylistsUpdateCallback:function(n){var i=function(t){r&&r.getPlaylists().done(_.bind(function(e){e.off("add remove reset",null,this)},this)),r=t,u?t.getPlaylists().done(_.bind(function(t){t.on("add remove reset",function(){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"generic",result:t});e.postMessage(n,"*")},this);var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"generic",result:t});e.postMessage(n,"*")},this)):t.getPlaylists().done(_.bind(function(t){t.on("add",function(t){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"add",result:t});e.postMessage(n,"*")},this),t.on("remove",function(t){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"remove",result:t});e.postMessage(n,"*")},this),t.on("reset",function(){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"reset",result:t});e.postMessage(n,"*")},this);var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"generic",result:t});e.postMessage(n,"*")},this))};u=n,t.on("change:user",i,this),i.call(this,t.get("user"))},addCurrentSongToLibrary:function(){o&&t.get("user").addSongsToLibrary([o])},removeCurrentSongFromQueue:function(){o&&n.trigger("player:removeSongs",[o])},enablePostMessage:function(){f=!0},searchAlbums:function(e){},searchSongs:function(e){},toggleRadio:function(){n.trigger("player:radio")},getRadioStatus:function(){var e=i.get("queue");return e&&e.get("autoplay")}}}(),function(){n.External=n.External||{};var t;n.External.BrowserNotifications={windowHasFocus:!0,init:function(r){t=r,e.Notification&&n.ready.then(_.bind(this.onReady,this))},add:function(e){function i(){t.show(),n.trigger("guts:log","browserNotificationShown")}function s(){t.error(),n.trigger("guts:log","browserNotificationErrored")}function o(){t.close(),a(),n.trigger("guts:log","browserNotificationClosed")}function u(){t.click(),a(),n.trigger("guts:log","browserNotificationClicked")}function a(){r.removeEventListener("show",i,!1),r.removeEventListener("error",s,!1),r.removeEventListener("close",o,!1),r.removeEventListener("click",u,!1)}var t=_.defaults(e,{tag:"default",title:"",body:"",icon:"",lifespan:4e3,show:function(){},error:function(){},close:function(){},click:function(){}}),r=new Notification(t.title,t);r.addEventListener("show",i,!1),r.addEventListener("error",s,!1),r.addEventListener("close",o,!1),r.addEventListener("click",u,!1),_.isNumber(t.lifespan)&&setTimeout(_.bind(r.close,r),t.lifespan)},onReady:function(){n.on("browserNotification:add",this.onAdd,this),e.addEventListener("focus",_.bind(this.focusWindow,this),!1),e.addEventListener("blur",_.bind(this.blurWindow,this),!1)},onAdd:function(e){var n=t.get("user"),r=n.get("IsPremium")&&n.get("settings").local.enableBrowserNotifications,i=_.orEqual(e.requireFocus,!0);if(!r||i&&!this.windowHasFocus)return;Notification.permission==="granted"?this.add(e):Notification.requestPermission(_.bind(function(t){t==="granted"&&this.add(e)},this))},focusWindow:function(e){this.windowHasFocus=!0},blurWindow:function(e){this.windowHasFocus=!1}}}(),function(r){function s(e){o(e),u(e)}function o(e){_.gaTrackPageView(e)}function u(t){var n={c1:2,c2:"8187464",c4:(location.protocol+"//"+location.host+"/"+t).replace("#!/","")};e.COMSCORE&&COMSCORE.beacon?COMSCORE.beacon(n):e._comscore.push(n)}function a(e,t){var s=i.model.get("user");if(_.defined(e.inviteCode)){gsConfig.inviteCode=e.inviteCode;var o=new Date,u=o.valueOf()+12096e5;try{n.Services.Local.set("lastInviteCode",{inviteCode:e.inviteCode,expires:u})}catch(a){}}if(e.hasOwnProperty("password")){var f={};e.hasOwnProperty("code")&&(f.resetCode=e.code),n.trigger("lightbox:open","forget",f)}e.hasOwnProperty("invite")&&n.trigger("lightbox:open","invite"),e.hasOwnProperty("signup")&&n.router.setHash("signup"),e.hasOwnProperty("login")&&(!s||!s.get("isLoggedIn"))&&(t?n.trigger("lightbox:open","login",{onLogin:function(){setTimeout(function(){n.router.setHash(t)},0)}}):n.trigger("lightbox:open","login")),e.hasOwnProperty("testAds")&&(n.Models.Ad.useTestAds=!0,n.Models.Ad.useTestAdsValue=e.testAds);if(e.hasOwnProperty("asArtist")||e.hasOwnProperty("asartist")){var l=_.toInt(e.asArtist)||_.toInt(e.asartist);l&&s&&s.getOwnedArtists().done(function(e){if(e){var t=e.find(function(e){return e.get("ArtistID")===l});t}})}if(e.hasOwnProperty("verifyEmailToken")){var c=e.verifyEmailToken;n.Services.API.userVerifyEmail(c).done(function(e){var t;switch(e.code){case 2:t="POPUP_EMAIL_VERIFIED_USER_CREATED",e.artist&&(t="POPUP_EMAIL_VERIFIED_ARTIST_CREATED"),s.get("isLoggedIn")||(e.artist?t="POPUP_EMAIL_VERIFIED_ARTIST_CREATED_LOGIN":t="POPUP_EMAIL_VERIFIED_USER_CREATED_LOGIN"),r.localize.ready.done(function(){n.trigger("notification:add",{icon:"email",type:"success",duration:1e4,description:_.getString(t)})});break;case 1:e.artist?t="POPUP_EMAIL_VERIFIED_ARTIST_CLAIM":t="POPUP_EMAIL_VERIFIED_USER",r.localize.ready.done(function(){n.trigger("notification:add",{icon:"email",type:"success",duration:1e4,description:_.getString(t)})});break;case-1:r.localize.ready.done(function(){n.trigger("notification:add",{type:"error",duration:0,description:_.getString("POPUP_EMAIL_VERIFY_MISMATCH")})});break;case-2:r.localize.ready.done(function(){n.trigger("notification:add",{type:"error",duration:0,click:function(){n.Services.API.resendEmailToken(c).done(function(){n.trigger("notification:add",{icon:"email",type:"success",description:_.getString("EMAIL_VERIFY_FAILED_RESENT_EMAIL")})})},description:_.getString("POPUP_EMAIL_VERIFY_EXPIRED")})});break;default:r.localize.ready.done(function(){n.trigger("notification:add",{icon:"email",type:"error",duration:1e4,description:_.getString("POPUP_EMAIL_VERIFY_FAILED")})})}}).fail(function(){n.trigger("notification:add",{type:"error",duration:1e4,description:_.getString("POPUP_EMAIL_VERIFY_FAILED")})}),n.router.setHash("/")}}function c(e,t,r){var s=_.defined(e.search),o=_.defined(e.notFound),u=_.defined(e.reason)?e.reason:!1,a=new L(e.splat,"tagName","tagID","subpage"),f=a.tagName?a.tagName.replace(/\+/g," "):"",l=n.getLoggedInUserID();a.tagName&&a.tagName===""&&self.notFound(),i.page.setPage("home",{id:l,focusSearch:s,possiblyResetPage:r&&r.possiblyResetPage,tagName:f,tagID:a.tagID||r&&r.tagID,mediaType:r&&r.mediaType,groupType:r&&r.groupType,subpage:a.subpage,notFound:o,reason:u,params:e})}function h(e,t,r){var s=e.splat;s&&(s[0]==="profile"||s[0]==="user"||s[0]==="artist")&&s.shift();var o=new L(s,"login","id","subpage","section","subpageData");e.isArtistPage?o.artistID=o.id:(o.artistID=e.artistID,o.userID=o.id),o.userID<0&&(o.artistID=-1*o.userID,o.userID=null),n.Models.Profile.get(o.userID,o.artistID,!0,!0,{notifyCache:!0}).done(function(t){var s=t&&t.get("user");if(!s){n.router.notFound();return}o.subpage==="share"?i.page.setPage("feedEvent",{userID:s.get("UserID"),subpage:o.section}):o.subpage==="notification"?i.page.setPage("taco",{userID:s.get("UserID"),subpage:o.section}):i.page.setPage("profile",{id:o.id,profile:t,subpage:o.subpage,section:o.section,subpageData:o.subpageData,artistID:o.artistID,isFollowReq:!!e.follow,broadcast:r&&r.broadcast})}).fail(function(){n.router.notFound()})}function p(e,t){e.isArtistPage=!0,h(e,t)}function d(e){var t=e.splat.shift(),n=new L(e.splat,"name","id","subpage","section","subpageData");t==="artist"&&n.subpage==="dashboard"?i.page.setPage("artistDashboard",{id:n.id,subpage:n.subpageData}):n.subpage==="edit"?amdModules.requireDeferred("gs/views/pages/albumEdit.js").done(function(){i.page.setPage("albumEdit",{id:n.id})}):i.page.setPage(t,{id:n.id,subpage:_.orEqual(n.subpage,"profile"),section:_.orEqual(n.section,""),subpageData:n.subpageData,playOnLoad:e.play,name:n.name})}function v(e){var t=e.splat.shift(),n=new L(e.splat,"subpage");n.section=t,t==="apply"&&(n.subpage=t,n.section="careers"),i.page.setPage("static",{subpage:_.orEqual(n.subpage,""),section:_.orEqual(n.section,"")})}function m(t){var n=t.splat[0],r;switch(n){case"apply":r="http://careers.grooveshark.com/openings";break;case"internships":r="http://careers.grooveshark.com/internships";break;default:r="http://careers.grooveshark.com"}i.page.currentPageView?e.open(r):(i.careersRedirect=!0,e.location=r)}function g(e){i.page.setPage("notFound",{})}function y(e,t){var n=e.indexOf("/");return n!==-1?e.substring(0,n)+"/"+t+e.substring(n):e+"/"+t}function b(e){var n=new L(e.splat,"subpage","type");n.subpage=="popular"&&(n.subpage="songs");if(n.subpage==="daily"||n.subpage==="weekly"||n.subpage==="monthly")n.type=n.subpage,n.subpage="songs";i.page.setPage("popular",{subpage:n.subpage||t,type:n.type||t})}function w(e,t,r){var s=r||{},o=new L(e.splat,"subpage","section"),u=i.model.get("user"),a=u.get("isArtist"),f;n.getLoggedInUserID()<1?n.router.setHash("signup"):a?i.page.setPage("artistOnboarding",_.extend({},{section:o.section},s)):i.model.get("appMode")==="mobile"?i.page.setPage("mobileUserOnboarding",_.extend({},{section:o.section},s)):i.page.setPage("userOnboarding",_.extend({},{section:o.section},s))}function E(e){var t=new L(e.splat,"subpage","tag","tagID");i.page.setPage("broadcasts",{subpage:t.subpage,tag:t.tag,tagID:t.tagID,period:e.period,date:e.date})}function S(e,t,n){var r=new L(e.splat,"subpage"),s=n||{};i.page.setPage("registration",{subpage:r.subpage,destination:s.destination,signupType:s.signupType,thirdPartyDetails:s.thirdPartyDetails,defaultValues:s.defaultValues,onClose:s.onClose,onLogin:s.onLogin,onUpgrade:s.onUpgrade})}function x(e,t,n){var r=new L(e.splat,"subpage");amdModules.requireDeferred("gs/views/pages/claimArtist.js").done(function(){i.page.setPage("claimArtist",{subpage:r.subpage,registrationInfo:n&&n.registrationInfo})})}function T(e,t,r){var s=new L(e.splat,"subpage","section");s.id=n.getLoggedInUserID(),n.getLoggedInUserID()<1&&s.subpage==="newFeatures"?n.router.setHash("/new"):i.page.setPage("settings",s)}function k(){var o=this;this._routes=[],this._lastHash=null,this._history=[],this._wasReplace=null,this._historyIndex=0,this._nextHashShift=0,this._pageNameCache={},this.hasBack=!1,this.hasForward=!1,this.setHash=function(t,n){t===null&&(t="notFound"),t=_.cleanHash(t),C[t]=n,r.browser.chrome&&e.history?(e.history.pushState({},"",t),r(e).trigger("hashchange",{force:!!n})):t!==e.location.hash?e.location.hash=t:n&&r(e).trigger("hashchange",{force:!0})},this.replaceHash=function(t){t===null&&(t="notFound"),t=_.cleanHash(t),this._wasReplace=[e.location.hash,t],r.browser.chrome&&e.history?(e.history.replaceState({},"",t),r(e).trigger("hashchange")):e.location.replace(e.location.protocol+"//"+e.location.hostname+"/"+t)},this.get=function(e,t,n){n=_.orEqual(n,this);if(!(e instanceof RegExp)&&!_.isString(e)){console.error("invalid route, must be String or RegExp");return}_.isString(e)&&(e=new RegExp("^"+e+"$")),this._routes.push({path:e,callback:t,context:n})},this.notFound=function(){this.replaceHash("notFound")},this.back=function(){this.navHistory(-1)},this.forward=function(){this.navHistory(1)},this.navHistory=function(e){var t=this._historyIndex+e;t>=0&&t<this._history.length&&(this._nextHashShift=e,this.setHash(this._history[t]))},this.getHistory=function(e){var n=this._historyIndex+e;return n>=0&&n<this._history.length?(this._nextHashShift=e,this._history[n]):t},this.performSearch=function(e,t){this.setHash(this.makeSearchUrl(e,t))},this.makeSearchUrl=function(e,t){t=t?t.toString():"";if(t.indexOf("http://")===0&&t.indexOf("tinysong")==-1){t=t.substring(7),this.setHash(t);return}return e=e&&e.toLowerCase(),t=encodeURIComponent(t),t=t.replace(/%20/g,"+"),e?_.cleanHash("/search/"+e+"?q="+t):t?_.cleanHash("/search?q="+t):_.cleanHash("/search")},this.cachePageName=function(e,t,n){this._pageNameCache[e]={type:t,id:n}},this.uncachePageName=function(e){this._pageNameCache.hasOwnProperty(e)&&delete this._pageNameCache[e]},this.run=function(t){i=t,i.render(),this.page={activate:function(){},getPageClass:function(){return r.Deferred()}},r(e).hashchange(function(e,t){var n=location.hash;n&&n.length&&(n=location.href.substring(location.href.indexOf("#"))),o._onHashChange(n,t)}),r(e).trigger("hashchange")},this._onHashChange=function(e,t){var r=t||{},o=e?this._parseQueryString(e):{};if(n.getAppMode()==="mobile"){this._lastQueryString&&this._lastQueryString.lb&&i.lightbox.isOpen&&i.lightbox.currentLightbox._canClose&&n.trigger("lightbox:close");if(o.lb){this._lastQueryString=o;return}}this._lastQueryString=o;if(e!==this._lastHash){var u=i.page.getCurrentPageView(),f=u?u.blockPageChange(e):!1;if(f)if(f===!0||!confirm(f)){this.replaceHash(this._lastHash);return}}else if(!r.force)return;e=e||"#!/";var l=this._lastHash;this._lastHash=e,s(e);if(this._nextHashShift!==0){var c=this._historyIndex+this._nextHashShift;c>=0&&c<this._history.length&&this._history[c]==e?this._historyIndex=c:this._nextHashShift=0}this._nextHashShift===0&&(this._history=this._history.slice(0,this._historyIndex+1),e&&(this._wasReplace&&this._history.length&&this._wasReplace[0]===this._history[this._history.length-1]&&this._wasReplace[1]===e&&this._history.pop(),this._history.push(e)),this._historyIndex=this._history.length-1),this._nextHashShift=0,this._wasReplace=null;var h=this._parseQueryString(e),p=decodeURIComponent(e.replace(N,"")),d=this._getRouteForPath(p);if(!d){this.notFound();return}var v=p.match(d.path);v.shift(),h.splat=v,_.isFunction(d.callback)&&(d.callback.call(d.context,h,l,C[e]),a(h,p),C={}),this.hasBack=this._history.length&&this._historyIndex>0,this.hasForward=this._history.length&&this._historyIndex<this._history.length-1,n.trigger("router:change",e,l)},this._getRouteForPath=function(e){var t,n,r;for(n=0,r=this._routes.length;n<r;n++)if(this._routes[n].path.test(e)){t=this._routes[n];break}return t},this._parseQueryString=function(e){var t={},n=/\+/g,r,i,s,o,u;r=e.match(N);if(r){i=r[1].split("&");for(o=0,u=i.length;o<u;o++){s=i[o].split("=");if(s[0]==="q"||s[0]==="query")s[1]=s[1].replace(n,"%20");t=this._parseParamPair(t,decodeURIComponent(s[0]),decodeURIComponent(s[1]))}}return t},this._parseParamPair=function(e,t,n){return e[t]?_.isArray(e[t])?e[t].push(n):e[t]=[e[t],n]:e[t]=n,e},this._getTypeIDForPageName=function(e){var t=r.Deferred(),i,s,u;return _.defined(this._pageNameCache[e])?t.resolve(this._pageNameCache[e]):n.Services.API.getItemByPageName(e).done(function(r){if(r&&r.type){u=r[r.type];if(!u){t.reject(r);return}u.PathName=e,u.pageNameData=r.data,u.rawPageNameData={Data:r.data,Name:e,source:"router"};switch(r.type){case"user":i=n.Models.User.newOrUpdate(u,{notifyCache:!0}),s=i.id,s<1&&(s=0);break;case"artist":i=n.Models.Artist.newOrUpdate(u,{notifyCache:!0}),i._gotExtraDetails=!0,s=i.id;break;case"album":i=n.Models.Album.newOrUpdate(u,{notifyCache:!0}),s=i.id;break;case"theme":i=u,s=u.themeID;break;default:console.log("unknown type for PageName",r.type,e),t.reject(r);return}if(!s){t.reject(r);return}o._pageNameCache[e]={type:r.type,id:s,item:i},t.resolve(o._pageNameCache[e])}else t.reject(r)}).fail(function(e){t.reject(e)}),t.promise()}}function L(){var e=r.makeArray(arguments),t=e.shift()[0],n=this;if(_.isEmpty(t)){n.length=0;return}var i=t.replace(/\/$/,"").split("/");n.length=i.length;var s;_.forEach(i,function(t,r){s=e[r],n[s]=t})}var i;typeof e._comscore!="object"&&(e._comscore=[]),n.router=new k;var f="",l=null;n.router.get("",function(e,n,r){c(e,t,r)}),n.router.get(/^#!?\/$/,function(e,n,r){c(e,t,r)}),n.router.get(/^#!?\/whatisbroadcast\/?$/,function(e){n.trigger("lightbox:open","broadcastAbout"),c({reason:"whatisbroadcast"})}),n.router.get(/^#!?\/legal\/dmca\/?$/,function(t){i.page.currentPageView?e.open("http://www.grooveshark.com/dmca"):(i.careersRedirect=!0,e.location="http://www.grooveshark.com/dmca")}),n.router.get(/^#!?\/user\/(.*)\/?$/,h),n.router.get(/^#!?\/profile\/(.*)\/?$/,h),n.router.get(/^#!?\/online\/?$/,function(){var e=i.model.get("user");i.page.setPage("onlineFriends",{user:e})}),n.router.get(/^#!?\/artist\/(.*)\/?$/,p),n.router.get(/^#!?\/playlist\/(.*)\/?/,function(e){var t=new L(e.splat,"name","id","subpage","section"),r=i.model.get("user");t.subpage==="overlay"?n.Models.Playlist.get(t.id).done(function(n){i.page.setPage("playlist",{id:t.id,subpage:_.orEqual(t.subpage,"profile"),section:_.orEqual(t.section,""),playOnLoad:e.play})}).fail(function(){n.router.setHash("notFound")}):i.page.setPage("playlist",{id:t.id,subpage:_.orEqual(t.subpage,"profile"),section:_.orEqual(t.section,""),playOnLoad:e.play})}),n.router.get(/^#!?\/s(?:ong)?\/(.*)\/?/,function(e){var t=new L(e.splat,"name","token","subpage","section","subpageData");i.page.setPage("song",{id:t.token,subpage:_.orEqual(t.subpage,""),section:_.orEqual(t.section,""),subpageData:t.subpageData})}),n.router.get(/^#!?\/notFound\/?$/,g),n.router.get(/^#!?\/(album|promotion)\/(.*)\/?/,d),n.router.get(/^#!?\/(careers|jobs|apply|internships)(?:\/?|\/(.*))$/,m),n.router.get(/^#!?\/(about|legal|contact|press|press_release|logo|artists)(?:\/?|\/(.*))$/,v),n.router.get(/^#!\/redeem\/?(.*)\/?/,function(e){var t=new L(e.splat,"type","code");!t.code&&t.type&&(t.code=t.type),c(e);var i=function(){n.trigger("lightbox:open","payments",{action:"redeem",code:t.code,headerVal:"REDEEM_CODE",messageVal:"PAYMENTS_LB_REDEEM_MESSAGE"})};n.getLoggedInUserID()<1?r.localize.ready.done(function(){n.trigger("lightbox:open","login",{message:_.getString("POPUP_EREDEEM_CODE_LOGIN_REQUIRED"),onLogin:i})}):i()}),n.router.get(/^#!?\/login(?:$|\/(.*)\/?)/,function(e,t,r){n.getLoggedInUserID()<1?i.page.setPage("login",r||{}):c(e,{reason:"login"})}),n.router.get(/^#!?\/themes(?:$|\/(.*)\/?)/,function(e){var t=new L(e.splat,"type");c(t),n.trigger("lightbox:open","themes",{type:t.type})}),n.router.get(/^#!?\/(theme)\/(.*)\/?/,function(e){var t=e.splat.shift(),r=new L(e.splat,"name","themeid","type");r.splat=e.splat,n.trigger("theme:get",{temporary:!0,id:r.themeid,name:r.name}),c({splat:[]})}),n.router.get(/^#!?\/boxee(?:$|\/(.*)\/?)/,function(e){var t=new L(e.splat,"type");c({reason:"boxee"})}),n.router.get(/^#!?\/perks(?:$|\/(.*)\/?)/,function(e){var t=new L(e.splat,"type");c(t),n.theme.setCurrentTheme(163,!0),n.trigger("lightbox:open","vipPerks")}),n.router.get(/^#!?\/gift(?:$|\/(.*)\/?)/,function(e){var t=new L(e.splat,"type");c({reason:"gift"});var s=new Date;s.getMonth()>=10&&i.theme.setCurrentTheme(945);var o=function(){n.trigger("lightbox:open","payments",{action:"purchase"})};n.getLoggedInUserID()<1?r.localize.ready.done(function(){n.trigger("lightbox:open","login",{message:_.getString("POPUP_BUY_CODE_LOGIN_REQUIRED"),onLogin:o})}):o()}),n.router.get(/^#!?\/upgrade(?:$|\/(.*)\/?)/,function(e){i.page.setPage("upgrade",{})}),n.router.get(/^#!?\/new(?:$|\/(.*)\/?)/,function(e){n.getLoggedInUserID()<1?i.page.setPage("newFeatures",{}):n.router.setHash("/settings/new-features")}),n.router.get(/^#!?\/leap\/?/,function(){n.router.setHash("notFound")}),n.router.get(/^#!?\/(sessions)/,function(e){c({reason:"sessions"})}),n.router.get(/^#!?\/search(?:$|\/(.*)\/?)/,function(e,t){var n=new L(e.splat,"type");i.page.setPage("search",{id:e.q||e.query,type:n.type,query:e.q||e.query})}),n.router.get(/^#!?\/surveys(?:$|\/(.*)\/?|\/(.*)\/(.*)\/?)/,function(e){i.page.setPage("surveys",{})}),n.router.get(/^#!?\/(?:now_playing|queue)(?:$|\/(.*)\/?)/,function(t){var s=new L(t.splat,"songName","songToken"),o=t.splat.input.replace("/now_playing/","/s/").replace("/queue/","/s/");if(s.songToken&&s.songToken.length){n.router.replaceHash(o),r(e).trigger("hashchange");return}i.page.setPage("queue",{id:0})}),n.router.get(/^#!?\/popular(?:$|\/(.*)\/?)/,b),n.router.get(/^#!?\/onboarding(?:$|\/(.*)\/?)/,w),n.router.get(/^#!?\/broadcasts?(?:$|\/(.*)\/?)/,E),n.router.get(/^#!?\/signup(?:$|\/(.*)\/?)/,S),n.router.get(/^#!?\/claim-artist(?:$|\/(.*)\/?)/,x),n.router.get(/^#!\/recommended(?:$|\/(.*)\/?)/,function(e){var t=new L(e.splat,"subpage","type");i.page.setPage("recommended",{subpage:t.subpage||"",type:t.type||""})}),n.router.get(/^#!\/(?:music|explore)(?:$|\/(.*)\/?)/,function(e){var t=new L(e.splat,"subpage","type");t.subpage=="popular"?b(e):c(e)}),n.router.get(/^#!\/(?:tag|genre)(?:$|\/(.*)\/?)/,function(e,n,r){var s=new L(e.splat,"tagName","tagID","subpage","type");s.tagName===""?self.notFound():s.subpage==="list"&&s.type==="songs"?i.page.setPage("genre",{tagName:s.tagName,tagID:s.tagID||r&&r.tagID}):c(e,t,r)}),n.router.get(/^#!\/(?:tags|genres)(?:$|\/(.*)\/?)/,function(e){this.replaceHash("home")}),n.router.get(/^#!\/(?:community)(?:$|\/(.*)\/?)/,function(e){this.replaceHash("home")}),n.router.get(/^#!?\/settings(?:$|\/(.*)\/?)/,T),n.router.get(/^#!?\/(.*)\/?$/,function(e,t,r){var s=new L(e.splat,"page","subpage","type"),o=s.page,u=this;if(s.page=="anywhere"||s.page=="subscription"){n.router.replaceHash("/upgrade");return}s.page=="popular"&&b(),(s.page=="genres"||s.page=="tags"||s.page=="community")&&this.replaceHash("home");var a=i.page.setPage(o,s);a.fail(_.bind(function(){this._getTypeIDForPageName(s.page).done(function(n){switch(n.type){case"user":e.splat[1]=y(e.splat[0],n.id),e.splat[0]="profile",h(e,t,r);break;case"artist":e.splat[1]=y(e.splat[0],n.id*-1),e.splat[0]="profile",e.artistID=n.id,h(e,t,r);break;case"album":e.splat[1]=y(e.splat[0],n.id),e.splat[0]=n.type,d(e,t);break;case"theme":var i=n.item.themeName?n.item.themeName:"x",s=n.id;n.item.pageNameData.isPromo?u.setHash("/promotion/"+i+"/"+s):u.setHash("/theme/"+i+"/"+s);break;default:console.log("cant handle pageName type",n),u.notFound()}}).fail(function(e){u.notFound()})},this))}),n.router.get(/^#!?(?:[a-z0-9A-Z])/,function(e){if(n.page.activePage&&n.page.activePage){var t=n.page.activePage.url;t=t.replace(/(&|\?)fb_comment_id=([a-zA-Z0-9\_\-]+)/,"$1fbComment");var r=n.page.activePage.element.controller();r.scrollToFBComment&&r.scrollToFBComment(),location.replace(t)}});var N=/\?([^#]*)$/,C={}}(jQuery);var n=typeof n!="undefined"?n:{},r,s,o,u;n.dispatcher=_.extend({},Backbone.Events),n.trigger=_.bind(n.dispatcher.trigger,n.dispatcher),n.on=_.bind(n.dispatcher.on,n.dispatcher),n.off=_.bind(n.dispatcher.off,n.dispatcher),n.once=_.bind(n.dispatcher.once,n.dispatcher);var a=new $.Deferred;n.ready=a.promise(),n.loadedTokenData=!1,e.GS=n;var f=setTimeout(function(){var t=$("#page-inner"),n=$("body"),r=$("#offline-notification"),i;e.gsLocale&&e.gsLocale.OFFLINE_RELOAD_MSG?i=e.gsLocale.OFFLINE_RELOAD_MSG:i="You appear to be offline. Please check your internet connection and try reloading the page.",n.addClass("offline"),t.removeClass("hide"),r.removeClass("hide"),t.find("p").html(i)},2e4);n.on("tokenData",function(i){function h(){var e=document.title||"";e.indexOf("#")!=-1&&(e=e.substring(0,e.indexOf("#"))),document.title!=e&&e!==""&&(document.title=e)}function p(){var e=!0,t=!1,r=!1,i=!1,s=_.browserDetect(),o={browser:s};switch(s.browser){case"chrome":s.version>=6&&(e=!1),Boolean(navigator.userAgent.match(/GoogleTV/i))&&(o.isUncertain=!0,e=!0);break;case"safari":s.version>=5&&(e=!1),s.version>=8&&!s.iOS&&(t=!0,r=!0),Boolean(navigator.userAgent.match(/luakit/i))&&(o.isUncertain=!0,e=!0);break;case"msie":i=!0,s.version>8&&(e=!1),s.version<=6&&(o.isChromeFrame=!0);break;case"firefox":s.version>=3&&(e=!1);break;case"mozilla":s.version>=1.9&&(e=!1);break;case"opera":s.version>=11&&(e=!1)}e?amdModules.requireDeferred("gs/views/lightboxes/unsupportedBrowser.js").done(function(){n.trigger("lightbox:open","unsupportedBrowser",o)}):t&&$.localize.ready.done(function(){_.getFlashObjectDfd("html5ShimSwf","makeHandle").fail(function(){n.trigger("lightbox:open","flashRequired",{isSafari:r,isIE:i})})})}clearTimeout(f),n.loadedTokenData=!0,e.gsConfig=i.getGSConfig,e.gsLocale=i.getGSLocale,e.gsProduction=i.getGSProduction,e.gsViewBundles=i.getGSViewBundle,e.gsPageBundle=i.getGSPageBundle,e.clientTimeDivergence=i.getGSConfig.timestamp*1e3-(new Date).getTime(),n.currentYear=(new Date(Date.now()+e.clientTimeDivergence)).getFullYear();try{OAuth.correctTimestamp(gsConfig.timestamp)}catch(o){}gsConfig.snapVersion&&($.localize.cachebuster="?v=_"+gsConfig.snapVersion),gsConfig.localeJSONP?$.localize.jsonpCallback=gsConfig.localeJSONP:$.localize.jsonpCallback=!1;if(_.defined(e.gsLocale)){_.defined($.localize.data.gs)||($.localize.data.gs=gsLocale);var u;for(u in gsLocale)gsLocale.hasOwnProperty(u)&&($.localize.defaultLangData[u]=gsLocale[u])}setTimeout(function(){$.localize("gs",{language:"en",callback:_.bind($.localize.ready.resolve,$.localize.ready)})},0),function(){var t=document.getElementsByTagName("script")[0],n=t.parentNode,r=gsConfig.country&&gsConfig.country.ID;if(r==174){e.pp_gemius_identifier="nLrglARWI2UVfQNr05sNWcVHnMmNUwxHYBVcbVy.dTT.37",e.pp_gemius_time_identifier="csrr4EuVpEjFMNEgzOo0t_VyPw1dQfu3ps74UAeI94H.r7";var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="http://gapl.hit.gemius.pl/xgemius.js",n.insertBefore(i,t)}else if(r==15){var s=document.createElement("script");s.type="text/javascript",s.async=!0,s.src=("https:"==document.location.protocol?"https://au-ssl":"http://au-cdn")+".effectivemeasure.net/em.js",n.insertBefore(s,t)}else if(r==72){e._eStat_Whap_loaded_func=function(){eStatWhap.serial("800000000049"),eStatWhap.send()};var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src=("https:"==document.location.protocol?"https://":"http://")+"w.estat.com/js/whap.js",n.insertBefore(o,t)}else if(r==106){function u(){var e={cid:"webads-it",content:"0",server:"secure-it"},t={check_cookie:0},n=nol_t&&nol_t(e,t);if(n&&n.record){var r=n.record();r&&r.post()}}var a=document.createElement("script"),f=!1;a.type="text/javascript",a.async=!0,a.src="//secure-it.imrworldwide.com/v60.js",a.onload=function(){f||(f=!0,u())},a.onreadystatechange=function(){!f&&(this.readyState=="loaded"||this.readyState=="complete")&&(f=!0,u())},n.insertBefore(a,t)}}();var l={tier2:"/gs/tier2.js",settingsPage:"/gs/tier2.js",queuePage:"/gs/tier2.js",upgradePage:"/gs/tier2.js",promotionPage:"/gs/tier2.js",surveysPage:"/gs/tier2.js",userOnboardingPage:"/gs/tier2.js",artistOnboardingPage:"/gs/tier2.js",mobileUserOnboardingPage:"/gs/tier2.js",registrationPage:"/gs/tier2.js",feedEventPage:"/gs/tier2.js",tacoPage:"/gs/tier2.js",shareLightbox:"/gs/tier2.js",embedLightbox:"/gs/tier2.js",inviteLightbox:"/gs/tier2.js",suggestTagsLightbox:"/gs/tier2.js",feedbackLightbox:"/gs/tier2.js",audioRollLightbox:"/gs/tier2.js",cleanInputText:"/gs/tier2.js",tagging:"/gs/tier2.js",countriesStates:"/gs/tier2.js",urlsEditor:"/gs/tier2.js",paywallLightbox:"/gs/tier2.js","gs/resources/contextMenus.js":"/gs/tier2.js"};if(gsProduction&&gsProduction.packages){var c=gsProduction.packages;_.extend(l,c)}amdModules.config({assetHost:gsConfig.assetHost}),amdModules.setPathRedirects(e.gsProduction),amdModules.addPackages(l),$.drop({mode:"mouse"}),jQuery.event.special.drag.defaults.distance=10,n.Views=n.Views||{},n.Views.viewBundles=e.gsViewBundles||{},n.Views.templateCache={};if(e.gsPageBundle&&$.isPlainObject(gsPageBundle))for(var d in gsPageBundle)gsPageBundle.hasOwnProperty(d)&&(n.Views.templateCache[d]=gsPageBundle[d]);n.getCurrentBroadcastID=function(){var e=s&&s.get("player"),t=e&&e.get("queue"),n=t&&t.get("currentBroadcast");return n?n.get("BroadcastID"):!1},n.getCurrentBroadcast=function(){var e=s&&s.get("player"),t=e&&e.get("queue"),n=t&&t.get("currentBroadcast");return n?n:!1},gsConfig.windowName&&function(){var t=$.browser.chrome&&_.toInt($.browser.version)||!1;if(!t||t<36||t>37)e.name=gsConfig.windowName}(),n.getLoggedInUserID=function(){return s&&s.get("user").id},n.getLoggedInUserPicture=function(e){return s&&s.get("user").getImageURL(e)},n.isLoggedInUserOwnerOfArtist=function(e){if(!e)return!1;var n=s&&s.get("user").get("artistsOwned");if(n){if(e)return n.get(e)?!0:!1;if(e===t)return n.length>0}return!1},n.isLoggedInUserArtistProfile=function(e){var t=s&&s.get("user"),r=_.toInt(t.get("Flags")),i=!1;return r&n.Models.User.FLAG_ARTIST_PROFILE&&(e?e==t.get("artistID")&&(i=!0):i=!0),i},n.isBroadcastListener=function(e){var t=s&&s.get("player"),n=t&&t.get("queue"),r=n&&n.get("currentBroadcast");return r?r.isListener():!1},n.isBroadcaster=function(){var e=s&&s.get("player"),t=e&&e.get("queue");return t&&!!t.get("isBroadcasting")},n.isBroadcastVIPCanAddToQueue=function(){var e=n.getLoggedInUserID(),t=s&&s.get("player"),r=t&&t.get("queue"),i=r?r.get("currentBroadcast"):null;return i?i.checkPermissionsForUserID(e,n.Models.Broadcast.VIP_PERM_AUTO_APPROVE)||i.checkPermissionsForUserID(e,n.Models.Broadcast.VIP_PERM_PLAY_NEXT):!1},n.getCurrentPlayStatus=function(){return s&&s.get("player").get("playStatus")},n.getLoggedInUserIsChatVisible=function(){return(s&&s.get("user").get("sessionPrivacy")&4)===0},n.getSessionPrivacy=function(){return s&&s.get("user").get("sessionPrivacy")},n.flashSafeTrigger=function(){n.dispatcher.trigger.apply(n.dispatcher,_.toArray(arguments))},n.premiumRequired=function(){var e=s&&s.get("user");return e&&e.get("subscription").premiumRequired()},n.getAppMode=function(){return s&&s.get("appMode")||(gsConfig.isMobile?"mobile":"desktop")},n.getAppSize=function(){return s&&s.get("appSize")},s=new n.Models.Model({gsConfig:gsConfig}),r=new n.Views.Application({model:s}),n.Services.SWF={playSpecialIndexex:n.Models.Player.playSpecialIndexes,playStatuses:n.Models.Player.playStatuses,repeatModes:n.Models.Player.repeatModes},r.setup();if(gsConfig.runMode==="dev")e.debugApp=r,e.debugModel=r.model,e.debugPlayer=r.model.get("player"),e.debugQueue=debugPlayer.get("queue"),e.debugManatee=r.model.get("manatee");else if(gsConfig.runMode==="staging"||gsConfig.runMode==="framily")e.stagingDebugApp=r;n.Services.Log.init(gsConfig),n.Services.API.init(gsConfig),n.Services.API.newTokenSuccess(i.getCommunicationToken),delete i.getCommunicationToken,n.Services.GUTS.init(s),n.Services.Facebook.init(r),n.Services.Twitter.init(r),n.Services.Google.init(r),n.Services.Lastfm.init(r),n.Services.Flattr.init(r),n.Services.Youtube.init(r),n.Services.Vimeo.init(r),n.External.DesktopBridge.init(s),n.External.PluginAPI.init(s),n.External.BrowserNotifications.init(s);var v=function(){var t=e.preloadedDataTotalTime,r=e.preloadedDataTotalSize,i=e.preloadedData.processTime,s=192,o,u,a,f;t&&r&&(o=r*.25,u=Math.max(o/(t/1e3-i)/1024*8,16e3),a=u/s,a>=2?f=_.toInt(1e3/a-200):a>=1&&(f=_.toInt(2e3/a-200)),n.Services.AudioHandle.setPreferredBufferSize(Math.min(Math.max(f,50),3e3)))};e.preloadedData?v():n.on("preloadedData",v);var m,g=function(e){if(!e)return;clearTimeout(m);var t=e.getStreamKeyWithSong;if(t&&t.song&&t.streamKey){e.consumedStreamKey=!0,delete e.getStreamKeyWithSong;var i=n.Models.Song.newOrUpdate(t.song),s=t.streamKey,o=r.model.get("player");o.playSongFromStreamKey(i.getDetailsForSwf(),s)}};typeof preloadedData!="undefined"?preloadedData.getStreamKeyWithSong&&g(preloadedData):(m=setTimeout(function(){n.trigger("neverGotStreamKey")},4e3),n.on("preloadedData",g)),n.Models.Callout.setupCalloutListeners();var y=_.once(function(){a.notify(),$("body").removeClass("css-loading");var t=$("body,#main,#page_wrapper,#mainContainer");t.scrollTop(0),document.body.scroll="no",t.scroll(function(e){return $(this).scrollTop()>0&&$(this).scrollTop(0),!1}),$.browser.msie&&($(document).bind("propertychange",function(){event.propertyName=="title"&&h()}),h()),$.drop({mode:"mouse"}),a.resolve(),n.router.run(r),p(),setTimeout(function(){amdModules.requireDeferred("tier2");if(e.gsProduction&&e.gsProduction.LB_CSSURI){var t=_.isUndefined(e.dataURISupport)||dataURISupport?gsProduction.LB_CSSURI:gsProduction.LB_CSS;t&&t.assetPath&&$.getStylesheet(t.assetPath)}},1e4)});$(document).ready(function(){$.browser.msie&&$("body").addClass("is-ie is-ie"+_.toInt($.browser.version));var t={},r="http://fonts.googleapis.com/css?family=Open+Sans:400,600,300",i=function(){t.font||(t.font=!0,e.gotGSStyle?y():n.on("gsStyle:ready",y))},s=gsAddCSS(r,{callback:i});setTimeout(function(){t.font||(s.parentNode.removeChild(s),s.href="",s.disabled=!0,i())},4e3)});var b=Date.now();e.onbeforeunload=function(){var e=s.get("user"),t=s.get("player");e&&e.id>0&&e.storeLibrary(),t&&t.storeQueue(),n.Services.GUTS&&n.Services.GUTS.forceSend();if(r.careersRedirect)return;if(!s.get("dontAlertOnLeave")&&!e.get("subscription").canHideAds()&&Date.now()-b<3e4&&!gsConfig.httpsFix&&!n.External.DesktopBridge.active)return _.getString("ONCLOSE_JUST_LOADED");var i=r.page.getCurrentPageView(),o=i?i.blockPageChange():!1;if(o===!0)return;if(o)return o;var u=swfobject.getObjectById("record-swf");if(u&&_.isFunction(u.numPendingUploads)&&u.numPendingUploads()>0)return _.getString("ONCLOSE_PENDING_UPLOADS");if(t.playStatusIsPlaying())return _.getString("ONCLOSE_PLAYING")},e.onunload=function(){var e=r.model.get("manatee");e&&e.cleanup()}}),e.tokenData&&n.trigger("tokenData",e.tokenData)};(function(t){var n=116,r="stingray",i={PRECORE:0,POSTCORE:1},s=0,o=0,u=5,a=1e3,f=6e4,l=!1,c=+(new Date),h=t.applicationCache,p=!0,d=!1,v=!0,m=!1,g=!1,y,b=function(e,t){if(e&&e.getGSProduction&&e.getGSProduction.HTML5_SHIM){var n=e.getGSProduction,r=$("#html5ShimSwf");if(r.length){var i=n.HTML5_SHIM.assetPath,s=r.clone(),o=s.find("param[name=movie]");if(t.runMode=="dev"||t.runMode=="themes")i+="?"+ +(new Date);o.length?o.attr("value",i):s.attr("data",i),r.replaceWith(s)}}};if(t.gsBootstrap&&t.gsBootstrap.booting){t.gsBootstrap.upgrade=function(e,s,o){var u=parseInt(e||0,10),a=t.tokenData,f=a.getGSConfig||{};if(u===n||!h)return;switch(s){case i.PRECORE:if(u<109&&n>=110){v=!1;return}u<115&&(v=!1),o!==r&&(v=!1);break;case i.POSTCORE:b(a,f)}},gsBootstrap.newApp=function(t){gsBootstrap.version||gsBootstrap.upgrade(0,i.POSTCORE,r);if(!v){t.location.reload();return}e(t)};return}t.gsBootstrap||(t.gsBootstrap={version:n,booting:!0,performance:t.performance||{},upgrade:function(){}},gsBootstrap.performance.mark||(gsBootstrap.performance.mark=function(e){gsBootstrap.log.push(e+": "+(+(new Date)-c))})),gsBootstrap.log=[];var w=function(c){if(l)return;o++,!e&&t.gsBootstrap.newApp&&(e=t.gsBootstrap.newApp);if(!t.groovesharkCore||!e){if(s>=f&&!g){g=!0,t.GSLogger&&t.GSLogger.notify("Failed to load new app within 60 seconds","ERROR",null,!0);if(confirm("Failed to load some files, retry?")){t.location.reload();return}}c||(s+=u,o>=8&&s>u*5&&u<a&&(u*=2)),setTimeout(w,u);return}gsBootstrap.upgrade(n,i.PRECORE,r),l=!0,t.gsBootstrap.newApp=null,gsBootstrap.performance.mark("running core"),t.groovesharkCore(t),gsBootstrap.performance.mark("finished core"),t.groovesharkCore=null,gsBootstrap.upgrade(n,i.POSTCORE,r),gsBootstrap.performance.mark("running app"),e(t),gsBootstrap.performance.mark("finished app")},E=function(){clearTimeout(y),y=null,p=!1,d=!0;var e=document.getElementById("coreJS");e&&(e.onload=e.onreadystatechange=w),setTimeout(w,u)};if(!h)return E();var S=function(e){var t=e.getElementsByTagName("script"),n=[],r,i,s,o;for(r=0,i=t.length;r<i;r++)s=t[r],o=s.src,o&&n.push([o,s,"js"]);t=e.getElementsByTagName("link");for(r=0,i=t.length;r<i;r++)s=t[r],o=s.href,o&&s.rel=="stylesheet"&&n.push([o,s,"css"]);return n}(document),x=function(){var n,r=0,i=function(){console.log("reloading due to failed update"),console.trace(),t.location.reload(),clearInterval(n)};t.groovesharkCore=null,e=null;var s=function(){if(++r>70)return i();if(!t.tokenData)return;var e=t.tokenData,s=e.getGSProduction,o=e.getGSConfig||{};clearInterval(n);if(!s||!s.CORE||!s.APP)return i();var u=s.CORE.assetPath,a=s.APP.assetPath,f=s.LOAD_CSSURI.assetPath,l=s.CSSURI.assetPath,c=document.getElementById("coreJS");if(o.runMode=="dev"||o.runMode=="themes"){var h=+(new Date);u+="?"+h,a+="?"+h,f+="?"+h,l+="?"+h}c&&c.parentNode&&c.parentNode.removeChild(c),gsAddScript(u,{id:"coreJS",cors:!0,retryCors:!0,callback:function(){!t.groovesharkCore&&t.GSLogger&&t.GSLogger.notify("Failed to load/parse core.js in outro.js","ERROR")}}),gsAddScript(a,{callback:function(){E()},cors:!0,retryCors:!0});var p=document.getElementById("loadingCSS"),d=document.getElementById("loadingCSSFallback");gsAddCSS(f,{id:"loadingCSS",callback:function(){var e=p&&p.parentNode;e&&e.removeChild(p),e=d&&d.parentNode,e&&e.removeChild(d)}}),gsAddCSS(l,{callback:function(){for(var e=0,t=S.length,n;e<t;e++)S[e][2]=="css"&&(n=S[e][1].parentNode,n&&n.removeChild(S[e][1]))}})};n=setInterval(s,100),s()},T=function(){gsBootstrap.log.push("appCache: "+h.status+" (allowLoad: "+p+")");if(!p)return;clearTimeout(y),y=null;switch(h.status){case h.UNCACHED:E();break;case h.IDLE:m&&E();break;case h.CHECKING:y=setTimeout(E,3500);case h.DOWNLOADING:m=!0;break;case h.UPDATEREADY:setTimeout(function(){p=!1,x()},6);break;case h.OBSOLETE:setTimeout(function(){t.location.reload()},1e3);break;default:E()}};gsBootstrap.checkCache=T,h.addEventListener("cached",function(){gsBootstrap.log.push("appCache: "+h.status+" (cached: true)"),E()},!1),h.addEventListener("progress",function(e){gsBootstrap.log.push("appCache progress: "+e.loaded+"/"+e.total),clearTimeout(y)},!1),h.addEventListener("downloading",T,!1),h.addEventListener("obsolete",T,!1),h.addEventListener("updateready",T,!1),h.addEventListener("noupdate",function(){gsBootstrap.log.push("appCache: "+h.status+" (noupdate: true)"),E()},!1),h.addEventListener("error",function(e){gsBootstrap.log.push("appCache: "+h.status+" (failed: true)"),t.GSLogger?t.GSLogger.notify(e,"ERROR",{errorSrc:"appCache"}):console.log("appCache failed",e.message,e),E()},!1),T()})(window)})()